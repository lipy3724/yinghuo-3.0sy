# 阿里云图像人脸融合模板输入限制对比

## 对比结果

| 限制项 | 阿里云要求 | 萤火AI当前实现 | 状态 |
|--------|-----------|---------------|------|
| **图像格式** | 支持 JPG、JPEG、PNG、BMP | ✅ 已实现（multer fileFilter） | ✅ 符合 |
| **图像大小** | 不超过 30 MB | ✅ 已实现（multer limits: 30MB） | ✅ 符合 |
| **图像分辨率** | 大于等于 32×32 像素 | ✅ 已实现（validateImageDimensions） | ✅ 符合 |
| **图像分辨率** | 小于等于 8192×8192 像素 | ✅ 已实现（validateImageDimensions） | ✅ 符合 |
| **最长边限制** | 最长边小于等于 8192 像素 | ✅ 已实现（validateImageDimensions） | ✅ 符合 |
| **人脸区域** | 宽高均不低于 64 像素 | ✅ 已实现（DetectFace + 面积校验） | ✅ 符合 |
| **URL中文字符** | URL地址不能包含中文字符 | ✅ 已符合（所有图片上传到OSS，路径自动生成，不包含中文） | ✅ 符合 |
| **多人图像** | 建议单张图像中的人脸数量不超过 5 个 | ✅ 已实现（DetectFace人脸数量验证） | ✅ 符合 |
| **模板数量** | 不限制可以增加的模板数量 | ✅ 无限制 | ✅ 符合 |

## 详细说明

### ✅ 已符合的要求

1. **图像格式验证**
   - 位置：`routes/faceFusion.js` 第 24-40 行
   - 实现：multer 的 `fileFilter` 中间件限制只允许 `image/jpeg`、`image/jpg`、`image/png`、`image/bmp`
   - Base64 数据会在上传前解析 MIME 类型并匹配允许的扩展名

2. **图像大小限制**
   - 位置：`routes/faceFusion.js` 第 26-29 行
   - 实现：multer 限制文件大小为 30MB，超限时返回明确提示

3. **图像分辨率验证**
   - 位置：`routes/faceFusion.js` 第 96-208 行 `validateImageDimensions` 函数
   - 实现：
     - 最小尺寸：32×32 像素
     - 最大尺寸：8192×8192 像素
     - 最长边：不超过 8192 像素

4. **URL中文字符**
   - 当前实现：所有模板图片都通过 `uploadImageToOSS` 上传到 OSS
   - OSS 路径格式：`images/{timestamp}-{randomStr}.{ext}`（不包含中文）
   - 因此不会出现 URL 包含中文字符的情况

### ✅ 新增的验证

1. **人脸数量与区域验证**
   - **位置**：`routes/faceFusion.js` 中 `detectFaceCount` 函数和 `/create-template` 路由
   - **实现**：
     - 调用阿里云 `DetectFace` 接口实时检测人脸数量，超过 5 个时返回警告并阻止模板创建
     - 基于 `DetectFace` 返回的矩形信息，校验每张人脸的宽高均不低于 64 像素
   - **效果**：确保模板符合阿里云建议，提升后续人脸融合效果稳定性

## 改进建议

### 优先级：高
1. ✅ 完成输入限制与阿里云最新规范对齐（格式、大小、分辨率、人脸面积）

### 优先级：中
3. 考虑添加内容审核：阿里云文档提到"确保图像已通过内容审核"，可以在创建模板前调用内容审核 API

### 优先级：低
4. 优化错误提示：当图片不符合要求时，提供更详细的错误信息，帮助用户快速定位问题

