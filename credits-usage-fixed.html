<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>积分使用情况 - 萤火AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="/components/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/auth-check.js"></script>
    <link rel="icon" href="/images/favicon.png" type="image/png">
</head>
<body class="bg-gray-50">
    <!-- 完整版导航栏 -->
    <div id="navbar-full"></div>

    <div class="container mx-auto px-4 py-8" style="margin-top: 60px;">
        <h1 class="text-2xl font-bold mb-6">积分使用情况</h1>
        
        <!-- 加载状态指示器 -->
        <div id="loading-indicator" class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-3"></div>
                <span>正在加载积分使用数据...</span>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-medium text-lg">积分概览</h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-indigo-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600">时段消费积分</p>
                    <p class="text-2xl font-bold text-indigo-600" id="total-credits-used">0</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600">使用次数</p>
                    <p class="text-2xl font-bold text-green-600" id="total-usage-count">0</p>
                </div>
                <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600">使用功能数量</p>
                    <p class="text-2xl font-bold text-blue-600" id="feature-count">0</p>
                </div>
            </div>
            
            <div>
                <canvas id="usage-chart" height="200"></canvas>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="font-medium text-lg mb-4">功能使用次数占比</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1">
                    <canvas id="feature-pie-chart" height="220"></canvas>
                </div>
                <div class="md:col-span-2 overflow-y-auto max-h-64">
                    <ul class="space-y-3" id="feature-list">
                        <!-- 功能列表将通过JS动态生成 -->
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 使用记录组件 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="font-medium text-lg mb-4">使用记录</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="py-2 px-4 text-left text-sm font-medium text-gray-500 border-b">时间</th>
                            <th class="py-2 px-4 text-left text-sm font-medium text-gray-500 border-b">功能名称</th>
                            <th class="py-2 px-4 text-left text-sm font-medium text-gray-500 border-b">操作</th>
                            <th class="py-2 px-4 text-left text-sm font-medium text-gray-500 border-b">积分消费</th>
                        </tr>
                    </thead>
                    <tbody id="usage-records-list">
                        <!-- 使用记录将通过JS动态生成 -->
                    </tbody>
                </table>
            </div>
            <div id="no-records" class="hidden text-center py-6 text-gray-500">
                暂无使用记录
            </div>
        </div>
    </div>

    <!-- 组件加载脚本 -->
    <script>
        // 异步加载完整版导航栏组件
        fetch('/components/navbar-full.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('navbar-full').innerHTML = html;
                
                // 加载组件JavaScript
                const script = document.createElement('script');
                script.src = '/components/components.js';
                document.head.appendChild(script);
            })
            .catch(error => {
                console.error('加载导航栏组件失败:', error);
            });

        // 初始化用户界面
        function initializeUserUI() {
            const authToken = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('user');
            
            console.log('积分使用页面：初始化用户界面，authToken存在:', !!authToken, 'userInfo存在:', !!userInfo);
            
            if (authToken && userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    console.log('积分使用页面：用户已登录，用户名:', user.username);
                    
                    // 加载积分使用数据
                    loadUsageData();
                } catch (e) {
                    console.error('解析用户信息出错:', e);
                    showError('用户信息解析失败，请重新登录');
                }
            } else {
                console.log('积分使用页面：用户未登录');
                showError('用户未登录，请先登录');
            }
        }
        
        // 显示错误信息
        function showError(message) {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
            loadingIndicator.innerHTML = `
                <div class="flex items-center">
                    <i class="ri-error-warning-line mr-3 text-red-600"></i>
                    <span>${message}</span>
                </div>
            `;
        }
        
        // 隐藏加载指示器
        function hideLoadingIndicator() {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'none';
        }
        
        // 从服务器获取用户积分使用数据的函数
        async function fetchUserCreditsUsage(days = 30) {
            try {
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    throw new Error('用户未登录');
                }
                
                console.log(`积分使用页面：开始请求API /api/credits/usage?days=${days}`);
                
                const response = await fetch(`/api/credits/usage?days=${days}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('积分使用页面：API响应状态', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('积分使用页面：API请求失败', response.status, errorText);
                    throw new Error(`获取数据失败: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('积分使用页面：API返回结果', result);
                
                if (result.success && result.data) {
                    console.log('积分使用页面：数据获取成功');
                    return result.data;
                } else {
                    throw new Error(result.message || '获取数据失败');
                }
            } catch (error) {
                console.error('积分使用页面：获取积分使用数据失败:', error);
                throw error;
            }
        }
        
        // 设置全局数据变量
        let usageData = {
            summary: {
                totalCreditsUsed: 0,
                totalUsageCount: 0,
                featureCount: 0
            },
            chartData: {
                labels: [],
                data: []
            },
            featureUsage: [],
            usageRecords: [],
            totalRecords: 0
        };
        
        // 加载积分使用数据
        async function loadUsageData() {
            try {
                console.log('积分使用页面：开始加载积分使用数据');
                
                // 显示加载状态
                document.getElementById('total-credits-used').textContent = '加载中...';
                document.getElementById('total-usage-count').textContent = '加载中...';
                document.getElementById('feature-count').textContent = '加载中...';
                
                // 从服务器获取数据
                const data = await fetchUserCreditsUsage(30);
                
                console.log('积分使用页面：获取到数据', data);
                
                // 更新本地数据
                usageData = data;
                
                // 更新概览数据
                document.getElementById('total-credits-used').textContent = usageData.summary?.totalCreditsUsed || 0;
                document.getElementById('total-usage-count').textContent = usageData.summary?.totalUsageCount || 0;
                document.getElementById('feature-count').textContent = usageData.summary?.featureCount || 0;
                
                console.log('积分使用页面：更新概览数据完成');
                
                // 隐藏加载指示器
                hideLoadingIndicator();
                
                // 渲染图表和列表
                renderUsageChart();
                renderFeaturePieChart();
                renderFeatureList();
                renderUsageRecords();
                
                console.log('积分使用页面：所有渲染完成');
            } catch (error) {
                console.error('积分使用页面：加载数据失败', error);
                
                // 显示错误信息
                showError(`数据加载失败：${error.message}`);
                
                // 显示错误状态
                document.getElementById('total-credits-used').textContent = '加载失败';
                document.getElementById('total-usage-count').textContent = '加载失败';
                document.getElementById('feature-count').textContent = '加载失败';
            }
        }
        
        // 渲染使用趋势图表
        function renderUsageChart() {
            const ctx = document.getElementById('usage-chart').getContext('2d');
            
            // 检查是否有数据
            const hasData = usageData.chartData?.data?.some(value => value > 0);
            console.log('图表数据检查:', usageData.chartData);
            
            if (!hasData) {
                // 显示无数据状态
                ctx.canvas.style.height = '200px';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '16px sans-serif';
                ctx.fillStyle = '#6B7280';
                ctx.fillText('暂无积分使用记录', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // 有数据时正常绘制图表
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: usageData.chartData.labels,
                    datasets: [{
                        label: '积分使用量',
                        data: usageData.chartData.data,
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // 渲染功能使用占比饼图
        function renderFeaturePieChart() {
            const ctx = document.getElementById('feature-pie-chart').getContext('2d');
            
            // 检查是否有数据
            if (!usageData.featureUsage || usageData.featureUsage.length === 0) {
                // 显示无数据状态
                ctx.canvas.style.height = '220px';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '16px sans-serif';
                ctx.fillStyle = '#6B7280';
                ctx.fillText('暂无功能使用记录', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // 过滤掉使用次数为0的项目
            const validData = usageData.featureUsage.filter(item => item.usageCount > 0);
            
            if (validData.length === 0) {
                ctx.canvas.style.height = '220px';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '16px sans-serif';
                ctx.fillStyle = '#6B7280';
                ctx.fillText('暂无功能使用记录', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // 有数据时正常绘制图表
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: validData.map(item => item.name),
                    datasets: [{
                        data: validData.map(item => item.usageCount),
                        backgroundColor: validData.map(item => item.color || getRandomColor(item.name)),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} 次 (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
        }
        
        // 生成随机颜色函数
        function getRandomColor(seed) {
            const colors = [
                '#4F46E5', '#0EA5E9', '#10B981', '#F59E0B', '#EF4444',
                '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16', '#F97316'
            ];
            
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                hash = seed.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            return colors[Math.abs(hash) % colors.length];
        }
        
        // 渲染功能列表
        function renderFeatureList() {
            const featureListEl = document.getElementById('feature-list');
            featureListEl.innerHTML = '';
            
            // 检查是否有数据
            if (!usageData.featureUsage || usageData.featureUsage.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'text-center text-gray-500 py-4';
                emptyItem.textContent = '暂无功能使用记录';
                featureListEl.appendChild(emptyItem);
                return;
            }
            
            // 过滤掉使用次数为0的项目
            const validData = usageData.featureUsage.filter(item => item.usageCount > 0);
            
            if (validData.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'text-center text-gray-500 py-4';
                emptyItem.textContent = '暂无功能使用记录';
                featureListEl.appendChild(emptyItem);
                return;
            }
            
            // 计算使用次数的百分比
            const totalUsageCount = validData.reduce((sum, feature) => sum + feature.usageCount, 0);
            
            // 按使用次数排序，从多到少
            validData
                .sort((a, b) => b.usageCount - a.usageCount)
                .forEach(feature => {
                    // 计算使用次数百分比
                    const usagePercentage = totalUsageCount > 0 ? 
                        ((feature.usageCount / totalUsageCount) * 100).toFixed(2) : '0.00';
                    
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center justify-between';
                    listItem.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${feature.color || getRandomColor(feature.name)}"></div>
                            <span class="text-sm">${feature.name}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium">${feature.usageCount} 次</div>
                            <div class="text-xs text-gray-500">${usagePercentage}%</div>
                        </div>
                    `;
                    featureListEl.appendChild(listItem);
                });
        }
        
        // 渲染使用记录列表
        function renderUsageRecords() {
            const recordsListEl = document.getElementById('usage-records-list');
            const noRecordsEl = document.getElementById('no-records');
            
            recordsListEl.innerHTML = '';
            
            // 检查是否有记录数据
            if (!usageData.usageRecords || usageData.usageRecords.length === 0) {
                noRecordsEl.classList.remove('hidden');
                return;
            }
            
            noRecordsEl.classList.add('hidden');
            
            // 只显示最近的10条记录
            const recentRecords = usageData.usageRecords.slice(0, 10);
            
            // 渲染每条记录
            recentRecords.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // 处理免费使用的显示
                let creditDisplay;
                if (record.isFree === true || record.credits === 0) {
                    creditDisplay = '<span class="text-green-500 font-medium">免费</span>';
                } else {
                    creditDisplay = `<span class="text-red-500 font-medium">-${record.credits} 积分</span>`;
                }
                
                row.innerHTML = `
                    <td class="py-3 px-4 border-b text-sm">${record.date}</td>
                    <td class="py-3 px-4 border-b text-sm">
                        <span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded-full text-xs">
                            ${record.feature}
                        </span>
                    </td>
                    <td class="py-3 px-4 border-b text-sm">${record.description}</td>
                    <td class="py-3 px-4 border-b text-sm">${creditDisplay}</td>
                `;
                recordsListEl.appendChild(row);
            });
        }
        
        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            console.log('积分使用页面：DOM加载完成，开始初始化');
            
            // 等待认证检查完成后再初始化
            const waitForAuth = () => {
                // 检查是否正在进行认证检查
                if (window.isAuthChecking) {
                    console.log('积分使用页面：等待认证检查完成...');
                    setTimeout(waitForAuth, 500);
                    return;
                }
                
                // 检查认证状态
                const authToken = localStorage.getItem('authToken');
                const userInfo = localStorage.getItem('user');
                
                if (authToken && userInfo) {
                    console.log('积分使用页面：认证完成，开始初始化');
                    initializeUserUI();
                } else {
                    console.log('积分使用页面：用户未登录，等待认证检查...');
                    setTimeout(waitForAuth, 500);
                }
            };
            
            // 延迟启动，确保auth-check.js有时间完成认证
            setTimeout(waitForAuth, 2000);
        });
    </script>
</body>
</html>
