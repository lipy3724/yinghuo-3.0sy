# 萤火AI平台宝塔部署指南

本文档提供在宝塔面板上部署萤火AI平台的详细步骤和注意事项。

## 1. 环境要求

- 宝塔面板 7.9.0 或更高版本
- Node.js v14.0.0 或更高版本（推荐v18.20.8）
- MySQL 5.7 或更高版本
- 至少 2GB 内存和 10GB 可用磁盘空间

## 2. 部署前准备

### 2.1 安装必要的软件

在宝塔面板中安装以下软件：

1. **Nginx** - 用于反向代理和静态文件服务
2. **MySQL** - 数据库服务
3. **Node.js** - 运行时环境（推荐v18.20.8）
4. **PM2管理器** - 用于管理Node.js进程

### 2.2 创建数据库

1. 在宝塔面板的数据库管理中创建新的MySQL数据库
2. 数据库名称：`yinghuo`（或您自定义的名称）
3. 创建对应的数据库用户并授予权限

## 3. 项目部署步骤

### 3.1 上传项目文件

1. 创建项目目录：
   ```bash
   mkdir -p /www/wwwroot/yinghuo/1_副本2\ 2
   chown -R www:www /www/wwwroot/yinghuo/1_副本2\ 2
   ```

2. 将项目文件上传到该目录（可以使用SFTP或宝塔自带的文件管理器）

3. 上传本项目提供的部署脚本到项目目录：
   - `bt-deploy.sh` - 部署脚本
   - `bt-start.sh` - 启动脚本
   - `bt-check.sh` - 环境检查脚本
   - `bt-pm2-config.js` - PM2配置文件
   - `bt-env-template` - 环境变量模板

### 3.2 检查环境

1. 切换到项目目录并运行环境检查脚本：
   ```bash
   cd /www/wwwroot/yinghuo/1_副本2\ 2
   chmod +x bt-check.sh
   ./bt-check.sh
   ```

2. 根据检查结果修复可能存在的问题

### 3.3 运行部署脚本

1. 执行部署脚本：
   ```bash
   chmod +x bt-deploy.sh
   ./bt-deploy.sh
   ```

2. 部署脚本会自动：
   - 创建必要的目录结构
   - 设置正确的权限
   - 创建环境变量文件模板
   - 创建PM2配置文件

### 3.4 配置环境变量

1. 编辑生成的`.env`文件（或使用模板创建）：
   ```bash
   nano .env
   ```
   
2. 根据实际情况修改以下配置：
   - 数据库连接信息
   - JWT密钥
   - 阿里云OSS配置
   - API密钥

## 4. 启动应用

### 4.1 使用宝塔Node.js管理器

1. 在宝塔面板中，进入**软件商店** > **Node.js管理器** > **项目列表**
2. 点击**添加Node项目**
3. 配置项目信息：
   - 项目名称：`yinghuo`
   - 项目目录：`/www/wwwroot/yinghuo/1_副本2 2`
   - 启动文件：`bt-start.sh`
   - 运行用户：`www`
   - Node版本：选择安装的版本
   - 项目端口：`8081`
4. 点击提交，然后启动项目

### 4.2 使用PM2启动（可选）

如果您更喜欢直接使用PM2管理应用：

```bash
cd /www/wwwroot/yinghuo/1_副本2\ 2
pm2 start bt-pm2-config.js
```

## 5. 配置Nginx反向代理

1. 在宝塔面板中，进入**网站** > **添加站点**
2. 填写您的域名和其他信息
3. 创建完成后，点击**设置** > **配置文件**
4. 修改Nginx配置，添加如下内容：

```nginx
location / {
    proxy_pass http://127.0.0.1:8081;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_buffers 16 4k;
    proxy_buffer_size 2k;
    proxy_read_timeout 300;
}

# 静态文件直接由Nginx提供服务
location /public/ {
    root /www/wwwroot/yinghuo/1_副本2 2;
    access_log off;
    expires 30d;
}

# 上传文件目录
location /uploads/ {
    root /www/wwwroot/yinghuo/1_副本2 2;
    access_log off;
    expires 7d;
}
```

5. 保存配置并重启Nginx

## 6. 应用监控和维护

### 6.1 查看日志

```bash
# 查看应用输出日志
tail -f /www/wwwroot/yinghuo/1_副本2\ 2/logs/out.log

# 查看错误日志
tail -f /www/wwwroot/yinghuo/1_副本2\ 2/logs/err.log
```

### 6.2 重启应用

在宝塔Node.js管理器中重启应用，或使用PM2命令：

```bash
pm2 restart yinghuo-ai
```

### 6.3 更新应用

1. 备份当前版本：
   ```bash
   cp -r /www/wwwroot/yinghuo/1_副本2\ 2 /www/backup/yinghuo_$(date +%Y%m%d)
   ```

2. 上传新版本文件
3. 重启应用

## 7. 常见问题与解决方案

### 7.1 启动失败问题

如果应用启动失败，请检查：

1. **日志文件**：查看`logs/err.log`和`logs/startup.log`获取错误信息
2. **目录权限**：确保`www`用户对项目目录有读写权限
3. **环境变量**：确保`.env`文件存在且配置正确
4. **依赖问题**：尝试重新安装依赖 `npm install`

### 7.2 访问404问题

1. 检查Nginx配置是否正确
2. 确认应用是否正常运行 `pm2 list`
3. 检查端口是否正常监听 `netstat -tln | grep 8081`

### 7.3 数据库连接问题

1. 检查`.env`中的数据库配置
2. 确认数据库用户有足够权限
3. 检查数据库是否正常运行

### 7.4 文件上传问题

1. 确保`uploads`目录存在且权限正确
2. 检查OSS配置是否正确
3. 确认存储空间是否充足

## 8. 安全建议

1. **JWT密钥**：使用强随机字符串，不要使用默认值
2. **API密钥**：保管好各种API密钥，避免泄露
3. **数据库密码**：使用强密码并定期更换
4. **权限隔离**：确保应用运行在受限用户下
5. **定期备份**：设置定期备份任务保护数据

## 9. 性能优化建议

1. **内存配置**：根据服务器内存调整Node.js内存限制
2. **PM2实例**：在多核服务器上可以适当增加实例数
3. **Nginx缓存**：为静态资源配置合理的缓存策略
4. **数据库优化**：定期维护数据库，优化查询性能

## 10. 帮助与支持

如果您在部署过程中遇到任何问题，请查看以下资源：

- 项目文档：参考项目根目录下的README.md
- 系统日志：检查应用和系统日志
- 技术支持：联系项目维护团队 