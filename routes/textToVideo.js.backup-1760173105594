const express = require('express');
const router = express.Router();
const axios = require('axios');
const { protect } = require('../middleware/auth');
const { createUnifiedFeatureMiddleware } = require('../middleware/unifiedFeatureUsage');
const { checkFeatureAccess } = require('../middleware/featureAccess');
const User = require('../models/User');
const { FeatureUsage } = require('../models/FeatureUsage');
const ImageHistory = require('../models/ImageHistory');
const { sequelize } = require('../config/db');
const multer = require('multer');
const { uploadFile } = require('../utils/ossService'); // å¯¼å…¥OSSä¸Šä¼ æœåŠ¡
const fs = require('fs');
const path = require('path');

// é…ç½®æ–‡ä»¶ä¸Šä¼ å­˜å‚¨
const storage = multer.diskStorage({
    destination: function(req, file, cb) {
        cb(null, 'uploads/');
    },
    filename: function(req, file, cb) {
        cb(null, Date.now() + '-' + file.originalname);
    }
});

// åˆ›å»ºuploadä¸­é—´ä»¶
const upload = multer({ 
    storage: storage,
    limits: { fileSize: 30 * 1024 * 1024 } // 30MBé™åˆ¶
});

// è§†é¢‘ç»“æœæ¨¡å‹
const VideoResult = require('../models/VideoResult');

// å­˜å‚¨ç”¨æˆ·åˆ›å»ºçš„è§†é¢‘ä»»åŠ¡
const userTasks = {};
// ä»»åŠ¡çŠ¶æ€ç¼“å­˜ï¼Œé¿å…è¿‡äºé¢‘ç¹åœ°è¯·æ±‚é˜¿é‡Œäº‘API
const taskStatusCache = {
  // taskId: {
  //   status: 'PENDING', // ä»»åŠ¡çŠ¶æ€
  //   lastFetchTime: timestamp, // ä¸Šæ¬¡ä»é˜¿é‡Œäº‘APIè·å–çŠ¶æ€çš„æ—¶é—´
  //   data: {...} // ä¸Šæ¬¡APIè¿”å›çš„å®Œæ•´æ•°æ®
  // }
};

// ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢æœ€å°é—´éš” (å•ä½: ms)
const STATUS_QUERY_MIN_INTERVAL = {
  'PENDING': 10000,  // æ’é˜Ÿä¸­çŠ¶æ€ï¼Œ10ç§’æŸ¥è¯¢ä¸€æ¬¡
  'RUNNING': 5000,   // å¤„ç†ä¸­çŠ¶æ€ï¼Œ5ç§’æŸ¥è¯¢ä¸€æ¬¡
  'default': 3000    // é»˜è®¤çŠ¶æ€ï¼Œ3ç§’æŸ¥è¯¢ä¸€æ¬¡
};

/**
 * @route   POST /api/text-to-video/create
 * @desc    åˆ›å»ºæ–‡ç”Ÿè§†é¢‘ä»»åŠ¡
 * @access  ç§æœ‰
 */
router.post('/create', protect, checkFeatureAccess('text-to-video'), async (req, res) => {
  try {
    const { prompt, model, size } = req.body;
    const userId = req.user.id;
    
    console.log('æ”¶åˆ°è§†é¢‘ç”Ÿæˆè¯·æ±‚:', { prompt, model, size, userId });
    
    // å‚æ•°éªŒè¯
    if (!prompt) {
      return res.status(400).json({
        success: false,
        message: 'è¯·æä¾›è§†é¢‘æè¿°(prompt)'
      });
    }
    
    if (!model || !['wanx2.1-t2v-turbo', 'wanx2.1-t2v-plus'].includes(model)) {
      return res.status(400).json({
        success: false,
        message: 'è¯·æä¾›æœ‰æ•ˆçš„æ¨¡å‹åç§°'
      });
    }
    
    if (!size) {
      return res.status(400).json({
        success: false,
        message: 'è¯·æä¾›è§†é¢‘å°ºå¯¸'
      });
    }
    
    // è´¹ç”¨è®¡ç®— - ç§¯åˆ†åˆ¶
    const costPerSecond = model === 'wanx2.1-t2v-turbo' ? 13.2 : 70; // æ”¹ä¸º13.2ç§¯åˆ†/ç§’ï¼Œä½¿5ç§’è§†é¢‘æ€»è®¡ä¸º66ç§¯åˆ†
    const estimatedCost = costPerSecond * 5; // å‡è®¾ç”Ÿæˆ5ç§’è§†é¢‘

    // ç§¯åˆ†æ£€æŸ¥å·²ç”±ä¸­é—´ä»¶å¤„ç†ï¼Œä»»åŠ¡å®Œæˆåå†æ‰£é™¤ç§¯åˆ†
    console.log(`æ–‡ç”Ÿè§†é¢‘ä»»åŠ¡åˆ›å»ºï¼Œé¢„è®¡æ¶ˆè€—ç§¯åˆ†: ${estimatedCost}${req.featureUsage?.usageType === 'free' ? ' (å…è´¹æ¬¡æ•°)' : ''}`);
    
    // ç”¨æˆ·éªŒè¯ï¼ˆä¸­é—´ä»¶å·²éªŒè¯ç§¯åˆ†ï¼Œè¿™é‡Œåªéœ€éªŒè¯ç”¨æˆ·å­˜åœ¨ï¼‰
    const user = await User.findByPk(userId);
    if (!user) {
      return res.status(404).json({
        success: false,
        message: 'ç”¨æˆ·ä¸å­˜åœ¨'
      });
    }
    
    try {
      // æ£€æŸ¥APIå¯†é’¥æ˜¯å¦å­˜åœ¨
      if (!process.env.DASHSCOPE_API_KEY) {
        console.error('DASHSCOPE_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®');
        return res.status(500).json({
          success: false,
          message: 'APIå¯†é’¥æœªé…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
        });
      }
      
      console.log('è°ƒç”¨é˜¿é‡Œäº‘æ–‡ç”Ÿè§†é¢‘APIï¼Œä½¿ç”¨çš„å¯†é’¥å‰ç¼€ï¼š', process.env.DASHSCOPE_API_KEY.substring(0, 6) + '...');
      
      // å‡†å¤‡è¯·æ±‚ä½“ - æŒ‰ç…§é˜¿é‡Œäº‘APIæ–‡æ¡£æ ¼å¼æ„å»º
      const requestBody = {
        model: model,
        input: {
          prompt: prompt
        },
        parameters: {
          size: size, // ä½¿ç”¨å‰ç«¯ä¼ é€’çš„sizeå‚æ•°ï¼Œä¸é˜¿é‡Œäº‘APIæ–‡æ¡£ä¸€è‡´
          duration: 5,
          prompt_extend: true
        }
      };
      
      console.log('APIè¯·æ±‚ä½“:', JSON.stringify(requestBody));
      
      // è°ƒç”¨é˜¿é‡Œäº‘æ–‡ç”Ÿè§†é¢‘API
      console.log('å¼€å§‹è°ƒç”¨é˜¿é‡Œäº‘æ–‡ç”Ÿè§†é¢‘API...');
      const response = await axios.post(
        'https://dashscope.aliyuncs.com/api/v1/services/aigc/video-generation/video-synthesis',
        requestBody,
        {
          headers: {
            'X-DashScope-Async': 'enable',
            'Authorization': `Bearer ${process.env.DASHSCOPE_API_KEY}`,
            'Content-Type': 'application/json'
          },
          timeout: 30000 // è®¾ç½®30ç§’è¶…æ—¶
        }
      );
      
      console.log('é˜¿é‡Œäº‘APIå“åº”:', JSON.stringify(response.data, null, 2));
      
      // è·å–ä»»åŠ¡ID
      if (!response.data || !response.data.output || !response.data.output.task_id) {
        console.error('APIå“åº”ä¸­æœªæ‰¾åˆ°task_id:', response.data);
        return res.status(500).json({
          success: false,
          message: 'APIå“åº”æ ¼å¼å¼‚å¸¸ï¼Œæœªæ‰¾åˆ°ä»»åŠ¡ID'
        });
      }
      
      const taskId = response.data.output.task_id;
      console.log('æˆåŠŸè·å–ä»»åŠ¡ID:', taskId);
      const task_status = response.data.output.task_status || 'PENDING';
      
      // è§„èŒƒåŒ–ä»»åŠ¡çŠ¶æ€ - éæˆåŠŸæˆ–å¤±è´¥çš„çŠ¶æ€éƒ½è§†ä¸ºç”Ÿæˆä¸­(RUNNING)
      const normalizedStatus = 
        task_status === 'SUCCEEDED' ? 'SUCCEEDED' :
        task_status === 'FAILED' ? 'FAILED' : 'RUNNING';
      
      // å­˜å‚¨ä»»åŠ¡ä¿¡æ¯åˆ°æœ¬åœ°å˜é‡(å…¼å®¹åŸæœ‰ä»£ç )
      if (!userTasks[userId]) {
        userTasks[userId] = [];
      }
      
      const newTask = {
        id: taskId,
        prompt,
        model,
        size,
        status: normalizedStatus, // ä½¿ç”¨è§„èŒƒåŒ–åçš„çŠ¶æ€
        createdAt: new Date().toISOString(),
        cost: estimatedCost, // å­˜å‚¨ä»»åŠ¡é¢„è®¡æ¶ˆè€—ç§¯åˆ†ï¼Œåœ¨ä»»åŠ¡æˆåŠŸåæ‰£é™¤
        videoUrl: null
      };
      
      userTasks[userId].unshift(newTask);
      
      // åŒæ—¶ä¿å­˜åˆ°OSSå­˜å‚¨
      try {
        await addTaskToOSS(userId, newTask);
        console.log(`ä»»åŠ¡å·²ä¿å­˜åˆ°OSS: ${taskId}`);
      } catch (ossError) {
        console.error('ä¿å­˜ä»»åŠ¡åˆ°OSSå¤±è´¥:', ossError);
        // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œï¼Œç¡®ä¿ä»»åŠ¡åˆ›å»ºæˆåŠŸ
      }
      
      // åŒæ—¶å­˜å‚¨ä»»åŠ¡ä¿¡æ¯åˆ°å…¨å±€å˜é‡ï¼Œæ–¹ä¾¿åŒæ­¥åˆ°ç§¯åˆ†ä½¿ç”¨æƒ…å†µé¡µé¢
      if (!global.textToVideoTasks) {
        global.textToVideoTasks = {};
      }
      
      global.textToVideoTasks[taskId] = {
        userId: userId,
        prompt: prompt,
        model: model,
        size: size,
        status: normalizedStatus,
        creditCost: estimatedCost,
        timestamp: new Date(),
        hasChargedCredits: false, // ä¿®æ”¹ä¸ºfalseï¼Œç¡®ä¿ä»»åŠ¡å®Œæˆåæ‰£é™¤ç§¯åˆ†
        isFree: req.featureUsage?.usageType === 'free' // æ ‡è®°æ˜¯å¦ä¸ºå…è´¹ä½¿ç”¨
      };
      
      // ğŸš€ ç«‹å³å°†ä»»åŠ¡è¯¦æƒ…å†™å…¥æ•°æ®åº“ï¼Œä¿è¯ç§¯åˆ†ä½¿ç”¨é¡µé¢å®æ—¶æ›´æ–°
      try {
        if (req.featureUsage && req.featureUsage.usage) {
          const { saveTaskDetails } = require('../middleware/unifiedFeatureUsage');
          await saveTaskDetails(req.featureUsage.usage, {
            taskId: taskId,
            creditCost: estimatedCost,
            isFree: req.featureUsage?.usageType === 'free'
          });
          console.log(`å·²å³æ—¶å†™å…¥æ–‡ç”Ÿè§†é¢‘ä»»åŠ¡è®°å½•åˆ°æ•°æ®åº“ taskId=${taskId}`);
        }
      } catch (saveErr) {
        console.error('å³æ—¶ä¿å­˜æ–‡ç”Ÿè§†é¢‘ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', saveErr);
        // ç»§ç»­æµç¨‹ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
      }
      
      console.log(`ä»»åŠ¡ä¿¡æ¯å·²å­˜å‚¨åˆ°å…¨å±€å˜é‡: taskId=${taskId}, userId=${userId}, creditCost=${estimatedCost}${req.featureUsage?.usageType === 'free' ? ' (å…è´¹æ¬¡æ•°)' : ''}`);
      
      // åŠŸèƒ½ä½¿ç”¨è®°å½•å·²ç”±ä¸­é—´ä»¶å¤„ç†ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤è®°å½•
      
      // è¿”å›ä»»åŠ¡ID - ä½¿ç”¨ä¸é˜¿é‡Œäº‘ä¸€è‡´çš„å“åº”æ ¼å¼ï¼Œå®Œå…¨åŒ¹é…SDKè¿”å›æ ¼å¼
      const createResponse = {
        output: {
          task_id: taskId,
          task_status: normalizedStatus, // ä½¿ç”¨è§„èŒƒåŒ–åçš„çŠ¶æ€
          // å¦‚æœé˜¿é‡Œäº‘APIè¿”å›äº†submit_timeï¼Œåˆ™ä½¿ç”¨å®ƒ
          submit_time: response.data.output.submit_time || new Date().toISOString().replace('T', ' ').split('.')[0],
          // å¦‚æœé˜¿é‡Œäº‘APIè¿”å›äº†åŸå§‹æç¤ºè¯ï¼Œåˆ™ä½¿ç”¨å®ƒï¼Œå¦åˆ™ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯
          orig_prompt: response.data.output.orig_prompt || prompt
        },
        request_id: response.data.request_id || null,
        // SDKå“åº”æ ¼å¼åŒ…å«çŠ¶æ€ç 
        status_code: response.status,
        // ä»¥ä¸‹å­—æ®µæ˜¯ä¸ºäº†ä¿æŒä¸å‰ç«¯çš„å…¼å®¹æ€§
        success: true,
        taskId: taskId,
        message: 'è§†é¢‘ç”Ÿæˆä»»åŠ¡å·²åˆ›å»ºï¼Œæ­£åœ¨å¤„ç†ä¸­'
      };
      
      console.log('è¿”å›åˆ›å»ºä»»åŠ¡å“åº”:', JSON.stringify(createResponse, null, 2));
      return res.json(createResponse);
    } catch (error) {
      console.error('APIè°ƒç”¨å¤±è´¥:', error);
      
      // å‡†å¤‡é”™è¯¯å“åº”
      const errorResponse = {
        success: false,
        status_code: error.response ? error.response.status : 500,
        code: 'ApiCallError',
        message: 'åˆ›å»ºè§†é¢‘ç”Ÿæˆä»»åŠ¡å¤±è´¥',
        request_id: null
      };
      
      if (error.response && error.response.data) {
        console.error('APIé”™è¯¯å“åº”:', error.response.status, error.response.data);
        
        // é˜¿é‡Œäº‘å“åº”æ ¼å¼å¤„ç†
        const errorData = error.response.data;
        
        if (errorData.code) {
          // é”™è¯¯ä¿¡æ¯ç›´æ¥åœ¨å“åº”æ ¹çº§åˆ«
          errorResponse.code = errorData.code;
          errorResponse.message = errorData.message || errorResponse.message;
          errorResponse.request_id = errorData.request_id || null;
          
          // å¦‚æœæ˜¯å‚æ•°é”™è¯¯ï¼Œä»¥é˜¿é‡Œäº‘æ ¼å¼è¿”å›
          if (errorData.code === 'InvalidParameter' || errorData.code.startsWith('Invalid')) {
            return res.status(error.response.status).json({
              code: errorData.code,
              message: errorData.message || 'å‚æ•°é”™è¯¯',
              request_id: errorData.request_id || null,
              // å…¼å®¹å‰ç«¯
              success: false
            });
          }
        } else if (errorData.output && errorData.output.code) {
          // é”™è¯¯ä¿¡æ¯åœ¨outputå­—æ®µä¸‹
          return res.status(error.response.status).json({
            output: {
              code: errorData.output.code,
              message: errorData.output.message || 'ä»»åŠ¡åˆ›å»ºå¤±è´¥'
            },
            request_id: errorData.request_id || null,
            // å…¼å®¹å‰ç«¯
            success: false
          });
        }
        
        return res.status(error.response.status).json(errorResponse);
      } else if (error.request) {
        console.error('æœªæ”¶åˆ°APIå“åº”:', error.request);
        errorResponse.code = 'RequestTimeout';
        errorResponse.message = 'åˆ›å»ºè§†é¢‘ç”Ÿæˆä»»åŠ¡å¤±è´¥: æœåŠ¡å™¨æ— å“åº”';
        
        return res.status(500).json(errorResponse);
      } else {
        console.error('è¯·æ±‚é…ç½®é”™è¯¯:', error.message);
        errorResponse.code = 'ConfigError';
        errorResponse.message = `åˆ›å»ºè§†é¢‘ç”Ÿæˆä»»åŠ¡å¤±è´¥: ${error.message}`;
        
        return res.status(500).json(errorResponse);
      }
    }
  } catch (error) {
    console.error('å¤„ç†æ–‡ç”Ÿè§†é¢‘è¯·æ±‚å‡ºé”™:', error);
    return res.status(500).json({
      success: false,
      code: 'InternalServerError',
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      request_id: null
    });
  }
});

/**
 * @route   GET /api/text-to-video/status/:taskId
 * @desc    è·å–æ–‡ç”Ÿè§†é¢‘ä»»åŠ¡çŠ¶æ€
 * @access  ç§æœ‰
 */
router.get('/status/:taskId', protect, async (req, res) => {
  try {
    const { taskId } = req.params;
    const userId = req.user.id;
    const forceRefresh = req.query.force === 'true'; // æ˜¯å¦å¼ºåˆ¶åˆ·æ–°çŠ¶æ€
    
    console.log(`æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€: taskId=${taskId}, userId=${userId}, forceRefresh=${forceRefresh}`);
    
    // å‚æ•°éªŒè¯
    if (!taskId) {
      return res.status(400).json({
        success: false,
        code: 'InvalidParameter',
        message: 'è¯·æä¾›ä»»åŠ¡ID',
        request_id: null
      });
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·çš„ä»»åŠ¡
    if (!userTasks[userId] || !userTasks[userId].find(task => task.id === taskId)) {
      console.log(`ä»»åŠ¡ä¸å­˜åœ¨æˆ–ä¸å±äºå½“å‰ç”¨æˆ·: taskId=${taskId}, userId=${userId}`);
      return res.status(404).json({
        success: false,
        code: 'TaskNotFound',
        message: 'ä»»åŠ¡ä¸å­˜åœ¨æˆ–ä¸å±äºå½“å‰ç”¨æˆ·',
        request_id: null
      });
    }
    
    // æ£€æŸ¥çŠ¶æ€ç¼“å­˜
    const now = Date.now();
    const cachedStatus = taskStatusCache[taskId];
    const userTaskIndex = userTasks[userId].findIndex(task => task.id === taskId);
    const currentStatus = userTaskIndex !== -1 ? userTasks[userId][userTaskIndex].status : null;
    
    // è·å–å½“å‰çŠ¶æ€çš„æœ€å°æŸ¥è¯¢é—´éš”
    const minInterval = currentStatus && STATUS_QUERY_MIN_INTERVAL[currentStatus] 
      ? STATUS_QUERY_MIN_INTERVAL[currentStatus] 
      : STATUS_QUERY_MIN_INTERVAL.default;
    
    // å¦‚æœæœ‰ç¼“å­˜ä¸”æœªè¶…è¿‡æœ€å°é—´éš”ï¼Œä¸”éå¼ºåˆ¶åˆ·æ–°çŠ¶æ€ï¼Œåˆ™è¿”å›ç¼“å­˜çš„çŠ¶æ€
    if (cachedStatus && 
        now - cachedStatus.lastFetchTime < minInterval && 
        !forceRefresh &&
        // å¦‚æœçŠ¶æ€æ˜¯SUCCEEDEDæˆ–FAILEDï¼Œç¼“å­˜å¯ä»¥é•¿æœŸæœ‰æ•ˆ
        (cachedStatus.status === 'SUCCEEDED' || cachedStatus.status === 'FAILED' || (now - cachedStatus.lastFetchTime < 30000))) {
      console.log(`è¿”å›ç¼“å­˜çš„ä»»åŠ¡çŠ¶æ€: ${taskId} => ${cachedStatus.status}, ç¼“å­˜æ—¶é—´: ${new Date(cachedStatus.lastFetchTime).toISOString()}`);
      
      // è¿”å›ç¼“å­˜çš„å“åº”
      return res.json(cachedStatus.data);
    }
    
    try {
      console.log(`å‘é€APIè¯·æ±‚æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€: taskId=${taskId}`);
      
      // è°ƒç”¨é˜¿é‡Œäº‘æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€APIï¼ˆä¸¥æ ¼æŒ‰ç…§é˜¿é‡Œäº‘æ–‡æ¡£æ„å»ºURLï¼‰
      const response = await axios.get(
        `https://dashscope.aliyuncs.com/api/v1/tasks/${taskId}`,
        {
          headers: {
            'Authorization': `Bearer ${process.env.DASHSCOPE_API_KEY}`
          },
          timeout: 15000 // è®¾ç½®15ç§’è¶…æ—¶
        }
      );
      
      console.log('ä»»åŠ¡çŠ¶æ€APIå“åº”:', JSON.stringify(response.data, null, 2));
      
      // éªŒè¯å“åº”æ ¼å¼ï¼ˆé˜¿é‡Œäº‘è¿”å›æ ¼å¼æ ‡å‡†éªŒè¯ï¼‰
      if (!response.data) {
        console.error('APIè¿”å›ç©ºå“åº”');
        return res.status(500).json({
          success: false,
          code: 'EmptyResponse',
          message: 'APIè¿”å›ç©ºå“åº”',
          request_id: null
        });
      }
      
      // å­˜åœ¨é”™è¯¯ç æ—¶çš„å¤„ç†
      if (response.data.code) {
        console.error('APIè¿”å›é”™è¯¯ç :', response.data.code, response.data.message);
        return res.status(400).json({
          success: false,
          code: response.data.code,
          message: response.data.message || 'æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥',
          request_id: response.data.request_id || null
        });
      }
      
      // æ£€æŸ¥æ˜¯å¦åŒ…å«å¿…è¦å­—æ®µ
      if (!response.data.output) {
        console.error('APIå“åº”æ ¼å¼å¼‚å¸¸,ç¼ºå°‘outputå­—æ®µ:', response.data);
        return res.status(500).json({
          success: false,
          code: 'InvalidResponse',
          message: 'APIå“åº”æ ¼å¼å¼‚å¸¸,ç¼ºå°‘outputå­—æ®µ',
          request_id: response.data.request_id || null
        });
      }
      
      if (!response.data.output.task_status) {
        console.error('APIå“åº”ä¸­æœªæ‰¾åˆ°task_status:', response.data);
        return res.status(500).json({
          success: false,
          code: 'InvalidResponse',
          message: 'APIå“åº”æ ¼å¼å¼‚å¸¸ï¼Œæœªæ‰¾åˆ°ä»»åŠ¡çŠ¶æ€',
          request_id: response.data.request_id || null
        });
      }
      
      const taskStatus = response.data.output.task_status;
      console.log(`ä»»åŠ¡çŠ¶æ€: taskId=${taskId}, status=${taskStatus}, request_id=${response.data.request_id || 'æ— '}`);
      
      // è§„èŒƒåŒ–ä»»åŠ¡çŠ¶æ€ - åªæœ‰SUCCEEDEDå’ŒFAILEDæ˜¯ç»ˆæ€ï¼Œå…¶ä»–éƒ½è§†ä¸ºRUNNING
      const normalizedStatus = 
        taskStatus === 'SUCCEEDED' ? 'SUCCEEDED' :
        taskStatus === 'FAILED' ? 'FAILED' : 'RUNNING';
        
      console.log(`è§„èŒƒåŒ–åçš„ä»»åŠ¡çŠ¶æ€: ${normalizedStatus} (åŸå§‹çŠ¶æ€: ${taskStatus})`);
      
      // æ›´æ–°æœ¬åœ°ä»»åŠ¡çŠ¶æ€
      const userTaskIndex = userTasks[userId].findIndex(task => task.id === taskId);
      if (userTaskIndex !== -1) {
        // ä¿å­˜æ—§çŠ¶æ€ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦æ˜¯é¦–æ¬¡æˆåŠŸ
        const previousStatus = userTasks[userId][userTaskIndex].status;
        const isFirstSuccess = normalizedStatus === 'SUCCEEDED' && previousStatus !== 'SUCCEEDED';
        
        console.log(`ä»»åŠ¡çŠ¶æ€å˜åŒ–: ${previousStatus} -> ${normalizedStatus}, æ˜¯å¦é¦–æ¬¡æˆåŠŸ: ${isFirstSuccess}`);
        
        // æ›´æ–°ä»»åŠ¡çŠ¶æ€
        userTasks[userId][userTaskIndex].status = normalizedStatus;
        
        // åŒæ—¶æ›´æ–°OSSå­˜å‚¨
        try {
          await updateTaskInOSS(userId, taskId, { status: normalizedStatus });
          console.log(`ä»»åŠ¡çŠ¶æ€å·²æ›´æ–°åˆ°OSS: ${taskId} -> ${normalizedStatus}`);
        } catch (ossError) {
          console.error('æ›´æ–°ä»»åŠ¡çŠ¶æ€åˆ°OSSå¤±è´¥:', ossError);
          // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
        }
        
        // å¦‚æœä»»åŠ¡å®Œæˆï¼Œè®°å½•è§†é¢‘URL
        if (normalizedStatus === 'SUCCEEDED') {
          // æ£€æŸ¥è§†é¢‘URL
          let videoUrl = null;
          
          // é˜¿é‡Œäº‘å¯èƒ½ä¼šåœ¨ä¸åŒä½ç½®è¿”å›è§†é¢‘URL
          if (response.data.output.video_url) {
            videoUrl = response.data.output.video_url;
          } else if (response.data.output.result && response.data.output.result.video_url) {
            videoUrl = response.data.output.result.video_url;
          } else if (response.data.output.result && response.data.output.result.urls && response.data.output.result.urls.length > 0) {
            videoUrl = response.data.output.result.urls[0];
          }
          
          if (!videoUrl) {
            console.error('ä»»åŠ¡æˆåŠŸä½†æœªæ‰¾åˆ°è§†é¢‘URL:', response.data);
            return res.status(500).json({
              success: false,
              code: 'MissingVideoUrl',
              message: 'ä»»åŠ¡æˆåŠŸä½†æœªæ‰¾åˆ°è§†é¢‘URL',
              request_id: response.data.request_id || null
            });
          }
          
          // å¦‚æœæ˜¯é¦–æ¬¡æˆåŠŸï¼ˆçŠ¶æ€ä»éSUCCEEDEDå˜ä¸ºSUCCEEDEDï¼‰ï¼Œæ‰£é™¤ç§¯åˆ†
          if (isFirstSuccess) {
            // è·å–ä»»åŠ¡æ¶ˆè€—çš„ç§¯åˆ†
            const taskCost = userTasks[userId][userTaskIndex].cost || 0;
            console.log(`å‡†å¤‡æ‰£é™¤ç§¯åˆ†: ä»»åŠ¡ID=${taskId}, ç§¯åˆ†=${taskCost}, ç”¨æˆ·ID=${userId}`);
            
            // æ›´æ–°å…¨å±€å˜é‡ä¸­çš„ä»»åŠ¡çŠ¶æ€
            if (global.textToVideoTasks && global.textToVideoTasks[taskId]) {
              global.imageToVideoTasks[taskId].status = 'SUCCEEDED';
              global.imageToVideoTasks[taskId].videoUrl = videoUrl;
              global.imageToVideoTasks[taskId].completedAt = new Date();
              console.log(`æ›´æ–°å…¨å±€å˜é‡ä¸­çš„ä»»åŠ¡çŠ¶æ€: taskId=${taskId}, status=SUCCEEDED`);
            }
            
            // æŸ¥è¯¢ç”¨æˆ·çš„åŠŸèƒ½ä½¿ç”¨è®°å½•ï¼Œé‡æ–°æ£€æŸ¥å…è´¹æ¬¡æ•°ä½¿ç”¨æƒ…å†µ
            try {
              const featureUsage = await FeatureUsage.findOne({
                where: {
                  userId: userId,
                  featureName: 'text-to-video'
                }
              });
              
              if (featureUsage) {
                // è·å–åŠŸèƒ½é…ç½®
                const { FEATURES } = require('../middleware/featureAccess');
                const featureConfig = FEATURES['text-to-video'] || { freeUsage: 1 };
                
                // ä½¿ç”¨ä»»åŠ¡åˆ›å»ºæ—¶çš„å…è´¹æ ‡è®°ï¼Œè€Œä¸æ˜¯é‡æ–°åˆ¤æ–­
                // å› ä¸ºusageCountå·²ç»åœ¨ä¸­é—´ä»¶ä¸­è¢«æ›´æ–°ï¼Œé‡æ–°åˆ¤æ–­ä¼šå¯¼è‡´é€»è¾‘é”™è¯¯
                const isFree = global.textToVideoTasks[taskId].isFree;
                
                console.log(`é‡æ–°æ£€æŸ¥å…è´¹æ¬¡æ•°ä½¿ç”¨æƒ…å†µ: ç”¨æˆ·ID=${userId}, åŠŸèƒ½=text-to-video, å½“å‰ä½¿ç”¨æ¬¡æ•°=${featureUsage.usageCount}, å…è´¹æ¬¡æ•°=${featureConfig.freeUsage}, æ˜¯å¦å…è´¹=${isFree}`);
                
                // æ›´æ–°å…¨å±€å˜é‡ä¸­çš„å…è´¹æ ‡è®°
                if (global.textToVideoTasks && global.textToVideoTasks[taskId]) {
                  global.textToVideoTasks[taskId].isFree = isFree;
                }
                
                // æ ¹æ®å®é™…æƒ…å†µå†³å®šæ˜¯å¦æ‰£é™¤ç§¯åˆ†
                if (isFree) {
                  console.log(`ä»»åŠ¡æ˜¯å…è´¹æ¬¡æ•°ä½¿ç”¨ï¼Œè·³è¿‡æ‰£é™¤ç§¯åˆ†: ä»»åŠ¡ID=${taskId}`);
                  // æ›´æ–°å…¨å±€å˜é‡ä¸­çš„çŠ¶æ€ï¼Œä½†ä¸æ‰£é™¤ç§¯åˆ†
                  if (global.textToVideoTasks && global.textToVideoTasks[taskId]) {
                    global.textToVideoTasks[taskId].hasChargedCredits = true;
                    global.textToVideoTasks[taskId].creditCost = 0; // å…è´¹ä½¿ç”¨ä¸æ¶ˆè€—ç§¯åˆ†
                  }
                  
                  // ä¿å­˜ä»»åŠ¡è¯¦æƒ…
                  const { saveTaskDetails } = require('../middleware/unifiedFeatureUsage');
                  await saveTaskDetails(featureUsage, {
                    taskId: taskId,
                    featureName: 'text-to-video',
                    status: 'completed',
                    creditCost: 0, // å…è´¹ä½¿ç”¨ä¸æ¶ˆè€—ç§¯åˆ†
                    isFree: true,
                    extraData: {
                      videoUrl: videoUrl,
                      prompt: userTasks[userId][userTaskIndex].prompt,
                      model: userTasks[userId][userTaskIndex].model,
                      size: userTasks[userId][userTaskIndex].size
                    }
                  });
                  console.log(`å·²æ›´æ–°æ–‡ç”Ÿè§†é¢‘å…è´¹ä»»åŠ¡è®°å½•: ä»»åŠ¡ID=${taskId}`);
                } else {
                  // ç§¯åˆ†æ‰£é™¤é€»è¾‘å·²ç§»è‡³unifiedFeatureUsage.jsä¸­ç»Ÿä¸€å¤„ç†
                  // è¿™é‡Œä¸å†ç›´æ¥æ‰£é™¤ç§¯åˆ†ï¼Œé¿å…é‡å¤æ‰£è´¹
                  
                  // ä¿å­˜ä»»åŠ¡è¯¦æƒ…
                  const { saveTaskDetails } = require('../middleware/unifiedFeatureUsage');
                  await saveTaskDetails(featureUsage, {
                    taskId: taskId,
                    featureName: 'text-to-video',
                    status: 'completed',
                    creditCost: taskCost,
                    isFree: false,
                    extraData: {
                      videoUrl: videoUrl,
                      prompt: userTasks[userId][userTaskIndex].prompt,
                      model: userTasks[userId][userTaskIndex].model,
                      size: userTasks[userId][userTaskIndex].size
                    }
                  });
                  console.log(`å·²è§¦å‘æ–‡ç”Ÿè§†é¢‘ä»»åŠ¡å®Œæˆæ‰£è´¹é€»è¾‘: ä»»åŠ¡ID=${taskId}, ç§¯åˆ†=${taskCost}`);
                  
                  // æ ‡è®°çŠ¶æ€
                  if (global.textToVideoTasks && global.textToVideoTasks[taskId]) {
                    global.textToVideoTasks[taskId].hasChargedCredits = true;
                  }
                }
              } else {
                console.error(`æœªæ‰¾åˆ°ç”¨æˆ·ID=${userId}çš„text-to-videoåŠŸèƒ½ä½¿ç”¨è®°å½•`);
              }
            } catch (err) {
              console.error('å¤„ç†æ–‡ç”Ÿè§†é¢‘ä»»åŠ¡å®Œæˆæ‰£è´¹é€»è¾‘å¤±è´¥:', err);
            }
          }
          
          userTasks[userId][userTaskIndex].videoUrl = videoUrl;
          console.log(`ä»»åŠ¡å®Œæˆï¼Œè§†é¢‘URLå·²ä¿å­˜: ${videoUrl}`);
          
          // åŒæ—¶æ›´æ–°OSSå­˜å‚¨ä¸­çš„è§†é¢‘URL
          try {
            await updateTaskInOSS(userId, taskId, { videoUrl: videoUrl });
            console.log(`è§†é¢‘URLå·²æ›´æ–°åˆ°OSS: ${taskId}`);
          } catch (ossError) {
            console.error('æ›´æ–°è§†é¢‘URLåˆ°OSSå¤±è´¥:', ossError);
            // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
          }
          
          // æ–‡ç”Ÿè§†é¢‘ä¸ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒï¼Œæ³¨é‡Šæ‰å†å²è®°å½•ä¿å­˜
          console.log('æ–‡ç”Ÿè§†é¢‘å®Œæˆï¼Œè·³è¿‡ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒå†å²è®°å½•');
          // try {
          //   await ImageHistory.create({
          //     userId,
          //     imageUrl: videoUrl,
          //     processType: 'æ–‡ç”Ÿè§†é¢‘',
          //     description: userTasks[userId][userTaskIndex].prompt,
          //     metadata: JSON.stringify({
          //       model: userTasks[userId][userTaskIndex].model,
          //       size: userTasks[userId][userTaskIndex].size
          //     }),
          //     type: 'TEXT_TO_VIDEO_NO_DOWNLOAD' // ä½¿ç”¨ç‰¹æ®Šç±»å‹æ ‡è®°ï¼Œä¸æ˜¾ç¤ºåœ¨ä¸‹è½½ä¸­å¿ƒ
          //   });
          //   console.log('è§†é¢‘è®°å½•å·²ä¿å­˜åˆ°å†å²è®°å½•ï¼Œä½†ä¸ä¼šæ˜¾ç¤ºåœ¨ä¸‹è½½ä¸­å¿ƒ');
          // } catch (historyError) {
          //   console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', historyError);
          //   // ç»§ç»­å¤„ç†ï¼Œä¸å½±å“ä¸»è¦åŠŸèƒ½
          // }
        }
      }
      
      // è·å–è§†é¢‘URL (å¦‚æœæœ‰)
      let videoUrl = null;
      if (normalizedStatus === 'SUCCEEDED') {
        // é˜¿é‡Œäº‘è¿”å›æˆåŠŸç»“æœå¯èƒ½çš„å‡ ç§æ ¼å¼ï¼š
        // 1. output.video_url
        // 2. output.result.video_url 
        // 3. output.result.urls[0]
        if (response.data.output.video_url) {
          videoUrl = response.data.output.video_url;
        } else if (response.data.output.result && response.data.output.result.video_url) {
          videoUrl = response.data.output.result.video_url;
        } else if (response.data.output.result && response.data.output.result.urls && response.data.output.result.urls.length > 0) {
          videoUrl = response.data.output.result.urls[0];
        }
      }
      
      // æ„å»ºç¬¦åˆé˜¿é‡Œäº‘SDKå“åº”æ ¼å¼çš„å“åº”
      const responseData = {
        status_code: 200, // æˆåŠŸçŠ¶æ€ç 
        success: true,
        output: {
          task_status: normalizedStatus, // ä½¿ç”¨è§„èŒƒåŒ–åçš„çŠ¶æ€
          task_id: taskId
        },
        request_id: response.data.request_id || null
      };
      
      // æ¨¡æ‹ŸSDKçš„waitå‡½æ•°è¡Œä¸º - åªåœ¨è§†é¢‘ç”ŸæˆæˆåŠŸæˆ–å¤±è´¥æ—¶è¿”å›å®Œæ•´ç»“æœ
      if (normalizedStatus === 'SUCCEEDED' || normalizedStatus === 'FAILED') {
        if (videoUrl) {
          // æˆåŠŸçŠ¶æ€ä¸‹çš„å¤„ç†
          responseData.output.video_url = videoUrl;
          
          // å¦‚æœæœ‰æ—¶é—´ä¿¡æ¯ï¼Œæ·»åŠ åˆ°å“åº”ä¸­
          if (response.data.output.submit_time) {
            responseData.output.submit_time = response.data.output.submit_time;
          }
          
          if (response.data.output.scheduled_time) {
            responseData.output.scheduled_time = response.data.output.scheduled_time;
          }
          
          if (response.data.output.end_time) {
            responseData.output.end_time = response.data.output.end_time;
          }
          
          // å¦‚æœæœ‰æç¤ºè¯ä¿¡æ¯ï¼Œæ·»åŠ åˆ°å“åº”ä¸­
          if (response.data.output.orig_prompt) {
            responseData.output.orig_prompt = response.data.output.orig_prompt;
          } else if (userTaskIndex !== -1) {
            responseData.output.orig_prompt = userTasks[userId][userTaskIndex].prompt || '';
          }
          
          if (response.data.output.actual_prompt) {
            responseData.output.actual_prompt = response.data.output.actual_prompt;
          }
          
          // å…¼å®¹è€ç‰ˆæœ¬å‰ç«¯
          responseData.status = normalizedStatus;
          responseData.videoUrl = videoUrl;
          responseData.task_id = taskId;
          responseData.task_status = normalizedStatus;
          responseData.video_url = videoUrl;
        } else if (normalizedStatus === 'FAILED') {
          // å¤±è´¥çŠ¶æ€ä¸‹çš„å¤„ç†
          if (response.data.output.code) {
            responseData.output.code = response.data.output.code;
            responseData.output.message = response.data.output.message || 'ä»»åŠ¡æ‰§è¡Œå¤±è´¥';
            // SDKæ ¼å¼é”™è¯¯å“åº”å¤„ç†
            responseData.code = response.data.output.code;
            responseData.message = response.data.output.message || 'ä»»åŠ¡æ‰§è¡Œå¤±è´¥';
          }
        }
      } else {
        // å…¶ä»–çŠ¶æ€ï¼ˆPENDING/RUNNINGï¼‰æ—¶åªè¿”å›æœ€åŸºæœ¬çš„ä¿¡æ¯
        console.log(`ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­: ${normalizedStatus}`);
      }
      
      // å¦‚æœæœ‰ç”¨é‡ä¿¡æ¯ï¼Œæ·»åŠ åˆ°å“åº”ä¸­
      if (response.data.usage) {
        responseData.usage = response.data.usage;
        
        // ç¡®ä¿usageåŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
        if (!responseData.usage.video_duration && normalizedStatus === 'SUCCEEDED') {
          responseData.usage.video_duration = 5; // é»˜è®¤5ç§’
        }
        
        if (!responseData.usage.video_ratio && userTaskIndex !== -1) {
          responseData.usage.video_ratio = userTasks[userId][userTaskIndex].size || '1280*720'; 
        }
        
        if (!responseData.usage.video_count && normalizedStatus === 'SUCCEEDED') {
          responseData.usage.video_count = 1; // é»˜è®¤ç”Ÿæˆ1ä¸ªè§†é¢‘
        }
      } else if (normalizedStatus === 'SUCCEEDED') {
        // å¦‚æœé˜¿é‡Œäº‘æœªè¿”å›ç”¨é‡ä¿¡æ¯ä½†ä»»åŠ¡æˆåŠŸï¼Œæ·»åŠ é»˜è®¤ç”¨é‡ä¿¡æ¯
        responseData.usage = {
          video_duration: 5, // é»˜è®¤5ç§’
          video_ratio: userTaskIndex !== -1 ? userTasks[userId][userTaskIndex].size || '1280*720' : '1280*720',
          video_count: 1
        };
      }
      
      // æ›´æ–°ä»»åŠ¡çŠ¶æ€ç¼“å­˜
      taskStatusCache[taskId] = {
        status: normalizedStatus, // ä½¿ç”¨è§„èŒƒåŒ–åçš„çŠ¶æ€
        lastFetchTime: now,
        data: responseData
      };
      
      // å¦‚æœä»»åŠ¡å·²å®Œæˆæˆ–å¤±è´¥ï¼Œå¯ä»¥ä¿ç•™è¾ƒé•¿æ—¶é—´çš„ç¼“å­˜
      if (normalizedStatus === 'SUCCEEDED' || normalizedStatus === 'FAILED') {
        console.log(`ä»»åŠ¡å·²å®Œæˆæˆ–å¤±è´¥ï¼Œè®¾ç½®é•¿æœŸç¼“å­˜: ${taskId} => ${normalizedStatus}`);
        // è¿™äº›çŠ¶æ€æ˜¯ç»ˆæ€ï¼Œå¯ä»¥ç¼“å­˜æ›´é•¿æ—¶é—´
        // taskStatusCacheä¼šä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œç›´åˆ°æœåŠ¡å™¨é‡å¯
      }
      
      // æ›´æ–°å…¨å±€å˜é‡ä¸­çš„ä»»åŠ¡çŠ¶æ€
      const taskStatusFromResponse = response.data.output?.task_status;
      if (global.imageToVideoTasks && global.imageToVideoTasks[taskId]) {
          // å¦‚æœä»»åŠ¡æˆåŠŸå®Œæˆ
          if (taskStatusFromResponse === 'SUCCEEDED') {
              global.imageToVideoTasks[taskId].status = 'SUCCEEDED';
              global.imageToVideoTasks[taskId].videoUrl = response.data.output.video_url;
              global.imageToVideoTasks[taskId].completedAt = new Date();
              console.log(`æ›´æ–°å…¨å±€å˜é‡ä¸­çš„ä»»åŠ¡çŠ¶æ€: taskId=${taskId}, status=SUCCEEDED`);
          }
          // å¦‚æœä»»åŠ¡å¤±è´¥
          else if (taskStatusFromResponse === 'FAILED') {
              global.textToVideoTasks[taskId].status = 'FAILED';
              global.textToVideoTasks[taskId].errorMessage = response.data.message || 'ä»»åŠ¡æ‰§è¡Œå¤±è´¥';
              global.imageToVideoTasks[taskId].completedAt = new Date();
              console.log(`æ›´æ–°å…¨å±€å˜é‡ä¸­çš„ä»»åŠ¡çŠ¶æ€: taskId=${taskId}, status=FAILED`);
          }
      }
      
      console.log('è¿”å›ä»»åŠ¡çŠ¶æ€å“åº”:', JSON.stringify(responseData, null, 2));
      return res.json(responseData);
    } catch (error) {
      // å¦‚æœæœ‰ç¼“å­˜ä½†è¯·æ±‚å¤±è´¥ï¼Œè¿”å›ç¨æ—§çš„ç¼“å­˜æ•°æ®
      if (cachedStatus && (now - cachedStatus.lastFetchTime < 60000)) { // ä¸€åˆ†é’Ÿå†…çš„ç¼“å­˜ä»å¯ç”¨
        console.log(`APIè¯·æ±‚å¤±è´¥ï¼Œä½†è¿”å›ç¼“å­˜æ•°æ®: ${taskId} => ${cachedStatus.status}`);
        return res.json(cachedStatus.data);
      }
      
      console.error('è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
      
      // å‡†å¤‡é”™è¯¯å“åº” - ä¸SDKé”™è¯¯å“åº”æ ¼å¼ä¸€è‡´
      const errorResponse = {
        success: false,
        status_code: error.response ? error.response.status : 500,
        code: 'UnknownError',
        message: 'è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥',
        request_id: null
      };
      
      if (error.response && error.response.data) {
        // é˜¿é‡Œäº‘APIè¿”å›çš„é”™è¯¯
        console.error('APIé”™è¯¯å“åº”:', error.response.status, error.response.data);
        
        // é˜¿é‡Œäº‘å“åº”æ ¼å¼å¤„ç† - å¯èƒ½åœ¨response.dataä¸‹æˆ–response.data.outputä¸‹
        const errorData = error.response.data;
        
        if (errorData.code) {
          // é”™è¯¯ä¿¡æ¯ç›´æ¥åœ¨å“åº”æ ¹çº§åˆ« - ä¸SDKé”™è¯¯æ ¼å¼ä¸€è‡´
          return res.status(error.response.status).json({
            status_code: error.response.status,
            code: errorData.code,
            message: errorData.message || 'è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥',
            request_id: errorData.request_id || null,
            success: false // å…¼å®¹å‰ç«¯
          });
        } else if (errorData.output && errorData.output.code) {
          // é”™è¯¯ä¿¡æ¯åœ¨outputå­—æ®µä¸‹ - æ„å»ºä¸SDKé”™è¯¯æ ¼å¼ä¸€è‡´çš„å“åº”
          return res.status(error.response.status).json({
            status_code: error.response.status,
            code: errorData.output.code,
            message: errorData.output.message || 'ä»»åŠ¡æ‰§è¡Œå¤±è´¥',
            output: {
              task_id: taskId,
              task_status: 'FAILED',
              code: errorData.output.code,
              message: errorData.output.message || 'ä»»åŠ¡æ‰§è¡Œå¤±è´¥'
            },
            request_id: errorData.request_id || null,
            success: false // å…¼å®¹å‰ç«¯
          });
        }
        
        return res.status(error.response.status).json(errorResponse);
      } else if (error.request) {
        // è¯·æ±‚å·²å‘é€ä½†æœªæ”¶åˆ°å“åº”
        console.error('æœªæ”¶åˆ°APIå“åº”:', error.request);
        errorResponse.code = 'RequestTimeout';
        errorResponse.message = 'è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥: æœåŠ¡å™¨æ— å“åº”';
        
        return res.status(500).json(errorResponse);
      } else {
        // è¯·æ±‚é…ç½®é”™è¯¯
        console.error('è¯·æ±‚é…ç½®é”™è¯¯:', error.message);
        errorResponse.code = 'ConfigError';
        errorResponse.message = `è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥: ${error.message}`;
        
        return res.status(500).json(errorResponse);
      }
    }
  } catch (error) {
    console.error('å¤„ç†è·å–ä»»åŠ¡çŠ¶æ€è¯·æ±‚å‡ºé”™:', error);
    return res.status(500).json({
      success: false,
      code: 'InternalServerError',
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      request_id: null
    });
  }
});

/**
 * @route   GET /api/text-to-video/tasks
 * @desc    è·å–ç”¨æˆ·æ‰€æœ‰æ–‡ç”Ÿè§†é¢‘ä»»åŠ¡ï¼ˆä»OSSå­˜å‚¨ï¼‰
 * @access  ç§æœ‰
 */
router.get('/tasks', protect, async (req, res) => {
  try {
    const userId = req.user.id;
    
    console.log(`è·å–ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨: userId=${userId}`);
    
    // ä»OSSåŠ è½½ä»»åŠ¡åˆ—è¡¨
    const tasks = await loadTasksFromOSS(userId);
    
    // è¿‡æ»¤24å°æ—¶å†…çš„ä»»åŠ¡
    const now = new Date();
    const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    const recentTasks = tasks.filter(task => {
      const taskTime = new Date(task.createdAt);
      return taskTime >= twentyFourHoursAgo;
    });
    
    // åªè¿”å›æœ€æ–°çš„ä¸€æ¡è®°å½•
    const latestTask = recentTasks.length > 0 ? [recentTasks[0]] : [];
    
    console.log(`æ‰¾åˆ° ${tasks.length} ä¸ªä»»åŠ¡ï¼Œ24å°æ—¶å†… ${recentTasks.length} ä¸ªï¼Œè¿”å›æœ€æ–° ${latestTask.length} ä¸ª`);
    
    return res.json(latestTask);
  } catch (error) {
    console.error('è·å–ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨å‡ºé”™:', error);
    return res.status(500).json({
      success: false,
      code: 'InternalServerError',
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      request_id: null
    });
  }
});

/**
 * @route   GET /api/tasks/image-to-video
 * @desc    è·å–ç”¨æˆ·æ‰€æœ‰å›¾ç”Ÿè§†é¢‘ä»»åŠ¡ï¼ˆä»OSSå­˜å‚¨ï¼‰
 * @access  ç§æœ‰
 */
router.get('/tasks/image-to-video', protect, async (req, res) => {
  try {
    const userId = req.user.id;
    
    console.log(`è·å–ç”¨æˆ·å›¾ç”Ÿè§†é¢‘ä»»åŠ¡åˆ—è¡¨: userId=${userId}`);
    
    // ä»OSSåŠ è½½ä»»åŠ¡åˆ—è¡¨
    const tasks = await loadTasksFromOSS(userId, 'image-to-video');
    
    // è¿‡æ»¤24å°æ—¶å†…çš„ä»»åŠ¡
    const now = new Date();
    const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    const recentTasks = tasks.filter(task => {
      const taskTime = new Date(task.createdAt);
      return taskTime >= twentyFourHoursAgo;
    });
    
    // åªè¿”å›æœ€æ–°çš„ä¸€æ¡è®°å½•
    const latestTask = recentTasks.length > 0 ? [recentTasks[0]] : [];
    
    // å¦‚æœæœ‰ä»»åŠ¡ï¼ŒæŸ¥è¯¢æœ€æ–°çŠ¶æ€
    if (latestTask.length > 0) {
      const task = latestTask[0];
      try {
        // æŸ¥è¯¢ä»»åŠ¡æœ€æ–°çŠ¶æ€
        const response = await axios({
          method: 'GET',
          url: `https://dashscope.aliyuncs.com/api/v1/tasks/${task.id}`,
          headers: {
            'Authorization': `Bearer ${process.env.DASHSCOPE_API_KEY}`
          }
        });
        
        if (response.data && response.data.output) {
          const taskStatus = response.data.output.task_status;
          const videoUrl = response.data.output.result_url || response.data.output.video_url;
          
          // æ›´æ–°ä»»åŠ¡çŠ¶æ€
          task.status = taskStatus;
          if (videoUrl) {
            task.videoUrl = videoUrl;
          }
          
          console.log(`æ›´æ–°ä»»åŠ¡ ${task.id} çŠ¶æ€: ${taskStatus}`);
          
          // å¦‚æœçŠ¶æ€æœ‰å˜åŒ–ï¼Œæ›´æ–°OSSå­˜å‚¨
          if (task.status !== recentTasks[0].status) {
            await saveTasksToOSS(userId, 'image-to-video', [task]);
            console.log(`å·²æ›´æ–°OSSä¸­ä»»åŠ¡ ${task.id} çš„çŠ¶æ€`);
          }
        }
      } catch (statusError) {
        console.error(`æŸ¥è¯¢ä»»åŠ¡ ${task.id} çŠ¶æ€å¤±è´¥:`, statusError.message);
        // å¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œä¿æŒåŸæœ‰çŠ¶æ€
      }
    }
    
    console.log(`æ‰¾åˆ° ${tasks.length} ä¸ªå›¾ç”Ÿè§†é¢‘ä»»åŠ¡ï¼Œ24å°æ—¶å†… ${recentTasks.length} ä¸ªï¼Œè¿”å›æœ€æ–° ${latestTask.length} ä¸ª`);
    
    return res.json({
      success: true,
      tasks: latestTask
    });
  } catch (error) {
    console.error('è·å–ç”¨æˆ·å›¾ç”Ÿè§†é¢‘ä»»åŠ¡åˆ—è¡¨å‡ºé”™:', error);
    return res.status(500).json({
      success: false,
      code: 'InternalServerError',
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
      request_id: null
    });
  }
});

/**
 * @route   DELETE /api/tasks/image-to-video
 * @desc    æ¸…ç©ºç”¨æˆ·æ‰€æœ‰å›¾ç”Ÿè§†é¢‘ä»»åŠ¡è®°å½•
 * @access  ç§æœ‰
 */
router.delete('/tasks/image-to-video', protect, async (req, res) => {
  try {
    const userId = req.user.id;
    
    console.log(`æ¸…ç©ºç”¨æˆ·æ‰€æœ‰å›¾ç”Ÿè§†é¢‘ä»»åŠ¡: userId=${userId}`);
    
    // æ¸…ç©ºOSSå­˜å‚¨
    try {
      const ossPath = `image-to-video/tasks/${userId}/tasks.json`;
      await client.put(ossPath, Buffer.from('[]', 'utf8'), {
        headers: {
          'Content-Type': 'application/json'
        }
      });
      console.log(`å·²æ¸…ç©ºå›¾ç”Ÿè§†é¢‘OSSå­˜å‚¨: ${ossPath}`);
    } catch (ossError) {
      console.error('æ¸…ç©ºå›¾ç”Ÿè§†é¢‘OSSå­˜å‚¨å¤±è´¥:', ossError);
      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
    }
    
    // æ¸…ç©ºå…¨å±€ä»»åŠ¡è®°å½•
    if (global.imageToVideoTasks) {
      const globalTaskIds = Object.keys(global.imageToVideoTasks);
      globalTaskIds.forEach(taskId => {
        if (global.imageToVideoTasks[taskId] && global.imageToVideoTasks[taskId].userId === userId) {
          delete global.imageToVideoTasks[taskId];
        }
      });
      console.log(`å·²æ¸…ç©ºå›¾ç”Ÿè§†é¢‘å…¨å±€ä»»åŠ¡è®°å½•: ${globalTaskIds.length} ä¸ªä»»åŠ¡`);
    }
    
    return res.json({
      success: true,
      message: 'æ‰€æœ‰å›¾ç”Ÿè§†é¢‘ä»»åŠ¡å·²æ¸…ç©º'
    });
  } catch (error) {
    console.error('æ¸…ç©ºå›¾ç”Ÿè§†é¢‘ä»»åŠ¡å¤±è´¥:', error);
    return res.status(500).json({
      success: false,
      code: 'InternalServerError',
      message: 'æ¸…ç©ºä»»åŠ¡å¤±è´¥: ' + error.message,
      request_id: null
    });
  }
});

/**
 * @route   DELETE /api/text-to-video/tasks/clear-all
 * @desc    æ¸…ç©ºç”¨æˆ·æ‰€æœ‰æ–‡ç”Ÿè§†é¢‘ä»»åŠ¡è®°å½•
 * @access  ç§æœ‰
 */
router.delete('/tasks/clear-all', protect, async (req, res) => {
  try {
    const userId = req.user.id;
    
    console.log(`æ¸…ç©ºç”¨æˆ·æ‰€æœ‰ä»»åŠ¡: userId=${userId}`);
    
    // æ¸…ç©ºç”¨æˆ·ä»»åŠ¡åˆ—è¡¨
    if (userTasks[userId]) {
      const taskCount = userTasks[userId].length;
      userTasks[userId] = [];
      console.log(`å·²æ¸…ç©ºç”¨æˆ·ä»»åŠ¡åˆ—è¡¨: ${taskCount} ä¸ªä»»åŠ¡`);
    }
    
    // æ¸…ç©ºOSSå­˜å‚¨
    try {
      const ossPath = `text-to-video/tasks/${userId}/tasks.json`;
      await client.put(ossPath, Buffer.from('[]', 'utf8'), {
        headers: {
          'Content-Type': 'application/json'
        }
      });
      console.log(`å·²æ¸…ç©ºOSSå­˜å‚¨: ${ossPath}`);
    } catch (ossError) {
      console.error('æ¸…ç©ºOSSå­˜å‚¨å¤±è´¥:', ossError);
      // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
    }
    
    // æ¸…ç©ºå…¨å±€ä»»åŠ¡è®°å½•
    if (global.textToVideoTasks) {
      const globalTaskIds = Object.keys(global.textToVideoTasks);
      globalTaskIds.forEach(taskId => {
        if (global.textToVideoTasks[taskId] && global.textToVideoTasks[taskId].userId === userId) {
          delete global.textToVideoTasks[taskId];
        }
      });
      console.log(`å·²æ¸…ç©ºå…¨å±€ä»»åŠ¡è®°å½•: ${globalTaskIds.length} ä¸ªä»»åŠ¡`);
    }
    
    // å°è¯•ä»æ•°æ®åº“ä¸­åˆ é™¤ç›¸å…³è®°å½•
    try {
      // åˆ é™¤è§†é¢‘ç»“æœè®°å½•
      const deletedVideoResults = await VideoResult.destroy({
        where: { user: userId }
      });
      
      // åˆ é™¤å†å²è®°å½•
      const deletedHistory = await ImageHistory.destroy({
        where: { 
          userId: userId,
          processType: 'æ–‡ç”Ÿè§†é¢‘'
        }
      });
      
      console.log(`å·²ä»æ•°æ®åº“ä¸­åˆ é™¤è®°å½•: è§†é¢‘ç»“æœ ${deletedVideoResults} æ¡ï¼Œå†å²è®°å½• ${deletedHistory} æ¡`);
    } catch (dbError) {
      console.error('åˆ é™¤æ•°æ®åº“è®°å½•æ—¶å‡ºé”™:', dbError);
      // ç»§ç»­å¤„ç†ï¼Œä¸å½±å“ä¸»è¦æ¸…ç©ºåŠŸèƒ½
    }
    
    return res.json({
      success: true,
      message: 'æ‰€æœ‰å†å²è®°å½•å·²æ¸…ç©º',
      data: {
        clearedTasks: userTasks[userId] ? 0 : 'unknown',
        clearedFromOSS: true,
        clearedFromGlobal: true
      }
    });
  } catch (error) {
    console.error('æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡å‡ºé”™:', error);
    return res.status(500).json({
      success: false,
      code: 'InternalServerError',
      message: 'æ¸…ç©ºä»»åŠ¡å¤±è´¥: ' + error.message,
      request_id: null
    });
  }
});

/**
 * @route   DELETE /api/text-to-video/tasks/:taskId
 * @desc    åˆ é™¤ç”¨æˆ·çš„æ–‡ç”Ÿè§†é¢‘ä»»åŠ¡è®°å½•
 * @access  ç§æœ‰
 */
router.delete('/tasks/:taskId', protect, async (req, res) => {
  try {
    const userId = req.user.id;
    const taskId = req.params.taskId;
    
    console.log(`åˆ é™¤ä»»åŠ¡è¯·æ±‚: userId=${userId}, taskId=${taskId}`);
    
    // ä»ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨ä¸­åˆ é™¤
    if (userTasks[userId]) {
      const taskIndex = userTasks[userId].findIndex(task => task.id === taskId);
      if (taskIndex !== -1) {
        const deletedTask = userTasks[userId].splice(taskIndex, 1)[0];
        console.log(`å·²ä»ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨ä¸­åˆ é™¤ä»»åŠ¡: ${taskId}`);
        
        // åŒæ—¶ä»OSSå­˜å‚¨ä¸­åˆ é™¤
        try {
          await deleteTaskFromOSS(userId, taskId);
          console.log(`ä»»åŠ¡å·²ä»OSSåˆ é™¤: ${taskId}`);
        } catch (ossError) {
          console.error('ä»OSSåˆ é™¤ä»»åŠ¡å¤±è´¥:', ossError);
          // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
        }
        
        // ä»å…¨å±€ä»»åŠ¡è®°å½•ä¸­åˆ é™¤
        if (global.textToVideoTasks && global.textToVideoTasks[taskId]) {
          delete global.textToVideoTasks[taskId];
          console.log(`å·²ä»å…¨å±€ä»»åŠ¡è®°å½•ä¸­åˆ é™¤ä»»åŠ¡: ${taskId}`);
        }
        
        // å°è¯•ä»æ•°æ®åº“ä¸­åˆ é™¤ç›¸å…³è®°å½•
        try {
          // åˆ é™¤è§†é¢‘ç»“æœè®°å½•
          await VideoResult.destroy({
            where: { taskId: taskId }
          });
          
          // åˆ é™¤å†å²è®°å½•
          await ImageHistory.destroy({
            where: { 
              userId: userId,
              metadata: {
                [sequelize.Op.like]: `%"taskId":"${taskId}"%`
              }
            }
          });
          
          console.log(`å·²ä»æ•°æ®åº“ä¸­åˆ é™¤ä»»åŠ¡ç›¸å…³è®°å½•: ${taskId}`);
        } catch (dbError) {
          console.error('åˆ é™¤æ•°æ®åº“è®°å½•æ—¶å‡ºé”™:', dbError);
          // ç»§ç»­å¤„ç†ï¼Œä¸å½±å“ä¸»è¦åˆ é™¤åŠŸèƒ½
        }
        
        return res.json({
          success: true,
          message: 'ä»»åŠ¡å·²åˆ é™¤',
          deletedTask: deletedTask
        });
      } else {
        console.log(`æœªæ‰¾åˆ°è¦åˆ é™¤çš„ä»»åŠ¡: ${taskId}`);
        return res.status(404).json({
          success: false,
          code: 'TaskNotFound',
          message: 'æœªæ‰¾åˆ°æŒ‡å®šçš„ä»»åŠ¡',
          request_id: null
        });
      }
    } else {
      console.log(`ç”¨æˆ· ${userId} æ²¡æœ‰ä»»åŠ¡è®°å½•`);
      return res.status(404).json({
        success: false,
        code: 'NoTasks',
        message: 'æ²¡æœ‰æ‰¾åˆ°ä»»åŠ¡è®°å½•',
        request_id: null
      });
    }
  } catch (error) {
    console.error('åˆ é™¤ä»»åŠ¡å‡ºé”™:', error);
    return res.status(500).json({
      success: false,
      code: 'InternalServerError',
      message: 'åˆ é™¤ä»»åŠ¡å¤±è´¥: ' + error.message,
      request_id: null
    });
  }
});

/**
 * @route   GET /api/text-to-video/tasks/cleanup
 * @desc    æ¸…ç†è¿‡æœŸçš„æ–‡ç”Ÿè§†é¢‘ä»»åŠ¡è®°å½•
 * @access  ç§æœ‰
 */
router.get('/tasks/cleanup', protect, async (req, res) => {
  try {
    const userId = req.user.id;
    
    console.log(`æ¸…ç†ç”¨æˆ·è¿‡æœŸä»»åŠ¡: userId=${userId}`);
    
    // ä»OSSåŠ è½½ä»»åŠ¡åˆ—è¡¨
    const tasks = await loadTasksFromOSS(userId);
    
    // è¿‡æ»¤24å°æ—¶å†…çš„ä»»åŠ¡
    const now = new Date();
    const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    const recentTasks = tasks.filter(task => {
      const taskTime = new Date(task.createdAt);
      return taskTime >= twentyFourHoursAgo;
    });
    
    const expiredCount = tasks.length - recentTasks.length;
    
    // åªä¿å­˜æœ€æ–°çš„1ä¸ªä»»åŠ¡
    const tasksToSave = recentTasks.slice(0, 1);
    
    // ä¿å­˜æ¸…ç†åçš„ä»»åŠ¡åˆ—è¡¨
    await saveTasksToOSS(userId, tasksToSave);
    
    console.log(`æ¸…ç†å®Œæˆ: åŸæœ‰ ${tasks.length} ä¸ªä»»åŠ¡ï¼Œè¿‡æœŸ ${expiredCount} ä¸ªï¼Œä¿ç•™ ${tasksToSave.length} ä¸ª`);
    
    return res.json({
      success: true,
      message: 'ä»»åŠ¡æ¸…ç†å®Œæˆ',
      data: {
        originalCount: tasks.length,
        expiredCount: expiredCount,
        remainingCount: tasksToSave.length
      }
    });
  } catch (error) {
    console.error('æ¸…ç†è¿‡æœŸä»»åŠ¡å‡ºé”™:', error);
    return res.status(500).json({
      success: false,
      code: 'InternalServerError',
      message: 'æ¸…ç†ä»»åŠ¡å¤±è´¥: ' + error.message,
      request_id: null
    });
  }
});


/**
 * å›¾ç”Ÿè§†é¢‘é€€æ¬¾å‡½æ•°
 * å½“ä»»åŠ¡å¤±è´¥æ—¶ï¼Œé€€è¿˜å·²æ‰£é™¤çš„ç§¯åˆ†
 */
async function refundImageToVideoCredits(userId, taskId, reason = 'ä»»åŠ¡å¤±è´¥') {
    try {
        console.log(`å¼€å§‹å¤„ç†å›¾ç”Ÿè§†é¢‘é€€æ¬¾: ç”¨æˆ·ID=${userId}, ä»»åŠ¡ID=${taskId}, åŸå› =${reason}`);
        
        // æŸ¥æ‰¾è¯¥åŠŸèƒ½çš„ä½¿ç”¨è®°å½•
        const usage = await FeatureUsage.findOne({
            where: {
                userId: userId,
                featureName: 'image-to-video'
            }
        });
        
        if (!usage) {
            console.log(`æœªæ‰¾åˆ°ç”¨æˆ·${userId}çš„å›¾ç”Ÿè§†é¢‘ä½¿ç”¨è®°å½•ï¼Œæ— éœ€é€€æ¬¾`);
            return false;
        }
        
        // è§£ædetailså­—æ®µï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ä»»åŠ¡è®°å½•
        let details = {};
        if (usage.details) {
            try {
                details = JSON.parse(usage.details);
            } catch (e) {
                console.error('è§£ædetailså­—æ®µå¤±è´¥:', e);
                details = {};
            }
        }
        
        // ç¡®ä¿refundsæ•°ç»„å­˜åœ¨
        if (!details.refunds) {
            details.refunds = [];
        }
        
        // æŸ¥æ‰¾å¯¹åº”çš„ä»»åŠ¡è®°å½•
        const tasks = details.tasks || [];
        let task = null;
        
        if (taskId) {
            // å¦‚æœæä¾›äº†taskIdï¼Œå…ˆå°è¯•ç²¾ç¡®åŒ¹é…
            task = tasks.find(t => t.taskId === taskId);
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»é€€æ¬¾è¿‡
            const existingRefund = details.refunds.find(refund => refund.taskId === taskId);
            if (existingRefund) {
                console.log(`ä»»åŠ¡${taskId}å·²ç»é€€æ¬¾è¿‡ï¼Œè·³è¿‡é‡å¤é€€æ¬¾`);
                return false;
            }
        }
        
        // å¦‚æœæ²¡æ‰¾åˆ°ä»»åŠ¡è®°å½•æˆ–æ²¡æœ‰æä¾›taskIdï¼Œå°è¯•ä»æœ€è¿‘çš„ä»»åŠ¡ä¸­æ¨æ–­
        if (!task && tasks.length > 0) {
            // æŒ‰æ—¶é—´æ’åºï¼Œå–æœ€è¿‘çš„ä¸€ä¸ªæ²¡æœ‰é€€æ¬¾çš„ä»»åŠ¡
            const sortedTasks = tasks.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            for (const t of sortedTasks) {
                const existingRefund = details.refunds.find(refund => refund.taskId === t.taskId);
                if (!existingRefund) {
                    task = t;
                    console.log(`ä½¿ç”¨æœ€è¿‘çš„æœªé€€æ¬¾ä»»åŠ¡è®°å½•è¿›è¡Œé€€æ¬¾: ${task.taskId}`);
                    break;
                }
            }
        }
        
        if (!task) {
            console.log(`æœªæ‰¾åˆ°ä»»åŠ¡è®°å½•ï¼Œæ— æ³•é€€æ¬¾`);
            return false;
        }
        
        const creditCost = task.creditCost || 0;
        const isFree = task.isFree || false;
        
        console.log(`æ‰¾åˆ°ä»»åŠ¡è®°å½•: ç§¯åˆ†=${creditCost}, æ˜¯å¦å…è´¹=${isFree}`);
        
        // å¦‚æœæ˜¯å…è´¹ä½¿ç”¨ï¼Œåªéœ€è¦å›é€€ä½¿ç”¨æ¬¡æ•°ï¼Œä¸é€€è¿˜ç§¯åˆ†
        if (isFree) {
            console.log('å…è´¹ä½¿ç”¨å¤±è´¥ï¼Œå›é€€ä½¿ç”¨æ¬¡æ•°');
            
            // å‡å°‘ä½¿ç”¨æ¬¡æ•°
            if (usage.usageCount > 0) {
                usage.usageCount -= 1;
            }
            
            // è®°å½•é€€æ¬¾ä¿¡æ¯ï¼ˆæ ‡è®°ä¸ºå…è´¹é€€æ¬¾ï¼‰
            details.refunds.push({
                taskId: task.taskId, // ä½¿ç”¨å®é™…çš„ä»»åŠ¡ID
                creditCost: 0,
                isFree: true,
                reason: reason,
                refundTime: new Date().toISOString()
            });
            
            usage.details = JSON.stringify(details);
            await usage.save();
            
            console.log(`å›¾ç”Ÿè§†é¢‘å…è´¹ä½¿ç”¨é€€æ¬¾å®Œæˆ: ç”¨æˆ·ID=${userId}, å›é€€ä½¿ç”¨æ¬¡æ•°`);
            return true;
        }
        
        // ä»˜è´¹ä½¿ç”¨é€€æ¬¾
        if (creditCost > 0) {
            console.log(`å¼€å§‹é€€è¿˜ç§¯åˆ†: ${creditCost}`);
            
            // è·å–ç”¨æˆ·ä¿¡æ¯
            const User = require('../models/User');
            const user = await User.findByPk(userId);
            
            if (!user) {
                console.error(`æœªæ‰¾åˆ°ç”¨æˆ·ID=${userId}`);
                return false;
            }
            
            // é€€è¿˜ç§¯åˆ†
            user.credits += creditCost;
            await user.save();
            
            // å‡å°‘è¯¥åŠŸèƒ½çš„ç§¯åˆ†æ¶ˆè´¹è®°å½•
            if (usage.credits >= creditCost) {
                usage.credits -= creditCost;
            } else {
                usage.credits = 0;
            }
            
            // å‡å°‘ä½¿ç”¨æ¬¡æ•°
            if (usage.usageCount > 0) {
                usage.usageCount -= 1;
            }
            
            // è®°å½•é€€æ¬¾ä¿¡æ¯
            details.refunds.push({
                taskId: task.taskId, // ä½¿ç”¨å®é™…çš„ä»»åŠ¡ID
                creditCost: creditCost,
                isFree: false,
                reason: reason,
                refundTime: new Date().toISOString()
            });
            
            usage.details = JSON.stringify(details);
            await usage.save();
            
            console.log(`å›¾ç”Ÿè§†é¢‘ç§¯åˆ†é€€æ¬¾å®Œæˆ: ç”¨æˆ·ID=${userId}, é€€è¿˜ç§¯åˆ†=${creditCost}, ç”¨æˆ·å½“å‰ç§¯åˆ†=${user.credits}`);
            return true;
        }
        
        console.log(`ä»»åŠ¡${taskId}æ— éœ€é€€æ¬¾: ç§¯åˆ†=${creditCost}, å…è´¹=${isFree}`);
        return false;
        
    } catch (error) {
        console.error('å›¾ç”Ÿè§†é¢‘é€€æ¬¾å¤±è´¥:', error);
        return false;
    }
}

/**
 * @route   POST /api/text-to-video/image-to-video
 * @desc    åˆ›å»ºå›¾ç”Ÿè§†é¢‘ä»»åŠ¡
 * @access  Private
 */
/**
 * å›¾ç”Ÿè§†é¢‘é€€æ¬¾å‡½æ•°
 * å½“ä»»åŠ¡å¤±è´¥æ—¶ï¼Œé€€è¿˜å·²æ‰£é™¤çš„ç§¯åˆ†
 */
async function refundImageToVideoCredits(userId, taskId, reason = 'ä»»åŠ¡å¤±è´¥') {
    try {
        console.log(`å¼€å§‹å¤„ç†å›¾ç”Ÿè§†é¢‘é€€æ¬¾: ç”¨æˆ·ID=${userId}, ä»»åŠ¡ID=${taskId}, åŸå› =${reason}`);
        
        // æŸ¥æ‰¾è¯¥åŠŸèƒ½çš„ä½¿ç”¨è®°å½•
        const usage = await FeatureUsage.findOne({
            where: {
                userId: userId,
                featureName: 'image-to-video'
            }
        });
        
        if (!usage) {
            console.log(`æœªæ‰¾åˆ°ç”¨æˆ·${userId}çš„å›¾ç”Ÿè§†é¢‘ä½¿ç”¨è®°å½•ï¼Œæ— éœ€é€€æ¬¾`);
            return false;
        }
        
        // è§£ædetailså­—æ®µï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ä»»åŠ¡è®°å½•
        let details = {};
        if (usage.details) {
            try {
                details = JSON.parse(usage.details);
            } catch (e) {
                console.error('è§£ædetailså­—æ®µå¤±è´¥:', e);
                details = {};
            }
        }
        
        // ç¡®ä¿refundsæ•°ç»„å­˜åœ¨
        if (!details.refunds) {
            details.refunds = [];
        }
        
        // æŸ¥æ‰¾å¯¹åº”çš„ä»»åŠ¡è®°å½•
        const tasks = details.tasks || [];
        let task = null;
        
        if (taskId) {
            // å¦‚æœæä¾›äº†taskIdï¼Œå…ˆå°è¯•ç²¾ç¡®åŒ¹é…
            task = tasks.find(t => t.taskId === taskId);
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»é€€æ¬¾è¿‡
            const existingRefund = details.refunds.find(refund => refund.taskId === taskId);
            if (existingRefund) {
                console.log(`ä»»åŠ¡${taskId}å·²ç»é€€æ¬¾è¿‡ï¼Œè·³è¿‡é‡å¤é€€æ¬¾`);
                return false;
            }
        }
        
        // å¦‚æœæ²¡æ‰¾åˆ°ä»»åŠ¡è®°å½•æˆ–æ²¡æœ‰æä¾›taskIdï¼Œå°è¯•ä»æœ€è¿‘çš„ä»»åŠ¡ä¸­æ¨æ–­
        if (!task && tasks.length > 0) {
            // æŒ‰æ—¶é—´æ’åºï¼Œå–æœ€è¿‘çš„ä¸€ä¸ªæ²¡æœ‰é€€æ¬¾çš„ä»»åŠ¡
            const sortedTasks = tasks.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            for (const t of sortedTasks) {
                const existingRefund = details.refunds.find(refund => refund.taskId === t.taskId);
                if (!existingRefund) {
                    task = t;
                    console.log(`ä½¿ç”¨æœ€è¿‘çš„æœªé€€æ¬¾ä»»åŠ¡è®°å½•è¿›è¡Œé€€æ¬¾: ${task.taskId}`);
                    break;
                }
            }
        }
        
        if (!task) {
            console.log(`æœªæ‰¾åˆ°ä»»åŠ¡è®°å½•ï¼Œæ— æ³•é€€æ¬¾`);
            return false;
        }
        
        const creditCost = task.creditCost || 0;
        const isFree = task.isFree || false;
        
        console.log(`æ‰¾åˆ°ä»»åŠ¡è®°å½•: ç§¯åˆ†=${creditCost}, æ˜¯å¦å…è´¹=${isFree}`);
        
        // å¦‚æœæ˜¯å…è´¹ä½¿ç”¨ï¼Œåªéœ€è¦å›é€€ä½¿ç”¨æ¬¡æ•°ï¼Œä¸é€€è¿˜ç§¯åˆ†
        if (isFree) {
            console.log('å…è´¹ä½¿ç”¨å¤±è´¥ï¼Œå›é€€ä½¿ç”¨æ¬¡æ•°');
            
            // å‡å°‘ä½¿ç”¨æ¬¡æ•°
            if (usage.usageCount > 0) {
                usage.usageCount -= 1;
            }
            
            // è®°å½•é€€æ¬¾ä¿¡æ¯ï¼ˆæ ‡è®°ä¸ºå…è´¹é€€æ¬¾ï¼‰
            details.refunds.push({
                taskId: task.taskId, // ä½¿ç”¨å®é™…çš„ä»»åŠ¡ID
                creditCost: 0,
                isFree: true,
                reason: reason,
                refundTime: new Date().toISOString()
            });
            
            usage.details = JSON.stringify(details);
            await usage.save();
            
            console.log(`å›¾ç”Ÿè§†é¢‘å…è´¹ä½¿ç”¨é€€æ¬¾å®Œæˆ: ç”¨æˆ·ID=${userId}, å›é€€ä½¿ç”¨æ¬¡æ•°`);
            return true;
        }
        
        // ä»˜è´¹ä½¿ç”¨é€€æ¬¾
        if (creditCost > 0) {
            console.log(`å¼€å§‹é€€è¿˜ç§¯åˆ†: ${creditCost}`);
            
            // è·å–ç”¨æˆ·ä¿¡æ¯
            const User = require('../models/User');
            const user = await User.findByPk(userId);
            
            if (!user) {
                console.error(`æœªæ‰¾åˆ°ç”¨æˆ·ID=${userId}`);
                return false;
            }
            
            // é€€è¿˜ç§¯åˆ†
            user.credits += creditCost;
            await user.save();
            
            // å‡å°‘è¯¥åŠŸèƒ½çš„ç§¯åˆ†æ¶ˆè´¹è®°å½•
            if (usage.credits >= creditCost) {
                usage.credits -= creditCost;
            } else {
                usage.credits = 0;
            }
            
            // å‡å°‘ä½¿ç”¨æ¬¡æ•°
            if (usage.usageCount > 0) {
                usage.usageCount -= 1;
            }
            
            // è®°å½•é€€æ¬¾ä¿¡æ¯
            details.refunds.push({
                taskId: task.taskId, // ä½¿ç”¨å®é™…çš„ä»»åŠ¡ID
                creditCost: creditCost,
                isFree: false,
                reason: reason,
                refundTime: new Date().toISOString()
            });
            
            usage.details = JSON.stringify(details);
            await usage.save();
            
            console.log(`å›¾ç”Ÿè§†é¢‘ç§¯åˆ†é€€æ¬¾å®Œæˆ: ç”¨æˆ·ID=${userId}, é€€è¿˜ç§¯åˆ†=${creditCost}, ç”¨æˆ·å½“å‰ç§¯åˆ†=${user.credits}`);
            return true;
        }
        
        console.log(`ä»»åŠ¡${taskId}æ— éœ€é€€æ¬¾: ç§¯åˆ†=${creditCost}, å…è´¹=${isFree}`);
        return false;
        
    } catch (error) {
        console.error('å›¾ç”Ÿè§†é¢‘é€€æ¬¾å¤±è´¥:', error);
        return false;
    }
}

/**
 * @route   POST /api/text-to-video/image-to-video
 * @desc    åˆ›å»ºå›¾ç”Ÿè§†é¢‘ä»»åŠ¡
 * @access  Private
 */
router.post('/image-to-video', protect, createUnifiedFeatureMiddleware('image-to-video'), async (req, res) => {
    try {
        const { model, input, parameters } = req.body;
        const userId = req.user.id;
        
        if (!model || !input || !input.prompt || !input.img_url) {
            return res.status(400).json({ 
                success: false, 
                message: 'ç¼ºå°‘å¿…è¦å‚æ•°' 
            });
        }
        
        // éªŒè¯æ¨¡å‹åç§°
        if (!model.includes('wanx2.1-i2v')) {
            return res.status(400).json({
                success: false,
                message: 'ä¸æ”¯æŒçš„æ¨¡å‹åç§°ï¼Œå›¾ç”Ÿè§†é¢‘åº”ä½¿ç”¨wanx2.1-i2v-turboæˆ–wanx2.1-i2v-plusæ¨¡å‹'
            });
        }
        
        // å‡†å¤‡è°ƒç”¨é˜¿é‡Œäº‘å›¾ç”Ÿè§†é¢‘APIçš„è¯·æ±‚
        const dashscopeRequest = {
            model: model,
            input: {
                prompt: input.prompt,
                img_url: input.img_url
            },
            parameters: parameters || {}
        };
        
        // å‚æ•°å¤„ç†ï¼šå¦‚æœæœ‰sizeå‚æ•°ï¼Œæ›¿æ¢ä¸ºresolutionå‚æ•°
        if (dashscopeRequest.parameters.size) {
            dashscopeRequest.parameters.resolution = dashscopeRequest.parameters.size;
            delete dashscopeRequest.parameters.size;
        }
        
        // ç¡®ä¿resolutionå‚æ•°ä¸ºæœ‰æ•ˆå€¼ï¼š480Pæˆ–720P
        if (dashscopeRequest.parameters.resolution) {
            const resolution = dashscopeRequest.parameters.resolution.toString().toUpperCase();
            if (!['480P', '720P'].includes(resolution)) {
                // å°è¯•è½¬æ¢å¦‚"1280*720"æ ¼å¼ä¸ºæ ‡å‡†æ¡£ä½
                if (resolution.includes('1280') || resolution.includes('720')) {
                    dashscopeRequest.parameters.resolution = '720P';
                } else if (resolution.includes('640') || resolution.includes('480')) {
                    dashscopeRequest.parameters.resolution = '480P';
                } else {
                    // é»˜è®¤ä½¿ç”¨720P
                    dashscopeRequest.parameters.resolution = '720P';
                }
            } else {
                dashscopeRequest.parameters.resolution = resolution;
            }
        } else {
            // é»˜è®¤è®¾ç½®ä¸º720P
            dashscopeRequest.parameters.resolution = '720P';
        }
        
        // ç¡®ä¿durationå‚æ•°æœ‰æ•ˆï¼šå¯¹äºwanx2.1-i2v-turboå¯ä»¥æ˜¯3ã€4æˆ–5ï¼Œå¯¹äºwanx2.1-i2v-plusåªèƒ½æ˜¯5
        if (dashscopeRequest.parameters.duration) {
            const duration = parseInt(dashscopeRequest.parameters.duration);
            if (model === 'wanx2.1-i2v-plus' && duration !== 5) {
                dashscopeRequest.parameters.duration = 5;
            } else if (model === 'wanx2.1-i2v-turbo' && ![3, 4, 5].includes(duration)) {
                dashscopeRequest.parameters.duration = 5;
            }
        } else {
            // é»˜è®¤è®¾ç½®ä¸º5ç§’
            dashscopeRequest.parameters.duration = 5;
        }
        
        // è°ƒç”¨é˜¿é‡Œäº‘å›¾ç”Ÿè§†é¢‘API
        console.log('è°ƒç”¨é˜¿é‡Œäº‘å›¾ç”Ÿè§†é¢‘APIï¼Œä½¿ç”¨çš„å¯†é’¥å‰ç¼€ï¼š', process.env.DASHSCOPE_API_KEY.substring(0, 6) + '...');
        console.log('è¯·æ±‚å‚æ•°:', JSON.stringify(dashscopeRequest, null, 2));
        
        // éªŒè¯img_urlæ ¼å¼
        const imgUrl = dashscopeRequest.input.img_url;
        if (!imgUrl || !imgUrl.startsWith('http')) {
            console.error('å›¾ç‰‡URLæ ¼å¼ä¸æ­£ç¡®:', imgUrl);
            return res.status(400).json({
                status_code: 400,
                code: 'InvalidParameter',
                message: 'å›¾ç‰‡URLæ ¼å¼ä¸æ­£ç¡®ï¼Œå¿…é¡»æ˜¯ä»¥httpå¼€å¤´çš„å®Œæ•´URL',
                request_id: Date.now().toString()
            });
        }
        
        // è°ƒç”¨é˜¿é‡Œäº‘å›¾ç”Ÿè§†é¢‘APIï¼Œç¡®ä¿æŒ‰ç…§å®˜æ–¹æ–‡æ¡£è¦æ±‚è®¾ç½®æ‰€æœ‰å¿…è¦çš„è¯·æ±‚å¤´
        console.log('å¼€å§‹è°ƒç”¨é˜¿é‡Œäº‘å›¾ç”Ÿè§†é¢‘API...');
        console.log('å®Œæ•´è¯·æ±‚åœ°å€:', 'https://dashscope.aliyuncs.com/api/v1/services/aigc/video-generation/video-synthesis');
        console.log('è¯·æ±‚å¤´:', JSON.stringify({
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${process.env.DASHSCOPE_API_KEY.substring(0, 6)}...`,
            'X-DashScope-Async': 'enable'
        }, null, 2));
        console.log('è¯·æ±‚ä½“:', JSON.stringify(dashscopeRequest, null, 2));
        
        try {
            const response = await axios.post(
                'https://dashscope.aliyuncs.com/api/v1/services/aigc/video-generation/video-synthesis',
                dashscopeRequest,
                {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${process.env.DASHSCOPE_API_KEY}`,
                        'X-DashScope-Async': 'enable'
                    },
                    timeout: 30000 // è®¾ç½®30ç§’è¶…æ—¶
                }
            );
            
            const dashscopeResponse = response.data;
            console.log('é˜¿é‡Œäº‘APIå“åº”çŠ¶æ€ç :', response.status);
            console.log('é˜¿é‡Œäº‘APIå“åº”å¤´:', JSON.stringify(response.headers, null, 2));
            console.log('é˜¿é‡Œäº‘APIå“åº”ä½“:', JSON.stringify(dashscopeResponse, null, 2));
            
            // æ£€æŸ¥å“åº”æ ¼å¼
            if (!dashscopeResponse || !dashscopeResponse.output || !dashscopeResponse.output.task_id) {
                console.error('APIå“åº”ä¸­æœªæ‰¾åˆ°task_id:', dashscopeResponse);
                return res.status(500).json({
                    status_code: 500,
                    code: 'InvalidResponse',
                    message: 'APIå“åº”æ ¼å¼å¼‚å¸¸ï¼Œæœªæ‰¾åˆ°ä»»åŠ¡ID',
                    request_id: null,
                    output: null,
                    usage: null
                });
            }
            
            const taskId = dashscopeResponse.output.task_id;
            console.log('æˆåŠŸè·å–ä»»åŠ¡ID:', taskId);
            
            // ç§¯åˆ†å·²åœ¨ç»Ÿä¸€ä¸­é—´ä»¶ä¸­æ‰£é™¤ï¼Œå…ˆè®°å½•ä»»åŠ¡ä¿¡æ¯ï¼ˆæ— è®ºAPIæ˜¯å¦æˆåŠŸï¼‰
            const creditCost = req.featureUsage?.creditCost || 0;
            const isFree = req.featureUsage?.isFree || false;
            
            // è®°å½•ä»»åŠ¡ä¿¡æ¯åˆ°å…¨å±€å˜é‡ï¼Œæ–¹ä¾¿åç»­æŸ¥è¯¢å’Œç§¯åˆ†ç»Ÿè®¡
            if (!global.imageToVideoTasks) {
                global.imageToVideoTasks = {};
            }
            
            global.imageToVideoTasks[taskId] = {
                userId: userId,
                prompt: input.prompt,
                img_url: input.img_url,
                timestamp: new Date(),
                creditCost: creditCost,
                status: 'pending',
                isFree: isFree // æ ‡è®°æ˜¯å¦ä¸ºå…è´¹ä½¿ç”¨
            };
            
            // ç«‹å³ä¿å­˜ä»»åŠ¡è®°å½•åˆ°æ•°æ®åº“ï¼ˆç¡®ä¿é€€æ¬¾æ—¶èƒ½æ‰¾åˆ°ï¼‰
            try {
                const { FeatureUsage } = require('../models/FeatureUsage');
                
                // æ›´æ–°æ•°æ®åº“ä¸­çš„ä½¿ç”¨è®°å½•
                let usage = await FeatureUsage.findOne({
                    where: { userId: req.user.id, featureName: 'image-to-video' }
                });
                
                if (usage) {
                    // å·²æœ‰è®°å½•ï¼Œåªæ›´æ–°ä»»åŠ¡è¯¦æƒ…
                    let details = {};
                    try {
                        details = usage.details ? JSON.parse(usage.details) : {};
                    } catch (e) {
                        details = {};
                    }
                    
                    if (!details.tasks) {
                        details.tasks = [];
                    }
                    
                    // æ·»åŠ æ–°çš„ä»»åŠ¡è®°å½•
                    details.tasks.push({
                        taskId: taskId,
                        creditCost: creditCost,
                        isFree: isFree,
                        timestamp: new Date(),
                        status: 'pending' // æ ‡è®°ä¸ºå¾…å¤„ç†
                    });
                    
                    // æ›´æ–°ä½¿ç”¨è®°å½•
                    usage.details = JSON.stringify(details);
                    usage.lastUsedAt = new Date();
                    await usage.save();
                }
                
                console.log(`å›¾ç”Ÿè§†é¢‘ä»»åŠ¡è®°å½•å·²é¢„ä¿å­˜: ç”¨æˆ·ID=${req.user.id}, ä»»åŠ¡ID=${taskId}, ç§¯åˆ†=${creditCost}, æ˜¯å¦å…è´¹=${isFree}`);
            } catch (dbError) {
                console.error('é¢„ä¿å­˜å›¾ç”Ÿè§†é¢‘ä½¿ç”¨è®°å½•å¤±è´¥:', dbError);
                // ç»§ç»­å¤„ç†ï¼Œä¸å½±å“ç”¨æˆ·ä½¿ç”¨
            }
            
            console.log(`ä¿å­˜å›¾ç”Ÿè§†é¢‘ä»»åŠ¡ä¿¡æ¯: ç”¨æˆ·ID=${userId}, ä»»åŠ¡ID=${taskId}, ç§¯åˆ†=${creditCost}${req.featureUsage?.usageType === 'free' ? ' (å…è´¹æ¬¡æ•°)' : ''}`);
            
            // ä¿å­˜ä»»åŠ¡åˆ°OSS
            try {
                const taskData = {
                    id: taskId,
                    prompt: input.prompt,
                    status: 'PROCESSING',
                    createdAt: new Date().toISOString(),
                    videoUrl: null,
                    imgUrl: input.img_url,
                    model: model,
                    parameters: dashscopeRequest.parameters
                };
                
                await addTaskToOSS(userId, taskData, 'image-to-video');
                console.log(`å›¾ç”Ÿè§†é¢‘ä»»åŠ¡å·²ä¿å­˜åˆ°OSS: ${taskId}`);
            } catch (ossError) {
                console.error('ä¿å­˜å›¾ç”Ÿè§†é¢‘ä»»åŠ¡åˆ°OSSå¤±è´¥:', ossError);
                // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
            }
            
            // æ ‡å‡†åŒ–å“åº”æ ¼å¼
            if (!dashscopeResponse.status_code) {
                dashscopeResponse.status_code = 200;
            }
            if (dashscopeResponse.code === undefined) {
                dashscopeResponse.code = null;
            }
            if (!dashscopeResponse.message) {
                dashscopeResponse.message = "";
            }
            
            // ç¡®ä¿usageå­—æ®µç»“æ„æ­£ç¡®
            if (dashscopeResponse.output && dashscopeResponse.output.task_status === 'SUCCEEDED') {
                if (!dashscopeResponse.usage) {
                    dashscopeResponse.usage = {
                        video_count: 1,
                        video_duration: 5,
                        video_ratio: "standard"
                    };
                } else {
                    // ç¡®ä¿usageä¸­æœ‰æ‰€æœ‰å¿…è¦å­—æ®µ
                    if (!dashscopeResponse.usage.video_count) {
                        dashscopeResponse.usage.video_count = 1;
                    }
                    if (!dashscopeResponse.usage.video_duration) {
                        dashscopeResponse.usage.video_duration = 5;
                    }
                    if (!dashscopeResponse.usage.video_ratio) {
                        dashscopeResponse.usage.video_ratio = "standard";
                    }
                }
            } else if (!dashscopeResponse.usage) {
                dashscopeResponse.usage = null;
            }
            
            // ç¡®ä¿outputå­—æ®µä¸‹æœ‰æ‰€æœ‰å¿…è¦çš„æ—¶é—´ä¿¡æ¯
            if (dashscopeResponse.output) {
                if (!dashscopeResponse.output.submit_time) {
                    dashscopeResponse.output.submit_time = new Date().toISOString().replace('T', ' ').substring(0, 23);
                }
                if (dashscopeResponse.output.task_status === 'SUCCEEDED' && !dashscopeResponse.output.scheduled_time) {
                    dashscopeResponse.output.scheduled_time = dashscopeResponse.output.submit_time;
                }
                if (dashscopeResponse.output.task_status === 'SUCCEEDED' && !dashscopeResponse.output.end_time) {
                    // ç”Ÿæˆä¸€ä¸ªæ¯”submit_timeæ™šå‡ åˆ†é’Ÿçš„æ—¶é—´
                    const endTime = new Date(dashscopeResponse.output.submit_time.replace(' ', 'T'));
                    endTime.setMinutes(endTime.getMinutes() + 5);
                    dashscopeResponse.output.end_time = endTime.toISOString().replace('T', ' ').substring(0, 23);
                }
                
                // ç¡®ä¿video_urlå­—æ®µå­˜åœ¨
                if (!dashscopeResponse.output.video_url) {
                    dashscopeResponse.output.video_url = "";
                }
            }
            
            // è¿”å›å“åº” - ç›´æ¥è¿”å›é˜¿é‡Œäº‘APIåŸå§‹å“åº”ï¼Œä½†ç¡®ä¿æ ¼å¼ä¸€è‡´
            return res.json(dashscopeResponse);
        } catch (error) {
            console.error('å¤„ç†å›¾ç”Ÿè§†é¢‘è¯·æ±‚å‡ºé”™:', error);
            
            // APIè°ƒç”¨å¤±è´¥ï¼Œè¿›è¡Œé€€æ¬¾
            console.log(`å›¾ç”Ÿè§†é¢‘APIè°ƒç”¨å¤±è´¥ï¼Œå¼€å§‹é€€æ¬¾æµç¨‹: ç”¨æˆ·ID=${req.user.id}, ä»»åŠ¡ID=${taskId}`);
            await refundImageToVideoCredits(req.user.id, taskId, `APIè°ƒç”¨å¤±è´¥: ${error.message}`);
            
            // å¤„ç†é˜¿é‡Œäº‘APIé”™è¯¯
            if (error.response && error.response.data) {
                console.error('é˜¿é‡Œäº‘APIè¿”å›é”™è¯¯:', error.response.data);
                // æ ‡å‡†åŒ–é˜¿é‡Œäº‘APIé”™è¯¯æ ¼å¼
                const errorResponse = error.response.data;
                if (!errorResponse.status_code) {
                    errorResponse.status_code = error.response.status || 500;
                }
                if (errorResponse.code === undefined) {
                    errorResponse.code = null;
                }
                if (!errorResponse.usage) {
                    errorResponse.usage = null;
                }
                return res.status(error.response.status || 500).json(errorResponse);
            }
            
            // SDKé£æ ¼çš„é”™è¯¯å“åº”æ ¼å¼
            return res.status(500).json({
                status_code: 500,
                code: 'InternalServerError',
                message: 'æœåŠ¡å™¨å¤„ç†å¼‚å¸¸: ' + error.message,
                request_id: null
            });
        }
    } catch (error) {
        console.error('å¤„ç†å›¾ç”Ÿè§†é¢‘è¯·æ±‚å‡ºé”™:', error);
        
        // å¦‚æœæœ‰taskIdï¼Œè¿›è¡Œé€€æ¬¾
        if (typeof taskId !== 'undefined') {
            console.log(`å›¾ç”Ÿè§†é¢‘æœåŠ¡å™¨é”™è¯¯ï¼Œå¼€å§‹é€€æ¬¾æµç¨‹: ç”¨æˆ·ID=${req.user.id}, ä»»åŠ¡ID=${taskId}`);
            await refundImageToVideoCredits(req.user.id, taskId, `æœåŠ¡å™¨é”™è¯¯: ${error.message}`);
        }
        
        return res.status(500).json({
            success: false,
            code: 'InternalServerError',
            message: 'æœåŠ¡å™¨å¤„ç†å¼‚å¸¸: ' + error.message,
            request_id: null
        });
    }
});

/**
 * @route   GET /api/text-to-video/task-status/:taskId
 * @desc    è·å–å›¾ç”Ÿè§†é¢‘ä»»åŠ¡çŠ¶æ€
 * @access  Private
 */
router.get('/task-status/:taskId', protect, async (req, res) => {
    try {
        const { taskId } = req.params;
        
        if (!taskId) {
            return res.status(400).json({ 
                status_code: 400,
                code: 'InvalidParameter',
                message: 'ç¼ºå°‘ä»»åŠ¡ID',
                request_id: null,
                output: null,
                usage: null
            });
        }
        
        // è°ƒç”¨é˜¿é‡Œäº‘APIè·å–ä»»åŠ¡çŠ¶æ€
        const response = await axios.get(
            `https://dashscope.aliyuncs.com/api/v1/tasks/${taskId}`,
            {
                headers: {
                    'Authorization': `Bearer ${process.env.DASHSCOPE_API_KEY}`
                },
                timeout: 15000 // è®¾ç½®15ç§’è¶…æ—¶
            }
        );
        
        const dashscopeResponse = response.data;
        console.log('ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢å“åº”:', JSON.stringify(dashscopeResponse, null, 2));
        
        // æ›´æ–°å…¨å±€å˜é‡ä¸­çš„ä»»åŠ¡çŠ¶æ€
        const currentTaskStatus = dashscopeResponse.output?.task_status;
        
        // ç¡®ä¿å…¨å±€å˜é‡å­˜åœ¨
        if (!global.imageToVideoTasks) {
            global.imageToVideoTasks = {};
            console.log('åˆå§‹åŒ–å…¨å±€å˜é‡ global.imageToVideoTasks');
        }
        
        // å¦‚æœå½“å‰ä»»åŠ¡ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°è®°å½•
        if (!global.imageToVideoTasks[taskId]) {
            console.log(`å…¨å±€å˜é‡ä¸­ä¸å­˜åœ¨ä»»åŠ¡è®°å½•ï¼Œåˆ›å»ºæ–°è®°å½•: taskId=${taskId}`);
            global.imageToVideoTasks[taskId] = {
                taskId: taskId,
                status: currentTaskStatus,
                videoUrl: dashscopeResponse.output?.video_url || null,
                timestamp: new Date().toISOString(),
                userId: req.user.id
            };
        }
        
        // æ£€æŸ¥å›¾ç”Ÿè§†é¢‘ä»»åŠ¡
        if (global.imageToVideoTasks && global.imageToVideoTasks[taskId]) {
            // å¦‚æœä»»åŠ¡æˆåŠŸå®Œæˆ
            if (currentTaskStatus === 'SUCCEEDED') {
                global.imageToVideoTasks[taskId].status = 'SUCCEEDED';
                global.imageToVideoTasks[taskId].videoUrl = dashscopeResponse.output.video_url;
                global.imageToVideoTasks[taskId].completedAt = new Date();
                
                // æ›´æ–°æ•°æ®åº“ä¸­çš„ä»»åŠ¡çŠ¶æ€ä¸ºæˆåŠŸ
                try {
                    const { FeatureUsage } = require('../models/FeatureUsage');
                    
                    let usage = await FeatureUsage.findOne({
                        where: { userId: global.imageToVideoTasks[taskId].userId, featureName: 'image-to-video' }
                    });
                    
                    if (usage && usage.details) {
                        let details = JSON.parse(usage.details);
                        if (details.tasks) {
                            // æ‰¾åˆ°å¯¹åº”çš„ä»»åŠ¡å¹¶æ›´æ–°çŠ¶æ€
                            const task = details.tasks.find(t => t.taskId === taskId);
                            if (task) {
                                task.status = 'completed';
                                usage.details = JSON.stringify(details);
                                await usage.save();
                            }
                        }
                    }
                    
                    console.log(`å›¾ç”Ÿè§†é¢‘ä»»åŠ¡çŠ¶æ€å·²æ›´æ–°ä¸ºå®Œæˆ: ä»»åŠ¡ID=${taskId}`);
                } catch (dbError) {
                    console.error('æ›´æ–°å›¾ç”Ÿè§†é¢‘ä»»åŠ¡çŠ¶æ€å¤±è´¥:', dbError);
                    // ç»§ç»­å¤„ç†ï¼Œä¸å½±å“ç”¨æˆ·ä½¿ç”¨
                }
                
                console.log(`æ›´æ–°å›¾ç”Ÿè§†é¢‘ä»»åŠ¡çŠ¶æ€: taskId=${taskId}, status=SUCCEEDED`);
            }
            // å¦‚æœä»»åŠ¡å¤±è´¥
            else if (currentTaskStatus === 'FAILED') {
                global.imageToVideoTasks[taskId].status = 'FAILED';
                global.imageToVideoTasks[taskId].errorMessage = dashscopeResponse.message || 'ä»»åŠ¡æ‰§è¡Œå¤±è´¥';
                global.imageToVideoTasks[taskId].completedAt = new Date();
                console.log(`æ›´æ–°å›¾ç”Ÿè§†é¢‘ä»»åŠ¡çŠ¶æ€: taskId=${taskId}, status=FAILED`);
                
                // ä»»åŠ¡å¤±è´¥ï¼Œè¿›è¡Œé€€æ¬¾
                console.log(`å›¾ç”Ÿè§†é¢‘ä»»åŠ¡å¤±è´¥ï¼Œå¼€å§‹é€€æ¬¾æµç¨‹: ç”¨æˆ·ID=${req.user.id}, ä»»åŠ¡ID=${taskId}`);
                const failureReason = dashscopeResponse.message || 'å›¾ç”Ÿè§†é¢‘ä»»åŠ¡å¤±è´¥';
                await refundImageToVideoCredits(req.user.id, taskId, failureReason);
            }
        }
        
        // æ ‡å‡†åŒ–å“åº”æ ¼å¼
        if (!dashscopeResponse.status_code) {
            dashscopeResponse.status_code = 200;
        }
        if (dashscopeResponse.code === undefined) {
            dashscopeResponse.code = null;
        }
        if (!dashscopeResponse.message) {
            dashscopeResponse.message = "";
        }
        
        // ç¡®ä¿usageå­—æ®µç»“æ„æ­£ç¡®
        if (dashscopeResponse.output && dashscopeResponse.output.task_status === 'SUCCEEDED') {
            if (!dashscopeResponse.usage) {
                dashscopeResponse.usage = {
                    video_count: 1,
                    video_duration: 5,
                    video_ratio: "standard"
                };
            } else {
                // ç¡®ä¿usageä¸­æœ‰æ‰€æœ‰å¿…è¦å­—æ®µ
                if (!dashscopeResponse.usage.video_count) {
                    dashscopeResponse.usage.video_count = 1;
                }
                if (!dashscopeResponse.usage.video_duration) {
                    dashscopeResponse.usage.video_duration = 5;
                }
                if (!dashscopeResponse.usage.video_ratio) {
                    dashscopeResponse.usage.video_ratio = "standard";
                }
            }
        } else if (!dashscopeResponse.usage) {
            dashscopeResponse.usage = null;
        }
        
        // ç¡®ä¿outputå­—æ®µä¸‹æœ‰æ‰€æœ‰å¿…è¦çš„æ—¶é—´ä¿¡æ¯
        if (dashscopeResponse.output) {
            if (!dashscopeResponse.output.submit_time) {
                dashscopeResponse.output.submit_time = new Date().toISOString().replace('T', ' ').substring(0, 23);
            }
            if (dashscopeResponse.output.task_status === 'SUCCEEDED' && !dashscopeResponse.output.scheduled_time) {
                dashscopeResponse.output.scheduled_time = dashscopeResponse.output.submit_time;
            }
            if (dashscopeResponse.output.task_status === 'SUCCEEDED' && !dashscopeResponse.output.end_time) {
                // ç”Ÿæˆä¸€ä¸ªæ¯”submit_timeæ™šå‡ åˆ†é’Ÿçš„æ—¶é—´
                const endTime = new Date(dashscopeResponse.output.submit_time.replace(' ', 'T'));
                endTime.setMinutes(endTime.getMinutes() + 5);
                dashscopeResponse.output.end_time = endTime.toISOString().replace('T', ' ').substring(0, 23);
            }
            
            // ç¡®ä¿video_urlå­—æ®µå­˜åœ¨
            if (!dashscopeResponse.output.video_url) {
                dashscopeResponse.output.video_url = "";
            }
        }
        
        // è¿”å›å“åº” - ç›´æ¥è¿”å›é˜¿é‡Œäº‘APIåŸå§‹å“åº”ï¼Œä½†ç¡®ä¿æ ¼å¼ä¸€è‡´
        return res.json(dashscopeResponse);
    } catch (error) {
        console.error('è·å–ä»»åŠ¡çŠ¶æ€å‡ºé”™:', error);
        
        // å¤„ç†é˜¿é‡Œäº‘APIé”™è¯¯
        if (error.response && error.response.data) {
            console.error('é˜¿é‡Œäº‘APIè¿”å›é”™è¯¯:', error.response.data);
            // æ ‡å‡†åŒ–é˜¿é‡Œäº‘APIé”™è¯¯æ ¼å¼
            const errorResponse = error.response.data;
            if (!errorResponse.status_code) {
                errorResponse.status_code = error.response.status || 500;
            }
            if (errorResponse.code === undefined) {
                errorResponse.code = null;
            }
            if (!errorResponse.usage) {
                errorResponse.usage = null;
            }
            return res.status(error.response.status || 500).json(errorResponse);
        }
        
        // SDKé£æ ¼çš„é”™è¯¯å“åº”æ ¼å¼
        return res.status(500).json({
            status_code: 500,
            code: 'InternalServerError',
            message: 'æœåŠ¡å™¨å¤„ç†å¼‚å¸¸: ' + error.message,
            request_id: null
        });
    }
});

/**
 * @route   POST /api/upload-image
 * @desc    ä¸Šä¼ å›¾ç‰‡è·å–URL
 * @access  Private
 */
router.post('/upload-image', protect, upload.single('image'), async (req, res) => {
    try {
        // æ·»åŠ è°ƒè¯•æ—¥å¿—
        console.log('=== å›¾ç‰‡ä¸Šä¼ è°ƒè¯•ä¿¡æ¯ ===');
        console.log('Content-Type:', req.headers['content-type']);
        console.log('isMultipart:', req.is('multipart/*'));
        console.log('req.file:', req.file);
        console.log('req.body:', req.body);
        console.log('========================');
        
        if (!req.file) {
            return res.status(400).json({ 
                code: 'InvalidParameter',
                message: 'æœªæä¾›å›¾ç‰‡æ–‡ä»¶',
                request_id: null
            });
        }
        
        // è·å–ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„
        const filePath = req.file.path;
        let imageUrl;
        
        try {
            // ç¡®ä¿æ–‡ä»¶å­˜åœ¨
            if (!fs.existsSync(filePath)) {
                throw new Error(`ä¸Šä¼ çš„æ–‡ä»¶ä¸å­˜åœ¨: ${filePath}`);
            }
            
            // ä½¿ç”¨OSSæœåŠ¡ä¸Šä¼ å›¾ç‰‡åˆ°é˜¿é‡Œäº‘
            console.log('å¼€å§‹å°†å›¾ç‰‡ä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSS...');
            imageUrl = await uploadFile(filePath, 'images/');
            console.log('å›¾ç‰‡å·²æˆåŠŸä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSS:', imageUrl);
            
            if (!imageUrl || !imageUrl.startsWith('http')) {
                throw new Error('OSSæœªè¿”å›æœ‰æ•ˆçš„URL');
            }
        } catch (ossError) {
            console.error('ä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSSå¤±è´¥:', ossError);
            // è¿”å›é”™è¯¯ï¼Œä¸ä½¿ç”¨æœ¬åœ°URL
            return res.status(500).json({
                code: 'OssUploadFailed',
                message: 'ä¸Šä¼ å›¾ç‰‡åˆ°OSSå¤±è´¥: ' + ossError.message,
                request_id: null
            });
        }
        
        // è¿”å›ç»Ÿä¸€çš„å“åº”æ ¼å¼
        return res.json({
            output: {
                img_url: imageUrl
            },
            imageUrl: imageUrl, // å…¼å®¹æ—§ä»£ç 
            request_id: Date.now().toString() // ç”Ÿæˆä¸€ä¸ªå”¯ä¸€IDä½œä¸ºè¯·æ±‚ID
        });
    } catch (error) {
        console.error('å›¾ç‰‡ä¸Šä¼ å¤„ç†é”™è¯¯:', error);
        return res.status(500).json({
            code: 'InternalServerError',
            message: 'å›¾ç‰‡ä¸Šä¼ å¤„ç†å¤±è´¥: ' + error.message,
            request_id: null
        });
    }
});

/**
 * @route   POST /api/save-video-result
 * @desc    ä¿å­˜è§†é¢‘ç”Ÿæˆç»“æœï¼ˆä¸é‡å¤è®¡ç®—ç§¯åˆ†æ¶ˆè´¹ï¼‰
 * @access  Private
 */
router.post('/save-video-result', protect, async (req, res) => {
    try {
        const { taskId, videoUrl, prompt, type } = req.body;
        
        if (!taskId || !videoUrl) {
            return res.status(400).json({
                code: 'InvalidParameter',
                message: 'ç¼ºå°‘å¿…è¦å‚æ•°',
                request_id: null
            });
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ­¤ä»»åŠ¡çš„ç»“æœè®°å½•ï¼Œé¿å…é‡å¤ä¿å­˜
        const existingResult = await VideoResult.findOne({
            where: { taskId: taskId }
        });
        
        if (!existingResult) {
            console.log(`ä¿å­˜æ–°çš„è§†é¢‘ç»“æœè®°å½•: taskId=${taskId}, type=${type || 'image-to-video'}`);
        
        // ä¿å­˜è§†é¢‘ç»“æœåˆ°æ•°æ®åº“
        // è¿™é‡Œä½¿ç”¨ä¸æ–‡ç”Ÿè§†é¢‘ç›¸åŒçš„æ•°æ®æ¨¡å‹ï¼Œä½†æ·»åŠ äº†typeå­—æ®µåŒºåˆ†
        const result = new VideoResult({
            user: req.user.id,
            taskId: taskId,
            videoUrl: videoUrl,
            prompt: prompt,
            type: type || 'image-to-video',
            createdAt: new Date()
        });
        
        await result.save();
            
            // è§†é¢‘ç»“æœä¸ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒï¼Œæ³¨é‡Šæ‰å†å²è®°å½•ä¿å­˜
            console.log(`è§†é¢‘ç»“æœå®Œæˆï¼Œè·³è¿‡ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒå†å²è®°å½•: taskId=${taskId}`);
            // try {
            //     await ImageHistory.create({
            //         userId: req.user.id,
            //         imageUrl: videoUrl,
            //         processType: type === 'text-to-video' ? 'æ–‡ç”Ÿè§†é¢‘' : 'å›¾ç”Ÿè§†é¢‘',
            //         description: prompt || '',
            //         type: type === 'text-to-video' ? 'TEXT_TO_VIDEO_NO_DOWNLOAD' : 'IMAGE_TO_VIDEO_NO_DOWNLOAD',
            //         metadata: JSON.stringify({
            //             taskId: taskId
            //         }),
            //         createdAt: new Date()
            //     });
            //     console.log(`è§†é¢‘ç»“æœå·²ä¿å­˜åˆ°å†å²è®°å½•ä½†ä¸ä¼šæ˜¾ç¤ºåœ¨ä¸‹è½½ä¸­å¿ƒ: taskId=${taskId}`);
            // } catch (historyError) {
            //     console.error('ä¿å­˜è§†é¢‘å†å²è®°å½•å¤±è´¥:', historyError);
            //     // ç»§ç»­å¤„ç†ï¼Œä¸å½±å“ä¸»è¦åŠŸèƒ½
            // }
            
            // æ£€æŸ¥å…¨å±€å˜é‡ä¸­æ˜¯å¦å·²ç»æ‰£é™¤è¿‡ç§¯åˆ†ï¼Œé¿å…é‡å¤æ‰£è´¹
            const taskRecordType = type === 'text-to-video' ? 'textToVideoTasks' : 'imageToVideoTasks';
            if (global[taskRecordType] && global[taskRecordType][taskId]) {
                // å¦‚æœå·²ç»æ‰£é™¤è¿‡ç§¯åˆ†ï¼Œåˆ™ä¸å†é‡å¤è®¡ç®—ç§¯åˆ†æ¶ˆè´¹
                if (global[taskRecordType][taskId].hasChargedCredits) {
                    console.log(`ä»»åŠ¡ ${taskId} å·²ç»åœ¨ä¹‹å‰æ‰£é™¤è¿‡ç§¯åˆ†ï¼Œä¸å†é‡å¤è®¡ç®—ç§¯åˆ†æ¶ˆè´¹`);
                } else {
                    console.log(`ä»»åŠ¡ ${taskId} çš„ç§¯åˆ†æ¶ˆè´¹å·²åœ¨å…¶ä»–åœ°æ–¹å¤„ç†ï¼Œæ ‡è®°ä¸ºå·²æ‰£è´¹`);
                    global[taskRecordType][taskId].hasChargedCredits = true;
                }
            } else {
                console.log(`æ‰¾ä¸åˆ°ä»»åŠ¡ ${taskId} çš„å…¨å±€è®°å½•ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨é‡å¯æˆ–å…¶ä»–åŸå› `);
            }
        } else {
            console.log(`å·²å­˜åœ¨è§†é¢‘ç»“æœè®°å½•ï¼Œè·³è¿‡ä¿å­˜: taskId=${taskId}`);
        }
        
        // è¿”å›å“åº” - ä½¿ç”¨ä¸APIä¸€è‡´çš„å“åº”æ ¼å¼
        return res.json({
            output: {
                task_id: taskId,
                task_status: 'SUCCEEDED',
                video_url: videoUrl
            },
            request_id: Date.now().toString() // ç”Ÿæˆä¸€ä¸ªå”¯ä¸€IDä½œä¸ºè¯·æ±‚ID
        });
    } catch (error) {
        console.error('ä¿å­˜è§†é¢‘ç»“æœé”™è¯¯:', error);
        return res.status(500).json({
            code: 'InternalServerError',
            message: 'ä¿å­˜è§†é¢‘ç»“æœå¤±è´¥: ' + error.message,
            request_id: null
        });
    }
});

/**
 * @route   POST /api/text-to-video/image-to-video-sync
 * @desc    åˆ›å»ºå›¾ç”Ÿè§†é¢‘ä»»åŠ¡ï¼ˆåŒæ­¥APIï¼Œä¸SDKè¡Œä¸ºä¸€è‡´ï¼‰
 * @access  Private
 */
router.post('/image-to-video-sync', protect, checkFeatureAccess('image-to-video'), async (req, res) => {
    try {
        const { model, prompt, img_url, parameters } = req.body;
        const userId = req.user.id;
        
        // å‚æ•°éªŒè¯
        if (!model || !prompt || !img_url) {
            return res.status(400).json({ 
                status_code: 400,
                code: 'InvalidParameter',
                message: 'ç¼ºå°‘å¿…è¦å‚æ•°ï¼šmodel, prompt, img_url',
                request_id: null
            });
        }
        
        // éªŒè¯æ¨¡å‹åç§°
        if (!model.includes('wanx2.1-i2v')) {
            return res.status(400).json({
                status_code: 400,
                code: 'InvalidParameter',
                message: 'ä¸æ”¯æŒçš„æ¨¡å‹åç§°ï¼Œå›¾ç”Ÿè§†é¢‘åº”ä½¿ç”¨wanx2.1-i2v-turboæˆ–wanx2.1-i2v-plusæ¨¡å‹',
                request_id: null
            });
        }
        
        // å‡†å¤‡è°ƒç”¨é˜¿é‡Œäº‘å›¾ç”Ÿè§†é¢‘APIçš„è¯·æ±‚ - ä¸SDKæ ¼å¼ä¸€è‡´
        const dashscopeRequest = {
            model: model,
            input: {
                prompt: prompt,
                img_url: img_url
            },
            parameters: parameters || {}
        };
        
        // å‚æ•°å¤„ç†ï¼šç¡®ä¿åˆ†è¾¨ç‡æ­£ç¡®
        if (dashscopeRequest.parameters.resolution) {
            const resolution = dashscopeRequest.parameters.resolution.toString().toUpperCase();
            if (!['480P', '720P'].includes(resolution)) {
                if (resolution.includes('1280') || resolution.includes('720')) {
                    dashscopeRequest.parameters.resolution = '720P';
                } else if (resolution.includes('640') || resolution.includes('480')) {
                    dashscopeRequest.parameters.resolution = '480P';
                } else {
                    dashscopeRequest.parameters.resolution = '720P';
                }
            } else {
                dashscopeRequest.parameters.resolution = resolution;
            }
        } else {
            dashscopeRequest.parameters.resolution = '720P';
        }
        
        // ç¡®ä¿durationå‚æ•°æœ‰æ•ˆ
        if (dashscopeRequest.parameters.duration) {
            const duration = parseInt(dashscopeRequest.parameters.duration);
            if (model === 'wanx2.1-i2v-plus' && duration !== 5) {
                dashscopeRequest.parameters.duration = 5;
            } else if (model === 'wanx2.1-i2v-turbo' && ![3, 4, 5].includes(duration)) {
                dashscopeRequest.parameters.duration = 5;
            }
        } else {
            dashscopeRequest.parameters.duration = 5;
        }
        
        console.log('è°ƒç”¨é˜¿é‡Œäº‘å›¾ç”Ÿè§†é¢‘åŒæ­¥APIï¼Œè¯·æ±‚å‚æ•°:', JSON.stringify(dashscopeRequest, null, 2));
        
        // åŒæ­¥è°ƒç”¨é˜¿é‡Œäº‘å›¾ç”Ÿè§†é¢‘API (ä¸ä½¿ç”¨X-DashScope-Asyncå¤´)
        const response = await axios.post(
            'https://dashscope.aliyuncs.com/api/v1/services/aigc/video-generation/video-synthesis',
            dashscopeRequest,
            {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${process.env.DASHSCOPE_API_KEY}`
                },
                timeout: 60000 // åŒæ­¥APIéœ€è¦æ›´é•¿çš„è¶…æ—¶æ—¶é—´ï¼Œè®¾ä¸º60ç§’
            }
        );
        
        // è·å–åŠŸèƒ½é…ç½®ä¿¡æ¯
        const { FEATURES } = require('../middleware/featureAccess');
        const creditCost = FEATURES['image-to-video']?.creditCost || 66; // é»˜è®¤ä¸æ–‡ç”Ÿè§†é¢‘ç›¸åŒçš„æˆæœ¬
        
        // ç”Ÿæˆå”¯ä¸€ä»»åŠ¡ID - ç¡®ä¿ä¸å¼‚æ­¥APIä¸€è‡´
        const taskId = response.data.output?.task_id || `sync-${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;
        
        // è®°å½•ä»»åŠ¡ä¿¡æ¯åˆ°å…¨å±€å˜é‡ï¼Œæ–¹ä¾¿åç»­æŸ¥è¯¢å’Œç§¯åˆ†ç»Ÿè®¡
        if (!global.imageToVideoTasks) {
            global.imageToVideoTasks = {};
        }
        
        global.imageToVideoTasks[taskId] = {
            userId: userId,
            prompt: prompt,
            img_url: img_url,
            timestamp: new Date(),
            creditCost: creditCost,
            hasChargedCredits: false,  // ä¿®æ”¹ä¸ºfalseï¼Œç¡®ä¿ä»»åŠ¡å®Œæˆåæ‰£é™¤ç§¯åˆ†
            isFree: req.featureUsage?.usageType === 'free' // æ ‡è®°æ˜¯å¦ä¸ºå…è´¹ä½¿ç”¨
        };
        
        // ç«‹å³å†™å…¥æ•°æ®åº“è®°å½•
        try {
            if (req.featureUsage && req.featureUsage.usage) {
                const { saveTaskDetails } = require('../middleware/unifiedFeatureUsage');
                await saveTaskDetails(req.featureUsage.usage, {
                    taskId: taskId,
                    creditCost: creditCost,
                    isFree: req.featureUsage?.usageType === 'free'
                });
                console.log(`å·²å³æ—¶å†™å…¥å›¾ç”Ÿè§†é¢‘(åŒæ­¥)ä»»åŠ¡è®°å½•åˆ°æ•°æ®åº“ taskId=${taskId}`);
            }
        } catch (dbErr) {
            console.error('å³æ—¶ä¿å­˜å›¾ç”Ÿè§†é¢‘(åŒæ­¥)ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', dbErr);
        }
        
        console.log(`ä¿å­˜å›¾ç”Ÿè§†é¢‘ä»»åŠ¡ä¿¡æ¯(åŒæ­¥API): ç”¨æˆ·ID=${userId}, ä»»åŠ¡ID=${taskId}, ç§¯åˆ†=${creditCost}${req.featureUsage?.usageType === 'free' ? ' (å…è´¹æ¬¡æ•°)' : ''}`);
        console.log(`å½“å‰imageToVideoTasksè®°å½•æ•°: ${Object.keys(global.imageToVideoTasks).length}`);
        
        // è¿”å›é˜¿é‡Œäº‘åŸå§‹å“åº” - åŒæ­¥APIç›´æ¥è¿”å›ç»“æœï¼ŒåŒ…å«video_url
        return res.json(response.data);
    } catch (error) {
        console.error('åŒæ­¥è°ƒç”¨å›¾ç”Ÿè§†é¢‘APIå‡ºé”™:', error);
        
        // é”™è¯¯å¤„ç†
        if (error.response && error.response.data) {
            // ç›´æ¥è¿”å›é˜¿é‡Œäº‘APIåŸå§‹é”™è¯¯æ ¼å¼
            return res.status(error.response.status || 500).json(error.response.data);
        }
        
        // SDKé£æ ¼çš„é”™è¯¯å“åº”æ ¼å¼
        return res.status(500).json({
            status_code: 500,
            code: 'InternalServerError',
            message: 'æœåŠ¡å™¨å¤„ç†å¼‚å¸¸: ' + error.message,
            request_id: null
        });
    }
});

// åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ä¸Šä¼ å›¾ç‰‡è·¯ç”±å¤„ç†å‡½æ•°
const uploadImageRoute = express.Router();

// ä½¿ç”¨JSONè§£æä¸­é—´ä»¶
uploadImageRoute.use(express.json({ limit: '10mb' }));

// åˆ›å»ºFormDataè§£æä¸­é—´ä»¶ - æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’ŒBase64
const fileUploadParser = multer({ 
    storage: multer.memoryStorage(),
    limits: { fileSize: 10 * 1024 * 1024 } // 10MBé™åˆ¶
}).single('image');

// å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆæ”¯æŒæ–‡ä»¶ä¸Šä¼ å’ŒBase64ï¼‰- ä¸éœ€è¦è®¤è¯
uploadImageRoute.post('/', fileUploadParser, async (req, res) => {
    // ç¡®ä¿ç¯å¢ƒå˜é‡å·²åŠ è½½
    require('dotenv').config();
    try {
        // æ·»åŠ è°ƒè¯•æ—¥å¿—
        console.log('=== å›¾ç‰‡ä¸Šä¼ è¯·æ±‚è°ƒè¯•ä¿¡æ¯ ===');
        console.log('è¯·æ±‚åˆ°è¾¾uploadImageRoute');
        console.log('Content-Type:', req.headers['content-type']);
        console.log('req.file:', req.file);
        console.log('req.body:', JSON.stringify(req.body, null, 2));
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯Base64ä¸Šä¼ ï¼ˆé€šè¿‡bodyå‚æ•°ï¼‰
        const isBase64Upload = (req.body && req.body.type === 'base64' && req.body.image) || 
                              (req.body && req.body.image && typeof req.body.image === 'string' && req.body.image.startsWith('data:')) ||
                              (req.body && req.body.image && typeof req.body.image === 'string' && req.body.image.length > 100); // çº¯Base64æ•°æ®é€šå¸¸å¾ˆé•¿
        
        console.log('isBase64Upload:', isBase64Upload);
        
        if (isBase64Upload) {
            // å¤„ç†Base64å›¾ç‰‡
            let base64Data = req.body.image;
            
            // å¦‚æœæ˜¯data:imageæ ¼å¼ï¼Œæå–Base64éƒ¨åˆ†
            if (base64Data.startsWith('data:')) {
                base64Data = base64Data.split(',')[1];
            }
            
            const imageUrl = await uploadBase64Image(base64Data);
            
            return res.json({
                success: true,
                output: {
                    img_url: imageUrl
                },
                imageUrl: imageUrl,
                url: imageUrl
            });
        }
        
        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        if (!req.file) {
            return res.status(400).json({ 
                code: 'InvalidParameter',
                message: 'æœªæä¾›å›¾ç‰‡æ–‡ä»¶',
                request_id: null
            });
        }
        
        let imageUrl;
        
        try {
            // å°†bufferå†™å…¥ä¸´æ—¶æ–‡ä»¶
            const tempDir = path.join(__dirname, '../uploads/temp');
            if (!fs.existsSync(tempDir)) {
                fs.mkdirSync(tempDir, { recursive: true });
            }
            
            const tempFilePath = path.join(tempDir, `${Date.now()}-${req.file.originalname}`);
            fs.writeFileSync(tempFilePath, req.file.buffer);
            
            console.log('ä¸´æ—¶æ–‡ä»¶å·²åˆ›å»º:', tempFilePath);
            
            // ä½¿ç”¨OSSæœåŠ¡ä¸Šä¼ å›¾ç‰‡åˆ°é˜¿é‡Œäº‘
            console.log('å¼€å§‹å°†å›¾ç‰‡ä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSS...');
            imageUrl = await uploadFile(tempFilePath, 'images/');
            console.log('å›¾ç‰‡å·²æˆåŠŸä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSS:', imageUrl);
            
            if (!imageUrl || !imageUrl.startsWith('http')) {
                throw new Error('OSSæœªè¿”å›æœ‰æ•ˆçš„URL');
            }
            
            // ä¸Šä¼ æˆåŠŸåæ¸…ç†ä¸´æ—¶æ–‡ä»¶
            try {
                if (fs.existsSync(tempFilePath)) {
                    fs.unlinkSync(tempFilePath);
                    console.log('ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†:', tempFilePath);
                }
            } catch (cleanupError) {
                console.warn('æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:', cleanupError);
                // ä¸å½±å“ä¸»æµç¨‹ï¼Œä»…è®°å½•è­¦å‘Š
            }
        } catch (ossError) {
            console.error('ä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSSå¤±è´¥:', ossError);
            
            // å¤±è´¥æ—¶ä¹Ÿè¦æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            try {
                if (fs.existsSync(tempFilePath)) {
                    fs.unlinkSync(tempFilePath);
                    console.log('ä¸Šä¼ å¤±è´¥ï¼Œä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†:', tempFilePath);
                }
            } catch (cleanupError) {
                console.warn('æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:', cleanupError);
            }
            
            // è¿”å›é”™è¯¯ä¿¡æ¯
            return res.status(500).json({
                success: false,
                code: 'OssUploadFailed',
                message: 'ä¸Šä¼ å›¾ç‰‡åˆ°OSSå¤±è´¥: ' + ossError.message,
                request_id: null
            });
        }
        
        // è¿”å›ç»Ÿä¸€çš„å“åº”æ ¼å¼
        const response = {
            success: true, // æ·»åŠ successå­—æ®µä»¥å…¼å®¹å‰ç«¯ä»£ç 
            output: {
                img_url: imageUrl
            },
            imageUrl: imageUrl, // å…¼å®¹æ—§ä»£ç 
            url: imageUrl // å…¼å®¹æ—§ä»£ç 
        };
        
        res.json(response);
    } catch (error) {
        console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
        
        // å‘ç”Ÿé”™è¯¯æ—¶æ¸…ç†å¯èƒ½å­˜åœ¨çš„ä¸´æ—¶æ–‡ä»¶
        try {
            const tempDir = path.join(__dirname, '../uploads/temp');
            const tempFilePath = path.join(tempDir, `${Date.now()}-${req.file?.originalname || 'unknown'}`);
            if (fs.existsSync(tempFilePath)) {
                fs.unlinkSync(tempFilePath);
                console.log('é”™è¯¯å¤„ç†ä¸­æ¸…ç†ä¸´æ—¶æ–‡ä»¶:', tempFilePath);
            }
        } catch (cleanupError) {
            console.warn('é”™è¯¯å¤„ç†ä¸­æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:', cleanupError);
        }
        
        res.status(500).json({
            success: false,
            message: 'ä¸Šä¼ å›¾ç‰‡å¤±è´¥: ' + error.message
        });
    }
});

// å¤„ç†Base64å›¾ç‰‡ä¸Šä¼ çš„è¾…åŠ©å‡½æ•°
async function uploadBase64Image(base64Data) {
    try {
        // å°†Base64è½¬æ¢ä¸ºBuffer
        const imageBuffer = Buffer.from(base64Data, 'base64');
        
        // ç”Ÿæˆä¸´æ—¶æ–‡ä»¶å
        const tempFileName = `temp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}.jpg`;
        const tempFilePath = path.join('uploads', tempFileName);
        
        // ç¡®ä¿uploadsç›®å½•å­˜åœ¨
        if (!fs.existsSync('uploads')) {
            fs.mkdirSync('uploads', { recursive: true });
        }
        
        // å†™å…¥ä¸´æ—¶æ–‡ä»¶
        fs.writeFileSync(tempFilePath, imageBuffer);
        
        try {
            // æ£€æŸ¥OSSé…ç½®æ˜¯å¦å®Œæ•´
            if (!process.env.OSS_REGION || !process.env.ALIYUN_ACCESS_KEY_ID || 
                !process.env.ALIYUN_ACCESS_KEY_SECRET || !process.env.OSS_BUCKET) {
                console.log('OSSé…ç½®ä¸å®Œæ•´ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨...');
                
                // ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä½œä¸ºé™çº§æ–¹æ¡ˆ
                const publicPath = path.join(__dirname, '../public/uploads');
                if (!fs.existsSync(publicPath)) {
                    fs.mkdirSync(publicPath, { recursive: true });
                }
                
                const fileName = `image-${Date.now()}-${Math.random().toString(36).substr(2, 9)}.jpg`;
                const publicFilePath = path.join(publicPath, fileName);
                
                // å¤åˆ¶æ–‡ä»¶åˆ°publicç›®å½•
                fs.copyFileSync(tempFilePath, publicFilePath);
                
                // è¿”å›æœ¬åœ°URL
                const imageUrl = `http://localhost:8080/uploads/${fileName}`;
                console.log('Base64å›¾ç‰‡å·²ä¿å­˜åˆ°æœ¬åœ°:', imageUrl);
                
                return imageUrl;
            } else {
                // ä¸Šä¼ åˆ°OSS
                console.log('å¼€å§‹å°†Base64å›¾ç‰‡ä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSS...');
                const imageUrl = await uploadFile(tempFilePath, 'images/');
                console.log('Base64å›¾ç‰‡å·²æˆåŠŸä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSS:', imageUrl);
                
                if (!imageUrl || !imageUrl.startsWith('http')) {
                    throw new Error('OSSæœªè¿”å›æœ‰æ•ˆçš„URL');
                }
                
                return imageUrl;
            }
        } finally {
            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            try {
                if (fs.existsSync(tempFilePath)) {
                    fs.unlinkSync(tempFilePath);
                    console.log('Base64ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†:', tempFilePath);
                }
            } catch (cleanupError) {
                console.warn('æ¸…ç†Base64ä¸´æ—¶æ–‡ä»¶å¤±è´¥:', cleanupError);
            }
        }
    } catch (error) {
        console.error('å¤„ç†Base64å›¾ç‰‡å¤±è´¥:', error);
        throw error;
    }
}


// æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
router.get('/digital-human/task/:taskId', protect, async (req, res) => {
    try {
        const { taskId } = req.params;
        console.log('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', taskId);
        
        // éªŒè¯ä»»åŠ¡IDæ ¼å¼
        if (!taskId || taskId.length < 5) {
            return res.status(400).json({ message: 'æ— æ•ˆçš„ä»»åŠ¡ID' });
        }
        
        // æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
        console.log('å‡†å¤‡æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€:', taskId);
        const response = await dashscopeService.queryVideoRetalkTaskStatus(taskId);
        
        if (response.status !== 200) {
            console.error('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', response.data);
            return res.status(response.status).json({ message: 'æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥', details: response.data });
        }
        
        console.log('å®Œæ•´å“åº”æ•°æ®:', response.data);
        
        // è§£æå“åº”æ•°æ®
        const output = response.data.output;
        const taskStatus = output.task_status;
        
        // å‡†å¤‡å“åº”æ•°æ®
        let responseData = {
            status: taskStatus
        };
        
        // å¦‚æœä»»åŠ¡å®Œæˆï¼Œæ·»åŠ è§†é¢‘URL
        if (taskStatus === 'SUCCEEDED') {
            const videoUrl = output.video_url;
            console.log('ä»output.video_urlè·å–åˆ°è§†é¢‘URL:', videoUrl);
            
            // è·å–è§†é¢‘æ—¶é•¿
            let videoDuration = 0;
            if (response.data.usage && response.data.usage.video_duration) {
                videoDuration = Math.ceil(response.data.usage.video_duration);
                console.log('ä»APIå“åº”çš„usage.video_durationè·å–è§†é¢‘æ—¶é•¿:', response.data.usage.video_duration, 'ç§’ï¼Œå–æ•´å:', videoDuration, 'ç§’');
            }
            
            // æŸ¥è¯¢ä»»åŠ¡è¯¦æƒ…ä»¥è·å–ç§¯åˆ†æ¶ˆè´¹ä¿¡æ¯
            const userId = req.user.id;
            const featureUsage = await FeatureUsage.findOne({
                where: { userId, featureName: 'DIGITAL_HUMAN_VIDEO' }
            });
            
            let creditsUsed = 0;
            if (featureUsage && featureUsage.details) {
                try {
                    const details = JSON.parse(featureUsage.details);
                    const taskDetail = details.tasks.find(t => t.taskId === taskId);
                    if (taskDetail) {
                        creditsUsed = taskDetail.credits || 0;
                    }
                } catch (err) {
                    console.error('è§£æä»»åŠ¡è¯¦æƒ…å¤±è´¥:', err);
                }
            }
            
            // ä¿å­˜ä»»åŠ¡è¯¦æƒ…
            const taskDetails = {
                status: 'SUCCEEDED',
                videoUrl: videoUrl,
                videoDuration: videoDuration,
                creditsUsed: creditsUsed,
                requestId: response.data.request_id
            };
            
            console.log('å®Œæ•´å“åº”çŠ¶æ€æ•°æ®:', taskDetails);
            
            // ä¿å­˜ä»»åŠ¡è¯¦æƒ…åˆ°æ•°æ®åº“
            try {
                await saveTaskDetails(taskId, req.user.id, taskDetails);
            } catch (error) {
                console.error('ä¿å­˜ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
            }
            
            responseData = taskDetails;
        } else if (taskStatus === 'FAILED') {
            // å¦‚æœä»»åŠ¡å¤±è´¥ï¼Œæ·»åŠ é”™è¯¯ä¿¡æ¯
            responseData.message = output.message || 'ä»»åŠ¡å¤„ç†å¤±è´¥';
        }
        
        res.status(200).json(responseData);
        console.log('å“åº”è¯·æ±‚: GET /api/digital-human/task/' + taskId + ' - çŠ¶æ€: 200');
    } catch (error) {
        console.error('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€æ—¶å‡ºé”™:', error);
        res.status(500).json({ message: 'æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€æ—¶å‡ºé”™', error: error.message });
    }
});

// ä¿å­˜ä»»åŠ¡è¯¦æƒ…åˆ°æ•°æ®åº“
async function saveTaskDetails(taskId, userId, details) {
    try {
        const featureUsage = await FeatureUsage.findOne({
            where: { userId, featureName: 'DIGITAL_HUMAN_VIDEO' }
        });
        
        if (!featureUsage) {
            console.error(`æœªæ‰¾åˆ°ç”¨æˆ·${userId}çš„DIGITAL_HUMAN_VIDEOåŠŸèƒ½ä½¿ç”¨è®°å½•`);
            return;
        }
        
        // è§£æç°æœ‰details
        let parsedDetails = { tasks: [] };
        if (featureUsage.details) {
            try {
                parsedDetails = JSON.parse(featureUsage.details);
                if (!parsedDetails.tasks) {
                    parsedDetails.tasks = [];
                }
            } catch (err) {
                console.error('è§£ædetailså¤±è´¥:', err);
                parsedDetails = { tasks: [] };
            }
        }
        
        // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¯¥ä»»åŠ¡
        const taskIndex = parsedDetails.tasks.findIndex(t => t.taskId === taskId);
        
        if (taskIndex >= 0) {
            // æ›´æ–°ç°æœ‰ä»»åŠ¡
            parsedDetails.tasks[taskIndex] = {
                ...parsedDetails.tasks[taskIndex],
                ...details
            };
        } else {
            // æ·»åŠ æ–°ä»»åŠ¡
            parsedDetails.tasks.push({
                taskId,
                ...details,
                timestamp: new Date().toISOString()
            });
        }
        
        // æ›´æ–°æ•°æ®åº“
        await featureUsage.update({
            details: JSON.stringify(parsedDetails)
        });
        
        console.log(`ä»»åŠ¡è¯¦æƒ…å·²ä¿å­˜: ä»»åŠ¡ID=${taskId}, ç§¯åˆ†=${details.creditsUsed}, æ˜¯å¦å…è´¹=${details.isFree || false}`);
    } catch (error) {
        console.error('ä¿å­˜ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
        throw error;
    }
}

// OSSå­˜å‚¨ç›¸å…³å‡½æ•°
const { client } = require('../utils/ossService');

/**
 * ä»OSSåŠ è½½ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨
 * @param {string} userId - ç”¨æˆ·ID
 * @returns {Promise<Array>} ä»»åŠ¡åˆ—è¡¨
 */
async function loadTasksFromOSS(userId, taskType = 'text-to-video') {
    try {
        const ossPath = `${taskType}/tasks/${userId}/tasks.json`;
        
        console.log(`ä»OSSåŠ è½½ä»»åŠ¡åˆ—è¡¨: ${ossPath}`);
        
        // å°è¯•ä»OSSè·å–ä»»åŠ¡åˆ—è¡¨
        const result = await client.get(ossPath);
        const tasksData = JSON.parse(result.content.toString());
        
        console.log(`ä»OSSåŠ è½½åˆ° ${tasksData.length} ä¸ªä»»åŠ¡`);
        return tasksData;
    } catch (error) {
        if (error.code === 'NoSuchKey') {
            console.log('OSSä¸­ä¸å­˜åœ¨ä»»åŠ¡æ–‡ä»¶ï¼Œè¿”å›ç©ºæ•°ç»„');
            return [];
        }
        console.error('ä»OSSåŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
        throw error;
    }
}

/**
 * ä¿å­˜ä»»åŠ¡åˆ—è¡¨åˆ°OSS
 * @param {string} userId - ç”¨æˆ·ID
 * @param {Array} tasks - ä»»åŠ¡åˆ—è¡¨
 * @returns {Promise<void>}
 */
async function saveTasksToOSS(userId, tasks, taskType = 'text-to-video') {
    try {
        const ossPath = `${taskType}/tasks/${userId}/tasks.json`;
        
        console.log(`ä¿å­˜ä»»åŠ¡åˆ—è¡¨åˆ°OSS: ${ossPath}, ä»»åŠ¡æ•°é‡: ${tasks.length}`);
        
        // è¿‡æ»¤24å°æ—¶å†…çš„ä»»åŠ¡
        const now = new Date();
        const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        
        const recentTasks = tasks.filter(task => {
            const taskTime = new Date(task.createdAt);
            return taskTime >= twentyFourHoursAgo;
        });
        
        // æŒ‰åˆ›å»ºæ—¶é—´é™åºæ’åºï¼Œç¡®ä¿æœ€æ–°çš„ä»»åŠ¡åœ¨å‰é¢
        const sortedTasks = recentTasks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        // åªä¿å­˜æœ€æ–°çš„1ä¸ªä»»åŠ¡ï¼Œç¬¦åˆæ˜¾ç¤ºè¦æ±‚
        const tasksToSave = sortedTasks.slice(0, 1);
        
        console.log(`è¿‡æ»¤å24å°æ—¶å†…ä»»åŠ¡: ${recentTasks.length} ä¸ªï¼Œä¿å­˜æœ€æ–°: ${tasksToSave.length} ä¸ª`);
        
        const tasksJson = JSON.stringify(tasksToSave, null, 2);
        
        await client.put(ossPath, Buffer.from(tasksJson, 'utf8'), {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log(`ä»»åŠ¡åˆ—è¡¨å·²ä¿å­˜åˆ°OSS: ${ossPath}`);
    } catch (error) {
        console.error('ä¿å­˜ä»»åŠ¡åˆ—è¡¨åˆ°OSSå¤±è´¥:', error);
        throw error;
    }
}

/**
 * æ·»åŠ ä»»åŠ¡åˆ°OSSå­˜å‚¨
 * @param {string} userId - ç”¨æˆ·ID
 * @param {Object} task - ä»»åŠ¡å¯¹è±¡
 * @returns {Promise<void>}
 */
async function addTaskToOSS(userId, task, taskType = 'text-to-video') {
    try {
        // å…ˆåŠ è½½ç°æœ‰ä»»åŠ¡
        const existingTasks = await loadTasksFromOSS(userId, taskType);
        
        // æ·»åŠ æ–°ä»»åŠ¡åˆ°å¼€å¤´
        existingTasks.unshift(task);
        
        // ä¿å­˜æ›´æ–°åçš„ä»»åŠ¡åˆ—è¡¨ï¼ˆä¼šè‡ªåŠ¨è¿‡æ»¤24å°æ—¶å†…çš„ä»»åŠ¡å¹¶åªä¿å­˜æœ€æ–°1æ¡ï¼‰
        await saveTasksToOSS(userId, existingTasks, taskType);
        
        console.log(`ä»»åŠ¡å·²æ·»åŠ åˆ°OSS: ${task.id}`);
    } catch (error) {
        console.error('æ·»åŠ ä»»åŠ¡åˆ°OSSå¤±è´¥:', error);
        throw error;
    }
}

/**
 * æ›´æ–°OSSä¸­çš„ä»»åŠ¡
 * @param {string} userId - ç”¨æˆ·ID
 * @param {string} taskId - ä»»åŠ¡ID
 * @param {Object} updates - æ›´æ–°å†…å®¹
 * @returns {Promise<void>}
 */
async function updateTaskInOSS(userId, taskId, updates, taskType = 'text-to-video') {
    try {
        // å…ˆåŠ è½½ç°æœ‰ä»»åŠ¡
        const existingTasks = await loadTasksFromOSS(userId, taskType);
        
        // æ‰¾åˆ°å¹¶æ›´æ–°ä»»åŠ¡
        const taskIndex = existingTasks.findIndex(task => task.id === taskId);
        if (taskIndex !== -1) {
            existingTasks[taskIndex] = { ...existingTasks[taskIndex], ...updates };
            
            // ä¿å­˜æ›´æ–°åçš„ä»»åŠ¡åˆ—è¡¨
            await saveTasksToOSS(userId, existingTasks, taskType);
            
            console.log(`ä»»åŠ¡å·²æ›´æ–°åˆ°OSS: ${taskId}`);
        } else {
            console.warn(`æœªæ‰¾åˆ°è¦æ›´æ–°çš„ä»»åŠ¡: ${taskId}`);
        }
    } catch (error) {
        console.error('æ›´æ–°ä»»åŠ¡åˆ°OSSå¤±è´¥:', error);
        throw error;
    }
}

/**
 * ä»OSSåˆ é™¤ä»»åŠ¡
 * @param {string} userId - ç”¨æˆ·ID
 * @param {string} taskId - ä»»åŠ¡ID
 * @returns {Promise<void>}
 */
async function deleteTaskFromOSS(userId, taskId, taskType = 'text-to-video') {
    try {
        // å…ˆåŠ è½½ç°æœ‰ä»»åŠ¡
        const existingTasks = await loadTasksFromOSS(userId, taskType);
        
        // è¿‡æ»¤æ‰è¦åˆ é™¤çš„ä»»åŠ¡
        const filteredTasks = existingTasks.filter(task => task.id !== taskId);
        
        // ä¿å­˜æ›´æ–°åçš„ä»»åŠ¡åˆ—è¡¨
        await saveTasksToOSS(userId, filteredTasks, taskType);
        
        console.log(`ä»»åŠ¡å·²ä»OSSåˆ é™¤: ${taskId}`);
    } catch (error) {
        console.error('ä»OSSåˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
        throw error;
    }
}

module.exports = router;
module.exports.uploadImageRoute = uploadImageRoute; 