<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- å®Œå…¨ç§»é™¤CSPé™åˆ¶ä»¥è§£å†³è§†é¢‘åŠ è½½é—®é¢˜ -->
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self'; media-src * blob: data:; img-src * blob: data:; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; font-src 'self' https://cdn.jsdelivr.net;"> -->
    <title data-translate="digital_human_video.page_title">è§†é¢‘æ•°å­—äºº - è¤ç«AI</title>
    <link rel="icon" href="/images/favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="/components/styles.css" rel="stylesheet">
    <script src="/js/mobile-guard.js"></script>
    <script src="/translations.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow-y: auto;
        }
        @keyframes firefly-glow {
            0% { text-shadow: 0 0 3px rgba(99, 102, 241, 0.5); }
            50% { text-shadow: 0 0 10px rgba(99, 102, 241, 0.8), 0 0 15px rgba(99, 102, 241, 0.3); }
            100% { text-shadow: 0 0 3px rgba(99, 102, 241, 0.5); }
        }
        .logo-text {
            animation: firefly-glow 3s infinite;
        }
        .logo-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #6366f1;
            border-radius: 50%;
            margin-left: 2px;
            margin-right: 4px;
            position: relative;
            top: -2px;
        }
        .custom-file-upload {
            display: inline-block;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 0.375rem;
            background-color: #f9fafb;
            border: 1px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .custom-file-upload:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }
        .video-preview-container {
            aspect-ratio: 9/16;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
        }
        .avatar-option {
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .avatar-option.selected {
            border-color: #6366f1;
            transform: scale(1.05);
        }
        .avatar-option:hover:not(.selected) {
            transform: scale(1.03);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .vertical-divider {
            width: 2px;
            background-color: #e5e7eb;
            margin: 0 1rem;
        }
        .preview-container {
            aspect-ratio: 16/9;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
            border: 1px dashed #d1d5db;
        }
        
        /* ç¡®ä¿è§†é¢‘åœ¨å®¹å™¨ä¸­å®Œæ•´æ˜¾ç¤º */
        .preview-container video {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ä¿æŒè§†é¢‘æ¯”ä¾‹ï¼Œç¡®ä¿å®Œæ•´æ˜¾ç¤º */
        }
        /* ç§»é™¤å›ºå®šé«˜åº¦çš„æ»šåŠ¨é¢æ¿ï¼Œæ”¹ä¸ºæ•´ä½“é¡µé¢æ»šåŠ¨ */
        /* å…¨å±€æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        .upload-progress {
            width: 0%;
            height: 4px;
            background-color: #6366f1;
            position: absolute;
            bottom: 0;
            left: 0;
            transition: width 0.3s ease;
        }
        /* Logoå›¾ç‰‡æ ·å¼ */
        .logo-image {
            max-height: 92px;
            height: auto;
            width: auto;
            transition: all 0.2s ease;
        }
        /* Logoå®¹å™¨æ ·å¼ */
        .logo-container {
            display: flex;
            align-items: center;
            position: relative;
            z-index: 5;
            transition: transform 0.2s ease;
            margin-top: 12px;
        }
        .logo-container:hover .logo-image {
            transform: scale(1.02);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- å¯¼èˆªæ ç»„ä»¶å®¹å™¨ -->
    <div id="navbar-simple"></div>

    <div class="container mx-auto py-8 px-4" style="margin-top: 60px;">
        <h1 class="text-3xl font-bold text-center mb-8" data-translate="digital_human_video.main_title">è§†é¢‘æ•°å­—äºº</h1>
        
    <main>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- å·¦ä¾§åŒºåŸŸï¼šä¸Šä¼ åŒºåŸŸå’Œé…ç½® -->
        <div class="md:col-span-1">
            <div class="space-y-6">
                <!-- ä¸Šä¼ è§†é¢‘ -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold mb-4" data-translate="digital_human_video.upload_video_title">ä¸Šä¼ äººç‰©è§†é¢‘</h2>
                    <div class="preview-container flex items-center justify-center mb-4 relative">
                        <div id="video-placeholder" class="flex flex-col items-center justify-center p-6 text-center">
                            <i class="ri-video-upload-line text-5xl text-gray-300 mb-2"></i>
                            <p class="text-gray-500 text-sm" data-translate="digital_human_video.video_upload_hint">ç‚¹å‡»æˆ–è€…æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ </p>
                            <p class="text-gray-400 text-xs mt-2" data-translate="digital_human_video.video_format_requirements">æ”¯æŒMP4æ ¼å¼ï¼Œâ‰¤300MBï¼Œ2ç§’ï¼œæ—¶é•¿ï¼œ120ç§’</p>
                            <input type="file" id="video-upload" accept="video/mp4" class="hidden" />
                            <button onclick="document.getElementById('video-upload').click()" class="mt-4 px-4 py-2 bg-indigo-50 text-indigo-600 text-sm font-medium rounded-md hover:bg-indigo-100 focus:outline-none" data-translate="digital_human_video.upload_video_btn">ä¸Šä¼ è§†é¢‘</button>
                        </div>
                        <div id="video-preview" class="hidden w-full h-full">
                            <video id="uploaded-video" class="w-full h-full object-contain" controls></video>
                        </div>
                        <div class="upload-progress" id="video-progress"></div>
                    </div>
                    <p class="text-xs text-gray-500" data-translate="digital_human_video.video_requirements">è§†é¢‘è¦æ±‚: äººç‰©æ­£é¢å‡ºé•œçš„è¿‘æ™¯ç”»é¢ï¼Œäººè„¸æ¸…æ™°å¯è§ä¸”å æ¯”é€‚ä¸­ï¼Œé¿å…å¤§è§’åº¦ä¾§è„¸ã€‚</p>
                </div>

                <!-- ä¸Šä¼ éŸ³é¢‘ -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold mb-4" data-translate="digital_human_video.upload_audio_title">ä¸Šä¼ è¯­éŸ³/éŸ³é¢‘</h2>
                    <div class="preview-container flex items-center justify-center mb-4 relative">
                        <div id="audio-placeholder" class="flex flex-col items-center justify-center p-6 text-center">
                            <i class="ri-file-music-line text-5xl text-gray-300 mb-2"></i>
                            <p class="text-gray-500 text-sm" data-translate="digital_human_video.audio_upload_hint">ç‚¹å‡»æˆ–è€…æ‹–æ‹½éŸ³é¢‘æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ </p>
                            <p class="text-gray-400 text-xs mt-2" data-translate="digital_human_video.audio_format_requirements">æ”¯æŒMP3æ ¼å¼ï¼Œâ‰¤50MBï¼Œæ—¶é•¿æ— ç‰¹åˆ«é™åˆ¶</p>
                            <input type="file" id="audio-upload" accept="audio/mp3,audio/mpeg" class="hidden" />
                            <button onclick="document.getElementById('audio-upload').click()" class="mt-4 px-4 py-2 bg-indigo-50 text-indigo-600 text-sm font-medium rounded-md hover:bg-indigo-100 focus:outline-none" data-translate="digital_human_video.upload_audio_btn">ä¸Šä¼ éŸ³é¢‘</button>
                        </div>
                        <div id="audio-preview" class="hidden w-full h-full">
                            <div class="flex flex-col items-center justify-center">
                                <i class="ri-file-music-fill text-5xl text-indigo-500 mb-3"></i>
                                <p id="audio-name" class="text-gray-700 text-center mb-2">audio.mp3</p>
                                <audio id="uploaded-audio" controls class="w-full max-w-xs"></audio>
                            </div>
                        </div>
                        <div class="upload-progress" id="audio-progress"></div>
                    </div>
                    <p class="text-xs text-gray-500" data-translate="digital_human_video.audio_requirements">éŸ³é¢‘è¦æ±‚: æ¸…æ™°çš„äººå£°å½•éŸ³ï¼ŒèƒŒæ™¯å™ªéŸ³å°ï¼Œæ™®é€šè¯/æ–¹è¨€ä¸é™ï¼Œå°½é‡é¿å…æ··æœ‰æ˜æ˜¾èƒŒæ™¯éŸ³ä¹ã€‚</p>
                </div>


                <!-- äººè„¸å‚è€ƒå›¾ï¼ˆå¯é€‰ï¼‰ -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold" data-translate="digital_human_video.face_reference_title">äººè„¸å‚è€ƒå›¾</h2>
                        <span class="text-xs text-gray-500" data-translate="digital_human_video.optional">é€‰å¡«</span>
                    </div>
                    <div class="preview-container flex items-center justify-center mb-4 relative">
                        <div id="image-placeholder" class="flex flex-col items-center justify-center p-6 text-center">
                            <i class="ri-user-line text-5xl text-gray-300 mb-2"></i>
                            <p class="text-gray-500 text-sm" data-translate="digital_human_video.image_upload_hint">ç‚¹å‡»æˆ–è€…æ‹–æ‹½äººè„¸å›¾ç‰‡åˆ°è¿™é‡Œä¸Šä¼ </p>
                            <p class="text-gray-400 text-xs mt-2" data-translate="digital_human_video.image_format_requirements">æ”¯æŒJPEGã€PNGç­‰æ ¼å¼ï¼Œâ‰¤10MB</p>
                            <input type="file" id="image-upload" accept="image/jpeg,image/png,image/bmp,image/webp" class="hidden" />
                            <button onclick="document.getElementById('image-upload').click()" class="mt-4 px-4 py-2 bg-indigo-50 text-indigo-600 text-sm font-medium rounded-md hover:bg-indigo-100 focus:outline-none" data-translate="digital_human_video.upload_image_btn">ä¸Šä¼ å›¾ç‰‡</button>
                        </div>
                        <div id="image-preview" class="hidden w-full h-full">
                            <img id="uploaded-image" class="w-full h-full object-contain" alt="äººè„¸å‚è€ƒå›¾" />
                        </div>
                        <div class="upload-progress" id="image-progress"></div>
                    </div>
                    <p class="text-xs text-gray-500" data-translate="digital_human_video.face_reference_description">ç”¨äºæŒ‡å®šè§†é¢‘ä¸­çš„å“ªä¸ªäººç‰©è¿›è¡Œå£å‹åˆæˆï¼Œå¦‚ä¸ä¸Šä¼ å°†è‡ªåŠ¨é€‰æ‹©ä¸»è¦äººç‰©ã€‚</p>
                </div>
                
                <!-- é«˜çº§é€‰é¡¹ -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold mb-4" data-translate="digital_human_video.advanced_options_title">é«˜çº§é€‰é¡¹</h2>
                    <div class="flex items-center">
                        <input type="checkbox" id="video-extension" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" />
                        <label for="video-extension" class="ml-2 text-sm text-gray-700" data-translate="digital_human_video.video_extension_label">è§†é¢‘å»¶é•¿æ¨¡å¼ï¼ˆè§†é¢‘ä¼šå»¶é•¿ä»¥åŒ¹é…éŸ³é¢‘æ—¶é•¿ï¼‰</label>
                    </div>
                    <p class="text-xs text-gray-500 mt-2" data-translate="digital_human_video.video_extension_description">å½“éŸ³é¢‘é•¿åº¦è¶…è¿‡è§†é¢‘é•¿åº¦æ—¶ï¼Œè‡ªåŠ¨æ‰©å±•è§†é¢‘æ—¶é•¿ä»¥åŒ¹é…éŸ³é¢‘é•¿åº¦ã€‚</p>
                </div>

                <button id="generate-btn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-md shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed" data-translate="digital_human_video.generate_btn">
                </button>
                
                <!-- æ³•å¾‹åˆè§„æç¤º -->
                <div class="bg-indigo-50 p-4 rounded-lg mt-4">
                    <div class="flex items-start">
                        <i class="ri-information-line text-indigo-600 text-xl mr-2 mt-0.5"></i>
                        <div>
                            <p class="text-xs text-red-500 font-medium" data-translate="digital_human_video.compliance_warning">
                                è¯·ä¸Šä¼ åˆæ³•åˆè§„çš„å›¾ç‰‡è§†é¢‘ï¼Œå¦‚æœ‰è¿åä¼šè¿›è¡Œå°å·å¤„ç†ï¼Œä»»åŠ¡ä¸€æ—¦æäº¤å°±ä¼šæ‰£é™¤ç§¯åˆ†ä¸å¯ä¸­æ–­ï¼Œè¯·å‹¿é‡å¤åˆ·æ–°æäº¤ï¼Œå¦åˆ™ä¼šé€ æˆç§¯åˆ†æµªè´¹ã€‚
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§åŒºåŸŸï¼šæ•ˆæœå±•ç¤ºå’Œè¾“å‡ºè§†é¢‘ -->
        <div class="md:col-span-2 border-l border-gray-200 pl-6">
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold mb-4" data-translate="digital_human_video.preview_title">æ•ˆæœå±•ç¤º</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- æºè§†é¢‘ -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-3" data-translate="digital_human_video.source_video">æºè§†é¢‘:</h3>
                            <div class="preview-container flex items-center justify-center">
                                <div id="source-preview" class="text-center text-gray-500 w-full h-full flex items-center justify-center" data-translate="digital_human_video.source_video_placeholder">ä¸Šä¼ è§†é¢‘åå°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
                            </div>
                        </div>
                        
                        <!-- è¾“å‡ºè§†é¢‘ -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-3" data-translate="digital_human_video.output_video">è¾“å‡ºè§†é¢‘:</h3>
                            <div class="preview-container flex items-center justify-center">
                                <div id="result-preview" class="hidden w-full h-full">
                                    <video id="result-video" class="w-full h-full object-cover" controls></video>
                                </div>
                                <div id="result-placeholder" class="flex flex-col items-center justify-center text-center text-gray-500">
                                    <i class="ri-video-line text-5xl text-gray-300 mb-2"></i>
                                    <p data-translate="digital_human_video.output_video_placeholder">è§†é¢‘ç”Ÿæˆåå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                                    <p class="text-xs mt-1" data-translate="digital_human_video.processing_time">å¤„ç†éœ€è¦3-10åˆ†é’Ÿ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="generation-status" class="mt-4 hidden">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700" data-translate="digital_human_video.processing_progress">å¤„ç†è¿›åº¦</span>
                            <span id="status-text" class="text-sm text-indigo-600" data-translate="digital_human_video.processing">æ­£åœ¨å¤„ç†...</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="result-actions" class="mt-4 hidden">
                        <div class="flex space-x-4">
                            <button id="download-btn" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 focus:outline-none" data-translate="digital_human_video.download_video_btn">
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ä»»åŠ¡åˆ—è¡¨ -->
                <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-semibold" data-translate="digital_human_video.task_list_title">ä»»åŠ¡åˆ—è¡¨</h2>
                            <p class="text-sm text-gray-500 mt-1" data-translate="digital_human_video.task_list_info">ä»…æ˜¾ç¤º24å°æ—¶å†…çš„æœ€æ–°1æ¡ä»»åŠ¡</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="clear-all-tasks-btn" class="text-red-600 hover:text-red-800 text-sm px-3 py-1 border border-red-300 rounded-md" data-translate="digital_human_video.clear_all_btn">
                            </button>
                            <button id="refresh-tasks-btn" class="text-indigo-600 hover:text-indigo-800">
                                <i class="ri-refresh-line text-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div id="tasks-container" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            <p data-translate="digital_human_video.no_tasks">æš‚æ— è§†é¢‘æ•°å­—äººä»»åŠ¡</p>
                            <p class="text-sm mt-2 text-gray-400" data-translate="digital_human_video.no_tasks_hint">ç”Ÿæˆè§†é¢‘åï¼Œä»»åŠ¡å°†åœ¨æ­¤å¤„æ˜¾ç¤º</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-xl font-semibold mb-4" data-translate="digital_human_video.notes_title">æ³¨æ„äº‹é¡¹</h2>
                    <div class="space-y-4">
                        <div>
                            <p class="font-medium text-indigo-700" data-translate="digital_human_video.video_requirements_title">è§†é¢‘è¦æ±‚ï¼š</p>
                            <ul class="space-y-1 mt-1">
                                <li data-translate="digital_human_video.video_file_requirements">â€¢ æ–‡ä»¶é™åˆ¶ï¼šæ”¯æŒmp4ã€aviã€movï¼Œæ–‡ä»¶â‰¤300MBï¼Œ2ç§’ï¼œæ—¶é•¿ï¼œ120ç§’ã€‚</li>
                                <li data-translate="digital_human_video.video_technical_requirements">â€¢ è§†é¢‘é™åˆ¶ï¼š15fpsâ‰¤å¸§ç‡â‰¤60fpsï¼›ç¼–ç é‡‡ç”¨H.264æˆ–H.265ï¼›è¾¹é•¿ä¸ä½äº640ï¼Œä¸å¤§äº2048ã€‚</li>
                                <li data-translate="digital_human_video.video_content_requirements">â€¢ è§†é¢‘å†…å®¹ï¼šè§†é¢‘åº”ä¸ºäººç‰©æ­£é¢å‡ºé•œçš„è¿‘æ™¯ç”»é¢ã€‚é¿å…å¤§è§’åº¦ä¾§è„¸æˆ–äººè„¸è¿‡å°ã€‚</li>
                            </ul>
                        </div>
                        
                        <div>
                            <p class="font-medium text-indigo-700" data-translate="digital_human_video.audio_requirements_title">éŸ³é¢‘è¦æ±‚ï¼š</p>
                            <ul class="space-y-1 mt-1">
                                <li data-translate="digital_human_video.audio_file_requirements">â€¢ æ–‡ä»¶é™åˆ¶ï¼šæ”¯æŒwavã€mp3ã€aacï¼Œæ–‡ä»¶â‰¤30MBï¼Œ2ç§’ï¼œæ—¶é•¿ï¼œ120ç§’ã€‚</li>
                                <li data-translate="digital_human_video.audio_content_requirements">â€¢ éŸ³é¢‘å†…å®¹ï¼šéŸ³é¢‘ä¸­éœ€åŒ…å«æ¸…æ™°ã€å“äº®çš„äººå£°è¯­éŸ³ï¼Œå¹¶å»é™¤äº†ç¯å¢ƒå™ªéŸ³ã€èƒŒæ™¯éŸ³ä¹ç­‰å£°éŸ³å¹²æ‰°ä¿¡æ¯ã€‚</li>
                            </ul>
                        </div>
                        
                        <div>
                            <p class="font-medium text-indigo-700" data-translate="digital_human_video.face_reference_requirements_title">äººç‰©å‚è€ƒå›¾è¦æ±‚ï¼š</p>
                            <ul class="space-y-1 mt-1">
                                <li data-translate="digital_human_video.face_reference_file_requirements">â€¢ æ–‡ä»¶é™åˆ¶ï¼šæ”¯æŒjpegã€jpgã€pngã€bmpã€webpï¼Œæ–‡ä»¶â‰¤10MBã€‚</li>
                                <li data-translate="digital_human_video.face_reference_content_requirements">â€¢ å›¾ç‰‡å†…å®¹ï¼šéœ€åŒ…å«ä¸€å¼ æ¸…æ™°çš„äººç‰©æ­£è„¸ï¼Œä¸”è¯¥äººç‰©å‡ºç°åœ¨è§†é¢‘ç”»é¢ä¸­ã€‚ä¹Ÿå¯ä»è§†é¢‘ç”»é¢ä¸­æˆªå›¾ç”¨ä½œäººç‰©å‚è€ƒå›¾ã€‚</li>
                            </ul>
                        </div>
                        
                        <div>
                            <p class="font-medium text-indigo-700" data-translate="digital_human_video.faq_title">å¸¸è§é—®é¢˜ï¼š</p>
                            <ul class="space-y-1 mt-1">
                                <li data-translate="digital_human_video.faq_audio_video_length">â€¢ è¾“å…¥è¯­éŸ³å’Œè§†é¢‘é•¿åº¦ä¸ä¸€è‡´ï¼Œä¼šå¦‚ä½•å¤„ç†ï¼Ÿ</li>
                                <li class="ml-4 text-sm" data-translate="digital_human_video.faq_audio_video_length_answer1">é»˜è®¤å°†æŒ‰éŸ³é¢‘ã€è§†é¢‘ä¸¤è€…ä¸­æ—¶é•¿è¾ƒçŸ­çš„æ¥æˆªæ–­ã€‚</li>
                                <li class="ml-4 text-sm" data-translate="digital_human_video.faq_audio_video_length_answer2">å½“è¾“å…¥çš„éŸ³é¢‘æ—¶é•¿å¤§äºè§†é¢‘æ—¶é•¿æ—¶ï¼Œå¹¶å¸Œæœ›æŒ‰éŸ³é¢‘é•¿åº¦æ¥ç”Ÿæˆæ—¶ï¼Œå¯å°†å…¥å‚çš„è§†é¢‘æ‰©å±•ï¼ˆparameters.video_extensionï¼‰å€¼è®¾ä¸ºtrueï¼Œç®—æ³•å°†ä½¿ç”¨åŸè§†é¢‘ç”»é¢"å€’æ”¾-æ­£æ”¾"äº¤æ›¿æ¨¡å¼æ‰©å±•è§†é¢‘æ—¶é•¿ï¼Œç›´è‡³ä¸éŸ³é¢‘ç›¸åŒã€‚</li>
                                <li data-translate="digital_human_video.faq_silence">â€¢ è¾“å…¥éŸ³é¢‘ä¸­æœ‰é™éŸ³çš„æƒ…å†µï¼Œä¼šå¦‚ä½•å¤„ç†ï¼Ÿ</li>
                                <li class="ml-4 text-sm" data-translate="digital_human_video.faq_silence_answer">éŸ³é¢‘é™éŸ³çš„æ—¶æ®µï¼Œé¢„æœŸè§†é¢‘ä¸­äººç‰©ä¹Ÿä¼šé—­å˜´ã€‚</li>
                                <li data-translate="digital_human_video.faq_no_face">â€¢ è¾“å…¥è§†é¢‘çš„ç”»é¢ä¸­æœ‰æ— äºº/è„¸æ‹ä¸å…¨çš„æƒ…å†µï¼Œä¼šå¦‚ä½•å¤„ç†ï¼Ÿ</li>
                                <li class="ml-4 text-sm" data-translate="digital_human_video.faq_no_face_answer">è‹¥éŸ³é¢‘ä¸­æœ‰äººå£°ï¼Œä½†ç”»é¢æ— äººæˆ–æœªå‡ºç°äººç‰©å˜´å‹ï¼Œåˆ™ä¿ç•™åŸè§†é¢‘ç”»é¢ï¼ŒéŸ³é¢‘æ­£å¸¸æ’­æ”¾ã€‚</li>
                                <li data-translate="digital_human_video.faq_multiple_people">â€¢ è¾“å…¥è§†é¢‘çš„ç”»é¢ä¸­æœ‰å¤šäººçš„æƒ…å†µï¼Œä¼šå¦‚ä½•å¤„ç†ï¼Ÿ</li>
                                <li class="ml-4 text-sm" data-translate="digital_human_video.faq_multiple_people_answer">ä»…æ”¯æŒæ›¿æ¢ä¸€ä¸ªäººç‰©ã€‚ç®—æ³•ä¼šæŒ‰ç…§è¾“å…¥äººè„¸å‚è€ƒå›¾ï¼ˆinput.ref_image_urlï¼‰ï¼Œè¯†åˆ«æŒ‡å®šäººè„¸ã€‚è‹¥æœªè¾“å…¥äººè„¸å‚è€ƒå›¾ï¼Œåˆ™é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæœ‰äººè„¸ç”»é¢ä¸­ï¼Œå æ¯”æœ€å¤§çš„äººè„¸ã€‚</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ–‡ä»¶ä¸Šä¼ å’Œé¢„è§ˆç›¸å…³å…ƒç´ 
            const videoUpload = document.getElementById('video-upload');
            const audioUpload = document.getElementById('audio-upload');
            const imageUpload = document.getElementById('image-upload');
            
            const videoPreview = document.getElementById('video-preview');
            const audioPreview = document.getElementById('audio-preview');
            const imagePreview = document.getElementById('image-preview');
            
            const videoPlaceholder = document.getElementById('video-placeholder');
            const audioPlaceholder = document.getElementById('audio-placeholder');
            const imagePlaceholder = document.getElementById('image-placeholder');
            
            const uploadedVideo = document.getElementById('uploaded-video');
            const uploadedAudio = document.getElementById('uploaded-audio');
            const uploadedImage = document.getElementById('uploaded-image');
            const audioName = document.getElementById('audio-name');
            
            const sourcePreview = document.getElementById('source-preview');
            
            const generateBtn = document.getElementById('generate-btn');
            const resultPreview = document.getElementById('result-preview');
            const resultPlaceholder = document.getElementById('result-placeholder');
            const resultVideo = document.getElementById('result-video');
            
            const generationStatus = document.getElementById('generation-status');
            const statusText = document.getElementById('status-text');
            const progressBar = document.getElementById('progress-bar');
            const resultActions = document.getElementById('result-actions');
            const downloadBtn = document.getElementById('download-btn');
            
            // ä¸Šä¼ è¿›åº¦æ¡
            const videoProgress = document.getElementById('video-progress');
            const audioProgress = document.getElementById('audio-progress');
            const imageProgress = document.getElementById('image-progress');
            
            // é«˜çº§é€‰é¡¹
            const videoExtension = document.getElementById('video-extension');
            
            // æ–‡ä»¶å­˜å‚¨ä¿¡æ¯
            let uploadedFiles = {
                video: null,
                audio: null,
                image: null,
                videoDuration: null,  // ä¿å­˜è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰
                audioDuration: null   // ä¿å­˜éŸ³é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰
            };
            
            // ğŸ¯ æ£€æŸ¥éŸ³é¢‘å’Œè§†é¢‘æ—¶é•¿å·®å¼‚çš„å‡½æ•°ï¼ˆå·²ç¦ç”¨æç¤ºæ¡†æ˜¾ç¤ºï¼‰
            function checkDurationMismatch() {
                // ä¸æ˜¾ç¤ºä»»ä½•æç¤ºæ¡†
                return;
            }
            
            
            // ğŸ¯ è£å‰ªéŸ³é¢‘åˆ°æŒ‡å®šæ—¶é•¿ï¼ˆä½¿ç”¨Web Audio APIï¼‰
            async function trimAudioToLength(audioFile, targetDuration) {
                return new Promise((resolve, reject) => {
                    console.log(`å¼€å§‹è£å‰ªéŸ³é¢‘: åŸå§‹æ—¶é•¿ ${uploadedFiles.audioDuration}ç§’ â†’ ç›®æ ‡æ—¶é•¿ ${targetDuration}ç§’`);
                    
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const reader = new FileReader();
                    
                    reader.onload = async function(e) {
                        try {
                            // è§£ç éŸ³é¢‘æ•°æ®
                            const audioBuffer = await audioContext.decodeAudioData(e.target.result);
                            
                            // è®¡ç®—éœ€è¦è£å‰ªçš„é‡‡æ ·æ•°
                            const sampleRate = audioBuffer.sampleRate;
                            const targetSamples = Math.floor(targetDuration * sampleRate);
                            const actualSamples = Math.min(targetSamples, audioBuffer.length);
                            
                            // åˆ›å»ºæ–°çš„éŸ³é¢‘ç¼“å†²åŒº
                            const trimmedBuffer = audioContext.createBuffer(
                                audioBuffer.numberOfChannels,
                                actualSamples,
                                sampleRate
                            );
                            
                            // å¤åˆ¶éŸ³é¢‘æ•°æ®åˆ°æ–°ç¼“å†²åŒºï¼ˆåªå¤åˆ¶å‰Nç§’ï¼‰
                            for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
                                const sourceData = audioBuffer.getChannelData(channel);
                                const targetData = trimmedBuffer.getChannelData(channel);
                                for (let i = 0; i < actualSamples; i++) {
                                    targetData[i] = sourceData[i];
                                }
                            }
                            
                            // å°†ç¼“å†²åŒºè½¬æ¢ä¸ºWAVæ ¼å¼çš„Blob
                            const trimmedBlob = audioBufferToWav(trimmedBuffer);
                            
                            // åˆ›å»ºæ–°çš„Fileå¯¹è±¡ï¼Œä¿æŒåŸå§‹æ–‡ä»¶å
                            const trimmedFile = new File(
                                [trimmedBlob], 
                                audioFile.name.replace(/\.[^/.]+$/, '') + '_trimmed.wav',
                                { type: 'audio/wav' }
                            );
                            
                            console.log(`âœ… éŸ³é¢‘è£å‰ªå®Œæˆ: ${targetDuration}ç§’ï¼Œæ–‡ä»¶å¤§å° ${(trimmedFile.size / 1024 / 1024).toFixed(2)}MB`);
                            
                            // å…³é—­éŸ³é¢‘ä¸Šä¸‹æ–‡
                            audioContext.close();
                            
                            resolve(trimmedFile);
                        } catch (error) {
                            console.error('éŸ³é¢‘è£å‰ªå¤±è´¥:', error);
                            audioContext.close();
                            reject(error);
                        }
                    };
                    
                    reader.onerror = function(error) {
                        console.error('è¯»å–éŸ³é¢‘æ–‡ä»¶å¤±è´¥:', error);
                        reject(error);
                    };
                    
                    reader.readAsArrayBuffer(audioFile);
                });
            }
            
            // ğŸ¯ å°†AudioBufferè½¬æ¢ä¸ºWAVæ ¼å¼çš„Blob
            function audioBufferToWav(buffer) {
                const numberOfChannels = buffer.numberOfChannels;
                const sampleRate = buffer.sampleRate;
                const format = 1; // PCM
                const bitDepth = 16;
                
                const bytesPerSample = bitDepth / 8;
                const blockAlign = numberOfChannels * bytesPerSample;
                
                const data = interleave(buffer);
                const dataLength = data.length * bytesPerSample;
                const headerLength = 44;
                const totalLength = headerLength + dataLength;
                
                const arrayBuffer = new ArrayBuffer(totalLength);
                const view = new DataView(arrayBuffer);
                
                // å†™å…¥WAVæ–‡ä»¶å¤´
                writeString(view, 0, 'RIFF');
                view.setUint32(4, totalLength - 8, true);
                writeString(view, 8, 'WAVE');
                writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true); // fmt chunk size
                view.setUint16(20, format, true);
                view.setUint16(22, numberOfChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * blockAlign, true);
                view.setUint16(32, blockAlign, true);
                view.setUint16(34, bitDepth, true);
                writeString(view, 36, 'data');
                view.setUint32(40, dataLength, true);
                
                // å†™å…¥éŸ³é¢‘æ•°æ®
                floatTo16BitPCM(view, 44, data);
                
                return new Blob([arrayBuffer], { type: 'audio/wav' });
            }
            
            function interleave(buffer) {
                const numberOfChannels = buffer.numberOfChannels;
                const length = buffer.length * numberOfChannels;
                const result = new Float32Array(length);
                
                let offset = 0;
                for (let i = 0; i < buffer.length; i++) {
                    for (let channel = 0; channel < numberOfChannels; channel++) {
                        result[offset++] = buffer.getChannelData(channel)[i];
                    }
                }
                
                return result;
            }
            
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
            
            function floatTo16BitPCM(view, offset, input) {
                for (let i = 0; i < input.length; i++, offset += 2) {
                    const s = Math.max(-1, Math.min(1, input[i]));
                    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
                }
            }
            
            // ä»»åŠ¡ID - ç”¨äºçŠ¶æ€æŸ¥è¯¢
            let taskId = null;
            let statusCheckInterval = null;
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkLoginStatus();
            
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            function checkLoginStatus() {
                const token = localStorage.getItem('authToken');
                
                if (!token) {
                    // ç”¨æˆ·æœªç™»å½•
                    // æ·»åŠ ç™»å½•é“¾æ¥
                    const headerDiv = document.querySelector('header .flex.items-center.space-x-4');
                    
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ äº†ç™»å½•æŒ‰é’®
                    if (!document.getElementById('login-btn')) {
                        const loginLink = document.createElement('a');
                        loginLink.href = '/login.html';
                        loginLink.className = 'text-indigo-600 hover:text-indigo-800 text-sm font-medium';
                        loginLink.id = 'login-btn';
                        loginLink.textContent = 'ç™»å½•';
                        headerDiv.appendChild(loginLink);
                    }
                }
            }
            
            // æ£€æŸ¥ç”ŸæˆæŒ‰é’®çŠ¶æ€
            function checkGenerateButtonState() {
                generateBtn.disabled = !(uploadedFiles.video && uploadedFiles.audio);
            }
            
            // å¤„ç†è§†é¢‘ä¸Šä¼ 
            videoUpload.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    if (!file.type.match('video/mp4')) {
                        alert('è¯·ä¸Šä¼ MP4æ ¼å¼çš„è§†é¢‘æ–‡ä»¶ï¼Œè§†é¢‘æ•°å­—äººåŠŸèƒ½ä»…æ”¯æŒè¯¥æ ¼å¼');
                        return;
                    }
                    
                    // æ£€æŸ¥æ–‡ä»¶å¤§å° (300MB = 300 * 1024 * 1024 bytes)
                    if (file.size > 300 * 1024 * 1024) {
                        alert('è§†é¢‘æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡300MB');
                        return;
                    }
                    
                    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦æ¡
                    showProgress(videoProgress);
                    
                    // é¢„è§ˆè§†é¢‘
                    const url = URL.createObjectURL(file);
                    uploadedVideo.src = url;
                    videoPreview.classList.remove('hidden');
                    videoPlaceholder.classList.add('hidden');
                    
                    // æ›´æ–°å³ä¾§é¢„è§ˆ
                    // æ›´æ–°å³ä¾§é¢„è§ˆåŒºåŸŸï¼Œä½¿ç”¨object-fit: containç¡®ä¿è§†é¢‘å®Œæ•´æ˜¾ç¤º
                    sourcePreview.innerHTML = `<video src="${url}" class="w-full h-full object-contain" controls></video>`;
                    
                    // å­˜å‚¨æ–‡ä»¶ä¿¡æ¯
                    uploadedFiles.video = file;
                    hideProgress(videoProgress);
                    
                    // åŠ è½½è§†é¢‘å…ƒæ•°æ®
                    uploadedVideo.onloadedmetadata = function() {
                        // ä¿å­˜è§†é¢‘æ—¶é•¿
                        uploadedFiles.videoDuration = uploadedVideo.duration;
                        console.log('âœ… è§†é¢‘æ—¶é•¿:', uploadedFiles.videoDuration, 'ç§’');
                        
                        // æ£€æŸ¥è§†é¢‘æ—¶é•¿ (ç§’)
                        if (uploadedVideo.duration < 2 || uploadedVideo.duration > 120) {
                            alert('è§†é¢‘æ—¶é•¿å¿…é¡»åœ¨2-120ç§’ä¹‹é—´ï¼Œè¯·é‡æ–°é€‰æ‹©ç¬¦åˆè¦æ±‚çš„è§†é¢‘');
                            videoPreview.classList.add('hidden');
                            videoPlaceholder.classList.remove('hidden');
                            uploadedFiles.video = null;
                            uploadedFiles.videoDuration = null;
                            checkGenerateButtonState();
                            return;
                        }
                        
                        // ğŸ¯ æ£€æŸ¥éŸ³é¢‘å’Œè§†é¢‘æ—¶é•¿å·®å¼‚
                        checkDurationMismatch();
                        
                        checkGenerateButtonState();
                    };
                }
            });
            
            // å¤„ç†éŸ³é¢‘ä¸Šä¼ 
            audioUpload.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    if (!file.type.match('audio/wav|audio/mp3|audio/mpeg')) {
                        alert('è¯·ä¸Šä¼ WAVæˆ–MP3æ ¼å¼çš„éŸ³é¢‘æ–‡ä»¶ï¼Œè§†é¢‘æ•°å­—äººåŠŸèƒ½ä»…æ”¯æŒè¿™äº›æ ¼å¼');
                        return;
                    }
                    
                    // æ£€æŸ¥æ–‡ä»¶å¤§å° (30MB = 30 * 1024 * 1024 bytes)
                    if (file.size > 30 * 1024 * 1024) {
                        alert('éŸ³é¢‘æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡30MB');
                        return;
                    }
                    
                    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦æ¡
                    showProgress(audioProgress);
                    
                    // é¢„è§ˆéŸ³é¢‘
                    const url = URL.createObjectURL(file);
                    uploadedAudio.src = url;
                    audioPreview.classList.remove('hidden');
                    audioPlaceholder.classList.add('hidden');
                    audioName.textContent = file.name;
                    
                    // å­˜å‚¨æ–‡ä»¶ä¿¡æ¯
                    uploadedFiles.audio = file;
                    hideProgress(audioProgress);
                    
                    // åŠ è½½éŸ³é¢‘å…ƒæ•°æ®
                    uploadedAudio.onloadedmetadata = function() {
                        // ä¿å­˜éŸ³é¢‘æ—¶é•¿
                        uploadedFiles.audioDuration = uploadedAudio.duration;
                        console.log('âœ… éŸ³é¢‘æ—¶é•¿:', uploadedFiles.audioDuration, 'ç§’');
                        
                        // æ£€æŸ¥éŸ³é¢‘æ—¶é•¿ (ç§’)
                        if (uploadedAudio.duration < 2 || uploadedAudio.duration > 120) {
                            alert('éŸ³é¢‘æ—¶é•¿å¿…é¡»åœ¨2-120ç§’ä¹‹é—´ï¼Œè¯·é‡æ–°é€‰æ‹©ç¬¦åˆè¦æ±‚çš„éŸ³é¢‘');
                            audioPreview.classList.add('hidden');
                            audioPlaceholder.classList.remove('hidden');
                            uploadedFiles.audio = null;
                            uploadedFiles.audioDuration = null;
                            checkGenerateButtonState();
                            return;
                        }
                        
                        // ğŸ¯ æ£€æŸ¥éŸ³é¢‘å’Œè§†é¢‘æ—¶é•¿å·®å¼‚
                        checkDurationMismatch();
                        
                        checkGenerateButtonState();
                    };
                }
            });
            
            // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
            imageUpload.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    
                    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                    if (!file.type.match('image/jpeg|image/png|image/bmp|image/webp')) {
                        alert('è¯·ä¸Šä¼ JPEGã€PNGã€BMPæˆ–WEBPæ ¼å¼çš„å›¾ç‰‡æ–‡ä»¶');
                        return;
                    }
                    
                    // æ£€æŸ¥æ–‡ä»¶å¤§å° (10MB = 10 * 1024 * 1024 bytes)
                    if (file.size > 10 * 1024 * 1024) {
                        alert('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                        return;
                    }
                    
                    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦æ¡
                    showProgress(imageProgress);
                    
                    // é¢„è§ˆå›¾ç‰‡
                    const url = URL.createObjectURL(file);
                    uploadedImage.src = url;
                    imagePreview.classList.remove('hidden');
                    imagePlaceholder.classList.add('hidden');
                    
                    // å­˜å‚¨æ–‡ä»¶ä¿¡æ¯
                    uploadedFiles.image = file;
                    hideProgress(imageProgress);
                }
            });
            
            // ç›‘å¬è§†é¢‘å»¶é•¿é€‰é¡¹çš„å˜åŒ–
            videoExtension.addEventListener('change', function() {
                checkDurationMismatch();
            });
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            function showProgress(progressElement) {
                progressElement.style.width = '100%';
            }
            
            // éšè—è¿›åº¦æ¡
            function hideProgress(progressElement) {
                progressElement.style.width = '0%';
            }
            
            // ç”ŸæˆæŒ‰é’®å¤„ç†
            generateBtn.addEventListener('click', async function() {
                if (!uploadedFiles.video || !uploadedFiles.audio) {
                    alert('è¯·ä¸Šä¼ äººç‰©è§†é¢‘å’ŒéŸ³é¢‘æ–‡ä»¶ä»¥ç”Ÿæˆè§†é¢‘æ•°å­—äºº');
                    return;
                }
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
                const token = localStorage.getItem('authToken');
                if (!token) {
                    if (confirm('ä½¿ç”¨è§†é¢‘æ•°å­—äººåŠŸèƒ½éœ€è¦å…ˆç™»å½•ï¼Œæ˜¯å¦å‰å¾€ç™»å½•é¡µé¢ï¼Ÿ')) {
                        window.location.href = '/login.html';
                    }
                    return;
                }
                
                // é¢„ä¼°è§†é¢‘æ—¶é•¿ï¼ˆå‡è®¾10ç§’ï¼Œå®é™…ä¼šæ ¹æ®ä¸Šä¼ çš„è§†é¢‘è°ƒæ•´ï¼‰
                const estimatedDuration = 10;
                
                try {
                    // å…ˆæ£€æŸ¥ç”¨æˆ·ç§¯åˆ†å’Œæƒé™
                    const checkResponse = await fetch('/api/check-feature-access', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            featureName: 'DIGITAL_HUMAN_VIDEO',
                            duration: estimatedDuration
                        })
                    });
                    
                    if (!checkResponse.ok && checkResponse.status === 402) {
                        // ç§¯åˆ†ä¸è¶³ï¼Œæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                        const errorData = await checkResponse.json();
                        let errorMessage = 'ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆè§†é¢‘æ•°å­—äººï¼\n\n';
                        errorMessage += `æ‰€éœ€ç§¯åˆ†: ${errorData.requiredCredits || estimatedDuration * 9}ç§¯åˆ†\n`;
                        errorMessage += `å½“å‰ä½™é¢: ${errorData.currentCredits || 0}ç§¯åˆ†\n`;
                        errorMessage += `ç¼ºå°‘ç§¯åˆ†: ${errorData.shortfall || 'N/A'}ç§¯åˆ†\n\n`;
                        errorMessage += 'è¯·å‰å¾€ç§¯åˆ†å……å€¼é¡µé¢å……å€¼åå†è¯•ã€‚';
                        
                        if (confirm(errorMessage + '\n\næ˜¯å¦å‰å¾€ç§¯åˆ†å……å€¼é¡µé¢ï¼Ÿ')) {
                            window.location.href = '/credits.html';
                        }
                        return;
                    } else if (!checkResponse.ok) {
                        const errorData = await checkResponse.json();
                        alert('æƒé™æ£€æŸ¥å¤±è´¥: ' + (errorData.message || 'æœªçŸ¥é”™è¯¯'));
                        return;
                    }
                    
                    console.log('ç§¯åˆ†æ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹ç”Ÿæˆè§†é¢‘æ•°å­—äºº');
                    
                } catch (error) {
                    console.error('ç§¯åˆ†æ£€æŸ¥å¤±è´¥:', error);
                    alert('æƒé™æ£€æŸ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    return;
                }
                
                // æ˜¾ç¤ºç”ŸæˆçŠ¶æ€
                generationStatus.classList.remove('hidden');
                resultPlaceholder.classList.add('hidden');
                
                // æ˜¾ç¤ºåŠ è½½é®ç½©
                const loadingOverlay = document.getElementById('loading-overlay');
                const loadingMessage = document.getElementById('loading-message');
                loadingOverlay.classList.remove('hidden');
                loadingMessage.textContent = 'è§†é¢‘æ•°å­—äººç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...';
                
                // ç¦ç”¨ç”ŸæˆæŒ‰é’®
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="ri-loader-4-line animate-spin mr-2"></i>ç”Ÿæˆä¸­...';
                
                // è°ƒç”¨APIä¸Šä¼ æ–‡ä»¶
                uploadFiles();
            });
            
            // ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
            async function uploadFiles() {
                try {
                    updateProgress(translate('digital_human_video.preparing_upload'), 10);
                    const loadingMessage = document.getElementById('loading-message');
                    loadingMessage.textContent = translate('digital_human_video.preparing_upload');
                    
                    // ğŸ¯ æ£€æŸ¥æ˜¯å¦éœ€è¦è£å‰ªéŸ³é¢‘
                    let audioToUpload = uploadedFiles.audio;
                    const isExtensionEnabled = videoExtension.checked;
                    
                    // å¦‚æœæœªå¯ç”¨å»¶é•¿æ¨¡å¼ï¼Œä¸”éŸ³é¢‘é•¿äºè§†é¢‘ï¼Œè‡ªåŠ¨è£å‰ªéŸ³é¢‘
                    if (!isExtensionEnabled && 
                        uploadedFiles.audioDuration && 
                        uploadedFiles.videoDuration && 
                        uploadedFiles.audioDuration > uploadedFiles.videoDuration + 0.5) {
                        
                        console.log('ğŸ¯ æ£€æµ‹åˆ°éŸ³é¢‘éœ€è¦è£å‰ª');
                        loadingMessage.textContent = 'æ­£åœ¨è£å‰ªéŸ³é¢‘åˆ°è§†é¢‘é•¿åº¦...';
                        updateProgress('æ­£åœ¨è£å‰ªéŸ³é¢‘...', 15);
                        
                        try {
                            // è£å‰ªéŸ³é¢‘åˆ°è§†é¢‘é•¿åº¦
                            audioToUpload = await trimAudioToLength(uploadedFiles.audio, uploadedFiles.videoDuration);
                            console.log('âœ… éŸ³é¢‘è£å‰ªæˆåŠŸï¼Œç»§ç»­ä¸Šä¼ ');
                            
                            // æ›´æ–°éŸ³é¢‘æ—¶é•¿è®°å½•
                            uploadedFiles.audioDuration = uploadedFiles.videoDuration;
                        } catch (trimError) {
                            console.error('âš ï¸ éŸ³é¢‘è£å‰ªå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹éŸ³é¢‘:', trimError);
                            // å¦‚æœè£å‰ªå¤±è´¥ï¼Œä»ä½¿ç”¨åŸéŸ³é¢‘ï¼ˆé™çº§å¤„ç†ï¼‰
                            alert('éŸ³é¢‘è£å‰ªå¤±è´¥ï¼Œå°†ä½¿ç”¨åŸå§‹éŸ³é¢‘ã€‚å¯èƒ½å¯¼è‡´è§†é¢‘æ—¶é•¿ä¸é¢„æœŸä¸ç¬¦ã€‚');
                        }
                    }
                    
                    // åˆ›å»ºFormDataå¯¹è±¡
                    const formData = new FormData();
                    formData.append('video', uploadedFiles.video);
                    formData.append('audio', audioToUpload);  // ä½¿ç”¨è£å‰ªåçš„éŸ³é¢‘ï¼ˆæˆ–åŸéŸ³é¢‘ï¼‰
                    if (uploadedFiles.image) {
                        formData.append('image', uploadedFiles.image);
                    }
                    formData.append('videoExtension', videoExtension.checked);
                    
                    // âœ… ä¼ é€’è§†é¢‘æ—¶é•¿ç»™åç«¯ï¼ˆç§’ï¼‰
                    if (uploadedFiles.videoDuration) {
                        formData.append('videoDuration', uploadedFiles.videoDuration);
                        console.log('âœ… ä¸Šä¼ è§†é¢‘æ—¶é•¿:', uploadedFiles.videoDuration, 'ç§’');
                    } else {
                        console.warn('âš ï¸ è§†é¢‘æ—¶é•¿æœªçŸ¥ï¼Œåç«¯å°†è‡ªè¡Œæ£€æµ‹');
                    }
                    
                    updateProgress(translate('digital_human_video.uploading'), 30);
                    loadingMessage.textContent = translate('digital_human_video.uploading');
                    
                    // è·å–è®¤è¯Token
                    const token = localStorage.getItem('authToken');
                    if (!token) {
                        throw new Error(translate('digital_human_video.auth_failed'));
                    }
                    
                    // å‘é€è¯·æ±‚
                    const response = await fetch('/api/digital-human/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData,
                        credentials: 'same-origin'  // ç¡®ä¿å‘é€cookies
                    });
                    
                    // æ£€æŸ¥å“åº”çŠ¶æ€
                    if (!response.ok) {
                        const contentType = response.headers.get("content-type");
                        if (contentType && contentType.indexOf("application/json") !== -1) {
                            // å¦‚æœæ˜¯JSONå“åº”ï¼Œè§£æå®ƒ
                            const data = await response.json();
                            throw new Error(data.message || `ä¸Šä¼ å¤±è´¥ (${response.status})`);
                        } else {
                            // å¦‚æœä¸æ˜¯JSONå“åº”ï¼Œä½¿ç”¨çŠ¶æ€æ–‡æœ¬
                            throw new Error(`ä¸Šä¼ å¤±è´¥ (${response.status}): ${response.statusText}`);
                        }
                    }
                    
                    // è§£ææˆåŠŸçš„å“åº”
                    const data = await response.json();
                    
                    // ä¿å­˜ä»»åŠ¡ID
                    taskId = data.taskId;
                    
                    updateProgress('ä»»åŠ¡å·²æäº¤ï¼Œå¼€å§‹å¤„ç†...', 50);
                    loadingMessage.textContent = 'ä»»åŠ¡å·²æäº¤ï¼Œå¼€å§‹å¤„ç†...';
                    
                    // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    checkTaskStatus();
                    
                } catch (error) {
                    console.error('ä¸Šä¼ æ–‡ä»¶å¤±è´¥:', error);
                    updateProgress(translate('digital_human_video.upload_failed') + ': ' + error.message, 0);
                    
                    // éšè—åŠ è½½é®ç½©
                    document.getElementById('loading-overlay').classList.add('hidden');
                    
                    // æ¢å¤ç”ŸæˆæŒ‰é’®
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = translate('digital_human_video.generate_btn');
                    
                    alert(translate('digital_human_video.generation_failed') + ': ' + error.message);
                }
            }
            
            // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
            function checkTaskStatus() {
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                }
                
                statusCheckInterval = setInterval(async () => {
                    try {
                        if (!taskId) {
                            clearInterval(statusCheckInterval);
                            return;
                        }
                        
                        // è·å–è®¤è¯Token
                        const token = localStorage.getItem('authToken');
                        
                        const response = await fetch(`/api/digital-human/task/${taskId}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.message || 'æŸ¥è¯¢å¤±è´¥');
                        }
                        
                        console.log('ä»»åŠ¡çŠ¶æ€:', data);
                        
                        // è·å–åŠ è½½æ¶ˆæ¯å…ƒç´ 
                        const loadingMessage = document.getElementById('loading-message');
                        
                        // æ ¹æ®ä»»åŠ¡çŠ¶æ€æ›´æ–°UI
                        if (data.status === 'SUCCEEDED') {
                            // ä»»åŠ¡å®Œæˆ
                            updateProgress('å¤„ç†å®Œæˆ', 100);
                            loadingMessage.textContent = 'å¤„ç†å®Œæˆ';
                            clearInterval(statusCheckInterval);
                            
                            // éšè—åŠ è½½é®ç½©
                            document.getElementById('loading-overlay').classList.add('hidden');
                            
                            // æ˜¾ç¤ºç»“æœè§†é¢‘
                            try {
                                console.log('è®¾ç½®ç»“æœè§†é¢‘URL:', data.videoUrl);
                                
                                // ä¿å­˜åŸå§‹URLç”¨äºä¸‹è½½
                                resultVideo.setAttribute('data-original-url', data.videoUrl);
                                
                                // ä½¿ç”¨ä»£ç†APIåŠ è½½è§†é¢‘ï¼Œé¿å…CSPé—®é¢˜ - æ·»åŠ direct=trueå‚æ•°è¡¨ç¤ºè¿™æ˜¯é¢„è§ˆè€Œéä¸‹è½½
                                const proxyUrl = `/api/download?url=${encodeURIComponent(data.videoUrl)}&direct=true`;
                                console.log('ä½¿ç”¨ä»£ç†URLåŠ è½½è§†é¢‘:', proxyUrl);
                                
                                // ä½¿ç”¨fetch APIåŠ è½½è§†é¢‘ï¼Œä»¥ä¾¿æ›´å¥½åœ°å¤„ç†é”™è¯¯
                                async function loadVideoWithFetch(url) {
                                    console.log('å°è¯•ä½¿ç”¨fetchåŠ è½½è§†é¢‘:', url);
                                    try {
                                        // å…ˆæ£€æŸ¥è§†é¢‘URLæ˜¯å¦å¯è®¿é—®
                                        const response = await fetch(url, {
                                            method: 'HEAD',
                                            cache: 'no-cache'
                                        });
                                        
                                        if (!response.ok) {
                                            throw new Error(`è§†é¢‘URLå“åº”é”™è¯¯: ${response.status} ${response.statusText}`);
                                        }
                                        
                                        console.log('è§†é¢‘URLæ£€æŸ¥æˆåŠŸï¼Œå¼€å§‹åŠ è½½è§†é¢‘');
                                        resultVideo.src = url;
                                        
                                        // è®¾ç½®åŠ è½½å’Œé”™è¯¯å¤„ç†
                                        resultVideo.onloadeddata = function() {
                                            console.log('è§†é¢‘å·²æˆåŠŸåŠ è½½');
                                            resultPreview.classList.remove('hidden');
                                            resultPlaceholder.classList.add('hidden');
                                        };
                                        
                                        resultVideo.onerror = function(e) {
                                            const errorDetails = e.target && e.target.error ? 
                                                `é”™è¯¯ä»£ç : ${e.target.error.code}, æ¶ˆæ¯: ${e.target.error.message}` : 
                                                'æœªçŸ¥é”™è¯¯';
                                            
                                            console.error('è§†é¢‘åŠ è½½è¯¦ç»†é”™è¯¯:', errorDetails);
                                            console.error('è§†é¢‘URL:', url);
                                            
                                            // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                                            resultPlaceholder.innerHTML = `
                                                <div class="flex flex-col items-center justify-center text-center p-4">
                                                    <i class="ri-error-warning-line text-5xl text-red-500 mb-2"></i>
                                                    <p class="text-red-500">è§†é¢‘é¢„è§ˆåŠ è½½å¤±è´¥</p>
                                                    <p class="text-xs text-gray-500 mt-2">é”™è¯¯è¯¦æƒ…: ${errorDetails}</p>
                                                    <p class="text-sm text-gray-500 mt-2">${translate('digital_human_video.try_direct_download')}</p>
                                                    <button id="retry-load-btn" class="mt-3 px-3 py-1 bg-indigo-100 text-indigo-700 text-sm rounded hover:bg-indigo-200">
                                                        é‡è¯•åŠ è½½
                                                    </button>
                                                </div>
                                            `;
                                            
                                            // æ·»åŠ é‡è¯•æŒ‰é’®äº‹ä»¶
                                            setTimeout(() => {
                                                const retryBtn = document.getElementById('retry-load-btn');
                                                if (retryBtn) {
                                                    retryBtn.addEventListener('click', () => loadVideoWithFetch(url));
                                                }
                                            }, 100);
                                            
                                            resultPlaceholder.classList.remove('hidden');
                                            resultPreview.classList.add('hidden');
                                        };
                                    } catch (error) {
                                        console.error('è§†é¢‘é¢„åŠ è½½æ£€æŸ¥å¤±è´¥:', error);
                                        resultPlaceholder.innerHTML = `
                                            <div class="flex flex-col items-center justify-center text-center p-4">
                                                <i class="ri-error-warning-line text-5xl text-red-500 mb-2"></i>
                                                <p class="text-red-500">è§†é¢‘é¢„è§ˆåŠ è½½å¤±è´¥</p>
                                                <p class="text-xs text-gray-500 mt-2">é”™è¯¯è¯¦æƒ…: ${error.message}</p>
                                                <p class="text-sm text-gray-500 mt-2">è¯·å°è¯•ç›´æ¥ä¸‹è½½è§†é¢‘æŸ¥çœ‹</p>
                                                <button id="retry-load-btn" class="mt-3 px-3 py-1 bg-indigo-100 text-indigo-700 text-sm rounded hover:bg-indigo-200">
                                                    é‡è¯•åŠ è½½
                                                </button>
                                            </div>
                                        `;
                                        
                                        // æ·»åŠ é‡è¯•æŒ‰é’®äº‹ä»¶
                                        setTimeout(() => {
                                            const retryBtn = document.getElementById('retry-load-btn');
                                            if (retryBtn) {
                                                retryBtn.addEventListener('click', () => loadVideoWithFetch(url));
                                            }
                                        }, 100);
                                        
                                        resultPlaceholder.classList.remove('hidden');
                                        resultPreview.classList.add('hidden');
                                    }
                                }
                                
                                loadVideoWithFetch(proxyUrl);
                            } catch (videoErr) {
                                console.error('è®¾ç½®è§†é¢‘æºæ—¶å‡ºé”™:', videoErr);
                                resultPlaceholder.innerHTML = `
                                    <div class="flex flex-col items-center justify-center text-center p-4">
                                        <i class="ri-error-warning-line text-5xl text-red-500 mb-2"></i>
                                        <p class="text-red-500">è§†é¢‘é¢„è§ˆåŠ è½½å¤±è´¥</p>
                                        <p class="text-sm text-gray-500 mt-2">${translate('digital_human_video.can_download_via_button')}</p>
                                    </div>
                                `;
                                resultPlaceholder.classList.remove('hidden');
                            }
                            
                            // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                            resultActions.classList.remove('hidden');
                            
                            // åˆ›å»ºæˆ–æ›´æ–°æ¶ˆè´¹ä¿¡æ¯å…ƒç´ 
                            let costInfoElement = document.getElementById('cost-info');
                            if (!costInfoElement) {
                                costInfoElement = document.createElement('div');
                                costInfoElement.id = 'cost-info';
                                costInfoElement.className = 'mt-4 p-3 bg-indigo-50 rounded-md text-sm';
                                resultActions.insertAdjacentElement('afterend', costInfoElement);
                            }
                            
                            // å…ˆæ˜¾ç¤ºå ä½ä¿¡æ¯
                            costInfoElement.innerHTML = `
                                <div class="flex items-start">
                                    <i class="ri-loader-line animate-spin text-indigo-600 text-lg mr-2 mt-0.5"></i>
                                    <div>
                                        <h3 class="font-medium text-indigo-800">è®¡ç®—è§†é¢‘ä¿¡æ¯ä¸­...</h3>
                                    </div>
                                </div>
                            `;
                            
                            // è·å–è§†é¢‘æ—¶é•¿å’Œè®¡ç®—ç§¯åˆ†æ¶ˆè´¹
                            const updateCreditInfo = () => {
                                // ä¼˜å…ˆä½¿ç”¨APIè¿”å›çš„æ—¶é•¿ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨è§†é¢‘å…ƒæ•°æ®
                                const videoDuration = data.videoDuration || Math.ceil(resultVideo.duration);
                                const creditsUsed = data.creditsUsed || Math.ceil(videoDuration * 9); // é»˜è®¤æŒ‰9ç§¯åˆ†/ç§’è®¡ç®—
                                
                                costInfoElement.innerHTML = `
                                    <div class="flex items-start">
                                        <i class="ri-information-line text-indigo-600 text-lg mr-2 mt-0.5"></i>
                                        <div>
                                            <h3 class="font-medium text-indigo-800">è§†é¢‘ç”Ÿæˆå®Œæˆ</h3>
                                            <p class="text-indigo-700 mt-1">
                                                è§†é¢‘æ—¶é•¿: <strong>${Math.ceil(videoDuration)}ç§’</strong>
                                            </p>
                                            <p class="text-indigo-700">
                                                ç§¯åˆ†æ¶ˆè´¹: <strong>${creditsUsed}ç§¯åˆ†</strong>
                                            </p>
                                        </div>
                                    </div>
                                `;
                                
                                // æ›´æ–°ç”¨æˆ·ç§¯åˆ†æ˜¾ç¤º
                                updateUserCredits();
                                
                                // æ›´æ–°é¡µé¢é¡¶éƒ¨ç§¯åˆ†æ˜¾ç¤º
                                updateHeaderCredits();
                                
                                // ç›´æ¥åˆ·æ–°ç§¯åˆ†ç®¡ç†é¡µé¢ä¸­çš„ç§¯åˆ†æ˜¾ç¤º
                                try {
                                    // å¦‚æœå½“å‰é¡µé¢åœ¨iframeä¸­ï¼Œå°è¯•æ›´æ–°çˆ¶é¡µé¢çš„ç§¯åˆ†æ˜¾ç¤º
                                    if (window.parent && window.parent !== window) {
                                        window.parent.postMessage({
                                            type: 'CREDITS_UPDATED',
                                            credits: data.credits || 'refresh'
                                        }, '*');
                                    }
                                    
                                    // è§¦å‘å…¨å±€äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–å¯èƒ½çš„ç»„ä»¶
                                    const event = new CustomEvent('creditsUpdated', {
                                        detail: { credits: data.credits || 'refresh' }
                                    });
                                    document.dispatchEvent(event);
                                    
                                    console.log('å·²è§¦å‘ç§¯åˆ†æ›´æ–°äº‹ä»¶');
                                } catch (e) {
                                    console.error('è§¦å‘ç§¯åˆ†æ›´æ–°äº‹ä»¶å¤±è´¥:', e);
                                }
                            };
                            
                            // å¦‚æœAPIè¿”å›äº†æ—¶é•¿ï¼Œç›´æ¥ä½¿ç”¨
                            if (data.videoDuration) {
                                updateCreditInfo();
                            } else {
                                // å¦åˆ™ç­‰å¾…è§†é¢‘åŠ è½½å®Œæˆåè·å–æ—¶é•¿
                                resultVideo.onloadedmetadata = updateCreditInfo;
                            }
                            
                            // æ¢å¤ç”ŸæˆæŒ‰é’®
                            generateBtn.disabled = false;
                            generateBtn.innerHTML = translate('digital_human_video.generate_btn');
                            
                            // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨ï¼ˆå»¶è¿Ÿ3ç§’ç¡®ä¿åç«¯å·²å®Œæˆä»»åŠ¡ä¿å­˜ï¼‰
                            setTimeout(() => {
                                console.log('ğŸ”„ è§†é¢‘ç”ŸæˆæˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨...');
                                loadUserTasks();
                            }, 3000); // âœ… å¢åŠ åˆ°3ç§’ï¼Œç¡®ä¿åç«¯æœ‰è¶³å¤Ÿæ—¶é—´å®Œæˆç§¯åˆ†æ‰£é™¤å’Œä»»åŠ¡ä¿å­˜
                            
                        } else if (data.status === 'FAILED') {
                            // ä»»åŠ¡å¤±è´¥
                            updateProgress('å¤„ç†å¤±è´¥: ' + data.message, 0);
                            if (loadingMessage) loadingMessage.textContent = 'å¤„ç†å¤±è´¥: ' + data.message;
                            clearInterval(statusCheckInterval);
                            
                            // éšè—åŠ è½½é®ç½©
                            document.getElementById('loading-overlay').classList.add('hidden');
                            
                            // æ¢å¤ç”ŸæˆæŒ‰é’®
                            generateBtn.disabled = false;
                            generateBtn.innerHTML = translate('digital_human_video.generate_btn');
                            
                            alert(translate('digital_human_video.processing_failed') + ': ' + data.message);
                            
                        } else if (data.status === 'PENDING' || data.status === 'RUNNING') {
                            // ä»»åŠ¡æ­£åœ¨å¤„ç†ä¸­
                            let progress = data.status === 'PENDING' ? 50 : 70;
                            updateProgress(translate('digital_human_video.processing'), progress);
                            if (loadingMessage) loadingMessage.textContent = translate('digital_human_video.processing_please_wait');
                        }
                        
                    } catch (error) {
                        console.error('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                        updateProgress(translate('digital_human_video.status_check_failed'), 0);
                        if (loadingMessage) loadingMessage.textContent = translate('digital_human_video.status_check_failed');
                        
                        // éšè—åŠ è½½é®ç½©
                        document.getElementById('loading-overlay').classList.add('hidden');
                        
                        // æ¢å¤ç”ŸæˆæŒ‰é’®
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = '<i class="ri-magic-line mr-2"></i>ç«‹å³ç”Ÿæˆ';
                        
                        clearInterval(statusCheckInterval);
                    }
                }, 5000); // æ¯5ç§’æŸ¥è¯¢ä¸€æ¬¡
            }
            
            // æ›´æ–°è¿›åº¦
            function updateProgress(text, percent) {
                statusText.textContent = text;
                progressBar.style.width = percent + '%';
            }
            
            // ä¸‹è½½æŒ‰é’®
            downloadBtn.addEventListener('click', function(e) {
                // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œé˜²æ­¢é¡µé¢åˆ·æ–°
                e.preventDefault();
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                
                if (resultVideo.src || resultVideo.getAttribute('data-original-url')) {
                    try {
                        // è·å–åŸå§‹è§†é¢‘URL
                        let originalVideoURL = resultVideo.getAttribute('data-original-url') || resultVideo.src;
                        
                        console.log('å‡†å¤‡ä¸‹è½½è§†é¢‘:', originalVideoURL);
                        
                        // ç›´æ¥ä¸‹è½½åŸå§‹URLï¼Œç¡®ä¿è·å–åˆ°çœŸå®çš„è§†é¢‘æ–‡ä»¶
                        // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè½¬æ¢ä¸ºç»å¯¹è·¯å¾„
                        if (originalVideoURL.startsWith('/')) {
                            originalVideoURL = window.location.origin + originalVideoURL;
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºDashScopeç”Ÿæˆçš„URL (åŒ…å«dashscopeå’Œç­¾åå‚æ•°)
                        const isDashScopeUrl = originalVideoURL.includes('dashscope-result-sh.oss-cn-shanghai.aliyuncs.com') || 
                                              (originalVideoURL.includes('OSSAccessKeyId=') && originalVideoURL.includes('Signature='));
                        
                        if (isDashScopeUrl) {
                            // å¯¹DashScope URLä½¿ç”¨ä»£ç†APIä¸‹è½½ä»¥è§£å†³è·¨åŸŸé—®é¢˜
                            console.log('æ£€æµ‹åˆ°DashScope URLï¼Œä½¿ç”¨ä»£ç†ä¸‹è½½');
                            
                            // ä½¿ç”¨ä»£ç†APIä¸‹è½½ï¼Œé¿å…è·¨åŸŸé—®é¢˜
                            const downloadUrl = `/api/download?url=${encodeURIComponent(originalVideoURL)}&filename=å£°åŠ¨äººåƒè§†é¢‘.mp4`;
                            
                            console.log('ä½¿ç”¨ä»£ç†ä¸‹è½½URL:', downloadUrl);
                            
                            // åˆ›å»ºä¸‹è½½é“¾æ¥å¹¶ç‚¹å‡»
                            const downloadLink = document.createElement('a');
                            downloadLink.href = downloadUrl;
                            downloadLink.download = 'å£°åŠ¨äººåƒè§†é¢‘.mp4';
                            downloadLink.style.display = 'none';
                            
                            // æ·»åŠ åˆ°é¡µé¢å¹¶ç‚¹å‡»
                            document.body.appendChild(downloadLink);
                            downloadLink.click();
                            
                            // çŸ­æš‚å»¶è¿Ÿåç§»é™¤é“¾æ¥
                            setTimeout(() => {
                                document.body.removeChild(downloadLink);
                            }, 1000);
                        } else {
                            // éDashScope URLï¼Œå°è¯•è·å–ç›´æ¥ä¸‹è½½é“¾æ¥
                            fetch(`/api/direct-download?url=${encodeURIComponent(originalVideoURL)}&filename=å£°åŠ¨äººåƒè§†é¢‘.mp4`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success && data.url) {
                                        // ä½¿ç”¨ç›´æ¥OSSä¸‹è½½é“¾æ¥
                                        console.log('è·å–åˆ°OSSç›´æ¥ä¸‹è½½é“¾æ¥ï¼Œæœ‰æ•ˆæœŸ:', data.expiresIn);
                                        
                                        // ä½¿ç”¨ç­¾åURLç›´æ¥ä¸‹è½½
                                        const downloadLink = document.createElement('a');
                                        downloadLink.href = data.url;
                                        downloadLink.download = 'å£°åŠ¨äººåƒè§†é¢‘.mp4';
                                        downloadLink.style.display = 'none';
                                        
                                        // æ·»åŠ åˆ°é¡µé¢å¹¶ç‚¹å‡»
                                        document.body.appendChild(downloadLink);
                                        downloadLink.click();
                                        
                                        // çŸ­æš‚å»¶è¿Ÿåç§»é™¤é“¾æ¥
                                        setTimeout(() => {
                                            document.body.removeChild(downloadLink);
                                        }, 1000);
                                    } else {
                                        throw new Error(data.message || 'è·å–ç›´æ¥ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œå°†ä½¿ç”¨æœåŠ¡å™¨ä»£ç†ä¸‹è½½');
                                    }
                                })
                                .catch(error => {
                                    // ç›´æ¥ä¸‹è½½å¤±è´¥ï¼Œå›é€€åˆ°æœåŠ¡å™¨ä»£ç†æ–¹å¼
                                    console.warn('ç›´æ¥ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨æœåŠ¡å™¨ä»£ç†æ–¹å¼:', error.message);
                                    
                                    // ä½¿ç”¨ä»£ç†APIä¸‹è½½ï¼Œé¿å…è·¨åŸŸé—®é¢˜
                                    const downloadUrl = `/api/download?url=${encodeURIComponent(originalVideoURL)}&filename=å£°åŠ¨äººåƒè§†é¢‘.mp4`;
                                    
                                    console.log('å›é€€åˆ°ä»£ç†ä¸‹è½½URL:', downloadUrl);
                                    
                                    // åˆ›å»ºä¸‹è½½é“¾æ¥å¹¶ç‚¹å‡»
                                    const downloadLink = document.createElement('a');
                                    downloadLink.href = downloadUrl;
                                    downloadLink.download = 'å£°åŠ¨äººåƒè§†é¢‘.mp4';
                                    downloadLink.style.display = 'none';
                                    
                                    // æ·»åŠ åˆ°é¡µé¢å¹¶ç‚¹å‡»
                                    document.body.appendChild(downloadLink);
                                    downloadLink.click();
                                    
                                    // çŸ­æš‚å»¶è¿Ÿåç§»é™¤é“¾æ¥
                                    setTimeout(() => {
                                        document.body.removeChild(downloadLink);
                                    }, 1000);
                                });
                        }
                    } catch (error) {
                        console.error('ä¸‹è½½è§†é¢‘å¤±è´¥:', error);
                        alert(translate('digital_human_video.download_failed') + ': ' + error.message);
                    }
                } else {
                    alert(translate('digital_human_video.no_video_to_download'));
                }
                
                // ç¡®ä¿ä¸ä¼šè§¦å‘è¡¨å•æäº¤æˆ–é¡µé¢è·³è½¬
                return false;
            });
            
            // æ›´æ–°ç”¨æˆ·ç§¯åˆ†æ˜¾ç¤º
            function updateUserCredits() {
                // è·å–ç”¨æˆ·æœ€æ–°ç§¯åˆ†
                fetch('/api/user/credits', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // å¦‚æœé¡µé¢ä¸Šæœ‰æ˜¾ç¤ºç§¯åˆ†çš„å…ƒç´ ï¼Œåˆ™æ›´æ–°å®ƒ
                    const creditsElement = document.getElementById('user-credits');
                    if (creditsElement) {
                        creditsElement.textContent = data.credits;
                    }
                    
                    console.log('ç”¨æˆ·ç§¯åˆ†å·²æ›´æ–°:', data.credits);
                })
                .catch(error => {
                    console.error('è·å–ç”¨æˆ·ç§¯åˆ†å¤±è´¥:', error);
                });
            }
            
            // è®¾ç½®ä»»åŠ¡åˆ—è¡¨äº‹ä»¶ç›‘å¬å™¨
            function setupTaskListEventListeners() {
                const refreshTasksBtn = document.getElementById('refresh-tasks-btn');
                const clearAllTasksBtn = document.getElementById('clear-all-tasks-btn');
                
                if (refreshTasksBtn) {
                    refreshTasksBtn.addEventListener('click', loadUserTasks);
                }
                
                if (clearAllTasksBtn) {
                    clearAllTasksBtn.addEventListener('click', confirmClearAllTasks);
                }
            }
            
            // åŠ è½½ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨
            function loadUserTasks() {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.log('ç”¨æˆ·æœªç™»å½•ï¼Œä¸åŠ è½½ä»»åŠ¡');
                    return;
                }
                
                console.log('ğŸ“‹ å¼€å§‹åŠ è½½è§†é¢‘æ•°å­—äººä»»åŠ¡åˆ—è¡¨...');
                
                fetch('/api/digital-human/tasks', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    console.log('âœ… APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || translate('digital_human_video.get_task_list_failed'));
                        });
                    }
                    return response.json();
                })
                .then(response => {
                    console.log('ğŸ“¦ æ•°å­—äººä»»åŠ¡APIå®Œæ•´å“åº”:', response);
                    console.log('ğŸ“¦ å­˜å‚¨ç±»å‹:', response.storageType);
                    console.log('ğŸ“¦ å“åº”æ¶ˆæ¯:', response.message);
                    
                    // æ£€æŸ¥å“åº”ç»“æ„ï¼Œå¤„ç†ä¸åŒçš„æ•°æ®æ ¼å¼
                    let tasks = [];
                    if (Array.isArray(response)) {
                        // å¦‚æœç›´æ¥è¿”å›æ•°ç»„
                        tasks = response;
                    } else if (response && Array.isArray(response.tasks)) {
                        // å¦‚æœè¿”å›åŒ…å«taskså­—æ®µçš„å¯¹è±¡
                        tasks = response.tasks;
                    } else if (response && response.success && Array.isArray(response.tasks)) {
                        // å¦‚æœè¿”å›æˆåŠŸå“åº”å¯¹è±¡
                        tasks = response.tasks;
                    } else {
                        console.warn('âš ï¸ æ•°å­—äººä»»åŠ¡APIè¿”å›äº†æ„å¤–çš„æ•°æ®æ ¼å¼:', response);
                        tasks = [];
                    }
                    
                    console.log(`âœ… è·å–åˆ° ${tasks.length} ä¸ªæ•°å­—äººä»»åŠ¡`);
                    if (tasks.length > 0) {
                        console.log('ğŸ“‹ ä»»åŠ¡åˆ—è¡¨è¯¦æƒ…:', tasks.map(t => ({
                            id: t.id?.substring(0, 8),
                            status: t.status,
                            createdAt: t.createdAt,
                            hasVideo: !!t.videoUrl
                        })));
                    }
                    renderTaskList(tasks);
                })
                .catch(error => {
                    console.error('âŒ è·å–ä»»åŠ¡åˆ—è¡¨å‡ºé”™:', error);
                    showTaskError(translate('digital_human_video.get_task_list_failed') + ': ' + error.message);
                });
            }
            
            // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
            function renderTaskList(tasks) {
                console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ï¼Œæ”¶åˆ°çš„ä»»åŠ¡:', tasks);
                
                const tasksContainer = document.getElementById('tasks-container');
                if (!tasksContainer) {
                    console.error('âŒ æ‰¾ä¸åˆ° tasks-container å…ƒç´ ');
                    return;
                }
                
                // ç¡®ä¿tasksæ˜¯æ•°ç»„
                if (!Array.isArray(tasks)) {
                    console.error('âŒ renderTaskList: tasksä¸æ˜¯æ•°ç»„:', tasks);
                    tasks = [];
                }
                
                if (tasks.length === 0) {
                    console.log('â„¹ï¸ æ²¡æœ‰ä»»åŠ¡ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€æç¤º');
                    tasksContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p>${translate('digital_human_video.no_tasks')}</p>
                            <p class="text-sm mt-2 text-gray-400">${translate('digital_human_video.no_tasks_hint')}</p>
                        </div>
                    `;
                    return;
                }
                
                // å†æ¬¡ç¡®ä¿tasksæ˜¯æ•°ç»„ï¼Œé˜²æ­¢è¿è¡Œæ—¶é”™è¯¯
                if (!Array.isArray(tasks)) {
                    console.error('âŒ renderTaskList: åœ¨mapä¹‹å‰tasksä¸æ˜¯æ•°ç»„:', tasks);
                    tasksContainer.innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <p>${translate('digital_human_video.data_format_error')}</p>
                        </div>
                    `;
                    return;
                }
                
                // è¿‡æ»¤24å°æ—¶å†…çš„ä»»åŠ¡å¹¶æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œåªå–æœ€æ–°çš„ä¸€æ¡
                const now = new Date();
                const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                
                console.log('â° å½“å‰æ—¶é—´:', now.toLocaleString('zh-CN'));
                console.log('â° 24å°æ—¶å‰æ—¶é—´:', twentyFourHoursAgo.toLocaleString('zh-CN'));
                
                const recentTasks = tasks.filter(task => {
                    if (!task.createdAt) {
                        console.warn('âš ï¸ ä»»åŠ¡ç¼ºå°‘ createdAt å­—æ®µ:', task);
                        return false;
                    }
                    const taskDate = new Date(task.createdAt);
                    const isRecent = taskDate >= twentyFourHoursAgo;
                    console.log(`ğŸ“… ä»»åŠ¡ ${task.id?.substring(0, 8)}: åˆ›å»ºæ—¶é—´ ${taskDate.toLocaleString('zh-CN')}, æ˜¯å¦åœ¨24å°æ—¶å†…: ${isRecent}`);
                    return isRecent;
                }).sort((a, b) => {
                    // æŒ‰åˆ›å»ºæ—¶é—´é™åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });
                
                console.log(`ğŸ“Š ç»Ÿè®¡: åŸå§‹ä»»åŠ¡æ•°=${tasks.length}, 24å°æ—¶å†…ä»»åŠ¡æ•°=${recentTasks.length}`);
                
                // åªæ˜¾ç¤ºæœ€æ–°çš„ä¸€æ¡ä»»åŠ¡
                const displayTasks = recentTasks.slice(0, 1);
                console.log(`âœ… å°†è¦æ˜¾ç¤º ${displayTasks.length} æ¡ä»»åŠ¡`);
                
                if (displayTasks.length === 0) {
                    tasksContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p>æš‚æ— 24å°æ—¶å†…çš„è§†é¢‘æ•°å­—äººä»»åŠ¡</p>
                            <p class="text-sm mt-2 text-gray-400">æœ€è¿‘24å°æ—¶å†…æ²¡æœ‰ç”Ÿæˆè¿‡è§†é¢‘ä»»åŠ¡</p>
                        </div>
                    `;
                    return;
                }
                
                const tasksHtml = displayTasks.map(task => {
                    const createdDate = new Date(task.createdAt);
                    const formattedDate = createdDate.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // æ˜¾ç¤ºAPIè¿”å›çš„å®é™…ç”Ÿæˆè§†é¢‘æ—¶é•¿
                    const duration = task.videoDuration ? `${Math.ceil(task.videoDuration)}ç§’` : 'æœªçŸ¥';
                    const creditCost = task.creditCost || 0;
                    
                    // ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º
                    let statusBadge = '';
                    if (task.status) {
                        let statusClass, statusText;
                        switch (task.status) {
                            case 'PENDING':
                                statusClass = 'bg-yellow-100 text-yellow-800';
                                statusText = 'æ’é˜Ÿä¸­';
                                break;
                            case 'RUNNING':
                                statusClass = 'bg-blue-100 text-blue-800';
                                statusText = 'ç”Ÿæˆä¸­';
                                break;
                            case 'SUCCEEDED':
                                statusClass = 'bg-green-100 text-green-800';
                                statusText = 'å·²å®Œæˆ';
                                break;
                            case 'FAILED':
                                statusClass = 'bg-red-100 text-red-800';
                                statusText = 'å¤±è´¥';
                                break;
                            default:
                                statusClass = 'bg-gray-100 text-gray-800';
                                statusText = 'æœªçŸ¥';
                        }
                        statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>`;
                    }
                    
                    // è§†é¢‘é¢„è§ˆï¼ˆä»…å½“ä»»åŠ¡æˆåŠŸä¸”æœ‰è§†é¢‘URLæ—¶ï¼‰
                    let videoPreview = '';
                    if (task.status === 'SUCCEEDED' && task.videoUrl) {
                        videoPreview = `
                            <div class="mt-3">
                                <video controls class="w-full rounded" style="max-height: 180px">
                                    <source src="/api/download?url=${encodeURIComponent(task.videoUrl)}&direct=true" type="video/mp4">
                                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾
                                </video>
                                <div class="flex justify-end mt-2">
                                    <button onclick="downloadTask('${task.videoUrl}')" class="text-indigo-600 hover:text-indigo-800 text-sm mr-3">
                                        <i class="ri-download-2-line mr-1"></i>ä¸‹è½½
                                    </button>
                                    <button onclick="previewTask('${task.id}', '${task.videoUrl}')" class="text-indigo-600 hover:text-indigo-800 text-sm">
                                        <i class="ri-fullscreen-line mr-1"></i>é¢„è§ˆ
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        // å¯¹äºæœªå®Œæˆçš„ä»»åŠ¡ï¼Œä¸æ˜¾ç¤ºé¢å¤–çš„æŒ‰é’®
                        videoPreview = '';
                    }
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h3 class="font-medium text-gray-900">ä»»åŠ¡ #${task.id.substring(0, 8)}</h3>
                                        ${statusBadge}
                                    </div>
                                    <p class="text-sm text-gray-500">åˆ›å»ºæ—¶é—´: ${formattedDate}</p>
                                    <p class="text-sm text-gray-500">è§†é¢‘æ—¶é•¿: ${duration} | æ¶ˆè€—ç§¯åˆ†: ${creditCost}</p>
                                </div>
                                <div class="flex space-x-2">
                                    ${!task.videoUrl ? `
                                        <span class="text-gray-400 text-sm px-3 py-1 border border-gray-300 rounded-md">
                                            <i class="ri-time-line mr-1"></i>ä»»åŠ¡è¿›è¡Œä¸­...
                                        </span>
                                    ` : ''}
                                    <button onclick="deleteTask('${task.id}')" class="text-red-600 hover:text-red-800 text-sm px-3 py-1 border border-red-300 rounded-md">
                                        <i class="ri-delete-bin-line mr-1"></i>åˆ é™¤ä»»åŠ¡
                                    </button>
                                </div>
                            </div>
                            ${videoPreview}
                        </div>
                    `;
                }).join('');
                
                tasksContainer.innerHTML = tasksHtml;
            }
            
            // é¢„è§ˆä»»åŠ¡è§†é¢‘
            function previewTask(taskId, videoUrl) {
                console.log('é¢„è§ˆä»»åŠ¡è§†é¢‘:', taskId, videoUrl);
                
                // ä½¿ç”¨ä»£ç†APIåŠ è½½è§†é¢‘ï¼Œé¿å…è·¨åŸŸé—®é¢˜
                const proxyUrl = `/api/download?url=${encodeURIComponent(videoUrl)}&direct=true`;
                
                // åœ¨å³ä¾§é¢„è§ˆåŒºåŸŸæ˜¾ç¤ºè§†é¢‘
                const resultPreview = document.getElementById('result-preview');
                const resultPlaceholder = document.getElementById('result-placeholder');
                const resultVideo = document.getElementById('result-video');
                
                if (resultPreview && resultVideo) {
                    resultVideo.src = proxyUrl;
                    resultVideo.setAttribute('data-original-url', videoUrl);
                    resultPreview.classList.remove('hidden');
                    resultPlaceholder.classList.add('hidden');
                    
                    // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                    const resultActions = document.getElementById('result-actions');
                    if (resultActions) {
                        resultActions.classList.remove('hidden');
                    }
                    
                    // æ»šåŠ¨åˆ°é¢„è§ˆåŒºåŸŸ
                    resultPreview.scrollIntoView({ behavior: 'smooth' });
                }
            }
            
            // ä¸‹è½½ä»»åŠ¡è§†é¢‘
            function downloadTask(videoUrl) {
                console.log('ä¸‹è½½ä»»åŠ¡è§†é¢‘:', videoUrl);
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºDashScopeç”Ÿæˆçš„URL
                const isDashScopeUrl = videoUrl.includes('dashscope-result-sh.oss-cn-shanghai.aliyuncs.com') || 
                                      (videoUrl.includes('OSSAccessKeyId=') && videoUrl.includes('Signature='));
                
                if (isDashScopeUrl) {
                    // ä½¿ç”¨ä»£ç†APIä¸‹è½½
                    const downloadUrl = `/api/download?url=${encodeURIComponent(videoUrl)}&filename=è§†é¢‘æ•°å­—äºº.mp4`;
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.href = downloadUrl;
                    downloadLink.download = 'è§†é¢‘æ•°å­—äºº.mp4';
                    downloadLink.style.display = 'none';
                    
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(downloadLink);
                    }, 1000);
                } else {
                    // å°è¯•ç›´æ¥ä¸‹è½½
                    const downloadLink = document.createElement('a');
                    downloadLink.href = videoUrl;
                    downloadLink.download = 'è§†é¢‘æ•°å­—äºº.mp4';
                    downloadLink.style.display = 'none';
                    
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(downloadLink);
                    }, 1000);
                }
            }
            
            // åˆ é™¤å•ä¸ªä»»åŠ¡
            function deleteTask(taskId) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    return;
                }
                
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }
                
                fetch(`/api/digital-human/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('ä»»åŠ¡åˆ é™¤æˆåŠŸ');
                        loadUserTasks(); // é‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤ä»»åŠ¡å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                });
            }
            
            // ç¡®è®¤æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡
            function confirmClearAllTasks() {
                if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰ä»»åŠ¡è®°å½•ï¼Œä¸”ä¸å¯æ’¤é”€ã€‚')) {
                    return;
                }
                
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }
                
                fetch('/api/digital-human/tasks/clear-all', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('æ‰€æœ‰ä»»åŠ¡æ¸…ç©ºæˆåŠŸ');
                        loadUserTasks(); // é‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
                        
                        // æ¸…ç©ºå³ä¾§é¢„è§ˆåŒºåŸŸ
                        const resultPreview = document.getElementById('result-preview');
                        const resultPlaceholder = document.getElementById('result-placeholder');
                        const resultActions = document.getElementById('result-actions');
                        
                        if (resultPreview) resultPreview.classList.add('hidden');
                        if (resultPlaceholder) resultPlaceholder.classList.remove('hidden');
                        if (resultActions) resultActions.classList.add('hidden');
                        
                        alert(`å·²æ¸…ç©º ${data.deletedCount} ä¸ªä»»åŠ¡`);
                    } else {
                        alert('æ¸…ç©ºå¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('æ¸…ç©ºä»»åŠ¡å¤±è´¥:', error);
                    alert('æ¸…ç©ºå¤±è´¥: ' + error.message);
                });
            }
            
            // æ˜¾ç¤ºä»»åŠ¡é”™è¯¯ä¿¡æ¯
            function showTaskError(message) {
                const tasksContainer = document.getElementById('tasks-container');
                if (tasksContainer) {
                    tasksContainer.innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <p>${message}</p>
                        </div>
                    `;
                }
            }
            
            // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿åœ¨HTMLä¸­è°ƒç”¨
            window.previewTask = previewTask;
            window.downloadTask = downloadTask;
            window.deleteTask = deleteTask;
            window.confirmClearAllTasks = confirmClearAllTasks;
            
            // æ›´æ–°é¡µé¢é¡¶éƒ¨ç§¯åˆ†æ˜¾ç¤º
            function updateHeaderCredits() {
                // è·å–ç”¨æˆ·æœ€æ–°ç§¯åˆ†
                fetch('/api/user/credits', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // å°è¯•æ›´æ–°é¡µé¢é¡¶éƒ¨çš„ç§¯åˆ†æ˜¾ç¤º
                    try {
                        // æŸ¥æ‰¾é¡µé¢ä¸Šå¯èƒ½çš„ç§¯åˆ†æ˜¾ç¤ºå…ƒç´ 
                        const headerCreditsElements = document.querySelectorAll('.header-credits, .user-credits, .credits-display');
                        if (headerCreditsElements.length > 0) {
                            headerCreditsElements.forEach(el => {
                                el.textContent = data.credits;
                            });
                            console.log('é¡µé¢é¡¶éƒ¨ç§¯åˆ†å·²æ›´æ–°:', data.credits);
                        }
                        
                        // å‘é€ç§¯åˆ†æ›´æ–°äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–é¡µé¢ï¼ˆç‰¹åˆ«æ˜¯ç§¯åˆ†ç®¡ç†é¡µé¢ï¼‰
                        const creditsUpdateEvent = new CustomEvent('creditsUpdated', { 
                            detail: { credits: data.credits } 
                        });
                        document.dispatchEvent(creditsUpdateEvent);
                        console.log('å·²è§¦å‘ç§¯åˆ†æ›´æ–°äº‹ä»¶:', data.credits);
                        
                        // å¦‚æœé¡µé¢æœ‰iframeï¼Œä¹Ÿå°è¯•é€šçŸ¥çˆ¶é¡µé¢
                        if (window.parent && window.parent !== window) {
                            window.parent.postMessage({
                                type: 'CREDITS_UPDATED',
                                credits: data.credits
                            }, '*');
                            console.log('å·²å‘çˆ¶é¡µé¢å‘é€ç§¯åˆ†æ›´æ–°æ¶ˆæ¯');
                        }
                        
                        // ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ–¹å¼å…±äº«ç§¯åˆ†æ›´æ–°ï¼Œé¿å…æ‰“å¼€æ–°çª—å£
                        try {
                            // å°†æœ€æ–°ç§¯åˆ†ä¿¡æ¯å­˜å‚¨åˆ°localStorage
                            localStorage.setItem('lastCreditsUpdate', JSON.stringify({
                                credits: data.credits,
                                timestamp: Date.now()
                            }));
                            console.log('å·²æ›´æ–°æœ¬åœ°å­˜å‚¨çš„ç§¯åˆ†ä¿¡æ¯');
                        } catch (err) {
                            console.error('æ›´æ–°æœ¬åœ°å­˜å‚¨ç§¯åˆ†ä¿¡æ¯å¤±è´¥:', err);
                        }
                    } catch (err) {
                        console.error('æ›´æ–°é¡µé¢é¡¶éƒ¨ç§¯åˆ†æ˜¾ç¤ºå¤±è´¥:', err);
                    }
                })
                .catch(error => {
                    console.error('è·å–ç”¨æˆ·ç§¯åˆ†å¤±è´¥:', error);
                });
            }
            
            // åˆå§‹åŒ–æ£€æŸ¥ç”ŸæˆæŒ‰é’®çŠ¶æ€
            checkGenerateButtonState();
            
            // åŠ è½½ä»»åŠ¡åˆ—è¡¨
            loadUserTasks();
            
            // è®¾ç½®ä»»åŠ¡åˆ—è¡¨ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
            setupTaskListEventListeners();
        });

        // åŠ è½½å¯¼èˆªæ ç»„ä»¶
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/components/navbar-simple.html');
                const navbarHtml = await response.text();
                document.getElementById('navbar-simple').innerHTML = navbarHtml;
                
                // åŠ è½½ç»„ä»¶è„šæœ¬
                const script = document.createElement('script');
                script.src = '/components/components.js';
                document.head.appendChild(script);
            } catch (error) {
                console.error('Failed to load navbar component:', error);
            }
        });
    </script>
    
    <!-- åŠ è½½ä¸­é®ç½© -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500 mb-4"></div>
                <p id="loading-message" class="text-gray-700 text-center">å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>
        </div>
    </div>

    <!-- æ¸…é™¤å³ä¸‹è§’æç¤ºçš„è„šæœ¬ -->
    <script>
        // ç›‘è§†DOMå˜åŒ–ï¼Œè‡ªåŠ¨ç§»é™¤é¡µé¢å³ä¸‹è§’çš„ä¸‹è½½æç¤º
        (function() {
            // åˆ›å»ºä¸€ä¸ªè§‚å¯Ÿå™¨å®ä¾‹
            const observer = new MutationObserver(function(mutations) {
                // æŸ¥æ‰¾å¹¶ç§»é™¤å³ä¸‹è§’çš„æç¤ºæ¡†
                const toastElements = document.querySelectorAll('.fixed.bottom-4.right-4');
                if (toastElements.length > 0) {
                    toastElements.forEach(el => {
                        // æ£€æŸ¥å…ƒç´ å†…å®¹æ˜¯å¦åŒ…å«"å‡†å¤‡é€šè¿‡ä»£ç†ä¸‹è½½"æˆ–å…¶ä»–ä¸‹è½½ç›¸å…³æ–‡æœ¬
                        if (el.innerText.includes('ä¸‹è½½') || el.innerHTML.includes('download') || 
                            el.innerHTML.includes('ri-download') || el.classList.contains('bg-green-100')) {
                            console.log('å·²è‡ªåŠ¨ç§»é™¤ä¸‹è½½æç¤ºæ¡†');
                            el.remove();
                        }
                    });
                }
            });
            
            // é…ç½®è§‚å¯Ÿé€‰é¡¹
            const config = { 
                childList: true, // è§‚å¯Ÿç›®æ ‡å­èŠ‚ç‚¹çš„å¢å‡
                subtree: true    // è§‚å¯Ÿæ‰€æœ‰åä»£èŠ‚ç‚¹
            };
            
            // å¼€å§‹è§‚å¯Ÿdocument.bodyçš„å˜åŒ–
            observer.observe(document.body, config);
            
            // é¡µé¢åŠ è½½åç«‹å³æ£€æŸ¥ä¸€æ¬¡
            document.addEventListener('DOMContentLoaded', function() {
                const toastElements = document.querySelectorAll('.fixed.bottom-4.right-4');
                if (toastElements.length > 0) {
                    toastElements.forEach(el => {
                        if (el.innerText.includes('ä¸‹è½½') || el.innerHTML.includes('download') || 
                            el.innerHTML.includes('ri-download') || el.classList.contains('bg-green-100')) {
                            console.log('é¡µé¢åŠ è½½åç§»é™¤å·²å­˜åœ¨çš„ä¸‹è½½æç¤ºæ¡†');
                            el.remove();
                        }
                    });
                }
            });
        })();
        
        // ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶ï¼Œç¡®ä¿é¡µé¢æ–‡æœ¬èƒ½å¤Ÿå®æ—¶æ›´æ–°
        window.addEventListener('languageChanged', function() {
            // translations.js ä¼šè‡ªåŠ¨æ›´æ–°é¡µé¢æ–‡æœ¬ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–æ“ä½œ
            console.log('Language changed, page text updated');
        });
    </script>
</body>
</html> 