<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="page.credits_title">ç§¯åˆ†ç®¡ç† - è¤ç«AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="/components/styles.css">
    <!-- PayPal JavaScript SDK å°†åŠ¨æ€åŠ è½½ -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f9fafb;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-control {
            display: block;
            width: 100%;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .form-control:focus {
            color: #495057;
            background-color: #fff;
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .btn-primary {
            color: #fff;
            background-color: #6366f1;
            border-color: #6366f1;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            line-height: 1.5;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .alert {
            position: relative;
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .feature-card {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 1rem;
            background-color: white;
        }
        /* æ·»åŠ æ·¡å…¥æ·¡å‡ºåŠ¨ç”»æ ·å¼ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .animate-fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }
        
        /* ç¡®ä¿å……å€¼è¡¨å•çš„æ˜¾ç¤ºè‡ªç„¶ä¸”ä¸ä¼šæŠ–åŠ¨é¡µé¢ */
        #recharge-form-container.hidden {
            display: none;
        }
        #recharge-form-container {
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }
        #recharge-form-container.animate-fade-in {
            opacity: 1;
        }
        /* å……å€¼é‡‘é¢é€‰é¡¹é€‰ä¸­çŠ¶æ€æ ·å¼ */
        .amount-option.active {
            border-color: #6366f1 !important;
            background-color: rgba(99, 102, 241, 0.05) !important;
            box-shadow: 0 0 0 1px #6366f1;
        }
        /* æ”¯ä»˜æ–¹å¼é€‰ä¸­çŠ¶æ€æ ·å¼ */
        .payment-method.active {
            border-color: #6366f1 !important;
            background-color: rgba(99, 102, 241, 0.05) !important;
        }
        /* æäº¤æŒ‰é’®æ‚¬åœæ•ˆæœ */
        button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }
        /* è‡ªå®šä¹‰é‡‘é¢è¾“å…¥æ¡†èšç„¦æ•ˆæœ */
        #custom-amount:focus {
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
            border-color: #6366f1;
        }
        

    </style>

        <link rel="icon" href="/images/favicon.png" type="image/png">
    <script src="/js/mobile-guard.js"></script>
</head>
<body class="bg-gray-50">
    <!-- å®Œæ•´ç‰ˆå¯¼èˆªæ  -->
    <div id="navbar-full"></div>

    <div class="max-w-4xl mx-auto mt-8 px-4" style="margin-top: 88px;">
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1 class="text-2xl font-bold mb-6" data-translate="page.credits_management">ç§¯åˆ†ç®¡ç†</h1>

            <!-- ç§¯åˆ†æ¦‚è§ˆ -->
            <div class="bg-indigo-50 p-6 rounded-lg mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-700" data-translate="credits.balance">ç§¯åˆ†ä½™é¢</h2>
                        <p class="text-3xl font-bold text-indigo-600 mt-2"><span id="user-credits">0</span> <span data-translate="credits.unit">ç§¯åˆ†</span></p>
                        <p class="text-sm text-gray-500 mt-1"><span data-translate="credits.last_recharge">ä¸Šæ¬¡å……å€¼</span>: <span id="last-recharge-time" data-translate="credits.never_recharged">ä»æœªå……å€¼</span></p>
                    </div>
                    <button id="recharge-btn" class="btn-primary flex items-center">
                        <i class="ri-add-circle-line mr-1"></i>
                        <span data-translate="credits.recharge_button">å……å€¼ç§¯åˆ†</span>
                    </button>
                </div>
            </div>

            <!-- å……å€¼è¡¨å• (é»˜è®¤éšè—) -->
            <div id="recharge-form-container" class="hidden bg-white rounded-lg p-6 mb-8 border border-gray-200">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-medium text-gray-800" data-translate="credits.recharge_title">ç§¯åˆ†å……å€¼</h2>
                    <button type="button" id="cancel-recharge" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>
                <form id="recharge-form" class="space-y-6">
                    <div class="form-group">
                        <label for="amount" class="block text-sm font-medium text-gray-700 mb-3" data-translate="credits.recharge_amount">å……å€¼é‡‘é¢</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <button type="button" class="amount-option group relative overflow-hidden rounded-xl border border-transparent bg-gray-50 hover:bg-indigo-50 hover:border-indigo-100 transition-all py-4 px-3 text-center" data-amount="800">
                                <div class="text-gray-800 font-medium mb-1">Â¥99</div>
                                <div class="text-indigo-600 font-bold">800<span data-translate="credits.unit">ç§¯åˆ†</span></div>
                                <div class="text-xs text-gray-500 mt-1">Â¥0.12/<span data-translate="credits.unit">ç§¯åˆ†</span></div>
                                <div class="absolute inset-0 border-2 border-indigo-500 rounded-xl opacity-0 group-hover:opacity-10 transition-opacity"></div>
                            </button>
                            <button type="button" class="amount-option group relative overflow-hidden rounded-xl border border-transparent bg-gray-50 hover:bg-indigo-50 hover:border-indigo-100 transition-all py-4 px-3 text-center" data-amount="3980">
                                <div class="text-gray-800 font-medium mb-1">Â¥399</div>
                                <div class="text-indigo-600 font-bold">3980<span data-translate="credits.unit">ç§¯åˆ†</span></div>
                                <div class="text-xs text-gray-500 mt-1">Â¥0.10/<span data-translate="credits.unit">ç§¯åˆ†</span></div>
                                <div class="absolute inset-0 border-2 border-indigo-500 rounded-xl opacity-0 group-hover:opacity-10 transition-opacity"></div>
                            </button>
                            <button type="button" class="amount-option group relative overflow-hidden rounded-xl border border-transparent bg-gray-50 hover:bg-indigo-50 hover:border-indigo-100 transition-all py-4 px-3 text-center" data-amount="6730">
                                <div class="text-gray-800 font-medium mb-1">Â¥599</div>
                                <div class="text-indigo-600 font-bold">6730<span data-translate="credits.unit">ç§¯åˆ†</span></div>
                                <div class="text-xs text-gray-500 mt-1">Â¥0.09/<span data-translate="credits.unit">ç§¯åˆ†</span></div>
                                <div class="absolute inset-0 border-2 border-indigo-500 rounded-xl opacity-0 group-hover:opacity-10 transition-opacity"></div>
                            </button>
                            <button type="button" class="amount-option group relative overflow-hidden rounded-xl border border-transparent bg-gray-50 hover:bg-indigo-50 hover:border-indigo-100 transition-all py-4 px-3 text-center" data-amount="12500">
                                <div class="text-gray-800 font-medium mb-1">Â¥999</div>
                                <div class="text-indigo-600 font-bold">12500<span data-translate="credits.unit">ç§¯åˆ†</span></div>
                                <div class="text-xs text-gray-500 mt-1">Â¥0.08/<span data-translate="credits.unit">ç§¯åˆ†</span></div>
                                <div class="absolute inset-0 border-2 border-indigo-500 rounded-xl opacity-0 group-hover:opacity-10 transition-opacity"></div>
                            </button>
                            <button type="button" class="amount-option group relative overflow-hidden rounded-xl border border-transparent bg-gray-50 hover:bg-indigo-50 hover:border-indigo-100 transition-all py-4 px-3 text-center" data-amount="350">
                                <div class="text-gray-800 font-medium mb-1">Â¥59</div>
                                <div class="text-indigo-600 font-bold">350<span data-translate="credits.unit">ç§¯åˆ†</span></div>
                                <div class="text-xs text-gray-500 mt-1">Â¥0.17/<span data-translate="credits.unit">ç§¯åˆ†</span></div>
                                <div class="absolute inset-0 border-2 border-indigo-500 rounded-xl opacity-0 group-hover:opacity-10 transition-opacity"></div>
                            </button>
                        </div>
                        <input type="hidden" id="amount" name="amount" value="">
                    </div>
                    <div class="form-group">
                        <div class="grid grid-cols-2 gap-3">
                            <button type="button" class="payment-method flex items-center justify-center py-3 px-4 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 transition-colors active" data-method="alipay">
                                <i class="ri-alipay-line text-blue-500 text-xl mr-2"></i>
                                <span class="font-medium" data-translate="payment.alipay">æ”¯ä»˜å®</span>
                            </button>
                            <button type="button" class="payment-method flex items-center justify-center py-3 px-4 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 transition-colors" data-method="paypal">
                                <span class="font-medium">PayPal</span>
                            </button>
                        </div>
                        <input type="hidden" id="payment-method" name="paymentMethod" value="alipay">
                    </div>
                    <div class="hidden" id="message-box"></div>
                    <div class="pt-4">
                        <button type="submit" class="w-full py-3 px-6 bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-700 hover:to-indigo-600 text-white font-medium rounded-xl shadow-sm hover:shadow transition-all transform hover:-translate-y-0.5">
                            <span data-translate="credits.confirm_recharge">ç¡®è®¤å……å€¼</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- åŠŸèƒ½ä»·æ ¼åˆ—è¡¨ -->
            <h2 class="text-xl font-semibold mb-4" data-translate="credits.pricing_list">åŠŸèƒ½ä»·æ ¼åˆ—è¡¨</h2>
            <div id="pricing-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- ä»·æ ¼åˆ—è¡¨é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                <div class="animate-pulse">
                    <div class="h-20 bg-gray-200 rounded"></div>
                </div>
                <div class="animate-pulse">
                    <div class="h-20 bg-gray-200 rounded"></div>
                </div>
                <div class="bg-white p-4 rounded shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold" data-translate="feature.video_style_repaint">è§†é¢‘é£æ ¼é‡ç»˜</h3>
                            <p class="text-sm text-gray-500"><span data-translate="credits.free_trial">å…è´¹è¯•ç”¨</span>: 0<span data-translate="credits.times">æ¬¡</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-indigo-600 font-bold">540Pï¼š3<span data-translate="credits.unit">ç§¯åˆ†</span>/<span data-translate="time.second">ç§’</span></p>
                            <p class="text-indigo-600 font-bold">720Pï¼š6<span data-translate="credits.unit">ç§¯åˆ†</span>/<span data-translate="time.second">ç§’</span></p>
                            <p class="text-xs text-gray-500" data-translate="credits.resolution_pricing_note">ä¸åŒåˆ†è¾¨ç‡ä»·æ ¼ä¸åŒï¼ŒæŒ‰å®é™…é€‰æ‹©è®¡è´¹</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- å¤šè¯­è¨€æ”¯æŒè„šæœ¬ -->
    <script src="/translations.js"></script>
    
    <script>
        // å¼‚æ­¥åŠ è½½å®Œæ•´ç‰ˆå¯¼èˆªæ 
        async function loadNavbar() {
            try {
                const response = await fetch('/components/navbar-full.html');
                const html = await response.text();
                document.getElementById('navbar-full').innerHTML = html;
                
                // æ£€æŸ¥ components.js æ˜¯å¦å·²ç»åŠ è½½
                const existingScript = document.querySelector('script[src="/components/components.js"]');
                const isScriptLoaded = existingScript && (typeof initializeComponents === 'function' || typeof window.ComponentsJS !== 'undefined');
                
                // åˆå§‹åŒ–è¯­è¨€é€‰æ‹©å™¨çš„å‡½æ•°
                function initLanguageSelector() {
                    console.log('ğŸ”µ å¼€å§‹åˆå§‹åŒ–è¯­è¨€é€‰æ‹©å™¨...');
                    
                    // å¤šæ¬¡å°è¯•åˆå§‹åŒ–ï¼Œç¡®ä¿navbar HTMLå·²ç»å®Œå…¨æ¸²æŸ“
                    let retryCount = 0;
                    const maxRetries = 10;
                    
                    function tryInitialize() {
                        // æ£€æŸ¥è¯­è¨€é€‰é¡¹æ˜¯å¦å­˜åœ¨
                        const languageOptions = document.querySelectorAll('.language-option');
                        
                        if (languageOptions.length > 0) {
                            // è¯­è¨€é€‰é¡¹å·²å­˜åœ¨ï¼Œå¯ä»¥åˆå§‹åŒ–
                            console.log('ğŸ”µ æ‰¾åˆ°è¯­è¨€é€‰é¡¹ï¼Œå¼€å§‹åˆå§‹åŒ–è¯­è¨€é€‰æ‹©å™¨...');
                            
                            // ä½¿ç”¨ translations.js ä¸­çš„ initializeTranslations å‡½æ•°
                            if (typeof initializeTranslations === 'function') {
                                console.log('ğŸ”µ è°ƒç”¨ initializeTranslations å‡½æ•°...');
                                initializeTranslations();
                                
                                // ç¡®ä¿å¯¼èˆªæ æ–‡æœ¬ä¹Ÿè¢«ç¿»è¯‘
                                if (typeof updatePageText === 'function') {
                                    console.log('ğŸ”µ æ›´æ–°å¯¼èˆªæ æ–‡æœ¬...');
                                    updatePageText();
                                }
                                
                                console.log('âœ… è¯­è¨€é€‰æ‹©å™¨åˆå§‹åŒ–å®Œæˆ');
                            } else {
                                // å¦‚æœ initializeTranslations ä¸å­˜åœ¨ï¼Œæ‰‹åŠ¨åˆå§‹åŒ–
                                console.log('âš ï¸ initializeTranslations å‡½æ•°æœªæ‰¾åˆ°ï¼Œæ‰‹åŠ¨åˆå§‹åŒ–...');
                                languageOptions.forEach(option => {
                                    const lang = option.getAttribute('data-lang');
                                    if (lang === (localStorage.getItem('language') || 'zh')) {
                                        option.classList.add('active', 'bg-purple-50', 'text-purple-600');
                                    }
                                    
                                    // ç¡®ä¿é€‰é¡¹å¯ä»¥æ¥æ”¶ç‚¹å‡»äº‹ä»¶
                                    option.style.pointerEvents = 'auto';
                                    option.style.cursor = 'pointer';
                                    
                                    // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé€šè¿‡å…‹éš†èŠ‚ç‚¹ï¼‰
                                    const newOption = option.cloneNode(true);
                                    option.parentNode.replaceChild(newOption, option);
                                    
                                    // ç»‘å®šç‚¹å‡»äº‹ä»¶
                                    newOption.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        
                                        const selectedLanguage = this.getAttribute('data-lang');
                                        console.log('ğŸ”„ ç”¨æˆ·é€‰æ‹©äº†æ–°è¯­è¨€:', selectedLanguage);
                                        
                                        if (!selectedLanguage) {
                                            console.error('âŒ è¯­è¨€é€‰é¡¹æ²¡æœ‰data-langå±æ€§');
                                            return;
                                        }
                                        
                                        // ä½¿ç”¨ translations.js ä¸­çš„ switchLanguage å‡½æ•°
                                        if (typeof switchLanguage === 'function') {
                                            switchLanguage(selectedLanguage);
                                            console.log('âœ… è¯­è¨€åˆ‡æ¢å®Œæˆ');
                                        } else {
                                            console.error('âŒ switchLanguage å‡½æ•°æœªæ‰¾åˆ°');
                                        }
                                    });
                                });
                                
                                // æ‰‹åŠ¨æ›´æ–°å¯¼èˆªæ æ–‡æœ¬
                                if (typeof updatePageText === 'function') {
                                    console.log('ğŸ”µ æ‰‹åŠ¨æ›´æ–°å¯¼èˆªæ æ–‡æœ¬...');
                                    updatePageText();
                                }
                                
                                console.log('âœ… æ‰‹åŠ¨åˆå§‹åŒ–è¯­è¨€é€‰æ‹©å™¨å®Œæˆ');
                            }
                        } else if (retryCount < maxRetries) {
                            // è¯­è¨€é€‰é¡¹è¿˜æœªåŠ è½½ï¼Œç»§ç»­é‡è¯•
                            retryCount++;
                            console.log(`âš ï¸ è¯­è¨€é€‰é¡¹æœªæ‰¾åˆ°ï¼Œ${100 * retryCount}msåé‡è¯• (${retryCount}/${maxRetries})`);
                            setTimeout(tryInitialize, 100 * retryCount);
                        } else {
                            console.error('âŒ è¯­è¨€é€‰é¡¹æœªæ‰¾åˆ°ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
                        }
                    }
                    
                    // å¼€å§‹å°è¯•åˆå§‹åŒ–
                    setTimeout(tryInitialize, 200);
                }
                
                // ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶ï¼Œæ›´æ–°å¯¼èˆªæ 
                window.addEventListener('languageChanged', function(event) {
                    console.log('ğŸ”„ æ£€æµ‹åˆ°è¯­è¨€å˜åŒ–äº‹ä»¶ï¼Œæ›´æ–°å¯¼èˆªæ æ–‡æœ¬...');
                    if (typeof updatePageText === 'function') {
                        updatePageText();
                        console.log('âœ… å¯¼èˆªæ æ–‡æœ¬å·²æ›´æ–°');
                    }
                });
                
                if (isScriptLoaded) {
                    console.log('âœ… components.js å·²ç»åŠ è½½ï¼Œç›´æ¥åˆå§‹åŒ–è¯­è¨€é€‰æ‹©å™¨');
                    initLanguageSelector();
                } else {
                    // åŠ è½½å¯¼èˆªæ çš„JavaScriptåŠŸèƒ½
                    const script = document.createElement('script');
                    script.src = '/components/components.js';
                    
                    // ç­‰å¾…è„šæœ¬åŠ è½½å®Œæˆåå†åˆå§‹åŒ–
                    script.onload = function() {
                        console.log('âœ… components.js åŠ è½½å®Œæˆ');
                        initLanguageSelector();
                    };
                    
                    script.onerror = function() {
                        console.error('âŒ åŠ è½½ components.js å¤±è´¥');
                    };
                    
                    document.head.appendChild(script);
                }
            } catch (error) {
                console.error('åŠ è½½å¯¼èˆªæ å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', loadNavbar);
    </script>

    <script>
        // å…¨å±€å˜é‡
        let userCredits = 0;
        let featurePricing = [];
        const messageBox = document.getElementById('message-box');
        let paypalSDKLoaded = false; // PayPal SDKåŠ è½½çŠ¶æ€
        
        // åŠ¨æ€åŠ è½½PayPal SDK
        async function loadPayPalSDK() {
            try {
                // ä»åç«¯è·å–PayPalé…ç½®
                const response = await fetch('/api/credits/paypal/config');
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    if (response.status === 404) {
                        console.error('PayPalé…ç½®æ¥å£ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è·¯ç”±é…ç½®');
                    } else if (response.status === 503) {
                        console.warn('PayPalæœåŠ¡æœªé…ç½®ï¼ŒPayPalæ”¯ä»˜åŠŸèƒ½å°†ä¸å¯ç”¨');
                    } else {
                        console.error('è·å–PayPalé…ç½®å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
                    }
                    paypalSDKLoaded = false;
                    return;
                }
                
                const data = await response.json();
                
                if (data.success && data.data && data.data.clientId) {
                    const clientId = data.data.clientId;
                    
                    // åŠ¨æ€åˆ›å»ºPayPal SDKè„šæœ¬
                    const script = document.createElement('script');
                    script.src = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=USD&components=buttons`;
                    script.async = true;
                    script.onload = function() {
                        paypalSDKLoaded = true;
                        console.log('PayPal SDKåŠ è½½æˆåŠŸ');
                    };
                    script.onerror = function() {
                        console.error('PayPal SDKåŠ è½½å¤±è´¥');
                        paypalSDKLoaded = false;
                    };
                    document.head.appendChild(script);
                } else {
                    console.warn('PayPalæœåŠ¡æœªé…ç½®ï¼ŒPayPalæ”¯ä»˜åŠŸèƒ½å°†ä¸å¯ç”¨');
                    paypalSDKLoaded = false;
                }
            } catch (error) {
                console.error('åŠ è½½PayPalé…ç½®å¤±è´¥:', error);
                if (error.message && error.message.includes('404')) {
                    console.error('PayPalé…ç½®æ¥å£è¿”å›404ï¼Œè¯·æ£€æŸ¥ï¼š1. æœåŠ¡å™¨æ˜¯å¦é‡å¯ 2. è·¯ç”±æ˜¯å¦æ­£ç¡®æ³¨å†Œ');
                }
                paypalSDKLoaded = false;
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'success') {
            messageBox.innerHTML = `<div class="alert ${type === 'success' ? 'alert-success' : 'alert-danger'}">${message}</div>`;
            messageBox.classList.remove('hidden');
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        function checkAuth() {
            const authToken = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('user');
            
            if (!authToken || !userInfo) {
                // ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = '/login.html';
                return false;
            }
            
            try {
                JSON.parse(userInfo);
                return true;
            } catch (e) {
                console.error('è§£æç”¨æˆ·ä¿¡æ¯å‡ºé”™:', e);
                // æ¸…é™¤æ— æ•ˆçš„å­˜å‚¨
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
                return false;
            }
        }
        
        // åŠ è½½ç”¨æˆ·ç§¯åˆ†ä¿¡æ¯
        async function loadCreditsInfo() {
            try {
                // ç›´æ¥ä»ç”¨æˆ·APIè·å–æœ€æ–°ç§¯åˆ†ï¼Œè€Œä¸æ˜¯ä»credits APIè·å–
                const response = await fetch('/api/user/credits', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // æ›´æ–°ç”¨æˆ·ç§¯åˆ†ä¿¡æ¯
                    userCredits = data.credits;
                    document.getElementById('user-credits').textContent = userCredits;
                    
                    console.log('ç§¯åˆ†ç®¡ç†é¡µé¢ï¼šå·²æ›´æ–°ç§¯åˆ†ä¸º', userCredits);
                    
                    // è·å–ä¸Šæ¬¡å……å€¼æ—¶é—´ï¼ˆä»ç„¶éœ€è¦ä»credits APIè·å–ï¼‰
                    try {
                        const creditsResponse = await fetch('/api/credits', {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                            }
                        });
                        
                        if (creditsResponse.ok) {
                            const creditsData = await creditsResponse.json();
                            
                            if (creditsData.success && creditsData.data && creditsData.data.user) {
                                // æ›´æ–°ä¸Šæ¬¡å……å€¼æ—¶é—´
                                const lastRechargeTime = creditsData.data.user.lastRechargeTime;
                                if (lastRechargeTime) {
                                    const date = new Date(lastRechargeTime);
                                    document.getElementById('last-recharge-time').textContent = date.toLocaleString('zh-CN');
                                }
                            }
                        }
                    } catch (err) {
                        console.error('è·å–å……å€¼æ—¶é—´å¤±è´¥:', err);
                    }
                } else {
                    const error = await response.json();
                    showMessage(error.message || 'è·å–ç§¯åˆ†ä¿¡æ¯å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½ç§¯åˆ†ä¿¡æ¯å‡ºé”™:', error);
                showMessage('åŠ è½½ç§¯åˆ†ä¿¡æ¯å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
        }
        
        // åŠ è½½åŠŸèƒ½ä»·æ ¼åˆ—è¡¨
        async function loadPricing() {
            try {
                const response = await fetch('/api/credits/pricing');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.data.pricing) {
                        featurePricing = data.data.pricing;
                        renderPricingList();
                    }
                } else {
                    const error = await response.json();
                    console.error('è·å–ä»·æ ¼åˆ—è¡¨å¤±è´¥:', error);
                }
            } catch (error) {
                console.error('åŠ è½½ä»·æ ¼åˆ—è¡¨å‡ºé”™:', error);
            }
        }
        
        // åŠŸèƒ½åç§°æœ¬åœ°åŒ– - ä½¿ç”¨ç¿»è¯‘å¯¹è±¡
        function formatFeatureName(name) {
            // è·å–å½“å‰è¯­è¨€
            const currentLang = localStorage.getItem('language') || 'zh';
            
            // åŠŸèƒ½åç§°åˆ°ç¿»è¯‘é”®çš„æ˜ å°„
            const featureNameMap = {
                'image-upscaler': 'feature.image_upscaling',
                'marketing-images': 'feature.marketing_image',
                'cutout': 'feature.smart_cutout',
                'translate': 'feature.image_translation',
                'scene-generator': 'feature.scene_generator',
                'image-removal': 'feature.smart_removal',
                'model-skin-changer': 'feature.model_skin_change',
                'clothing-simulation': 'feature.virtual_try_on',
                'text-to-video': 'text-to-video',
                'image-to-video': 'image-to-video',
                'IMAGE_EDIT': 'feature.instruction_editing',
                'LOCAL_REDRAW': 'feature.local_redraw',
                'IMAGE_COLORIZATION': 'feature.image_colorization',
                'image-expansion': 'feature.smart_expansion',
                'VIRTUAL_SHOE_MODEL': 'VIRTUAL_SHOE_MODEL',
                'TEXT_TO_IMAGE': 'feature.text_to_image',
                'IMAGE_SHARPENING': 'feature.blur_to_clear',
                'CLOTH_SEGMENTATION': 'feature.smart_clothing_segmentation',
                'GLOBAL_STYLE': 'feature.global_stylization',
                'VIRTUAL_MODEL_VTON': 'VIRTUAL_MODEL_VTON',
                'VIDEO_SUBTITLE_REMOVER': 'VIDEO_SUBTITLE_REMOVER',
                'MULTI_IMAGE_TO_VIDEO': 'MULTI_IMAGE_TO_VIDEO',
                'DIGITAL_HUMAN_VIDEO': 'DIGITAL_HUMAN_VIDEO',
                'VIDEO_STYLE_REPAINT': 'feature.video_style_repaint',
                'DIANTU': 'feature.padding_image',
                'IMAGE_RESIZE': 'IMAGE_RESIZE',
                'IMAGE_CROP': 'IMAGE_CROP',
                'amazon_video_script': 'amazon_video_script',
                'product_improvement_analysis': 'product_improvement_analysis',
                'amazon_brand_info': 'amazon_brand_info',
                'amazon_brand_naming': 'amazon_brand_naming',
                'amazon_listing': 'amazon_listing',
                'amazon_search_term': 'amazon_search_term',
                'amazon_review_analysis': 'amazon_review_analysis',
                'amazon_consumer_insights': 'amazon_consumer_insights',
                'amazon_customer_email': 'amazon_customer_email',
                'fba_claim_email': 'fba_claim_email',
                'amazon_review_generator': 'amazon_review_generator',
                'amazon_review_response': 'amazon_review_response',
                'product_comparison': 'product_comparison',
                'amazon_post_creator': 'amazon_post_creator',
                'amazon_keyword_recommender': 'amazon_keyword_recommender',
                'amazon_case_creator': 'amazon_case_creator',
                'QWEN_IMAGE_EDIT': 'QWEN_IMAGE_EDIT',
                'VIDEO_FACE_SWAP': 'VIDEO_FACE_SWAP',
                'VIDEO_LOGO_REMOVAL': 'VIDEO_LOGO_REMOVAL'
            };
            
            // è·å–ç¿»è¯‘é”®
            const translationKey = featureNameMap[name];
            
            // å¦‚æœå­˜åœ¨ç¿»è¯‘é”®ï¼Œå°è¯•ä»ç¿»è¯‘å¯¹è±¡è·å–
            if (translationKey && typeof translations !== 'undefined' && translations[currentLang] && translations[currentLang][translationKey]) {
                return translations[currentLang][translationKey];
            }
            
            // å¦‚æœæ²¡æœ‰ç¿»è¯‘ï¼Œä½¿ç”¨ä¸­æ–‡é»˜è®¤å€¼
            const defaultNames = {
                'image-upscaler': 'å›¾åƒé«˜æ¸…æ”¾å¤§',
                'marketing-images': 'AIè¥é”€å›¾ç”Ÿæˆ',
                'cutout': 'å•†å“æ¢èƒŒæ™¯',
                'translate': 'å›¾ç‰‡ç¿»è¯‘',
                'scene-generator': 'åœºæ™¯å›¾ç”Ÿæˆ',
                'image-removal': 'å›¾åƒæ™ºèƒ½æ¶ˆé™¤',
                'model-skin-changer': 'æ¨¡ç‰¹æ¢è‚¤',
                'clothing-simulation': 'æ¨¡æ‹Ÿè¯•è¡£',
                'text-to-video': 'æ–‡ç”Ÿè§†é¢‘',
                'image-to-video': 'å›¾ç”Ÿè§†é¢‘',
                'IMAGE_EDIT': 'æŒ‡ä»¤ç¼–è¾‘',
                'LOCAL_REDRAW': 'å±€éƒ¨é‡ç»˜',
                'IMAGE_COLORIZATION': 'å›¾åƒä¸Šè‰²',
                'image-expansion': 'æ™ºèƒ½æ‰©å›¾',
                'VIRTUAL_SHOE_MODEL': 'é‹é´è™šæ‹Ÿè¯•ç©¿',
                'TEXT_TO_IMAGE': 'æ–‡ç”Ÿå›¾ç‰‡',
                'IMAGE_SHARPENING': 'æ¨¡ç³Šå›¾ç‰‡å˜æ¸…æ™°',
                'CLOTH_SEGMENTATION': 'æ™ºèƒ½æœé¥°åˆ†å‰²',
                'GLOBAL_STYLE': 'å…¨å±€é£æ ¼åŒ–',
                'VIRTUAL_MODEL_VTON': 'æ™ºèƒ½è™šæ‹Ÿæ¨¡ç‰¹è¯•ç©¿',
                'VIDEO_SUBTITLE_REMOVER': 'è§†é¢‘å»é™¤å­—å¹•',
                'MULTI_IMAGE_TO_VIDEO': 'å¤šå›¾è½¬è§†é¢‘',
                'DIGITAL_HUMAN_VIDEO': 'è§†é¢‘æ•°å­—äºº',
                'VIDEO_STYLE_REPAINT': 'è§†é¢‘é£æ ¼é‡ç»˜',
                'DIANTU': 'å«å›¾',
                'IMAGE_RESIZE': 'å›¾ç‰‡æ”¹å°ºå¯¸',
                'IMAGE_CROP': 'å›¾åƒè£å‰ª',
                'amazon_video_script': 'äºšé©¬é€Šå¹¿å‘Šè§†é¢‘è„šæœ¬ç”Ÿæˆ',
                'product_improvement_analysis': 'é€‰å“çš„æ”¹æ¬¾åˆ†æå’Œå»ºè®®',
                'amazon_brand_info': 'å“ç‰Œä¿¡æ¯æ”¶é›†å’Œæ€»ç»“',
                'amazon_brand_naming': 'äºšé©¬é€Šå“ç‰Œèµ·å',
                'amazon_listing': 'äºšé©¬é€ŠListingå†™ä½œä¸ä¼˜åŒ–',
                'amazon_search_term': 'äºšé©¬é€Šåå°æœç´¢è¯',
                'amazon_review_analysis': 'äºšé©¬é€Šå®¢æˆ·è¯„è®ºåˆ†æ',
                'amazon_consumer_insights': 'äºšé©¬é€Šæ¶ˆè´¹è€…æ´å¯Ÿä¸“å®¶',
                'amazon_customer_email': 'äºšé©¬é€Šå®¢æˆ·é‚®ä»¶å›å¤',
                'fba_claim_email': 'FBAç´¢èµ”é‚®ä»¶',
                'amazon_review_generator': 'äºšé©¬é€Šè¯„è®ºç”Ÿæˆ',
                'amazon_review_response': 'äºšé©¬é€Šè¯„è®ºå›å¤',
                'product_comparison': 'äº§å“å¯¹æ¯”',
                'amazon_post_creator': 'åˆ›å»ºäºšé©¬é€ŠPost',
                'amazon_keyword_recommender': 'äºšé©¬é€Šå…³é”®è¯æ¨è',
                'amazon_case_creator': 'äºšé©¬é€Šå®¢æœcaseå†…å®¹',
                'QWEN_IMAGE_EDIT': 'å›¾åƒç¼–è¾‘',
                'VIDEO_FACE_SWAP': 'è§†é¢‘æ¢äºº',
                'VIDEO_LOGO_REMOVAL': 'è§†é¢‘å»æ°´å°/logo',
                'VIDEO_FACE_FUSION': 'è§†é¢‘æ¢è„¸'
            };
            
            return defaultNames[name] || name;
        }
        
        // è·å–ç¿»è¯‘æ–‡æœ¬çš„è¾…åŠ©å‡½æ•°
        function getTranslationText(key, defaultText) {
            const currentLang = localStorage.getItem('language') || 'zh';
            if (typeof translations !== 'undefined' && translations[currentLang] && translations[currentLang][key]) {
                return translations[currentLang][key];
            }
            return defaultText;
        }
        
        // æ¸²æŸ“ä»·æ ¼åˆ—è¡¨
        function renderPricingList() {
            const pricingList = document.getElementById('pricing-list');
            const currentLang = localStorage.getItem('language') || 'zh';
            
            if (featurePricing.length === 0) {
                const noPriceText = currentLang === 'en' ? 'No pricing information' : 'æš‚æ— ä»·æ ¼ä¿¡æ¯';
                pricingList.innerHTML = `<p class="text-gray-500">${noPriceText}</p>`;
                return;
            }
            
            pricingList.innerHTML = '';
            
            // è·å–ç¿»è¯‘æ–‡æœ¬
            const unlimitedText = getTranslationText('credits.unlimited', 'æ— é™åˆ¶');
            const freeTrialText = getTranslationText('credits.free_trial', 'å…è´¹è¯•ç”¨');
            const timesText = getTranslationText('credits.times', 'æ¬¡');
            const creditsText = getTranslationText('credits.unit', 'ç§¯åˆ†');
            const secondText = getTranslationText('time.second', 'ç§’');
            const perTimeText = currentLang === 'en' ? 'per time' : '/æ¬¡';
            const perSecondText = currentLang === 'en' ? 'per second' : '/ç§’';
            const lessThan30SecText = currentLang === 'en' ? 'Less than 30 seconds counted as 30 seconds' : 'ä¸æ»¡30ç§’æŒ‰30ç§’è®¡ç®—';
            const videoDurationText = currentLang === 'en' ? 'Charged by video duration, rounded up' : 'æŒ‰è§†é¢‘æ—¶é•¿è®¡è´¹ï¼Œå‘ä¸Šå–æ•´';
            const standardModeText = currentLang === 'en' ? 'Standard Mode' : 'æ ‡å‡†æ¨¡å¼';
            const proModeText = currentLang === 'en' ? 'Pro Mode' : 'ä¸“ä¸šæ¨¡å¼';
            
            featurePricing.forEach(feature => {
                // è·³è¿‡ VIDEO_STYLE_REPAINTï¼ˆå•ç‹¬å¤„ç†ï¼‰
                if (feature.name === 'VIDEO_STYLE_REPAINT') return;
                // åŠŸèƒ½åç§°æœ¬åœ°åŒ–
                const localName = formatFeatureName(feature.name);
                
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded shadow-sm border border-gray-200';

                // æ ¹æ®åŠŸèƒ½ç±»å‹æä¾›ä¸åŒçš„æ˜¾ç¤ºæ ¼å¼
                if (feature.name === 'VIDEO_SUBTITLE_REMOVER' || feature.name === 'MULTI_IMAGE_TO_VIDEO') {
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${localName}</h3>
                                <p class="text-sm text-gray-500">${feature.freeUsage >= 999999 ? unlimitedText : `${freeTrialText}: ${feature.freeUsage}${timesText}`}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-indigo-600 font-bold">30 ${creditsText}/30${secondText}</p>
                                <p class="text-xs text-gray-500">${lessThan30SecText}</p>
                            </div>
                        </div>
                    `;
                } else if (feature.name === 'VIDEO_LOGO_REMOVAL') {
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${localName}</h3>
                                <p class="text-sm text-gray-500">${feature.freeUsage >= 999999 ? unlimitedText : `${freeTrialText}: ${feature.freeUsage}${timesText}`}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-indigo-600 font-bold">5 ${creditsText}/30${secondText}</p>
                                <p class="text-xs text-gray-500">${lessThan30SecText}</p>
                            </div>
                        </div>
                    `;
                } else if (feature.name === 'DIGITAL_HUMAN_VIDEO') {
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${localName}</h3>
                                <p class="text-sm text-gray-500">${feature.freeUsage >= 999999 ? unlimitedText : `${freeTrialText}: ${feature.freeUsage}${timesText}`}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-indigo-600 font-bold">9 ${creditsText}${perSecondText}</p>
                            </div>
                        </div>
                    `;
                } else if (feature.name === 'VIRTUAL_MODEL_VTON') {
                    const modelVton10Text = currentLang === 'en' ? 'Model vton1.0' : 'æ¨¡å‹vton1.0';
                    const modelVton15Text = currentLang === 'en' ? 'Model vton1.5' : 'æ¨¡å‹vton1.5';
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${localName}</h3>
                                <p class="text-sm text-gray-500">${feature.freeUsage >= 999999 ? unlimitedText : `${freeTrialText}: ${feature.freeUsage}${timesText}`}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-indigo-600 font-bold">${modelVton10Text}/40${creditsText}</p>
                                <p class="text-indigo-600 font-bold">${modelVton15Text}/45${creditsText}</p>
                            </div>
                        </div>
                    `;
                } else if (feature.name === 'text-to-video' || feature.name === 'image-to-video') {
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${localName}</h3>
                                <p class="text-sm text-gray-500">${feature.freeUsage >= 999999 ? unlimitedText : `${freeTrialText}: ${feature.freeUsage}${timesText}`}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-indigo-600 font-bold">66 ${creditsText}${perTimeText}</p>
                            </div>
                        </div>
                    `;
                } else if (feature.name === 'QWEN_IMAGE_EDIT') {
                    const perImageText = currentLang === 'en' ? 'per image' : '/å¼ ';
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${localName}</h3>
                                <p class="text-sm text-gray-500">${feature.freeUsage >= 999999 ? unlimitedText : `${freeTrialText}: ${feature.freeUsage}${timesText}`}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-indigo-600 font-bold">7 ${creditsText}${perImageText}</p>
                            </div>
                        </div>
                    `;
                } else if (feature.name === 'VIDEO_FACE_SWAP') {
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${localName}</h3>
                                <p class="text-sm text-gray-500">${feature.freeUsage >= 999999 ? unlimitedText : `${freeTrialText}: ${feature.freeUsage}${timesText}`}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-indigo-600 font-bold">${standardModeText}ï¼š8${creditsText}${perSecondText}</p>
                                <p class="text-indigo-600 font-bold">${proModeText}ï¼š10${creditsText}${perSecondText}</p>
                                <p class="text-xs text-gray-500">${videoDurationText}</p>
                            </div>
                        </div>
                    `;
                } else if (feature.name === 'VIDEO_FACE_FUSION') {
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${localName}</h3>
                                <p class="text-sm text-gray-500">${feature.freeUsage >= 999999 ? unlimitedText : `${freeTrialText}: ${feature.freeUsage}${timesText}`}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-indigo-600 font-bold">1 ${creditsText}${perSecondText}</p>
                            </div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${localName}</h3>
                                <p class="text-sm text-gray-500">${feature.freeUsage >= 999999 ? unlimitedText : `${freeTrialText}: ${feature.freeUsage}${timesText}`}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-indigo-600 font-bold">${feature.creditCost} ${creditsText}${perTimeText}</p>
                            </div>
                        </div>
                    `;
                }
                
                pricingList.appendChild(card);
            });
            // åœ¨è¿™é‡Œæ’å…¥"è§†é¢‘é£æ ¼é‡ç»˜"å¡ç‰‡
            const repaintCard = document.createElement('div');
            repaintCard.className = 'bg-white p-4 rounded shadow-sm border border-gray-200';
            const repaintName = formatFeatureName('VIDEO_STYLE_REPAINT');
            repaintCard.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold">${repaintName}</h3>
                        <p class="text-sm text-gray-500">${freeTrialText}: 0${timesText}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-indigo-600 font-bold">540Pï¼š3${creditsText}${perSecondText}</p>
                        <p class="text-indigo-600 font-bold">720Pï¼š6${creditsText}${perSecondText}</p>
                        <p class="text-xs text-gray-500">${getTranslationText('credits.resolution_pricing_note', 'ä¸åŒåˆ†è¾¨ç‡ä»·æ ¼ä¸åŒï¼ŒæŒ‰å®é™…é€‰æ‹©è®¡è´¹')}</p>
                    </div>
                </div>
            `;
            pricingList.appendChild(repaintCard);
        }
        
        // æ£€æŸ¥URLå‚æ•°ï¼Œé¢„å…ˆè®¾ç½®å……å€¼è¡¨å•çŠ¶æ€
        const shouldShowRechargeForm = new URLSearchParams(window.location.search).get('openRecharge') === 'true';
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        

        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            if (!checkAuth()) return;
            
            // åŠ è½½PayPal SDK
            loadPayPalSDK();
            
            // åˆå§‹åŒ–è¯­è¨€åˆ‡æ¢åŠŸèƒ½
            initLanguageSupport();
            
            // åŠ è½½ç”¨æˆ·ç§¯åˆ†ä¿¡æ¯
            loadCreditsInfo();
            
            // åŠ è½½åŠŸèƒ½ä»·æ ¼åˆ—è¡¨
            loadPricing();
            
            
            // åˆå§‹åŒ–å……å€¼è¡¨å•
            initRechargeForm();
            
            // å¦‚æœURLä¸­æœ‰openRecharge=trueï¼Œåˆ™æ˜¾ç¤ºå……å€¼è¡¨å•
            if (shouldShowRechargeForm) {
                // ç­‰å¾…DOMå®Œå…¨åŠ è½½åæ˜¾ç¤ºå……å€¼è¡¨å•
                window.requestAnimationFrame(() => {
                    const rechargeFormContainer = document.getElementById('recharge-form-container');
                    if (rechargeFormContainer) {
                        // ç¡®ä¿è¡¨å•å…ƒç´ å®Œå…¨å¯è§
                        rechargeFormContainer.classList.remove('hidden');
                        
                        // ä½¿ç”¨requestAnimationFrameç¡®ä¿ä¸‹ä¸€å¸§æ·»åŠ åŠ¨ç”»ç±»ï¼Œä»¥è·å¾—å¹³æ»‘è¿‡æ¸¡
                        window.requestAnimationFrame(() => {
                            rechargeFormContainer.classList.add('animate-fade-in');
                        });
                        
                        // ç¡®ä¿é¡µé¢ä¿æŒåœ¨é¡¶éƒ¨
                        window.scrollTo(0, 0);
                        
                        // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªå……å€¼é€‰é¡¹
                        const firstAmountOption = document.querySelector('.amount-option');
                        if (firstAmountOption) {
                            firstAmountOption.click();
                        }
                    }
                });
            }
            
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå½“ç”¨æˆ·åˆ‡æ¢å›é¡µé¢æ—¶åˆ·æ–°ç§¯åˆ†ä¿¡æ¯
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') {
                    console.log('é¡µé¢å˜ä¸ºå¯è§ï¼Œåˆ·æ–°ç§¯åˆ†ä¿¡æ¯');
                    loadCreditsInfo();
                }
            });
            
            // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ï¼Œå½“å…¶ä»–é¡µé¢å‘å‡ºç§¯åˆ†æ›´æ–°äº‹ä»¶æ—¶åˆ·æ–°ç§¯åˆ†ä¿¡æ¯
            document.addEventListener('creditsUpdated', function(event) {
                console.log('æ”¶åˆ°ç§¯åˆ†æ›´æ–°äº‹ä»¶ï¼Œåˆ·æ–°ç§¯åˆ†ä¿¡æ¯', event.detail);
                loadCreditsInfo();
            });
            
            // ç›‘å¬æ¥è‡ªiframeæˆ–å…¶ä»–çª—å£çš„æ¶ˆæ¯
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'CREDITS_UPDATED') {
                    console.log('æ”¶åˆ°ç§¯åˆ†æ›´æ–°æ¶ˆæ¯ï¼Œåˆ·æ–°ç§¯åˆ†ä¿¡æ¯', event.data);
                    // å¦‚æœæ˜¯å¼ºåˆ¶åˆ·æ–°æ¶ˆæ¯ï¼Œç›´æ¥åˆ·æ–°é¡µé¢
                    if (event.data.forceRefresh) {
                        console.log('æ”¶åˆ°å¼ºåˆ¶åˆ·æ–°æŒ‡ä»¤ï¼Œå³å°†åˆ·æ–°é¡µé¢');
                        window.location.reload();
                        return;
                    }
                    loadCreditsInfo();
                }
            });
            
            // ç›‘å¬æœ¬åœ°å­˜å‚¨å˜åŒ–
            window.addEventListener('storage', function(event) {
                if (event.key === 'lastCreditsUpdate') {
                    try {
                        const updateData = JSON.parse(event.newValue);
                        if (updateData && updateData.timestamp) {
                            // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åœ¨30ç§’å†…
                            const now = Date.now();
                            if (now - updateData.timestamp < 30000) { // 30ç§’å†…çš„æ›´æ–°æ‰å¤„ç†
                                console.log('æ£€æµ‹åˆ°ç§¯åˆ†æ›´æ–°ï¼Œåˆ·æ–°ç§¯åˆ†ä¿¡æ¯', updateData);
                                loadCreditsInfo();
                            }
                        }
                    } catch (err) {
                        console.error('è§£æç§¯åˆ†æ›´æ–°æ•°æ®å¤±è´¥:', err);
                    }
                }
            });
            
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ç§¯åˆ†ä¿¡æ¯
            setInterval(() => {
                loadCreditsInfo();
            }, 30000);
        });
        
        // åˆå§‹åŒ–è¯­è¨€æ”¯æŒ
        function initLanguageSupport() {
            // ç­‰å¾… translations.js å’Œ components.js åŠ è½½å®Œæˆ
            const checkComponents = setInterval(() => {
                if (typeof translations !== 'undefined') {
                    clearInterval(checkComponents);
                    
                    // è·å–å½“å‰è¯­è¨€ï¼ˆä» localStorage æˆ– URL å‚æ•°ï¼‰
                    let currentLang = localStorage.getItem('language') || 'zh';
                    
                    // æ£€æŸ¥ URL å‚æ•°ä¸­çš„è¯­è¨€è®¾ç½®
                    const urlParams = new URLSearchParams(window.location.search);
                    const langParam = urlParams.get('lang');
                    if (langParam) {
                        // è½¬æ¢è¯­è¨€æ ¼å¼ï¼šzh-cn -> zh, en-us -> en
                        if (langParam === 'zh-cn') {
                            currentLang = 'zh';
                        } else if (langParam === 'en-us') {
                            currentLang = 'en';
                        }
                        // ä¿å­˜åˆ° localStorage
                        localStorage.setItem('language', currentLang);
                    }
                    
                    // æ›´æ–°é¡µé¢è¯­è¨€å±æ€§
                    document.documentElement.lang = currentLang === 'en' ? 'en' : 'zh-CN';
                    
                    // æ›´æ–° translations.js ä¸­çš„ currentLanguage å˜é‡
                    if (typeof currentLanguage !== 'undefined') {
                        currentLanguage = currentLang;
                    }
                    
                    // æ›´æ–°é¡µé¢æ–‡æœ¬ - ä½¿ç”¨ translations.js ä¸­çš„ updatePageText å‡½æ•°
                    if (typeof updatePageText === 'function') {
                        // translations.js ä¸­çš„ updatePageText ä¸éœ€è¦å‚æ•°ï¼Œå®ƒä¼šè‡ªåŠ¨ä» localStorage è¯»å–è¯­è¨€
                        // ä½†éœ€è¦å…ˆæ›´æ–° currentLanguage å˜é‡
                        if (typeof currentLanguage !== 'undefined') {
                            currentLanguage = currentLang;
                        }
                        updatePageText();
                    } else {
                        // æ‰‹åŠ¨æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-translate å±æ€§çš„å…ƒç´ 
                        const elements = document.querySelectorAll('[data-translate]');
                        elements.forEach(element => {
                            const key = element.getAttribute('data-translate');
                            if (translations[currentLang] && translations[currentLang][key]) {
                                if (element.tagName === 'TITLE') {
                                    document.title = translations[currentLang][key];
                                } else {
                                    element.textContent = translations[currentLang][key];
                                }
                            }
                        });
                    }
                    
                    // æ›´æ–°é¡µé¢æ ‡é¢˜
                    const titleKey = 'page.credits_title';
                    if (translations[currentLang] && translations[currentLang][titleKey]) {
                        document.title = translations[currentLang][titleKey];
                    } else {
                        document.title = currentLang === 'en' ? 'Credits Management - YingHuo AI' : 'ç§¯åˆ†ç®¡ç† - è¤ç«AI';
                    }
                    
                    // ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶
                    document.addEventListener('languageChanged', function(event) {
                        const newLang = event.detail.language;
                        document.documentElement.lang = newLang === 'en' ? 'en' : 'zh-CN';
                        
                        // æ›´æ–° translations.js ä¸­çš„ currentLanguage å˜é‡
                        if (typeof currentLanguage !== 'undefined') {
                            currentLanguage = newLang;
                        }
                        
                        // æ›´æ–°é¡µé¢æ–‡æœ¬
                        if (typeof updatePageText === 'function') {
                            // å…ˆæ›´æ–° currentLanguage å˜é‡
                            if (typeof currentLanguage !== 'undefined') {
                                currentLanguage = newLang;
                            }
                            updatePageText();
                        } else {
                            // æ‰‹åŠ¨æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-translate å±æ€§çš„å…ƒç´ 
                            const elements = document.querySelectorAll('[data-translate]');
                            elements.forEach(element => {
                                const key = element.getAttribute('data-translate');
                                if (translations[newLang] && translations[newLang][key]) {
                                    if (element.tagName === 'TITLE') {
                                        document.title = translations[newLang][key];
                                    } else {
                                        element.textContent = translations[newLang][key];
                                    }
                                }
                            });
                        }
                        
                        // é‡æ–°æ¸²æŸ“ä»·æ ¼åˆ—è¡¨ä»¥åº”ç”¨æ–°è¯­è¨€
                        if (featurePricing.length > 0) {
                            renderPricingList();
                        }
                        
                        // æ›´æ–°é¡µé¢æ ‡é¢˜
                        const titleKey = 'page.credits_title';
                        if (translations[newLang] && translations[newLang][titleKey]) {
                            document.title = translations[newLang][titleKey];
                        } else {
                            document.title = newLang === 'en' ? 'Credits Management - YingHuo AI' : 'ç§¯åˆ†ç®¡ç† - è¤ç«AI';
                        }
                    });
                    
                    console.log('è¯­è¨€æ”¯æŒåˆå§‹åŒ–å®Œæˆï¼Œå½“å‰è¯­è¨€:', currentLang);
                }
            }, 100);
            
            // å¦‚æœ 5 ç§’åä»æœªåŠ è½½å®Œæˆï¼Œåœæ­¢æ£€æŸ¥
            setTimeout(() => {
                clearInterval(checkComponents);
            }, 5000);
        }
        
        // åˆå§‹åŒ–å……å€¼è¡¨å•
        function initRechargeForm() {
            const rechargeBtn = document.getElementById('recharge-btn');
            const rechargeFormContainer = document.getElementById('recharge-form-container');
            const cancelRechargeBtn = document.getElementById('cancel-recharge');
            const rechargeForm = document.getElementById('recharge-form');
            const amountOptions = document.querySelectorAll('.amount-option');
            const amountInput = document.getElementById('amount');
            const paymentMethods = document.querySelectorAll('.payment-method');
            const paymentMethodInput = document.getElementById('payment-method');
            
            // æ˜¾ç¤ºå……å€¼è¡¨å•
            if (rechargeBtn) {
                rechargeBtn.addEventListener('click', function() {
                    rechargeFormContainer.classList.remove('hidden');
                    rechargeFormContainer.classList.add('animate-fade-in');
                    
                    // ç¡®ä¿é¡µé¢ä¿æŒåœ¨é¡¶éƒ¨ï¼Œè¿™æ ·ç”¨æˆ·å¯ä»¥åŒæ—¶çœ‹åˆ°ç§¯åˆ†ä½™é¢å’Œå……å€¼è¡¨å•
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            }
            
            // éšè—å……å€¼è¡¨å•
            if (cancelRechargeBtn) {
                cancelRechargeBtn.addEventListener('click', function() {
                    rechargeFormContainer.classList.add('animate-fade-out');
                    setTimeout(() => {
                        rechargeFormContainer.classList.add('hidden');
                        rechargeFormContainer.classList.remove('animate-fade-out');
                        // é‡ç½®è¡¨å•
                        resetRechargeForm();
                    }, 300);
                });
            }
            
            // é€‰æ‹©å……å€¼é‡‘é¢
            amountOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                    amountOptions.forEach(opt => {
                        opt.classList.remove('bg-indigo-50', 'border-indigo-200');
                        opt.classList.add('bg-gray-50', 'border-transparent');
                    });
                    
                    // æ·»åŠ é€‰ä¸­çŠ¶æ€
                    this.classList.remove('bg-gray-50', 'border-transparent');
                    this.classList.add('bg-indigo-50', 'border-indigo-200');
                    
                    // è®¾ç½®é‡‘é¢
                    const amount = this.getAttribute('data-amount');
                    amountInput.value = amount;
                });
            });
            
            // é€‰æ‹©æ”¯ä»˜æ–¹å¼
            paymentMethods.forEach(method => {
                method.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
                    paymentMethods.forEach(m => m.classList.remove('active', 'border-indigo-500', 'bg-indigo-50'));
                    
                    // æ·»åŠ é€‰ä¸­çŠ¶æ€
                    this.classList.add('active', 'border-indigo-500', 'bg-indigo-50');
            
                    // è®¾ç½®æ”¯ä»˜æ–¹å¼
                    const paymentMethod = this.getAttribute('data-method');
                    paymentMethodInput.value = paymentMethod;
                });
            });
            
            // æäº¤å……å€¼è¡¨å•
            if (rechargeForm) {
                rechargeForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                    // è·å–å……å€¼é‡‘é¢
                    let amount = amountInput.value;
                    
                    // éªŒè¯å……å€¼é‡‘é¢
                    if (!amount || isNaN(amount) || amount < 10) {
                        showMessage('è¯·é€‰æ‹©å……å€¼é‡‘é¢', 'error');
                    return;
                }
                    
                    // è·å–æ”¯ä»˜æ–¹å¼
                    const paymentMethod = paymentMethodInput.value;
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    const submitBtn = rechargeForm.querySelector('button[type="submit"]');
                    const originalBtnText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="ri-loader-2-line animate-spin mr-1"></i> åˆ›å»ºè®¢å•ä¸­...';
                    submitBtn.disabled = true;
                    
                    try {
                        // å¦‚æœæ˜¯PayPalæ”¯ä»˜ï¼Œä½¿ç”¨PayPal SDK
                        if (paymentMethod === 'paypal') {
                            // æ£€æŸ¥PayPal SDKæ˜¯å¦å·²åŠ è½½
                            if (!paypalSDKLoaded || !window.paypal) {
                                showMessage('PayPal SDKæ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨å€™å†è¯•...', 'error');
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalBtnText;
                                return;
                            }
                            
                            // åˆ›å»ºPayPalè®¢å•
                            const response = await fetch('/api/credits/paypal/create', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                                },
                                body: JSON.stringify({ 
                                    amount: parseInt(amount)
                                })
                            });
                            
                            const data = await response.json();
                            
                            if (response.ok && data.success && data.data.paypalOrderId) {
                                // ä¿å­˜è®¢å•ä¿¡æ¯
                                localStorage.setItem('pendingPayPalOrderNumber', data.data.orderNumber);
                                localStorage.setItem('pendingPayPalOrderId', data.data.paypalOrderId);
                                localStorage.setItem('pendingOrderAmount', amount);
                                
                                // éšè—æäº¤æŒ‰é’®ï¼Œæ˜¾ç¤ºPayPalæŒ‰é’®å®¹å™¨
                                submitBtn.style.display = 'none';
                                
                                // åˆ›å»ºPayPalæŒ‰é’®å®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                                let paypalButtonContainer = document.getElementById('paypal-button-container');
                                if (!paypalButtonContainer) {
                                    paypalButtonContainer = document.createElement('div');
                                    paypalButtonContainer.id = 'paypal-button-container';
                                    paypalButtonContainer.className = 'mt-4';
                                    submitBtn.parentNode.insertBefore(paypalButtonContainer, submitBtn);
                                } else {
                                    paypalButtonContainer.innerHTML = '';
                                }
                                
                                // æ¸²æŸ“PayPalæŒ‰é’®
                                if (window.paypal) {
                                    window.paypal.Buttons({
                                        createOrder: function(data, actions) {
                                            // è¿”å›å·²åˆ›å»ºçš„PayPalè®¢å•ID
                                            return localStorage.getItem('pendingPayPalOrderId');
                                        },
                                        onApprove: async function(data, actions) {
                                            try {
                                                // æ•è·æ”¯ä»˜
                                                const captureResponse = await fetch('/api/credits/paypal/capture', {
                                                    method: 'POST',
                                                    headers: {
                                                        'Content-Type': 'application/json',
                                                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                                                    },
                                                    body: JSON.stringify({ 
                                                        orderId: localStorage.getItem('pendingPayPalOrderNumber')
                                                    })
                                                });
                                                
                                                const captureData = await captureResponse.json();
                                                
                                                if (captureResponse.ok && captureData.success) {
                                                    showMessage('æ”¯ä»˜æˆåŠŸï¼ç§¯åˆ†å·²åˆ°è´¦', 'success');
                                                    
                                                    // æ¸…ç†æœ¬åœ°å­˜å‚¨
                                                    localStorage.removeItem('pendingPayPalOrderNumber');
                                                    localStorage.removeItem('pendingPayPalOrderId');
                                                    localStorage.removeItem('pendingOrderAmount');
                                                    
                                                    // åˆ·æ–°é¡µé¢æ•°æ®
                                                    setTimeout(() => {
                                                        location.reload();
                                                    }, 1500);
                                                } else {
                                                    showMessage(captureData.message || 'æ”¯ä»˜å¤„ç†å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                                                }
                                            } catch (error) {
                                                console.error('æ•è·PayPalæ”¯ä»˜å‡ºé”™:', error);
                                                showMessage('æ”¯ä»˜å¤„ç†å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•', 'error');
                                            }
                                        },
                                        onCancel: function(data) {
                                            showMessage('æ”¯ä»˜å·²å–æ¶ˆ', 'info');
                                            // æ¢å¤æäº¤æŒ‰é’®
                                            submitBtn.style.display = 'block';
                                            paypalButtonContainer.innerHTML = '';
                                        },
                                        onError: function(err) {
                                            console.error('PayPalé”™è¯¯:', err);
                                            showMessage('PayPalæ”¯ä»˜å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•', 'error');
                                            // æ¢å¤æäº¤æŒ‰é’®
                                            submitBtn.style.display = 'block';
                                            paypalButtonContainer.innerHTML = '';
                                        }
                                    }).render('#paypal-button-container');
                                } else {
                                    showMessage('PayPal SDKæœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                                    submitBtn.style.display = 'block';
                                }
                                
                                // æ¢å¤æŒ‰é’®æ–‡æœ¬ï¼ˆä½†ä¿æŒéšè—ï¼‰
                                submitBtn.innerHTML = originalBtnText;
                            } else {
                                // è®¢å•åˆ›å»ºå¤±è´¥
                                showMessage(data.message || 'åˆ›å»ºPayPalè®¢å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                                submitBtn.innerHTML = originalBtnText;
                                submitBtn.disabled = false;
                            }
                        } else {
                            // æ”¯ä»˜å®æ”¯ä»˜æµç¨‹
                        const response = await fetch('/api/credits/alipay/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                            body: JSON.stringify({ 
                                amount: parseInt(amount),
                                paymentMethod
                            })
                    });
                    
                    const data = await response.json();
                    
                        if (response.ok && data.success && data.data.paymentUrl) {
                            // ä¿å­˜è®¢å•ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨ï¼Œä»¥ä¾¿åœ¨æ”¯ä»˜å®ŒæˆåæŸ¥è¯¢
                            localStorage.setItem('pendingOrderNumber', data.data.orderNumber);
                            localStorage.setItem('pendingOrderAmount', amount);
                            
                            // å¦‚æœæœ‰è¿‡æœŸæ—¶é—´ï¼Œä¹Ÿä¿å­˜ä¸‹æ¥
                            if (data.data.expireTime) {
                                localStorage.setItem('orderExpireTime', new Date(data.data.expireTime).getTime());
                            }
                            
                            showMessage('è®¢å•åˆ›å»ºæˆåŠŸï¼Œæ­£åœ¨è·³è½¬åˆ°æ”¯ä»˜é¡µé¢...');
                        
                            // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
                            window.location.href = data.data.paymentUrl;
                    } else {
                            // è®¢å•åˆ›å»ºå¤±è´¥
                            showMessage(data.message || 'åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                                submitBtn.innerHTML = originalBtnText;
                                submitBtn.disabled = false;
                            }
                    }
                } catch (error) {
                        console.error('åˆ›å»ºæ”¯ä»˜è®¢å•å‡ºé”™:', error);
                        showMessage('åˆ›å»ºæ”¯ä»˜è®¢å•å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•', 'error');
                        submitBtn.innerHTML = originalBtnText;
                        submitBtn.disabled = false;
                    }
                });
            }
        }
        
        // é‡ç½®å……å€¼è¡¨å•
        function resetRechargeForm() {
            const rechargeForm = document.getElementById('recharge-form');
            const amountOptions = document.querySelectorAll('.amount-option');
            const amountInput = document.getElementById('amount');
            
            if (rechargeForm) {
                rechargeForm.reset();
            }
            
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            amountOptions.forEach(opt => {
                opt.classList.remove('bg-indigo-50', 'border-indigo-200');
                opt.classList.add('bg-gray-50', 'border-transparent');
            });
            
            // é‡ç½®é‡‘é¢è¾“å…¥
            amountInput.value = '';
        }
    </script>
</body>
</html> 