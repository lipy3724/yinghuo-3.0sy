<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="page.diantu_title">垫图 - 萤火AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="/components/styles.css" rel="stylesheet">
    <link href="/css/diantu.css" rel="stylesheet">
    <script src="/js/auth-check.js"></script>
    <script src="/js/mobile-guard.js"></script>
    <script src="translations.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .feature-card {
            background-color: white;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        @keyframes firefly-glow {
            0% { text-shadow: 0 0 3px rgba(99, 102, 241, 0.5); }
            50% { text-shadow: 0 0 10px rgba(99, 102, 241, 0.8), 0 0 15px rgba(99, 102, 241, 0.3); }
            100% { text-shadow: 0 0 3px rgba(99, 102, 241, 0.5); }
        }
        .logo-text {
            animation: firefly-glow 3s infinite;
        }
        .logo-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #6366f1;
            border-radius: 50%;
            margin-left: 2px;
            margin-right: 4px;
            position: relative;
            top: -2px;
        }
        .image-preview {
            aspect-ratio: 16/9;
            background-color: #f3f4f6;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 5px solid rgba(99, 102, 241, 0.2);
            border-top-color: rgba(99, 102, 241, 1);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .history-card {
            transition: all 0.3s ease;
        }
        
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .history-thumbnail {
            transition: transform 0.3s ease;
        }
        
        .history-card:hover .history-thumbnail {
            transform: scale(1.05);
        }
        
        .history-card .download-history-btn {
            transition: all 0.2s ease;
        }
        
        .history-card .download-history-btn:hover {
            color: #4f46e5 !important;
            transform: scale(1.1);
        }
        
        #tasks-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        .active-option {
            background-color: #ede9fe;
            border-color: #6366f1;
            color: #4f46e5;
        }
        /* 图片拖动禁用 */
        img {
            -webkit-user-drag: none;
            user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        
        /* 自定义滚动条样式 */
        .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>

    <link rel="icon" href="/images/favicon.png" type="image/png">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 导航栏组件容器 -->
    <div id="navbar-simple"></div>

    <!-- 主内容区域 -->
    <div class="container mx-auto py-8 px-4" style="margin-top: 60px;">
        <h1 class="text-3xl font-bold text-center mb-8" data-translate="diantu.title">垫图</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- 左侧面板: 图片上传和设置 -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4" data-translate="diantu.settings">垫图设置</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="diantu.image_upload">图片上传</label>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700" data-translate="diantu.upload_instruction">上传需要垫图的图片</span>
                    </div>
                    <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-400 transition-colors cursor-pointer bg-gray-50">
                        <input type="file" id="image-upload" class="hidden" accept="image/*">
                        <div id="upload-placeholder">
                            <i class="ri-upload-cloud-2-line text-4xl text-gray-400 mb-2"></i>
                             <p class="text-gray-500" data-translate="diantu.upload_placeholder">拖放图片到此处或 <span class="text-indigo-600 font-medium">点击上传</span></p>
                             <p class="text-sm text-gray-400 mt-1" data-translate="diantu.supported_formats">支持 JPG, PNG, WEBP, GIF, BMP 格式</p>
                        </div>
                        <div id="preview-container" class="hidden">
                            <img id="image-preview" class="max-h-48 mx-auto mb-3">
                            <p id="image-info" class="text-sm text-gray-500"></p>
                             <button type="button" id="remove-image" class="mt-2 text-sm text-red-500 hover:text-red-700" data-translate="diantu.remove_image">
                                 移除图片
                             </button>
                        </div>
                    </div>
                     <p class="mt-1 text-xs text-gray-500" data-translate="diantu.upload_note">上传图片后将根据提示词生成垫图效果</p>
                </div>
                
                <div class="mb-6">
                     <label for="prompt-input" class="block text-sm font-medium text-gray-700 mb-1" data-translate="diantu.prompt_input">提示词输入</label>
                    <div class="flex justify-between items-center mb-1">
                         <span class="text-sm font-medium text-gray-700" data-translate="diantu.prompt_instruction">描述您想要的垫图效果</span>
                    </div>
                     <textarea id="prompt-input" class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="4" data-translate="diantu.prompt_placeholder" placeholder="请输入提示词，如: 添加柔和背景垫图，突出主体"></textarea>
                     <p class="text-xs text-gray-500 mt-2" data-translate="diantu.prompt_note">提示词需详细描述卡通形象的行动，建议采用格式“卡通形象……”</p>
                </div>
                
                <div class="pt-4">
                    <button id="generate-btn" class="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ri-magic-line mr-2"></i>
                         <span data-translate="diantu.start_generation">开始垫图</span>
                    </button>
                    <p class="mt-2 text-center text-sm text-gray-500">
                         <span data-translate="diantu.generation_time">垫图需要5-10秒，消耗7积分</span>
                    </p>
                     <p class="mt-2 text-center text-sm text-red-500 font-medium" data-translate="diantu.compliance_warning">
                         请上传合法合规的图片，如有违反会进行封号处理，任务一旦提交就会扣除积分不可中断，请勿重复刷新提交，否则会造成积分浪费。
                     </p>
                </div>
            </div>
            
            <!-- 右侧面板: 预览和历史记录 -->
            <div class="lg:col-span-3">
                <!-- 预览区域 -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                     <h2 class="text-xl font-bold mb-4" data-translate="diantu.image_preview">图片预览</h2>
                    <div id="original-image-container" class="h-64 md:h-96 bg-gray-100 rounded-md flex items-center justify-center overflow-hidden relative">
                         <img id="original-image" class="hidden max-w-full max-h-full object-contain" data-translate="diantu.uploaded_image_alt" alt="上传的图片" draggable="false">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="text-center">
                                <i class="ri-image-line text-6xl text-gray-300 mb-4"></i>
                                 <p class="text-gray-500" data-translate="diantu.preview_placeholder">您上传的图片将在这里显示</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 处理结果区域 -->
                <div id="resultContainer" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
                     <h2 class="text-xl font-bold mb-4" data-translate="diantu.result_preview">处理结果</h2>
                    
                    <div class="flex flex-col md:flex-row gap-6 mb-6">
                        <div class="flex-1">
                             <h3 class="font-medium text-gray-700 mb-2" data-translate="diantu.original_image">原始图片</h3>
                            <div class="border border-gray-200 rounded-lg p-2 bg-gray-50">
                                <img id="result-original-image" class="max-w-full max-h-64 mx-auto">
                                <p id="result-original-info" class="text-sm text-gray-500 mt-2 text-center"></p>
                            </div>
                        </div>
                        <div class="flex-1">
                             <h3 class="font-medium text-gray-700 mb-2" data-translate="diantu.styled_image">垫图后图片</h3>
                            <div id="result-image-wrapper" class="border border-gray-200 rounded-lg p-2 bg-gray-50">
                                <img id="result-image" class="max-w-full max-h-64 mx-auto">
                                <p id="result-image-info" class="text-sm text-gray-500 mt-2 text-center"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3">
                        <button type="button" id="download-btn" class="inline-flex items-center px-4 py-2 border border-indigo-600 text-indigo-600 bg-white rounded-md hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="ri-download-2-line mr-1"></i>
                             <span data-translate="diantu.download_result">下载图片</span>
                        </button>
                        <button type="button" id="save-to-downloads-btn" class="inline-flex items-center px-4 py-2 border border-indigo-600 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="ri-save-line mr-1"></i>
                             <span data-translate="diantu.save_result">保存</span>
                        </button>
                        <button type="button" id="new-diantu-btn" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="ri-add-line mr-1"></i>
                             <span data-translate="diantu.new_upload">上传新图片</span>
                        </button>
                    </div>
                </div>
                
                <!-- 生成历史部分 -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-xl font-bold" data-translate="diantu.history_records">生成历史</h2>
                        <div class="flex space-x-2">
                            <button id="clear-history-btn" class="text-gray-500 hover:text-red-600" title="清空历史记录">
                                <i class="ri-delete-bin-line text-xl"></i>
                            </button>
                            <button id="refresh-history-btn" class="text-indigo-600 hover:text-indigo-800" title="刷新历史记录">
                                <i class="ri-refresh-line text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="tasks-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <!-- 历史记录将通过JavaScript动态添加到这里 -->
                         <p class="text-gray-500 col-span-full text-center py-4" data-translate="diantu.no_history">暂无历史记录</p>
                    </div>
                    
                    <!-- 保存时间提示 -->
                     <p class="text-xs text-gray-400 mt-3 text-center" data-translate="diantu.history_retention">历史记录仅保存24小时</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 加载中遮罩 -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loading-spinner mb-4"></div>
             <p id="loading-message" class="text-lg font-medium" data-translate="diantu.processing">垫图处理中，请耐心等待...</p>
             <p class="text-sm text-gray-500 mt-2" data-translate="diantu.processing_time">垫图需要5-10秒</p>
        </div>
    </div>

    <!-- 引用外部Javascript文件 -->
    <script>

        // 获取当前语言设置
        function getCurrentLanguage() {
            return localStorage.getItem('language') || 'zh';
        }

        // 获取翻译文本的函数
        function getTranslation(key, fallback = key) {
            const currentLang = getCurrentLanguage();
            return translations[currentLang]?.[key] || translations['zh']?.[key] || fallback;
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // 初始化多语言支持
            if (typeof initializeLanguageSupport === 'function') {
                initializeLanguageSupport();
            }
            
            // 首先检查用户认证状态
            console.log('垫图页面：开始检查用户认证状态');
            
            // 检查本地存储
            const authToken = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('user');
            
            if (!authToken || !userInfo) {
                console.log('垫图页面：用户未登录，跳转到登录页');
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.href);
                return;
            }
            
            // 如果有统一的认证检查函数，使用它
            if (typeof window.checkAuth === 'function') {
                try {
                    const isAuthenticated = await window.checkAuth(true);
                    if (!isAuthenticated) {
                        console.log('垫图页面：认证检查失败');
                        return; // checkAuth会自动处理重定向
                    }
                    console.log('垫图页面：认证检查通过');
                } catch (error) {
                    console.error('垫图页面：认证检查出错:', error);
                    // 出错时也继续加载页面，但记录错误
                }
            }
            
            // 全局变量
            let tasks = [];
            let pollingIntervals = {};
            
            // DOM元素
            const uploadArea = document.getElementById('upload-area');
            const imageUpload = document.getElementById('image-upload');
            const imagePreview = document.getElementById('image-preview');
            const uploadPlaceholder = document.getElementById('upload-placeholder');
            const previewContainer = document.getElementById('preview-container');
            const imageInfo = document.getElementById('image-info');
            const removeImage = document.getElementById('remove-image');
            const originalImage = document.getElementById('original-image');
            const resultImage = document.getElementById('result-image');
            const generateBtn = document.getElementById('generate-btn');
            const promptInput = document.getElementById('prompt-input');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            const downloadBtn = document.getElementById('download-btn');
            const saveToDownloadsBtn = document.getElementById('save-to-downloads-btn');
            const newDiantuBtn = document.getElementById('new-diantu-btn');
            const resultContainer = document.getElementById('resultContainer');
            const resultOriginalImage = document.getElementById('result-original-image');
            const resultOriginalInfo = document.getElementById('result-original-info');
            const resultImageInfo = document.getElementById('result-image-info');
            const historyContainer = document.getElementById('tasks-container');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const refreshHistoryBtn = document.getElementById('refresh-history-btn');
            
            // 检查用户登录状态
            initializeUserUI();
            
            // 设置用户状态监听，检测用户切换
            setupUserStateListener();
            
            // 初始化按钮状态 - 确保按钮在页面加载时是隐藏的
            downloadBtn.classList.add('hidden');
            saveToDownloadsBtn.classList.add('hidden');
            newDiantuBtn.classList.add('hidden');
            
            // 退款请求函数
            async function requestRefund(taskId, reason) {
                console.log(`准备请求退款，任务ID: ${taskId}, 原因: ${reason}`);
                try {
                    const response = await fetch('/api/refund/diantu', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            taskId: taskId,
                            reason: reason
                        })
                    });
                    
                    const data = await response.json();
                    console.log('退款请求响应:', data);
                    
                    if (data.success) {
                        console.log('退款请求成功');
                        return true;
                    } else if (data.message && data.message.includes('已经退款')) {
                        // 已经退款过的情况也算成功
                        console.log('该任务已经退款过');
                        return true;
                    } else {
                        console.warn('退款请求失败:', data.message);
                        return false;
                    }
                } catch (error) {
                    console.error('发送退款请求时出错:', error);
                    throw error;
                }
            }
            
            // 图片上传处理
            uploadArea.addEventListener('click', () => {
                imageUpload.click();
            });
            
            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleImageFile(file);
                }
            });
            
            // 移除图片按钮
            removeImage.addEventListener('click', () => {
                imageUpload.value = '';
                imagePreview.src = '';
                originalImage.src = '';
                originalImage.classList.add('hidden');
                uploadPlaceholder.classList.remove('hidden');
                previewContainer.classList.add('hidden');
                
                // 重新显示占位符文本
                const placeholderDiv = document.querySelector('#original-image-container .absolute');
                if (placeholderDiv) {
                    placeholderDiv.style.display = 'flex';
                }
                
                generateBtn.disabled = true;
            });
            
            // 拖放上传
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            uploadArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                
                if (file && file.type.startsWith('image/')) {
                    handleImageFile(file);
                } else {
                    alert('请上传图片文件！');
                }
            });
            
            // 生成按钮点击
            generateBtn.addEventListener('click', async () => {
                const prompt = promptInput.value.trim();
                
                if (!originalImage.src || originalImage.classList.contains('hidden')) {
                    alert('请先上传图片！');
                    return;
                }
                
                if (!prompt) {
                    alert('请输入提示词！');
                    return;
                }
                
                // 禁用生成按钮
                generateBtn.disabled = true;
                
                // 显示加载中
                loadingOverlay.classList.remove('hidden');
                loadingMessage.textContent = getTranslation('diantu.processing_image');
                
                try {
                    // 1. 上传原图到服务器获取URL
                    loadingMessage.textContent = getTranslation('diantu.uploading_image');
                    console.log('正在上传图片...');
                    let imageUrl;
                    
                    try {
                        imageUrl = await uploadImageToServer(originalImage.src);
                    } catch (uploadError) {
                        console.error('图片上传错误:', uploadError);
                        throw new Error(`图片上传失败: ${uploadError.message}`);
                    }
                    
                    if (!imageUrl) {
                        throw new Error('图片上传失败，未获取到有效URL');
                    }
                    
                    console.log('图片上传成功，获取到的URL:', imageUrl);
                    
                    // 2. 调用API创建垫图任务
                    loadingMessage.textContent = '正在创建垫图任务...';
                    console.log('正在创建垫图任务...');
                    
                    let taskId;
                    try {
                        taskId = await createDiantuTask(prompt, imageUrl);
                    } catch (taskError) {
                        console.error('创建任务错误:', taskError);
                        throw new Error(`创建垫图任务失败: ${taskError.message}`);
                    }
                    
                    if (!taskId) {
                        throw new Error('创建垫图任务失败，未获取到任务ID');
                    }
                    
                    // 保存任务ID到全局变量，以便在错误处理中使用
                    window.currentTaskId = taskId;
                    console.log('创建任务成功，任务ID:', taskId);
                    
                    // 3. 轮询任务状态
                    loadingMessage.textContent = getTranslation('diantu.processing_wait');
                    console.log('开始轮询任务状态...');
                    
                    let resultImageUrl;
                    try {
                        resultImageUrl = await pollTaskStatus(taskId);
                    } catch (pollError) {
                        console.error('轮询任务状态错误:', pollError);
                        throw new Error(`获取任务结果失败: ${pollError.message}`);
                    }
                    
                    if (!resultImageUrl) {
                        throw new Error('获取结果图像失败，未获取到有效URL');
                    }
                    
                    console.log('获取任务结果成功，图像URL:', resultImageUrl);
                    
                    // 4. 显示结果图像
                    loadingMessage.textContent = getTranslation('diantu.loading_result');
                    showResults({
                        imageUrl: resultImageUrl,
                        originalUrl: imageUrl,
                        taskStatus: 'SUCCEEDED' // 添加任务状态，确保只有成功的任务才会被保存
                    });
                    
                    // 5. 保存到历史记录并更新显示
                    console.log('生成成功，保存到历史记录并更新显示');
                    
                    // 先保存到历史记录（这一步在showResults中已经完成）
                    // 然后加载最新的历史记录
                    await loadUserTasks();
                    
                    // 延迟3秒后再次更新，确保服务器数据完全同步
                    setTimeout(async () => {
                        console.log('延迟3秒后再次更新历史记录');
                        await loadUserTasks();
                    }, 3000);
                } catch (error) {
                    console.error('处理失败:', error);
                    
                    // 隐藏加载遮罩
                    hideLoadingOverlay();
                    
                    // 重新启用生成按钮
                    generateBtn.disabled = false;
                    
                    // 尝试自动退款
                    if (window.currentTaskId) {
                        try {
                            await requestRefund(window.currentTaskId, error.message || '处理失败');
                            console.log('错误处理中请求退款成功');
                            alert(getTranslation('diantu.processing_failed') + ': ' + error.message + '\n' + getTranslation('diantu.credits_refunded'));
                        } catch (refundError) {
                            console.error('退款请求失败:', refundError);
                            alert('处理失败: ' + error.message + '\n退款请求失败，请联系客服处理。');
                        }
                    } else {
                        alert('处理失败: ' + error.message);
                    }
                    
                    // 隐藏加载遮罩
                    loadingOverlay.classList.add('hidden');
                }
            });
            
            // 上传图片到服务器
            async function uploadImageToServer(imageData) {
                try {
                    // 转换为Blob对象
                    let blob;
                    if (imageData.startsWith('data:')) {
                        // 从base64字符串创建Blob对象
                        blob = base64ToBlob(imageData.split(',')[1], 'image/jpeg');
                    } else {
                        // 处理URL情况 - 先获取图像再转换
                        const response = await fetch(imageData);
                        blob = await response.blob();
                    }
                    
                    // 创建FormData对象
                    const formData = new FormData();
                    formData.append('image', blob, 'image.jpg');
                    formData.append('useOSS', 'true'); // 指定使用OSS存储
                    formData.append('prefix', 'diantu'); // 指定OSS存储前缀
                    
                    // 发送请求上传图片
                    console.log('准备上传图片到OSS...');
                    const response = await fetch('/api/upload-to-oss', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        console.log('OSS上传失败，尝试使用传统上传方式');
                        return await uploadImageToServerFallback(imageData);
                    }
                    
                    const imageUrl = data.url || data.imageUrl;
                    console.log('上传图片到OSS成功，获取到的URL:', imageUrl);
                    return imageUrl;
                } catch (error) {
                    console.error('OSS图片上传错误:', error);
                    console.log('尝试使用传统上传方式');
                    return await uploadImageToServerFallback(imageData);
                }
            }
            
            // 传统上传方式（备用）
            async function uploadImageToServerFallback(imageData) {
                try {
                    // 转换为Blob对象
                    let blob;
                    if (imageData.startsWith('data:')) {
                        // 从base64字符串创建Blob对象
                        blob = base64ToBlob(imageData.split(',')[1], 'image/jpeg');
                    } else {
                        // 处理URL情况 - 先获取图像再转换
                        const response = await fetch(imageData);
                        blob = await response.blob();
                    }
                    
                    // 创建FormData对象
                    const formData = new FormData();
                    formData.append('image', blob, 'image.jpg');
                    
                    // 发送请求上传图片
                    console.log('准备使用传统方式上传图片...');
                    const response = await fetch('/api/text-to-video/upload-image', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || '图片上传失败');
                    }
                    
                    const imageUrl = data.output?.img_url || data.imageUrl;
                    console.log('传统方式上传图片成功，获取到的URL:', imageUrl);
                    return imageUrl;
                } catch (error) {
                    console.error('传统图片上传错误:', error);
                    throw new Error('图片上传失败: ' + error.message);
                }
            }
            
            // Base64转Blob
            function base64ToBlob(base64Data, mimeType = 'image/jpeg') {
                const byteCharacters = atob(base64Data);
                const byteArrays = [];
                
                for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                    const slice = byteCharacters.slice(offset, offset + 512);
                    
                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) {
                        byteNumbers[i] = slice.charCodeAt(i);
                    }
                    
                    const byteArray = new Uint8Array(byteNumbers);
                    byteArrays.push(byteArray);
                }
                
                return new Blob(byteArrays, { type: mimeType });
            }
            
            // 创建垫图任务
            async function createDiantuTask(prompt, imageUrl) {
                try {
                    // 构建请求数据
                    const requestData = {
                        model: "wanx2.1-imageedit",
                        input: {
                            function: "control_cartoon_feature",
                            prompt: prompt || "为图片添加垫图效果",
                            base_image_url: imageUrl
                        },
                        parameters: {
                            n: 1
                        }
                    };
                    // 通过服务器代理调用阿里云API
                    const response = await fetch('/api/image-edit/create-task', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify(requestData)
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        if (data.message && data.message.includes('积分不足')) {
                            throw new Error('您的积分不足，请充值后再试');
                        } else {
                            throw new Error(data.message || '创建任务失败');
                        }
                    }
                    return data.output?.task_id;
                } catch (error) {
                    console.error('创建任务错误:', error);
                    throw new Error('创建任务失败: ' + error.message);
                }
            }
            
            // 轮询任务状态
            async function pollTaskStatus(taskId) {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    let errorCount = 0;
                    const maxAttempts = 60; // 最多轮询60次，约10分钟
                    const pollInterval = 10000; // 轮询间隔10秒
                    async function checkStatus() {
                        if (attempts >= maxAttempts) {
                            clearTimeout(timeoutId);
                            
                            // 请求退款
                            try {
                                await requestRefund(taskId, '任务处理超时');
                                console.log('已请求退款，原因：任务处理超时');
                                
                                // 显示超时提示
                                resultImagePlaceholder.innerHTML = `
                                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                                        <svg class="w-12 h-12 mx-auto text-yellow-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <h3 class="text-lg font-medium text-yellow-600 mb-2">任务处理超时</h3>
                                        <p class="text-yellow-600 mb-2">服务器处理时间过长，请稍后重试</p>
                                        <p class="text-green-600">${getTranslation('diantu.credits_refunded')}</p>
                                    </div>
                                `;
                            } catch (refundError) {
                                console.error('退款请求失败:', refundError);
                            }
                            
                            reject(new Error('任务处理超时，请稍后重试'));
                            return;
                        }
                        attempts++;
                        loadingMessage.textContent = `${getTranslation('diantu.processing_wait')} (${attempts}/${maxAttempts})`;
                        try {
                            const response = await fetch(`/api/image-edit/task-status/${taskId}`, {
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                                }
                            });
                            if (!response.ok) {
                                throw new Error('获取任务状态失败，服务器错误');
                            }
                            const data = await response.json();
                            
                            // 详细记录API响应结构，便于调试
                            console.log(`轮询结果 (${attempts}/${maxAttempts}):`, data);
                            console.log('API响应详情 - request_id:', data.request_id);
                            console.log('API响应详情 - output:', data.output);
                            if (data.output) {
                                console.log('API响应详情 - task_status:', data.output.task_status);
                                console.log('API响应详情 - task_id:', data.output.task_id);
                                if (data.output.results) {
                                    console.log('API响应详情 - results:', JSON.stringify(data.output.results));
                                }
                            }
                            
                            const taskStatus = data.output?.task_status;
                            
                            // 检查各种任务状态
                            if (taskStatus === 'SUCCEEDED') {
                                const resultsList = data.output?.results || [];
                                if (resultsList.length > 0) {
                                    const successResults = resultsList.filter(result => result.url);
                                    const failedResults = resultsList.filter(result => result.code);
                                    
                                    if (successResults.length > 0) {
                                        clearTimeout(timeoutId);
                                        resolve(successResults[0].url);
                                        return;
                                    } else {
                                        // 所有结果都失败了
                                        clearTimeout(timeoutId);
                                        
                                        // 请求退款
                                        try {
                            const errorMessage = failedResults[0]?.message || getTranslation('diantu.unknown_error');
                            await requestRefund(taskId, `${getTranslation('diantu.generation_failed')}: ${errorMessage}`);
                            console.log('已请求退款，原因：所有生成结果都失败');
                            
                            // 显示失败提示
                            resultImagePlaceholder.innerHTML = `
                                <div class="text-center p-4 bg-red-50 rounded-lg">
                                    <svg class="w-12 h-12 mx-auto text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <h3 class="text-lg font-medium text-red-600 mb-2">${getTranslation('diantu.generation_failed')}</h3>
                                    <p class="text-red-600 mb-2">${getTranslation('diantu.error_reason')}: ${errorMessage}</p>
                                    <p class="text-green-600">${getTranslation('diantu.credits_refunded')}</p>
                                </div>
                            `;
                                        } catch (refundError) {
                                            console.error('退款请求失败:', refundError);
                                        }
                                        
                                        reject(new Error(`${getTranslation('diantu.generation_failed')}: ${errorMessage}`));
                                        return;
                                    }
                                }
                                clearTimeout(timeoutId);
                                
                                // 请求退款
                                try {
                                    await requestRefund(taskId, '任务成功但未找到结果');
                                    console.log('已请求退款，原因：任务成功但未找到结果');
                                    
                                    // 显示失败提示
                                    resultImagePlaceholder.innerHTML = `
                                        <div class="text-center p-4 bg-red-50 rounded-lg">
                                            <svg class="w-12 h-12 mx-auto text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <h3 class="text-lg font-medium text-red-600 mb-2">${getTranslation('diantu.generation_failed')}</h3>
                                            <p class="text-red-600 mb-2">任务成功但未找到结果，请重试</p>
                                            <p class="text-green-600">${getTranslation('diantu.credits_refunded')}</p>
                                        </div>
                                    `;
                                } catch (refundError) {
                                    console.error('退款请求失败:', refundError);
                                }
                                
                                reject(new Error('任务成功但未找到结果，请重试'));
                                return;
                            } else if (taskStatus === 'FAILED') {
                                clearTimeout(timeoutId);
                                const errorMsg = data.output?.message || getTranslation('diantu.unknown_error');
                                const errorCode = data.output?.code || '';
                                
                                // 请求退款
                                try {
                                    await requestRefund(taskId, `任务执行失败: ${errorCode} - ${errorMsg}`);
                                    console.log('已请求退款，原因：任务执行失败');
                                    
                                    // 显示失败提示
                                    resultImagePlaceholder.innerHTML = `
                                        <div class="text-center p-4 bg-red-50 rounded-lg">
                                            <svg class="w-12 h-12 mx-auto text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <h3 class="text-lg font-medium text-red-600 mb-2">${getTranslation('diantu.generation_failed')}</h3>
                                            <p class="text-red-600 mb-2">${getTranslation('diantu.error_reason')}: ${errorMsg}</p>
                                            <p class="text-green-600">${getTranslation('diantu.credits_refunded')}</p>
                                        </div>
                                    `;
                                } catch (refundError) {
                                    console.error('退款请求失败:', refundError);
                                }
                                
                                reject(new Error(`任务执行失败: ${errorMsg}`));
                                return;
                            } else if (taskStatus === 'CANCELED') {
                                clearTimeout(timeoutId);
                                
                                // 请求退款
                                try {
                                    await requestRefund(taskId, '任务已被取消');
                                    console.log('已请求退款，原因：任务已被取消');
                                    
                                    // 显示取消提示
                                    resultImagePlaceholder.innerHTML = `
                                        <div class="text-center p-4 bg-yellow-50 rounded-lg">
                                            <svg class="w-12 h-12 mx-auto text-yellow-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                            </svg>
                                            <h3 class="text-lg font-medium text-yellow-600 mb-2">任务已被取消</h3>
                                            <p class="text-green-600">${getTranslation('diantu.credits_refunded')}</p>
                                        </div>
                                    `;
                                } catch (refundError) {
                                    console.error('退款请求失败:', refundError);
                                }
                                
                                reject(new Error('任务已被取消'));
                                return;
                            } else if (taskStatus === 'UNKNOWN') {
                                clearTimeout(timeoutId);
                                
                                // 请求退款
                                try {
                                    await requestRefund(taskId, '任务状态未知');
                                    console.log('已请求退款，原因：任务状态未知');
                                    
                                    // 显示未知状态提示
                                    resultImagePlaceholder.innerHTML = `
                                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                                            <svg class="w-12 h-12 mx-auto text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <h3 class="text-lg font-medium text-gray-600 mb-2">任务状态未知</h3>
                                            <p class="text-gray-600 mb-2">无法确定任务处理状态</p>
                                            <p class="text-green-600">${getTranslation('diantu.credits_refunded')}</p>
                                        </div>
                                    `;
                                } catch (refundError) {
                                    console.error('退款请求失败:', refundError);
                                }
                                
                                reject(new Error('任务状态未知，请重试'));
                                return;
                            }
                            
                            // 状态为PENDING或RUNNING，继续轮询
                            console.log(`任务状态: ${taskStatus}, 继续轮询...`);
                            timeoutId = setTimeout(checkStatus, pollInterval);
                        } catch (error) {
                            errorCount++;
                            if (errorCount >= 3) {
                                clearTimeout(timeoutId);
                                
                                // 请求退款
                                try {
                                    await requestRefund(taskId, '轮询任务状态连续失败');
                                    console.log('已请求退款，原因：轮询任务状态连续失败');
                                    
                                    // 显示网络错误提示
                                    resultImagePlaceholder.innerHTML = `
                                        <div class="text-center p-4 bg-orange-50 rounded-lg">
                                            <svg class="w-12 h-12 mx-auto text-orange-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                            </svg>
                                            <h3 class="text-lg font-medium text-orange-600 mb-2">网络连接不稳定</h3>
                                            <p class="text-orange-600 mb-2">无法获取任务状态，请检查网络后重试</p>
                                            <p class="text-green-600">${getTranslation('diantu.credits_refunded')}</p>
                                        </div>
                                    `;
                                } catch (refundError) {
                                    console.error('退款请求失败:', refundError);
                                }
                                
                                reject(new Error('网络连接不稳定，请检查网络后重试'));
                                return;
                            }
                            timeoutId = setTimeout(checkStatus, pollInterval);
                        }
                    }
                    let timeoutId = setTimeout(checkStatus, 3000);
                });
            }
            
            // 保存到下载中心按钮 - 统一的保存逻辑
            saveToDownloadsBtn.addEventListener('click', async () => {
                if (!resultImage.src) return;
                
                try {
                    // 显示加载中
                    loadingOverlay.classList.remove('hidden');
                    loadingMessage.textContent = '正在保存到下载中心...';
                    
                    // 获取提示文本
                    const promptText = promptInput.value.trim() || '垫图';
                    
                    console.log('准备保存图片到下载中心:', resultImage.src.substring(0, 50) + '...');
                    
                    // 检查URL长度，如果过长则进行处理
                    const maxUrlLength = 2000; // 设置最大URL长度
                    let processedImageUrl = resultImage.src;
                    
                    if (resultImage.src && resultImage.src.length > maxUrlLength) {
                        console.warn('图片URL过长，长度:', resultImage.src.length);
                        // 对于过长的URL，我们保留关键部分
                        processedImageUrl = resultImage.src.substring(0, maxUrlLength) + '...[截断]';
                    }
                    
                    // 调用API保存图片到下载中心
                    const response = await fetch('/api/downloads/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            imageUrl: processedImageUrl,
                            title: '垫图: ' + (promptText.substring(0, 30) + (promptText.length > 30 ? '...' : '')),
                            description: promptText,
                            type: 'DIANTU'
                        })
                    });
                    
                    console.log('保存响应状态:', response.status);
                    
                    const data = await response.json();
                    console.log('保存响应数据:', data);
                    
                    if (!response.ok) {
                        throw new Error(data.message || data.error || '保存失败');
                    }
                    
                    if (data.success) {
                        alert('图片已成功保存到下载中心！');
                        
                        // 保存成功后，刷新历史记录
                        console.log('保存成功，刷新历史记录');
                        if (typeof loadUserTasks === 'function') {
                            loadUserTasks();
                        }
                    } else {
                        throw new Error(data.message || '保存失败');
                    }
                } catch (error) {
                    console.error('保存到下载中心失败:', error);
                    alert('保存到下载中心失败: ' + error.message);
                } finally {
                    // 隐藏加载遮罩
                    loadingOverlay.classList.add('hidden');
                }
            });

            // 辅助函数
            function handleImageFile(file) {
                // 检查文件类型
                if (!file.type.startsWith('image/')) {
                    alert('请上传图片文件！支持的格式包括JPG、PNG和WEBP');
                    return;
                }
                
                // 检查文件大小
                if (file.size > 10 * 1024 * 1024) { // 10MB 限制
                    alert('图片大小不能超过10MB！');
                    return;
                }
                
                // 创建预览并检查图片尺寸
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = function() {
                        // 检查图片尺寸
                        if (img.width < 512 || img.height < 512) {
                            alert('图片尺寸太小，请上传最小512×512像素的图片');
                            return;
                        }
                        if (img.width > 4000 || img.height > 4000) {
                            alert('图片尺寸过大，请上传不超过4000×4000像素的图片');
                            return;
                        }
                        
                        // 更新预览
                        imagePreview.src = event.target.result;
                        imageInfo.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                        uploadPlaceholder.classList.add('hidden');
                        previewContainer.classList.remove('hidden');
                        
                        // 显示原始图片
                        originalImage.src = event.target.result;
                        originalImage.classList.remove('hidden');
                        
                        // 隐藏占位符文本
                        const placeholderDiv = document.querySelector('#original-image-container .absolute');
                        if (placeholderDiv) {
                            placeholderDiv.style.display = 'none';
                        }
                        
                        // 启用生成按钮
                        generateBtn.disabled = false;
                    };
                    img.src = event.target.result;
                };
                reader.onerror = () => {
                    alert('读取文件失败，请重新上传');
                };
                reader.readAsDataURL(file);
            }
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            function highlight() {
                uploadArea.classList.add('border-indigo-500', 'bg-indigo-50');
            }
            function unhighlight() {
                uploadArea.classList.remove('border-indigo-500', 'bg-indigo-50');
            }

            // 显示处理结果
            function showResults(result) {
                hideLoadingOverlay();
                
                // 如果result包含originalUrl，使用它；否则使用本地文件
                if (result.originalUrl) {
                    resultOriginalImage.src = result.originalUrl;
                } else {
                    resultOriginalImage.src = originalImage.src;
                }
                
                resultImage.src = result.imageUrl;
                
                // 保存任务状态，用于后续保存历史记录
                resultImage.dataset.taskStatus = result.taskStatus || '';
                
                const img = new Image();
                img.onload = () => {
                    if (originalImage.src) {
                        resultOriginalInfo.textContent = `原始图片 (${img.width}×${img.height} px)`;
                    } else {
                        resultOriginalInfo.textContent = `原始图片 (${img.width}×${img.height} px)`;
                    }
                    resultImageInfo.textContent = `垫图后图片 (尺寸: ${img.width}x${img.height})`;
                };
                img.src = result.imageUrl;
                
                // 显示结果，但保持左侧面板可见
                resultContainer.classList.remove('hidden');
                
                // 确保按钮是可见的
                downloadBtn.classList.remove('hidden');
                saveToDownloadsBtn.classList.remove('hidden');
                newDiantuBtn.classList.remove('hidden');
                
                // 自动保存到新的OSS历史记录系统
                if (result.taskStatus === 'SUCCEEDED') {
                    saveDiantuHistoryToOSS(result.originalUrl, result.imageUrl, promptInput.value.trim() || '垫图');
                }
                
                // 注意：保存按钮的事件处理已在上面统一处理，这里不需要重复绑定
                // 移除重复的事件绑定以避免保存两条记录
            }
            
            // 隐藏加载遮罩
            function hideLoadingOverlay() {
                loadingOverlay.classList.add('hidden');
            }
            
            // 显示加载遮罩
            function showLoadingOverlay(message = null) {
                if (!message) message = getTranslation('diantu.processing_wait');
                loadingMessage.textContent = message;
                loadingOverlay.classList.remove('hidden');
            }
            
            // 初始化用户界面（不进行认证检查，由auth-check.js统一处理）
            function initializeUserUI() {
                const authToken = localStorage.getItem('authToken');
                const userInfo = localStorage.getItem('user');
                if (authToken && userInfo) {
                    try {
                        const user = JSON.parse(userInfo);
                        const usernameElement = document.getElementById('username-display');
                        if (usernameElement) {
                            usernameElement.textContent = user.username;
                        }
                        const loginSection = document.getElementById('login-section');
                        if (loginSection) loginSection.classList.add('hidden');
                        const userSection = document.getElementById('user-section');
                        if (userSection) userSection.classList.remove('hidden');
                        // 获取用户积分
                        const creditsElement = document.getElementById('credits-display');
                        if (creditsElement) {
                            fetch('/api/user/credits', {
                                headers: {
                                    'Authorization': `Bearer ${authToken}`
                                }
                            })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    creditsElement.textContent = `积分: ${data.credits || 0}`;
                                } else {
                                    creditsElement.textContent = '积分: --';
                                }
                            })
                            .catch(err => {
                                console.error('获取积分失败:', err);
                                creditsElement.textContent = '积分: --';
                            });
                        }
                    } catch (e) {
                        console.error('解析用户信息出错:', e);
                        // 不进行跳转，让auth-check.js处理
                        console.log('垫图页面：用户信息解析失败，由auth-check.js处理');
                    }
                } else {
                    // 用户未登录，不进行跳转，让auth-check.js处理
                    console.log('垫图页面：用户未登录，由auth-check.js处理');
                    const userSection = document.getElementById('user-section');
                    const loginSection = document.getElementById('login-section');
                    if (userSection) userSection.classList.add('hidden');
                    if (loginSection) loginSection.classList.remove('hidden');
                }
            }

            // 下载按钮
            // 上传新图片按钮
            newDiantuBtn.addEventListener('click', () => {
                // 清空当前图片预览和提示词
                imageUpload.value = '';
                imagePreview.src = '';
                originalImage.src = '';
                originalImage.classList.add('hidden');
                uploadPlaceholder.classList.remove('hidden');
                previewContainer.classList.add('hidden');
                promptInput.value = '';
                resultContainer.classList.add('hidden');
                downloadBtn.classList.add('hidden');
                saveToDownloadsBtn.classList.add('hidden');
                newDiantuBtn.classList.add('hidden');
                
                // 重新显示占位符文本
                const placeholderDiv = document.querySelector('#original-image-container .absolute');
                if (placeholderDiv) {
                    placeholderDiv.style.display = 'flex';
                }
                
                // 显示上传区域
                const leftPanel = document.querySelector('.lg\\:col-span-2');
                if (leftPanel) {
                    leftPanel.style.display = 'block';
                }
                
                // 禁用生成按钮
                generateBtn.disabled = true;
            });
            
            // 下载按钮点击事件
            downloadBtn.addEventListener('click', () => {
                if (resultImage.src) {
                    const link = document.createElement('a');
                    link.href = resultImage.src;
                    link.download = 'diantu-result.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
            
            // 加载用户任务列表
            async function loadUserTasks() {
                try {
                    console.log('开始加载垫图历史记录...');
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        console.error('加载历史记录失败: 用户未登录');
                        historyContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">请先登录</p>';
                        return;
                    }
                    
                    // 首先尝试从新的OSS历史记录API获取历史记录
                    try {
                        console.log('尝试从新的OSS历史记录API获取历史记录...');
                        const ossResponse = await fetch(`/api/diantu-history/list?t=${Date.now()}`, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Cache-Control': 'no-cache, no-store, must-revalidate'
                            }
                        });
                        
                        if (ossResponse.ok) {
                            const ossData = await ossResponse.json();
                            console.log('新OSS历史记录API响应数据:', ossData);
                            
                            if (ossData.success && ossData.records && Array.isArray(ossData.records)) {
                                console.log('新OSS历史记录API响应成功，检查历史记录数据:', ossData.records);
                                
                                const historyData = ossData.records;
                                
                                if (historyData && historyData.length > 0) {
                                    console.log(`从OSS获取到${historyData.length}条历史记录，开始验证有效性`);
                                    
                                    // 验证历史记录的有效性
                                    const validHistory = historyData.filter(item => {
                                        // 检查必要字段
                                        const hasValidResult = item.resultImage && item.resultImage.trim() !== '' && !item.resultImage.includes('placeholder');
                                        const hasValidOriginal = item.originalImage && item.originalImage.trim() !== '' && !item.originalImage.includes('placeholder');
                                        const hasValidPrompt = item.prompt && item.prompt.trim() !== '' && item.prompt !== '垫图';
                                        const hasValidTime = item.timestamp;
                                        const hasValidId = item.id || item.taskId;
                                        
                                        // 检查是否是测试数据（通过多种方式判断）
                                        let isTestData = false;
                                        
                                        // 1. 检查时间戳是否合理
                                        if (hasValidTime) {
                                            const recordTime = new Date(item.timestamp);
                                            const now = new Date();
                                            const oneYearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                                            
                                            // 如果记录时间是未来时间或超过一年前，可能是测试数据
                                            if (recordTime > now || recordTime < oneYearAgo) {
                                                console.log('发现异常时间的记录，可能是测试数据:', recordTime);
                                                isTestData = true;
                                            }
                                        }
                                        
                                        // 2. 检查图片URL是否包含测试标识
                                        if (hasValidResult && (
                                            item.resultImage.includes('test') || 
                                            item.resultImage.includes('demo') || 
                                            item.resultImage.includes('sample') ||
                                            item.resultImage.includes('example')
                                        )) {
                                            console.log('发现测试图片URL:', item.resultImage);
                                            isTestData = true;
                                        }
                                        
                                        // 3. 检查提示词是否包含测试标识
                                        if (hasValidPrompt && (
                                            item.prompt.includes('测试') || 
                                            item.prompt.includes('test') || 
                                            item.prompt.includes('demo') ||
                                            item.prompt.toLowerCase().includes('sample')
                                        )) {
                                            console.log('发现测试提示词:', item.prompt);
                                            isTestData = true;
                                        }
                                        
                                        const isValid = hasValidResult && hasValidOriginal && hasValidPrompt && hasValidTime && hasValidId && !isTestData;
                                        
                                        if (!isValid) {
                                            console.log('过滤无效OSS历史记录:', {
                                                id: item.id || item.taskId,
                                                hasValidResult,
                                                hasValidOriginal, 
                                                hasValidPrompt,
                                                hasValidTime,
                                                hasValidId,
                                                isTestData,
                                                resultImage: item.resultImage?.substring(0, 50) + '...',
                                                prompt: item.prompt
                                            });
                                        }
                                        
                                        return isValid;
                                    });
                                    
                                    console.log(`过滤后的有效OSS历史记录数量: ${validHistory.length}/${historyData.length}`);
                                    
                                    if (validHistory.length > 0) {
                                        // 输出第一条有效记录的详细信息用于调试
                                        console.log('第一条有效OSS历史记录:', JSON.stringify(validHistory[0]));
                                        
                                        // 转换格式以兼容现有显示逻辑
                                        tasks = validHistory.map(item => {
                                            return {
                                                id: item.id || item.taskId || Math.random().toString(36).substring(2),
                                                taskId: item.id || item.taskId || Math.random().toString(36).substring(2),
                                                userId: item.userId || 'unknown',
                                                prompt: item.prompt,
                                                originalUrl: item.originalImage,
                                                resultUrl: item.resultImage,
                                                status: 'completed',
                                                createdAt: item.timestamp,
                                                storage: 'oss'
                                            };
                                        });
                                        
                                        // 显示任务
                                        displayTasks();
                                        return; // 成功获取OSS记录，不需要继续获取传统记录
                                    } else {
                                        console.log('OSS中没有有效的历史记录，显示空状态');
                                        tasks = [];
                                        displayTasks();
                                        return;
                                    }
                                } else {
                                    console.log('OSS响应中未找到有效的历史记录数组');
                                    console.log('OSS响应缺少history字段或history不是数组:', ossData);
                                }
                                
                                console.log('OSS中没有有效的历史记录，尝试获取传统记录');
                            } else {
                                console.log('OSS响应不成功，尝试获取传统记录');
                            }
                        } else {
                            console.log('OSS历史记录请求失败，状态码:', ossResponse.status);
                            console.log('尝试获取传统记录');
                        }
                    } catch (ossError) {
                        console.error('从OSS获取历史记录失败:', ossError);
                        console.log('尝试获取传统记录');
                    }
                    
                    // 获取传统历史记录
                    console.log('发送传统历史记录请求，添加时间戳防止缓存:', new Date().toISOString());
                    const response = await fetch(`/api/diantu/tasks?t=${Date.now()}`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Cache-Control': 'no-cache, no-store, must-revalidate'
                        }
                    });
                    
                    console.log('传统历史记录响应状态:', response.status);
                    
                    if (!response.ok) {
                        throw new Error('获取任务列表失败，HTTP状态: ' + response.status);
                    }
                    
                    const data = await response.json();
                    console.log('传统历史记录响应数据:', data);
                    console.log('获取到历史记录数量:', (data.tasks || []).length);
                    
                    const rawTasks = data.tasks || [];
                    console.log(`从传统API获取到${rawTasks.length}条历史记录，开始验证有效性`);
                    
                    // 验证传统API的历史记录
                    const validTasks = rawTasks.filter(task => {
                        // 检查必要字段
                        const hasValidResult = task.resultUrl && task.resultUrl.trim() !== '' && !task.resultUrl.includes('placeholder');
                        const hasValidOriginal = task.originalUrl && task.originalUrl.trim() !== '' && !task.originalUrl.includes('placeholder');
                        const hasValidPrompt = task.prompt && task.prompt.trim() !== '' && task.prompt !== '垫图';
                        const hasValidTime = task.createdAt;
                        const hasValidId = task.taskId;
                        
                        // 检查是否是测试数据
                        let isTestData = false;
                        
                        // 1. 检查时间戳是否合理
                        if (hasValidTime) {
                            const recordTime = new Date(task.createdAt);
                            const now = new Date();
                            const oneYearAgo = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                            
                            // 如果记录时间是未来时间或超过一年前，可能是测试数据
                            if (recordTime > now || recordTime < oneYearAgo) {
                                console.log('发现异常时间的传统记录，可能是测试数据:', recordTime);
                                isTestData = true;
                            }
                        }
                        
                        // 2. 检查图片URL是否包含测试标识
                        if (hasValidResult && (
                            task.resultUrl.includes('test') || 
                            task.resultUrl.includes('demo') || 
                            task.resultUrl.includes('sample') ||
                            task.resultUrl.includes('example')
                        )) {
                            console.log('发现测试图片URL:', task.resultUrl);
                            isTestData = true;
                        }
                        
                        // 3. 检查提示词是否包含测试标识
                        if (hasValidPrompt && (
                            task.prompt.includes('测试') || 
                            task.prompt.includes('test') || 
                            task.prompt.includes('demo') ||
                            task.prompt.toLowerCase().includes('sample')
                        )) {
                            console.log('发现测试提示词:', task.prompt);
                            isTestData = true;
                        }
                        
                        const isValid = hasValidResult && hasValidOriginal && hasValidPrompt && hasValidTime && hasValidId && !isTestData;
                        
                        if (!isValid) {
                            console.log('过滤无效传统历史记录:', {
                                taskId: task.taskId,
                                hasValidResult,
                                hasValidOriginal,
                                hasValidPrompt,
                                hasValidTime,
                                hasValidId,
                                isTestData,
                                resultUrl: task.resultUrl?.substring(0, 50) + '...',
                                prompt: task.prompt
                            });
                        }
                        
                        return isValid;
                    });
                    
                    console.log(`过滤后的有效传统历史记录数量: ${validTasks.length}/${rawTasks.length}`);
                    
                    tasks = validTasks;
                    
                    // 记录有效任务ID和状态，便于调试
                    if (tasks.length > 0) {
                        console.log('有效历史记录任务列表:', tasks.map(task => ({
                            id: task.taskId,
                            status: task.status,
                            time: new Date(task.createdAt).toLocaleString('zh-CN'),
                            prompt: task.prompt?.substring(0, 20) + '...'
                        })));
                    } else {
                        console.log('没有找到有效的历史记录');
                    }
                    
                    displayTasks();
                } catch (error) {
                    console.error('加载任务列表失败:', error);
                    // 出错时显示空状态而不是错误信息，避免显示虚假数据
                    tasks = [];
                    displayTasks();
                }
            }
            
            // 显示任务列表
            function displayTasks() {
                if (tasks.length === 0) {
                    const noHistoryText = getTranslation('diantu.no_history');
                    historyContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">${noHistoryText}</p>`;
                    return;
                }
                
                // 清空历史记录容器
                historyContainer.innerHTML = '';
                
                // 按时间倒序排序，确保最新的记录在前面
                const sortedTasks = tasks.sort((a, b) => {
                    const dateA = new Date(a.createdAt);
                    const dateB = new Date(b.createdAt);
                    return dateB - dateA; // 降序排列，最新的在前
                });
                
                // 只显示最新的3条记录
                const displayTasks = sortedTasks.slice(0, 3);
                console.log(`显示最新的 ${displayTasks.length} 条垫图历史记录，按时间倒序排列`);
                
                // 输出排序后的时间信息用于调试
                if (displayTasks.length > 0) {
                    console.log('历史记录时间排序:', displayTasks.map((task, index) => ({
                        index: index + 1,
                        time: new Date(task.createdAt).toLocaleString('zh-CN'),
                        prompt: task.prompt?.substring(0, 20) + '...'
                    })));
                }
                
                    // 遍历任务并创建卡片
                    displayTasks.forEach((task, index) => {
                        console.log(`处理第${index+1}条历史记录:`, task.prompt);
                        console.log(`历史记录${index+1}的结果图URL:`, task.resultUrl);
                        
                        // 创建历史记录卡片
                    const historyCard = document.createElement('div');
                    historyCard.className = 'history-card bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all';
                
                    const originalImage = task.originalUrl;
                    const resultImage = task.resultUrl;
                    const prompt = task.prompt || '垫图任务';
                    const createdAt = new Date(task.createdAt).toLocaleString('zh-CN');
                    
                    // 设置卡片内容
                    historyCard.innerHTML = `
                        <div class="relative">
                            <img src="${resultImage}" alt="结果图" class="history-thumbnail w-full h-32 object-cover" loading="lazy" 
                                 onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNTYgMTkyQzI4OC4yMDkgMTkyIDMxMiAyMTUuNzkxIDMxMiAyNDhDMzEyIDI4MC4yMDkgMjg4LjIwOSAzMDQgMjU2IDMwNEMyMjMuNzkxIDMwNCAyMDAgMjgwLjIwOSAyMDAgMjQ4QzIwMCAyMTUuNzkxIDIyMy43OTEgMTkyIDI1NiAxOTJaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0yNTYgMjI0QzI2Ni4wMDkgMjI0IDI3NCAyMzEuOTkxIDI3NCAyNDJDMjc0IDI1Mi4wMDkgMjY2LjAwOSAyNjAgMjU2IDI2MEMyNDUuOTkxIDI2MCAyMzggMjUyLjAwOSAyMzggMjQyQzIzOCAyMzEuOTkxIDI0NS45OTEgMjI0IDI1NiAyMjRaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K'; this.alt='图片加载失败';">
                        </div>
                        <div class="p-3">
                            <p class="text-sm text-gray-700 truncate" title="${prompt}">${prompt}</p>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-500">${createdAt}</span>
                                <button class="download-history-btn text-indigo-600 hover:text-indigo-800 p-1" ${!resultImage || resultImage.includes('placeholder') ? 'disabled' : ''}>
                                    <i class="ri-download-line"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // 下载按钮点击事件
                    const downloadHistoryBtn = historyCard.querySelector('.download-history-btn');
                    downloadHistoryBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // 防止触发卡片点击事件
                        if (resultImage && !resultImage.includes('placeholder')) {
                            downloadImage(resultImage, `垫图结果_${Date.now()}.png`);
                        } else {
                            alert('该图片无法下载（可能是测试数据）');
                        }
                    });
                    
                    // 将卡片添加到容器
                    historyContainer.appendChild(historyCard);
                });
                
                console.log('历史记录加载完成');
            }
            
            // 获取状态样式类
            function getStatusClass(status) {
                switch (status) {
                    case 'PENDING': return 'bg-yellow-100 text-yellow-800';
                    case 'RUNNING': return 'bg-blue-100 text-blue-800';
                    case 'SUCCEEDED': return 'bg-green-100 text-green-800';
                    case 'FAILED': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }
            
            // 获取状态文本
            function getStatusText(status) {
                switch (status) {
                    case 'PENDING': return '排队中';
                    case 'RUNNING': return getTranslation('diantu.status_running');
                    case 'SUCCEEDED': return '已完成';
                    case 'FAILED': return '失败';
                    default: return '未知';
                }
            }
            
            // 下载图片
            window.downloadImage = function(url, filename) {
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
            };
            
            // 保存到下载中心
            window.saveToDownloadCenter = async function(originalUrl, resultUrl, prompt, taskStatus = 'SUCCEEDED') {
                try {
                    console.log('保存到下载中心 - 开始');
                    console.log('原始图片URL:', originalUrl ? originalUrl.substring(0, 50) + '...' : '无');
                    console.log('结果图片URL:', resultUrl ? resultUrl.substring(0, 50) + '...' : '无');
                    
                    if (!resultUrl) {
                        throw new Error('结果图片URL不能为空');
                    }
                    
                    // 检查是否是OSS URL
                    const isOssUrl = resultUrl.includes('aliyuncs.com');
                    console.log('是否为OSS URL:', isOssUrl);
                    
                    // 检查URL长度，如果过长则进行处理
                    const maxUrlLength = 2000; // 设置最大URL长度
                    let processedOriginalUrl = originalUrl;
                    let processedResultUrl = resultUrl;
                    
                    if (originalUrl && originalUrl.length > maxUrlLength) {
                        console.warn('原始图片URL过长，长度:', originalUrl.length);
                        // 对于过长的URL，我们保留关键部分
                        processedOriginalUrl = originalUrl.substring(0, maxUrlLength) + '...[截断]';
                    }
                    
                    if (resultUrl && resultUrl.length > maxUrlLength) {
                        console.warn('结果图片URL过长，长度:', resultUrl.length);
                        // 对于过长的URL，我们保留关键部分
                        processedResultUrl = resultUrl.substring(0, maxUrlLength) + '...[截断]';
                    }
                    
                    const resultData = {
                        originalImageUrl: processedOriginalUrl,
                        processedImageUrl: processedResultUrl,
                        processTime: new Date().toISOString(),
                        processType: '垫图',
                        description: `垫图结果 - 提示词: ${prompt || '垫图'}`,
                        storage: isOssUrl ? 'oss' : 'local', // 添加存储类型标记
                        taskStatus: taskStatus // 使用传入的任务状态
                    };
                    
                    console.log('发送保存请求，数据:', JSON.stringify({
                        processType: resultData.processType,
                        description: resultData.description,
                        storage: resultData.storage,
                        taskStatus: resultData.taskStatus
                    }));
                    
                    // 首先尝试使用垫图专用API保存
                    try {
                        console.log('尝试使用通用API保存...');
                        // 由于垫图专用API暂时无法使用，直接使用通用API保存
                        const diantuResponse = await fetch('/api/save-result', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                            },
                            body: JSON.stringify(resultData)
                        });
                        
                        const diantuResult = await diantuResponse.json();
                        
                        if (diantuResult.success) {
                            console.log('通用API保存成功:', diantuResult);
                            alert('已成功保存到下载中心！');
                            
                            // 保存成功后，立即刷新历史记录
                            console.log('保存成功，立即刷新历史记录');
                            loadUserTasks();
                            
                            // 延迟3秒后再次刷新，确保服务器数据已更新
                            setTimeout(() => {
                                console.log('保存成功，延迟3秒后再次刷新历史记录');
                                loadUserTasks();
                            }, 3000);
                            
                            return true;
                        } else {
                            console.log('通用API保存失败:', diantuResult);
                            throw new Error(diantuResult.message || '通用API保存失败');
                        }
                    } catch (diantuError) {
                        console.error('通用API保存失败:', diantuError);
                        // 保存失败，显示错误信息
                        showToast('保存失败: ' + diantuError.message, 'error');
                    }
                    
                    // 由于我们已经尝试过通用API保存，这里不需要重复
                    return false;
                } catch (error) {
                    console.error('保存到下载中心失败:', error);
                    showToast('保存失败: ' + error.message, 'error');
                    return false;
                }
            };
            
            // 清空历史记录
            async function clearHistory() {
                if (confirm('确定要清空所有历史记录吗？此操作不可恢复。')) {
                    try {
                        console.log('开始清空历史记录...');
                        
                        // 清空OSS历史记录
                        try {
                            console.log('尝试清空OSS历史记录...');
                            const ossResponse = await fetch('/api/diantu-history/clear', {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            if (ossResponse.ok) {
                                const ossResult = await ossResponse.json();
                                console.log('清空OSS历史记录成功:', ossResult);
                            } else {
                                console.error('清空OSS历史记录失败:', await ossResponse.text());
                            }
                        } catch (ossError) {
                            console.error('清空OSS历史记录异常:', ossError);
                        }
                        
                        // 清空传统历史记录
                        try {
                            console.log('尝试清空传统历史记录...');
                            // 调用后端API清除历史记录
                            const response = await fetch('/api/diantu/history', {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error('清除历史记录失败');
                            }
                            
                            const result = await response.json();
                            console.log('清除传统历史记录成功:', result);
                        } catch (traditionalError) {
                            console.error('清空传统历史记录失败:', traditionalError);
                        }
                        
                        // 清空前端任务数组
                        tasks = [];
                        displayTasks();
                        
                        alert('历史记录已清空！');
                    } catch (error) {
                        console.error('清空历史记录失败:', error);
                        alert('清空历史记录失败: ' + error.message);
                    }
                }
            }
            
            // 绑定清空历史记录按钮
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', clearHistory);
            }
            
            // 绑定刷新历史记录按钮
            if (refreshHistoryBtn) {
                refreshHistoryBtn.addEventListener('click', function() {
                    console.log('刷新历史记录按钮被点击');
                    // 添加视觉反馈
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 150);
                    loadUserTasks();
                });
            }
            
            // 初始加载任务列表
            loadUserTasks();
            
            // 开始轮询未完成的任务
            startPollingPendingTasks();
            
            // 用户状态监听函数
            function setupUserStateListener() {
                let currentUserId = null;
                let currentAuthToken = null;
                
                // 获取当前用户ID
                function getCurrentUserId() {
                    try {
                        const userInfo = localStorage.getItem('user');
                        if (userInfo) {
                            const user = JSON.parse(userInfo);
                            return user.id || user.phone || 'unknown';
                        }
                    } catch (error) {
                        console.error('获取用户ID失败:', error);
                    }
                    return null;
                }
                
                // 检查用户状态变化
                function checkUserState() {
                    const newUserId = getCurrentUserId();
                    const newAuthToken = localStorage.getItem('authToken');
                    
                    // 如果是第一次检查，记录当前状态
                    if (currentUserId === null) {
                        currentUserId = newUserId;
                        currentAuthToken = newAuthToken;
                        console.log('垫图页面：初始化用户状态监听，当前用户:', currentUserId);
                        return;
                    }
                    
                    // 检查用户ID或认证令牌是否发生变化
                    if (newUserId !== currentUserId || newAuthToken !== currentAuthToken) {
                        console.log('垫图页面：检测到用户切换，清除历史记录');
                        console.log('原用户:', currentUserId, '新用户:', newUserId);
                        
                        // 清除任务数组
                        tasks = [];
                        
                        // 清空历史记录显示
                        if (historyContainer) {
                            historyContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">暂无历史记录</p>';
                        }
                        
                        // 更新当前用户状态
                        currentUserId = newUserId;
                        currentAuthToken = newAuthToken;
                        
                        // 重新加载新用户的历史记录
                        if (newUserId && newAuthToken) {
                            console.log('垫图页面：重新加载新用户的历史记录');
                            loadUserTasks();
                        }
                    }
                }
                
                // 定期检查用户状态（每2秒检查一次）
                setInterval(checkUserState, 2000);
                
                // 监听localStorage变化
                window.addEventListener('storage', function(e) {
                    if (e.key === 'user' || e.key === 'authToken') {
                        console.log('垫图页面：检测到localStorage变化，重新检查用户状态');
                        setTimeout(checkUserState, 100);
                    }
                });
                
                // 监听页面焦点变化（用户可能在其他标签页切换账号）
                window.addEventListener('focus', function() {
                    console.log('垫图页面：页面获得焦点，检查用户状态');
                    setTimeout(checkUserState, 100);
                });
                
                console.log('垫图页面：用户状态监听已启动');
            }
            
            // 开始轮询未完成的任务
            function startPollingPendingTasks() {
                // 清除所有现有的轮询
                Object.keys(pollingIntervals).forEach(taskId => {
                    clearInterval(pollingIntervals[taskId]);
                    delete pollingIntervals[taskId];
                });
                
                // 为每个未完成的任务开始轮询
                tasks.forEach(task => {
                    if (task.status === 'PENDING' || task.status === 'RUNNING') {
                        startPollingTask(task.taskId);
                    }
                });
            }
            
            // 开始轮询单个任务
            function startPollingTask(taskId) {
                if (pollingIntervals[taskId]) {
                    clearInterval(pollingIntervals[taskId]);
                }
                
                const pollFunction = async () => {
                    try {
                        const response = await fetch(`/api/diantu/task/${taskId}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error('获取任务状态失败');
                        }
                        
                        const data = await response.json();
                        const task = data.task;
                        
                        // 更新任务列表中的任务状态
                        const taskIndex = tasks.findIndex(t => t.taskId === taskId);
                        if (taskIndex !== -1) {
                            tasks[taskIndex] = task;
                        }
                        
                    // 如果任务完成，停止轮询
                    if (task.status === 'SUCCEEDED' || task.status === 'FAILED') {
                        clearInterval(pollingIntervals[taskId]);
                        delete pollingIntervals[taskId];
                        
                        console.log('任务状态变为完成或失败，任务ID:', taskId);
                        console.log('当前任务状态:', task.status);
                        
                        // 如果API返回了最新的历史记录，直接使用它更新任务列表
                        if (data.latestHistory && Array.isArray(data.latestHistory)) {
                            console.log('收到最新的历史记录，立即更新任务列表');
                            tasks = data.latestHistory;
                            displayTasks();
                            
                            // 延迟2秒后再次加载，确保历史记录完全更新
                            setTimeout(() => {
                                console.log('延迟2秒后再次加载历史记录');
                                loadUserTasks();
                            }, 2000);
                        } else {
                            // 否则重新加载任务列表
                            console.log('未收到最新历史记录，立即显示当前任务列表');
                            displayTasks();
                            
                            // 立即加载一次历史记录
                            console.log('立即加载历史记录');
                            loadUserTasks();
                            
                            // 延迟3秒后再次加载，确保历史记录完全更新
                            setTimeout(() => {
                                console.log('延迟3秒后再次加载历史记录');
                                loadUserTasks();
                            }, 3000);
                        }
                            
                            // 如果是当前任务完成，显示结果
                            if (taskId === window.currentTaskId) {
                                if (task.status === 'SUCCEEDED') {
                                    showResults({
                                        imageUrl: task.resultUrl,
                                        originalUrl: task.originalUrl
                                    });
                                } else {
                                    hideLoadingOverlay();
                                    alert(`${getTranslation('diantu.task_processing_failed')}: ${task.errorMessage || getTranslation('diantu.unknown_error')}`);
                                }
                                window.currentTaskId = null;
                            }
                        }
                    } catch (error) {
                        console.error('轮询任务状态失败:', error);
                    }
                };
                
                // 立即执行一次，然后每2秒轮询一次
                pollFunction();
                pollingIntervals[taskId] = setInterval(pollFunction, 2000);
            }
            
            // 保存垫图历史记录到新的OSS系统
            async function saveDiantuHistoryToOSS(originalImageUrl, resultImageUrl, prompt) {
                try {
                    console.log('开始保存垫图历史记录到OSS...');
                    console.log('原图URL:', originalImageUrl);
                    console.log('结果图URL:', resultImageUrl);
                    console.log('提示词:', prompt);
                    
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        console.warn('用户未登录，无法保存历史记录');
                        return;
                    }
                    
                    if (!resultImageUrl) {
                        console.warn('结果图片URL为空，无法保存历史记录');
                        return;
                    }
                    
                    const historyData = {
                        originalImage: originalImageUrl || '',
                        resultImage: resultImageUrl,
                        prompt: prompt || '垫图',
                        metadata: {
                            processType: '垫图',
                            timestamp: new Date().toISOString()
                        }
                    };
                    
                    const response = await fetch('/api/diantu-history/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(historyData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('垫图历史记录保存成功:', result.message);
                        // 刷新历史记录显示
                        await loadUserTasks();
                    } else {
                        console.error('垫图历史记录保存失败:', result.message);
                    }
                } catch (error) {
                    console.error('保存垫图历史记录到OSS失败:', error);
                }
            }

            // 加载导航栏组件
            try {
                const response = await fetch('/components/navbar-simple.html');
                const navbarHtml = await response.text();
                document.getElementById('navbar-simple').innerHTML = navbarHtml;
                
                // 加载组件脚本
                const script = document.createElement('script');
                script.src = '/components/components.js';
                document.head.appendChild(script);
            } catch (error) {
                console.error('Failed to load navbar component:', error);
            }
        });
    </script>
</body>
</html>
