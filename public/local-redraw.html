<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="local_redraw.page_title">å±€éƒ¨é‡ç»˜ - è¤ç«AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" onerror="this.onerror=null;this.href='data:text/css;base64,'">
    <link href="/components/styles.css" rel="stylesheet">
    <link href="/css/local-redraw.css" rel="stylesheet">
    <script src="/js/auth-check.js"></script>
    <script src="/js/mobile-guard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/local-redraw-history.js"></script>
    <script src="/translations.js"></script>
    <script>
        // æ£€æµ‹ Remixicon æ˜¯å¦åŠ è½½æˆåŠŸ
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ Remixicon å­—ä½“æ˜¯å¦åŠ è½½æˆåŠŸ
            setTimeout(function() {
                const testIcon = document.createElement('i');
                testIcon.className = 'ri-upload-line';
                testIcon.style.position = 'absolute';
                testIcon.style.left = '-9999px';
                testIcon.style.fontSize = '16px';
                document.body.appendChild(testIcon);
                
                const computedStyle = window.getComputedStyle(testIcon);
                const fontFamily = computedStyle.getPropertyValue('font-family');
                
                // å¦‚æœå­—ä½“åŠ è½½å¤±è´¥ï¼Œæ·»åŠ å¤‡ç”¨ç±»
                if (!fontFamily.includes('remixicon') || fontFamily.includes('serif')) {
                    document.body.classList.add('remixicon-failed');
                    console.log('Remixicon å­—ä½“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨å›¾æ ‡');
                }
                
                document.body.removeChild(testIcon);
            }, 1000);
        });
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        /* å¤‡ç”¨å›¾æ ‡æ ·å¼ï¼Œå½“ Remixicon åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨ */
        .icon-fallback {
            display: inline-block;
            width: 1em;
            height: 1em;
            background-color: currentColor;
            mask-size: contain;
            mask-repeat: no-repeat;
            mask-position: center;
        }
        
        .icon-upload::before {
            content: "ğŸ“";
        }
        
        .icon-download::before {
            content: "â¬‡ï¸";
        }
        
        .icon-refresh::before {
            content: "ğŸ”„";
        }
        
        .icon-close::before {
            content: "âœ•";
        }
        
        /* å½“ Remixicon åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ ·å¼ */
        body.remixicon-failed .ri-upload-line::before {
            content: "ğŸ“";
        }
        
        body.remixicon-failed .ri-download-line::before {
            content: "â¬‡ï¸";
        }
        
        body.remixicon-failed .ri-refresh-line::before {
            content: "ğŸ”„";
        }
        
        body.remixicon-failed .ri-close-line::before {
            content: "âœ•";
        }
        
        body.remixicon-failed .ri-image-line::before {
            content: "ğŸ–¼ï¸";
        }
        
        body.remixicon-failed .ri-settings-line::before {
            content: "âš™ï¸";
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .feature-card {
            background-color: white;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        @keyframes firefly-glow {
            0% { text-shadow: 0 0 3px rgba(99, 102, 241, 0.5); }
            50% { text-shadow: 0 0 10px rgba(99, 102, 241, 0.8), 0 0 15px rgba(99, 102, 241, 0.3); }
            100% { text-shadow: 0 0 3px rgba(99, 102, 241, 0.5); }
        }
        .logo-text {
            animation: firefly-glow 3s infinite;
        }
        .logo-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #6366f1;
            border-radius: 50%;
            margin-left: 2px;
            margin-right: 4px;
            position: relative;
            top: -2px;
        }
        .image-preview {
            aspect-ratio: 16/9;
            background-color: #f3f4f6;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 5px solid rgba(99, 102, 241, 0.2);
            border-top-color: rgba(99, 102, 241, 1);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .redraw-task {
            transition: all 0.3s ease;
        }
        .active-option {
            background-color: #ede9fe;
            border-color: #6366f1;
            color: #4f46e5;
        }
        
        .history-card {
            transition: all 0.3s ease;
        }
        
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .history-thumbnail {
            transition: transform 0.3s ease;
        }
        
        .history-card:hover .history-thumbnail {
            transform: scale(1.05);
        }
        
        .history-card .download-history-btn {
            transition: all 0.2s ease;
        }
        
        .history-card .download-history-btn:hover {
            color: #4f46e5 !important;
            transform: scale(1.1);
        }
        
        #history-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        /* æ»‘å—æ ·å¼è‡ªå®šä¹‰ */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: linear-gradient(to right, #4f46e5, #818cf8);
            border-radius: 10px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #ffffff;
            border: 2px solid #4f46e5;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #ffffff;
            border: 2px solid #4f46e5;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        /* è‡ªå®šä¹‰é¼ æ ‡æŒ‡é’ˆ */
        .brush-cursor {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            background-color: rgba(255, 255, 255, 0.2);
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 10;
            display: none; /* é»˜è®¤éšè— */
            box-shadow: 0 0 0 1px #000;
        }
        /* ç¦ç”¨å›¾ç‰‡æ‹–åŠ¨ */
        img {
            -webkit-user-drag: none;
            user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        .drawing-area {
            position: relative;
            overflow: hidden;
        }
        #drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            z-index: 10;
        }
    </style>

    <link rel="icon" href="/images/favicon.png" type="image/png">
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- å¯¼èˆªæ ç»„ä»¶å®¹å™¨ -->
    <div id="navbar-simple"></div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="container mx-auto py-8 px-4" style="margin-top: 60px;">
        <h1 class="text-3xl font-bold text-center mb-8" data-translate="local_redraw.main_title">å±€éƒ¨é‡ç»˜</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- å·¦ä¾§é¢æ¿: å›¾ç‰‡ä¸Šä¼ å’Œè®¾ç½® -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4" data-translate="local_redraw.settings_title">å±€éƒ¨é‡ç»˜è®¾ç½®</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="local_redraw.image_upload">å›¾ç‰‡ä¸Šä¼ </label>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700" data-translate="local_redraw.upload_description">ä¸Šä¼ éœ€è¦é‡ç»˜çš„å›¾ç‰‡</span>
                    </div>
                    <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-400 transition-colors cursor-pointer bg-gray-50">
                        <input type="file" id="image-upload" class="hidden" accept="image/*">
                        <div id="upload-placeholder">
                            <i class="ri-upload-cloud-2-line text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500"><span data-translate="local_redraw.drag_drop_text">æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤å¤„æˆ–</span> <span class="text-indigo-600 font-medium" data-translate="local_redraw.click_upload">ç‚¹å‡»ä¸Šä¼ </span></p>
                            <p class="text-sm text-gray-400 mt-1" data-translate="local_redraw.supported_formats">æ”¯æŒ JPG, PNG, WEBP, GIF, BMP æ ¼å¼</p>
                        </div>
                        <div id="preview-container" class="hidden">
                            <img id="image-preview" class="max-h-48 mx-auto mb-3">
                            <p id="image-info" class="text-sm text-gray-500"></p>
                            <button type="button" id="remove-image" class="mt-2 text-sm text-red-500 hover:text-red-700" data-translate="local_redraw.remove_image">
                                ç§»é™¤å›¾ç‰‡
                            </button>
                        </div>
                    </div>
                    <p class="mt-1 text-xs text-gray-500" data-translate="local_redraw.size_requirements">å›¾ç‰‡å°ºå¯¸æœ€å°ä¸º512Ã—512pxï¼Œæœ€å¤§ä¸è¶…è¿‡4000px</p>
                </div>
                
                <div class="mb-6">
                    <label for="brush-size" class="block text-sm font-medium text-gray-700 mb-1" data-translate="local_redraw.brush_size">ç”»ç¬”ç²—ç»†</label>
                    <input type="range" id="brush-size" min="5" max="50" value="15" class="w-full" />
                    <div class="flex justify-between mt-1">
                        <span class="text-xs text-gray-500" data-translate="local_redraw.brush_thin">ç»†</span>
                        <span class="text-xs text-gray-500" data-translate="local_redraw.brush_thick">ç²—</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" data-translate="local_redraw.brush_tip">è°ƒæ•´ç”»ç¬”å¤§å°æ¥ç²¾ç¡®æ¶‚æŠ¹éœ€è¦é‡ç»˜çš„åŒºåŸŸ</p>
                </div>
                
                <div class="mb-6">
                    <label for="prompt-input" class="block text-sm font-medium text-gray-700 mb-1" data-translate="local_redraw.prompt_label">é‡ç»˜æç¤ºè¯</label>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700" data-translate="local_redraw.prompt_description">æè¿°é‡ç»˜å†…å®¹</span>
                    </div>
                    <textarea id="prompt-input" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" data-translate="local_redraw.prompt_placeholder" placeholder="è¯·è¾“å…¥æç¤ºè¯ï¼Œå¦‚: ç»™å›¾ç‰‡ä¸­çš„äººç‰©æ·»åŠ ä¸€ä¸ªé»„è‰²å£ç½©"></textarea>
                    <p class="mt-1 text-xs text-gray-500" data-translate="local_redraw.prompt_tip">è¯¦ç»†æè¿°é‡ç»˜å†…å®¹å¯ä»¥è·å¾—æ›´å¥½çš„æ•ˆæœ</p>
                </div>
                
                <div class="pt-4">
                    <button id="generate-btn" class="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ri-magic-line mr-2"></i>
                        <span data-translate="local_redraw.start_redraw">å¼€å§‹é‡ç»˜</span>
                    </button>
                    <p class="mt-2 text-center text-sm text-gray-500" data-translate="local_redraw.time_cost_info">
                        å±€éƒ¨é‡ç»˜éœ€è¦5-10ç§’ï¼Œæ¶ˆè€—7ç§¯åˆ†
                    </p>
                    <p class="mt-2 text-center text-sm text-red-500 font-medium" data-translate="local_redraw.compliance_warning">
                        è¯·ä¸Šä¼ åˆæ³•åˆè§„çš„å›¾ç‰‡ï¼Œå¦‚æœ‰è¿åä¼šè¿›è¡Œå°å·å¤„ç†ï¼Œä»»åŠ¡ä¸€æ—¦æäº¤å°±ä¼šæ‰£é™¤ç§¯åˆ†ä¸å¯ä¸­æ–­ï¼Œè¯·å‹¿é‡å¤åˆ·æ–°æäº¤ï¼Œå¦åˆ™ä¼šé€ æˆç§¯åˆ†æµªè´¹ã€‚
                    </p>
                </div>
            </div>
            
            <!-- å³ä¾§é¢æ¿: é¢„è§ˆå’Œå†å²è®°å½• -->
            <div class="lg:col-span-3">
                <!-- ç»˜å›¾åŒºåŸŸ -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h2 class="text-xl font-bold mb-4" data-translate="local_redraw.drawing_area">ç»˜å›¾åŒºåŸŸ</h2>
                    <div id="original-image-container" class="image-preview flex items-center justify-center border border-gray-200 rounded-md overflow-hidden relative drawing-area">
                        <img id="original-image" class="hidden max-w-full max-h-full object-contain" alt="ä¸Šä¼ çš„å›¾ç‰‡" draggable="false">
                        <canvas id="drawing-canvas" class="absolute top-0 left-0 hidden"></canvas>
                        <div id="brush-cursor" class="brush-cursor"></div>
                        <div id="original-image-placeholder" class="text-center p-6">
                            <i class="ri-image-line text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500" data-translate="local_redraw.image_display_placeholder">æ‚¨ä¸Šä¼ çš„å›¾ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                        </div>
                        </div>
                    <!-- æ¶‚æŠ¹æç¤º - ç§»åˆ°å›¾ç‰‡å®¹å™¨å¤–éƒ¨ï¼Œåœ¨å›¾ç‰‡ä¸‹æ–¹ -->
                    <div id="drawing-instructions" class="mt-2 text-sm text-gray-600 bg-blue-50 border border-blue-200 rounded-md p-3 hidden">
                        <div class="flex items-start">
                            <i class="ri-information-line text-blue-500 mr-2 mt-0.5 flex-shrink-0"></i>
                            <div>
                                <p class="font-medium text-blue-800 mb-1" data-translate="local_redraw.usage_instructions">ä½¿ç”¨è¯´æ˜ï¼š</p>
                                <p data-translate="local_redraw.drawing_instructions">è¯·ç”¨é¼ æ ‡åœ¨éœ€è¦é‡ç»˜çš„åŒºåŸŸä¸Šæ¶‚æŠ¹ - è¿™äº›åŒºåŸŸå°†è¢«é‡æ–°ç”Ÿæˆ</p>
                                <p class="text-xs text-blue-600 mt-1" data-translate="local_redraw.refresh_tip">å¦‚æœæ— æ³•æ¶‚æŠ¹ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•</p>
                    </div>
                        </div>
                    </div>
                    <div class="mt-2 flex justify-end">
                        <button id="clear-mask-btn" class="hidden text-indigo-600 hover:text-indigo-800 text-sm flex items-center">
                            <i class="ri-eraser-line mr-1"></i>
                            <span data-translate="local_redraw.clear_mask">æ¸…é™¤æ¶‚æŠ¹</span>
                        </button>
                    </div>
                </div>
                
                <!-- å¤„ç†ç»“æœåŒºåŸŸ -->
                <div id="resultContainer" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
                    <h2 class="text-xl font-bold mb-4" data-translate="local_redraw.processing_result">å¤„ç†ç»“æœ</h2>
                    
                    <div class="flex flex-col md:flex-row gap-6 mb-6">
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-700 mb-2" data-translate="local_redraw.original_image">åŸå§‹å›¾ç‰‡</h3>
                            <div class="border border-gray-200 rounded-lg p-2 bg-gray-50">
                                <img id="result-original-image" class="max-w-full max-h-64 mx-auto">
                                <p id="result-original-info" class="text-sm text-gray-500 mt-2 text-center"></p>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-700 mb-2" data-translate="local_redraw.redrawn_image">é‡ç»˜åå›¾ç‰‡</h3>
                            <div id="result-image-wrapper" class="border border-gray-200 rounded-lg p-2 bg-gray-50">
                                <img id="result-image" class="max-w-full max-h-64 mx-auto hidden">
                                <div id="result-image-placeholder" class="text-center p-6">
                                    <i class="ri-image-line text-4xl text-gray-300 mb-2"></i>
                                    <p class="text-gray-500 text-sm" data-translate="local_redraw.result_placeholder">é‡ç»˜ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                                </div>
                                <p id="result-image-info" class="text-sm text-gray-500 mt-2 text-center"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3">
                        <button type="button" id="download-btn" class="inline-flex items-center px-4 py-2 border border-indigo-600 text-indigo-600 bg-white rounded-md hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="ri-download-2-line mr-1"></i>
                            <span data-translate="local_redraw.download_image">ä¸‹è½½å›¾ç‰‡</span>
                        </button>
                        <button type="button" id="save-to-downloads-btn" class="inline-flex items-center px-4 py-2 border border-indigo-600 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="ri-save-line mr-1"></i>
                            <span data-translate="local_redraw.save">ä¿å­˜</span>
                        </button>
                        <button type="button" id="new-redraw-btn" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="ri-add-line mr-1"></i>
                            <span data-translate="local_redraw.upload_new_image">ä¸Šä¼ æ–°å›¾ç‰‡</span>
                        </button>
                    </div>
                </div>
                
                <!-- ç”Ÿæˆå†å²éƒ¨åˆ† -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold" data-translate="local_redraw.generation_history">ç”Ÿæˆå†å²</h2>
                        <div class="flex space-x-2">
                            <button id="clear-history-btn" class="text-gray-500 hover:text-red-600" data-translate="local_redraw.clear_history" title="æ¸…ç©ºå†å²è®°å½•">
                                <i class="ri-delete-bin-line text-xl"></i>
                            </button>
                            <button id="refresh-history-btn" class="text-indigo-600 hover:text-indigo-800" data-translate="local_redraw.refresh_history" title="åˆ·æ–°å†å²è®°å½•">
                                <i class="ri-refresh-line text-xl"></i>
                        </button>
                    </div>
                        </div>
                    
                    <div id="history-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <!-- å†å²è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                        <p class="text-gray-500 col-span-full text-center py-4" data-translate="local_redraw.no_history">æš‚æ— å†å²è®°å½•</p>
                    </div>
                    
                    <!-- ä¿å­˜æ—¶é—´æç¤º -->
                    <p class="text-xs text-gray-400 mt-3 text-center" data-translate="local_redraw.history_time_limit">ä»…æ˜¾ç¤º24å°æ—¶å†…çš„å†å²è®°å½•</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½ä¸­é®ç½© -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loading-spinner mb-4"></div>
            <p id="loading-message" class="text-lg font-medium" data-translate="local_redraw.processing_message">å±€éƒ¨é‡ç»˜ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...</p>
            <p class="text-sm text-gray-500 mt-2" data-translate="local_redraw.processing_time">å±€éƒ¨é‡ç»˜éœ€è¦5-10ç§’</p>
        </div>
    </div>

    <!-- å¼•ç”¨å¤–éƒ¨Javascriptæ–‡ä»¶ -->
    <script>
        // å…¨å±€å˜é‡ - éœ€è¦åœ¨DOMåŠ è½½å‰å®šä¹‰
        let history = [];
        
        // ç¿»è¯‘å‡½æ•° - ä½¿ç”¨å…¨å±€çš„translateå‡½æ•°
        function t(key) {
            // å¦‚æœtranslateå‡½æ•°å­˜åœ¨ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            if (typeof translate === 'function') {
                return translate(key);
            }
            const lang = localStorage.getItem('language') || 'zh';
            return translations[lang] && translations[lang][key] ? translations[lang][key] : key;
        }
        let pollingIntervals = {};
        let historyContainer = null;
        
        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('å…¨å±€é”™è¯¯:', e.error);
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', e.reason);
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            // DOMå…ƒç´ 
            const uploadArea = document.getElementById('upload-area');
            const imageUpload = document.getElementById('image-upload');
            const originalImage = document.getElementById('original-image');
            const originalImageContainer = document.getElementById('original-image-container');
            const originalImagePlaceholder = document.getElementById('original-image-placeholder');
            const drawingCanvas = document.getElementById('drawing-canvas');
            const drawingInstructions = document.getElementById('drawing-instructions');
            const clearMaskBtn = document.getElementById('clear-mask-btn');
            const resultImage = document.getElementById('result-image');
            const resultImagePlaceholder = document.getElementById('result-image-placeholder');
            const generateBtn = document.getElementById('generate-btn');
            const promptInput = document.getElementById('prompt-input');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            const downloadBtn = document.getElementById('download-btn');
            const userMenuBtn = document.getElementById('user-menu-btn');
            const loginBtn = document.getElementById('login-btn');
            const saveToDownloadsBtn = document.getElementById('save-to-downloads-btn');
            const brushSizeSlider = document.getElementById('brush-size');
            const brushCursor = document.getElementById('brush-cursor');
            const newRedrawBtn = document.getElementById('new-redraw-btn');
            const resultContainer = document.getElementById('resultContainer');
            const resultOriginalImage = document.getElementById('result-original-image');
            const resultOriginalInfo = document.getElementById('result-original-info');
            const resultImageInfo = document.getElementById('result-image-info');
            const refreshHistoryBtn = document.getElementById('refresh-history-btn');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            historyContainer = document.getElementById('history-container'); // èµ‹å€¼ç»™å…¨å±€å˜é‡
            
            // ç»˜å›¾å˜é‡
            let isDrawing = false;
            let startX, startY;
            let rect = null;
            const ctx = drawingCanvas.getContext('2d');
            let maskPaths = []; // ç”¨äºå­˜å‚¨æ¶‚æŠ¹è·¯å¾„
            let brushSize = 15; // é»˜è®¤ç”»ç¬”å¤§å°
            
            // é€€æ¬¾è¯·æ±‚å‡½æ•°
            async function requestRefund(taskId, reason) {
                console.log(`å‡†å¤‡è¯·æ±‚é€€æ¬¾ï¼Œä»»åŠ¡ID: ${taskId}, åŸå› : ${reason}`);
                try {
                    const response = await fetch('/api/refund/local-redraw', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            taskId: taskId,
                            reason: reason
                        })
                    });
                    
                    const data = await response.json();
                    console.log('é€€æ¬¾è¯·æ±‚å“åº”:', data);
                    
                    if (data.success) {
                        console.log('é€€æ¬¾è¯·æ±‚æˆåŠŸ');
                        return true;
                    } else if (data.message && data.message.includes('å·²ç»é€€æ¬¾')) {
                        // å·²ç»é€€æ¬¾è¿‡çš„æƒ…å†µä¹Ÿç®—æˆåŠŸ
                        console.log('è¯¥ä»»åŠ¡å·²ç»é€€æ¬¾è¿‡');
                        return true;
                    } else {
                        console.warn('é€€æ¬¾è¯·æ±‚å¤±è´¥:', data.message);
                        return false;
                    }
                } catch (error) {
                    console.error('å‘é€é€€æ¬¾è¯·æ±‚æ—¶å‡ºé”™:', error);
                    throw error;
                }
            }
            
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            initializeUserUI();
            
            // åˆå§‹åŒ–å†å²è®°å½•åŠŸèƒ½
            initializeHistoryFeatures();
            
            // å»¶è¿ŸåŠ è½½å†å²è®°å½•ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
            setTimeout(() => {
                loadHistory();
            }, 1000);
            
            // é¡µé¢åŠ è½½æ—¶åº”ç”¨å½“å‰è¯­è¨€è®¾ç½®
            setTimeout(() => {
                if (typeof updatePageText === 'function') {
                    updatePageText();
                }
            }, 500);
            
            // ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶ï¼Œè·Ÿéšhomeé¡µé¢çš„è¯­è¨€é€‰æ‹©
            document.addEventListener('languageChanged', function(event) {
                console.log('è§†é¢‘é£æ ¼é‡ç»˜é¡µé¢ï¼šæ£€æµ‹åˆ°è¯­è¨€å˜åŒ–', event.detail);
                // æ›´æ–°é¡µé¢æ–‡æœ¬
                if (typeof updatePageText === 'function') {
                    updatePageText();
                }
                // é‡æ–°åŠ è½½å†å²è®°å½•ï¼ˆå› ä¸ºå†å²è®°å½•ä¸­çš„æ–‡æœ¬ä¹Ÿéœ€è¦æ›´æ–°ï¼‰
                setTimeout(() => {
                    loadHistory();
                }, 100);
            });
            
            // ç›‘å¬storageäº‹ä»¶ï¼ˆå¤„ç†è·¨æ ‡ç­¾é¡µè¯­è¨€åˆ‡æ¢ï¼‰
            window.addEventListener('storage', function(e) {
                if (e.key === 'language') {
                    console.log('è§†é¢‘é£æ ¼é‡ç»˜é¡µé¢ï¼šæ£€æµ‹åˆ°localStorageè¯­è¨€å˜åŒ–', e.newValue);
                    // æ›´æ–°é¡µé¢æ–‡æœ¬
                    if (typeof updatePageText === 'function') {
                        updatePageText();
                    }
                    // é‡æ–°åŠ è½½å†å²è®°å½•
                    setTimeout(() => {
                        loadHistory();
                    }, 100);
                }
            });
            
            // è®¾ç½®ç”»ç¬”å¤§å°å’Œå…‰æ ‡æ˜¾ç¤º
            brushSizeSlider.addEventListener('input', (e) => {
                brushSize = parseInt(e.target.value);
                updateBrushCursor();
            });
            
            function updateBrushCursor() {
                brushCursor.style.width = `${brushSize}px`;
                brushCursor.style.height = `${brushSize}px`;
            }
            
            // å®šä¹‰å›¾åƒå’Œç”»å¸ƒçš„ä½ç½®å…³ç³»å˜é‡
            let canvasOffsetX = 0;
            let canvasOffsetY = 0;
            let canvasWidth = 0;
            let canvasHeight = 0;
            let imageWidth = 0;
            let imageHeight = 0;
            
            // æ›´æ–°å›¾åƒå’Œç”»å¸ƒçŠ¶æ€
            function updateImageAndCanvasState() {
                if (!originalImage.complete || originalImage.naturalWidth === 0) return;
                
                // è·å–å®¹å™¨å°ºå¯¸
                const containerWidth = originalImageContainer.clientWidth;
                const containerHeight = originalImageContainer.clientHeight;
                
                // è®¡ç®—å›¾åƒçš„æ˜¾ç¤ºå°ºå¯¸ï¼Œä¿æŒåŸå§‹æ¯”ä¾‹
                const imgRatio = originalImage.naturalWidth / originalImage.naturalHeight;
                let displayWidth, displayHeight;
                
                if (containerWidth / containerHeight > imgRatio) {
                    displayHeight = containerHeight;
                    displayWidth = displayHeight * imgRatio;
                } else {
                    displayWidth = containerWidth;
                    displayHeight = displayWidth / imgRatio;
                }
                
                // è®¾ç½®å›¾åƒçš„æ˜¾ç¤ºå°ºå¯¸
                imageWidth = Math.floor(displayWidth);
                imageHeight = Math.floor(displayHeight);
                
                // è®¡ç®—ç”»å¸ƒåº”è¯¥åœ¨å®¹å™¨ä¸­çš„ä½ç½®ï¼ˆå±…ä¸­ï¼‰
                canvasOffsetX = Math.floor((containerWidth - imageWidth) / 2);
                canvasOffsetY = Math.floor((containerHeight - imageHeight) / 2);
                
                // è®¾ç½®ç”»å¸ƒçš„å¤§å°å’Œä½ç½®
                drawingCanvas.width = imageWidth;
                drawingCanvas.height = imageHeight;
                drawingCanvas.style.width = `${imageWidth}px`;
                drawingCanvas.style.height = `${imageHeight}px`;
                drawingCanvas.style.left = `${canvasOffsetX}px`;
                drawingCanvas.style.top = `${canvasOffsetY}px`;
                canvasWidth = imageWidth;
                canvasHeight = imageHeight;
                
                console.log("Canvas dimensions updated:", 
                    { width: canvasWidth, height: canvasHeight, 
                      offsetX: canvasOffsetX, offsetY: canvasOffsetY,
                      containerWidth, containerHeight });
            }
            
            // æ›´æ–°ç”»ç¬”å…‰æ ‡ä½ç½®
            originalImageContainer.addEventListener('mousemove', (e) => {
                const rect = originalImageContainer.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨å›¾åƒåŒºåŸŸå†…
                if (mouseX >= canvasOffsetX && 
                    mouseX <= canvasOffsetX + canvasWidth && 
                    mouseY >= canvasOffsetY && 
                    mouseY <= canvasOffsetY + canvasHeight) {
                    
                    // è®¾ç½®å…‰æ ‡ä½ç½®ï¼Œä¸é¼ æ ‡ä½ç½®åŒæ­¥
                    brushCursor.style.left = `${mouseX}px`;
                    brushCursor.style.top = `${mouseY}px`;
                    brushCursor.style.display = 'block';
                } else {
                    brushCursor.style.display = 'none';
                }
            });
            
            // é¼ æ ‡ç¦»å¼€å®¹å™¨æ—¶éšè—å…‰æ ‡
            originalImageContainer.addEventListener('mouseleave', () => {
                brushCursor.style.display = 'none';
            });
            
            // å›¾ç‰‡ä¸Šä¼ å¤„ç†
            uploadArea.addEventListener('click', () => {
                imageUpload.click();
            });
            
            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleImageFile(file);
                }
            });
            
            // ç»˜å›¾ç›¸å…³äº‹ä»¶ - ç»Ÿä¸€ç»‘å®šåˆ°ç”»å¸ƒä¸Š
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', handleMouseMove);
            drawingCanvas.addEventListener('mouseup', endDrawing);
            drawingCanvas.addEventListener('mouseleave', endDrawing);
            
            function startDrawing(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // ç¡®ä¿ç”»å¸ƒå·²åˆå§‹åŒ–
                if (!drawingCanvas.width || !drawingCanvas.height) {
                    console.warn('ç”»å¸ƒæœªåˆå§‹åŒ–ï¼Œæ— æ³•å¼€å§‹ç»˜åˆ¶');
                    return;
                }
                
                isDrawing = true;
                
                // è·å–ç›¸å¯¹äºç”»å¸ƒçš„ä½ç½®
                const rect = drawingCanvas.getBoundingClientRect();
                startX = e.clientX - rect.left;
                startY = e.clientY - rect.top;
                
                // ç¡®ä¿åæ ‡ä¸è¶…å‡ºç”»å¸ƒèŒƒå›´
                startX = Math.max(0, Math.min(startX, canvasWidth));
                startY = Math.max(0, Math.min(startY, canvasHeight));
                
                // è®¾ç½®ç»˜åˆ¶æ ·å¼
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = brushSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                // ç»˜åˆ¶èµ·å§‹ç‚¹
                ctx.beginPath();
                ctx.arc(startX, startY, brushSize/2, 0, Math.PI * 2);
                ctx.fill();
                
                // å¼€å§‹æ–°çš„è·¯å¾„
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                
                // è®°å½•è·¯å¾„
                maskPaths.push({type: 'start', x: startX, y: startY});
                
                console.log('å¼€å§‹ç»˜åˆ¶ï¼Œä½ç½®:', startX, startY, 'ç”»ç¬”å¤§å°:', brushSize);
            }
            
            function handleMouseMove(e) {
                // éç»˜åˆ¶çŠ¶æ€ä¸‹ä¸å¤„ç†
                if (!isDrawing) return;
                
                // ç¡®ä¿ç”»å¸ƒå·²åˆå§‹åŒ–
                if (!drawingCanvas.width || !drawingCanvas.height) return;
                
                // è·å–ç›¸å¯¹äºç”»å¸ƒçš„åæ ‡
                const rect = drawingCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // ç¡®ä¿åæ ‡ä¸è¶…å‡ºç”»å¸ƒèŒƒå›´
                const clampedX = Math.max(0, Math.min(x, canvasWidth));
                const clampedY = Math.max(0, Math.min(y, canvasHeight));
                
                // è®¾ç½®ç»˜åˆ¶æ ·å¼
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = brushSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                // ç»˜åˆ¶çº¿æ®µ
                ctx.lineTo(clampedX, clampedY);
                ctx.stroke();
                
                // è®°å½•è·¯å¾„ç‚¹
                maskPaths.push({type: 'point', x: clampedX, y: clampedY});
                
                console.log('ç»˜åˆ¶ä¸­ï¼Œä½ç½®:', clampedX, clampedY);
            }
            
            function endDrawing() {
                if (isDrawing) {
                    isDrawing = false;
                    ctx.closePath();
                    maskPaths.push({type: 'end'});
                    console.log('ç»“æŸç»˜åˆ¶ï¼Œè·¯å¾„ç‚¹æ•°é‡:', maskPaths.length);
                }
            }
            
            // æ‹–æ”¾ä¸Šä¼ 
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            uploadArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                
                if (file && file.type.startsWith('image/')) {
                    handleImageFile(file);
                } else {
                    alert(t('local_redraw.upload_image_file'));
                }
            });
            
            // æµ‹è¯•æ¶‚æŠ¹åŠŸèƒ½å·²ç§»é™¤
            
            // æ¸…é™¤æ¶‚æŠ¹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            clearMaskBtn.addEventListener('click', () => {
                if (drawingCanvas.width && drawingCanvas.height) {
                    // æ¸…é™¤ç”»å¸ƒ
                    ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                    // é‡ç½®æ¶‚æŠ¹è·¯å¾„
                    maskPaths = [];
                    console.log('å·²æ¸…é™¤æ‰€æœ‰æ¶‚æŠ¹å†…å®¹');
                }
            });
            
            // ä¸Šä¼ æ–°å›¾ç‰‡æŒ‰é’®
            newRedrawBtn.addEventListener('click', () => {
                // æ¸…ç©ºå½“å‰å›¾ç‰‡é¢„è§ˆå’Œæç¤ºè¯
                originalImage.src = '';
                originalImage.classList.add('hidden');
                
                // æ˜¾ç¤ºå ä½ç¬¦
                if (originalImagePlaceholder) {
                    originalImagePlaceholder.classList.remove('hidden');
                }
                
                promptInput.value = '';
                resultContainer.classList.add('hidden');
                downloadBtn.classList.add('hidden');
                saveToDownloadsBtn.classList.add('hidden');
                newRedrawBtn.classList.add('hidden');
                
                // æ¸…é™¤ç”»å¸ƒ
                if (drawingCanvas.width && drawingCanvas.height) {
                    ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                }
                maskPaths = [];
                
                // æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
                const leftPanel = document.querySelector('.lg\\:col-span-2');
                if (leftPanel) {
                    leftPanel.style.display = 'block';
                }
            });
            
            // ç”ŸæˆæŒ‰é’®ç‚¹å‡»
            generateBtn.addEventListener('click', async () => {
                const prompt = promptInput.value.trim();
                
                if (!originalImage.src || originalImage.classList.contains('hidden')) {
                    alert(t('local_redraw.upload_first'));
                    return;
                }
                
                if (!prompt) {
                    alert(t('local_redraw.enter_prompt'));
                    return;
                }
                
                if (maskPaths.length === 0) {
                    alert(t('local_redraw.paint_area_first'));
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½ä¸­
                loadingOverlay.classList.remove('hidden');
                loadingMessage.textContent = t('local_redraw.processing_image');
                
                try {
                    // 1. åˆ›å»ºè’™ç‰ˆå›¾åƒ - éœ€è¦ç™½è‰²åŒºåŸŸè¡¨ç¤ºé‡ç»˜éƒ¨åˆ†
                    loadingMessage.textContent = t('local_redraw.creating_mask');
                    console.log('æ­£åœ¨åˆ›å»ºè’™ç‰ˆå›¾åƒ...');
                    const maskImageData = createMaskImage();
                    if (!maskImageData) {
                        throw new Error('åˆ›å»ºè’™ç‰ˆå›¾åƒå¤±è´¥');
                    }
                    
                    // 2. ä¸Šä¼ åŸå›¾å’Œè’™ç‰ˆå›¾åˆ°æœåŠ¡å™¨è·å–URL
                    loadingMessage.textContent = t('local_redraw.uploading_image');
                    console.log('æ­£åœ¨ä¸Šä¼ åŸå›¾å’Œè’™ç‰ˆå›¾...');
                    let baseImageUrl, maskImageUrl;
                    
                    try {
                        [baseImageUrl, maskImageUrl] = await Promise.all([
                            uploadImageToServer(originalImage.src, 'base'),
                            uploadImageToServer(maskImageData, 'mask')
                        ]);
                    } catch (uploadError) {
                        console.error('å›¾ç‰‡ä¸Šä¼ é”™è¯¯:', uploadError);
                        throw new Error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${uploadError.message}`);
                    }
                    
                    if (!baseImageUrl || !maskImageUrl) {
                        throw new Error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œæœªè·å–åˆ°æœ‰æ•ˆURL');
                    }
                    
                    console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œè·å–åˆ°çš„URL:');
                    console.log('- åŸå›¾URL:', baseImageUrl);
                    console.log('- è’™ç‰ˆURL:', maskImageUrl);
                    
                    // 3. è°ƒç”¨é€šä¹‰ä¸‡ç›¸APIåˆ›å»ºå±€éƒ¨é‡ç»˜ä»»åŠ¡
                    loadingMessage.textContent = t('local_redraw.creating_task');
                    console.log('æ­£åœ¨åˆ›å»ºå±€éƒ¨é‡ç»˜ä»»åŠ¡...');
                    
                    let taskId;
                    try {
                        taskId = await createLocalRedrawTask(prompt, baseImageUrl, maskImageUrl);
                    } catch (taskError) {
                        console.error('åˆ›å»ºä»»åŠ¡é”™è¯¯:', taskError);
                        throw new Error(`åˆ›å»ºå±€éƒ¨é‡ç»˜ä»»åŠ¡å¤±è´¥: ${taskError.message}`);
                    }
                    
                    if (!taskId) {
                        throw new Error('åˆ›å»ºå±€éƒ¨é‡ç»˜ä»»åŠ¡å¤±è´¥ï¼Œæœªè·å–åˆ°ä»»åŠ¡ID');
                    }
                    
                    console.log('åˆ›å»ºä»»åŠ¡æˆåŠŸï¼Œä»»åŠ¡ID:', taskId);
                    
                    // è®¾ç½®å½“å‰ä»»åŠ¡IDï¼Œç”¨äºåç»­ç»“æœæ˜¾ç¤º
                    window.currentTaskId = taskId;
                    
                    // 4. è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    loadingMessage.textContent = t('local_redraw.processing_wait');
                    console.log('å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€...');
                    
                    let resultImageUrl;
                    try {
                        resultImageUrl = await pollTaskStatus(taskId);
                    } catch (pollError) {
                        console.error('è½®è¯¢ä»»åŠ¡çŠ¶æ€é”™è¯¯:', pollError);
                        throw new Error(`è·å–ä»»åŠ¡ç»“æœå¤±è´¥: ${pollError.message}`);
                    }
                    
                    if (!resultImageUrl) {
                        throw new Error('è·å–ç»“æœå›¾åƒå¤±è´¥ï¼Œæœªè·å–åˆ°æœ‰æ•ˆURL');
                    }
                    
                    console.log('è·å–ä»»åŠ¡ç»“æœæˆåŠŸï¼Œå›¾åƒURL:', resultImageUrl);
                    
                    // 5. æ˜¾ç¤ºç»“æœå›¾åƒ
                    loadingMessage.textContent = t('local_redraw.loading_result');
                    
                    resultImage.onload = () => {
                        loadingOverlay.classList.add('hidden');
                        
                        // è®¾ç½®åŸå§‹å›¾ç‰‡
                        resultOriginalImage.src = originalImage.src;
                        
                        // è®¾ç½®å›¾ç‰‡ä¿¡æ¯
                        resultOriginalInfo.textContent = `${t('local_redraw.original_image_info')} (${originalImage.naturalWidth}Ã—${originalImage.naturalHeight} px)`;
                        resultImageInfo.textContent = `${t('local_redraw.redrawn_image_info')} (${resultImage.naturalWidth}x${resultImage.naturalHeight})`;
                        
                        // æ˜¾ç¤ºç»“æœå®¹å™¨
                        resultContainer.classList.remove('hidden');
                    };
                    
                    resultImage.onerror = () => {
                        loadingOverlay.classList.add('hidden');
                        alert(t('local_redraw.load_result_failed'));
                    };
                    
                    resultImage.src = resultImageUrl;
                    resultImage.classList.remove('hidden');
                    if (resultImagePlaceholder) {
                    resultImagePlaceholder.classList.add('hidden');
                    }
                    downloadBtn.classList.remove('hidden');
                    saveToDownloadsBtn.classList.remove('hidden');
                    
                    // æ·»åŠ åˆ°å†å²è®°å½•
                    const promptText = promptInput.value.trim() || 'å±€éƒ¨é‡ç»˜';
                    addToHistory(originalImage.src, resultImage.src, promptText);
                } catch (error) {
                    console.error('å¤„ç†å¤±è´¥:', error);
                    // ä¼˜åŒ–é”™è¯¯æç¤ºæ–‡æœ¬
                    let errorMessage = error.message;
                    if (errorMessage.includes('æ‚¨çš„å…è´¹è¯•ç”¨æ¬¡æ•°å·²ç”¨å®Œï¼Œç§¯åˆ†ä¸è¶³')) {
                        errorMessage = errorMessage.replace('æ‚¨çš„å…è´¹è¯•ç”¨æ¬¡æ•°å·²ç”¨å®Œï¼Œç§¯åˆ†ä¸è¶³', 'æ‚¨çš„ç§¯åˆ†ä½™é¢ä¸è¶³');
                    }
                    alert(t('local_redraw.processing_failed') + ': ' + errorMessage);
                } finally {
                    // éšè—åŠ è½½é®ç½©
                    loadingOverlay.classList.add('hidden');
                }
            });
            
            // åˆ›å»ºè’™ç‰ˆå›¾åƒ - ç™½è‰²åŒºåŸŸè¡¨ç¤ºéœ€è¦é‡ç»˜çš„éƒ¨åˆ†
            function createMaskImage() {
                // åˆ›å»ºä¸´æ—¶ç”»å¸ƒï¼Œä¸åŸå§‹å›¾åƒå¤§å°ç›¸åŒ
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = originalImage.naturalWidth;
                tempCanvas.height = originalImage.naturalHeight;
                const tempCtx = tempCanvas.getContext('2d');
                
                // æ¸…é™¤ç”»å¸ƒä¸ºé»‘è‰²èƒŒæ™¯ (é»‘è‰²è¡¨ç¤ºä¸å˜çš„åŒºåŸŸ)
                tempCtx.fillStyle = 'rgb(0,0,0)';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // è®¡ç®—ç»˜åˆ¶ç”»å¸ƒä¸åŸå§‹å›¾åƒçš„æ¯”ä¾‹
                const scaleX = originalImage.naturalWidth / canvasWidth;
                const scaleY = originalImage.naturalHeight / canvasHeight;
                
                // è®¾ç½®ç»˜åˆ¶æ ·å¼
                tempCtx.strokeStyle = 'rgb(255,255,255)'; // ç™½è‰²è¡¨ç¤ºè¦é‡ç»˜çš„éƒ¨åˆ†
                tempCtx.fillStyle = 'rgb(255,255,255)';
                tempCtx.lineWidth = brushSize * Math.max(scaleX, scaleY);
                tempCtx.lineCap = 'round';
                tempCtx.lineJoin = 'round';
                
                // ç»˜åˆ¶æ‰€æœ‰è·¯å¾„
                let currentPath = null;
                for (const point of maskPaths) {
                    if (point.type === 'start') {
                        tempCtx.beginPath();
                        tempCtx.moveTo(point.x * scaleX, point.y * scaleY);
                        currentPath = point;
                    } else if (point.type === 'point' && currentPath) {
                        tempCtx.lineTo(point.x * scaleX, point.y * scaleY);
                        tempCtx.stroke();
                    } else if (point.type === 'end') {
                        tempCtx.closePath();
                        currentPath = null;
                    }
                }
                
                // è¿”å›è’™ç‰ˆå›¾åƒçš„base64æ•°æ®
                return tempCanvas.toDataURL('image/png');
            }
            
            // ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨
            async function uploadImageToServer(imageData, imageType) {
                try {
                    // è½¬æ¢ä¸ºBlobå¯¹è±¡
                    let blob;
                    if (imageData.startsWith('data:')) {
                        // ä»base64å­—ç¬¦ä¸²åˆ›å»ºBlobå¯¹è±¡
                        blob = base64ToBlob(imageData.split(',')[1], imageType === 'mask' ? 'image/png' : 'image/jpeg');
                    } else {
                        // å¤„ç†URLæƒ…å†µ - å…ˆè·å–å›¾åƒå†è½¬æ¢
                        const response = await fetch(imageData);
                        blob = await response.blob();
                    }
                    
                    // åˆ›å»ºFormDataå¯¹è±¡
                    const formData = new FormData();
                    formData.append('image', blob, `${imageType}_image.${imageType === 'mask' ? 'png' : 'jpg'}`);
                    
                    // å‘é€è¯·æ±‚ä¸Šä¼ å›¾ç‰‡
                    console.log(`å‡†å¤‡ä¸Šä¼ ${imageType}å›¾ç‰‡...`);
                    const response = await fetch('/api/text-to-video/upload-image', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
                    }
                    
                    const imageUrl = data.output?.img_url || data.imageUrl;
                    console.log(`ä¸Šä¼ ${imageType}å›¾ç‰‡ï¼Œè·å–åˆ°çš„URL:`, imageUrl);
                    return imageUrl;
                } catch (error) {
                    console.error(`${imageType}å›¾ç‰‡ä¸Šä¼ é”™è¯¯:`, error);
                    throw new Error(`${imageType}å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ` + error.message);
                }
            }
            
            // Base64è½¬Blob
            function base64ToBlob(base64Data, mimeType = 'image/png') {
                const byteCharacters = atob(base64Data);
                const byteArrays = [];
                
                for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                    const slice = byteCharacters.slice(offset, offset + 512);
                    
                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) {
                        byteNumbers[i] = slice.charCodeAt(i);
                    }
                    
                    const byteArray = new Uint8Array(byteNumbers);
                    byteArrays.push(byteArray);
                }
                
                return new Blob(byteArrays, { type: mimeType });
            }
            
            // åˆ›å»ºé€šä¹‰ä¸‡ç›¸å±€éƒ¨é‡ç»˜ä»»åŠ¡
            async function createLocalRedrawTask(prompt, baseImageUrl, maskImageUrl) {
                try {
                    // å‡†å¤‡è¯·æ±‚æ•°æ® - å®Œå…¨æŒ‰ç…§APIæ–‡æ¡£æ ¼å¼
                    const requestData = {
                        model: "wanx2.1-imageedit",
                        input: {
                            function: "description_edit_with_mask",
                            prompt: prompt,
                            base_image_url: baseImageUrl,
                            mask_image_url: maskImageUrl
                        },
                        parameters: {
                            n: 1
                        }
                    };
                    
                    console.log('å‘é€åˆ›å»ºå±€éƒ¨é‡ç»˜ä»»åŠ¡è¯·æ±‚:', JSON.stringify(requestData));
                    
                    // é€šè¿‡æœåŠ¡å™¨ä»£ç†è°ƒç”¨é˜¿é‡Œäº‘API
                    const response = await fetch('/api/image-edit/create-task', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const data = await response.json();
                    
                    console.log('åˆ›å»ºä»»åŠ¡å“åº”:', data);
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
                    }
                    
                    return data.output?.task_id;
                } catch (error) {
                    console.error('åˆ›å»ºä»»åŠ¡é”™è¯¯:', error);
                    throw new Error('åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + error.message);
                }
            }
            
            // è½®è¯¢ä»»åŠ¡çŠ¶æ€
            async function pollTaskStatus(taskId) {
                return new Promise((resolve, reject) => {
                    // è®¡æ•°å™¨ï¼Œé˜²æ­¢æ— é™è½®è¯¢
                    let attempts = 0;
                    let errorCount = 0;
                    const maxAttempts = 60; // æœ€å¤šè½®è¯¢60æ¬¡ï¼Œçº¦10åˆ†é’Ÿ
                    
                    // è½®è¯¢é—´éš”ï¼Œé¦–æ¬¡10ç§’ï¼Œåç»­æ¯æ¬¡10ç§’
                    const pollInterval = 10000;
                    
                    // è½®è¯¢å‡½æ•°
                    async function checkStatus() {
                        if (attempts >= maxAttempts) {
                            clearTimeout(timeoutId);
                            reject(new Error('ä»»åŠ¡å¤„ç†è¶…æ—¶'));
                            return;
                        }
                        
                        attempts++;
                        loadingMessage.textContent = `${t('local_redraw.processing_wait')} (${attempts}/${maxAttempts})`;
                        
                        try {
                            const response = await fetch(`/api/image-edit/task-status/${taskId}`, {
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                                }
                            });
                            
                            const data = await response.json();
                            console.log(`è½®è¯¢ç»“æœ (${attempts}/${maxAttempts}):`, data);
                            
                            // è¯¦ç»†è®°å½•APIå“åº”ç»“æ„ï¼Œä¾¿äºè°ƒè¯•
                            console.log('APIå“åº”è¯¦æƒ… - request_id:', data.request_id);
                            console.log('APIå“åº”è¯¦æƒ… - output:', data.output);
                            if (data.output) {
                                console.log('APIå“åº”è¯¦æƒ… - task_status:', data.output.task_status);
                                console.log('APIå“åº”è¯¦æƒ… - task_id:', data.output.task_id);
                                if (data.output.results) {
                                    console.log('APIå“åº”è¯¦æƒ… - results:', JSON.stringify(data.output.results));
                                }
                                if (data.output.task_metrics) {
                                    console.log('APIå“åº”è¯¦æƒ… - task_metrics:', data.output.task_metrics);
                                }
                            }
                            if (data.usage) {
                                console.log('APIå“åº”è¯¦æƒ… - usage:', data.usage);
                            }
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ç 
                            if (data.code) {
                                clearTimeout(timeoutId);
                                reject(new Error(`è¯·æ±‚å¤±è´¥: ${data.code} - ${data.message || 'æœªçŸ¥é”™è¯¯'}`));
                                return;
                            }
                            
                            // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ - ä¸¥æ ¼æŒ‰ç…§å®˜æ–¹æ–‡æ¡£å¤„ç†çŠ¶æ€
                            const taskStatus = data.output?.task_status;
                            
                            // æ£€æŸ¥å„ç§ä»»åŠ¡çŠ¶æ€
                            if (taskStatus === 'SUCCEEDED') {
                                // æˆåŠŸå®Œæˆ
                                // æ›´æ–°ï¼šAPIè¿”å›çš„æ˜¯resultsæ•°ç»„ï¼Œè€Œä¸æ˜¯imagesæ•°ç»„
                                const resultsList = data.output?.results || [];
                                if (resultsList.length > 0) {
                                    // æ£€æŸ¥æ˜¯å¦æœ‰éƒ¨åˆ†å¤±è´¥çš„æƒ…å†µ
                                    const successResults = resultsList.filter(result => result.url);
                                    const failedResults = resultsList.filter(result => result.code);
                                    
                                    if (successResults.length > 0) {
                                        // è‡³å°‘æœ‰ä¸€ä¸ªæˆåŠŸçš„ç»“æœ
                                        const resultImageUrl = successResults[0].url;
                                        clearTimeout(timeoutId);
                                        resolve(resultImageUrl);
                                        
                                        // å¦‚æœæœ‰éƒ¨åˆ†å¤±è´¥ï¼Œåœ¨æ§åˆ¶å°è®°å½•
                                        if (failedResults.length > 0) {
                                            console.warn('éƒ¨åˆ†ç”Ÿæˆå¤±è´¥:', failedResults);
                                        }
                                        return;
                                    } else {
                                        // æ‰€æœ‰ç»“æœéƒ½å¤±è´¥äº†
                                        clearTimeout(timeoutId);
                                        
                                        // è¯·æ±‚é€€æ¬¾
                                        try {
                                            await requestRefund(taskId, 'æ‰€æœ‰ç”Ÿæˆç»“æœéƒ½å¤±è´¥');
                                            console.log('å·²è¯·æ±‚é€€æ¬¾ï¼ŒåŸå› ï¼šæ‰€æœ‰ç”Ÿæˆç»“æœéƒ½å¤±è´¥');
                                        } catch (refundError) {
                                            console.error('é€€æ¬¾è¯·æ±‚å¤±è´¥:', refundError);
                                        }
                                        
                                        // æ˜¾ç¤ºå¤±è´¥æç¤º
                                        if (resultImagePlaceholder) {
                                        resultImagePlaceholder.innerHTML = `
                                            <div class="text-center p-4 bg-red-50 rounded-lg">
                                                <svg class="w-12 h-12 mx-auto text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                <h3 class="text-lg font-medium text-red-600 mb-2">ç”Ÿæˆå¤±è´¥</h3>
                                                <p class="text-red-600 mb-2">é”™è¯¯åŸå› : ${failedResults[0]?.message || 'æœªçŸ¥é”™è¯¯'}</p>
                                                <p class="text-green-600">ç³»ç»Ÿå·²è‡ªåŠ¨é€€è¿˜æ‚¨ä½¿ç”¨çš„ç§¯åˆ†</p>
                                            </div>
                                        `;
                                        }
                                        
                                        reject(new Error(`ç”Ÿæˆå¤±è´¥: ${failedResults[0]?.message || 'æœªçŸ¥é”™è¯¯'}`));
                                        return;
                                    }
                                } else {
                                    clearTimeout(timeoutId);
                                    
                                    // è¯·æ±‚é€€æ¬¾
                                    try {
                                        await requestRefund(taskId, 'ä»»åŠ¡æˆåŠŸä½†æœªæ‰¾åˆ°ç»“æœ');
                                        console.log('å·²è¯·æ±‚é€€æ¬¾ï¼ŒåŸå› ï¼šä»»åŠ¡æˆåŠŸä½†æœªæ‰¾åˆ°ç»“æœ');
                                    } catch (refundError) {
                                        console.error('é€€æ¬¾è¯·æ±‚å¤±è´¥:', refundError);
                                    }
                                    
                                    // æ˜¾ç¤ºå¤±è´¥æç¤º
                                    if (resultImagePlaceholder) {
                                    resultImagePlaceholder.innerHTML = `
                                        <div class="text-center p-4 bg-red-50 rounded-lg">
                                            <svg class="w-12 h-12 mx-auto text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <h3 class="text-lg font-medium text-red-600 mb-2">ç”Ÿæˆå¤±è´¥</h3>
                                            <p class="text-red-600 mb-2">ä»»åŠ¡æˆåŠŸä½†æœªæ‰¾åˆ°ç»“æœï¼Œè¯·é‡è¯•</p>
                                            <p class="text-green-600">ç³»ç»Ÿå·²è‡ªåŠ¨é€€è¿˜æ‚¨ä½¿ç”¨çš„ç§¯åˆ†</p>
                                        </div>
                                    `;
                                    }
                                    
                                    reject(new Error('ä»»åŠ¡æˆåŠŸä½†æœªæ‰¾åˆ°ç»“æœ'));
                                    return;
                                }
                            } 
                            else if (taskStatus === 'FAILED') {
                                // ä»»åŠ¡å¤±è´¥
                                clearTimeout(timeoutId);
                                // æ›´æ–°ï¼šè¯»å–codeå’Œmessageå­—æ®µ
                                const errorCode = data.output?.code || '';
                                const errorMsg = data.output?.message || 'æœªçŸ¥é”™è¯¯';
                                
                                // è¯·æ±‚é€€æ¬¾
                                try {
                                    await requestRefund(taskId, `ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${errorCode} - ${errorMsg}`);
                                    console.log('å·²è¯·æ±‚é€€æ¬¾ï¼ŒåŸå› ï¼šä»»åŠ¡æ‰§è¡Œå¤±è´¥');
                                } catch (refundError) {
                                    console.error('é€€æ¬¾è¯·æ±‚å¤±è´¥:', refundError);
                                }
                                
                                // æ˜¾ç¤ºå¤±è´¥æç¤º
                                if (resultImagePlaceholder) {
                                resultImagePlaceholder.innerHTML = `
                                    <div class="text-center p-4 bg-red-50 rounded-lg">
                                        <svg class="w-12 h-12 mx-auto text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <h3 class="text-lg font-medium text-red-600 mb-2">ç”Ÿæˆå¤±è´¥</h3>
                                        <p class="text-red-600 mb-2">é”™è¯¯åŸå› : ${errorMsg}</p>
                                        <p class="text-green-600">ç³»ç»Ÿå·²è‡ªåŠ¨é€€è¿˜æ‚¨ä½¿ç”¨çš„ç§¯åˆ†</p>
                                    </div>
                                `;
                                }
                                
                                reject(new Error(`ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${errorCode} - ${errorMsg}`));
                                return;
                            } 
                            else if (taskStatus === 'CANCELED') {
                                // ä»»åŠ¡è¢«å–æ¶ˆ
                                clearTimeout(timeoutId);
                                
                                // è¯·æ±‚é€€æ¬¾
                                try {
                                    await requestRefund(taskId, 'ä»»åŠ¡å·²è¢«å–æ¶ˆ');
                                    console.log('å·²è¯·æ±‚é€€æ¬¾ï¼ŒåŸå› ï¼šä»»åŠ¡å·²è¢«å–æ¶ˆ');
                                } catch (refundError) {
                                    console.error('é€€æ¬¾è¯·æ±‚å¤±è´¥:', refundError);
                                }
                                
                                // æ˜¾ç¤ºå–æ¶ˆæç¤º
                                if (resultImagePlaceholder) {
                                resultImagePlaceholder.innerHTML = `
                                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                                        <svg class="w-12 h-12 mx-auto text-yellow-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                        <h3 class="text-lg font-medium text-yellow-600 mb-2">ä»»åŠ¡å·²è¢«å–æ¶ˆ</h3>
                                        <p class="text-green-600">ç³»ç»Ÿå·²è‡ªåŠ¨é€€è¿˜æ‚¨ä½¿ç”¨çš„ç§¯åˆ†</p>
                                    </div>
                                `;
                                }
                                
                                reject(new Error('ä»»åŠ¡å·²è¢«å–æ¶ˆ'));
                                return;
                            }
                            else if (taskStatus === 'UNKNOWN') {
                                // ä»»åŠ¡çŠ¶æ€æœªçŸ¥
                                clearTimeout(timeoutId);
                                
                                // è¯·æ±‚é€€æ¬¾
                                try {
                                    await requestRefund(taskId, 'ä»»åŠ¡çŠ¶æ€æœªçŸ¥');
                                    console.log('å·²è¯·æ±‚é€€æ¬¾ï¼ŒåŸå› ï¼šä»»åŠ¡çŠ¶æ€æœªçŸ¥');
                                } catch (refundError) {
                                    console.error('é€€æ¬¾è¯·æ±‚å¤±è´¥:', refundError);
                                }
                                
                                // æ˜¾ç¤ºæœªçŸ¥çŠ¶æ€æç¤º
                                if (resultImagePlaceholder) {
                                resultImagePlaceholder.innerHTML = `
                                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                                        <svg class="w-12 h-12 mx-auto text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <h3 class="text-lg font-medium text-gray-600 mb-2">ä»»åŠ¡çŠ¶æ€æœªçŸ¥</h3>
                                        <p class="text-gray-600 mb-2">æ— æ³•ç¡®å®šä»»åŠ¡å¤„ç†çŠ¶æ€</p>
                                        <p class="text-green-600">ç³»ç»Ÿå·²è‡ªåŠ¨é€€è¿˜æ‚¨ä½¿ç”¨çš„ç§¯åˆ†</p>
                                    </div>
                                `;
                                }
                                
                                reject(new Error('ä»»åŠ¡çŠ¶æ€æœªçŸ¥ï¼Œè¯·é‡è¯•'));
                                return;
                            }
                            // çŠ¶æ€ä¸ºPENDINGæˆ–RUNNINGï¼Œç»§ç»­è½®è¯¢
                            console.log(`ä»»åŠ¡çŠ¶æ€: ${taskStatus}, ç»§ç»­è½®è¯¢...`);
                            timeoutId = setTimeout(checkStatus, pollInterval);
                        } catch (error) {
                            console.error(`è½®è¯¢å‡ºé”™ (${attempts}/${maxAttempts}):`, error);
                            errorCount++;
                            
                            // å¦‚æœè¿ç»­é”™è¯¯è¶…è¿‡3æ¬¡ï¼Œåˆ™æ”¾å¼ƒ
                            if (errorCount >= 3) {
                                clearTimeout(timeoutId);
                                reject(new Error('è½®è¯¢ä»»åŠ¡çŠ¶æ€è¿ç»­å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'));
                                return;
                            }
                            
                            // ç»§ç»­è½®è¯¢
                            timeoutId = setTimeout(checkStatus, pollInterval);
                        }
                    }
                    
                    // å¼€å§‹è½®è¯¢
                    let timeoutId = setTimeout(checkStatus, 3000); // é¦–æ¬¡å»¶è¿Ÿ3ç§’åå¼€å§‹è½®è¯¢
                });
            }
            
            // ä¸‹è½½æŒ‰é’®
            downloadBtn.addEventListener('click', () => {
                if (resultImage.src) {
                    const link = document.createElement('a');
                    link.href = resultImage.src;
                    link.download = 'local-redraw-result.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
            
            // ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒæŒ‰é’®
            saveToDownloadsBtn.addEventListener('click', async () => {
                if (!resultImage.src) return;
                
                try {
                    // æ˜¾ç¤ºåŠ è½½ä¸­
                    loadingOverlay.classList.remove('hidden');
                    loadingMessage.textContent = t('local_redraw.saving_to_downloads');
                    
                    // è·å–æç¤ºæ–‡æœ¬
                    const promptText = promptInput.value.trim() || 'å±€éƒ¨é‡ç»˜';
                    
                    console.log('å‡†å¤‡ä¿å­˜å›¾ç‰‡åˆ°ä¸‹è½½ä¸­å¿ƒ:', resultImage.src.substring(0, 50) + '...');
                    
                    // è°ƒç”¨APIä¿å­˜å›¾ç‰‡åˆ°ä¸‹è½½ä¸­å¿ƒ
                    const response = await fetch('/api/downloads/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            imageUrl: resultImage.src,
                            title: 'å±€éƒ¨é‡ç»˜: ' + (promptText.substring(0, 30) + (promptText.length > 30 ? '...' : '')),
                            description: promptText,
                            type: 'LOCAL_REDRAW'
                        })
                    });
                    
                    console.log('ä¿å­˜å“åº”çŠ¶æ€:', response.status);
                    
                    const data = await response.json();
                    console.log('ä¿å­˜å“åº”æ•°æ®:', data);
                    
                    if (!response.ok) {
                        throw new Error(data.message || data.error || 'ä¿å­˜å¤±è´¥');
                    }
                    
                    if (data.success) {
                        alert(t('local_redraw.save_success'));
                    } else {
                        throw new Error(data.message || 'ä¿å­˜å¤±è´¥');
                    }
                } catch (error) {
                    console.error('ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒå¤±è´¥:', error);
                    alert(t('local_redraw.save_failed') + ': ' + error.message);
                } finally {
                    // éšè—åŠ è½½é®ç½©
                    loadingOverlay.classList.add('hidden');
                }
            });
            
            // è¾…åŠ©å‡½æ•°
            function handleImageFile(file) {
                if (file.size > 10 * 1024 * 1024) { // 10MB é™åˆ¶
                    alert(t('local_redraw.file_too_large'));
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    // æ˜¾ç¤ºåŸå§‹å›¾ç‰‡
                    originalImage.src = event.target.result;
                    originalImage.classList.remove('hidden');
                    
                    // å®‰å…¨åœ°éšè—å ä½ç¬¦
                    if (originalImagePlaceholder) {
                    originalImagePlaceholder.classList.add('hidden');
                    }
                    
                    // å½“å›¾ç‰‡åŠ è½½å®Œæˆåè®¾ç½®ç»˜å›¾ç”»å¸ƒ
                    originalImage.onload = () => {
                        // æ£€æŸ¥å›¾ç‰‡å°ºå¯¸æ˜¯å¦ç¬¦åˆè¦æ±‚
                        const width = originalImage.naturalWidth;
                        const height = originalImage.naturalHeight;
                        
                        if (width < 512 || height < 512) {
                            alert(t('local_redraw.image_too_small'));
                            originalImage.classList.add('hidden');
                            if (originalImagePlaceholder) {
                            originalImagePlaceholder.classList.remove('hidden');
                            }
                            return;
                        }
                        
                        if (width > 4000 || height > 4000) {
                            alert(t('local_redraw.image_too_large'));
                            originalImage.classList.add('hidden');
                            if (originalImagePlaceholder) {
                            originalImagePlaceholder.classList.remove('hidden');
                            }
                            return;
                        }
                        
                        // æ›´æ–°ç”»å¸ƒå¤§å°å’Œä½ç½®
                        updateImageAndCanvasState();
                        
                        // æ˜¾ç¤ºç»˜å›¾ç”»å¸ƒå’Œæç¤º
                        drawingCanvas.classList.remove('hidden');
                        drawingInstructions.classList.remove('hidden');
                        clearMaskBtn.classList.remove('hidden');
                        
                        // æ¸…é™¤ç”»å¸ƒå’Œæ¶‚æŠ¹è·¯å¾„
                        if (drawingCanvas.width && drawingCanvas.height) {
                        ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                        }
                        maskPaths = [];
                        
                        console.log('å›¾ç‰‡åŠ è½½å®Œæˆï¼Œç”»å¸ƒå·²åˆå§‹åŒ–:', {
                            canvasWidth: drawingCanvas.width,
                            canvasHeight: drawingCanvas.height,
                            imageWidth: originalImage.naturalWidth,
                            imageHeight: originalImage.naturalHeight,
                            canvasStyle: {
                                left: drawingCanvas.style.left,
                                top: drawingCanvas.style.top,
                                width: drawingCanvas.style.width,
                                height: drawingCanvas.style.height
                            }
                        });
                        
                        // æ·»åŠ è°ƒè¯•è¾¹æ¡†ï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°ç”»å¸ƒåŒºåŸŸ
                        drawingCanvas.style.border = '2px solid rgba(255, 0, 0, 0.3)';
                        drawingCanvas.style.backgroundColor = 'rgba(0, 255, 0, 0.1)';
                    };
                    
                    // é‡ç½®ç»“æœåŒºåŸŸ
                    resultImage.classList.add('hidden');
                    if (resultImagePlaceholder) {
                    resultImagePlaceholder.classList.remove('hidden');
                    }
                    downloadBtn.classList.add('hidden');
                    saveToDownloadsBtn.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                uploadArea.classList.add('border-indigo-500', 'bg-indigo-50');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('border-indigo-500', 'bg-indigo-50');
            }
            
            // åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢ï¼ˆä¸è¿›è¡Œè®¤è¯æ£€æŸ¥ï¼Œç”±auth-check.jsç»Ÿä¸€å¤„ç†ï¼‰
            function initializeUserUI() {
                const authToken = localStorage.getItem('authToken');
                const userInfo = localStorage.getItem('user');
                
                if (authToken && userInfo) {
                    try {
                        const user = JSON.parse(userInfo);
                        const usernameElement = document.getElementById('username-display');
                        if (usernameElement) {
                            usernameElement.textContent = user.username;
                        }
                        
                        if (loginBtn) loginBtn.classList.add('hidden');
                        if (userMenuBtn) userMenuBtn.classList.remove('hidden');
                        
                        // è·å–ç”¨æˆ·ç§¯åˆ†
                        fetch('/api/user/credits', {
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        })
                        .then(res => res.json())
                        .then(data => {
                            const creditsElement = document.getElementById('user-credits');
                            if (creditsElement) {
                                creditsElement.textContent = `${t('nav.credits')}: ${data.credits || 0}`;
                            }
                        })
                        .catch(err => {
                            console.error('è·å–ç§¯åˆ†å¤±è´¥:', err);
                        });
                    } catch (e) {
                        console.error('è§£æç”¨æˆ·ä¿¡æ¯å‡ºé”™:', e);
                        // ä¸è¿›è¡Œè·³è½¬ï¼Œè®©auth-check.jså¤„ç†
                        console.log('å±€éƒ¨é‡ç»˜é¡µé¢ï¼šç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥ï¼Œç”±auth-check.jså¤„ç†');
                    }
                } else {
                    // ç”¨æˆ·æœªç™»å½•ï¼Œä¸è¿›è¡Œè·³è½¬ï¼Œè®©auth-check.jså¤„ç†
                    console.log('å±€éƒ¨é‡ç»˜é¡µé¢ï¼šç”¨æˆ·æœªç™»å½•ï¼Œç”±auth-check.jså¤„ç†');
                }
            }
            
            // æ·»åŠ çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—ç”»å¸ƒä½ç½®
            window.addEventListener('resize', updateImageAndCanvasState);
        });

        // å†å²è®°å½•ç›¸å…³å‡½æ•°
        // æ·»åŠ åˆ°å†å²è®°å½•
        async function addToHistory(originalImage, resultImage, prompt) {
            try {
                // æ£€æŸ¥localStorageæ˜¯å¦å¯ç”¨
                if (!isLocalStorageAvailable()) {
                    console.warn('localStorageä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜å†å²è®°å½•');
                    return;
                }
                
                console.log('æ·»åŠ å†å²è®°å½• - å¼€å§‹');
                
                // å‹ç¼©å›¾ç‰‡æ•°æ®ï¼Œé¿å…localStorageè¶…å‡ºé™åˆ¶
                const compressedOriginalImage = await compressImageDataIfNeeded(originalImage);
                const compressedResultImage = await compressImageDataIfNeeded(resultImage);
                
                console.log('æ·»åŠ å†å²è®°å½• - åŸå§‹å›¾ç‰‡(å‹ç¼©å):', compressedOriginalImage.substring(0, 50) + '...');
                console.log('æ·»åŠ å†å²è®°å½• - ç»“æœå›¾ç‰‡(å‹ç¼©å):', compressedResultImage.substring(0, 50) + '...');
                console.log('æ·»åŠ å†å²è®°å½• - æç¤ºè¯:', prompt);
                
                const historyItem = {
                    originalImage: compressedOriginalImage,
                    resultImage: compressedResultImage,
                    prompt: prompt,
                    createdAt: new Date().toISOString()
                };
                
                // ä¿å­˜åˆ°OSSå­˜å‚¨
                try {
                    // ä½¿ç”¨OSSå†å²è®°å½•æ¨¡å—ä¿å­˜
                    const historyData = {
                        originalImage: compressedOriginalImage,
                        resultImage: compressedResultImage,
                        prompt: prompt,
                        maskImage: null, // å±€éƒ¨é‡ç»˜æš‚æ—¶æ²¡æœ‰è’™ç‰ˆå›¾ç‰‡
                        metadata: {
                            feature: 'local-redraw',
                            timestamp: new Date().toISOString()
                        }
                    };
                    
                    console.log('æ·»åŠ å†å²è®°å½• - å‡†å¤‡ä¿å­˜åˆ°OSS:', historyData);
                    
                    // è°ƒç”¨OSSä¿å­˜æ¥å£
                    if (window.LocalRedrawHistory) {
                        await window.LocalRedrawHistory.save(historyData);
                        console.log('æ·»åŠ å†å²è®°å½• - OSSä¿å­˜æˆåŠŸ');
                    } else {
                        console.error('LocalRedrawHistoryæ¨¡å—æœªåŠ è½½ï¼Œæ— æ³•ä¿å­˜åˆ°OSS');
                        // é™çº§åˆ°localStorage
                        await saveToLocalStorage(historyItem);
                    }
                } catch (error) {
                    console.error('ä¿å­˜å†å²è®°å½•åˆ°OSSå¤±è´¥:', error);
                    // é™çº§åˆ°localStorage
                    try {
                        await saveToLocalStorage(historyItem);
                        console.log('æ·»åŠ å†å²è®°å½• - é™çº§åˆ°localStorageä¿å­˜æˆåŠŸ');
                    } catch (localError) {
                        console.error('é™çº§åˆ°localStorageä¹Ÿå¤±è´¥:', localError);
                    }
                }
                
                // åˆ·æ–°å†å²è®°å½•æ˜¾ç¤º
                console.log('æ·»åŠ å†å²è®°å½• - è°ƒç”¨loadHistory()åˆ·æ–°æ˜¾ç¤º');
                loadHistory();
                console.log('æ·»åŠ å†å²è®°å½• - å®Œæˆ');
            } catch (error) {
                console.error('æ·»åŠ å†å²è®°å½•å¤±è´¥:', error);
            }
        }
        
        // localStorageé™çº§ä¿å­˜å‡½æ•°
        async function saveToLocalStorage(historyItem) {
            let history = [];
            try {
                const historyData = localStorage.getItem('localRedrawHistory');
                if (historyData) {
                    history = JSON.parse(historyData);
                }
            } catch (e) {
                console.error('è§£æå†å²è®°å½•å¤±è´¥ï¼Œé‡ç½®å†å²è®°å½•', e);
                history = [];
            }
            
            // æ·»åŠ æ–°è®°å½•åˆ°å¼€å¤´
            history.unshift(historyItem);
            
            // åªä¿ç•™æœ€æ–°çš„3æ¡è®°å½•
            history = history.slice(0, 3);
            
            // ä¿å­˜åˆ°localStorage
            const historyString = JSON.stringify(history);
            console.log('æ·»åŠ å†å²è®°å½• - å‡†å¤‡ä¿å­˜åˆ°localStorageçš„æ•°æ®å¤§å°:', historyString.length, 'å­—èŠ‚');
            
            // æ£€æŸ¥æ•°æ®å¤§å°ï¼Œé¿å…è¶…å‡ºé…é¢
            if (historyString.length > 3500000) { // çº¦3.5MBé™åˆ¶
                console.warn('å†å²è®°å½•è¿‡å¤§ï¼Œæ¸…ç†æ—§è®°å½•');
                // å¦‚æœæ•°æ®å¤ªå¤§ï¼Œå°è¯•åªä¿ç•™æœ€æ–°çš„2æ¡è®°å½•
                history = history.slice(0, 2);
                const reducedHistoryString = JSON.stringify(history);
                
                if (reducedHistoryString.length > 3500000) {
                    // å¦‚æœä»ç„¶å¤ªå¤§ï¼Œåªä¿ç•™æœ€æ–°çš„è®°å½•
                    history = [history[0]];
                    localStorage.setItem('localRedrawHistory', JSON.stringify(history));
                    console.log('æ·»åŠ å†å²è®°å½• - æ•°æ®è¿‡å¤§ï¼Œä»…ä¿å­˜æœ€æ–°ä¸€æ¡');
                } else {
                    localStorage.setItem('localRedrawHistory', reducedHistoryString);
                    console.log('æ·»åŠ å†å²è®°å½• - æ•°æ®è¿‡å¤§ï¼Œä¿å­˜æœ€æ–°ä¸¤æ¡');
                }
            } else {
                localStorage.setItem('localRedrawHistory', historyString);
                console.log('æ·»åŠ å†å²è®°å½• - localStorageä¿å­˜æˆåŠŸï¼Œå…±', history.length, 'æ¡è®°å½•');
            }
            
            // éªŒè¯ä¿å­˜æ˜¯å¦æˆåŠŸ
            const savedData = localStorage.getItem('localRedrawHistory');
            if (savedData) {
                const savedHistory = JSON.parse(savedData);
                console.log('æ·»åŠ å†å²è®°å½• - éªŒè¯localStorageä¿å­˜ç»“æœ:', savedHistory.length, 'æ¡è®°å½•');
            }
        }
        
        // å‹ç¼©å›¾ç‰‡æ•°æ®ä»¥é€‚åº”localStorageé™åˆ¶
        function compressImageDataIfNeeded(imageData) {
            return new Promise((resolve) => {
                try {
                    // å¦‚æœä¸æ˜¯base64æ•°æ®ï¼Œç›´æ¥è¿”å›
                    if (!imageData || !imageData.startsWith('data:image')) {
                        resolve(imageData);
                        return;
                    }
                    
                    // å¦‚æœæ•°æ®å¤§å°å·²ç»å°äº500KBï¼Œä¸éœ€è¦å‹ç¼©
                    if (imageData.length < 500000) {
                        resolve(imageData);
                        return;
                    }
                    
                    console.log('å‹ç¼©å›¾ç‰‡ - åŸå§‹å¤§å°:', imageData.length, 'å­—èŠ‚');
                    
                    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„canvaså’ŒImageå¯¹è±¡
                    const img = new Image();
                    
                    img.onload = () => {
                        // åˆ›å»ºä¸€ä¸ªcanvaså…ƒç´ 
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // è®¾ç½®åˆé€‚çš„å°ºå¯¸ï¼Œä¿æŒå®½é«˜æ¯”
                        let width = img.width;
                        let height = img.height;
                        
                        // å¦‚æœå›¾ç‰‡å¤ªå¤§ï¼ŒæŒ‰æ¯”ä¾‹ç¼©å°
                        const MAX_SIZE = 800;
                        if (width > height && width > MAX_SIZE) {
                            height = Math.round((height * MAX_SIZE) / width);
                            width = MAX_SIZE;
                        } else if (height > MAX_SIZE) {
                            width = Math.round((width * MAX_SIZE) / height);
                            height = MAX_SIZE;
                        }
                        
                        // è®¾ç½®canvaså°ºå¯¸
                        canvas.width = width;
                        canvas.height = height;
                        
                        // ç»˜åˆ¶å›¾ç‰‡åˆ°canvas
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // å°†canvasè½¬æ¢ä¸ºå‹ç¼©åçš„base64æ•°æ®
                        // ä½¿ç”¨è¾ƒä½çš„è´¨é‡å€¼æ¥å‡å°æ–‡ä»¶å¤§å°
                        const compressedData = canvas.toDataURL('image/jpeg', 0.6);
                        
                        console.log('å‹ç¼©å›¾ç‰‡ - å‹ç¼©åå¤§å°:', compressedData.length, 'å­—èŠ‚');
                        console.log('å‹ç¼©å›¾ç‰‡ - å‹ç¼©ç‡:', Math.round((compressedData.length / imageData.length) * 100) + '%');
                        
                        resolve(compressedData);
                    };
                    
                    img.onerror = () => {
                        console.error('å‹ç¼©å›¾ç‰‡å¤±è´¥: å›¾ç‰‡åŠ è½½é”™è¯¯');
                        resolve(imageData); // å¦‚æœåŠ è½½å¤±è´¥ï¼Œè¿”å›åŸå§‹æ•°æ®
                    };
                    
                    img.src = imageData;
                } catch (error) {
                    console.error('å‹ç¼©å›¾ç‰‡å¤±è´¥:', error);
                    // å¦‚æœå‹ç¼©å¤±è´¥ï¼Œè¿”å›åŸå§‹æ•°æ®
                    resolve(imageData);
                }
            });
        }
        
        // æ£€æŸ¥localStorageæ˜¯å¦å¯ç”¨
        function isLocalStorageAvailable() {
            try {
                const test = '__test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }
        
        // åŠ è½½å†å²è®°å½•
        async function loadHistory() {
            console.log('loadHistoryå‡½æ•°è¢«è°ƒç”¨');
            try {
                const historyContainer = document.getElementById('history-container');
                if (!historyContainer) {
                    console.error('æœªæ‰¾åˆ°å†å²è®°å½•å®¹å™¨å…ƒç´ ');
                    return;
                }
                console.log('æ‰¾åˆ°å†å²è®°å½•å®¹å™¨å…ƒç´ ');
                
                // ä¼˜å…ˆä½¿ç”¨OSSå­˜å‚¨
                if (window.LocalRedrawHistory) {
                    try {
                        console.log('å¼€å§‹ä»OSSåŠ è½½å†å²è®°å½•');
                        const records = await window.LocalRedrawHistory.fetch();
                        console.log('ä»OSSè·å–åˆ°å†å²è®°å½•:', records.length, 'æ¡');
                        
                        // ä½¿ç”¨OSSå†å²è®°å½•æ¨¡å—æ˜¾ç¤º
                        window.LocalRedrawHistory.display(records, 'history-container');
                        return;
                    } catch (error) {
                        console.error('ä»OSSåŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯é—®é¢˜
                        if (error.response && error.response.status === 401) {
                            console.log('ç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æç¤º');
                            historyContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">${t('local_redraw.login_required')}</p>`;
                            return;
                        }
                        
                        // é™çº§åˆ°localStorage
                        console.log('é™çº§åˆ°localStorageåŠ è½½å†å²è®°å½•');
                    }
                }
                
                // é™çº§åˆ°localStorage
                if (!isLocalStorageAvailable()) {
                    console.warn('localStorageä¸å¯ç”¨ï¼Œæ— æ³•åŠ è½½å†å²è®°å½•');
                    historyContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">${t('local_redraw.history_unavailable')}</p>`;
                    return;
                }
                
                let history = [];
                try {
                    console.log('å¼€å§‹ä»localStorageåŠ è½½å†å²è®°å½•');
                    const historyData = localStorage.getItem('localRedrawHistory');
                    console.log('ä»localStorageè·å–çš„å†å²è®°å½•æ•°æ®:', historyData);
                    
                    if (historyData) {
                        history = JSON.parse(historyData);
                        console.log('è§£æåçš„å†å²è®°å½•:', history);
                        console.log('å†å²è®°å½•æ•°é‡:', history.length);
                    } else {
                        console.log('localStorageä¸­æ²¡æœ‰å†å²è®°å½•æ•°æ®');
                    }
                } catch (e) {
                    console.error('è§£æå†å²è®°å½•å¤±è´¥', e);
                    history = [];
                }
                
                // è¿‡æ»¤24å°æ—¶å†…çš„è®°å½•
                const now = new Date();
                const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                
                const recentHistory = history.filter(item => {
                    if (!item.createdAt) {
                        console.warn('å†å²è®°å½•ç¼ºå°‘åˆ›å»ºæ—¶é—´ï¼Œè·³è¿‡:', item);
                        return false;
                    }
                    
                    const itemDate = new Date(item.createdAt);
                    const isRecent = itemDate >= twentyFourHoursAgo;
                    
                    if (!isRecent) {
                        console.log('è¿‡æ»¤æ‰è¶…è¿‡24å°æ—¶çš„è®°å½•:', {
                            è®°å½•æ—¶é—´: itemDate.toLocaleString(),
                            å½“å‰æ—¶é—´: now.toLocaleString(),
                            æç¤ºè¯: item.prompt
                        });
                    }
                    
                    return isRecent;
                });
                
                console.log('24å°æ—¶è¿‡æ»¤ç»“æœ:', {
                    åŸå§‹è®°å½•æ•°: history.length,
                    è¿‡æ»¤åè®°å½•æ•°: recentHistory.length,
                    è¿‡æ»¤æ—¶é—´èŒƒå›´: `${twentyFourHoursAgo.toLocaleString()} è‡³ ${now.toLocaleString()}`
                });
                
                // ç¡®ä¿æ˜¾ç¤ºæœ€æ–°çš„3æ¡è®°å½•
                const limitedHistory = recentHistory.slice(0, 3);
                console.log('å°†æ˜¾ç¤ºçš„å†å²è®°å½•æ•°é‡:', limitedHistory.length);
            
                if (limitedHistory.length === 0) {
                    historyContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">${t('local_redraw.no_history')}</p>`;
                    return;
                }
                
                // æ¸…ç©ºå†å²è®°å½•å®¹å™¨
                historyContainer.innerHTML = '';
                
                // éå†å†å²è®°å½•å¹¶åˆ›å»ºå¡ç‰‡
                limitedHistory.forEach((item, index) => {
                    console.log(`å¤„ç†ç¬¬${index+1}æ¡å†å²è®°å½•:`, item.prompt);
                    
                    // åˆ›å»ºå†å²è®°å½•å¡ç‰‡
                    const historyCard = document.createElement('div');
                    historyCard.className = 'history-card bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all';
                
                    const originalImage = item.originalImage;
                    const resultImage = item.resultImage;
                    const prompt = item.prompt || 'å±€éƒ¨é‡ç»˜';
                    const createdAt = new Date(item.createdAt).toLocaleString();
                    
                    // è®¾ç½®å¡ç‰‡å†…å®¹
                    historyCard.innerHTML = `
                        <div class="relative">
                            <img src="${resultImage}" alt="ç»“æœå›¾" class="history-thumbnail w-full h-32 object-cover" loading="lazy">
                        </div>
                        <div class="p-3">
                            <p class="text-sm text-gray-700 truncate" title="${prompt}">${prompt}</p>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-500">${createdAt}</span>
                                <button class="download-history-btn text-indigo-600 hover:text-indigo-800 p-1">
                                    <i class="ri-download-line"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // ä¸‹è½½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                    const downloadHistoryBtn = historyCard.querySelector('.download-history-btn');
                    downloadHistoryBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // é˜²æ­¢è§¦å‘å¡ç‰‡ç‚¹å‡»äº‹ä»¶
                        downloadImage(resultImage, `å±€éƒ¨é‡ç»˜_${Date.now()}.png`);
                    });
                    
                    // å°†å¡ç‰‡æ·»åŠ åˆ°å®¹å™¨
                    historyContainer.appendChild(historyCard);
                });
                
                console.log('å†å²è®°å½•åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                const historyContainer = document.getElementById('history-container');
                if (historyContainer) {
                    historyContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">${t('local_redraw.load_history_failed')}</p>`;
                }
            }
        }
        
        // æ¸…ç©ºå†å²è®°å½•
        async function clearHistory() {
            if (confirm(t('local_redraw.confirm_clear_history'))) {
                try {
                    // ä¼˜å…ˆä½¿ç”¨OSSå­˜å‚¨
                    if (window.LocalRedrawHistory) {
                        try {
                            console.log('å¼€å§‹æ¸…ç©ºOSSå†å²è®°å½•');
                            // ä½¿ç”¨æ­£ç¡®çš„APIç«¯ç‚¹æ¸…ç©ºæ‰€æœ‰è®°å½•
                            const response = await fetch('/api/local-redraw-history/clear', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                console.log('OSSå†å²è®°å½•å·²æ¸…ç©º:', result);
                                alert(t('local_redraw.history_cleared'));
                                loadHistory(); // é‡æ–°åŠ è½½å†å²è®°å½•æ˜¾ç¤º
                                return;
                            } else {
                                throw new Error(`æ¸…ç©ºå¤±è´¥: ${response.status}`);
                            }
                        } catch (error) {
                            console.error('æ¸…ç©ºOSSå†å²è®°å½•å¤±è´¥:', error);
                            // é™çº§åˆ°localStorage
                            console.log('é™çº§åˆ°localStorageæ¸…ç©ºå†å²è®°å½•');
                        }
                    }
                    
                    // é™çº§åˆ°localStorage
                    localStorage.removeItem('localRedrawHistory');
                    console.log('localStorageå†å²è®°å½•å·²æ¸…ç©º');
                    loadHistory(); // é‡æ–°åŠ è½½å†å²è®°å½•æ˜¾ç¤º
                    alert(t('local_redraw.history_cleared'));
                } catch (error) {
                    console.error('æ¸…ç©ºå†å²è®°å½•å¤±è´¥:', error);
                    alert(t('local_redraw.clear_history_failed'));
                }
            }
        }
        
        // åˆå§‹åŒ–å†å²è®°å½•åŠŸèƒ½
        function initializeHistoryFeatures() {
            // ç»‘å®šæ¸…ç©ºå†å²è®°å½•æŒ‰é’®
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', clearHistory);
            }
            
            // ç»‘å®šåˆ·æ–°å†å²è®°å½•æŒ‰é’®
            const refreshHistoryBtn = document.getElementById('refresh-history-btn');
            if (refreshHistoryBtn) {
                refreshHistoryBtn.addEventListener('click', function() {
                    console.log('åˆ·æ–°å†å²è®°å½•æŒ‰é’®è¢«ç‚¹å‡»');
                    // æ·»åŠ è§†è§‰åé¦ˆ
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 150);
                    loadHistory();
                                });
                            } else {
                console.error('æœªæ‰¾åˆ°åˆ·æ–°å†å²è®°å½•æŒ‰é’®å…ƒç´ ');
            }
        }
        
        // ä¸‹è½½å›¾ç‰‡å‡½æ•°
        function downloadImage(imageUrl, fileName) {
            try {
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„aæ ‡ç­¾æ¥è§¦å‘ä¸‹è½½
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = fileName || 'image.png';
                
                // æ·»åŠ åˆ°DOMä¸­
                document.body.appendChild(link);
                
                // è§¦å‘ç‚¹å‡»äº‹ä»¶
                link.click();
                
                // æ¸…ç†DOM
                document.body.removeChild(link);
                } catch (error) {
                console.error('ä¸‹è½½å›¾ç‰‡å¤±è´¥:', error);
                alert(t('local_redraw.download_failed'));
            }
        }
        
        // ç¡®ä¿DOMå®Œå…¨åŠ è½½ååˆå§‹åŒ–
        setTimeout(() => {
            if (historyContainer) {
                console.log('DOMåˆå§‹åŒ–å®Œæˆï¼ŒhistoryContainerå·²å°±ç»ª');
            } else {
                console.error('DOMåˆå§‹åŒ–å¤±è´¥ï¼ŒhistoryContaineræœªæ‰¾åˆ°');
            }
        }, 100);
        


        // åŠ è½½å¯¼èˆªæ ç»„ä»¶
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/components/navbar-simple.html');
                const navbarHtml = await response.text();
                document.getElementById('navbar-simple').innerHTML = navbarHtml;
                
                // åŠ è½½ç»„ä»¶è„šæœ¬
                const script = document.createElement('script');
                script.src = '/components/components.js';
                document.head.appendChild(script);
            } catch (error) {
                console.error('Failed to load navbar component:', error);
            }
        });
    </script>
</body>
</html> 
</html> 