<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="clothing_segmentation.page_title">智能服饰分割 - 萤火AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="/components/styles.css">
    <script src="/translations.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #6366f1;
            background-color: #f9fafb;
        }
        .result-section {
            border-left: 1px solid #e5e7eb;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        .instructions {
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        .preview-area {
            background-color: #f9fafb;
            border-radius: 0.5rem;
            min-height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* 图片拖动禁用 */
        img {
            -webkit-user-drag: none;
            user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        
        /* 生成历史样式 */
        .history-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .history-thumbnail {
            width: 100%;
            height: 8rem;
            object-fit: cover;
        }
        
        
        .download-history-btn {
            transition: all 0.2s ease;
        }
        
        .download-history-btn:hover {
            color: #4f46e5 !important;
            transform: scale(1.1);
        }

    </style>

    <link rel="icon" href="/images/favicon.png" type="image/png">
    <script src="/js/auth-check.js"></script>
    <script src="/js/mobile-guard.js"></script>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- 简化版导航栏 -->
    <div id="navbar-simple"></div>

    <!-- 主内容区域 -->
    <div class="container mx-auto py-8 px-4" style="margin-top: 60px;">
        <h1 class="text-3xl font-bold text-center mb-8" data-translate="clothing_segmentation.main_title">智能服饰分割</h1>
        
        <div class="w-full flex flex-col lg:flex-row bg-white rounded-lg shadow-md" style="min-height: calc(100vh - 200px);">
            <!-- 左侧：上传图片和提示词 -->
            <div class="w-full lg:w-1/3 border-r border-gray-200 p-5 flex flex-col h-full overflow-auto">
                <h2 class="text-xl font-bold mb-3" data-translate="clothing_segmentation.settings_title">智能服饰分割</h2>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2" data-translate="clothing_segmentation.usage_tips">使用提示:</p>
                    <div class="instructions bg-gray-50 p-3 rounded-md">
                        <p class="mb-2" data-translate="clothing_segmentation.description_1">此功能可以精确识别并分割图片中的服装元素，为后续处理提供基础。</p>
                        <p class="mb-2" data-translate="clothing_segmentation.description_2">上传包含服饰的图像后，系统会自动识别服装区域，并生成分割结果。</p>
                        <p class="mb-2" data-translate="clothing_segmentation.description_3">支持以下服饰类别：上衣、外套、裙装、裤装、包类、鞋子、帽子等。</p>
                        <p class="mb-2" data-translate="clothing_segmentation.description_4">图片要求：支持PNG、JPEG、JPG、BMP格式，大小不超过3MB，分辨率在50×50至3000×3000像素之间。</p>
                        <p class="text-red-500 font-medium" data-translate="clothing_segmentation.warning_text">请上传合法合规的图片视频，如有违反会进行封号处理，任务一旦提交就会扣除积分不可中断，请勿重复刷新提交，否则会造成积分浪费。</p>
                    </div>
                </div>

                <div id="upload-area" class="upload-area h-36 flex flex-col items-center justify-center mb-4 bg-gray-50 border border-dashed border-gray-300 rounded-md hover:border-indigo-500 hover:bg-gray-100 transition-colors">
                    <i class="ri-upload-cloud-line text-2xl text-gray-400 mb-1"></i>
                    <p class="text-gray-500 text-center text-xs px-2" data-translate="clothing_segmentation.upload_text">点击或者拖动文件到这区域来上传</p>
                    <input type="file" id="image-upload" class="hidden" accept="image/*">
                </div>
                <p class="text-xs text-gray-500 mb-4" data-translate="clothing_segmentation.upload_image_label">上传服饰图像</p>
                
                <!-- 服饰类别选择 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="clothing_segmentation.category_label">选择服饰类别:</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center space-x-2 bg-gray-50 p-2 rounded-md hover:bg-gray-100">
                            <input type="checkbox" name="clothClass" value="tops" class="form-checkbox h-4 w-4 text-indigo-600" checked>
                            <span class="text-sm" data-translate="clothing_segmentation.category_tops">上衣 (tops)</span>
                        </label>
                        <label class="flex items-center space-x-2 bg-gray-50 p-2 rounded-md hover:bg-gray-100">
                            <input type="checkbox" name="clothClass" value="coat" class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="text-sm" data-translate="clothing_segmentation.category_coat">外套 (coat)</span>
                        </label>
                        <label class="flex items-center space-x-2 bg-gray-50 p-2 rounded-md hover:bg-gray-100">
                            <input type="checkbox" name="clothClass" value="skirt" class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="text-sm" data-translate="clothing_segmentation.category_skirt">裙装 (skirt)</span>
                        </label>
                        <label class="flex items-center space-x-2 bg-gray-50 p-2 rounded-md hover:bg-gray-100">
                            <input type="checkbox" name="clothClass" value="pants" class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="text-sm" data-translate="clothing_segmentation.category_pants">裤装 (pants)</span>
                        </label>
                        <label class="flex items-center space-x-2 bg-gray-50 p-2 rounded-md hover:bg-gray-100">
                            <input type="checkbox" name="clothClass" value="bag" class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="text-sm" data-translate="clothing_segmentation.category_bag">包类 (bag)</span>
                        </label>
                        <label class="flex items-center space-x-2 bg-gray-50 p-2 rounded-md hover:bg-gray-100">
                            <input type="checkbox" name="clothClass" value="shoes" class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="text-sm" data-translate="clothing_segmentation.category_shoes">鞋子 (shoes)</span>
                        </label>
                        <label class="flex items-center space-x-2 bg-gray-50 p-2 rounded-md hover:bg-gray-100">
                            <input type="checkbox" name="clothClass" value="hat" class="form-checkbox h-4 w-4 text-indigo-600">
                            <span class="text-sm" data-translate="clothing_segmentation.category_hat">帽子 (hat)</span>
                        </label>
                    </div>
                </div>
                
                <!-- 返回结果类型选择 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="clothing_segmentation.result_type_label">返回结果类型:</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="returnForm" value="" class="form-radio h-4 w-4 text-indigo-600" checked>
                            <span class="text-sm" data-translate="clothing_segmentation.result_no_background">无背景图</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="returnForm" value="mask" class="form-radio h-4 w-4 text-indigo-600">
                            <span class="text-sm" data-translate="clothing_segmentation.result_mask">二值遮罩图</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="returnForm" value="whiteBK" class="form-radio h-4 w-4 text-indigo-600">
                            <span class="text-sm" data-translate="clothing_segmentation.result_white_background">白底图</span>
                        </label>
                    </div>
                </div>
                
                <button id="generate-btn" class="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 flex items-center justify-center">
                    <i class="ri-magic-line mr-2"></i>
                    <span data-translate="clothing_segmentation.start_segmentation">开始分割</span>
                </button>
                <p class="mt-2 text-center text-sm text-gray-500" data-translate="clothing_segmentation.credits_cost">
                    一次消耗2积分
                </p>
            </div>
            
            <!-- 右侧：效果展示 -->
            <div class="w-full lg:w-2/3 p-6 flex flex-col h-full overflow-auto">
                <h2 class="text-xl font-bold mb-4 text-center" data-translate="clothing_segmentation.effect_display">效果展示</h2>
                
                <div class="flex flex-col md:flex-row gap-6 flex-grow">
                    <div class="w-full md:w-1/2">
                        <h3 class="text-base font-medium mb-3 text-center" data-translate="clothing_segmentation.original_image">原始图像:</h3>
                        <div id="original-image-container" class="h-64 md:h-96 bg-gray-100 rounded-md flex items-center justify-center overflow-hidden relative">
                            <img id="original-image" class="hidden max-w-full max-h-full object-contain" alt="上传的图片" draggable="false">
                            <p id="original-image-placeholder" class="text-gray-500 text-center px-4" data-translate="clothing_segmentation.original_placeholder">上传图片后将在这里显示</p>
                        </div>
                    </div>
                    
                    <div class="w-full md:w-1/2">
                        <h3 class="text-base font-medium text-center mb-3" data-translate="clothing_segmentation.segmentation_result">分割结果:</h3>
                        <div id="result-image-container" class="h-64 md:h-96 bg-gray-100 rounded-md flex items-center justify-center overflow-hidden">
                            <img id="result-image" class="hidden max-w-full max-h-full object-contain" alt="分割结果">
                            <p id="result-image-placeholder" class="text-gray-500 text-center px-4" data-translate="clothing_segmentation.result_placeholder">分割结果将在这里显示</p>
                        </div>
                    </div>
                </div>

                <!-- 分类结果展示 -->
                <div id="class-results-container" class="mt-6 hidden">
                    <h3 class="text-base font-medium mb-3" data-translate="clothing_segmentation.classification_result">分类结果:</h3>
                    <div id="class-results" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- 分类结果将在这里动态添加 -->
                    </div>
                </div>

                <div class="mt-4 flex justify-center space-x-4">
                    <button id="save-to-downloads-btn" class="hidden bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center">
                        <i class="ri-save-line mr-2"></i>
                        <span data-translate="clothing_segmentation.save_to_downloads">保存到下载中心</span>
                    </button>
                    
                    <button id="download-btn" class="hidden bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center">
                        <i class="ri-download-line mr-2"></i>
                        <span data-translate="clothing_segmentation.download_result">下载结果</span>
                    </button>
                    
                    <button id="download-all-btn" class="hidden bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center">
                        <i class="ri-file-zip-line mr-2"></i>
                        <span data-translate="clothing_segmentation.download_all_results">下载所有分类结果</span>
                    </button>
                </div>
                
                <!-- 生成历史部分 -->
                <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold" data-translate="clothing_segmentation.generation_history">生成历史</h2>
                        <div class="flex items-center space-x-2">
                            <button id="clear-history-btn" class="text-red-600 hover:text-red-800 text-sm" title="清空历史记录">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                            <button id="refresh-history-btn" class="text-indigo-600 hover:text-indigo-800">
                                <i class="ri-refresh-line text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="history-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <!-- 历史记录将通过JavaScript动态添加到这里 -->
                        <div class="col-span-full flex items-center justify-center py-8">
                            <p class="text-gray-500 text-center" data-translate="clothing_segmentation.no_history">暂无历史记录</p>
                        </div>
                    </div>
                    
                    <!-- 保存时间提示 -->
                    <div class="mt-4 text-center">
                        <p class="text-xs text-gray-500">
                            <i class="ri-time-line mr-1"></i>
                            <span data-translate="clothing_segmentation.history_time_note">仅显示24小时内最新3条历史记录</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 加载中遮罩 -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500 mb-4"></div>
                <p id="loading-message" class="text-gray-700 text-center">正在处理，请稍候...</p>
            </div>
        </div>
    </div>

    <!-- 引用外部Javascript文件 -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // 首先检查用户认证状态
            console.log('服饰分割页面：开始检查用户认证状态');
            
            // 检查本地存储
            const authToken = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('user');
            
            if (!authToken || !userInfo) {
                console.log('服饰分割页面：用户未登录，跳转到登录页');
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.href);
                return;
            }
            
            // 如果有统一的认证检查函数，使用它
            if (typeof window.checkAuth === 'function') {
                try {
                    const isAuthenticated = await window.checkAuth(true);
                    if (!isAuthenticated) {
                        console.log('服饰分割页面：认证检查失败');
                        return; // checkAuth会自动处理重定向
                    }
                    console.log('服饰分割页面：认证检查通过');
                } catch (error) {
                    console.error('服饰分割页面：认证检查出错:', error);
                    // 出错时也继续加载页面，但记录错误
                }
            }
            
            // 加载简化版导航栏组件
            try {
                const navbarResponse = await fetch('/components/navbar-simple.html');
                const navbarHtml = await navbarResponse.text();
                document.getElementById('navbar-simple').innerHTML = navbarHtml;
                
                // 加载组件JavaScript
                const componentsScript = document.createElement('script');
                componentsScript.src = '/components/components.js';
                document.head.appendChild(componentsScript);
            } catch (error) {
                console.error('加载导航栏组件失败:', error);
            }
            
            // DOM元素
            const uploadArea = document.getElementById('upload-area');
            const imageUpload = document.getElementById('image-upload');
            const originalImage = document.getElementById('original-image');
            const originalImageContainer = document.getElementById('original-image-container');
            const originalImagePlaceholder = document.getElementById('original-image-placeholder');
            const resultImage = document.getElementById('result-image');
            const resultImagePlaceholder = document.getElementById('result-image-placeholder');
            const generateBtn = document.getElementById('generate-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            const downloadBtn = document.getElementById('download-btn');
            const downloadAllBtn = document.getElementById('download-all-btn');
            const saveToDownloadsBtn = document.getElementById('save-to-downloads-btn');
            const clothClassCheckboxes = document.querySelectorAll('input[name="clothClass"]');
            const returnFormRadios = document.querySelectorAll('input[name="returnForm"]');
            const classResultsContainer = document.getElementById('class-results-container');
            const classResults = document.getElementById('class-results');
            
            // 服饰类别中文名称映射
            const clothClassNames = {
                'tops': '上衣',
                'coat': '外套',
                'skirt': '裙装',
                'pants': '裤装',
                'bag': '包类',
                'shoes': '鞋子',
                'hat': '帽子'
            };
            
            // 图片上传处理
            uploadArea.addEventListener('click', () => {
                imageUpload.click();
            });
            
            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleImageFile(file);
                }
            });
            
            // 拖放上传
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            uploadArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                
                if (file && file.type.startsWith('image/')) {
                    handleImageFile(file);
                } else {
                    alert('请上传图片文件！');
                }
            });
            
            // 生成按钮点击
            generateBtn.addEventListener('click', async () => {
                if (!originalImage.src || originalImage.classList.contains('hidden')) {
                    alert('请先上传图片！');
                    return;
                }
                
                // 检查是否选择了服饰类别
                const selectedClasses = getSelectedClothClasses();
                if (selectedClasses.length === 0) {
                    alert('请至少选择一个服饰类别！');
                    return;
                }
                
                // 显示加载中
                loadingOverlay.classList.remove('hidden');
                loadingMessage.textContent = '正在处理图像，请稍候...';
                
                try {
                    // 1. 上传原图到服务器获取URL
                    loadingMessage.textContent = '正在上传图片...';
                    console.log('正在上传图片...');
                    let imageUrl;
                    
                    try {
                        imageUrl = await uploadImageToServer(originalImage.src);
                    } catch (uploadError) {
                        console.error('图片上传错误:', uploadError);
                        throw new Error(`图片上传失败: ${uploadError.message}`);
                    }
                    
                    if (!imageUrl) {
                        throw new Error('图片上传失败，未获取到有效URL');
                    }
                    
                    console.log('图片上传成功，获取到的URL:', imageUrl);
                    
                    // 2. 获取所选的服饰类别和返回类型
                    const clothClasses = getSelectedClothClasses();
                    const returnForm = getSelectedReturnForm();
                    
                    // 3. 调用API创建服饰分割任务
                    loadingMessage.textContent = '正在创建服饰分割任务...';
                    console.log('正在创建服饰分割任务...');
                    
                    let result;
                    try {
                        result = await createClothSegmentationTask(imageUrl, clothClasses, returnForm);
                    } catch (taskError) {
                        console.error('创建任务错误:', taskError);
                        throw new Error(`创建服饰分割任务失败: ${taskError.message}`);
                    }
                    
                    if (!result || !result.imageUrl) {
                        throw new Error('创建服饰分割任务失败，未获取到结果');
                    }
                    
                    console.log('分割任务完成，结果:', result);
                    
                    // 4. 显示结果图像
                    loadingMessage.textContent = '正在加载结果图像...';
                    
                    resultImage.onload = () => {
                        loadingOverlay.classList.add('hidden');
                    };
                    
                    resultImage.onerror = () => {
                        loadingOverlay.classList.add('hidden');
                        alert('加载结果图像失败，请稍后重试');
                    };
                    
                    resultImage.src = result.imageUrl;
                    resultImage.classList.remove('hidden');
                    resultImagePlaceholder.classList.add('hidden');
                    downloadBtn.classList.remove('hidden');
                    saveToDownloadsBtn.classList.remove('hidden');
                    
                    // 5. 如果有分类结果，显示分类图片
                    if (result.classUrls && Object.keys(result.classUrls).length > 0) {
                        displayClassResults(result.classUrls);
                        downloadAllBtn.classList.remove('hidden');
                    } else {
                        classResultsContainer.classList.add('hidden');
                        downloadAllBtn.classList.add('hidden');
                    }
                    
                    // 6. 保存到历史记录并刷新历史显示
                    try {
                        await saveToHistory({
                            inputUrl: imageUrl,
                            outputUrl: result.imageUrl,
                            classUrls: result.classUrls,
                            clothClasses: clothClasses,
                            returnForm: returnForm
                        });
                        // 刷新历史记录显示
                        await loadHistory();
                    } catch (historyError) {
                        console.error('保存历史记录失败:', historyError);
                        // 历史记录保存失败不影响主要功能
                    }
                } catch (error) {
                    console.error('处理失败:', error);
                    
                    // 如果有任务ID，尝试请求退款
                    if (window.currentTaskId) {
                        try {
                            await requestRefund(window.currentTaskId, `处理失败: ${error.message}`);
                            console.log(`已为任务 ${window.currentTaskId} 请求退款`);
                            alert('处理失败: ' + error.message + '\n系统已自动申请退款，积分或免费次数将很快退还到您的账户。');
                        } catch (refundError) {
                            console.error('退款请求失败:', refundError);
                    alert('处理失败: ' + error.message);
                        }
                    } else {
                        alert('处理失败: ' + error.message);
                    }
                } finally {
                    // 隐藏加载遮罩
                    loadingOverlay.classList.add('hidden');
                }
            });
            
            // 下载按钮点击事件
            downloadBtn.addEventListener('click', () => {
                if (resultImage.src) {
                    const link = document.createElement('a');
                    link.href = resultImage.src;
                    link.download = '服饰分割结果_' + new Date().getTime() + '.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
            
            // 下载所有分类结果按钮点击事件
            downloadAllBtn.addEventListener('click', () => {
                const classImages = document.querySelectorAll('.class-result-image');
                if (classImages.length > 0) {
                    classImages.forEach(img => {
                        const className = img.dataset.className;
                        const link = document.createElement('a');
                        link.href = img.src;
                        link.download = `服饰分割_${className}_${new Date().getTime()}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    });
                }
            });
            
            // 保存到下载中心按钮点击事件
            saveToDownloadsBtn.addEventListener('click', async () => {
                if (!resultImage.src || resultImage.classList.contains('hidden')) {
                    alert('没有可保存的结果图像！');
                    return;
                }
                
                try {
                    loadingOverlay.classList.remove('hidden');
                    loadingMessage.textContent = '正在保存到下载中心...';
                    
                    const response = await fetch('/api/downloads/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            imageUrl: resultImage.src,
                            title: '服饰分割结果',
                            type: 'CLOTH_SEGMENTATION'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert('已成功保存到下载中心！');
                    } else {
                        throw new Error(result.message || '保存失败');
                    }
                } catch (error) {
                    console.error('保存到下载中心失败:', error);
                    alert('保存到下载中心失败: ' + error.message);
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            });
            
            // 历史记录相关功能
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            const refreshHistoryBtn = document.getElementById('refresh-history-btn');
            const historyContainer = document.getElementById('history-container');
            
            // 加载历史记录
            async function loadHistory() {
                console.log('开始加载服饰分割历史记录');
                if (!historyContainer) {
                    console.error('找不到历史记录容器');
                    return;
                }
                
                try {
                    // 显示加载中状态
                    historyContainer.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-8">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-500"></div>
                            <p class="mt-2 text-gray-500 text-center" data-translate="clothing_segmentation.loading_history">${translate('clothing_segmentation.loading_history')}</p>
                        </div>
                    `;
                    
                    // 从OSS和服务器加载历史记录
                    console.log('尝试从OSS和服务器加载历史记录...');
                    let history = [];
                    
                    try {
                        history = await loadHistoryFromServer();
                        console.log('从OSS服务器获取到的历史记录:', history);
                    } catch (serverError) {
                        console.error('从OSS服务器加载历史记录失败:', serverError);
                        history = [];
                    }
                    
                    if (!history || history.length === 0) {
                        console.log('没有历史记录，显示空状态');
                        historyContainer.innerHTML = `
                            <div class="col-span-full flex items-center justify-center py-8">
                                <p class="text-gray-500 text-center" data-translate="clothing_segmentation.no_history">${translate('clothing_segmentation.no_history')}</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // 过滤24小时内的记录
                    const now = new Date();
                    const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    
                    const recentHistory = history.filter(item => {
                        let itemWithTimestamp = item;
                        if (!item.createdAt && !item.created_at && !item.timestamp) {
                            console.warn('历史记录缺少创建时间，添加当前时间:', item);
                            itemWithTimestamp = {...item, timestamp: new Date().toISOString()};
                        }
                        
                        const itemDate = new Date(itemWithTimestamp.created_at || itemWithTimestamp.createdAt || itemWithTimestamp.timestamp);
                        const isRecent = itemDate >= twentyFourHoursAgo;
                        
                        if (!isRecent) {
                            console.log('过滤掉超过24小时的记录:', {
                                记录时间: itemDate.toLocaleString(),
                                当前时间: now.toLocaleString(),
                                描述: '服饰分割'
                            });
                        }
                        
                        return isRecent;
                    });
                    
                    console.log(`过滤前历史记录数量: ${history.length}, 过滤后数量: ${recentHistory.length}`);
                    
                    if (recentHistory.length === 0) {
                        console.log('24小时内没有历史记录，显示空状态');
                        historyContainer.innerHTML = `
                            <div class="col-span-full flex items-center justify-center py-8">
                                <p class="text-gray-500 text-center" data-translate="clothing_segmentation.no_history">${translate('clothing_segmentation.no_history')}</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // 限制只显示最新的3条记录
                    const limitedHistory = recentHistory.slice(0, 3);
                    console.log(`限制显示记录数量: 原始${recentHistory.length}条，显示${limitedHistory.length}条`);
                    
                    // 显示历史记录
                    displayHistory(limitedHistory);
                    
                } catch (error) {
                    console.error('加载历史记录失败:', error);
                    historyContainer.innerHTML = '<p class="text-red-500 text-center py-4">加载历史记录失败，请稍后重试</p>';
                }
            }
            
            // 从服务器加载历史记录
            async function loadHistoryFromServer() {
                try {
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        console.log('用户未登录，无法获取服务器历史记录');
                        return [];
                    }

                    const response = await fetch('/api/cloth-segmentation/history', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.tasks) {
                        const tasks = data.data.tasks;
                        
                        console.log(`从服务器获取到 ${tasks.length} 条服饰分割历史记录:`, tasks);
                        
                        // 验证每条记录的数据完整性
                        const validHistory = tasks.filter(record => {
                            return record && 
                                   typeof record === 'object' && 
                                   (record.outputUrl || record.imageUrl || record.result_image_url) &&
                                   (record.created_at || record.createdAt || record.timestamp);
                        });
                        
                        console.log(`服务器历史记录验证: 原始${tasks.length}条，有效${validHistory.length}条`);
                        
                        return validHistory;
                    } else {
                        console.warn('服务器返回的数据格式无效:', data);
                        return [];
                    }
                } catch (error) {
                    console.error('从服务器加载历史记录失败:', error);
                    throw error;
                }
            }

            // 显示历史记录
            function displayHistory(tasks) {
                if (!tasks || tasks.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="col-span-full flex items-center justify-center py-8">
                            <p class="text-gray-500 text-center" data-translate="clothing_segmentation.no_history">${translate('clothing_segmentation.no_history')}</p>
                        </div>
                    `;
                    return;
                }
                
                // 清空历史记录容器
                historyContainer.innerHTML = '';
                
                // 遍历历史记录并创建卡片
                for (let index = 0; index < tasks.length; index++) {
                    const task = Object.assign({}, tasks[index]);
                    
                    if (!task || Array.isArray(task) || typeof task !== 'object') {
                        console.error('历史记录项无效或不是对象:', task);
                        continue;
                    }
                    
                    console.log(`渲染服饰分割历史记录项 ${index}:`, task);
                    
                    try {
                        const historyCard = createHistoryCard(task);
                        historyContainer.appendChild(historyCard);
                    } catch (cardError) {
                        console.error('创建历史记录卡片失败:', cardError, task);
                        continue;
                    }
                }
            }
            
            // 创建历史记录卡片
            function createHistoryCard(task) {
                const card = document.createElement('div');
                card.className = 'history-card bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200';
                
                // 安全地获取图片URL
                let imageUrl = null;
                let originalUrl = null;
                
                try {
                    imageUrl = task.outputUrl || task.imageUrl || task.result_image_url;
                    originalUrl = task.inputUrl || task.original_image_url;
                } catch (e) {
                    console.error('获取图片URL时出错:', e);
                }
                
                if (!imageUrl) {
                    console.warn('历史记录项缺少结果图片URL:', task);
                    // 返回占位卡片
                    card.innerHTML = `
                        <div class="p-4 text-center text-gray-500">
                            <i class="ri-image-line text-2xl mb-2"></i>
                            <p class="text-sm">图片加载失败</p>
                        </div>
                    `;
                    return card;
                }
                
                // 验证时间戳并格式化
                let createdAt = '未知时间';
                const timestamp = task.created_at || task.createdAt || task.timestamp;
                
                try {
                    const date = new Date(timestamp || new Date());
                    if (!isNaN(date.getTime())) {
                        createdAt = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
                    }
                } catch (error) {
                    console.warn('时间戳格式化失败:', timestamp, error);
                }
                
                // 获取服饰类别信息
                const clothClasses = task.clothClasses || task.cloth_classes || [];
                const classesText = Array.isArray(clothClasses) && clothClasses.length > 0 
                    ? clothClasses.map(cls => clothClassNames[cls] || cls).join(', ')
                    : '服饰分割';
                
                card.innerHTML = `
                    <div class="relative">
                        <img src="${imageUrl}" alt="服饰分割结果" class="history-thumbnail w-full h-32 object-cover" loading="lazy"
                             onerror="this.onerror=null;this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiPuWbvueJh+WKoOi9veWksei0pTwvdGV4dD48L3N2Zz4=';">
                    </div>
                    <div class="p-3">
                        <p class="text-sm text-gray-700 truncate" title="${classesText}">${classesText}</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-gray-500">${createdAt}</span>
                            <div class="flex space-x-1">
                                <button class="download-history-btn text-indigo-600 hover:text-indigo-800 p-1" onclick="downloadHistoryImage('${imageUrl}', '服饰分割_${task.id || new Date().getTime()}')" title="下载">
                                    <i class="ri-download-line"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                return card;
            }
            
            
            // 下载历史图片 (增强版)
            window.downloadHistoryImage = function(imageUrl, filename) {
                try {
                    // 验证图片URL是否有效
                    const validateUrl = (url) => {
                        return url && typeof url === 'string' && (url.startsWith('http') || url.startsWith('data:') || url.startsWith('blob:'));
                    };
                    
                    if (!validateUrl(imageUrl)) {
                        alert('图片URL无效，无法下载');
                        return;
                    }
                    
                    console.log('开始下载历史图片:', {
                        URL: imageUrl.substring(0, 50) + '...',
                        文件名: filename
                    });
                    
                    // 创建下载链接
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = filename + '.png';
                    link.style.display = 'none';
                    
                    // 添加到DOM并触发下载
                    document.body.appendChild(link);
                    link.click();
                    
                    // 清理DOM
                    setTimeout(() => {
                        document.body.removeChild(link);
                    }, 100);
                    
                    console.log('下载请求已发送');
                    
                } catch (error) {
                    console.error('下载历史图片失败:', error);
                    alert('下载失败: ' + error.message);
                }
            };
            
            // 通用下载图片函数 (供其他地方使用)
            function downloadImage(imageUrl, filename) {
                try {
                    if (!imageUrl) {
                        throw new Error('图片URL为空');
                    }
                    
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = filename || `服饰分割_${Date.now()}.png`;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                    }, 100);
                    
                    console.log('图片下载成功:', filename);
                } catch (error) {
                    console.error('下载图片失败:', error);
                    throw error;
                }
            }
            
            // 清空历史记录
            async function clearHistory() {
                if (confirm('确定要清空所有历史记录吗？此操作不可恢复。')) {
                    try {
                        const response = await fetch('/api/cloth-segmentation/history', {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                            }
                        });
                        
                        if (response.ok) {
                            displayHistory([]);
                            alert('历史记录已清空！');
                        } else {
                            alert('清空历史记录失败');
                        }
                    } catch (error) {
                        console.error('清空历史记录失败:', error);
                        alert('清空历史记录失败: ' + error.message);
                    }
                }
            }
            
            // 绑定历史记录按钮事件
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', clearHistory);
            }
            
            if (refreshHistoryBtn) {
                refreshHistoryBtn.addEventListener('click', loadHistory);
            }
            
            // 保存到历史记录
            async function saveToHistory(taskData) {
                try {
                    // 1. 保存到服务器
                    const response = await fetch('/api/cloth-segmentation/history', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify(taskData)
                    });
                    
                    if (!response.ok) {
                        throw new Error('保存历史记录到服务器失败');
                    }
                    
                    console.log('历史记录保存到OSS服务器成功');
                    
                } catch (error) {
                    console.error('保存历史记录到OSS服务器失败:', error);
                    throw new Error('保存历史记录失败');
                }
            }
            // 页面加载完成后加载历史记录
            loadHistory();
            
            // 显示分类结果
            function displayClassResults(classUrls) {
                // 清空之前的结果
                classResults.innerHTML = '';
                
                // 解析分类URL (处理API返回的字符串格式)
                let urlsObj = classUrls;
                if (typeof classUrls === 'string') {
                    try {
                        // 移除单引号并替换为双引号使其成为有效的JSON
                        const jsonStr = classUrls.replace(/'/g, '"');
                        urlsObj = JSON.parse(jsonStr);
                    } catch (e) {
                        console.error('解析分类URL失败:', e);
                        return;
                    }
                }
                
                // 检查是否有分类结果
                if (!urlsObj || Object.keys(urlsObj).length === 0) {
                    classResultsContainer.classList.add('hidden');
                    return;
                }
                
                // 显示分类结果容器
                classResultsContainer.classList.remove('hidden');
                
                // 为每个分类创建结果卡片
                Object.entries(urlsObj).forEach(([className, url]) => {
                    const displayName = clothClassNames[className] || className;
                    
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg overflow-hidden shadow';
                    
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = `${displayName}分割结果`;
                    img.className = 'w-full h-40 object-contain class-result-image';
                    img.dataset.className = className;
                    
                    const footer = document.createElement('div');
                    footer.className = 'p-3 bg-gray-50 flex justify-between items-center';
                    
                    const label = document.createElement('span');
                    label.className = 'text-sm font-medium';
                    label.textContent = displayName;
                    
                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'text-indigo-600 hover:text-indigo-800';
                    downloadBtn.innerHTML = '<i class="ri-download-line"></i>';
                    downloadBtn.title = `下载${displayName}分割结果`;
                    downloadBtn.onclick = function() {
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `服饰分割_${className}_${new Date().getTime()}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    };
                    
                    footer.appendChild(label);
                    footer.appendChild(downloadBtn);
                    
                    card.appendChild(img);
                    card.appendChild(footer);
                    
                    classResults.appendChild(card);
                });
            }
            
            // 辅助函数
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                uploadArea.classList.add('border-indigo-500');
                uploadArea.classList.add('bg-gray-100');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('border-indigo-500');
                uploadArea.classList.remove('bg-gray-100');
            }
            
            // 获取选中的服饰类别
            function getSelectedClothClasses() {
                const selected = [];
                clothClassCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        selected.push(checkbox.value);
                    }
                });
                return selected;
            }
            
            // 获取选中的返回类型
            function getSelectedReturnForm() {
                let selected = '';
                returnFormRadios.forEach(radio => {
                    if (radio.checked) {
                        selected = radio.value;
                    }
                });
                return selected;
            }
            
            // 获取选中的分割结果类型(OutMode)
            function getSelectedOutMode() {
                // 已移除选择界面，直接返回1 (指定类别组合分割结果)
                return 1;
            }
            
            // 处理上传的图片文件
            function handleImageFile(file) {
                if (!file.type.match('image.*')) {
                    alert('请上传图片文件！');
                    return;
                }
                
                // 验证图片大小
                if (file.size > 3 * 1024 * 1024) {
                    alert('图片大小不能超过3MB！');
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // 验证图片尺寸
                    const img = new Image();
                    img.onload = function() {
                        if (img.width < 50 || img.height < 50) {
                            alert('图片尺寸太小，最小需要50×50像素！');
                            return;
                        }
                        
                        if (img.width > 3000 || img.height > 3000) {
                            alert('图片尺寸太大，最大不超过3000×3000像素！');
                            return;
                        }
                        
                        // 显示原图
                        originalImage.src = e.target.result;
                        originalImage.classList.remove('hidden');
                        originalImagePlaceholder.classList.add('hidden');
                        
                        // 清除结果区域
                        resultImage.classList.add('hidden');
                        resultImagePlaceholder.classList.remove('hidden');
                        downloadBtn.classList.add('hidden');
                        downloadAllBtn.classList.add('hidden');
                        saveToDownloadsBtn.classList.add('hidden');
                        classResultsContainer.classList.add('hidden');
                    };
                    
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            }
            
            // 上传图片到服务器
            async function uploadImageToServer(imageData) {
                try {
                    // 转换为Blob对象
                    let blob;
                    if (imageData.startsWith('data:')) {
                        // 从base64字符串创建Blob对象
                        blob = base64ToBlob(imageData.split(',')[1], 'image/jpeg');
                    } else {
                        // 处理URL情况 - 先获取图像再转换
                        const response = await fetch(imageData);
                        blob = await response.blob();
                    }
                    
                    // 创建FormData对象
                    const formData = new FormData();
                    formData.append('image', blob, 'image.jpg');
                    
                    // 发送请求上传图片
                    console.log('准备上传图片...');
                    
                    // 尝试先使用专用的图片上传API
                    try {
                        const response = await fetch('/api/upload-image', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                            },
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error('图片上传API未响应');
                        }
                        
                        const data = await response.json();
                        const imageUrl = data.imageUrl || data.output?.img_url;
                        if (imageUrl) {
                            console.log('图片上传成功，URL:', imageUrl);
                            return imageUrl;
                        }
                        throw new Error('未获取到有效的图片URL');
                    } catch (uploadError) {
                        console.warn('专用上传API失败，尝试备用方式:', uploadError);
                        
                        // 备用方式：使用text-to-video的上传端点
                        const fallbackResponse = await fetch('/api/text-to-video/upload-image', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                            },
                            body: formData
                        });
                        
                        if (!fallbackResponse.ok) {
                            const errorText = await fallbackResponse.text();
                            throw new Error(`图片上传失败: ${errorText}`);
                        }
                        
                        const fallbackData = await fallbackResponse.json();
                        const fallbackUrl = fallbackData.imageUrl || fallbackData.output?.img_url;
                        
                        if (!fallbackUrl) {
                            throw new Error('图片上传成功但未返回URL');
                        }
                        
                        console.log('备用方式图片上传成功，URL:', fallbackUrl);
                        return fallbackUrl;
                    }
                } catch (error) {
                    console.error('图片上传错误:', error);
                    throw error;
                }
            }
            
            // Base64转Blob
            function base64ToBlob(base64Data, mimeType = 'image/jpeg') {
                const byteCharacters = atob(base64Data);
                const byteArrays = [];
                
                for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                    const slice = byteCharacters.slice(offset, offset + 512);
                    
                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) {
                        byteNumbers[i] = slice.charCodeAt(i);
                    }
                    
                    const byteArray = new Uint8Array(byteNumbers);
                    byteArrays.push(byteArray);
                }
                
                return new Blob(byteArrays, { type: mimeType });
            }
            
            // 创建服饰分割任务
            async function createClothSegmentationTask(imageUrl, clothClasses, returnForm) {
                try {
                    // 准备请求数据
                    const requestData = {
                        imageUrl: imageUrl,
                        clothClasses: clothClasses,
                        outMode: getSelectedOutMode()
                    };
                    
                    // 如果选择了返回类型，添加到请求中
                    if (returnForm) {
                        requestData.returnForm = returnForm;
                    }
                    
                    console.log('发送创建服饰分割任务请求:', JSON.stringify(requestData));
                    
                    // 通过服务器代理调用API
                    const response = await fetch('/api/cloth-segmentation/create-task', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    // 检查HTTP错误
                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorMessage;
                        
                        try {
                            // 尝试解析错误消息为JSON
                            const errorData = JSON.parse(errorText);
                            errorMessage = errorData.Message || errorData.message || errorData.error || '未知错误';
                            // 记录错误代码
                            const errorCode = errorData.Code || errorData.code || '';
                            if (errorCode) {
                                console.error(`错误代码: ${errorCode}`);
                            }
                        } catch (e) {
                            // 如果不是有效的JSON，直接使用文本
                            errorMessage = errorText || `HTTP错误 ${response.status}`;
                        }
                        
                        if (errorMessage.includes('积分不足')) {
                            throw new Error('您的积分不足，请充值后再试');
                        } else {
                            throw new Error(`创建任务失败: ${errorMessage}`);
                        }
                    }
                    
                    const data = await response.json();
                    console.log('服饰分割任务响应:', data);
                    
                    // 检查是否需要轮询任务状态
                    if (data.taskId) {
                        // 保存任务ID用于可能的退款
                        window.currentTaskId = data.taskId;
                        loadingMessage.textContent = '任务已创建，正在处理...';
                        // 轮询任务状态
                        const result = await pollTaskStatus(data.taskId);
                        return result;
                    }
                    
                    // 适应阿里云标准API格式返回结果
                    if (data.Data) {
                        // 从标准API返回结果中提取信息
                        // 主图URL可能来自Data.ImageURL或Data.Elements[0].ImageURL
                        let mainImageUrl = data.Data.ImageURL;
                        if (!mainImageUrl && data.Data.Elements && data.Data.Elements.length > 0) {
                            mainImageUrl = data.Data.Elements[0].ImageURL;
                        }
                        
                        // 如果没有主图URL但有ClassUrl，使用第一个分类图作为主图
                        if (!mainImageUrl && data.Data.ClassUrl && Object.keys(data.Data.ClassUrl).length > 0) {
                            const firstCategory = Object.keys(data.Data.ClassUrl)[0];
                            mainImageUrl = data.Data.ClassUrl[firstCategory];
                        }
                        
                        // 返回结果
                        return {
                            imageUrl: mainImageUrl,
                            classUrls: data.Data.ClassUrl || {}
                        };
                    } else {
                        throw new Error('API返回数据格式错误');
                    }
                } catch (error) {
                    console.error('创建任务错误:', error);
                    throw error;
                }
            }
            
            // 轮询任务状态，直到完成或失败
            async function pollTaskStatus(taskId) {
                let maxRetries = 30; // 最多轮询30次
                let retryCount = 0;
                let retryDelay = 2000; // 开始时2秒一次
                
                while (retryCount < maxRetries) {
                    try {
                        console.log(`轮询任务状态: ${taskId}, 第${retryCount + 1}次尝试`);
                        loadingMessage.textContent = `处理中，请稍候... (${retryCount + 1}/${maxRetries})`;
                        
                        const response = await fetch(`/api/cloth-segmentation/task-status/${taskId}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                            }
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`查询任务状态失败:`, errorText);
                            throw new Error(`查询任务状态失败: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('任务状态响应:', data);
                        
                        // 检查任务是否完成
                        if (data.Data && data.Data.TaskStatus === 'SUCCEEDED' || (data.taskStatus === 'SUCCEEDED')) {
                            console.log('任务成功完成');
                            loadingMessage.textContent = '处理完成，正在加载结果...';
                            
                            // 返回结果
                            return {
                                imageUrl: data.Data.ImageURL,
                                classUrls: data.Data.ClassUrl || {}
                            };
                        }
                        
                        // 检查任务是否失败
                        if (data.Data && data.Data.TaskStatus === 'FAILED' || data.taskStatus === 'FAILED') {
                            console.error('任务失败');
                            // 任务失败时请求退款
                            try {
                                await requestRefund(taskId, data.Message || '服饰分割任务失败');
                                console.log(`已为任务 ${taskId} 请求退款`);
                            } catch (refundError) {
                                console.error('退款请求失败:', refundError);
                            }
                            throw new Error(data.Message || '服饰分割任务失败');
                        }
                        
                        // 任务仍在进行中，等待后继续轮询
                        retryCount++;
                        
                        // 稍微增加等待时间，避免过于频繁轮询
                        retryDelay = Math.min(retryDelay * 1.2, 10000); // 最长不超过10秒
                        
                        await new Promise(resolve => setTimeout(resolve, retryDelay));
                    } catch (error) {
                        console.error(`轮询任务状态出错 (${retryCount + 1}/${maxRetries}):`, error);
                        retryCount++;
                        
                        // 如果是服务器错误，继续轮询；其他错误则直接抛出
                        if (!error.message.includes('任务失败') && error.message.includes('状态')) {
                            await new Promise(resolve => setTimeout(resolve, retryDelay));
                            continue;
                        }
                        
                        throw error;
                    }
                }
                
                throw new Error('轮询任务状态超时，请稍后查看结果');
            }
            
            // 添加退款请求函数
            async function requestRefund(taskId, reason) {
                try {
                    console.log(`开始请求退款: 任务ID=${taskId}, 原因=${reason}`);
                    
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        console.error('用户未登录，无法请求退款');
                        return false;
                    }
                    
                    const response = await fetch('/api/refund/cloth-segmentation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ taskId, reason })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`退款请求失败: ${response.status}, ${errorText}`);
                        return false;
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log('退款请求成功:', result);
                        return true;
                    } else {
                        console.error('退款请求被拒绝:', result.message);
                        return false;
                    }
                } catch (error) {
                    console.error('退款请求出错:', error);
                    return false;
                }
            }
        });

        // 初始化翻译系统
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initializeTranslations === 'function') {
                initializeTranslations();
            }
            
            // 调试：添加语言切换测试按钮
            console.log('当前语言:', localStorage.getItem('language') || 'zh');
            console.log('可用翻译:', typeof translate === 'function' ? '是' : '否');
            
            // 添加全局调试函数
            window.testLanguageSwitch = function(lang) {
                localStorage.setItem('language', lang);
                location.reload();
            };
            
            console.log('调试提示：在控制台输入 testLanguageSwitch("en") 切换到英文，testLanguageSwitch("zh") 切换到中文');
        });
    </script>
</body>
</html> 