// æ‰‹æœºç«¯æ‹¦æˆªè„šæœ¬
// ä½œç”¨ï¼šåœ¨ç§»åŠ¨è®¾å¤‡ä¸Šé˜»æ­¢è¿›å…¥ä»…æ”¯æŒæ¡Œé¢ç«¯çš„åŠŸèƒ½é¡µé¢ï¼Œå¹¶ç»™å‡ºæç¤º
(function () {
  console.log('ç§»åŠ¨ç«¯æ‹¦æˆªè„šæœ¬å·²åŠ è½½');
  
  const isMobile = /Android|iPhone|iPad|iPod|Mobile|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  if (!isMobile) return; // ä»…åœ¨æ‰‹æœºæµè§ˆå™¨æ‰§è¡Œ
  
  console.log('æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡');

  // å…è®¸æ‰‹æœºç«¯è®¿é—®çš„ URL ç™½åå•
  const allowList = new Set([
    '/login.html',
    '/register.html',
    '/phone-login.html',
    '/phone-register.html',
    '/forgot-password.html',
    '/privacy-policy.html',
    '/service-agreement.html',
    '/index.html', // é¦–é¡µå…è®¸
    '/',
    '/credits.html', // ç§¯åˆ†é¡µé¢å…è®¸
    '/account.html', // è´¦æˆ·é¡µé¢å…è®¸
    '/credits-usage.html' // ç§¯åˆ†ä½¿ç”¨è®°å½•å…è®¸
  ]);

  // AIåŠŸèƒ½è·¯å¾„åˆ—è¡¨ï¼ˆéœ€è¦æ‹¦æˆªçš„è·¯å¾„ï¼‰
  const aiFunctionPaths = new Set([
    '/virtual-model',
    '/virtual-model-redirect.html',
    '/virtual-model-shoes.html',
    '/image-removal.html',
    '/image-expansion.html',
    '/image-sharpen.html',
    '/image-colorization.html',
    '/scene-generator.html',
    '/cutout.html',
    '/local-redraw.html',
    '/global-style.html',
    '/clothing-simulation.html',
    '/clothing-segmentation.html',
    '/model-skin-changer.html',
    '/text-to-image.html',
    '/text-to-video.html',
    '/image-to-video.html',
    '/multi-image-to-video.html',
    '/video-style-repaint.html',
    '/digital-human-video.html',
    '/video-subtitle-remover.html',
    '/amazon-listing.html',
    '/amazon-search-term.html',
    '/amazon-review-analysis.html',
    '/amazon-consumer-insights.html',
    '/amazon-customer-email.html',
    '/fba-claim-email.html',
    '/amazon-review-generator.html',
    '/amazon-review-response.html',
    '/amazon-brand-naming.html',
    '/amazon-post-creator.html',
    '/amazon-video-script.html',
    '/product-comparison.html',
    '/amazon-brand-info.html',
    '/product-improvement-analysis.html',
    '/amazon-keyword-recommender.html',
    '/amazon-case-creator.html',
    '/prompt-editor.html',
    '/diantu.html',
    '/image-upscaler.html',
    '/translate.html',
    '/marketing-images.html'
  ]);

  // æ˜¾ç¤ºå‹å¥½çš„æç¤ºå¼¹çª—
  function showMobileAlert(isPageBlock = false) {
    // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºäº†å¼¹çª—
    if (document.querySelector('.mobile-guard-alert')) return;
    
    console.log('å‡†å¤‡æ˜¾ç¤ºç§»åŠ¨ç«¯æç¤ºå¼¹çª—');
    
    // ç¡®ä¿document.bodyå·²å­˜åœ¨
    if (!document.body) {
      console.log('document.bodyä¸å­˜åœ¨ï¼Œç­‰å¾…DOMåŠ è½½');
      // å¦‚æœbodyä¸å­˜åœ¨ï¼Œç­‰å¾…DOMåŠ è½½å®Œæˆ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          showMobileAlert(isPageBlock);
        });
      } else {
        // å¦‚æœreadyStateä¸æ˜¯loadingä½†bodyä»ä¸å­˜åœ¨ï¼Œä½¿ç”¨setTimeouté‡è¯•
        setTimeout(function() {
          showMobileAlert(isPageBlock);
        }, 100);
      }
      return;
    }
    
    console.log('æ˜¾ç¤ºç§»åŠ¨ç«¯æç¤ºå¼¹çª—');
    
    const alertDiv = document.createElement('div');
    alertDiv.className = 'mobile-guard-alert';
    alertDiv.innerHTML = `
      <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 90%; width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
          <div style="font-size: 60px; margin-bottom: 20px; line-height: 1;">ğŸ“±â†’ğŸ’»</div>
          <h3 style="color: #333; margin-bottom: 15px; font-size: 20px; font-weight: 600;">è¯·åœ¨ç”µè„‘ä¸Šä½¿ç”¨å®Œæ•´åŠŸèƒ½</h3>
          <p style="color: #666; margin-bottom: 25px; line-height: 1.6; font-size: 16px;">
            ä¸ºæä¾›æœ€ä½³ä½“éªŒï¼Œæ­¤åŠŸèƒ½ä»…æ”¯æŒç”µè„‘ç«¯è®¿é—®ã€‚<br>è¯·ä½¿ç”¨ç”µè„‘æµè§ˆå™¨è®¿é—®æˆ‘ä»¬çš„ç½‘ç«™ã€‚
          </p>
          <div style="display: flex; justify-content: center; gap: 10px;">
            ${isPageBlock ? 
              `<button onclick="window.history.back()" style="flex: 1; background: #6366f1; color: white; border: none; padding: 12px 15px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">è¿”å›ä¸Šä¸€é¡µ</button>` 
              : 
              `<button onclick="this.closest('.mobile-guard-alert').remove()" style="flex: 1; background: #6366f1; color: white; border: none; padding: 12px 15px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">æˆ‘çŸ¥é“äº†</button>`
            }
          </div>
        </div>
      </div>
    `;
    
    try {
      document.body.appendChild(alertDiv);
      
      // æ·»åŠ ç®€å•çš„åŠ¨ç”»æ•ˆæœ
      const popupContent = alertDiv.querySelector('div > div');
      popupContent.style.transform = 'scale(0.9)';
      popupContent.style.opacity = '0';
      popupContent.style.transition = 'all 0.3s ease-out';
      
      // å¼ºåˆ¶é‡æ’åæ˜¾ç¤ºåŠ¨ç”»
      setTimeout(() => {
        popupContent.style.transform = 'scale(1)';
        popupContent.style.opacity = '1';
      }, 10);
    } catch (error) {
      console.error('æ·»åŠ å¼¹çª—å¤±è´¥:', error);
    }
  }

  // æ£€æŸ¥æ˜¯å¦æ˜¯éœ€è¦æ‹¦æˆªçš„AIåŠŸèƒ½é“¾æ¥
  function isAIFunctionLink(url) {
    if (!url || typeof url !== 'string') return false;
    
    // æ¸…ç†URLï¼Œç§»é™¤æŸ¥è¯¢å‚æ•°å’Œé”šç‚¹
    const cleanUrl = url.split('?')[0].split('#')[0];
    
    // ç›´æ¥æ£€æŸ¥æ˜¯å¦åœ¨AIåŠŸèƒ½è·¯å¾„åˆ—è¡¨ä¸­
    if (aiFunctionPaths.has(cleanUrl)) return true;
    if (aiFunctionPaths.has(url)) return true;
    
    // æ£€æŸ¥æ˜¯å¦åŒ…å«checkAuthAndRedirectè°ƒç”¨
    if (url.includes('checkAuthAndRedirect')) return true;
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ä»¥AIåŠŸèƒ½è·¯å¾„å¼€å¤´çš„è·¯å¾„
    for (const path of aiFunctionPaths) {
      if (url.startsWith(path) || cleanUrl.startsWith(path)) return true;
    }
    
    // æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åŒ¹é…ï¼ˆå»æ‰è·¯å¾„å‰ç¼€ï¼‰
    const fileName = cleanUrl.split('/').pop();
    if (fileName && aiFunctionPaths.has('/' + fileName)) return true;
    
    return false;
  }
  
  // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦æ˜¯åŠŸèƒ½é¡µé¢
  function checkCurrentPage() {
    console.log('æ£€æŸ¥å½“å‰é¡µé¢è·¯å¾„:', window.location.pathname);
    
    // æ£€æŸ¥å½“å‰è·¯å¾„æ˜¯å¦åœ¨ç™½åå•ä¸­
    if (allowList.has(window.location.pathname)) {
      console.log('å½“å‰é¡µé¢åœ¨ç™½åå•ä¸­ï¼Œå…è®¸è®¿é—®');
      return;
    }
    
    // æ£€æŸ¥å½“å‰è·¯å¾„æ˜¯å¦æ˜¯åŠŸèƒ½é¡µé¢
    const isFeaturePage = isAIFunctionLink(window.location.pathname);
    console.log('å½“å‰é¡µé¢æ˜¯å¦æ˜¯åŠŸèƒ½é¡µé¢:', isFeaturePage);
    
    if (isFeaturePage) {
      // å¦‚æœæ˜¯åŠŸèƒ½é¡µé¢ï¼Œæ˜¾ç¤ºå¼¹çª—å¹¶é˜»æ­¢è¿›ä¸€æ­¥åŠ è½½
      showMobileAlert(true);
      
      // å°è¯•é˜»æ­¢é¡µé¢å†…å®¹åŠ è½½
      document.addEventListener('DOMContentLoaded', function() {
        // éšè—é¡µé¢ä¸»è¦å†…å®¹
        const mainContent = document.querySelector('main') || document.querySelector('.container') || document.querySelector('.content');
        if (mainContent) {
          mainContent.style.display = 'none';
        }
        
        // å¦‚æœé¡µé¢ä¸­æœ‰iframeï¼Œä¹Ÿéšè—å®ƒä»¬
        const iframes = document.querySelectorAll('iframe');
        if (iframes.length > 0) {
          iframes.forEach(iframe => {
            iframe.style.display = 'none';
          });
        }
      });
    }
  }

  // æ•è·æ‰€æœ‰ç‚¹å‡»äº‹ä»¶
  document.addEventListener(
    'click',
    function (e) {
      const link = e.target.closest('a, button, [role="button"], .card, .feature-card, .function-card, .card-body'); // æŸ¥æ‰¾å¯ç‚¹å‡»å…ƒç´ 
      if (!link) return;

      // æ£€æŸ¥dataå±æ€§ä¸­çš„URLæˆ–åŠŸèƒ½ä¿¡æ¯
      const dataHref = link.dataset.href || link.dataset.url || link.dataset.link || link.dataset.target;
      const href = link.getAttribute('href');
      const onclick = link.getAttribute('onclick') || '';
      
      console.log('ç‚¹å‡»å…ƒç´ :', link.tagName, 'é“¾æ¥:', href || dataHref || 'æ— é“¾æ¥');
      
      // æ£€æŸ¥å…ƒç´ ç±»åæ˜¯å¦åŒ…å«åŠŸèƒ½å¡ç‰‡ç›¸å…³ç±»å
      const isFeatureCard = link.classList && (
        link.classList.contains('feature-card') || 
        link.classList.contains('function-card') || 
        link.classList.contains('ai-feature') ||
        link.classList.contains('feature-item')
      );
      
      // å¦‚æœæ˜¯åŠŸèƒ½å¡ç‰‡ï¼Œç›´æ¥æ‹¦æˆª
      if (isFeatureCard) {
        console.log('æ‹¦æˆªåŠŸèƒ½å¡ç‰‡ç‚¹å‡»');
        e.preventDefault();
        e.stopPropagation();
        showMobileAlert();
        return false;
      }
      
      // æ£€æŸ¥hrefå±æ€§
      if (href) {
        // è·³è¿‡é”šç‚¹é“¾æ¥å’Œçº¯JavaScriptä»£ç 
        if (href.startsWith('#') || href === 'javascript:void(0)') return;

        // å¤–éƒ¨é“¾æ¥æ”¾è¡Œ
        if (/^https?:\/\//i.test(href) && !href.includes(window.location.hostname)) return;

        // ç™½åå•æ”¾è¡Œ
        if (allowList.has(href)) return;

        // æ£€æŸ¥æ˜¯å¦æ˜¯AIåŠŸèƒ½é“¾æ¥
        if (isAIFunctionLink(href)) {
          console.log('æ‹¦æˆªåŠŸèƒ½é“¾æ¥ç‚¹å‡»:', href);
          e.preventDefault();
          e.stopPropagation();
          showMobileAlert();
          return false;
        }
      }
      
      // æ£€æŸ¥data-hrefå±æ€§
      if (dataHref && isAIFunctionLink(dataHref)) {
        console.log('æ‹¦æˆªdata-hrefåŠŸèƒ½é“¾æ¥ç‚¹å‡»:', dataHref);
        e.preventDefault();
        e.stopPropagation();
        showMobileAlert();
        return false;
      }

      // æ£€æŸ¥onclickå±æ€§ä¸­çš„è·³è½¬æˆ–checkAuthAndRedirectè°ƒç”¨
      if (onclick) {
        if (onclick.includes('location.href') || onclick.includes('window.location') || 
            onclick.includes('navigate') || onclick.includes('redirect')) {
          // å°è¯•æå–URL
          const urlMatch = onclick.match(/(location\.href|window\.location|location\.replace)\s*=\s*['"]([^'"]+)['"]/);
          if (urlMatch && urlMatch[2] && isAIFunctionLink(urlMatch[2])) {
            console.log('æ‹¦æˆªonclickä¸­çš„è·³è½¬:', urlMatch[2]);
            e.preventDefault();
            e.stopPropagation();
            showMobileAlert();
            return false;
          }
        }
        
        // æ£€æŸ¥checkAuthAndRedirectè°ƒç”¨
        if (onclick.includes('checkAuthAndRedirect')) {
          // æå–URLå‚æ•°
          const urlMatch = onclick.match(/checkAuthAndRedirect\(['"]([^'"]+)['"]\)/);
          if (urlMatch && urlMatch[1] && isAIFunctionLink(urlMatch[1])) {
            console.log('æ‹¦æˆªcheckAuthAndRedirectè°ƒç”¨:', urlMatch[1]);
            e.preventDefault();
            e.stopPropagation();
            showMobileAlert();
            return false;
          }
        }
      }
    },
    true // æ•è·é˜¶æ®µï¼Œä¼˜å…ˆè§¦å‘
  );

  // è¦†ç›–å…¨å±€è·³è½¬å‡½æ•°
  function overrideGlobalFunctions() {
    // ç«‹å³è¦†ç›– checkAuthAndRedirect å‡½æ•°
    if (window.checkAuthAndRedirect) {
      console.log('è¦†ç›–checkAuthAndRedirectå‡½æ•°');
      const originalCheckAuthAndRedirect = window.checkAuthAndRedirect;
      window.checkAuthAndRedirect = function (url) {
        console.log('checkAuthAndRedirectè¢«è°ƒç”¨:', url);
        if (url && isAIFunctionLink(url)) {
          showMobileAlert();
          return false;
        }
        // å¦‚æœä¸æ˜¯AIåŠŸèƒ½é“¾æ¥ï¼Œæ‰§è¡ŒåŸå‡½æ•°
        return originalCheckAuthAndRedirect.call(this, url);
      };
    }

    // è¦†ç›–å…¶ä»–å¯èƒ½çš„è·³è½¬å‡½æ•°
    const originalWindowOpen = window.open;
    window.open = function(url, name, specs) {
      console.log('window.openè¢«è°ƒç”¨:', url);
      if (url && isAIFunctionLink(url)) {
        showMobileAlert();
        return null;
      }
      return originalWindowOpen.call(this, url, name, specs);
    };
  }

  // ç¡®ä¿åœ¨é¡µé¢å®Œå…¨åŠ è½½åæ‰§è¡Œæ£€æŸ¥
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      checkCurrentPage();
      overrideGlobalFunctions();
    });
  } else {
    // å¦‚æœé¡µé¢å·²åŠ è½½å®Œæˆï¼Œç«‹å³æ‰§è¡Œ
    checkCurrentPage();
    overrideGlobalFunctions();
  }
  
  // ç«‹å³æ£€æŸ¥å½“å‰é¡µé¢ï¼ˆä¸ç­‰å¾…DOMContentLoadedï¼‰
  // ä½¿ç”¨try-catchåŒ…è£¹ï¼Œé˜²æ­¢å‡ºé”™
  try {
    checkCurrentPage();
  } catch (error) {
    console.error('æ£€æŸ¥å½“å‰é¡µé¢æ—¶å‡ºé”™:', error);
  }
})();
