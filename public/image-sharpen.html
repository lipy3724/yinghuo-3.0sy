npm <!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="image_sharpen.page_title">æ¨¡ç³Šå›¾ç‰‡å˜æ¸…æ™° - è¤ç«AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="/components/styles.css">
    <link href="/css/image-sharpen.css" rel="stylesheet">
    <script src="/translations.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #6366f1;
            background-color: #f9fafb;
        }
        .result-section {
            border-left: 1px solid #e5e7eb;
        }
        /* ä½¿ç”¨Tailwindè‡ªå¸¦çš„animate-spinæ›¿ä»£è‡ªå®šä¹‰spinner */
        .instructions {
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        .preview-area {
            background-color: #f9fafb;
            border-radius: 0.5rem;
            min-height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* å›¾ç‰‡æ‹–åŠ¨ç¦ç”¨ */
        img {
            -webkit-user-drag: none;
            user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        
        /* ç”Ÿæˆå†å²æ ·å¼ */
        .history-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .view-btn {
            transition: all 0.2s ease;
        }
        
        .view-btn:hover {
            transform: scale(1.1);
            background-color: #f3f4f6 !important;
        }
        
        .download-history-btn {
            transition: all 0.2s ease;
        }
        
        .download-history-btn:hover {
            color: #4f46e5 !important;
            transform: scale(1.1);
        }
        
        /* å†å²è®°å½•å¡ç‰‡æ ·å¼ */
        .history-card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .history-thumbnail {
            width: 100%;
            height: 8rem;
            object-fit: cover;
        }
    </style>

    <link rel="icon" href="/images/favicon.png" type="image/png">
    <script src="/js/translations.js"></script>
    <script src="/js/auth-check.js"></script>
    <script src="/js/mobile-guard.js"></script>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- å¯¼èˆªæ ç»„ä»¶å®¹å™¨ -->
    <div id="navbar-simple"></div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="container mx-auto py-8 px-4" style="margin-top: 60px;">
        <h1 class="text-3xl font-bold text-center mb-8" data-translate="image_sharpen.title">æ¨¡ç³Šå›¾ç‰‡å˜æ¸…æ™°</h1>
        
        <div class="w-full flex flex-col lg:flex-row bg-white" style="min-height: calc(100vh - 200px);">
            <!-- å·¦ä¾§ï¼šä¸Šä¼ å›¾ç‰‡å’Œæç¤ºè¯ -->
            <div class="w-full lg:w-1/3 border-r border-gray-200 p-5 flex flex-col h-full overflow-auto">
                <h2 class="text-xl font-bold mb-3" data-translate="image_sharpen.upload_image">å›¾åƒå¢å¼ºè®¾ç½®</h2>
                
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2" data-translate="image_sharpen.usage_tips">ä½¿ç”¨æç¤º:</p>
                    <div class="instructions bg-gray-50 p-3 rounded-md">
                        <p class="mb-2" data-translate="image_sharpen.tip1">æ­¤åŠŸèƒ½å¯ä»¥å°†æ¨¡ç³Šä¸æ¸…çš„ç…§ç‰‡å˜å¾—æ›´åŠ æ¸…æ™°é”åˆ©ï¼Œæå‡å›¾åƒè´¨é‡ã€‚</p>
                        <p class="mb-2" data-translate="image_sharpen.tip2">ä¸Šä¼ æ¨¡ç³Šã€å™ªç‚¹æˆ–è´¨é‡ä¸ä½³çš„å›¾åƒåï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ†æå¹¶å¢å¼ºå›¾åƒç»†èŠ‚å’Œæ¸…æ™°åº¦ã€‚</p>
                        <p class="mb-2" data-translate="image_sharpen.tip3">æ‚¨å¯ä»¥åœ¨æç¤ºæ¡†ä¸­æè¿°å¸Œæœ›å¢å¼ºçš„å…·ä½“åŒºåŸŸæˆ–æ•ˆæœï¼Œä¾‹å¦‚ï¼š"æé«˜äººè„¸ç»†èŠ‚æ¸…æ™°åº¦"ã€"å¢å¼ºæ–‡å­—å¯è¯»æ€§"ç­‰ã€‚</p>
                        <p class="mb-2" data-translate="image_sharpen.tip4">å›¾ç‰‡å°ºå¯¸è¦æ±‚ï¼šæœ€å°512Ã—512åƒç´ ï¼Œæœ€å¤§ä¸è¶…è¿‡4000Ã—4000åƒç´ ã€‚</p>
                        <p class="text-red-500 font-medium" data-translate="image_sharpen.warning">è¯·ä¸Šä¼ åˆæ³•åˆè§„çš„å›¾ç‰‡è§†é¢‘ï¼Œå¦‚æœ‰è¿åä¼šè¿›è¡Œå°å·å¤„ç†ï¼Œä»»åŠ¡ä¸€æ—¦æäº¤å°±ä¼šæ‰£é™¤ç§¯åˆ†ä¸å¯ä¸­æ–­ï¼Œè¯·å‹¿é‡å¤åˆ·æ–°æäº¤ï¼Œå¦åˆ™ä¼šé€ æˆç§¯åˆ†æµªè´¹ã€‚</p>
                    </div>
                </div>

                <div id="upload-area" class="upload-area h-36 flex flex-col items-center justify-center mb-4 bg-gray-50 border border-dashed border-gray-300 rounded-md hover:border-indigo-500 hover:bg-gray-100 transition-colors">
                    <i class="ri-upload-cloud-line text-2xl text-gray-400 mb-1"></i>
                    <p class="text-gray-500 text-center text-xs px-2" data-translate="image_sharpen.upload_click_or_drag">ç‚¹å‡»æˆ–è€…æ‹–åŠ¨æ–‡ä»¶åˆ°è¿™åŒºåŸŸæ¥ä¸Šä¼ </p>
                    <input type="file" id="image-upload" class="hidden" accept="image/*">
                </div>
                <p class="text-xs text-gray-500 mb-4" data-translate="image_sharpen.upload_image_label">ä¸Šä¼ å›¾åƒ</p>

                <!-- æç¤ºè¯è¾“å…¥æ¡† -->
                <div class="mb-4">
                    <label for="enhancement-prompt" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="ri-edit-line mr-1"></i><span data-translate="image_sharpen.enhancement_prompt">å¢å¼ºæç¤ºè¯</span>
                    </label>
                    <textarea 
                        id="enhancement-prompt" 
                        name="enhancement-prompt"
                        rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none"
data-translate-placeholder="image_sharpen.prompt_placeholder"
                        placeholder="æè¿°å¸Œæœ›å¢å¼ºçš„å…·ä½“åŒºåŸŸæˆ–æ•ˆæœï¼Œä¾‹å¦‚ï¼š&#10;â€¢ æé«˜äººè„¸ç»†èŠ‚æ¸…æ™°åº¦&#10;â€¢ å¢å¼ºæ–‡å­—å¯è¯»æ€§&#10;â€¢ å‡å°‘å™ªç‚¹ï¼Œæå‡æ•´ä½“æ¸…æ™°åº¦&#10;â€¢ å¢å¼ºè¾¹ç¼˜é”åº¦ï¼Œçªå‡ºä¸»ä½“è½®å»“"
                    ></textarea>
                    <div class="flex justify-between items-center mt-1">
                        <p class="text-xs text-gray-500" data-translate="image_sharpen.prompt_tip">æç¤ºï¼šè¯¦ç»†çš„æè¿°æœ‰åŠ©äºç”Ÿæˆæ›´å¥½çš„å¢å¼ºæ•ˆæœ</p>
                        <button type="button" id="clear-prompt-btn" class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline">
                            <i class="ri-close-line mr-1"></i><span data-translate="image_sharpen.clear">æ¸…ç©º</span>
                        </button>
                    </div>
                </div>

                <!-- è¿™é‡Œæ·»åŠ flex-growæ¥å ç”¨å‰©ä½™ç©ºé—´ï¼Œè®©æŒ‰é’®æ¨åˆ°åº•éƒ¨ -->
                <div class="flex-grow"></div>
                
                <button id="generate-btn" class="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 flex items-center justify-center mt-auto">
                    <i class="ri-magic-line mr-2"></i>
                    <span data-translate="image_sharpen.generate_now">ç«‹å³ç”Ÿæˆ</span>
                </button>
                <p class="mt-2 text-center text-sm text-gray-500">
                    <span data-translate="image_sharpen.generation_info">å›¾åƒç”Ÿæˆéœ€è¦10-20ç§’ï¼Œæ¶ˆè€—7ç§¯åˆ†</span>
                </p>
            </div>
            
            <!-- å³ä¾§ï¼šæ•ˆæœå±•ç¤º -->
            <div class="w-full lg:w-2/3 p-6 flex flex-col h-full overflow-auto">
                <h2 class="text-xl font-bold mb-4 text-center" data-translate="image_sharpen.effect_display">æ•ˆæœå±•ç¤º</h2>
                
                <div class="flex flex-col md:flex-row gap-6 flex-grow">
                    <div class="w-full md:w-1/2">
                        <h3 class="text-base font-medium mb-3 text-center" data-translate="image_sharpen.original_image">åŸå§‹å›¾åƒ:</h3>
                        <div id="original-image-container" class="h-64 md:h-96 bg-gray-100 rounded-md flex items-center justify-center overflow-hidden relative">
                            <img id="original-image" class="hidden max-w-full max-h-full object-contain" alt="ä¸Šä¼ çš„å›¾ç‰‡" draggable="false">
                            <p id="original-image-placeholder" class="text-gray-500 text-center px-4" data-translate="image_sharpen.upload_placeholder">ä¸Šä¼ å›¾ç‰‡åå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                        </div>
                    </div>
                    
                    <div class="w-full md:w-1/2">
                        <h3 class="text-base font-medium mb-3 text-center" data-translate="image_sharpen.generated_result">ç”Ÿæˆç»“æœ:</h3>
                        <div id="result-image-container" class="h-64 md:h-96 bg-gray-100 rounded-md flex items-center justify-center overflow-hidden">
                            <img id="result-image" class="hidden max-w-full max-h-full object-contain" alt="ç”Ÿæˆçš„å›¾ç‰‡">
                            <p id="result-image-placeholder" class="text-gray-500 text-center px-4" data-translate="image_sharpen.result_placeholder">ç”Ÿæˆç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-center space-x-4">
                    <button id="download-btn" class="hidden bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center">
                        <i class="ri-download-line mr-2"></i>
                        <span data-translate="image_sharpen.download_result">ä¸‹è½½ç»“æœ</span>
                    </button>
                    <button id="save-to-downloads-btn" class="hidden bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center justify-center">
                        <i class="ri-save-line mr-2"></i>
                        <span data-translate="image_sharpen.save_to_download_center">ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒ</span>
                    </button>
                </div>
                
                <!-- ç”Ÿæˆå†å²éƒ¨åˆ† -->
                <div class="bg-white p-6 rounded-lg shadow-md mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold" data-translate="image_sharpen.generation_history">ç”Ÿæˆå†å²</h2>
                        <div class="flex items-center space-x-2">
                            <button id="clear-history-btn" class="text-red-600 hover:text-red-800 text-sm" data-translate-title="image_sharpen.clear_history_title" title="æ¸…ç©ºå†å²è®°å½•">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                            <button id="refresh-history-btn" class="text-indigo-600 hover:text-indigo-800">
                                <i class="ri-refresh-line text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="history-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <!-- å†å²è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                        <p class="text-gray-500 col-span-full text-center py-4" data-translate="image_sharpen.no_history">æš‚æ— å†å²è®°å½•</p>
                    </div>
                    
                    <!-- ä¿å­˜æ—¶é—´æç¤º -->
                    <div class="mt-4 text-center">
                        <p class="text-xs text-gray-500">
                            <i class="ri-time-line mr-1"></i>
                            <span data-translate="image_sharpen.history_note">ä»…æ˜¾ç¤º24å°æ—¶å†…çš„å†å²è®°å½•</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½ä¸­é®ç½© -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500 mb-4"></div>
                <p id="loading-message" class="text-gray-700 text-center" data-translate="image_sharpen.processing">å¤„ç†ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...</p>
            <p class="text-sm text-gray-500 mt-2" data-translate="image_sharpen.processing_time">å¤„ç†æ—¶é—´çº¦ä¸º5-10ç§’</p>
            </div>
        </div>
    </div>

    <!-- å¼•ç”¨å¤–éƒ¨Javascriptæ–‡ä»¶ -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // åˆå§‹åŒ–ç¿»è¯‘ç³»ç»Ÿ
            if (typeof initializeTranslations === 'function') {
                initializeTranslations();
            }
            
            // é¦–å…ˆæ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
            console.log('å›¾ç‰‡é”åŒ–é¡µé¢ï¼šå¼€å§‹æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€');
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
            const authToken = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('user');
            
            if (!authToken || !userInfo) {
                console.log('å›¾ç‰‡é”åŒ–é¡µé¢ï¼šç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ');
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.href);
                return;
            }
            
            // å¦‚æœæœ‰ç»Ÿä¸€çš„è®¤è¯æ£€æŸ¥å‡½æ•°ï¼Œä½¿ç”¨å®ƒ
            if (typeof window.checkAuth === 'function') {
                try {
                    const isAuthenticated = await window.checkAuth(true);
                    if (!isAuthenticated) {
                        console.log('å›¾ç‰‡é”åŒ–é¡µé¢ï¼šè®¤è¯æ£€æŸ¥å¤±è´¥');
                        return; // checkAuthä¼šè‡ªåŠ¨å¤„ç†é‡å®šå‘
                    }
                    console.log('å›¾ç‰‡é”åŒ–é¡µé¢ï¼šè®¤è¯æ£€æŸ¥é€šè¿‡');
                } catch (error) {
                    console.error('å›¾ç‰‡é”åŒ–é¡µé¢ï¼šè®¤è¯æ£€æŸ¥å‡ºé”™:', error);
                    // å‡ºé”™æ—¶ä¹Ÿç»§ç»­åŠ è½½é¡µé¢ï¼Œä½†è®°å½•é”™è¯¯
                }
            }
            
            // è®¾ç½®ç”¨æˆ·çŠ¶æ€ç›‘å¬ï¼Œæ£€æµ‹ç”¨æˆ·åˆ‡æ¢
            setupUserStateListener();
            
            // DOMå…ƒç´ 
            const uploadArea = document.getElementById('upload-area');
            const imageUpload = document.getElementById('image-upload');
            const originalImage = document.getElementById('original-image');
            const originalImageContainer = document.getElementById('original-image-container');
            const originalImagePlaceholder = document.getElementById('original-image-placeholder');
            const resultImage = document.getElementById('result-image');
            const resultImagePlaceholder = document.getElementById('result-image-placeholder');
            const generateBtn = document.getElementById('generate-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            const downloadBtn = document.getElementById('download-btn');
            const saveToDownloadsBtn = document.getElementById('save-to-downloads-btn');
            
            // åˆå§‹åŒ–æç¤ºæ¡†é»˜è®¤å€¼
            const enhancementPrompt = document.getElementById('enhancement-prompt');
            if (enhancementPrompt) {
                enhancementPrompt.value = translate('image_sharpen.default_prompt');
            }
            
            // æ¸…ç©ºæç¤ºè¯æŒ‰é’®äº‹ä»¶
            const clearPromptBtn = document.getElementById('clear-prompt-btn');
            if (clearPromptBtn) {
                clearPromptBtn.addEventListener('click', () => {
                    if (enhancementPrompt) {
                        enhancementPrompt.value = '';
                        enhancementPrompt.focus();
                    }
                });
            }
            
            // å›¾ç‰‡ä¸Šä¼ å¤„ç†
            uploadArea.addEventListener('click', () => {
                imageUpload.click();
            });
            
            imageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleImageFile(file);
                }
            });
            
            // æ‹–æ”¾ä¸Šä¼ 
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            uploadArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const file = dt.files[0];
                
                if (file && file.type.startsWith('image/')) {
                    handleImageFile(file);
                } else {
                     alert(translate('image_sharpen.upload_image_file'));
                }
            });
            
            // ç”ŸæˆæŒ‰é’®ç‚¹å‡»
            generateBtn.addEventListener('click', async () => {
                if (!originalImage.src || originalImage.classList.contains('hidden')) {
                     alert(translate('image_sharpen.upload_first'));
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½ä¸­
                loadingOverlay.classList.remove('hidden');
                loadingMessage.textContent = translate('image_sharpen.processing_image');
                
                try {
                    // 1. ä¸Šä¼ åŸå›¾åˆ°æœåŠ¡å™¨è·å–URL
                     loadingMessage.textContent = translate('image_sharpen.uploading');
                    console.log(translate('image_sharpen.uploading_image'));
                    let imageUrl;
                    
                    try {
                        imageUrl = await uploadImageToServer(originalImage.src);
                    } catch (uploadError) {
                        console.error('å›¾ç‰‡ä¸Šä¼ é”™è¯¯:', uploadError);
                        throw new Error(`${translate('image_sharpen.upload_failed')}: ${uploadError.message}`);
                    }
                    
                    if (!imageUrl) {
                        throw new Error(translate('image_sharpen.upload_failed') + 'ï¼Œæœªè·å–åˆ°æœ‰æ•ˆURL');
                    }
                    
                    console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œè·å–åˆ°çš„URL:', imageUrl);
                    
                    // 2. è°ƒç”¨APIåˆ›å»ºå›¾åƒé”åŒ–ä»»åŠ¡
                    loadingMessage.textContent = translate('image_sharpen.creating_task');
                    console.log(translate('image_sharpen.creating_task'));
                    
                    // è·å–ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯
                    const enhancementPrompt = document.getElementById('enhancement-prompt').value.trim();
                    const prompt = enhancementPrompt || translate('image_sharpen.default_prompt');
                    
                    let taskId;
                    try {
                        taskId = await createSharpenTask(prompt, imageUrl);
                    } catch (taskError) {
                        console.error('åˆ›å»ºä»»åŠ¡é”™è¯¯:', taskError);
                        throw new Error(`${translate('image_sharpen.create_task_failed')}: ${taskError.message}`);
                    }
                    
                    if (!taskId) {
                        throw new Error(translate('image_sharpen.create_task_failed') + 'ï¼Œæœªè·å–åˆ°ä»»åŠ¡ID');
                    }
                    
                    console.log('åˆ›å»ºä»»åŠ¡æˆåŠŸï¼Œä»»åŠ¡ID:', taskId);
                    
                    // ä¿å­˜å½“å‰ä»»åŠ¡IDï¼Œç”¨äºå¯èƒ½çš„é€€æ¬¾è¯·æ±‚
                    window.currentSharpenTaskId = taskId;
                    
                    // 3. è½®è¯¢ä»»åŠ¡çŠ¶æ€
                     loadingMessage.textContent = translate('image_sharpen.processing');
                    console.log(translate('image_sharpen.polling_status'));
                    
                    let resultImageUrl;
                    try {
                        resultImageUrl = await pollTaskStatus(taskId);
                    } catch (pollError) {
                        console.error('è½®è¯¢ä»»åŠ¡çŠ¶æ€é”™è¯¯:', pollError);
                        throw new Error(`${translate('image_sharpen.get_result_failed')}: ${pollError.message}`);
                    }
                    
                    if (!resultImageUrl) {
                        throw new Error(translate('image_sharpen.get_result_failed') + 'ï¼Œæœªè·å–åˆ°æœ‰æ•ˆURL');
                    }
                    
                    console.log('è·å–ä»»åŠ¡ç»“æœæˆåŠŸï¼Œå›¾åƒURL:', resultImageUrl);
                    
                    // 4. æ˜¾ç¤ºç»“æœå›¾åƒ
                    loadingMessage.textContent = translate('image_sharpen.loading_result');
                    
                    resultImage.onload = () => {
                        loadingOverlay.classList.add('hidden');
                    };
                    
                    resultImage.onerror = () => {
                        loadingOverlay.classList.add('hidden');
                        alert(translate('image_sharpen.load_result_failed'));
                    };
                    
                    resultImage.src = resultImageUrl;
                    resultImage.classList.remove('hidden');
                    resultImagePlaceholder.classList.add('hidden');
                    downloadBtn.classList.remove('hidden');
                    saveToDownloadsBtn.classList.remove('hidden');
                    
                    // æ·»åŠ åˆ°å†å²è®°å½•
                    const originalImageSrc = originalImage.src;
                    addToHistory(originalImageSrc, resultImageUrl, prompt);
                } catch (error) {
                    console.error('å¤„ç†å¤±è´¥:', error);
                    
                    // å¦‚æœæœ‰ä»»åŠ¡IDï¼Œè¯·æ±‚é€€æ¬¾
                    if (window.currentSharpenTaskId) {
                        try {
                            await requestRefund(window.currentSharpenTaskId, error.message || translate('image_sharpen.task_processing_failed'));
                            console.log('å·²è¯·æ±‚é€€æ¬¾ï¼Œä»»åŠ¡ID:', window.currentSharpenTaskId);
                            alert(translate('image_sharpen.processing_failed_with_refund') + ': ' + error.message);
                        } catch (refundError) {
                            console.error('é€€æ¬¾è¯·æ±‚å¤±è´¥:', refundError);
                            alert(translate('image_sharpen.processing_failed_refund_failed') + ': ' + error.message);
                        }
                    } else {
                        alert(translate('image_sharpen.processing_failed') + ': ' + error.message);
                    }
                } finally {
                    // éšè—åŠ è½½é®ç½©
                    loadingOverlay.classList.add('hidden');
                }
            });
            
            // ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨
            async function uploadImageToServer(imageData) {
                try {
                    // è½¬æ¢ä¸ºBlobå¯¹è±¡
                    let blob;
                    if (imageData.startsWith('data:')) {
                        // ä»base64å­—ç¬¦ä¸²åˆ›å»ºBlobå¯¹è±¡
                        blob = base64ToBlob(imageData.split(',')[1], 'image/jpeg');
                    } else {
                        // å¤„ç†URLæƒ…å†µ - å…ˆè·å–å›¾åƒå†è½¬æ¢
                        const response = await fetch(imageData);
                        blob = await response.blob();
                    }
                    
                    // åˆ›å»ºFormDataå¯¹è±¡
                    const formData = new FormData();
                    formData.append('image', blob, 'image.jpg');
                    
                    // å‘é€è¯·æ±‚ä¸Šä¼ å›¾ç‰‡
                    console.log('å‡†å¤‡ä¸Šä¼ å›¾ç‰‡...');
                    const response = await fetch('/api/text-to-video/upload-image', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || translate('image_sharpen.upload_failed'));
                    }
                    
                    const imageUrl = data.output?.img_url || data.imageUrl;
                    console.log('ä¸Šä¼ å›¾ç‰‡ï¼Œè·å–åˆ°çš„URL:', imageUrl);
                    return imageUrl;
                } catch (error) {
                    console.error('å›¾ç‰‡ä¸Šä¼ é”™è¯¯:', error);
                    throw new Error(translate('image_sharpen.upload_failed') + ': ' + error.message);
                }
            }
            
            // Base64è½¬Blob
            function base64ToBlob(base64Data, mimeType = 'image/jpeg') {
                const byteCharacters = atob(base64Data);
                const byteArrays = [];
                
                for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                    const slice = byteCharacters.slice(offset, offset + 512);
                    
                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) {
                        byteNumbers[i] = slice.charCodeAt(i);
                    }
                    
                    const byteArray = new Uint8Array(byteNumbers);
                    byteArrays.push(byteArray);
                }
                
                return new Blob(byteArrays, { type: mimeType });
            }
            
            // åˆ›å»ºå›¾åƒé”åŒ–ä»»åŠ¡
            async function createSharpenTask(prompt, imageUrl) {
                try {
                    // å‡†å¤‡è¯·æ±‚æ•°æ®
                    const requestData = {
                        model: "wanx2.1-imageedit",
                        input: {
                            function: "super_resolution",
                            prompt: prompt || translate('image_sharpen.default_prompt'),
                            base_image_url: imageUrl,
                            upscale_factor: 1
                        },
                        parameters: {
                            n: 1
                        }
                    };
                    
                    console.log('å‘é€åˆ›å»ºå›¾åƒé”åŒ–ä»»åŠ¡è¯·æ±‚:', JSON.stringify(requestData));
                    
                    // é€šè¿‡æœåŠ¡å™¨ä»£ç†è°ƒç”¨API
                    const response = await fetch('/api/image-edit/create-task', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const data = await response.json();
                    
                    console.log('åˆ›å»ºä»»åŠ¡å“åº”:', data);
                    
                    if (!response.ok) {
                        if (data.message && data.message.includes('ç§¯åˆ†ä¸è¶³')) {
                            throw new Error(translate('image_sharpen.insufficient_credits'));
                        } else {
                            throw new Error(data.message || translate('image_sharpen.create_task_failed'));
                        }
                    }
                    
                    return data.output?.task_id;
                } catch (error) {
                    console.error('åˆ›å»ºä»»åŠ¡é”™è¯¯:', error);
                    throw new Error(translate('image_sharpen.create_task_failed') + ': ' + error.message);
                }
            }
            
            // è½®è¯¢ä»»åŠ¡çŠ¶æ€
            async function pollTaskStatus(taskId) {
                return new Promise((resolve, reject) => {
                    // è®¡æ•°å™¨ï¼Œé˜²æ­¢æ— é™è½®è¯¢
                    let attempts = 0;
                    let errorCount = 0;
                    const maxAttempts = 60; // æœ€å¤šè½®è¯¢60æ¬¡ï¼Œçº¦10åˆ†é’Ÿ
                    
                    // è½®è¯¢é—´éš”ï¼Œé¦–æ¬¡10ç§’ï¼Œåç»­æ¯æ¬¡10ç§’
                    const pollInterval = 10000;
                    
                    // è½®è¯¢å‡½æ•°
                    async function checkStatus() {
                        if (attempts >= maxAttempts) {
                            clearTimeout(timeoutId);
                            reject(new Error(translate('image_sharpen.task_timeout')));
                            return;
                        }
                        
                        attempts++;
                        loadingMessage.textContent = `å¤„ç†ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…... (${attempts}/${maxAttempts})`;
                        
                        try {
                            const response = await fetch(`/api/image-edit/task-status/${taskId}`, {
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(translate('image_sharpen.get_result_failed') + 'ï¼ŒæœåŠ¡å™¨é”™è¯¯');
                            }
                            
                            const data = await response.json();
                            console.log(`è½®è¯¢ç»“æœ (${attempts}/${maxAttempts}):`, data);
                            
                            // è¯¦ç»†è®°å½•APIå“åº”ç»“æ„ï¼Œä¾¿äºè°ƒè¯•
                            console.log('APIå“åº”è¯¦æƒ… - request_id:', data.request_id);
                            console.log('APIå“åº”è¯¦æƒ… - output:', data.output);
                            if (data.output) {
                                console.log('APIå“åº”è¯¦æƒ… - task_status:', data.output.task_status);
                                console.log('APIå“åº”è¯¦æƒ… - task_id:', data.output.task_id);
                                if (data.output.results) {
                                    console.log('APIå“åº”è¯¦æƒ… - results:', JSON.stringify(data.output.results));
                                }
                            }
                            
                            // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
                            const taskStatus = data.output?.task_status;
                            
                            if (taskStatus === 'SUCCEEDED') {
                                // æˆåŠŸå®Œæˆ
                                const resultsList = data.output?.results || [];
                                if (resultsList.length > 0) {
                                    // æ£€æŸ¥æ˜¯å¦æœ‰éƒ¨åˆ†å¤±è´¥çš„æƒ…å†µ
                                    const successResults = resultsList.filter(result => result.url && result.url.trim() !== '');
                                    const failedResults = resultsList.filter(result => result.code || !result.url || result.url.trim() === '');
                                    
                                    if (successResults.length > 0) {
                                        // è‡³å°‘æœ‰ä¸€ä¸ªæˆåŠŸçš„ç»“æœ
                                        const resultImageUrl = successResults[0].url;
                                        if (!resultImageUrl || resultImageUrl.trim() === '') {
                                            clearTimeout(timeoutId);
                                            
                                            // è¯·æ±‚é€€æ¬¾ - è™½ç„¶çŠ¶æ€æ˜¯æˆåŠŸï¼Œä½†æ²¡æœ‰æœ‰æ•ˆURL
                                            try {
                                                await requestRefund(taskId, translate('image_sharpen.task_empty_result'));
                                                console.log('å·²è¯·æ±‚é€€æ¬¾ï¼ŒåŸå› ï¼šä»»åŠ¡è¿”å›ç©ºç»“æœ');
                                            } catch (refundError) {
                                                console.error('é€€æ¬¾è¯·æ±‚å¤±è´¥:', refundError);
                                            }
                                            
                                            reject(new Error('ä»»åŠ¡å®Œæˆä½†è¿”å›ç©ºç»“æœï¼Œç³»ç»Ÿå·²è‡ªåŠ¨ç”³è¯·é€€æ¬¾'));
                                            return;
                                        }
                                        clearTimeout(timeoutId);
                                        resolve(resultImageUrl);
                                        
                                        // å¦‚æœæœ‰éƒ¨åˆ†å¤±è´¥ï¼Œåœ¨æ§åˆ¶å°è®°å½•
                                        if (failedResults.length > 0) {
                                            console.warn('éƒ¨åˆ†ç”Ÿæˆå¤±è´¥:', failedResults);
                                        }
                                        return;
                                    } else {
                                        // æ‰€æœ‰ç»“æœéƒ½å¤±è´¥äº†
                                        clearTimeout(timeoutId);
                                        
                                        // è¯·æ±‚é€€æ¬¾
                                        try {
                                            await requestRefund(taskId, translate('image_sharpen.task_all_results_failed'));
                                            console.log('å·²è¯·æ±‚é€€æ¬¾ï¼ŒåŸå› ï¼šä»»åŠ¡æˆåŠŸä½†æ‰€æœ‰ç»“æœéƒ½å¤±è´¥');
                                        } catch (refundError) {
                                            console.error('é€€æ¬¾è¯·æ±‚å¤±è´¥:', refundError);
                                        }
                                        
                                        reject(new Error('ä»»åŠ¡æˆåŠŸä½†æœªæ‰¾åˆ°ç»“æœï¼Œè¯·é‡è¯•ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨ç”³è¯·é€€æ¬¾'));
                                        return;
                                    }
                                } else {
                                    clearTimeout(timeoutId);
                                    
                                    // è¯·æ±‚é€€æ¬¾ - çŠ¶æ€æ˜¯æˆåŠŸä½†ç»“æœåˆ—è¡¨ä¸ºç©º
                                    try {
                                        await requestRefund(taskId, 'ä»»åŠ¡æˆåŠŸä½†æœªæ‰¾åˆ°ç»“æœå›¾åƒ');
                                        console.log('å·²è¯·æ±‚é€€æ¬¾ï¼ŒåŸå› ï¼šä»»åŠ¡æˆåŠŸä½†ç»“æœåˆ—è¡¨ä¸ºç©º');
                                    } catch (refundError) {
                                        console.error('é€€æ¬¾è¯·æ±‚å¤±è´¥:', refundError);
                                    }
                                    
                                    reject(new Error('ä»»åŠ¡æˆåŠŸä½†æœªæ‰¾åˆ°ç»“æœï¼Œè¯·é‡è¯•ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨ç”³è¯·é€€æ¬¾'));
                                    return;
                                }
                            } 
                            else if (taskStatus === 'FAILED') {
                                // ä»»åŠ¡å¤±è´¥ï¼Œè·å–é”™è¯¯è¯¦æƒ…
                                clearTimeout(timeoutId);
                                const errorCode = data.output?.code || '';
                                const errorMsg = data.output?.message || 'æœªçŸ¥é”™è¯¯';
                                
                                // è¯·æ±‚é€€æ¬¾
                                try {
                                    await requestRefund(taskId, `ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${errorMsg}`);
                                    console.log('å·²è¯·æ±‚é€€æ¬¾ï¼ŒåŸå› ï¼šä»»åŠ¡æ‰§è¡Œå¤±è´¥');
                                } catch (refundError) {
                                    console.error('é€€æ¬¾è¯·æ±‚å¤±è´¥:', refundError);
                                }
                                
                                reject(new Error(`ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ${errorMsg}`));
                                return;
                            } 
                            else if (taskStatus === 'CANCELED') {
                                // ä»»åŠ¡è¢«å–æ¶ˆ
                                clearTimeout(timeoutId);
                                
                                // è¯·æ±‚é€€æ¬¾
                                try {
                                    await requestRefund(taskId, 'ä»»åŠ¡å·²è¢«å–æ¶ˆ');
                                    console.log('å·²è¯·æ±‚é€€æ¬¾ï¼ŒåŸå› ï¼šä»»åŠ¡å·²è¢«å–æ¶ˆ');
                                } catch (refundError) {
                                    console.error('é€€æ¬¾è¯·æ±‚å¤±è´¥:', refundError);
                                }
                                
                                reject(new Error('ä»»åŠ¡å·²è¢«å–æ¶ˆï¼Œè¯·é‡è¯•'));
                                return;
                            }
                            else if (taskStatus === 'UNKNOWN') {
                                // ä»»åŠ¡çŠ¶æ€æœªçŸ¥
                                clearTimeout(timeoutId);
                                
                                // è¯·æ±‚é€€æ¬¾
                                try {
                                    await requestRefund(taskId, 'ä»»åŠ¡çŠ¶æ€æœªçŸ¥');
                                    console.log('å·²è¯·æ±‚é€€æ¬¾ï¼ŒåŸå› ï¼šä»»åŠ¡çŠ¶æ€æœªçŸ¥');
                                } catch (refundError) {
                                    console.error('é€€æ¬¾è¯·æ±‚å¤±è´¥:', refundError);
                                }
                                
                                reject(new Error('ä»»åŠ¡çŠ¶æ€æœªçŸ¥ï¼Œè¯·é‡è¯•'));
                                return;
                            }
                            // çŠ¶æ€ä¸ºPENDINGæˆ–RUNNINGï¼Œç»§ç»­è½®è¯¢
                            console.log(`ä»»åŠ¡çŠ¶æ€: ${taskStatus}, ç»§ç»­è½®è¯¢...`);
                            timeoutId = setTimeout(checkStatus, pollInterval);
                        } catch (error) {
                            console.error(`è½®è¯¢å‡ºé”™ (${attempts}/${maxAttempts}):`, error);
                            errorCount++;
                            
                            // å¦‚æœè¿ç»­é”™è¯¯è¶…è¿‡3æ¬¡ï¼Œåˆ™æ”¾å¼ƒ
                            if (errorCount >= 3) {
                                clearTimeout(timeoutId);
                                
                                // è¯·æ±‚é€€æ¬¾
                                try {
                                    await requestRefund(taskId, 'ç½‘ç»œè¿æ¥ä¸ç¨³å®š');
                                    console.log('å·²è¯·æ±‚é€€æ¬¾ï¼ŒåŸå› ï¼šç½‘ç»œè¿æ¥ä¸ç¨³å®š');
                                } catch (refundError) {
                                    console.error('é€€æ¬¾è¯·æ±‚å¤±è´¥:', refundError);
                                }
                                
                                reject(new Error('ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•'));
                                return;
                            }
                            
                            // ç»§ç»­è½®è¯¢
                            timeoutId = setTimeout(checkStatus, pollInterval);
                        }
                    }
                    
                    // å¼€å§‹è½®è¯¢
                    let timeoutId = setTimeout(checkStatus, 3000); // é¦–æ¬¡å»¶è¿Ÿ3ç§’åå¼€å§‹è½®è¯¢
                });
            }
            
            // ä¸‹è½½æŒ‰é’®
            downloadBtn.addEventListener('click', () => {
                if (resultImage.src) {
                    const link = document.createElement('a');
                    link.href = resultImage.src;
                    link.download = 'sharpen-image.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
            
            // ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒæŒ‰é’®
            saveToDownloadsBtn.addEventListener('click', async () => {
                if (!resultImage.src) return;
                
                try {
                    // æ˜¾ç¤ºåŠ è½½ä¸­
                    loadingOverlay.classList.remove('hidden');
                    loadingMessage.textContent = translate('image_sharpen.saving_to_download_center');
                    
                    console.log('å‡†å¤‡ä¿å­˜å›¾ç‰‡åˆ°ä¸‹è½½ä¸­å¿ƒ:', resultImage.src.substring(0, 50) + '...');
                    
                    // è°ƒç”¨APIä¿å­˜å›¾ç‰‡åˆ°ä¸‹è½½ä¸­å¿ƒ
                    const response = await fetch('/api/downloads/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            imageUrl: resultImage.src,
                            title: 'æ¨¡ç³Šå›¾ç‰‡å˜æ¸…æ™°',
                            description: 'å›¾åƒé”åŒ–å¤„ç†',
                            type: 'IMAGE_SHARPENING'
                        })
                    });
                    
                    console.log('ä¿å­˜å“åº”çŠ¶æ€:', response.status);
                    
                    const data = await response.json();
                    console.log('ä¿å­˜å“åº”æ•°æ®:', data);
                    
                    if (!response.ok) {
                        throw new Error(data.message || data.error || translate('image_sharpen.save_failed_generic'));
                    }
                    
                    if (data.success) {
                        alert(translate('image_sharpen.save_success'));
                    } else {
                        throw new Error(data.message || translate('image_sharpen.save_failed_generic'));
                    }
                } catch (error) {
                    console.error('ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒå¤±è´¥:', error);
                    alert(translate('image_sharpen.save_failed') + ': ' + error.message);
                } finally {
                    // éšè—åŠ è½½é®ç½©
                    loadingOverlay.classList.add('hidden');
                }
            });
            
            // è¾…åŠ©å‡½æ•°
            function handleImageFile(file) {
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                     alert(translate('image_sharpen.supported_formats'));
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                if (file.size > 10 * 1024 * 1024) { // 10MB é™åˆ¶
                    alert(translate('image_sharpen.file_too_large'));
                    return;
                }
                
                // åˆ›å»ºé¢„è§ˆå¹¶æ£€æŸ¥å›¾ç‰‡å°ºå¯¸
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = function() {
                        // æ£€æŸ¥å›¾ç‰‡å°ºå¯¸
                        if (img.width < 512 || img.height < 512) {
                            alert(translate('image_sharpen.image_too_small'));
                            return;
                        }
                        
                        if (img.width > 4000 || img.height > 4000) {
                            alert(translate('image_sharpen.image_too_large'));
                            return;
                        }
                        
                        // æ˜¾ç¤ºåŸå§‹å›¾ç‰‡
                        originalImage.src = event.target.result;
                        originalImage.classList.remove('hidden');
                        originalImagePlaceholder.classList.add('hidden');
                        
                        // é‡ç½®ç»“æœåŒºåŸŸ
                        resultImage.classList.add('hidden');
                        resultImagePlaceholder.classList.remove('hidden');
                        downloadBtn.classList.add('hidden');
                        saveToDownloadsBtn.classList.add('hidden');
                    };
                    img.src = event.target.result;
                };
                reader.onerror = () => {
                    alert(translate('image_sharpen.read_file_failed'));
                };
                reader.readAsDataURL(file);
            }
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                uploadArea.classList.add('border-indigo-500', 'bg-indigo-50');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('border-indigo-500', 'bg-indigo-50');
            }

            // æ·»åŠ é€€æ¬¾è¯·æ±‚å‡½æ•°
            async function requestRefund(taskId, reason) {
                try {
                    const response = await fetch('/api/refund/image-sharpening', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            taskId: taskId,
                            reason: reason
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'é€€æ¬¾è¯·æ±‚å¤±è´¥');
                    }
                    
                    return data.success;
                } catch (error) {
                    console.error('é€€æ¬¾è¯·æ±‚é”™è¯¯:', error);
                    throw new Error('é€€æ¬¾è¯·æ±‚å¤±è´¥: ' + error.message);
                }
            }

            // æ·»åŠ åˆ°å†å²è®°å½•
            function addToHistory(originalImage, resultImage, prompt) {
                console.log('å¼€å§‹ä¿å­˜å†å²è®°å½•:', { 
                    originalImage: originalImage ? (originalImage.substring(0, 50) + '...') : 'undefined', 
                    resultImage: resultImage ? (resultImage.substring(0, 50) + '...') : 'undefined', 
                    prompt 
                });
                
                // ç¡®ä¿ä¸¤ä¸ªå›¾ç‰‡URLéƒ½å­˜åœ¨
                if (!originalImage || !resultImage) {
                    console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥: åŸå§‹å›¾ç‰‡æˆ–ç»“æœå›¾ç‰‡URLä¸ºç©º');
                    return;
                }
                
                const historyItem = {
                    originalImage: originalImage,
                    resultImage: resultImage,
                    prompt: prompt,
                    createdAt: new Date().toISOString()
                };
                
                console.log('åˆ›å»ºå†å²è®°å½•é¡¹:', {
                    originalImage: historyItem.originalImage.substring(0, 50) + '...',
                    resultImage: historyItem.resultImage.substring(0, 50) + '...',
                    prompt: historyItem.prompt,
                    createdAt: historyItem.createdAt
                });
                
                // å†å²è®°å½•ä¿å­˜ç­–ç•¥ï¼šä¼˜å…ˆOSSï¼Œå¤±è´¥æ—¶ä½¿ç”¨localStorageå¤‡é€‰æ–¹æ¡ˆ
                console.log('ğŸ“ å¼€å§‹ä¿å­˜å†å²è®°å½•ï¼ˆOSSä¼˜å…ˆï¼ŒlocalStorageå¤‡é€‰ï¼‰');
                saveHistoryToOSS(historyItem)
                    .then(() => {
                        console.log('âœ… å†å²è®°å½•å·²æˆåŠŸä¿å­˜åˆ°OSSï¼ˆä¼˜å…ˆæ–¹æ¡ˆï¼‰');
                        // åˆ·æ–°å†å²è®°å½•æ˜¾ç¤º
                        loadHistory();
                    })
                    .catch(error => {
                        console.error('âŒ OSSä¿å­˜å¤±è´¥ï¼Œå¯ç”¨localStorageå¤‡é€‰æ–¹æ¡ˆ:', error);
                        // å°è¯•ä½¿ç”¨localStorageä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                        saveHistoryToLocalStorage(historyItem);
                        console.log('ğŸ’¾ å·²å¯ç”¨localStorageå¤‡é€‰æ–¹æ¡ˆä¿å­˜å†å²è®°å½•');
                        // å³ä½¿ä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆï¼Œä¹Ÿè¦åˆ·æ–°å†å²è®°å½•æ˜¾ç¤º
                        loadHistory();
                    });
            }

            // ä¿å­˜å†å²è®°å½•åˆ°é˜¿é‡Œäº‘OSSï¼ˆä¼˜å…ˆæ–¹æ¡ˆï¼‰
            async function saveHistoryToOSS(historyItem) {
                try {
                    // ä»localStorageè·å–è®¤è¯ä»¤ç‰Œ
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        console.warn('æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œæ— æ³•ä¿å­˜åˆ°OSS');
                        throw new Error('æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œ');
                    }
                    
                    console.log('å¼€å§‹ä¿å­˜å†å²è®°å½•åˆ°é˜¿é‡Œäº‘OSSï¼ˆä¼˜å…ˆæ–¹æ¡ˆï¼‰');
                    console.log('å½“å‰ç”¨æˆ·ä¿¡æ¯:', {
                        authToken: authToken ? authToken.substring(0, 10) + '...' : 'æ— ',
                        userInfo: localStorage.getItem('user') ? JSON.parse(localStorage.getItem('user')).id || 'æ— ç”¨æˆ·ID' : 'æ— ç”¨æˆ·ä¿¡æ¯'
                    });
                    
                    // æ£€æŸ¥å†å²è®°å½•é¡¹æ˜¯å¦å®Œæ•´
                    if (!historyItem.originalImage || !historyItem.resultImage) {
                        console.warn('å†å²è®°å½•é¡¹ä¸å®Œæ•´ï¼Œè¯¦æƒ…:', {
                            æœ‰åŸå§‹å›¾ç‰‡: !!historyItem.originalImage,
                            æœ‰ç»“æœå›¾ç‰‡: !!historyItem.resultImage,
                            æœ‰æç¤ºè¯: !!historyItem.prompt,
                            æœ‰åˆ›å»ºæ—¶é—´: !!historyItem.createdAt
                        });
                    }
                    
                    // å‡†å¤‡è¯·æ±‚æ•°æ®
                    const data = {
                        originalImage: historyItem.originalImage,
                        resultImage: historyItem.resultImage,
                        prompt: historyItem.prompt || 'å›¾ç‰‡é”åŒ–',
                        processType: 'IMAGE_SHARPENING',
                        timestamp: new Date().toISOString(),
                        createdAt: historyItem.createdAt || new Date().toISOString() // ç¡®ä¿æœ‰åˆ›å»ºæ—¶é—´
                    };
                    
                    console.log('å‡†å¤‡å‘é€åˆ°æœåŠ¡å™¨çš„æ•°æ®:', {
                        åŸå§‹å›¾ç‰‡: data.originalImage ? data.originalImage.substring(0, 50) + '...' : 'æ— ',
                        ç»“æœå›¾ç‰‡: data.resultImage ? data.resultImage.substring(0, 50) + '...' : 'æ— ',
                        æç¤ºè¯: data.prompt,
                        å¤„ç†ç±»å‹: data.processType,
                        æ—¶é—´æˆ³: data.timestamp,
                        åˆ›å»ºæ—¶é—´: data.createdAt
                    });
                    
                    // å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
                    console.log('å¼€å§‹å‘é€è¯·æ±‚åˆ°OSSæœåŠ¡å™¨...');
                    const response = await fetch('/api/image-sharpen-history/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(data)
                    });
                    
                    console.log('OSSæœåŠ¡å™¨å“åº”çŠ¶æ€ç :', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('OSSæœåŠ¡å™¨å“åº”é”™è¯¯å†…å®¹:', errorText);
                        throw new Error(`OSSä¿å­˜å¤±è´¥: ${response.status}, é”™è¯¯å†…å®¹: ${errorText}`);
                    }
                    
                    const result = await response.json();
                    console.log('âœ… å†å²è®°å½•å·²æˆåŠŸä¿å­˜åˆ°OSSï¼ˆä¼˜å…ˆæ–¹æ¡ˆï¼‰:', result);
                    
                    return result;
                } catch (error) {
                    console.error('âŒ ä¿å­˜åˆ°é˜¿é‡Œäº‘OSSå¤±è´¥ï¼ˆå°†ä½¿ç”¨localStorageå¤‡é€‰æ–¹æ¡ˆï¼‰:', error);
                    console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                    console.error('é”™è¯¯å †æ ˆ:', error.stack);
                    throw error; // æŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨æ–¹å¤„ç†å¤‡é€‰æ–¹æ¡ˆ
                }
            }

            // å¤‡é€‰æ–¹æ¡ˆï¼šä¿å­˜åˆ°localStorageï¼ˆä»…åœ¨OSSä¿å­˜å¤±è´¥æ—¶ä½¿ç”¨ï¼‰
            function saveHistoryToLocalStorage(historyItem) {
                try {
                    console.log('ğŸ”„ ä½¿ç”¨localStorageä¿å­˜å†å²è®°å½•ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰');
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œä½†åªä¿å­˜å›¾ç‰‡URLå¼•ç”¨è€Œä¸æ˜¯å®Œæ•´çš„base64æ•°æ®
                    let history = JSON.parse(localStorage.getItem('imageSharpenHistory') || '[]');
                    console.log('å½“å‰localStorageä¸­çš„å†å²è®°å½•:', history);
                    
                    // åˆ›å»ºä¸€ä¸ªç²¾ç®€ç‰ˆçš„å†å²è®°å½•é¡¹ï¼Œé¿å…å­˜å‚¨è¿‡å¤§çš„æ•°æ®
                    const compactHistoryItem = {
                        originalImage: typeof historyItem.originalImage === 'string' && historyItem.originalImage.startsWith('data:') 
                            ? 'å›¾ç‰‡å¤ªå¤§æ— æ³•ä¿å­˜' // ä¸ä¿å­˜base64æ•°æ®
                            : historyItem.originalImage, // ä¿å­˜URLå¼•ç”¨
                        resultImage: typeof historyItem.resultImage === 'string' && historyItem.resultImage.startsWith('data:')
                            ? 'å›¾ç‰‡å¤ªå¤§æ— æ³•ä¿å­˜' // ä¸ä¿å­˜base64æ•°æ®
                            : historyItem.resultImage, // ä¿å­˜URLå¼•ç”¨
                        prompt: historyItem.prompt,
                        createdAt: historyItem.createdAt
                    };
                    
                    console.log('åˆ›å»ºç²¾ç®€ç‰ˆå†å²è®°å½•é¡¹:', compactHistoryItem);
                    
                    history.unshift(compactHistoryItem);
                    console.log('æ·»åŠ æ–°è®°å½•åçš„å†å²è®°å½•:', history);
                    
                    // è¿‡æ»¤æœ€è¿‘1å¤©çš„è®°å½•
                    const oneDayAgo = new Date();
                    oneDayAgo.setDate(oneDayAgo.getDate() - 1);
                    
                    history = history.filter(item => {
                        // ç¡®ä¿æ¯æ¡è®°å½•éƒ½æœ‰åˆ›å»ºæ—¶é—´
                        if (!item.createdAt) {
                            item.createdAt = new Date().toISOString();
                        }
                        const itemDate = new Date(item.createdAt);
                        return itemDate >= oneDayAgo;
                    });
                    
                    console.log('è¿‡æ»¤1å¤©å†…è®°å½•åçš„å†å²è®°å½•:', history);
                    
                    // é™åˆ¶å†å²è®°å½•æ•°é‡ä¸º3ä¸ª
                    if (history.length > 3) {
                        history = history.slice(0, 3);
                    }
                    
                    // åœ¨å­˜å‚¨å‰æ£€æŸ¥æ•°æ®å¤§å°
                    const dataSize = JSON.stringify(history).length;
                    if (dataSize > 2000000) { // å¦‚æœæ•°æ®å¤§äº2MB
                        console.warn('å†å²è®°å½•æ•°æ®è¿‡å¤§ï¼Œæ¸…ç†æ—§è®°å½•');
                        history = history.slice(0, 1); // åªä¿ç•™æœ€æ–°çš„ä¸€æ¡
                    }
                    
                    console.log('æœ€ç»ˆä¿å­˜åˆ°localStorageçš„å†å²è®°å½•ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰:', history);
                    localStorage.setItem('imageSharpenHistory', JSON.stringify(history));
                    console.log('âœ… å†å²è®°å½•å·²æˆåŠŸä¿å­˜åˆ°localStorageï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰');
                    
                    // åˆ·æ–°å†å²è®°å½•æ˜¾ç¤º
                    loadHistory();
                } catch (error) {
                    console.error('ä¿å­˜åˆ°localStorageå¤±è´¥:', error);
                    // å°è¯•æ¸…ç†localStorage
                    try {
                        localStorage.removeItem('imageSharpenHistory');
                        console.log('å·²æ¸…ç†å†å²è®°å½•ç¼“å­˜');
                    } catch (e) {
                        console.error('æ¸…ç†ç¼“å­˜å¤±è´¥', e);
                    }
                }
            }

            // åŠ è½½å†å²è®°å½•
            async function loadHistory() {
                console.log('å¼€å§‹åŠ è½½å†å²è®°å½•');
                const historyContainer = document.getElementById('history-container');
                if (!historyContainer) {
                    console.error('æ‰¾ä¸åˆ°å†å²è®°å½•å®¹å™¨');
                    return;
                }
                
                try {
                    // å†å²è®°å½•åŠ è½½ç­–ç•¥ï¼šä¼˜å…ˆä»OSSåŠ è½½ï¼Œå¤±è´¥æ—¶ä»localStorageåŠ è½½
                    console.log('ğŸ“– å¼€å§‹åŠ è½½å†å²è®°å½•ï¼ˆOSSä¼˜å…ˆï¼ŒlocalStorageå¤‡é€‰ï¼‰');
                    let history = [];
                    
                    try {
                        console.log('ğŸ” å°è¯•ä»OSSåŠ è½½å†å²è®°å½•ï¼ˆä¼˜å…ˆæ–¹æ¡ˆï¼‰...');
                        history = await loadHistoryFromOSS();
                        console.log('âœ… ä»OSSæˆåŠŸè·å–åˆ°çš„å†å²è®°å½•:', history);
                    } catch (ossError) {
                        console.error('âŒ ä»OSSåŠ è½½å†å²è®°å½•å¤±è´¥ï¼Œå¯ç”¨localStorageå¤‡é€‰æ–¹æ¡ˆ:', ossError);
                        
                        try {
                            console.log('ğŸ”„ å°è¯•ä»localStorageåŠ è½½å†å²è®°å½•ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰...');
                            const localHistoryStr = localStorage.getItem('imageSharpenHistory') || '[]';
                            history = JSON.parse(localHistoryStr);
                            
                            if (!Array.isArray(history)) {
                                console.warn('localStorageä¸­çš„å†å²è®°å½•ä¸æ˜¯æ•°ç»„ï¼Œä½¿ç”¨ç©ºæ•°ç»„');
                                history = [];
                            }
                            
                            console.log('ğŸ’¾ ä»localStorageæˆåŠŸåŠ è½½çš„å†å²è®°å½•ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰:', history);
                        } catch (localError) {
                            console.error('âŒ ä»localStorageåŠ è½½å†å²è®°å½•ä¹Ÿå¤±è´¥:', localError);
                            history = [];
                        }
                    }
                    
                    if (!history || history.length === 0) {
                        console.log('æ²¡æœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                        const noHistoryText = translate('image_sharpen.no_history');
                        historyContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">${noHistoryText}</p>`;
                        return;
                    }
                    
                    // è¿‡æ»¤24å°æ—¶å†…çš„è®°å½•
                    const now = new Date();
                    const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    
                    const recentHistory = history.filter(item => {
                        // ç¡®ä¿æ¯ä¸ªè®°å½•éƒ½æœ‰æ—¶é—´æˆ³
                        // ä¸ç›´æ¥ä¿®æ”¹åŸå¯¹è±¡ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ç”¨äºåç»­å¤„ç†
                        let itemWithTimestamp = item;
                        if (!item.createdAt && !item.processTime && !item.timestamp) {
                            console.warn('å†å²è®°å½•ç¼ºå°‘åˆ›å»ºæ—¶é—´ï¼Œæ·»åŠ å½“å‰æ—¶é—´:', item);
                            // åˆ›å»ºæ–°å¯¹è±¡è€Œä¸æ˜¯ä¿®æ”¹åŸå¯¹è±¡
                            itemWithTimestamp = {...item, timestamp: new Date().toISOString()};
                        }
                        
                        const itemDate = new Date(itemWithTimestamp.processTime || itemWithTimestamp.createdAt || itemWithTimestamp.timestamp);
                        const isRecent = itemDate >= twentyFourHoursAgo;
                        
                        if (!isRecent) {
                            console.log('è¿‡æ»¤æ‰è¶…è¿‡24å°æ—¶çš„è®°å½•:', {
                                è®°å½•æ—¶é—´: itemDate.toLocaleString(),
                                å½“å‰æ—¶é—´: now.toLocaleString(),
                                æç¤ºè¯: itemWithTimestamp.description || itemWithTimestamp.prompt || 'å›¾ç‰‡é”åŒ–'
                            });
                        }
                        
                        return isRecent;
                    });
                    
                    console.log(`è¿‡æ»¤å‰å†å²è®°å½•æ•°é‡: ${history.length}, è¿‡æ»¤åæ•°é‡: ${recentHistory.length}`);
                    
                    if (recentHistory.length === 0) {
                        console.log('24å°æ—¶å†…æ²¡æœ‰å†å²è®°å½•ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
                        const noHistoryText = translate('image_sharpen.no_history');
                        historyContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">${noHistoryText}</p>`;
                        return;
                    }
                    
                    // æ¸…ç©ºå†å²è®°å½•å®¹å™¨
                    historyContainer.innerHTML = '';
                    
                    // éå†å†å²è®°å½•å¹¶åˆ›å»ºå¡ç‰‡
                        // ç¡®ä¿recentHistoryæ˜¯æ•°ç»„
                        if (!Array.isArray(recentHistory)) {
                            console.error('recentHistoryä¸æ˜¯æ•°ç»„:', recentHistory);
                            historyContainer.innerHTML = '<p class="text-red-500 text-center py-4">å†å²è®°å½•æ ¼å¼é”™è¯¯</p>';
                            return;
                        }
                        
                        // ä½¿ç”¨å®‰å…¨çš„æ–¹å¼éå†å†å²è®°å½•
                        // ä½¿ç”¨å¸¸è§„forå¾ªç¯æ›¿ä»£forEachï¼Œé¿å…åŒ¿åå‡½æ•°ä¸­çš„thisç»‘å®šé—®é¢˜
                        for (let index = 0; index < recentHistory.length; index++) {
                            // ä½¿ç”¨ä¸´æ—¶å˜é‡å­˜å‚¨å½“å‰é¡¹ï¼Œé¿å…ç›´æ¥ä¿®æ”¹recentHistoryä¸­çš„é¡¹
                            const item = Object.assign({}, recentHistory[index]);
                            // ç¡®ä¿itemæ˜¯å¯¹è±¡è€Œä¸æ˜¯æ•°ç»„
                            if (!item || Array.isArray(item) || typeof item !== 'object') {
                                console.error('å†å²è®°å½•é¡¹æ— æ•ˆæˆ–ä¸æ˜¯å¯¹è±¡:', item);
                                continue; // è·³è¿‡è¿™æ¡è®°å½•
                            }
                            console.log(`æ¸²æŸ“æœåŠ¡å™¨å†å²è®°å½•é¡¹ ${index}:`, item);
                        
                            const historyCard = document.createElement('div');
                            historyCard.className = 'history-card';
                            
                            // å¤„ç†ä¸åŒæ•°æ®æºçš„å­—æ®µå·®å¼‚
                            // å®‰å…¨åœ°è·å–å›¾ç‰‡URL
                            let originalImage = null;
                            let resultImage = null;
                            
                            try {
                                originalImage = item.originalImage || item.baseImageUrl || null;
                                resultImage = item.processedImageUrl || item.resultImage || item.imageUrl;
                            } catch (e) {
                                console.error('è·å–å›¾ç‰‡URLæ—¶å‡ºé”™:', e);
                            }
                            const prompt = item.description || item.prompt || 'å›¾ç‰‡é”åŒ–';
                            const timestamp = item.processTime || item.createdAt;
                        
                            console.log(`å†å²è®°å½•é¡¹ ${index} çš„å›¾ç‰‡URL:`, {
                                åŸå§‹å›¾ç‰‡: originalImage ? originalImage.substring(0, 50) + '...' : 'æ— ',
                                ç»“æœå›¾ç‰‡: resultImage ? resultImage.substring(0, 50) + '...' : 'æ— ',
                                æç¤ºè¯: prompt
                            });
                            
                            if (!resultImage) {
                                console.warn('å†å²è®°å½•é¡¹ç¼ºå°‘ç»“æœå›¾ç‰‡URL:', item);
                                continue; // è·³è¿‡æ— æ•ˆè®°å½•
                            }
                        
                            // éªŒè¯æ—¶é—´æˆ³
                            let createdAt = 'æœªçŸ¥æ—¶é—´';
                            // ç¡®ä¿æœ‰æ—¶é—´æˆ³ï¼Œåˆ›å»ºå‰¯æœ¬è€Œä¸æ˜¯ä¿®æ”¹åŸå¯¹è±¡
                            let safeTimestamp = timestamp || new Date().toISOString();
                            
                                    try {
                                        const date = new Date(safeTimestamp);
                                        if (!isNaN(date.getTime())) {
                                            // ä½¿ç”¨ä¸åç«¯ä¸€è‡´çš„æ—¶é—´æ ¼å¼
                                            createdAt = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
                                        }
                            } catch (error) {
                                console.warn('æ—¶é—´æˆ³æ ¼å¼åŒ–å¤±è´¥:', safeTimestamp, error);
                            }
                        
                            historyCard.innerHTML = `
                                <div class="relative">
                                    <img src="${resultImage || '#'}" alt="ç»“æœå›¾" class="history-thumbnail w-full h-32 object-cover" loading="lazy" 
                                         onerror="this.onerror=null;this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiPuWbvueJh+WKoOi9veWksei0pTwvdGV4dD48L3N2Zz4=';">
                                </div>
                                <div class="p-3">
                                    <p class="text-sm text-gray-700 truncate" title="${prompt}">${prompt || 'å›¾ç‰‡é”åŒ–'}</p>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-xs text-gray-500">${createdAt}</span>
                                        <button class="download-history-btn text-indigo-600 hover:text-indigo-800 p-1">
                                            <i class="ri-download-line"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        
                            // ä¸‹è½½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                            const downloadHistoryBtn = historyCard.querySelector('.download-history-btn');
                            if (downloadHistoryBtn) {
                                downloadHistoryBtn.addEventListener('click', function() {
                                    try {
                                        // éªŒè¯å›¾ç‰‡URLæ˜¯å¦æœ‰æ•ˆ
                                        const validateUrl = (url) => {
                                            return url && typeof url === 'string' && (url.startsWith('http') || url.startsWith('data:') || url.startsWith('blob:'));
                                        };
                                        
                                        const validOriginal = validateUrl(originalImage) && originalImage !== 'å›¾ç‰‡å¤ªå¤§æ— æ³•ä¿å­˜';
                                        const validResult = validateUrl(resultImage);
                                        
                                        console.log('ä¸‹è½½å›¾ç‰‡çŠ¶æ€:', {
                                            åŸå§‹å›¾ç‰‡æœ‰æ•ˆ: validOriginal,
                                            ç»“æœå›¾ç‰‡æœ‰æ•ˆ: validResult,
                                            åŸå§‹å›¾ç‰‡URL: originalImage ? originalImage.substring(0, 30) + '...' : 'æ— ',
                                            ç»“æœå›¾ç‰‡URL: resultImage ? resultImage.substring(0, 30) + '...' : 'æ— '
                                        });
                                        
                                        // åªä¸‹è½½ç»“æœå›¾ç‰‡
                                        if (validResult) {
                                            downloadImage(resultImage, `é”åŒ–ç»“æœ_${Date.now()}.png`);
                                        } else {
                                            alert(translate('image_sharpen.result_not_available'));
                                        }
                                    } catch (e) {
                                        console.error('ä¸‹è½½å†å²è®°å½•å›¾ç‰‡å¤±è´¥:', e);
                                        alert(translate('image_sharpen.download_failed'));
                                    }
                                });
                            }
                            
                            historyContainer.appendChild(historyCard);
                    }
                } catch (error) {
                    console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                    
                    // è®°å½•æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                    let errorDetails = 'æœªçŸ¥é”™è¯¯';
                    if (error instanceof TypeError) {
                        errorDetails = 'TypeError: ' + (error.message || 'ç±»å‹é”™è¯¯');
                    } else if (error instanceof SyntaxError) {
                        errorDetails = 'SyntaxError: ' + (error.message || 'JSONè§£æé”™è¯¯');
                    } else if (error instanceof Error) {
                        errorDetails = error.name + ': ' + (error.message || 'æœªçŸ¥é”™è¯¯');
                    }
                    console.error('é”™è¯¯ç±»å‹å’Œè¯¦æƒ…:', errorDetails);
                    
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    historyContainer.innerHTML = `<div class="text-center py-8">
                        <p class="text-red-500 mb-2">åŠ è½½å†å²è®°å½•å¤±è´¥</p>
                        <p class="text-sm text-gray-500">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</p>
                        <p class="text-xs text-gray-400 mt-1">é”™è¯¯ä¿¡æ¯: ${errorDetails}</p>
                        <button onclick="loadHistory()" class="mt-2 text-indigo-600 hover:text-indigo-800 text-sm">ç‚¹å‡»é‡è¯•</button>
                    </div>`;
                    
                    // å°è¯•ä»localStorageåŠ è½½
                    try {
                        console.log('å°è¯•ä»localStorageåŠ è½½å†å²è®°å½•');
                        loadHistoryFromLocalStorage();
                    } catch (localStorageError) {
                        console.error('ä»localStorageåŠ è½½å†å²è®°å½•å¤±è´¥:', localStorageError);
                        const noHistoryText = translate('image_sharpen.no_history');
                        historyContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">${noHistoryText}</p>`;
                    }
                }
                
                // ä»localStorageåŠ è½½å†å²è®°å½•çš„å‡½æ•°
                function loadHistoryFromLocalStorage(historyArray) {
                    try {
                        // ä½¿ç”¨ä¼ å…¥çš„æ•°ç»„æˆ–ä»localStorageè·å–
                        const localHistory = historyArray || JSON.parse(localStorage.getItem('imageSharpenHistory') || '[]');
                        console.log('ä»localStorageè·å–åˆ°çš„å†å²è®°å½•:', localHistory);
                        
                        if (localHistory.length === 0) {
                            console.log('localStorageä¸­ä¹Ÿæ²¡æœ‰å†å²è®°å½•');
                            const noHistoryText = translate('image_sharpen.no_history');
                            historyContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">${noHistoryText}</p>`;
                            return;
                        }
                        
                        // è¿‡æ»¤24å°æ—¶å†…çš„è®°å½•
                        const now = new Date();
                        const twentyFourHoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                        
                        // ç¡®ä¿localHistoryæ˜¯æ•°ç»„å¹¶ä¸”æ¯ä¸ªå…ƒç´ æ˜¯å¯¹è±¡
                        if (!Array.isArray(localHistory)) {
                            console.error('localStorageä¸­çš„å†å²è®°å½•ä¸æ˜¯æ•°ç»„:', localHistory);
                            // åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„å˜é‡ï¼Œè€Œä¸æ˜¯å°è¯•ä¿®æ”¹constå˜é‡
                            const fixedLocalHistory = [];
                            // ä½¿ç”¨fixedLocalHistoryæ›¿ä»£localHistoryè¿›è¡Œåç»­æ“ä½œ
                            return loadHistoryFromLocalStorage(fixedLocalHistory);
                        }
                        
                        // åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„æ¥å­˜å‚¨24å°æ—¶å†…çš„è®°å½•
                        const recentLocalHistory = [];
                        
                        // éå†å†å²è®°å½•å¹¶è¿‡æ»¤
                        for (let i = 0; i < localHistory.length; i++) {
                            const item = localHistory[i];
                            
                            // è·³è¿‡éå¯¹è±¡æˆ–æ•°ç»„ç±»å‹çš„é¡¹
                            if (!item || typeof item !== 'object' || Array.isArray(item)) {
                                console.warn('è·³è¿‡æ— æ•ˆçš„localStorageå†å²è®°å½•é¡¹:', item);
                                continue;
                            }
                            
                            // åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ï¼Œè€Œä¸æ˜¯ä¿®æ”¹åŸå¯¹è±¡
                            const itemCopy = {...item};
                            
                            // ç¡®ä¿æ¯ä¸ªè®°å½•éƒ½æœ‰æ—¶é—´æˆ³
                            if (!itemCopy.createdAt && !itemCopy.timestamp) {
                                console.warn('localStorageå†å²è®°å½•ç¼ºå°‘åˆ›å»ºæ—¶é—´ï¼Œæ·»åŠ å½“å‰æ—¶é—´');
                                // ä¸ä¿®æ”¹åŸå¯¹è±¡ï¼Œè€Œæ˜¯åœ¨å‰¯æœ¬ä¸Šæ·»åŠ å±æ€§
                                const updatedItem = {...itemCopy, timestamp: new Date().toISOString()};
                                
                                const itemDate = new Date(updatedItem.createdAt || updatedItem.timestamp || now.toISOString());
                                if (itemDate >= twentyFourHoursAgo) {
                                    recentLocalHistory.push(updatedItem);
                                }
                            } else {
                                const itemDate = new Date(itemCopy.createdAt || itemCopy.timestamp || now.toISOString());
                                if (itemDate >= twentyFourHoursAgo) {
                                    recentLocalHistory.push(itemCopy);
                                }
                            }
                        }
                        
                        console.log(`localStorageè¿‡æ»¤å‰å†å²è®°å½•æ•°é‡: ${localHistory.length}, è¿‡æ»¤åæ•°é‡: ${recentLocalHistory.length}`);
                        
                        if (recentLocalHistory.length === 0) {
                            console.log('localStorageä¸­24å°æ—¶å†…æ²¡æœ‰å†å²è®°å½•');
                            const noHistoryText = translate('image_sharpen.no_history');
                            historyContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">${noHistoryText}</p>`;
                            return;
                        }
                        
                        // æ¸…ç©ºå†å²è®°å½•å®¹å™¨
                        historyContainer.innerHTML = '';
                        
                        // éå†å†å²è®°å½•å¹¶åˆ›å»ºå¡ç‰‡
                        for (let index = 0; index < recentLocalHistory.length; index++) {
                            // åˆ›å»ºå‰¯æœ¬é¿å…ä¿®æ”¹åŸå¯¹è±¡
                            const item = Object.assign({}, recentLocalHistory[index]);
                            // ç¡®ä¿itemæ˜¯å¯¹è±¡è€Œä¸æ˜¯æ•°ç»„
                            if (Array.isArray(item)) {
                                console.error('localStorageå†å²è®°å½•é¡¹æ˜¯æ•°ç»„è€Œä¸æ˜¯å¯¹è±¡:', item);
                                continue; // è·³è¿‡è¿™æ¡è®°å½•
                            }
                            console.log(`æ¸²æŸ“localStorageå†å²è®°å½•é¡¹ ${index}:`, item);
                            
                            const historyCard = document.createElement('div');
                            historyCard.className = 'history-card';
                            
                            const originalImage = item.originalImage;
                            const resultImage = item.resultImage;
                            const prompt = item.prompt || 'å›¾ç‰‡é”åŒ–';
                            
                            console.log(`localStorageå†å²è®°å½•é¡¹ ${index} çš„å›¾ç‰‡URL:`, {
                                åŸå§‹å›¾ç‰‡: originalImage ? (typeof originalImage === 'string' ? originalImage.substring(0, 50) + '...' : 'éå­—ç¬¦ä¸²') : 'æ— ',
                                ç»“æœå›¾ç‰‡: resultImage ? (typeof resultImage === 'string' ? resultImage.substring(0, 50) + '...' : 'éå­—ç¬¦ä¸²') : 'æ— ',
                                æç¤ºè¯: prompt
                            });
                            
                            // éªŒè¯æ—¶é—´æˆ³
                            let createdAt = 'æœªçŸ¥æ—¶é—´';
                            // ç¡®ä¿æœ‰åˆ›å»ºæ—¶é—´ï¼Œä½†ä¸ä¿®æ”¹åŸå¯¹è±¡
                            const itemWithTimestamp = item.createdAt ? item : { ...item, createdAt: new Date().toISOString() };
                            
                            try {
                                const date = new Date(itemWithTimestamp.createdAt);
                                if (!isNaN(date.getTime())) {
                                    createdAt = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
                                }
                            } catch (error) {
                                console.warn('localStorageæ—¶é—´æˆ³æ ¼å¼åŒ–å¤±è´¥:', itemWithTimestamp.createdAt, error);
                            }
                            
                            // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å¯ç”¨
                            if (!resultImage || resultImage === 'å›¾ç‰‡å¤ªå¤§æ— æ³•ä¿å­˜') {
                                console.warn('localStorageå†å²è®°å½•é¡¹ç»“æœå›¾ç‰‡ä¸å¯ç”¨:', item);
                                continue; // è·³è¿‡æ— æ•ˆè®°å½•
                            }
                            
                            historyCard.innerHTML = `
                                <div class="relative">
                                    <img src="${resultImage || '#'}" alt="ç»“æœå›¾" class="history-thumbnail w-full h-32 object-cover" loading="lazy" onerror="this.onerror=null;this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiPuWbvueJh+WKoOi9veWksei0pTwvdGV4dD48L3N2Zz4=';">
                                </div>
                                <div class="p-3">
                                    <p class="text-sm text-gray-700 truncate" title="${prompt}">${prompt || 'å›¾ç‰‡é”åŒ–'}</p>
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="text-xs text-gray-500">${createdAt}</span>
                                        <button class="download-history-btn text-indigo-600 hover:text-indigo-800 p-1">
                                            <i class="ri-download-line"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                            
                            // ä¸‹è½½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                            const downloadHistoryBtn = historyCard.querySelector('.download-history-btn');
                            if (downloadHistoryBtn) {
                                downloadHistoryBtn.addEventListener('click', function() {
                                    try {
                                        // åªä¸‹è½½ç»“æœå›¾ç‰‡
                                        downloadImage(resultImage, `é”åŒ–ç»“æœ_${Date.now()}.png`);
                                    } catch (error) {
                                        console.error('ä¸‹è½½å†å²è®°å½•å›¾ç‰‡å¤±è´¥:', error);
                                        alert(translate('image_sharpen.download_failed'));
                                    }
                                });
                            }
                            
                            historyContainer.appendChild(historyCard);
                        }
                    } catch (localError) {
                        console.error('ä»localStorageåŠ è½½å†å²è®°å½•å¤±è´¥:', localError);
                        const noHistoryText = translate('image_sharpen.no_history');
                        historyContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center py-4">${noHistoryText}</p>`;
                    }
                }
            }

            // ä»æœåŠ¡å™¨åŠ è½½å†å²è®°å½•
            async function loadHistoryFromServer() {
                try {
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        console.log('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•è·å–å†å²è®°å½•');
                        return [];
                    }

                    const response = await fetch('/api/history', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (data.success && data.results) {
                        // è¿‡æ»¤å‡ºå›¾ç‰‡é”åŒ–ç›¸å…³çš„è®°å½•
                        const sharpenHistory = data.results.filter(record => 
                            record && typeof record === 'object' && (
                                record.processType === 'IMAGE_SHARPENING' || 
                                record.processType === 'å›¾ç‰‡é”åŒ–' ||
                                record.type === 'IMAGE_SHARPENING' ||
                                record.type === 'å›¾ç‰‡é”åŒ–'
                            )
                        );
                        
                        console.log(`ä»æœåŠ¡å™¨è·å–åˆ° ${sharpenHistory.length} æ¡é”åŒ–å†å²è®°å½•:`, sharpenHistory);
                        
                        // éªŒè¯æ¯æ¡è®°å½•çš„æ•°æ®å®Œæ•´æ€§
                        const validHistory = sharpenHistory.filter(record => {
                            const isValid = record && 
                                (record.originalImage || record.resultImage || record.prompt) &&
                                record.createdAt;
                            
                            if (!isValid) {
                                console.warn('å‘ç°æ— æ•ˆçš„å†å²è®°å½•é¡¹:', record);
                            }
                            
                            return isValid;
                        });
                        
                        console.log(`éªŒè¯åæœ‰æ•ˆè®°å½• ${validHistory.length} æ¡:`, validHistory);
                        return validHistory;
                    } else {
                        console.log('æœåŠ¡å™¨è¿”å›æ•°æ®æ ¼å¼é”™è¯¯:', data);
                        return [];
                    }
                } catch (error) {
                    console.error('ä»æœåŠ¡å™¨åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                    return [];
                }
            }

            // ä»é˜¿é‡Œäº‘OSSåŠ è½½å†å²è®°å½•
            // ä»é˜¿é‡Œäº‘OSSåŠ è½½å†å²è®°å½•
            async function loadHistoryFromOSS() {
                // æ·»åŠ é˜²é”™æœºåˆ¶
                let retryCount = 0;
                const maxRetries = 2;
                try {
                    // ä»localStorageè·å–è®¤è¯ä»¤ç‰Œ
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        console.warn('æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨');
                        try {
                            const localHistoryStr = localStorage.getItem('imageSharpenHistory') || '[]';
                            const localHistory = JSON.parse(localHistoryStr);
                            
                            // éªŒè¯è§£æç»“æœæ˜¯å¦ä¸ºæ•°ç»„
                            if (!Array.isArray(localHistory)) {
                                console.warn('localStorageä¸­çš„å†å²è®°å½•ä¸æ˜¯æ•°ç»„æ ¼å¼ï¼Œè¿”å›ç©ºæ•°ç»„');
                                return [];
                            }
                            
                            console.log('ä»localStorageåŠ è½½çš„å†å²è®°å½•:', localHistory);
                            return localHistory;
                        } catch (parseError) {
                            console.error('è§£ælocalStorageå†å²è®°å½•å¤±è´¥:', parseError);
                            return [];
                        }
                    }
                    
                    console.log('å¼€å§‹ä»é˜¿é‡Œäº‘OSSåŠ è½½å†å²è®°å½•');
                    
                    // å…ˆæµ‹è¯•APIæ˜¯å¦å¯ç”¨
                    try {
                        const testResponse = await fetch('/api/image-sharpen-history/test');
                        if (!testResponse.ok) {
                            console.warn('å†å²è®°å½•APIæµ‹è¯•å¤±è´¥ï¼ŒçŠ¶æ€ç :', testResponse.status);
                        } else {
                            console.log('å†å²è®°å½•APIæµ‹è¯•æˆåŠŸ');
                        }
                    } catch (testError) {
                        console.warn('å†å²è®°å½•APIæµ‹è¯•å‡ºé”™:', testError);
                    }
                    
                    // å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
                    const response = await fetch('/api/image-sharpen-history/list', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        console.warn(`HTTPé”™è¯¯: ${response.status}ï¼Œå›é€€åˆ°æœ¬åœ°å­˜å‚¨`);
                        throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                    }
                    
                    let data;
                    try {
                        data = await response.json();
                        console.log('OSSè¿”å›çš„å†å²è®°å½•æ•°æ®:', data);
                    } catch (jsonError) {
                        console.error('è§£æOSSè¿”å›çš„JSONæ•°æ®å¤±è´¥:', jsonError);
                        throw new Error('è§£ææœåŠ¡å™¨è¿”å›æ•°æ®å¤±è´¥');
                    }
                    
                    if (data.success && data.records) {
                        // ç¡®ä¿recordsæ˜¯æ•°ç»„
                        if (!Array.isArray(data.records)) {
                            console.warn('OSSè¿”å›çš„recordsä¸æ˜¯æ•°ç»„:', data.records);
                            return [];
                        }
                        
                        // éªŒè¯å¹¶è¿‡æ»¤è®°å½•
                        const validRecords = data.records
                            .filter(record => 
                                record && 
                                typeof record === 'object' && 
                                !Array.isArray(record) &&
                                (record.originalImage || record.resultImage) &&
                                record.timestamp
                            )
                            // åªä¿ç•™24å°æ—¶å†…çš„è®°å½•
                            .filter(record => {
                                const recordTime = new Date(record.timestamp);
                                const twentyFourHoursAgo = new Date();
                                twentyFourHoursAgo.setHours(twentyFourHoursAgo.getHours() - 24);
                                return recordTime >= twentyFourHoursAgo;
                            })
                            // å»é‡ï¼šæ ¹æ®ç»“æœå›¾ç‰‡URLå»é‡ï¼Œä¿ç•™æœ€æ–°çš„è®°å½•
                            .reduce((unique, record) => {
                                // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨ç›¸åŒç»“æœå›¾ç‰‡URLçš„è®°å½•
                                const existingIndex = unique.findIndex(item => 
                                    item.resultImage === record.resultImage
                                );
                                
                                if (existingIndex >= 0) {
                                    // å¦‚æœå­˜åœ¨ï¼Œæ¯”è¾ƒæ—¶é—´æˆ³ï¼Œä¿ç•™æœ€æ–°çš„
                                    const existingTime = new Date(unique[existingIndex].timestamp).getTime();
                                    const currentTime = new Date(record.timestamp).getTime();
                                    
                                    if (currentTime > existingTime) {
                                        // ç”¨æ–°è®°å½•æ›¿æ¢æ—§è®°å½•
                                        unique[existingIndex] = record;
                                    }
                                } else {
                                    // å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ åˆ°ç»“æœé›†
                                    unique.push(record);
                                }
                                
                                return unique;
                            }, [])
                            // æŒ‰æ—¶é—´æˆ³é™åºæ’åºï¼ˆæœ€æ–°çš„æ’åœ¨å‰é¢ï¼‰
                            .sort((a, b) => {
                                const timeA = new Date(a.timestamp).getTime();
                                const timeB = new Date(b.timestamp).getTime();
                                return timeB - timeA;
                            })
                            // åªä¿ç•™æœ€æ–°çš„3æ¡è®°å½•
                            .slice(0, 3);
                            
                        console.log(`ä»OSSè·å–åˆ° ${validRecords.length} æ¡æœ‰æ•ˆå†å²è®°å½•`);
                        return validRecords;
                    } else {
                        console.warn('OSSè¿”å›çš„æ•°æ®æ ¼å¼æ— æ•ˆï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨');
                    }
                    
                    // å¦‚æœOSSæ²¡æœ‰æ•°æ®æˆ–æ•°æ®æ— æ•ˆï¼Œå°è¯•ä»localStorageåŠ è½½
                    console.log('OSSæ— æœ‰æ•ˆæ•°æ®ï¼Œå°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½å†å²è®°å½•');
                    const localHistory = JSON.parse(localStorage.getItem('imageSharpenHistory') || '[]');
                    
                    // è¿‡æ»¤24å°æ—¶å†…çš„è®°å½•å¹¶åªä¿ç•™æœ€æ–°çš„3æ¡
                    const twentyFourHoursAgo = new Date();
                    twentyFourHoursAgo.setHours(twentyFourHoursAgo.getHours() - 24);
                    
                    const recentLocalHistory = localHistory
                        .filter(item => {
                            const itemDate = new Date(item.createdAt);
                            return itemDate >= twentyFourHoursAgo;
                        })
                        // æŒ‰æ—¶é—´æˆ³é™åºæ’åºï¼ˆæœ€æ–°çš„æ’åœ¨å‰é¢ï¼‰
                        .sort((a, b) => {
                            const timeA = new Date(a.createdAt).getTime();
                            const timeB = new Date(b.createdAt).getTime();
                            return timeB - timeA;
                        })
                        .slice(0, 3);
                        
                    console.log(`ä»localStorageåŠ è½½çš„å†å²è®°å½•: è¿‡æ»¤å‰ ${localHistory.length} æ¡ï¼Œè¿‡æ»¤å ${recentLocalHistory.length} æ¡`);
                    return recentLocalHistory;
                } catch (error) {
                    console.error('ä»OSSåŠ è½½å†å²è®°å½•å¤±è´¥ï¼Œè¯¦ç»†é”™è¯¯:', error);
                    console.error('é”™è¯¯çŠ¶æ€ç :', error.status || 'æœªçŸ¥');
                    console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                    
                    // ä»localStorageåŠ è½½å¹¶è¿‡æ»¤
                    try {
                        const localHistory = JSON.parse(localStorage.getItem('imageSharpenHistory') || '[]');
                        
                        // è¿‡æ»¤24å°æ—¶å†…çš„è®°å½•å¹¶åªä¿ç•™æœ€æ–°çš„3æ¡
                        const twentyFourHoursAgo = new Date();
                        twentyFourHoursAgo.setHours(twentyFourHoursAgo.getHours() - 24);
                        
                        const recentLocalHistory = localHistory
                            .filter(item => {
                                const itemDate = new Date(item.createdAt);
                                return itemDate >= twentyFourHoursAgo;
                            })
                            .slice(0, 3);
                            
                        console.log(`é”™è¯¯å›é€€åˆ°localStorageçš„å†å²è®°å½•: è¿‡æ»¤å‰ ${localHistory.length} æ¡ï¼Œè¿‡æ»¤å ${recentLocalHistory.length} æ¡`);
                        return recentLocalHistory;
                    } catch (localError) {
                        console.error('localStorageä¹ŸåŠ è½½å¤±è´¥:', localError);
                        return [];
                    }
                }
            }

            // æ¸…ç©ºå†å²è®°å½•æŒ‰é’®äº‹ä»¶
            document.getElementById('clear-history-btn').addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    clearHistoryFromOSS()
                        .then(result => {
                            if (result.success) {
                                // åŒæ—¶æ¸…ç©ºlocalStorageä¸­çš„å¤‡ä»½
                                localStorage.removeItem('imageSharpenHistory');
                                // åˆ·æ–°å†å²è®°å½•æ˜¾ç¤º
                                loadHistory();
                                // æç¤ºç”¨æˆ·
                                alert(translate('image_sharpen.history_cleared'));
                            } else {
                                alert(translate('image_sharpen.clear_history_failed') + ': ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                            }
                        })
                        .catch(error => {
                            console.error('æ¸…ç©ºå†å²è®°å½•å¤±è´¥:', error);
                            alert(translate('image_sharpen.clear_history_failed') + ': ' + error.message);
                        });
                }
            });

            // ä»OSSæ¸…é™¤å†å²è®°å½•
            async function clearHistoryFromOSS() {
                try {
                    // ä»localStorageè·å–è®¤è¯ä»¤ç‰Œ
                    const authToken = localStorage.getItem('authToken');
                    if (!authToken) {
                        console.warn('æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œåªæ¸…é™¤æœ¬åœ°å­˜å‚¨');
                        // æ¸…ç©ºlocalStorageä¸­çš„å¤‡ä»½
                        localStorage.removeItem('imageSharpenHistory');
                        return { success: true };
                    }
                    
                    console.log('å¼€å§‹æ¸…é™¤é˜¿é‡Œäº‘OSSä¸­çš„å†å²è®°å½•');
                    
                    // å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
                    const response = await fetch('/api/image-sharpen-history/clear', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('OSSå†å²è®°å½•å·²æ¸…é™¤:', result);
                    
                    return result;
                } catch (error) {
                    console.error('æ¸…é™¤OSSå†å²è®°å½•å¤±è´¥:', error);
                    throw error;
                }
            }
            
            // åˆ·æ–°å†å²è®°å½•æŒ‰é’®äº‹ä»¶
            document.getElementById('refresh-history-btn').addEventListener('click', function() {
                loadHistory();
            });

            // æ˜¾ç¤ºå›¾ç‰‡å‡½æ•°
            function displayImages(originalImageSrc, resultImageSrc) {
                console.log('æ˜¾ç¤ºå›¾ç‰‡:', {
                    åŸå§‹å›¾ç‰‡: originalImageSrc ? originalImageSrc.substring(0, 50) + '...' : 'æ— ',
                    ç»“æœå›¾ç‰‡: resultImageSrc ? resultImageSrc.substring(0, 50) + '...' : 'æ— '
                });
                
                const originalImage = document.getElementById('original-image');
                const resultImage = document.getElementById('result-image');
                const originalImagePlaceholder = document.getElementById('original-image-placeholder');
                const resultImagePlaceholder = document.getElementById('result-image-placeholder');
                
                // æ˜¾ç¤ºåŸå§‹å›¾ç‰‡
                if (originalImageSrc && originalImageSrc !== 'å›¾ç‰‡å¤ªå¤§æ— æ³•ä¿å­˜') {
                    originalImage.src = originalImageSrc;
                    originalImage.classList.remove('hidden');
                    originalImagePlaceholder.classList.add('hidden');
                } else {
                    // å¦‚æœæ²¡æœ‰åŸå§‹å›¾ç‰‡ï¼Œæ˜¾ç¤ºæç¤º
                    originalImage.classList.add('hidden');
                    originalImagePlaceholder.classList.remove('hidden');
                    originalImagePlaceholder.textContent = 'åŸå§‹å›¾ç‰‡ä¸å¯ç”¨';
                }
                
                // æ˜¾ç¤ºç»“æœå›¾ç‰‡
                if (resultImageSrc) {
                    resultImage.src = resultImageSrc;
                    resultImage.classList.remove('hidden');
                    resultImagePlaceholder.classList.add('hidden');
                } else {
                    // å¦‚æœæ²¡æœ‰ç»“æœå›¾ç‰‡ï¼Œæ˜¾ç¤ºæç¤º
                    resultImage.classList.add('hidden');
                    resultImagePlaceholder.classList.remove('hidden');
                    resultImagePlaceholder.textContent = 'ç»“æœå›¾ç‰‡ä¸å¯ç”¨';
                }
                
                // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                downloadBtn.classList.remove('hidden');
                saveToDownloadsBtn.classList.remove('hidden');
            }

            // ä¸‹è½½å›¾ç‰‡å‡½æ•°
            function downloadImage(imageSrc, filename) {
                const link = document.createElement('a');
                link.href = imageSrc;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // æ¸…ç†æ‰€æœ‰å­˜å‚¨æŒ‰é’®äº‹ä»¶å·²ç§»é™¤

            // æ¸…ç†å­˜å‚¨ç©ºé—´å‡½æ•°
            function cleanupStorage() {
                try {
                    // æ£€æŸ¥å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
                    const testKey = 'storage_test';
                    const testValue = 'x'.repeat(1000); // 1KBæµ‹è¯•æ•°æ®
                    
                    try {
                        localStorage.setItem(testKey, testValue);
                        localStorage.removeItem(testKey);
                    } catch (error) {
                        console.warn('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå¼€å§‹æ¸…ç†å½“å‰åŠŸèƒ½å†å²è®°å½•:', error);
                        
                        // åªæ¸…ç†å½“å‰åŠŸèƒ½çš„å†å²è®°å½•
                        try {
                            localStorage.removeItem('imageSharpenHistory');
                            console.log('å·²æ¸…ç†å›¾åƒé”åŒ–å†å²è®°å½•');
                        } catch (cleanError) {
                            console.error('æ¸…ç†å†å²è®°å½•å¤±è´¥:', cleanError);
                        }
                    }
                } catch (error) {
                    console.error('æ¸…ç†å­˜å‚¨ç©ºé—´å¤±è´¥:', error);
                }
            }

            // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
            cleanupStorage();
            
            // ç¡®ä¿ç¿»è¯‘ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆåå†åŠ è½½å†å²è®°å½•
            setTimeout(() => {
                loadHistory();
            }, 100);
        });
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å­˜å‚¨ç©ºé—´å¹¶åŠ è½½å†å²è®°å½•
        // æ³¨æ„ï¼šè¿™äº›å‡½æ•°éœ€è¦åœ¨DOMContentLoadedäº‹ä»¶å†…éƒ¨è°ƒç”¨
        
        // ç”¨æˆ·çŠ¶æ€ç›‘å¬å‡½æ•°
        function setupUserStateListener() {
            let currentUserId = null;
            let currentAuthToken = null;
            
            // è·å–å½“å‰ç”¨æˆ·ID
            function getCurrentUserId() {
                try {
                    const userInfo = localStorage.getItem('user');
                    if (userInfo) {
                        const user = JSON.parse(userInfo);
                        return user.id || user.phone || 'unknown';
                    }
                } catch (e) {
                    console.warn('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
                }
                return null;
            }
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åˆ‡æ¢
            function checkUserSwitch() {
                const newUserId = getCurrentUserId();
                const newAuthToken = localStorage.getItem('authToken');
                
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼Œè®°å½•å½“å‰çŠ¶æ€
                if (currentUserId === null) {
                    currentUserId = newUserId;
                    currentAuthToken = newAuthToken;
                    console.log('å›¾ç‰‡é”åŒ–é¡µé¢ï¼šåˆå§‹åŒ–ç”¨æˆ·çŠ¶æ€ç›‘å¬ï¼Œå½“å‰ç”¨æˆ·:', currentUserId);
                    return;
                }
                
                // æ£€æŸ¥ç”¨æˆ·IDæˆ–è®¤è¯ä»¤ç‰Œæ˜¯å¦å‘ç”Ÿå˜åŒ–
                if (newUserId !== currentUserId || newAuthToken !== currentAuthToken) {
                    console.log('å›¾ç‰‡é”åŒ–é¡µé¢ï¼šæ£€æµ‹åˆ°ç”¨æˆ·åˆ‡æ¢ï¼Œæ¸…é™¤å†å²è®°å½•');
                    console.log('åŸç”¨æˆ·:', currentUserId, 'æ–°ç”¨æˆ·:', newUserId);
                    
                    // æ¸…é™¤æ‰€æœ‰åŠŸèƒ½çš„å†å²è®°å½•
                    const historyKeys = [
                        'imageSharpenHistory',
                        'imageExpansionHistory', 
                        'textToImageHistory',
                        'imageToVideoHistory',
                        'videoStyleRepaintHistory',
                        'videoSubtitleRemoverHistory',
                        'multiImageToVideoHistory',
                        'promptEditorHistory',
                        'imageUpscalerHistory'
                    ];
                    
                    historyKeys.forEach(key => {
                        try {
                            localStorage.removeItem(key);
                            console.log(`å·²æ¸…é™¤å†å²è®°å½•: ${key}`);
                        } catch (e) {
                            console.warn(`æ¸…é™¤å†å²è®°å½•å¤±è´¥: ${key}`, e);
                        }
                    });
                    
                    // æ›´æ–°å½“å‰çŠ¶æ€
                    currentUserId = newUserId;
                    currentAuthToken = newAuthToken;
                    
                    // é‡æ–°åŠ è½½å†å²è®°å½•ï¼ˆæ­¤æ—¶ä¼šä»æœåŠ¡å™¨è·å–æ–°ç”¨æˆ·çš„æ•°æ®ï¼‰
                    setTimeout(() => {
                        loadHistory();
                    }, 100);
                }
            }
            
            // å®šæœŸæ£€æŸ¥ç”¨æˆ·çŠ¶æ€ï¼ˆæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
            setInterval(checkUserSwitch, 2000);
            
            // ç›‘å¬localStorageå˜åŒ–
            window.addEventListener('storage', function(e) {
                if (e.key === 'authToken' || e.key === 'user') {
                    console.log('å›¾ç‰‡é”åŒ–é¡µé¢ï¼šæ£€æµ‹åˆ°è®¤è¯ä¿¡æ¯å˜åŒ–ï¼Œæ£€æŸ¥ç”¨æˆ·åˆ‡æ¢');
                    setTimeout(checkUserSwitch, 100);
                }
            });
            
            // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå½“é¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹æ—¶æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    console.log('å›¾ç‰‡é”åŒ–é¡µé¢ï¼šé¡µé¢é‡æ–°è·å¾—ç„¦ç‚¹ï¼Œæ£€æŸ¥ç”¨æˆ·çŠ¶æ€');
                    setTimeout(checkUserSwitch, 100);
                }
            });
        }

        // åŠ è½½å¯¼èˆªæ ç»„ä»¶
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/components/navbar-simple.html');
                const navbarHtml = await response.text();
                document.getElementById('navbar-simple').innerHTML = navbarHtml;
                
                // åŠ è½½ç»„ä»¶è„šæœ¬
                const script = document.createElement('script');
                script.src = '/components/components.js';
                document.head.appendChild(script);
            } catch (error) {
                console.error('Failed to load navbar component:', error);
            }
        });
      </script>

      <!-- è¯­è¨€åˆ‡æ¢æ”¯æŒ -->
      <script>
          // è¯­è¨€æ£€æµ‹å’Œåˆ‡æ¢åŠŸèƒ½
          function initializeLanguageSupport() {
              // ä»URLå‚æ•°æˆ–localStorageè·å–è¯­è¨€è®¾ç½®
              function getLanguageFromParams() {
                  try {
                      // 1. é¦–å…ˆä»URLå‚æ•°è·å–
                      const urlParams = new URLSearchParams(window.location.search);
                      let langParam = urlParams.get('lang');
                      
                      if (langParam) {
                          console.log('ä»URLå‚æ•°è·å–è¯­è¨€:', langParam);
                          // è½¬æ¢è¯­è¨€æ ¼å¼ï¼šzh/en -> zh/en
                          if (langParam === 'zh-cn') {
                              langParam = 'zh';
                          } else if (langParam === 'en-us') {
                              langParam = 'en';
                          }
                          currentLanguage = langParam;
                          // ä¿å­˜åˆ°localStorage
                          localStorage.setItem('language', langParam);
                          return langParam;
                      }
                      
                      // 2. ä»localStorageè·å–
                      const savedLang = localStorage.getItem('language');
                      if (savedLang) {
                          console.log('ä»localStorageè·å–è¯­è¨€:', savedLang);
                          currentLanguage = savedLang;
                          return savedLang;
                      }
                      
                      // 3. ä½¿ç”¨é»˜è®¤è¯­è¨€
                      console.log('ä½¿ç”¨é»˜è®¤è¯­è¨€:', currentLanguage);
                      return currentLanguage;
                  } catch (error) {
                      console.error('è·å–è¯­è¨€å‚æ•°å¤±è´¥:', error);
                      return 'zh';
                  }
              }

              // æ›´æ–°é¡µé¢è¯­è¨€
              function updatePageLanguage() {
                  const currentLang = localStorage.getItem('language') || 'zh';
                  
                  // æ›´æ–°é¡µé¢æ ‡é¢˜
                  document.title = translate('image_sharpen.page_title');
                  
                  // æ›´æ–°HTMLè¯­è¨€å±æ€§
                  document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : 'en';
                  
                  // æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-translate å±æ€§çš„å…ƒç´ 
                  document.querySelectorAll('[data-translate]').forEach(element => {
                      const key = element.getAttribute('data-translate');
                      const translation = translate(key);
                      
                      if (element.tagName === 'TITLE') {
                          element.textContent = translation;
                      } else if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                          element.placeholder = translation;
                      } else {
                          element.textContent = translation;
                      }
                  });
                  
                  // æ›´æ–°å¸¦æœ‰ data-translate-placeholder å±æ€§çš„å…ƒç´ çš„ placeholder
                  document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                      const key = element.getAttribute('data-translate-placeholder');
                      const translation = translate(key);
                      element.placeholder = translation;
                  });
                  
                  // æ›´æ–°å¸¦æœ‰ data-translate-title å±æ€§çš„å…ƒç´ çš„ title
                  document.querySelectorAll('[data-translate-title]').forEach(element => {
                      const key = element.getAttribute('data-translate-title');
                      const translation = translate(key);
                      element.title = translation;
                  });
                  
                  console.log('é¡µé¢è¯­è¨€å·²æ›´æ–°ä¸º:', currentLang === 'zh' ? 'ä¸­æ–‡' : 'English');
              }

              // ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶
              window.addEventListener('languageChanged', function(event) {
                  console.log('æ”¶åˆ°è¯­è¨€å˜åŒ–äº‹ä»¶:', event.detail.language);
                  currentLanguage = event.detail.language;
                  localStorage.setItem('language', event.detail.language);
                  updatePageLanguage();
              });

              // ç›‘å¬æ¥è‡ªçˆ¶é¡µé¢çš„è¯­è¨€åˆ‡æ¢æ¶ˆæ¯
              window.addEventListener('message', function(event) {
                  if (event.data && event.data.type === 'languageChange') {
                      console.log('æ”¶åˆ°è¯­è¨€åˆ‡æ¢æ¶ˆæ¯:', event.data.language);
                      localStorage.setItem('language', event.data.language);
                      currentLanguage = event.data.language;
                      updatePageLanguage();
                  }
              });

              // åˆå§‹åŒ–è¯­è¨€
              getLanguageFromParams();
              updatePageLanguage();
          }

          // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–è¯­è¨€æ”¯æŒ
          document.addEventListener('DOMContentLoaded', function() {
              // ç­‰å¾…translations.jsåŠ è½½å®Œæˆ
              if (typeof translate === 'function') {
                  initializeLanguageSupport();
              } else {
                  // å¦‚æœtranslations.jsè¿˜æ²¡åŠ è½½å®Œæˆï¼Œç­‰å¾…ä¸€ä¸‹
                  setTimeout(() => {
                      if (typeof translate === 'function') {
                          initializeLanguageSupport();
                      }
                  }, 100);
              }
          });
      </script>
  </body>
</html> 