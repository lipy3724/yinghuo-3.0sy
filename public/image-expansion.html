<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="page.image_expansion_title">智能扩图 - 萤火AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="/components/styles.css" rel="stylesheet">
    <link href="/css/image-expansion.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/auth-helper.js"></script>
    <script src="/js/image-expansion-history.js" defer></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            pointer-events: auto;
            z-index: 1;
        }
        .upload-area:hover {
            border-color: #6366f1;
            background-color: #f8faff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
        }
        .upload-area:active {
            transform: translateY(0);
        }
        .result-section {
            border-left: 1px solid #e5e7eb;
        }
        /* 使用Tailwind自带的animate-spin替代自定义spinner */
        .prompt-input {
            resize: none;
            min-height: 120px;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.75rem;
            width: 100%;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .prompt-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px #4f46e5;
        }
        .instructions {
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        .preview-area {
            background-color: #f9fafb;
            border-radius: 0.5rem;
            min-height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* 滑块样式自定义 */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: linear-gradient(to right, #4f46e5, #818cf8);
            border-radius: 10px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #ffffff;
            border: 2px solid #4f46e5;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #ffffff;
            border: 2px solid #4f46e5;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        /* 图片拖动禁用 */
        img {
            -webkit-user-drag: none;
            user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        .expansion-direction {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        .direction-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .direction-btn:hover {
            background-color: #f3f4f6;
        }
        .direction-btn.active {
            background-color: #6366f1;
            color: white;
            border-color: #6366f1;
        }
        
        /* 确保左右区域滚动独立 */
        .left-panel {
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
            height: 100%;
            flex-shrink: 0;
        }
        
        .right-panel {
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
            height: 100%;
            flex-shrink: 0;
        }
        
        /* 防止滚动传播 */
        .left-panel::-webkit-scrollbar {
            width: 6px;
        }
        
        .left-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .left-panel::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .left-panel::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* 右侧面板滚动条样式 */
        .right-panel::-webkit-scrollbar {
            width: 6px;
        }
        
        .right-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .right-panel::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .right-panel::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* 确保图片容器不会导致布局问题 */
        #original-image-container,
        #result-image-container {
            min-height: 200px;
            max-height: 400px;
        }
        
        /* 禁用状态的按钮样式 */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
        }
        
        /* 必填标识样式 */
        .required {
            color: #ef4444;
        }

        /* 历史记录卡片样式 */
        .history-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .history-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }
        
        .history-card .view-btn {
            cursor: pointer;
            transition: all 0.2s ease;
            transform: scale(0.9);
        }
        
        .history-card .view-btn:hover {
            transform: scale(1);
        }
        
        .history-card .download-history-btn {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .history-card .download-history-btn:hover {
            color: #4f46e5 !important;
            transform: scale(1.1);
        }
        
        #history-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        /* 历史记录刷新按钮动画 */
        #refresh-history-btn {
            transition: transform 0.3s ease;
        }
        
        #refresh-history-btn:hover {
            transform: rotate(90deg);
        }
        
        #refresh-history-btn:active {
            transform: rotate(180deg);
        }

    </style>

    <link rel="icon" href="/images/favicon.png" type="image/png">    <script src="/js/auth-check.js"></script>
    <script src="/js/mobile-guard.js"></script>
</head>
<body class="min-h-screen bg-gray-100">
    <!-- 简化版导航栏 -->
    <div id="navbar-simple"></div>

    <!-- 主内容区域 -->
    <div class="container mx-auto py-8 px-4" style="margin-top: 60px;">
        <h1 class="text-3xl font-bold text-center mb-8" data-translate="image_expansion.title">智能扩图</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- 左侧：上传图片和提示词 -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4" data-translate="image_expansion.settings">扩图设置</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="image_expansion.upload_image">上传图片</label>
                    <div id="upload-area" class="upload-area h-36 flex flex-col items-center justify-center mb-2 bg-gray-50 relative">
                        <input type="file" id="image-upload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="image/*">
                        <div class="upload-content">
                            <i class="ri-upload-cloud-line text-2xl text-gray-400 mb-1"></i>
                            <p class="text-gray-500 text-center text-sm px-2" data-translate="image_expansion.upload_click_or_drag">点击或者拖动文件到这区域来上传</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mb-4" data-translate="image_expansion.image_size_info">图片大小最小为512×512像素，最大不超过2048×2048像素。</p>
                </div>
                    
                <div class="mb-6">
                    <label for="prompt" class="block text-sm font-medium text-gray-700 mb-1" data-translate="image_expansion.prompt_label">提示词</label>
                        <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700" data-translate="image_expansion.prompt_input_label">输入提示词</span>
                        </div>
                    <textarea id="prompt" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" data-translate-placeholder="image_expansion.prompt_placeholder"></textarea>
                    <p class="mt-1 text-xs text-gray-500" data-translate="image_expansion.prompt_tip">详细、具体的描述可以获得更好的效果</p>
                    </div>
                    
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="image_expansion.expansion_ratio">扩展方向与比例控制</label>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="flex justify-between text-sm text-gray-600">
                                <span data-translate="image_expansion.left_expand">向左扩展</span>
                                <span id="left-value">1</span>
                            </label>
                            <input type="range" id="left-expand" min="1" max="2" value="1" step="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    
                        <div>
                            <label class="flex justify-between text-sm text-gray-600">
                                <span data-translate="image_expansion.right_expand">向右扩展</span>
                                <span id="right-value">1</span>
                            </label>
                            <input type="range" id="right-expand" min="1" max="2" value="1" step="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    
                        <div>
                            <label class="flex justify-between text-sm text-gray-600">
                                <span data-translate="image_expansion.up_expand">向上扩展</span>
                                <span id="up-value">1</span>
                            </label>
                            <input type="range" id="up-expand" min="1" max="2" value="1" step="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                        <div>
                            <label class="flex justify-between text-sm text-gray-600">
                                <span data-translate="image_expansion.down_expand">向下扩展</span>
                                <span id="down-value">1</span>
                        </label>
                            <input type="range" id="down-expand" min="1" max="2" value="1" step="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
                
                    <p class="mt-2 text-xs text-gray-500" data-translate="image_expansion.slider_tip">拖动滑块调整各个方向的扩展比例（1-2倍，步长0.5）</p>
                </div>
                
                <div class="pt-4">
                <button id="generate-btn" class="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 flex items-center justify-center">
                        <i class="ri-image-add-line mr-2"></i>
                        <span data-translate="image_expansion.generate_button">生成扩图</span>
                </button>
                    <p class="mt-2 text-center text-sm text-gray-500">
                        <span data-translate="image_expansion.generation_info">图像生成需要5-15秒，消耗7积分</span>
                    </p>
                    <p class="mt-2 text-center text-sm text-red-500 font-medium">
                        <span data-translate="image_expansion.compliance_warning">请上传合法合规的图片，如有违反会进行封号处理，任务一旦提交就会扣除积分不可中断，请勿重复刷新提交，否则会造成积分浪费。</span>
                    </p>
                </div>
            </div>
            
            <!-- 右侧：效果展示 -->
            <div id="effect-showcase" class="lg:col-span-3 space-y-8">
                <!-- 效果展示部分 -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4 text-center" data-translate="image_expansion.effect_showcase">效果展示</h2>
                
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 原始图像 -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-3" data-translate="image_expansion.original_image">原始图像</h3>
                            <div id="original-image-container" class="bg-gray-100 rounded-md flex items-center justify-center overflow-hidden" style="min-height: 200px;">
                                <img id="original-image" class="hidden max-w-full max-h-full object-contain" alt="Original Image">
                            <p id="original-image-placeholder" class="text-gray-500 text-center px-4" data-translate="image_expansion.upload_placeholder">上传图片后将在这里显示</p>
                        </div>
                    </div>
                    
                        <!-- 生成结果 -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-3" data-translate="image_expansion.generated_result">生成结果</h3>
                            <div id="result-image-container" class="bg-gray-100 rounded-md flex items-center justify-center overflow-hidden" style="min-height: 200px;">
                                <img id="result-image" class="hidden max-w-full max-h-full object-contain" alt="Generated Result">
                            <p id="result-image-placeholder" class="text-gray-500 text-center px-4" data-translate="image_expansion.result_placeholder">生成结果将在这里显示</p>
                        </div>
                    </div>
                </div>

                    <div id="image-actions" class="mt-4 hidden">
                        <div class="flex space-x-2 justify-end">
                            <button id="download-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md text-sm flex items-center">
                                <i class="ri-download-line mr-1"></i> <span data-translate="image_expansion.download_image">下载图片</span>
                    </button>
                            <button id="save-to-downloads-btn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md text-sm flex items-center">
                                <i class="ri-save-line mr-1"></i> <span data-translate="image_expansion.save_to_download_center">保存到下载中心</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 生成历史部分 -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold" data-translate="image_expansion.generation_history">生成历史</h2>
                        <div class="flex space-x-2">
                            <button id="clear-history-btn" class="text-gray-500 hover:text-red-600" data-title-translate="image_expansion.clear_history">
                                <i class="ri-delete-bin-line text-xl"></i>
                            </button>
                            <button id="refresh-history-btn" class="text-indigo-600 hover:text-indigo-800" data-title-translate="image_expansion.refresh_history">
                            <i class="ri-refresh-line text-xl"></i>
                        </button>
                        </div>
                    </div>
                    
                    <div id="history-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <!-- 历史记录将通过JavaScript动态添加到这里 -->
                        <p class="text-gray-500 col-span-full text-center py-4" data-translate="image_expansion.no_history"></p>
                    </div>
                    
                    <!-- 保存时间提示 -->
                    <div class="mt-4 text-center">
                        <p class="text-xs text-gray-500">
                            <i class="ri-time-line mr-1"></i>
                            <span data-translate="image_expansion.save_duration">图片仅保存24小时</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 加载中遮罩 -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500 mb-4"></div>
                <p id="loading-message" class="text-lg font-medium" data-translate="image_expansion.processing">处理中，请耐心等待...</p>
                <p class="text-sm text-gray-500 mt-2" data-translate="image_expansion.processing_time">处理时间约为5-15秒</p>
                <div id="progress-container" class="w-full mt-4 hidden">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="progress-text" class="text-xs text-gray-500 mt-1 text-center">0%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 引用外部Javascript文件 -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // 加载导航栏组件
            try {
                const navbarResponse = await fetch('/components/navbar-simple.html');
                const navbarHtml = await navbarResponse.text();
                document.getElementById('navbar-simple').innerHTML = navbarHtml;
                
                // 加载组件JavaScript
                const componentsScript = document.createElement('script');
                componentsScript.src = '/components/components.js';
                document.head.appendChild(componentsScript);
            } catch (error) {
                console.error('加载导航栏组件失败:', error);
            }
            
            // 检查登录状态函数
            async function checkLoginStatus() {
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    console.log('用户未登录');
                    return false;
                }
                return true;
            }
            
            // 检查用户登录状态
            const isLoggedIn = await checkLoginStatus();
            
            // DOM元素
            const uploadArea = document.getElementById('upload-area');
            const imageUpload = document.getElementById('image-upload');
            const originalImage = document.getElementById('original-image');
            const originalImageContainer = document.getElementById('original-image-container');
            const originalImagePlaceholder = document.getElementById('original-image-placeholder');
            const resultImage = document.getElementById('result-image');
            const resultImagePlaceholder = document.getElementById('result-image-placeholder');
            const generateBtn = document.getElementById('generate-btn');
            const promptInput = document.getElementById('prompt'); // Changed from prompt-input to prompt
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            const downloadBtn = document.getElementById('download-btn');
            const saveToDownloadsBtn = document.getElementById('save-to-downloads-btn');
            const leftScale = document.getElementById('left-expand'); // Changed from left-scale to left-expand
            const rightScale = document.getElementById('right-expand'); // Changed from right-scale to right-expand
            const topScale = document.getElementById('up-expand'); // Changed from top-scale to up-expand
            const bottomScale = document.getElementById('down-expand'); // Changed from bottom-scale to down-expand
            const leftScaleValue = document.getElementById('left-value'); // Changed from left-scale-value to left-value
            const rightScaleValue = document.getElementById('right-value'); // Changed from right-scale-value to right-value
            const topScaleValue = document.getElementById('up-value'); // Changed from top-scale-value to up-value
            const bottomScaleValue = document.getElementById('down-value'); // Changed from bottom-scale-value to down-value
            const resetScales = document.getElementById('reset-scales'); // This element is removed, so no need to update
            const equalScales = document.getElementById('equal-scales'); // This element is removed, so no need to update
            
            // 初始化滑块值显示
            updateScaleValueDisplay();
            
            // 初始化按钮状态
            updateGenerateButtonState();
            
            // 添加滑块值变化事件
            leftScale.addEventListener('input', updateScaleValueDisplay);
            rightScale.addEventListener('input', updateScaleValueDisplay);
            topScale.addEventListener('input', updateScaleValueDisplay);
            bottomScale.addEventListener('input', updateScaleValueDisplay);
            
            // 添加提示词输入事件监听
            promptInput.addEventListener('input', updateGenerateButtonState);
            promptInput.addEventListener('blur', updateGenerateButtonState);
            
            // 重置按钮事件
            // resetScales.addEventListener('click', function() { // This element is removed, so no need to update
            //     leftScale.value = 1;
            //     rightScale.value = 1;
            //     topScale.value = 1;
            //     bottomScale.value = 1;
            //     updateScaleValueDisplay();
            // });
            
            // 四周均匀扩展按钮事件
            // equalScales.addEventListener('click', function() { // This element is removed, so no need to update
            //     const value = prompt('请输入四周均匀扩展比例 (0-2):', '1.5');
            //     if (value !== null) {
            //         const numValue = parseFloat(value);
            //         if (!isNaN(numValue) && numValue >= 0 && numValue <= 2) {
            //             leftScale.value = numValue;
            //             rightScale.value = numValue;
            //             topScale.value = numValue;
            //             bottomScale.value = numValue;
            //             updateScaleValueDisplay();
            //         } else {
            //             alert('请输入0到2之间的有效数值');
            //         }
            //     }
            // });
            
            // 更新滑块值显示
            function updateScaleValueDisplay() {
                leftScaleValue.textContent = leftScale.value;
                rightScaleValue.textContent = rightScale.value;
                topScaleValue.textContent = topScale.value;
                bottomScaleValue.textContent = bottomScale.value;
            }
            
            // 更新生成按钮状态
            function updateGenerateButtonState() {
                const prompt = promptInput.value.trim();
                const hasImage = originalImage.src && !originalImage.classList.contains('hidden');
                
                if (!prompt) {
                    generateBtn.disabled = true;
                    generateBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    generateBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    generateBtn.innerHTML = '<i class="ri-image-add-line mr-2"></i>' + getTranslation('image_expansion.enter_prompt_first');
                } else if (!hasImage) {
                    generateBtn.disabled = true;
                    generateBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    generateBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    generateBtn.innerHTML = '<i class="ri-image-add-line mr-2"></i>' + getTranslation('image_expansion.upload_first') + '';
                } else {
                    generateBtn.disabled = false;
                    generateBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    generateBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    generateBtn.innerHTML = '<i class="ri-image-add-line mr-2"></i>' + getTranslation('image_expansion.generate_button');
                }
            }
            
            // 图片上传处理
            console.log('设置上传事件监听器...');
            
            // 确保元素存在
            if (!uploadArea) {
                console.error('uploadArea 元素不存在');
                return;
            }
            if (!imageUpload) {
                console.error('imageUpload 元素不存在');
                return;
            }
            
            // 点击上传 - 移除阻止默认行为，让文件输入直接处理点击
            uploadArea.addEventListener('click', (e) => {
                console.log('点击上传区域');
                // 不阻止默认行为，让文件输入元素直接处理点击
            });
            
            // 文件选择变化
            imageUpload.addEventListener('change', (e) => {
                console.log('文件选择变化');
                const file = e.target.files[0];
                if (file) {
                    console.log('选择的文件:', file.name);
                    handleImageFile(file);
                }
            });
            
            // 拖放上传
            uploadArea.addEventListener('dragenter', (e) => {
                console.log('拖拽进入');
                e.preventDefault();
                e.stopPropagation();
                highlight();
            });
            
            uploadArea.addEventListener('dragover', (e) => {
                console.log('拖拽悬停');
                e.preventDefault();
                e.stopPropagation();
                highlight();
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                console.log('拖拽离开');
                e.preventDefault();
                e.stopPropagation();
                unhighlight();
            });
            
            uploadArea.addEventListener('drop', (e) => {
                console.log('文件拖拽释放');
                e.preventDefault();
                e.stopPropagation();
                unhighlight();
                
                const dt = e.dataTransfer;
                const file = dt.files[0];
                
                if (file && file.type.startsWith('image/')) {
                    console.log('拖拽上传文件:', file.name);
                    handleImageFile(file);
                } else {
                    console.log('拖拽文件不是图片格式');
                    alert('' + getTranslation('image_expansion.upload_image_file') + '');
                }
            });
            
                // 生成按钮点击
                generateBtn.addEventListener('click', async () => {
                    const prompt = promptInput.value.trim();
                    
                    if (!originalImage.src || originalImage.classList.contains('hidden')) {
                        alert('' + getTranslation('image_expansion.upload_first') + '！');
                        return;
                    }
                    
                    if (!prompt) {
                        alert(getTranslation('image_expansion.prompt_required'));
                        promptInput.focus();
                        return;
                    }
                    
                    // 禁用生成按钮，防止重复点击
                    generateBtn.disabled = true;
                    generateBtn.innerHTML = '<i class="ri-loader-2-line animate-spin mr-2"></i>' + getTranslation('image_expansion.processing');
                    
                    // 显示加载中
                    loadingOverlay.classList.remove('hidden');
                    loadingMessage.textContent = getTranslation('image_expansion.processing_image');
                    
                    // 在try外部声明taskId，避免catch中未定义
                    let taskId = null;
                    try {
                        // 1. 上传原图到服务器获取URL
                        loadingMessage.textContent = getTranslation('image_expansion.uploading_image');
                        console.log('正在上传图片...');
                        let imageUrl;
                        
                        try {
                            imageUrl = await uploadImageToServer(originalImage.src);
                        } catch (uploadError) {
                            console.error('图片上传错误:', uploadError);
                            throw new Error(`${getTranslation('image_expansion.upload_failed')}: ${uploadError.message}`);
                        }
                        
                        if (!imageUrl) {
                            throw new Error(getTranslation('image_expansion.upload_failed_no_url'));
                        }
                        
                        console.log('图片上传成功，获取到的URL:', imageUrl);
                        
                        // 2. 调用API创建智能扩图任务
                        loadingMessage.textContent = getTranslation('image_expansion.creating_task');
                        console.log('正在创建智能扩图任务...');
                        
                        try {
                            taskId = await createExpansionTask(prompt, imageUrl);
                        } catch (taskError) {
                            console.error('创建任务错误:', taskError);
                            throw new Error(`创建智能扩图任务失败: ${taskError.message}`);
                        }
                        
                        if (!taskId) {
                            throw new Error('创建智能扩图任务失败，未获取到任务ID');
                        }
                        
                        console.log('创建任务成功，任务ID:', taskId);
                        
                        // 3. 轮询任务状态
                        loadingMessage.textContent = getTranslation('image_expansion.start_processing');
                        
                        // 重置进度条
                        const progressContainer = document.getElementById('progress-container');
                        const progressBar = document.getElementById('progress-bar');
                        const progressText = document.getElementById('progress-text');
                        
                        if (progressContainer && progressBar && progressText) {
                            progressContainer.classList.remove('hidden');
                            progressBar.style.width = '0%';
                            progressText.textContent = '0% - 准备中';
                        }
                        
                        console.log('开始轮询任务状态...');
                        
                        let resultImageUrl;
                        try {
                            resultImageUrl = await pollTaskStatus(taskId);
                        } catch (pollError) {
                            console.error('轮询任务状态错误:', pollError);
                            
                            // 检查是否是认证错误
                            if (pollError.message && pollError.message.includes('登录已失效')) {
                                // 清除本地认证信息
                                try {
                                    if (isLocalStorageAvailable()) {
                                        localStorage.removeItem('authToken');
                                    }
                                } catch (e) {
                                    console.error('清除认证信息失败:', e);
                                }
                                
                                // 显示认证错误提示
                                alert(getTranslation('common.login_expired'));
                                window.location.href = '/login.html';
                                return;
                            }
                            
                            // 检查是否是超时错误
                            if (pollError.message && pollError.message.includes('超时')) {
                                // 显示更友好的超时提示
                                // 不抛出错误，而是返回null表示需要继续等待
                                console.log('检测到超时，但任务可能仍在处理中，继续等待');
                                return null;
                            }
                            
                            // 检查是否是参数错误
                            if (pollError.message && pollError.message.includes('请求参数错误')) {
                                throw new Error('任务参数错误，系统已自动退还您的积分。');
                            }
                            
                            // 其他错误
                            throw new Error(`获取任务结果失败: ${pollError.message}`);
                        }
                        
                        // 如果没有获取到结果URL，可能是因为任务仍在处理中
                        if (!resultImageUrl) {
                            console.log('未获取到有效URL，但不抛出错误，继续流程');
                        }
                        
                        console.log('获取任务结果成功，图像URL:', resultImageUrl);
                        
                        // 4. 显示结果图像
                        if (resultImageUrl) {
                            loadingMessage.textContent = getTranslation('image_expansion.loading_result');
                            
                            resultImage.onload = () => {
                                loadingOverlay.classList.add('hidden');
                            };
                            
                            resultImage.onerror = () => {
                                loadingOverlay.classList.add('hidden');
                                alert(getTranslation('image_expansion.load_result_failed'));
                            };
                            
                            resultImage.src = resultImageUrl;
                            resultImage.classList.remove('hidden');
                            resultImagePlaceholder.classList.add('hidden');
                        } else {
                            // 如果没有获取到结果URL，隐藏加载中状态
                            loadingOverlay.classList.add('hidden');
                            return; // 直接返回，不继续处理
                        }
                        
                        // 显示操作按钮
                        const imageActions = document.getElementById('image-actions');
                        if (imageActions) {
                            imageActions.classList.remove('hidden');
                        }

                        // 添加到历史记录
                        try {
                            // 获取消耗的积分数
                            const creditUsed = 7; // 固定使用7积分
                            await addToHistory(originalImage.src, resultImageUrl, prompt, creditUsed);
                            console.log('历史记录添加成功');
                        } catch (historyError) {
                            console.error('添加到历史记录失败:', historyError);
                            // 历史记录失败不影响主流程
                        }
                    } catch (error) {
                        console.error('处理失败:', error);
                        
                        // 尝试退还积分
                        if (taskId) {
                            try {
                                const refundResult = await requestRefund(taskId, `生成失败: ${error.message}`);
                                if (refundResult && refundResult.success) {
                                    console.log('积分退还成功');
                                } else {
                                    console.warn('积分退还可能失败:', refundResult);
                                }
                            } catch (refundError) {
                                console.error('积分退还请求失败:', refundError);
                            }
                        }
                        
                        // 显示更友好的错误提示
                        let errorMessage = error.message;
                        if (errorMessage.includes('任务处理超时') || errorMessage.includes('系统已自动退还')) {
                            alert(getTranslation('image_expansion.timeout_refund'));
                        } else if (errorMessage.includes('网络连接不稳定')) {
                            alert(getTranslation('image_expansion.network_error_refund'));
                        } else {
                            alert(getTranslation('image_expansion.process_failed_refund').replace('{error}', errorMessage));
                        }
                        
                        // 隐藏加载中状态
                        loadingOverlay.classList.add('hidden');
                    }
                    
                    // 恢复生成按钮状态
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="ri-image-add-line mr-2"></i>' + getTranslation('image_expansion.generate_button');
                });
            
            // 上传图片到服务器
            async function uploadImageToServer(imageData) {
                try {
                    // 转换为Blob对象
                    let blob;
                    if (imageData.startsWith('data:')) {
                        // 从base64字符串创建Blob对象
                        const base64Data = imageData.split(',');
                        // 确保我们有有效的Base64数据部分
                        if (base64Data.length > 1) {
                            blob = base64ToBlob(base64Data[1], 'image/jpeg');
                        } else {
                            // 如果没有逗号分隔，可能是纯Base64数据
                            blob = base64ToBlob(imageData, 'image/jpeg');
                        }
                    } else {
                        // 处理URL情况 - 先获取图像再转换
                        const response = await fetch(imageData);
                        blob = await response.blob();
                    }
                    
                    // 创建FormData对象
                    const formData = new FormData();
                    formData.append('image', blob, 'image.jpg');
                    
                    // 安全获取authToken
                    let authToken = '';
                    try {
                        if (isLocalStorageAvailable()) {
                            authToken = localStorage.getItem('authToken') || '';
                        }
                    } catch (e) {
                        console.error('获取authToken失败:', e);
                    }
                    
                    // 发送请求上传图片
                    console.log('准备上传图片...');
                    const response = await fetch('/api/upload-image', {
                        method: 'POST',
                        headers: {
                            'Authorization': authToken ? `Bearer ${authToken}` : ''
                        },
                        body: formData
                    });
                    
                    // 先检查HTTP状态码，再解析JSON
                    if (!response.ok) {
                        // 未授权处理
                        if (response.status === 401 || response.status === 403) {
                            try { localStorage.removeItem('authToken'); } catch (e) {}
                            alert('登录已失效，请重新登录后再试');
                            window.location.href = '/login.html';
                            return;
                        }
                        
                        // 尝试解析错误响应
                        let errorMessage = getTranslation('image_expansion.upload_failed');
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorData.error || getTranslation('image_expansion.upload_failed');
                            
                            // OSS配置错误的友好提示
                            if (response.status === 500 && /OSS\s+Access\s+Key\s+Id/i.test(errorMessage)) {
                                errorMessage = getTranslation('image_expansion.oss_config_error');
                            }
                        } catch (e) {
                            // 如果无法解析JSON，使用默认错误消息
                        }
                        
                        throw new Error(errorMessage);
                    }
                    
                    // 解析成功响应
                    const data = await response.json();
                    const imageUrl = data.output?.img_url || data.imageUrl || data.url;
                    
                    if (!imageUrl) {
                        throw new Error('服务器返回的图片URL无效');
                    }
                    
                    console.log('上传图片成功，获取到的URL:', imageUrl);
                    return imageUrl;
                } catch (error) {
                    console.error('图片上传错误:', error);
                    throw new Error(getTranslation('image_expansion.upload_failed') + ': ' + error.message);
                }
            }
            
            // Base64转Blob
            function base64ToBlob(base64Data, mimeType = 'image/jpeg') {
                const byteCharacters = atob(base64Data);
                const byteArrays = [];
                
                for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                    const slice = byteCharacters.slice(offset, offset + 512);
                    
                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) {
                        byteNumbers[i] = slice.charCodeAt(i);
                    }
                    
                    const byteArray = new Uint8Array(byteNumbers);
                    byteArrays.push(byteArray);
                }
                
                return new Blob(byteArrays, { type: mimeType });
            }
            
            // 创建智能扩图任务
            async function createExpansionTask(prompt, imageUrl) {
                try {
                    // 获取各个方向的扩展比例
                    const leftScaleValue = parseFloat(leftScale.value);
                    const rightScaleValue = parseFloat(rightScale.value);
                    const topScaleValue = parseFloat(topScale.value);
                    const bottomScaleValue = parseFloat(bottomScale.value);
                    
                    // 验证参数范围，确保不超过API限制
                    const maxScale = 2;
                    if (leftScaleValue > maxScale || rightScaleValue > maxScale || topScaleValue > maxScale || bottomScaleValue > maxScale) {
                        throw new Error(`扩展比例不能超过${maxScale}倍，当前设置：左${leftScaleValue}，右${rightScaleValue}，上${topScaleValue}，下${bottomScaleValue}`);
                    }
                    
                    // 准备请求数据 - 使用expand功能
                    const requestData = {
                        prompt: prompt || "延续图像内容",
                        imageUrl: imageUrl,
                        leftScale: leftScaleValue,
                        rightScale: rightScaleValue,
                        topScale: topScaleValue,
                        bottomScale: bottomScaleValue,
                        negativePrompt: "模糊, 扭曲, 变形, 低质量",
                        quality: "standard"
                    };
                    
                    console.log('发送创建智能扩图任务请求:', JSON.stringify(requestData));
                    
                    // 安全获取authToken
                    let authToken = '';
                    try {
                        if (isLocalStorageAvailable()) {
                            authToken = localStorage.getItem('authToken') || '';
                        }
                    } catch (e) {
                        console.error('获取authToken失败:', e);
                    }
                    
                    // 通过服务器代理调用API
                    const response = await fetch('/api/image-expansion/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': authToken ? `Bearer ${authToken}` : ''
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    const data = await response.json();
                    
                    console.log('创建任务响应:', data);
                    
                    if (!response.ok) {
                        if (data.message && data.message.includes('积分不足')) {
                            throw new Error('您的积分不足，请充值后再试');
                        } else {
                            throw new Error(data.message || '创建任务失败');
                        }
                    }
                    
                    // 从响应中获取任务ID，支持不同的数据结构格式
                    const taskId = data.taskId || data.output?.task_id;
                    if (!taskId) {
                        throw new Error('服务器未返回任务ID，请稍后重试');
                    }
                    return taskId;
                } catch (error) {
                    console.error('创建任务错误:', error);
                    throw new Error('创建任务失败: ' + error.message);
                }
            }
            
            // 轮询任务状态
            async function pollTaskStatus(taskId) {
                const maxAttempts = 60; // 增加轮询次数到60次，相当于120秒
                const interval = 2000; // 每2秒轮询一次
                
                for (let attempt = 0; attempt < maxAttempts; attempt++) {
                    try {
                        const data = await queryTaskStatus(taskId);
                            
                        // 详细记录API响应结构，便于调试
                        console.log('API响应详情 - request_id:', data.request_id);
                        console.log('API响应详情 - output:', data.output);
                        if (data.output) {
                            console.log('API响应详情 - task_status:', data.output.task_status);
                            console.log('API响应详情 - task_id:', data.output.task_id);
                            if (data.output.results) {
                                console.log('API响应详情 - results:', JSON.stringify(data.output.results));
                            } else if (data.output.images) {
                                console.log('API响应详情 - images:', JSON.stringify(data.output.images));
                            }
                            if (data.output.task_metrics) {
                                console.log('API响应详情 - task_metrics:', JSON.stringify(data.output.task_metrics));
                            }
                        }
                        
                        // 如果存在顶层错误码和错误信息，说明API调用直接失败
                        if (data.code && data.message) {
                            throw new Error(`API错误: ${data.code}: ${data.message}`);
                        }
                        
                        // 检查任务状态
                        const taskStatus = data.output?.task_status;
                        
                        if (taskStatus === 'SUCCEEDED') {
                            // 成功完成，优先检查images字段(新版API)
                            if (data.output?.images && data.output.images.length > 0) {
                                const resultImageUrl = data.output.images[0].url;
                                if (!resultImageUrl || resultImageUrl.trim() === '') {
                                    // 请求退款 - 虽然状态是成功，但没有有效URL
                                    const refundResult = await requestRefund(taskId, '任务返回空结果，无有效图像URL');
                                    console.log('退款请求结果:', refundResult);
                                    
                                    throw new Error('任务完成但返回空结果，系统已自动申请退款');
                                }
                                return resultImageUrl;
                            }
                            
                            // 然后检查results字段(旧版API)
                            const resultsList = data.output?.results || [];
                            if (resultsList.length > 0) {
                                // 检查是否有部分失败的情况
                                const successResults = resultsList.filter(result => result.url && result.url.trim() !== '');
                                const failedResults = resultsList.filter(result => result.code || !result.url || result.url.trim() === '');
                                
                                if (successResults.length > 0) {
                                    // 至少有一个成功的结果
                                    const resultImageUrl = successResults[0].url;
                                    
                                    // 如果有部分失败，在控制台记录
                                    if (failedResults.length > 0) {
                                        console.warn('部分任务失败:');
                                        failedResults.forEach(item => {
                                            console.warn(`- 错误码: ${item.code}, 信息: ${item.message}`);
                                        });
                                        
                                        // 显示部分成功信息
                                        const totalTasks = resultsList.length;
                                        const successTasks = successResults.length;
                                        console.log(`任务部分成功: ${successTasks}/${totalTasks} 成功`);
                                        
                                        // 记录task_metrics信息
                                        if (data.output.task_metrics) {
                                            const metrics = data.output.task_metrics;
                                            console.log(`任务统计: 总数=${metrics.TOTAL}, 成功=${metrics.SUCCEEDED}, 失败=${metrics.FAILED}`);
                                        }
                                    }
                                    
                                    return resultImageUrl;
                                } else {
                                    // 所有结果都失败
                                    const error = failedResults[0] || {};
                                    
                                    // 请求退款
                                    const refundResult = await requestRefund(taskId, `生成失败: ${error.code ? `${error.code}: ` : ''}${error.message || '图像处理失败'}`);
                                    console.log('退款请求结果:', refundResult);
                                    
                                    throw new Error(`生成失败: ${error.code ? `${error.code}: ` : ''}${error.message || '图像处理失败'}`);
                                }
                            } else {
                                // 请求退款 - 状态是成功但结果列表为空
                                const refundResult = await requestRefund(taskId, '任务成功但未找到结果图像');
                                console.log('退款请求结果:', refundResult);
                                
                                throw new Error('任务成功但未找到结果图像，系统已自动申请退款');
                            }
                        } 
                        else if (taskStatus === 'FAILED') {
                            // 任务失败，获取错误详情
                            
                            // 根据官方文档，FAILED状态下code和message字段直接在output对象下
                            let errorMsg = '未知错误';
                            let errorCode = '';
                            
                            if (data.output.code) {
                                // 标准格式：错误码在output.code
                                errorCode = data.output.code;
                                errorMsg = data.output.message || '未知错误';
                            } else if (data.output.error) {
                                // 兼容格式：错误在error对象内
                                errorCode = data.output.error.code || '';
                                errorMsg = data.output.error.message || '未知错误';
                            } else if (data.output.message) {
                                // 只有错误信息
                                errorMsg = data.output.message;
                            }
                            
                            // 请求退款
                            const refundResult = await requestRefund(taskId, `任务执行失败: ${errorCode ? `${errorCode}: ` : ''}${errorMsg}`);
                            console.log('退款请求结果:', refundResult);
                            
                            console.log(`任务失败，错误码: ${errorCode}, 错误信息: ${errorMsg}`);
                            throw new Error(`任务执行失败: ${errorCode ? `${errorCode}: ` : ''}${errorMsg}`);
                        }
                        else if (taskStatus === 'CANCELED') {
                            // 任务被取消
                            
                            // 请求退款
                            const refundResult = await requestRefund(taskId, '任务已被取消');
                            console.log('退款请求结果:', refundResult);
                            
                            throw new Error('任务已被取消，请重试');
                        }
                        else if (taskStatus === 'UNKNOWN') {
                            // 任务状态未知
                            
                            // 请求退款
                            const refundResult = await requestRefund(taskId, '任务状态未知');
                            console.log('退款请求结果:', refundResult);
                            
                            throw new Error('任务状态未知，请重试');
                        }
                        // 状态为PENDING或RUNNING，继续轮询
                        console.log(`任务状态: ${taskStatus || 'PENDING'}, 已轮询 ${attempt + 1}/${maxAttempts} 次，继续轮询...`);
                        
                        // 每5次轮询更新一次进度条
                        if (attempt > 0 && attempt % 5 === 0) {
                            const progressPercent = Math.floor((attempt / maxAttempts) * 100);
                            const progressContainer = document.getElementById('progress-container');
                            const progressBar = document.getElementById('progress-bar');
                            const progressText = document.getElementById('progress-text');
                            
                            if (progressContainer && progressBar && progressText) {
                                // 显示进度条
                                progressContainer.classList.remove('hidden');
                                // 更新进度条
                                progressBar.style.width = `${progressPercent}%`;
                                // 更新进度文本
                                progressText.textContent = `${progressPercent}% - 请耐心等待`;
                            }
                            
                            // 更新加载消息
                            const loadingMessage = document.getElementById('loading-message');
                            if (loadingMessage) {
                                if (progressPercent > 75) {
                                    loadingMessage.textContent = getTranslation('image_expansion.almost_done');
                                } else if (progressPercent > 50) {
                                    loadingMessage.textContent = getTranslation('image_expansion.generating_content');
                                } else if (progressPercent > 25) {
                                    loadingMessage.textContent = getTranslation('image_expansion.processing_edges');
                                } else {
                                    loadingMessage.textContent = getTranslation('image_expansion.analyzing_image');
                                }
                            }
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, interval));
                    } catch (error) {
                        console.error(`轮询第 ${attempt + 1} 次失败:`, error);
                        
                        // 检查是否是认证错误
                        if (error.message && error.message.includes('登录已失效')) {
                            // 认证失效，直接退出轮询
                            console.error('认证失效，停止轮询');
                            
                            // 请求退款
                            try {
                                const refundResult = await requestRefund(taskId, '用户认证失效');
                                console.log('退款请求结果:', refundResult);
                            } catch (refundError) {
                                console.error('退款请求失败:', refundError);
                            }
                            
                            throw new Error('登录已失效，请重新登录后重试');
                        }
                        
                        // 检查是否是400错误（任务不存在或参数错误）
                        if (error.message && error.message.includes('请求参数错误')) {
                            console.error('任务参数错误，停止轮询');
                            
                            // 请求退款
                            try {
                                const refundResult = await requestRefund(taskId, '任务参数错误');
                                console.log('退款请求结果:', refundResult);
                            } catch (refundError) {
                                console.error('退款请求失败:', refundError);
                            }
                            
                            throw new Error('任务参数错误，系统已自动退还积分');
                        }
                        
                        // 如果连续错误超过3次，则放弃
                        if (attempt >= 3) { // 允许最多4次错误
                            // 请求退款
                            try {
                                const refundResult = await requestRefund(taskId, '网络连接不稳定');
                                console.log('退款请求结果:', refundResult);
                            } catch (refundError) {
                                console.error('退款请求失败:', refundError);
                            }
                            
                            throw new Error('网络连接不稳定，请检查网络后重试');
                        }
                        
                        // 继续轮询
                        await new Promise(resolve => setTimeout(resolve, interval));
                    }
                }
                
                // 超过最大尝试次数，但不立即失败，尝试继续获取结果
                console.log(`轮询次数已达上限(${maxAttempts}次/120秒)，但任务可能仍在处理中，继续等待结果`);
                
                // 更新加载消息，提示用户任务处理中
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.textContent = getTranslation('image_expansion.task_processing');
                    loadingMessage.style.color = '#3b82f6'; // 蓝色提示更友好
                }
                
                // 更新进度条显示
                const progressContainer = document.getElementById('progress-container');
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                
                if (progressContainer && progressBar && progressText) {
                    progressBar.style.width = '100%';
                    progressBar.style.backgroundColor = '#3b82f6'; // 蓝色进度条表示处理中
                    progressText.textContent = '100% - 处理中，请等待';
                }
                
                // 继续尝试获取结果，而不是立即退款
                try {
                    console.log('继续尝试获取任务结果...');
                    
                    // 再多等待一段时间
                    const extraWaitTime = 60000; // 额外等待60秒
                    const checkInterval = 5000; // 每5秒检查一次
                    const maxExtraChecks = extraWaitTime / checkInterval;
                    
                    for (let extraCheck = 0; extraCheck < maxExtraChecks; extraCheck++) {
                        try {
                            // 更新提示信息
                            if (loadingMessage) {
                                loadingMessage.textContent = getTranslation('image_expansion.extra_waiting').replace('{current}', extraCheck + 1).replace('{total}', maxExtraChecks);
                            }
                            
                            // 等待间隔
                            await new Promise(resolve => setTimeout(resolve, checkInterval));
                            
                            // 尝试查询任务状态
                            const data = await queryTaskStatus(taskId);
                            
                            // 检查任务状态
                            const taskStatus = data.output?.task_status;
                            
                            if (taskStatus === 'SUCCEEDED') {
                                console.log('额外等待后任务成功完成!');
                                
                                // 处理成功结果
                                if (data.output?.images && data.output.images.length > 0) {
                                    return data.output.images[0].url;
                                } else if (data.output?.results && data.output.results.length > 0) {
                                    return data.output.results[0].url;
                                }
                            } else if (taskStatus === 'FAILED') {
                                console.log('额外等待后任务失败');
                                break; // 退出循环，进行退款流程
                            } else {
                                console.log(`额外等待中，当前状态: ${taskStatus || 'PENDING'} (${extraCheck + 1}/${maxExtraChecks})`);
                            }
                        } catch (checkError) {
                            console.warn(`额外等待检查出错 (${extraCheck + 1}/${maxExtraChecks}):`, checkError);
                            // 继续循环，不中断
                        }
                    }
                    
                    console.log('额外等待后仍未获得结果，准备退款');
                    
                    // 更新加载消息，提示用户任务处理超时
                    if (loadingMessage) {
                        loadingMessage.textContent = getTranslation('image_expansion.timeout_refunding');
                        loadingMessage.style.color = '#ef4444'; // 红色提示更醒目
                    }
                    
                    // 更新进度条显示
                    if (progressContainer && progressBar && progressText) {
                        progressBar.style.backgroundColor = '#f87171'; // 红色进度条表示超时
                        progressText.textContent = '100% - 处理超时';
                    }
                    
                    // 请求退款
                    console.log('使用公开端点请求退款...');
                    let refundResult = await requestRefund(taskId, '任务处理时间过长');
                    
                    if (refundResult && refundResult.success) {
                        console.log('已请求退款成功，原因：任务处理时间过长');
                    }
                    
                    // 等待一小段时间让用户看到退款提示
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // 不抛出错误，而是显示友好提示
                    alert(getTranslation('image_expansion.timeout_refund'));
                    
                    // 返回null表示没有结果
                    return null;
                    
                } catch (finalError) {
                    console.error('最终处理失败:', finalError);
                    
                    // 请求退款
                    try {
                        await requestRefund(taskId, '任务处理时间过长');
                    } catch (refundError) {
                        console.error('退款请求失败:', refundError);
                    }
                    
                    // 显示友好提示
                    alert(getTranslation('image_expansion.timeout_refund'));
                    
                    // 返回null表示没有结果
                    return null;
                }
            }
            
            // 请求退款
            async function requestRefund(taskId, reason) {
                try {
                    console.log('请求退款，任务ID:', taskId);
                    
                    // 安全获取authToken
                    let authToken = '';
                    try {
                        if (isLocalStorageAvailable()) {
                            authToken = localStorage.getItem('authToken') || '';
                        }
                    } catch (e) {
                        console.error('获取authToken失败:', e);
                    }
                    
                    // 统一使用公开退款API端点，无需认证
                    const endpoint = '/api/refund/image-expansion-fallback';
                    
                    console.log(`使用退款端点: ${endpoint}`);
                    
                    // 增加超时设置
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000); // 8秒超时
                    
                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': authToken ? `Bearer ${authToken}` : ''
                            },
                            body: JSON.stringify({
                                taskId: taskId,
                                reason: reason || '任务处理失败'
                            }),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        // 尝试解析响应
                        const data = await response.json();
                        
                        if (!response.ok) {
                            console.warn(`退款请求失败: ${data.message || '未知错误'}`);
                            
                            // 如果是401或403错误，尝试使用备用端点
                            if (response.status === 401 || response.status === 403) {
                                console.log('尝试使用备用退款端点...');
                                try {
                                    const backupResponse = await fetch('/api/refund/image-expansion', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            taskId: taskId,
                                            reason: reason || '任务处理失败'
                                        }),
                                        // 设置更短的超时时间
                                        signal: AbortSignal.timeout(5000)
                                    });
                                    
                                    if (backupResponse.ok) {
                                        const backupData = await backupResponse.json();
                                        console.log('备用退款请求成功:', backupData);
                                        return backupData;
                                    }
                                } catch (backupError) {
                                    console.warn('备用退款请求失败:', backupError);
                                }
                            }
                            
                            return { success: false, message: data.message || '请求退款失败' };
                        }
                        
                        return data;
                    } catch (fetchError) {
                        clearTimeout(timeoutId);
                        throw fetchError;
                    }
                    
                } catch (error) {
                    console.error('请求退款失败:', error);
                    
                    // 如果是超时错误，给出更明确的信息
                    if (error.name === 'AbortError') {
                        console.warn('退款请求超时，但会继续处理');
                        
                        // 尝试最后一次无认证退款请求
                        try {
                            console.log('尝试最终无认证退款请求...');
                            const finalResponse = await fetch('/api/refund/image-expansion-fallback', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    taskId: taskId,
                                    reason: '退款请求超时重试'
                                }),
                                // 设置更短的超时时间
                                signal: AbortSignal.timeout(3000)
                            });
                            
                            if (finalResponse.ok) {
                                const finalData = await finalResponse.json();
                                console.log('最终退款请求成功:', finalData);
                                return finalData;
                            }
                        } catch (finalError) {
                            console.warn('最终退款请求失败，但不影响用户体验:', finalError);
                        }
                        
                        return { success: true, message: '系统已记录退款请求，将尽快处理' };
                    }
                    
                    // 不再抛出错误，而是返回状态
                    return { success: true, message: '系统已记录您的退款请求' };
                }
            }
            
            // 下载按钮
            downloadBtn.addEventListener('click', () => {
                if (resultImage.src) {
                    const link = document.createElement('a');
                    link.href = resultImage.src;
                    link.download = 'expanded-image.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
            
            // 保存到下载中心按钮
            saveToDownloadsBtn.addEventListener('click', async () => {
                if (!resultImage.src) return;
                
                try {
                    // 显示加载中
                    loadingOverlay.classList.remove('hidden');
                    loadingMessage.textContent = getTranslation('image_expansion.saving_to_download_center');
                    
                    // 获取提示文本
                    const promptText = promptInput.value.trim() || '智能扩图';
                    
                    console.log('准备保存图片到下载中心:', resultImage.src.substring(0, 50) + '...');
                    
                    // 安全获取authToken
                    let authToken = '';
                    try {
                        if (isLocalStorageAvailable()) {
                            authToken = localStorage.getItem('authToken') || '';
                        }
                    } catch (e) {
                        console.error('获取authToken失败:', e);
                    }
                    
                    // 调用API保存图片到下载中心
                    const response = await fetch('/api/downloads/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': authToken ? `Bearer ${authToken}` : ''
                        },
                        body: JSON.stringify({
                            imageUrl: resultImage.src,
                            title: '智能扩图: ' + (promptText.substring(0, 30) + (promptText.length > 30 ? '...' : '')),
                            description: promptText,
                            type: 'IMAGE_EXPANSION'
                        })
                    });
                    
                    console.log('保存响应状态:', response.status);
                    
                    const data = await response.json();
                    console.log('保存响应数据:', data);
                    
                    if (!response.ok) {
                        throw new Error(data.message || data.error || '保存失败');
                    }
                    
                    // 隐藏加载中
                    loadingOverlay.classList.add('hidden');
                    
                    // 显示成功提示
                    alert(getTranslation('image_expansion.save_success'));
                } catch (error) {
                    console.error('保存到下载中心失败:', error);
                    loadingOverlay.classList.add('hidden');
                    alert(getTranslation('image_expansion.save_failed') + ': ' + error.message);
                }
            });
            
                    // 查询任务状态
                    async function queryTaskStatus(taskId) {
                        try {
                            console.log('查询任务状态:', taskId);
                            
                            // 安全获取authToken
                            let authToken = '';
                            try {
                                if (isLocalStorageAvailable()) {
                                    authToken = localStorage.getItem('authToken') || '';
                                }
                            } catch (e) {
                                console.error('获取authToken失败:', e);
                            }
                            
                            // 检查认证令牌
                            if (!authToken) {
                                throw new Error('未登录或登录已失效，请重新登录');
                            }
                            
                            // 添加重试机制
                            const maxRetries = 2; // 最多重试2次
                            let lastError = null;
                            
                            // 尝试所有可能的API路径
                            const apiPaths = [
                                `/api/image-edit/task-status/${taskId}`,
                                `/api/image-edit/status/${taskId}`,
                                `/api/image-expansion/status/${taskId}` // 添加可能的路径
                            ];
                            
                            for (const apiPath of apiPaths) {
                                for (let retry = 0; retry <= maxRetries; retry++) {
                                    try {
                                        console.log(`尝试路径 ${apiPath} (尝试 ${retry + 1}/${maxRetries + 1})`);
                                        
                                        const response = await fetch(apiPath, {
                                            headers: {
                                                'Authorization': `Bearer ${authToken}`,
                                                'Content-Type': 'application/json'
                                            },
                                            // 添加缓存控制，避免浏览器缓存
                                            cache: 'no-store',
                                            // 添加超时控制
                                            signal: AbortSignal.timeout(10000) // 10秒超时
                                        });
                                        
                                        // 检查响应状态
                                        if (!response.ok) {
                                            // 处理认证错误
                                            if (response.status === 401 || response.status === 403) {
                                                console.warn('认证失效，清除本地令牌');
                                                try {
                                                    if (isLocalStorageAvailable()) {
                                                        localStorage.removeItem('authToken');
                                                    }
                                                } catch (e) {
                                                    console.error('清除令牌失败:', e);
                                                }
                                                throw new Error('登录已失效，请重新登录');
                                            }
                                            
                                            // 处理400错误
                                            if (response.status === 400) {
                                                const errorData = await response.json().catch(() => ({}));
                                                console.warn(`${apiPath} 返回400错误:`, errorData);
                                                throw new Error(`请求参数错误: ${errorData.message || '任务ID无效或任务不存在'}`);
                                            }
                                            
                                            // 处理其他HTTP错误
                                            const errorData = await response.json().catch(() => ({}));
                                            console.warn(`${apiPath} 返回错误 ${response.status}:`, errorData);
                                            throw new Error(`服务器错误 ${response.status}: ${errorData.message || '未知错误'}`);
                                        }
                                        
                                        const data = await response.json();
                                        console.log(`${apiPath} 响应:`, data);
                                        
                                        console.log(`成功通过 ${apiPath} 获取任务状态`);
                                        return data;
                                        
                                    } catch (err) {
                                        console.warn(`${apiPath} 请求失败 (尝试 ${retry + 1}/${maxRetries + 1}):`, err);
                                        lastError = err;
                                        
                                        // 如果是认证错误，不再重试
                                        if (err.message && err.message.includes('登录已失效')) {
                                            throw err;
                                        }
                                        
                                        // 如果不是最后一次重试，等待后再试
                                        if (retry < maxRetries) {
                                            await new Promise(resolve => setTimeout(resolve, 1000));
                                        }
                                    }
                                }
                            }
                            
                            // 所有路径都尝试失败
                            console.error('所有API路径尝试均失败');
                            throw lastError || new Error('查询任务状态失败: 所有API路径均无响应');
                        } catch (error) {
                            console.error('查询任务状态失败:', error);
                            throw error;
                        }
                    }
            
            // 检查生成按钮状态
            function checkGenerateButtonState() {
                const hasPrompt = promptInput.value.trim() !== '';
                const hasImage = uploadedImage !== null;
                
                if (!hasPrompt) {
                    generateBtn.disabled = true;
                    generateBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    generateBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    generateBtn.innerHTML = '<i class="ri-image-add-line mr-2"></i>' + getTranslation('image_expansion.enter_prompt_first');
                } else if (!hasImage) {
                    generateBtn.disabled = true;
                    generateBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    generateBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    generateBtn.innerHTML = '<i class="ri-image-add-line mr-2"></i>' + getTranslation('image_expansion.upload_first') + '';
                } else {
                    generateBtn.disabled = false;
                    generateBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    generateBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    generateBtn.innerHTML = '<i class="ri-image-add-line mr-2"></i>' + getTranslation('image_expansion.generate_button');
                }
            }
            
            // 添加到历史记录
            async function addToHistory(originalImage, resultImage, prompt, creditUsed = 7) {
                try {
                    console.log('添加历史记录 - 开始');
                    
                    // 使用新的历史记录管理模块保存到OSS
                    await window.ImageExpansionHistory.save({
                        originalImage: originalImage,
                        resultImage: resultImage,
                        prompt: prompt,
                        creditUsed: creditUsed,
                        metadata: {
                            userAgent: navigator.userAgent,
                            screenSize: `${window.screen.width}x${window.screen.height}`
                        }
                    });
                    
                    console.log('历史记录已保存到OSS');
                    
                    // 刷新历史记录显示
                    await loadHistory();
                } catch (e) {
                    console.error('保存历史记录失败', e);
                }
            }
            
            // 压缩图片数据以适应localStorage限制
            function compressImageDataIfNeeded(imageData) {
                return new Promise((resolve) => {
                    try {
                        // 如果不是base64数据，直接返回
                        if (!imageData || !imageData.startsWith('data:image')) {
                            resolve(imageData);
                            return;
                        }
                        
                        // 如果数据大小已经小于500KB，不需要压缩
                        if (imageData.length < 500000) {
                            resolve(imageData);
                            return;
                        }
                        
                        console.log('压缩图片 - 原始大小:', imageData.length, '字节');
                        
                        // 创建一个临时的canvas和Image对象
                        const img = new Image();
                        
                        img.onload = () => {
                            // 创建一个canvas元素
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // 设置合适的尺寸，保持宽高比
                            let width = img.width;
                            let height = img.height;
                            
                            // 如果图片太大，按比例缩小
                            const MAX_SIZE = 800;
                            if (width > height && width > MAX_SIZE) {
                                height = Math.round((height * MAX_SIZE) / width);
                                width = MAX_SIZE;
                            } else if (height > MAX_SIZE) {
                                width = Math.round((width * MAX_SIZE) / height);
                                height = MAX_SIZE;
                            }
                            
                            // 设置canvas尺寸
                            canvas.width = width;
                            canvas.height = height;
                            
                            // 绘制图片到canvas
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // 将canvas转换为压缩后的base64数据
                            // 使用较低的质量值来减小文件大小
                            const compressedData = canvas.toDataURL('image/jpeg', 0.6);
                            
                            console.log('压缩图片 - 压缩后大小:', compressedData.length, '字节');
                            console.log('压缩图片 - 压缩率:', Math.round((compressedData.length / imageData.length) * 100) + '%');
                            
                            resolve(compressedData);
                        };
                        
                        img.onerror = () => {
                            console.error('压缩图片失败: 图片加载错误');
                            resolve(imageData); // 如果加载失败，返回原始数据
                        };
                        
                        img.src = imageData;
                } catch (error) {
                        console.error('压缩图片失败:', error);
                        // 如果压缩失败，返回原始数据
                        resolve(imageData);
                    }
                });
            }
            
            // 检查localStorage是否可用
            function isLocalStorageAvailable() {
                try {
                    const test = '__test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            // 获取用户特定的历史记录键
            function getUserHistoryKey() {
                try {
                    const userInfo = localStorage.getItem('user');
                    if (userInfo) {
                        const user = JSON.parse(userInfo);
                        const userId = user.id || user.phone || 'anonymous';
                        return `imageExpansionHistory_${userId}`;
                    }
                } catch (error) {
                    console.error('获取用户ID失败:', error);
                }
                return 'imageExpansionHistory_anonymous';
            }
            
            // 格式化日期时间为24小时制
            function formatDateTime(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            }
            
            // 加载历史记录
            async function loadHistory() {
                try {
                    console.log('开始加载历史记录');
                    const historyContainer = document.getElementById('history-container');
                    if (!historyContainer) {
                        console.error('找不到历史记录容器元素');
                        return;
                    }
                    
                    // 显示加载中状态
                    historyContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">' + getTranslation('common.loading') + '</p>';
                    
                    // 检查ImageExpansionHistory模块是否已加载
                    if (!window.ImageExpansionHistory) {
                        console.error('ImageExpansionHistory模块未加载');
                        historyContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">' + getTranslation('image_expansion.load_history_failed') + '</p>';
                        return;
                    }
                    
                    // 使用新的历史记录管理模块获取历史记录
                    const records = await window.ImageExpansionHistory.fetch();
                    console.log('获取到历史记录:', records);
                    
                    // 显示历史记录
                    window.ImageExpansionHistory.display(records, 'history-container');
                    
                    // 旧的历史记录加载代码已被替换为OSS存储
                    /*
                    let history = [];
                    try {
                        console.log('开始加载历史记录');
                        const historyKey = getUserHistoryKey();
                        console.log('使用历史记录键:', historyKey);
                        const historyData = localStorage.getItem(historyKey);
                        console.log('从localStorage获取的历史记录数据:', historyData);
                        
                        if (historyData) {
                            history = JSON.parse(historyData);
                            console.log('解析后的历史记录:', history);
                            console.log('历史记录数量:', history.length);
                        } else {
                            console.log('localStorage中没有历史记录数据');
                        }
                    } catch (e) {
                        console.error('解析历史记录失败', e);
                        history = [];
                    }
                    
                    // 确保显示最新的3条记录
                    const limitedHistory = history.slice(0, 3);
                    console.log('将显示的历史记录数量:', limitedHistory.length);
                
                    if (limitedHistory.length === 0) {
                        historyContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">' + getTranslation('image_expansion.no_history') + '</p>';
                        return;
                    }
                
                    // 清空历史记录容器
                    historyContainer.innerHTML = '';
                
                    // 遍历历史记录并创建卡片
                    limitedHistory.forEach((item, index) => {
                        console.log(`处理第${index+1}条历史记录:`, item.prompt);
                        
                        // 创建历史记录卡片
                        const historyCard = document.createElement('div');
                        historyCard.className = 'history-card bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all';
                    
                        const originalImage = item.originalImage;
                        const resultImage = item.resultImage;
                        const prompt = item.prompt || '智能扩图';
                        const createdAt = new Date(item.createdAt).toLocaleString();
                    
                        // 设置卡片内容
                        historyCard.innerHTML = `
                            <div class="relative">
                                <img src="${resultImage}" alt="Result Image" class="history-thumbnail w-full h-32 object-cover" loading="lazy">
                            </div>
                            <div class="p-3">
                                <p class="text-sm text-gray-700 truncate" title="${prompt}">${prompt}</p>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-xs text-gray-500">${createdAt}</span>
                                    <button class="download-history-btn text-indigo-600 hover:text-indigo-800 p-1">
                                        <i class="ri-download-line"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // 下载按钮点击事件
                        const downloadHistoryBtn = historyCard.querySelector('.download-history-btn');
                        downloadHistoryBtn.addEventListener('click', function(e) {
                            e.stopPropagation(); // 防止触发卡片点击事件
                            downloadImage(resultImage, `扩图结果_${Date.now()}.png`);
                        });
                        
                        // 移除查看按钮和卡片点击事件
                        
                        // 将卡片添加到容器
                        historyContainer.appendChild(historyCard);
                    });
                    
                    console.log('历史记录加载完成');
                    */
                } catch (error) {
                    console.error('加载历史记录失败:', error);
                    const historyContainer = document.getElementById('history-container');
                    if (historyContainer) {
                        historyContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">' + getTranslation('image_expansion.load_history_failed') + '</p>';
                    }
                }
            }
            
            // 下载图片函数
            function downloadImage(imageUrl, fileName) {
                try {
                    // 创建一个临时的a标签来触发下载
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = fileName || 'image.png';
                    
                    // 添加到DOM中
                    document.body.appendChild(link);
                    
                    // 触发点击事件
                    link.click();
                    
                    // 清理DOM
                    document.body.removeChild(link);
                    
                    console.log('图片下载成功:', fileName);
                } catch (error) {
                    console.error('图片下载失败:', error);
                    alert(getTranslation('image_expansion.download_failed'));
                }
            }
            
            // 辅助函数
            function handleImageFile(file) {
                // 检查文件类型
                if (!file.type.startsWith('image/')) {
                    alert('' + getTranslation('image_expansion.upload_image_file') + '支持的格式包括JPG、PNG和WEBP');
                    return;
                }
                
                // 检查文件大小
                if (file.size > 10 * 1024 * 1024) { // 10MB 限制
                    alert(getTranslation('image_expansion.file_too_large'));
                    return;
                }
                
                // 创建预览并检查图片尺寸
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = function() {
                        // 检查图片尺寸
                        if (img.width < 512 || img.height < 512) {
                            alert(getTranslation('image_expansion.image_too_small'));
                            return;
                        }
                        
                        if (img.width > 2048 || img.height > 2048) {
                            alert(getTranslation('image_expansion.image_too_large'));
                            return;
                        }
                        
                        // 显示原始图片
                        originalImage.src = event.target.result;
                        originalImage.classList.remove('hidden');
                        originalImagePlaceholder.classList.add('hidden');
                        
                        // 重置结果区域
                        resultImage.classList.add('hidden');
                        resultImagePlaceholder.classList.remove('hidden');
                        
                        // 隐藏操作按钮
                        const imageActions = document.getElementById('image-actions');
                        if (imageActions) {
                            imageActions.classList.add('hidden');
                        }
                        
                        // 更新生成按钮状态
                        updateGenerateButtonState();
                    };
                    img.src = event.target.result;
                };
                reader.onerror = () => {
                    alert(getTranslation('image_expansion.file_read_failed'));
                };
                reader.readAsDataURL(file);
            }
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                uploadArea.classList.add('border-indigo-500', 'bg-indigo-50');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('border-indigo-500', 'bg-indigo-50');
            }
            
            // 防止左右区域滚动相互影响
            function preventScrollPropagation() {
                const leftPanel = document.querySelector('.left-panel');
                const rightPanel = document.querySelector('.right-panel');
                
                if (leftPanel) {
                    // 左侧面板滚动事件处理
                    leftPanel.addEventListener('scroll', function(e) {
                        e.stopPropagation();
                    }, { passive: true });
                    
                    leftPanel.addEventListener('wheel', function(e) {
                        e.stopPropagation();
                        
                        const atTop = leftPanel.scrollTop === 0;
                        const atBottom = leftPanel.scrollTop >= (leftPanel.scrollHeight - leftPanel.clientHeight - 1);
                        
                        // 防止边界滚动传播到页面
                        if ((atTop && e.deltaY < 0) || (atBottom && e.deltaY > 0)) {
                            e.preventDefault();
                        }
                    }, { passive: false });
                }
                
                if (rightPanel) {
                    // 右侧面板滚动事件处理
                    rightPanel.addEventListener('scroll', function(e) {
                        e.stopPropagation();
                    }, { passive: true });
                    
                    rightPanel.addEventListener('wheel', function(e) {
                        e.stopPropagation();
                        
                        const atTop = rightPanel.scrollTop === 0;
                        const atBottom = rightPanel.scrollTop >= (rightPanel.scrollHeight - rightPanel.clientHeight - 1);
                        
                        // 防止边界滚动传播到页面
                        if ((atTop && e.deltaY < 0) || (atBottom && e.deltaY > 0)) {
                            e.preventDefault();
                        }
                    }, { passive: false });
                }
            }
            
            // 初始化滚动防护
            preventScrollPropagation();
            
            // 调试信息
            console.log('智能扩图页面初始化完成');
            
            // 刷新历史按钮点击事件
            document.getElementById('refresh-history-btn').addEventListener('click', function() {
                loadHistory();
            });

            // 清除历史记录按钮点击事件
            document.getElementById('clear-history-btn').addEventListener('click', async function() {
                if (confirm('确定要清空所有智能扩图历史记录吗？此操作不可逆。')) {
                    try {
                        // 获取认证令牌
                        const authToken = localStorage.getItem('authToken');
                        
                        // 调用后端API清空历史记录
                        const response = await fetch('/api/image-expansion-history/clear', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': authToken ? `Bearer ${authToken}` : ''
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            console.log('历史记录已清空');
                            loadHistory(); // 刷新显示
                            alert(getTranslation('image_expansion.history_cleared'));
                        } else {
                            throw new Error(data.message || '清空历史记录失败');
                        }
                    } catch (e) {
                        console.error('清空历史记录失败:', e);
                        alert(getTranslation('image_expansion.clear_history_failed'));
                    }
                }
            });
            
            // 确保JS模块已加载后再初始化历史记录
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(loadHistory, 500); // 延迟加载历史记录，确保JS模块已加载
                });
            } else {
                setTimeout(loadHistory, 500);
            }
            
            // 设置用户状态监听，检测用户切换
            setupUserStateListener();
            
            // 确保历史记录在页面完全加载后显示
            window.addEventListener('load', function() {
                console.log('页面完全加载，重新加载历史记录');
                
                // 检查并显示当前localStorage状态
                if (isLocalStorageAvailable()) {
                    try {
                        const historyKey = getUserHistoryKey();
                        const historyData = localStorage.getItem(historyKey);
                        if (historyData) {
                            const history = JSON.parse(historyData);
                            console.log('当前历史记录状态:', {
                                记录数量: history.length,
                                数据大小: historyData.length + ' 字节',
                                最新记录创建时间: history[0] ? new Date(history[0].createdAt).toLocaleString() : '无'
                            });
                        } else {
                            console.log('当前历史记录为空');
                        }
                    } catch (e) {
                        console.error('检查历史记录状态失败:', e);
                    }
                }
                
                // 延迟500ms再次加载历史记录，确保DOM已完全准备好
                setTimeout(loadHistory, 500);
                
                // 5秒后再次尝试加载，以防之前的加载失败
                setTimeout(function() {
                    console.log('最终检查历史记录显示');
                    const historyContainer = document.getElementById('history-container');
                    if (historyContainer && historyContainer.children.length <= 1) {
                        console.log('历史记录可能未正确加载，再次尝试');
                loadHistory();
                    }
                }, 5000);
            });
            
            // 用户状态监听函数
            function setupUserStateListener() {
                let currentUserId = null;
                let currentAuthToken = null;
                
                // 获取当前用户ID
                function getCurrentUserId() {
                    try {
                        const userInfo = localStorage.getItem('user');
                        if (userInfo) {
                            const user = JSON.parse(userInfo);
                            return user.id || user.phone || 'unknown';
                        }
                    } catch (error) {
                        console.error('获取用户ID失败:', error);
                    }
                    return null;
                }
                
                // 检查用户状态变化
                function checkUserState() {
                    const newUserId = getCurrentUserId();
                    const newAuthToken = localStorage.getItem('authToken');
                    
                    // 如果是第一次检查，记录当前状态
                    if (currentUserId === null) {
                        currentUserId = newUserId;
                        currentAuthToken = newAuthToken;
                        console.log('智能扩图页面：初始化用户状态监听，当前用户:', currentUserId);
                        return;
                    }
                    
                    // 检查用户ID或认证令牌是否发生变化
                    if (newUserId !== currentUserId || newAuthToken !== currentAuthToken) {
                        console.log('智能扩图页面：检测到用户切换，清除历史记录');
                        console.log('原用户:', currentUserId, '新用户:', newUserId);
                        
                        // 清除智能扩图历史记录
                        try {
                            const historyKey = getUserHistoryKey();
                            localStorage.removeItem(historyKey);
                            console.log('智能扩图页面：已清除历史记录，键:', historyKey);
                        } catch (error) {
                            console.error('智能扩图页面：清除历史记录失败:', error);
                        }
                        
                        // 清空历史记录显示
                        const historyContainer = document.getElementById('history-container');
                        if (historyContainer) {
                            historyContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">' + getTranslation('image_expansion.no_history') + '</p>';
                        }
                        
                        // 更新当前用户状态
                        currentUserId = newUserId;
                        currentAuthToken = newAuthToken;
                        
                        // 重新加载新用户的历史记录
                        if (newUserId && newAuthToken) {
                            console.log('智能扩图页面：重新加载新用户的历史记录');
                            setTimeout(() => {
                                loadHistory();
                            }, 100);
                        }
                    }
                }
                
                // 定期检查用户状态（每2秒检查一次）
                setInterval(checkUserState, 2000);
                
                // 监听localStorage变化
                window.addEventListener('storage', function(e) {
                    if (e.key === 'user' || e.key === 'authToken') {
                        console.log('智能扩图页面：检测到localStorage变化，重新检查用户状态');
                        setTimeout(checkUserState, 100);
                    }
                });
                
                // 监听页面焦点变化（用户可能在其他标签页切换账号）
                window.addEventListener('focus', function() {
                    console.log('智能扩图页面：页面获得焦点，检查用户状态');
                    setTimeout(checkUserState, 100);
                });
                
                console.log('智能扩图页面：用户状态监听已启动');
            }
        });
    </script>

    <!-- 多语言支持脚本 -->
    <script src="/translations.js"></script>
    <script>
        // 多语言支持函数
        function getTranslation(key) {
            const currentLang = localStorage.getItem('language') || 'zh';
            return translations[currentLang] && translations[currentLang][key] ? translations[currentLang][key] : key;
        }
        
        // 将翻译函数暴露到全局，供其他模块使用
        window.getTranslation = getTranslation;

        function updatePageLanguage() {
            const currentLang = localStorage.getItem('language') || 'zh';
            
            // 更新页面标题
            document.title = getTranslation('page.image_expansion_title');
            
            // 更新所有带有 data-translate 属性的元素
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                const translation = getTranslation(key);
                
                if (element.tagName === 'TITLE') {
                    element.textContent = translation;
                } else if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                    element.placeholder = translation;
                } else {
                    element.textContent = translation;
                }
            });
            
            // 更新所有带有 data-translate-placeholder 属性的元素
            document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                const translation = getTranslation(key);
                element.placeholder = translation;
            });
        }

        // 监听语言变化
        window.addEventListener('languageChanged', function() {
            updatePageLanguage();
        });

        // 页面加载时应用语言设置
        document.addEventListener('DOMContentLoaded', function() {
            updatePageLanguage();
        });

        // URL参数语言设置
        const urlParams = new URLSearchParams(window.location.search);
        const langParam = urlParams.get('lang');
        if (langParam) {
            const language = langParam === 'en-us' ? 'en' : 'zh';
            localStorage.setItem('language', language);
            updatePageLanguage();
        }
    </script>
</body>
</html> 

