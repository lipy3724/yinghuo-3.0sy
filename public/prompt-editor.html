<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="prompt_editor.page_title">指令编辑 - 萤火AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="/components/styles.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f9fafb;
        }
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 160px;
        }
        .upload-area:hover {
            border-color: #6366f1;
            background-color: #eef2ff;
        }
        .prompt-input {
            resize: none;
            min-height: 120px;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            font-size: 0.9rem;
            line-height: 1.5;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .image-preview {
            aspect-ratio: 16/9;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 5px solid rgba(99, 102, 241, 0.2);
            border-top-color: rgba(99, 102, 241, 1);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .feature-tag {
            background-color: #eef2ff;
            color: #6366f1;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }
        .tips-card {
            background-color: #eef2ff;
            border-left: 4px solid #6366f1;
        }
        .history-thumbnail {
            width: 100%;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
    </style>
    <link rel="icon" href="/images/favicon.png" type="image/png">
    <script src="/js/auth-check.js"></script>
    <script src="/js/mobile-guard.js"></script>
    <script src="/translations.js"></script>
    <script src="/js/wanxiang-api.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 简化版导航栏 -->
    <div id="navbar-simple"></div>
    
    <!-- 主内容区域 -->
    <div class="container mx-auto py-8 px-4" style="margin-top: 60px;">
        <h1 class="text-3xl font-bold text-center mb-8" data-translate="prompt_editor.main_title">AI 指令编辑</h1>
                
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- 左侧面板: 图片上传和指令输入 -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4" data-translate="prompt_editor.edit_settings">编辑设置</h2>
                
                <!-- 图片上传区域 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="prompt_editor.image_upload">图片上传</label>
                                <div id="upload-area" class="upload-area flex flex-col items-center justify-center mb-2 bg-gray-50 border border-dashed border-gray-300 rounded-md hover:border-indigo-500 hover:bg-indigo-50 transition-colors">
                                    <i class="ri-upload-cloud-line text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-500 text-center text-sm px-2" data-translate="prompt_editor.upload_placeholder">点击或者拖动文件到这区域来上传</p>
                                    <p class="text-xs text-gray-400 mt-1" data-translate="prompt_editor.upload_format">支持jpg、png、webp格式，大小不超过10MB</p>
                                    <input type="file" id="image-upload" class="hidden" accept="image/*">
                                </div>
                    <p class="mt-1 text-xs text-gray-500" data-translate="prompt_editor.upload_recommendation">建议使用清晰的图片，尺寸最小为512×512px</p>
                            </div>
                            
                <!-- 编辑指令输入 -->
                <div class="mb-6">
                    <label for="prompt-input" class="block text-sm font-medium text-gray-700 mb-1" data-translate="prompt_editor.edit_instruction">编辑指令</label>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700" data-translate="prompt_editor.input_description">输入编辑描述</span>
                                </div>
                    <textarea id="prompt-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="4" data-translate-placeholder="prompt_editor.prompt_placeholder" placeholder="例如：将图片中人物的头发颜色修改为红色，添加一副金色眼镜，背景改为海滩"></textarea>
                    <p class="mt-1 text-xs text-gray-500" data-translate="prompt_editor.prompt_tip">详细、具体的描述可以获得更好的效果</p>
                                </div>
                                
                <!-- 使用技巧 -->
                <div class="mb-6">
                    <div class="tips-card p-4 rounded-md">
                                    <h3 class="font-medium text-blue-800 flex items-center mb-2">
                                        <i class="ri-lightbulb-line mr-1"></i><span data-translate="prompt_editor.usage_tips">使用技巧</span>
                                    </h3>
                                    <ul class="text-sm text-blue-700 space-y-1 pl-5 list-disc">
                                        <li data-translate="prompt_editor.tip_1">使用“添加”、“移除”、“修改”等明确的动作词</li>
                                        <li data-translate="prompt_editor.tip_2">详细描述颜色、材质、位置等属性</li>
                                        <li data-translate="prompt_editor.tip_3">一次修改一个或少数几个元素效果更佳</li>
                                    </ul>
                                </div>
                            </div>
                            
                <div class="pt-4">
                    <button id="generate-btn" class="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 flex items-center justify-center">
                                    <i class="ri-magic-line mr-2"></i>
                        <span data-translate="prompt_editor.generate_button">生成图片</span>
                                </button>
                    <p class="mt-2 text-center text-sm text-gray-500" data-translate="prompt_editor.generation_info">
                        图片生成需要5-10秒，消耗7积分
                    </p>
                    <p class="mt-2 text-center text-sm text-red-500 font-medium" data-translate="prompt_editor.warning">
                        请上传合法合规的图片，如有违反会进行封号处理，任务一旦提交就会扣除积分不可中断，请勿重复刷新提交，否则会造成积分浪费。
                    </p>
                        </div>
                    </div>
                    
            <!-- 右侧面板: 预览和历史记录 -->
            <div class="lg:col-span-3">
                <!-- 预览区域 -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h2 class="text-xl font-bold mb-4" data-translate="prompt_editor.preview_title">效果预览</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white border border-gray-200 rounded-md overflow-hidden">
                            <h3 class="text-base font-medium p-3 border-b border-gray-100 flex items-center text-gray-700">
                                        <i class="ri-image-line mr-1 text-gray-500"></i>
                                        <span data-translate="prompt_editor.original_image">原始图片</span>
                                    </h3>
                            <div id="original-image-container" class="image-preview flex items-center justify-center overflow-hidden">
                                        <img id="original-image" class="hidden max-w-full max-h-full object-contain" alt="上传的图片">
                                        <div id="original-image-placeholder" class="text-center px-6">
                                    <i class="ri-image-add-line text-6xl text-gray-300 mb-4"></i>
                                    <p class="text-gray-500" data-translate="prompt_editor.upload_image_prompt">请上传图片</p>
                                        </div>
                                    </div>
                                </div>
                                
                        <div class="bg-white border border-gray-200 rounded-md overflow-hidden">
                            <div class="flex justify-between items-center p-3 border-b border-gray-100">
                                        <h3 class="text-base font-medium flex items-center text-gray-700">
                                            <i class="ri-magic-line mr-1 text-indigo-500"></i>
                                            <span data-translate="prompt_editor.result_image">生成结果</span>
                                        </h3>
                                    </div>
                            <div id="result-image-container" class="image-preview flex items-center justify-center overflow-hidden">
                                        <img id="result-image" class="hidden max-w-full max-h-full object-contain" alt="生成的图片">
                                        <div id="result-image-placeholder" class="text-center px-6">
                                    <i class="ri-landscape-line text-6xl text-gray-300 mb-4"></i>
                                    <p class="text-gray-500" data-translate="prompt_editor.result_placeholder">生成结果将在这里显示</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                    <div class="flex justify-center mt-4">
                        <button id="download-btn" class="hidden bg-indigo-600 text-white py-2.5 px-6 rounded-md hover:bg-indigo-700 transition flex items-center justify-center mr-4">
                                    <i class="ri-download-line mr-2"></i>
                                    <span data-translate="prompt_editor.download_result">下载结果</span>
                                </button>
                        <button id="save-to-downloads-btn" class="hidden bg-white border border-indigo-500 text-indigo-600 py-2.5 px-6 rounded-md hover:bg-indigo-50 transition flex items-center justify-center">
                            <i class="ri-save-line mr-2"></i>
                            <span data-translate="prompt_editor.save_to_downloads">保存到下载中心</span>
                        </button>
                    </div>
                            </div>
                            
                <!-- 历史记录 -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold" data-translate="prompt_editor.history_title">生成历史</h2>
                        <div class="flex space-x-2">
                            <button id="clear-history-btn" class="text-gray-500 hover:text-red-600" title="清空历史记录">
                                <i class="ri-delete-bin-line text-xl"></i>
                            </button>
                            <button id="refresh-history-btn" class="text-indigo-600 hover:text-indigo-800" title="刷新历史记录">
                                <i class="ri-refresh-line text-xl"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="history-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <!-- 历史记录将通过JavaScript动态添加到这里 -->
                        <p class="text-gray-500 col-span-full text-center py-4" data-translate="prompt_editor.no_history">暂无历史记录</p>
                    </div>
                    
                    <!-- 保存时间提示 -->
                    <p class="text-xs text-gray-400 mt-3 text-center" data-translate="prompt_editor.history_retention">历史记录仅显示最新3条，保存时间24小时</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 加载中遮罩 -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loading-spinner mb-4"></div>
            <p id="loading-message" class="text-lg font-medium" data-translate="prompt_editor.generating">图片生成中，请耐心等待...</p>
            <p class="text-sm text-gray-500 mt-2" data-translate="prompt_editor.generation_time">图片生成需要5-10秒</p>
        </div>
    </div>

    <script>
        // 当前语言
        let currentLanguage = localStorage.getItem('language') || 'zh';
        
        // 更新页面文本的函数
        function updatePageText(language) {
            currentLanguage = language || currentLanguage;
            
            // 更新所有带有data-translate属性的元素
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (window.translations && window.translations[currentLanguage] && window.translations[currentLanguage][key]) {
                    element.textContent = window.translations[currentLanguage][key];
                }
            });
            
            // 更新placeholder属性
            const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
            placeholderElements.forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                if (window.translations && window.translations[currentLanguage] && window.translations[currentLanguage][key]) {
                    element.placeholder = window.translations[currentLanguage][key];
                }
            });
            
            // 更新页面标题
            const titleElement = document.querySelector('title[data-translate]');
            if (titleElement) {
                const key = titleElement.getAttribute('data-translate');
                if (window.translations && window.translations[currentLanguage] && window.translations[currentLanguage][key]) {
                    document.title = window.translations[currentLanguage][key];
                }
            }
            
            console.log('页面文本已更新为:', currentLanguage === 'zh' ? '中文' : 'English');
        }
        
        // 监听语言变化事件
        document.addEventListener('languageChanged', function(event) {
            console.log('收到语言变化事件:', event.detail.language);
            updatePageText(event.detail.language);
        });
        
        // 页面加载时初始化语言
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟执行，确保translations.js已加载
            setTimeout(() => {
                updatePageText(currentLanguage);
            }, 100);
        });
        
        document.addEventListener('DOMContentLoaded', async function() {
            // 首先检查用户认证状态
            console.log("页面加载：开始检查用户认证状态");
            
            // 检查本地存储
            const authToken = localStorage.getItem("authToken");
            const userInfo = localStorage.getItem("user");
            
            if (!authToken || !userInfo) {
                console.log("页面加载：用户未登录，跳转到登录页");
                window.location.href = "/login.html?redirect=" + encodeURIComponent(window.location.href);
                return;
            }
            
            // 如果有统一的认证检查函数，使用它
            if (typeof window.checkAuth === "function") {
                try {
                    const isAuthenticated = await window.checkAuth(true);
                    if (!isAuthenticated) {
                        console.log("页面加载：认证检查失败");
                        return; // checkAuth会自动处理重定向
                    }
                    console.log("页面加载：认证检查通过");
                } catch (error) {
                    console.error("页面加载：认证检查出错:", error);
                    // 出错时也继续加载页面，但记录错误
                }
            }
            
            // 加载简化版导航栏组件
            try {
                const navbarResponse = await fetch('/components/navbar-simple.html');
                const navbarHtml = await navbarResponse.text();
                document.getElementById('navbar-simple').innerHTML = navbarHtml;
                
                // 加载组件JavaScript
                const componentsScript = document.createElement('script');
                componentsScript.src = '/components/components.js';
                document.head.appendChild(componentsScript);
            } catch (error) {
                console.error('加载导航栏组件失败:', error);
            }
            
            // 获取DOM元素
            const uploadArea = document.getElementById('upload-area');
            const imageUpload = document.getElementById('image-upload');
            const originalImage = document.getElementById('original-image');
            const originalImagePlaceholder = document.getElementById('original-image-placeholder');
            const resultImage = document.getElementById('result-image');
            const resultImagePlaceholder = document.getElementById('result-image-placeholder');
            const promptInput = document.getElementById('prompt-input');
            const generateBtn = document.getElementById('generate-btn');
            const downloadBtn = document.getElementById('download-btn');
            const saveToDownloadsBtn = document.getElementById('save-to-downloads-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            const historyContainer = document.getElementById('history-container');
            const refreshHistoryBtn = document.getElementById('refresh-history-btn');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            
            // 上传区域点击事件
            uploadArea.addEventListener('click', () => {
                imageUpload.click();
            });
            
            // 文件上传事件
            imageUpload.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    handleImageFile(e.target.files[0]);
                }
            });
            
            // 拖放功能
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-indigo-500', 'bg-indigo-50');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-indigo-500', 'bg-indigo-50');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-indigo-500', 'bg-indigo-50');
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleImageFile(e.dataTransfer.files[0]);
                }
            });
            
            // 下载按钮点击事件
            downloadBtn.addEventListener('click', () => {
                if (resultImage.src && !resultImage.classList.contains('hidden')) {
                    const link = document.createElement('a');
                    link.href = resultImage.src;
                    link.download = `edited_image_${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            });
            
            // 保存到下载中心按钮
            saveToDownloadsBtn.addEventListener('click', async () => {
                if (!resultImage.src || resultImage.classList.contains('hidden')) {
                    return;
                }
                
                loadingOverlay.classList.remove('hidden');
                loadingMessage.textContent = '正在保存到下载中心...';
                
                try {
                    const response = await fetch('/api/downloads/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            imageUrl: resultImage.src,
                            title: '图片编辑: ' + promptInput.value.substring(0, 30) + (promptInput.value.length > 30 ? '...' : ''),
                            description: promptInput.value,
                            type: 'IMAGE_EDIT'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('已成功保存到下载中心');
                } else {
                        throw new Error(data.message || '保存失败');
                    }
                } catch (error) {
                    console.error('保存失败:', error);
                    alert('保存到下载中心失败: ' + error.message);
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            });
            
            // 刷新历史按钮点击事件
            refreshHistoryBtn.addEventListener('click', async function() {
                await loadHistory();
            });
            
            // 生成按钮点击
            generateBtn.addEventListener('click', async () => {
                const prompt = promptInput.value.trim();
                
                if (!originalImage.src || originalImage.classList.contains('hidden')) {
                    alert('请先上传图片！');
                    return;
                }
                
                if (!prompt) {
                    alert('请输入提示词！');
                    return;
                }
                
                // 暂停认证检查，避免与API调用冲突
                if (window.isAuthChecking) {
                    console.log('等待认证检查完成...');
                    // 等待认证检查完成
                    let waitCount = 0;
                    while (window.isAuthChecking && waitCount < 10) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        waitCount++;
                    }
                }
                
                // 显示加载中
                loadingOverlay.classList.remove('hidden');
                loadingMessage.textContent = '正在处理图像，请稍候...';
                
                try {
                    // 1. 先将图片上传到服务器获取URL
                    const imageUrl = await uploadImageToServer(originalImage.src);
                    
                    if (!imageUrl) {
                        throw new Error('图片上传失败');
                    }
                    
                    // 2. 调用通义万相API创建任务
                    const taskId = await window.wanxiangApi.createImageEditTask(prompt, imageUrl);
                    
                    if (!taskId) {
                        throw new Error('创建图像编辑任务失败');
                    }
                    
                    // 3. 轮询任务状态
                    const resultImageUrl = await window.wanxiangApi.pollTaskStatus(taskId);
                    
                    if (resultImageUrl) {
                        // 4. 显示结果图像
                        resultImage.src = resultImageUrl;
                        resultImage.classList.remove('hidden');
                        resultImagePlaceholder.classList.add('hidden');
                        downloadBtn.classList.remove('hidden');
                        saveToDownloadsBtn.classList.remove('hidden');
                        
                        // 保存到历史记录并刷新历史显示
                        try {
                            console.log('开始保存历史记录，原图URL:', originalImage.src.substring(0, 50) + '...');
                            console.log('开始保存历史记录，结果图URL:', resultImageUrl.substring(0, 50) + '...');
                            
                            await saveToHistory({
                                prompt: prompt,
                                inputImageUrl: originalImage.src,
                                outputImageUrl: resultImageUrl,
                                function: 'description_edit', // 修改为正确的功能类型
                                model: 'wanx2.1-imageedit',
                                taskId: taskId // 添加taskId
                            });
                            
                            console.log('历史记录保存成功，准备刷新历史记录显示');
                            
                            // 刷新历史记录显示
                            await loadHistory();
                        } catch (historyError) {
                            console.error('保存历史记录失败:', historyError);
                            // 历史记录保存失败不影响主要功能
                        }
                    } else {
                        throw new Error('获取结果图像失败');
                    }
                } catch (error) {
                    console.error('处理失败:', error);
                    alert('处理失败: ' + error.message);
                } finally {
                    // 隐藏加载遮罩
                    loadingOverlay.classList.add('hidden');
                }
            });
            
        // 上传图片到服务器获取URL
        async function uploadImageToServer(base64Image) {
            loadingMessage.textContent = '正在上传图片...';
            
            try {
                // 从Base64中提取实际数据部分
                let base64Data;
                if (base64Image.startsWith('data:')) {
                    // 如果是完整的Data URL，提取Base64部分
                    base64Data = base64Image.split(',')[1];
                } else {
                    // 如果已经是纯Base64数据，直接使用
                    base64Data = base64Image;
                }
                
                // 直接使用Base64上传接口，不需要认证
                const response = await fetch('/api/upload/image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}` // 添加认证令牌
                    },
                    body: JSON.stringify({
                        image: `data:image/png;base64,${base64Data}`,
                        type: 'base64'
                    })
                });
                
                const data = await response.json();
                console.log('上传图片响应:', data);
                
                // 检查各种可能的返回格式
                if (data.success && data.url) {
                    return data.url;
                } else if (data.output && data.output.img_url) {
                    return data.output.img_url;
                } else if (data.imageUrl) {
                    return data.imageUrl;
                } else {
                    throw new Error(data.message || '上传失败');
                }
            } catch (error) {
                console.error('上传图片失败:', error);
                // 如果是网络错误或服务器错误，显示更友好的错误信息
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    throw new Error('网络连接失败，请检查网络连接后重试');
                } else if (error.message.includes('500')) {
                    throw new Error('服务器内部错误，请稍后重试');
                }
                throw error;
            }
        }
            
            // 备用图片上传函数（不需要认证）
            async function uploadImageToServerFallback(base64Data) {
                try {
                    console.log('使用备用接口上传图片...');
                    
                    // 发送请求到接口并添加认证令牌
                    const response = await fetch('/api/upload/image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}` // 添加认证令牌
                        },
                        body: JSON.stringify({
                            image: base64Data,
                            type: 'base64'
                        })
                    });
                    
                    const data = await response.json();
                    console.log('备用接口响应:', data);
                    
                    // 检查各种可能的返回格式
                    if (data.success && data.url) {
                        console.log('备用接口上传成功');
                        return data.url;
                    } else if (data.output && data.output.img_url) {
                        console.log('备用接口上传成功');
                        return data.output.img_url;
                    } else if (data.imageUrl) {
                        console.log('备用接口上传成功');
                        return data.imageUrl;
                    } else {
                        throw new Error(data.message || '备用接口上传失败');
                    }
                } catch (error) {
                    console.error('备用接口上传图片失败:', error);
                    throw error;
                }
            }
            
            // 这些函数现在已经移动到 wanxiang-api.js 文件中
            // 在生成按钮点击事件中使用 window.wanxiangApi.createImageEditTask 和 window.wanxiangApi.pollTaskStatus
            
            // 保存到历史记录（参考智能服饰分割的逻辑）
            async function saveToHistory(taskData) {
                try {
                    console.log('开始保存历史记录到服务器，任务数据:', JSON.stringify({
                        prompt: taskData.prompt,
                        function: taskData.function,
                        taskId: taskData.taskId || Date.now().toString()
                    }));
                    
                    // 1. 保存到服务器
                    const response = await fetch('/api/image-edit-history-simple/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            originalImage: taskData.inputImageUrl,
                            resultImage: taskData.outputImageUrl,
                            prompt: taskData.prompt,
                            function: taskData.function || 'description_edit',
                            metadata: taskData.metadata || {},
                            taskId: taskData.taskId || Date.now().toString()
                        })
                    });
                    
                    const responseData = await response.json();
                    
                    if (!response.ok || !responseData.success) {
                        console.error('保存历史记录到服务器失败，服务器响应:', responseData);
                        throw new Error(responseData.message || '保存历史记录到服务器失败');
                    }
                    
                    console.log('历史记录保存到OSS服务器成功，响应:', responseData);
                    return responseData;
                    
                } catch (error) {
                    console.error('保存历史记录到OSS服务器失败:', error);
                    throw new Error('保存历史记录失败: ' + error.message);
                }
            }
                
            // 加载历史记录（从OSS获取）
            async function loadHistory() {
                try {
                    console.log('开始加载历史记录...');
                    
                    // 获取用户信息
                    const userInfo = JSON.parse(localStorage.getItem('user') || '{}');
                    const userId = userInfo.id || userInfo.userId;
                    
                    if (!userId) {
                        console.error('无法获取用户ID，历史记录加载失败');
                        historyContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">无法加载历史记录</p>';
                        return;
                    }
                    
                    console.log('当前用户ID:', userId);
                    
                    // 从OSS获取历史记录 - 限制为最新3条和24小时
                    const response = await fetch(`/api/image-edit-history-simple/list?hours=24&limit=10`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    const data = await response.json();
                    console.log('历史记录API响应:', data);
                    
                    if (!data.success) {
                        throw new Error(data.message || '获取历史记录失败');
                    }
                    
                    const history = data.records || [];
                    console.log(`成功获取历史记录，共${history.length}条`);
                    
                    // 清空历史记录容器
                    historyContainer.innerHTML = '';
                    
                    if (history.length === 0) {
                        historyContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">暂无历史记录</p>';
                        return;
                    }
                    
                    // 按时间倒序排序历史记录，确保最新的记录在最前面
                    history.sort((a, b) => {
                        // 确保时间戳是有效的日期字符串或数值
                        const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                        const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                        console.log(`比较时间: ${new Date(timeA).toLocaleString()} 和 ${new Date(timeB).toLocaleString()}`);
                        return timeB - timeA;
                    });
                    
                    // 只显示最新的3条记录
                    const recentHistory = history.slice(0, 3);
                    console.log(`筛选后显示${recentHistory.length}条最新记录`);
                    
                    // 遍历历史记录并创建卡片
                    recentHistory.forEach((item, index) => {
                        console.log(`处理第${index+1}条历史记录:`, item.prompt || '无提示词', '时间:', new Date(item.timestamp).toLocaleString());
                        
                        // 创建历史记录卡片
                        const historyCard = document.createElement('div');
                        historyCard.className = 'history-card bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all cursor-pointer';
                    
                        const originalImage = item.originalImage || '';
                        const resultImage = item.resultImage || '';
                        const prompt = item.prompt || '图片编辑';
                        const createdAt = new Date(item.timestamp).toLocaleString();
                        
                        // 使用代理服务处理图片URL避免CORS问题
                        // 直接使用原始URL，不使用代理
                        const proxyResultImage = resultImage || '';
                        
                        // 设置卡片内容
                        historyCard.innerHTML = `
                            <div class="relative">
                                <img src="${proxyResultImage}" alt="结果图" class="history-thumbnail w-full h-32 object-cover" loading="lazy">
                            </div>
                            <div class="p-3">
                                <p class="text-sm text-gray-700 truncate" title="${prompt}">${prompt}</p>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-xs text-gray-500">${createdAt}</span>
                                    <button class="download-history-btn text-indigo-600 hover:text-indigo-800 p-1">
                                        <i class="ri-download-line"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // 下载按钮点击事件
                        const downloadHistoryBtn = historyCard.querySelector('.download-history-btn');
                        downloadHistoryBtn.addEventListener('click', function(e) {
                            e.stopPropagation(); // 防止触发卡片点击事件
                            downloadImage(resultImage, `图片编辑_${Date.now()}.png`);
                        });
                        
                        // 卡片点击事件
                        historyCard.addEventListener('click', () => {
                            // 显示历史记录的图片
                            resultImage.src = resultImage;
                            resultImage.classList.remove('hidden');
                            resultImagePlaceholder.classList.add('hidden');
                            downloadBtn.classList.remove('hidden');
                            saveToDownloadsBtn.classList.remove('hidden');
                            
                            // 提示词恢复
                            if (prompt) {
                                promptInput.value = prompt;
                            }
                        });
                        
                        // 将卡片添加到容器
                        historyContainer.appendChild(historyCard);
                    });
                    
                    console.log('历史记录加载完成，共', history.length, '条记录');
                } catch (error) {
                    console.error('加载历史记录失败:', error);
                    historyContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">加载历史记录失败</p>';
                }
            }

            // 清空历史记录（删除OSS中的记录）
            async function clearHistory() {
                if (confirm('确定要清空所有历史记录吗？此操作不可恢复。')) {
                    try {
                        // 获取用户信息
                        const userInfo = JSON.parse(localStorage.getItem('user') || '{}');
                        const userId = userInfo.id || userInfo.userId;
                        
                        if (!userId) {
                            alert('无法获取用户ID，清空历史记录失败');
                            return;
                        }
                        
                        // 调用API删除OSS中的历史记录
                        const response = await fetch(`/api/image-edit-history-simple/clear`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            console.log('历史记录已清空');
                            await loadHistory(); // 重新加载历史记录显示
                            alert('历史记录已清空');
                        } else {
                            throw new Error(data.message || '清空历史记录失败');
                        }
                    } catch (error) {
                        console.error('清空历史记录失败:', error);
                        alert('清空历史记录失败: ' + error.message);
                    }
                }
            }
            
            // 下载图片函数
            function downloadImage(imageUrl, fileName) {
                try {
                    // 创建一个临时的a标签来触发下载
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = fileName || 'image.png';
                    
                    // 添加到DOM中
                    document.body.appendChild(link);
                    
                    // 触发点击事件
                    link.click();
                    
                    // 清理DOM
                    document.body.removeChild(link);
                } catch (error) {
                    console.error('下载图片失败:', error);
                    alert('下载图片失败');
                }
            }

            // 辅助函数
            function handleImageFile(file) {
                if (file.size > 10 * 1024 * 1024) { // 10MB 限制
                    alert('图片大小不能超过10MB！');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    originalImage.src = event.target.result;
                    originalImage.classList.remove('hidden');
                    originalImagePlaceholder.classList.add('hidden');
                    
                    // 重置结果区域
                    resultImage.classList.add('hidden');
                    resultImagePlaceholder.classList.remove('hidden');
                    downloadBtn.classList.add('hidden');
                    saveToDownloadsBtn.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
            
            // 绑定历史记录按钮事件
            if (refreshHistoryBtn) {
                refreshHistoryBtn.addEventListener('click', async function() {
                    await loadHistory();
                });
            }
            
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', clearHistory);
            }
            
            // 初始加载历史记录
            await loadHistory();
        });
    </script>
</body>
</html> 