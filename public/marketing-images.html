<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥é”€å›¾ç”Ÿæˆ - è¤ç«AI</title>
    <script src="/feature-tracker.js"></script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #myiframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* å°è¯•ä¿®å¤ç¼–è¾‘å™¨å†…æŒ‰é’®è”åŠ¨é—®é¢˜ */
        iframe {
            pointer-events: auto;
        }
        
        /* å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ·»åŠ æ›´å¤šæ ·å¼æ¥æ§åˆ¶ç¼–è¾‘å™¨å†…çš„æŒ‰é’®è¡Œä¸º */
    </style>
    <script>
        // open sdk æ‰©å±•é…ç½® - åˆå§‹åŒ–ä¸ºç©ºï¼Œç¨åä»APIè·å–
        window.INTL_OP_FRAME_SDK_CONFIG = {
            apiMap: {
                signature: '/open/api/signature' // ç­¾åæ¥å£è·¯å¾„
            }
        };
    </script>
    <script src="https://g.alicdn.com/code/npm/@ali/intl-op-frame-sdk/0.1.10/main.min.js"></script>

    <link rel="icon" href="/images/favicon.png" type="image/png">    <script src="/js/iframe-mobile-guard.js"></script>
</head>
<body>
    <!-- ç”¨æˆ·æç¤ºä¿¡æ¯ -->
    <div id="user-tip" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; z-index: 9999; display: none;">
        ğŸ’¡ æç¤ºï¼šä¸‹è½½å’Œä¿å­˜æ˜¯ç‹¬ç«‹æ“ä½œï¼ŒæŒ‰é’®åŠ¨ç”»ä»…ä¸ºè§†è§‰åé¦ˆ
    </div>
    
    <iframe id="myiframe" class="aidc-open-frame" src="" frameborder="0"></iframe>

    <script>
        // å¿…è¦çš„å˜é‡è®¾ç½®
        let iframeEle = document.getElementById("myiframe");
        let receiveBiz = ""; // ä¿å­˜ä¸šåŠ¡æ ‡è¯†ï¼Œç”¨äºpostMessageå›åº”
        let selectedImageIndex = 0; // å½“å‰é€‰ä¸­çš„å›¾ç‰‡ç´¢å¼•
        // æ ‡è®°æ˜¯å¦å·²è®°å½•è¿‡ä¸€æ¬¡æ‰£è´¹ï¼Œé¿å…é‡å¤æ‰£è´¹
        let hasTrackedUsage = false;
        
        // ä»APIè·å–é…ç½®ä¿¡æ¯
        async function fetchConfig() {
            try {
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    console.error('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•è·å–é…ç½®');
                    alert('è¯·å…ˆç™»å½•');
                    window.location.href = '/login.html';
                    return false;
                }
                
                const response = await fetch('/api/api-configs/marketing-images', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`è·å–é…ç½®å¤±è´¥: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // æ›´æ–°SDKé…ç½®
                    window.INTL_OP_FRAME_SDK_CONFIG = {
                        ...window.INTL_OP_FRAME_SDK_CONFIG,
                        ...result.data
                    };
                    console.log('æˆåŠŸè·å–APIé…ç½®');
                    return true;
                } else {
                    throw new Error('é…ç½®æ•°æ®æ— æ•ˆ');
                }
            } catch (error) {
                console.error('è·å–é…ç½®å¤±è´¥:', error);
                alert('è·å–é…ç½®å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜');
                return false;
            }
        }
        
        // æ„å»ºç¼–è¾‘å™¨URLå¹¶åŠ è½½
        async function initializeEditor() {
            // é¦–å…ˆè·å–é…ç½®
            const configSuccess = await fetchConfig();
            if (!configSuccess) {
                return; // å¦‚æœé…ç½®è·å–å¤±è´¥ï¼Œä¸ç»§ç»­åˆå§‹åŒ–
            }
            
            // æ„å»ºåŸºæœ¬å‚æ•°
            const params = {
                apiHost: 'aibcn', // ä½¿ç”¨aibcnæœåŠ¡èŠ‚ç‚¹
                appKey: window.INTL_OP_FRAME_SDK_CONFIG.appKey,
                trial: true,
                lang: 'zh-cn',
                charge: true, // å¼€å¯ç”Ÿäº§æ‹¦æˆª
                // å°è¯•ç¦ç”¨æŒ‰é’®è”åŠ¨æ•ˆæœ
                disableButtonSync: true,
                // å¯é€‰: imageUrlå‚æ•°å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
                // imageUrl: "https://example.com/image.jpg"
            };
            
            // ä½¿ç”¨payloadæ–¹å¼æ„å»ºURL
            const payloadString = encodeURIComponent(JSON.stringify(params));
            // ä½¿ç”¨è¥é”€å›¾ç”Ÿæˆè·¯ç”±
            // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            const isMobile = /Android|iPhone|iPad|iPod|Mobile|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                console.log("æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡ï¼Œä¸åŠ è½½ç¼–è¾‘å™¨");
                return;
            }
            
            const url = `https://editor.d.design/editor/index.html/#/marketing-image?payload=${payloadString}`;
            
            // æ›´æ–°iframeçš„src
            iframeEle.src = url;
            console.log("åŠ è½½è¥é”€å›¾ç”Ÿæˆç¼–è¾‘å™¨ï¼Œå·²å¼€å¯ç”Ÿäº§æ‹¦æˆª");
            
            // ç¼–è¾‘å™¨åŠ è½½å®Œæˆåå°è¯•ä¿®å¤æŒ‰é’®è”åŠ¨é—®é¢˜
            iframeEle.onload = function() {
                console.log("ç¼–è¾‘å™¨å·²åŠ è½½ï¼Œå°è¯•ä¿®å¤æŒ‰é’®è”åŠ¨é—®é¢˜");
                // å‘ç¼–è¾‘å™¨å‘é€é…ç½®æ¶ˆæ¯ï¼Œå°è¯•ç¦ç”¨æŒ‰é’®è”åŠ¨
                setTimeout(() => {
                    try {
                        iframeEle.contentWindow.postMessage({
                            action: 'config',
                            disableButtonSync: true,
                            separateDownloadSave: true
                        }, '*');
                        console.log("å·²å‘é€æŒ‰é’®è”åŠ¨ç¦ç”¨é…ç½®");
                    } catch (e) {
                        console.log("æ— æ³•å‘é€é…ç½®æ¶ˆæ¯:", e);
                    }
                }, 1000);
            };
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šä¸‹è½½å›¾ç‰‡
        function downloadImage(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename || 'marketing-image.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ä¿å­˜å›¾ç‰‡åˆ°æœåŠ¡å™¨
        async function saveImageResult(data) {
            try {
                console.log("å¼€å§‹ä¿å­˜è¥é”€å›¾ç‰‡ï¼Œå®Œæ•´æ•°æ®:", JSON.stringify(data));
                
                // è·å–åŸå§‹å›¾ç‰‡å’Œå¤„ç†åçš„å›¾ç‰‡URL
                let originalImageUrl = null;
                let processedImageUrl = null;
                
                // é‡ç‚¹ï¼šå¤„ç†å„ç§å¯èƒ½çš„æ•°æ®ç»“æ„
                if (typeof data === 'object') {
                    console.log("å¤„ç†å¯¹è±¡æ•°æ®æ ¼å¼");
                    
                    // æƒ…å†µ1: åŒ…å«imageUrlå±æ€§
                    if (data.imageUrl) {
                        processedImageUrl = data.imageUrl;
                        originalImageUrl = data.originalImageUrl || null;
                        console.log("ä»data.imageUrlè·å–ç»“æœURL:", processedImageUrl);
                    }
                    // æƒ…å†µ2: åŒ…å«urlå±æ€§
                    else if (data.url) {
                        processedImageUrl = data.url;
                        originalImageUrl = data.originalUrl || data.sourceUrl || null;
                        console.log("ä»data.urlè·å–ç»“æœURL:", processedImageUrl);
                    }
                    // æƒ…å†µ3: æ£€æŸ¥data.dataå¯èƒ½åŒ…å«çš„URL
                    else if (data.data) {
                        console.log("æ£€æµ‹åˆ°data.dataå­—æ®µ");
                        const subData = data.data;
                        
                        if (typeof subData === 'object') {
                            if (subData.imageUrl) {
                                processedImageUrl = subData.imageUrl;
                                console.log("ä»data.data.imageUrlè·å–ç»“æœURL:", processedImageUrl);
                            } else if (subData.url) {
                                processedImageUrl = subData.url;
                                console.log("ä»data.data.urlè·å–ç»“æœURL:", processedImageUrl);
                            }
                        } else if (typeof subData === 'string' && subData.startsWith('http')) {
                            processedImageUrl = subData;
                            console.log("ä»data.dataå­—ç¬¦ä¸²è·å–ç»“æœURL:", processedImageUrl);
                        }
                    }
                    // æƒ…å†µ4: æ£€æŸ¥resultå±æ€§
                    else if (data.result) {
                        console.log("æ£€æµ‹åˆ°data.resultå­—æ®µ");
                        if (typeof data.result === 'object') {
                            if (data.result.url) {
                                processedImageUrl = data.result.url;
                                originalImageUrl = data.result.originalUrl || null;
                                console.log("ä»data.result.urlè·å–ç»“æœURL:", processedImageUrl);
                            } else if (data.result.imageUrl) {
                                processedImageUrl = data.result.imageUrl;
                                console.log("ä»data.result.imageUrlè·å–ç»“æœURL:", processedImageUrl);
                            }
                        }
                    }
                }
                
                // å¤„ç†æ•°ç»„æ ¼å¼
                if (!processedImageUrl && Array.isArray(data) && data.length > 0) {
                    console.log("å¤„ç†æ•°ç»„å½¢å¼çš„æ•°æ®");
                    if (data[0] && data[0].url) {
                        processedImageUrl = data[0].url;
                        originalImageUrl = data[0].originalUrl || data[0].sourceUrl || null;
                        console.log("ä»data[0].urlè·å–ç»“æœURL:", processedImageUrl);
                    } else if (data[0] && typeof data[0] === 'string' && data[0].startsWith('http')) {
                        processedImageUrl = data[0];
                        console.log("ä»data[0]å­—ç¬¦ä¸²è·å–ç»“æœURL:", processedImageUrl);
                    }
                }
                
                // æ£€æŸ¥ç›´æ¥æ˜¯URLå­—ç¬¦ä¸²çš„æƒ…å†µ
                if (!processedImageUrl && typeof data === 'string' && data.startsWith('http')) {
                    processedImageUrl = data;
                    console.log("ä»å­—ç¬¦ä¸²ç›´æ¥è·å–ç»“æœURL:", processedImageUrl);
                }
                
                if (!processedImageUrl) {
                    console.error("æå–URLå¤±è´¥ï¼Œæœªæ‰¾åˆ°æœ‰æ•ˆçš„å›¾ç‰‡URLã€‚æ•°æ®ç»“æ„:", JSON.stringify(data));
                    alert('ä¿å­˜å¤±è´¥ï¼šæœªèƒ½æå–æœ‰æ•ˆçš„å›¾ç‰‡URL');
                    return false;
                }
                
                console.log("æœ€ç»ˆæå–çš„å¤„ç†åå›¾ç‰‡URL:", processedImageUrl);
                console.log("æå–çš„åŸå§‹å›¾ç‰‡URL:", originalImageUrl);
                
                // å‡†å¤‡è¦å‘é€çš„æ•°æ®
                const resultData = {
                    originalImageUrl: originalImageUrl,
                    processedImageUrl: processedImageUrl,
                    processTime: new Date().toISOString(),
                    processType: 'è¥é”€å›¾ç”Ÿæˆ', // åŠŸèƒ½ç±»å‹
                    description: 'è¥é”€å›¾ç”Ÿæˆç»“æœ'
                };
                
                console.log("å‡†å¤‡å‘é€åˆ°æœåŠ¡å™¨çš„æ•°æ®:", JSON.stringify(resultData));
                
                // å‘é€åˆ°æœåŠ¡å™¨API
                const response = await fetch('/api/save-result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': localStorage.getItem('authToken') ? `Bearer ${localStorage.getItem('authToken')}` : ''
                    },
                    body: JSON.stringify(resultData)
                });
                
                if (!response.ok) {
                    console.error('æœåŠ¡å™¨å“åº”é”™è¯¯:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('é”™è¯¯è¯¦æƒ…:', errorText);
                    alert('ä¿å­˜å¤±è´¥ï¼šæœåŠ¡å™¨å“åº”é”™è¯¯ ' + response.status);
                    return false;
                }
                
                const result = await response.json();
                console.log('æœåŠ¡å™¨è¿”å›ç»“æœ:', result);
                
                if (result.success) {
                    console.log('å›¾ç‰‡ç»“æœå·²ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒ:', result);
                    return true;
                } else {
                    console.error('ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒå¤±è´¥:', result.error);
                    alert('ä¿å­˜å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                    return false;
                }
            } catch (error) {
                console.error('ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒå‡ºé”™:', error);
                alert('ä¿å­˜å‡ºé”™ï¼š' + error.message);
                return false;
            }
        }
        
        // ç›‘å¬ç¼–è¾‘å™¨æ¶ˆæ¯
        window.addEventListener("message", (ev) => {
            try {
                console.log("=== æ”¶åˆ°ç¼–è¾‘å™¨æ¶ˆæ¯ ===");
                console.log("å®Œæ•´æ¶ˆæ¯:", JSON.stringify(ev.data));
                console.log("æ¶ˆæ¯æ¥æº:", ev.origin);
                console.log("========================");
                
                // ç¡®ä¿æ¶ˆæ¯æœ‰æ•ˆ
                if (!ev.data) {
                    console.error("æ”¶åˆ°ç©ºæ¶ˆæ¯");
                    return;
                }
                
                // è§£æ„æ¶ˆæ¯æ•°æ®
                const { data, action, biz, errCode, errMessage } = ev.data;
                
                console.log("è§£æåçš„action:", action);
                console.log("è§£æåçš„data:", data);
                
                // ä¿å­˜ä¸šåŠ¡æ ‡è¯†ç”¨äºåç»­å“åº”
                if (biz) {
                    receiveBiz = biz;
                }
                
                // å¤„ç†ç”Ÿäº§æ‹¦æˆª
                if (action === 'generate') {
                    console.log('æ”¶åˆ° generateï¼Œå‡†å¤‡æ‰£è´¹');
                    // è®°å½•ä¸€æ¬¡åŠŸèƒ½ä½¿ç”¨ï¼ˆæ‰£è´¹/å…è´¹æ¬¡æ•°è®¡ç®—ï¼‰
                    // å°†åœ¨ä¸‹é¢é€šè¿‡ trackFeatureUsage è°ƒç”¨åç«¯æ¥å£
                    // é¦–æ¬¡ç”Ÿæˆæ—¶æ‰£è´¹/æ£€æŸ¥å…è´¹æ¬¡æ•°
                    trackFeatureUsage('use', 'marketing-images')
                        .then(canProceed => {
                            // å°†ç»“æœè¿”å›ç»™ SDK
                            iframeEle.contentWindow.postMessage({ biz, action: 'respond', success: canProceed }, '*');
                            if (!canProceed) {
                                alert('å…è´¹æ¬¡æ•°å·²ç”¨å®Œæˆ–ç§¯åˆ†ä¸è¶³');
                            }
                        })
                        .catch(err => {
                            console.error('æ‰£è´¹å¤±è´¥', err);
                            iframeEle.contentWindow.postMessage({ biz, action: 'respond', success: false }, '*');
                        });
                    return; // ç­‰å¾…æ‰£è´¹ç»“æœåå†ç»§ç»­
                }
                
                // æ ‡å¿—å˜é‡ï¼Œç”¨äºé˜²æ­¢é‡å¤ä¿å­˜å’Œé‡å¤æç¤º
                let saveInProgress = false;
                
                // æ£€æŸ¥æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«é€‰ä¸­å›¾ç‰‡çš„ç´¢å¼•ä¿¡æ¯
                if (ev.data && ev.data.selectedIndex !== undefined) {
                    selectedImageIndex = ev.data.selectedIndex;
                    console.log("æ£€æµ‹åˆ°é€‰ä¸­å›¾ç‰‡ç´¢å¼•:", selectedImageIndex);
                }
                
                // ä»æ•°ç»„ä¸­è·å–é€‰ä¸­çš„å›¾ç‰‡
                function getSelectedImage(imageArray) {
                    if (!Array.isArray(imageArray) || imageArray.length === 0) {
                        return null;
                    }
                    
                    // ç¡®ä¿é€‰ä¸­ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
                    if (selectedImageIndex >= 0 && selectedImageIndex < imageArray.length) {
                        return imageArray[selectedImageIndex];
                    }
                    
                    // é»˜è®¤è¿”å›ç¬¬ä¸€å¼ å›¾ç‰‡
                    return imageArray[0];
                }
                
                // ç»Ÿä¸€å¤„ç†å›¾ç‰‡ä¿å­˜å‡½æ•° - ä¿®æ”¹ä¸ºåªä¿å­˜å½“å‰é€‰ä¸­çš„å›¾ç‰‡
                const handleImageSave = async (imageData) => {
                    // å¦‚æœå·²ç»åœ¨ä¿å­˜è¿‡ç¨‹ä¸­ï¼Œä¸å†è§¦å‘æ–°çš„ä¿å­˜
                    if (saveInProgress) {
                        console.log("ä¿å­˜å·²åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤ä¿å­˜");
                        return;
                    }
                    
                    saveInProgress = true;
                    console.log("å¼€å§‹å¤„ç†å›¾ç‰‡ä¿å­˜:", JSON.stringify(imageData));
                    
                    try {
                        // å¦‚æœæ˜¯æ•°ç»„ï¼Œåªå¤„ç†å½“å‰é€‰ä¸­çš„å›¾ç‰‡
                        let dataToSave = imageData;
                        if (Array.isArray(imageData) && imageData.length > 0) {
                            dataToSave = getSelectedImage(imageData);
                            console.log("ä»æ•°ç»„ä¸­é€‰æ‹©äº†ç´¢å¼•", selectedImageIndex, "çš„å›¾ç‰‡è¿›è¡Œä¿å­˜");
                        }
                        
                        if (!dataToSave) {
                            console.error("æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„å›¾ç‰‡æ•°æ®è¿›è¡Œä¿å­˜");
                            alert("ä¿å­˜å¤±è´¥ï¼šæ²¡æœ‰é€‰ä¸­æœ‰æ•ˆçš„å›¾ç‰‡");
                            saveInProgress = false;
                            return;
                        }
                        
                        const success = await saveImageResult(dataToSave);
                        if (success) {
                            console.log('å›¾ç‰‡å·²æˆåŠŸä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒ');
                            alert('å›¾ç‰‡å·²æˆåŠŸä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒ!');
                        } else {
                            console.error('ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒå¤±è´¥');
                        }
                    } catch (error) {
                        console.error('ä¿å­˜è¿‡ç¨‹å‡ºé”™:', error);
                    } finally {
                        // é‡ç½®ä¿å­˜çŠ¶æ€
                        saveInProgress = false;
                    }
                };
                
                if (action === "pageReady") {
                    console.log("ç¼–è¾‘å™¨é¡µé¢å·²å‡†å¤‡å°±ç»ª");
                } else if (action === "taskSuccess") {
                    console.log(`ä¸šåŠ¡[${biz}]å¤„ç†ä»»åŠ¡å®Œæˆ:`, data);
                    
                    // åœ¨ä»»åŠ¡æˆåŠŸæ—¶ä¸è‡ªåŠ¨ä¿å­˜ï¼Œç­‰å¾…ç”¨æˆ·æ˜ç¡®çš„ä¿å­˜æ“ä½œ
                    console.log("ä»»åŠ¡æˆåŠŸï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©ä¿å­˜");
                } else if (action === "submitAll") {
                    console.log("æ”¶åˆ°submitAlläº‹ä»¶:", JSON.stringify(data));
                    
                    // ä¸è‡ªåŠ¨ä¿å­˜ï¼Œè®©ç”¨æˆ·ä¸»åŠ¨é€‰æ‹©ä¿å­˜
                    console.log("submitAlläº‹ä»¶ä¸è‡ªåŠ¨ä¿å­˜ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨ä¿å­˜");
                } else if (action === "submit") {
                    console.log("=== è§¦å‘ä¿å­˜æ“ä½œ ===");
                    console.log("ç”¨æˆ·ç‚¹å‡»äº†ä¿å­˜æŒ‰é’®:", JSON.stringify(data));
                    console.log("å³å°†è°ƒç”¨ handleImageSave");
                    console.log("==================");
                    // å¤„ç†ä¿å­˜æ“ä½œ - åªä¿å­˜å½“å‰é€‰æ‹©çš„å›¾ç‰‡
                    if (data) {
                        handleImageSave(data);
                    } else {
                        console.error("ä¿å­˜å¤±è´¥ï¼šæœªæ”¶åˆ°æœ‰æ•ˆçš„å›¾ç‰‡æ•°æ®");
                        alert("ä¿å­˜å¤±è´¥ï¼šæœªæ”¶åˆ°æœ‰æ•ˆçš„å›¾ç‰‡æ•°æ®");
                    }
                } else if (action === "download") {
                    console.log("=== è§¦å‘ä¸‹è½½æ“ä½œ ===");
                    console.log("ç”¨æˆ·ç‚¹å‡»äº†ä¸‹è½½æŒ‰é’®:", JSON.stringify(data));
                    console.log("æ³¨æ„ï¼šæ­¤æ“ä½œä¸ä¼šè‡ªåŠ¨ä¿å­˜");
                    console.log("==================");
                    
                    // æ˜¾ç¤ºç”¨æˆ·æç¤º
                    const tip = document.getElementById('user-tip');
                    if (tip) {
                        tip.style.display = 'block';
                        setTimeout(() => {
                            tip.style.display = 'none';
                        }, 3000);
                    }
                    
                    // å¤„ç†ä¸‹è½½æ“ä½œ - åªå¤„ç†å½“å‰é€‰æ‹©çš„å›¾ç‰‡ä¸‹è½½ï¼Œä¸è‡ªåŠ¨ä¿å­˜
                    if (data) {
                        let downloadUrl = null;
                        
                        if (Array.isArray(data)) {
                            const selectedImage = getSelectedImage(data);
                            if (selectedImage) {
                                if (selectedImage.url) {
                                    downloadUrl = selectedImage.url;
                                }
                            }
                        } else if (data.url) {
                            downloadUrl = data.url;
                        }
                        
                        if (downloadUrl) {
                            downloadImage(downloadUrl, `marketing-image-${Date.now()}.png`);
                            console.log("å›¾ç‰‡ä¸‹è½½å®Œæˆï¼Œæœªè‡ªåŠ¨ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒ");
                        } else {
                            console.error("ä¸‹è½½å¤±è´¥ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„å›¾ç‰‡URL");
                        }
                    } else {
                        console.error("ä¸‹è½½å¤±è´¥ï¼šæœªæ”¶åˆ°æœ‰æ•ˆçš„å›¾ç‰‡æ•°æ®");
                    }
                } else if (action === "selectImage" || action === "select") {
                    // å¤„ç†å›¾ç‰‡é€‰æ‹©äº‹ä»¶ï¼Œæ›´æ–°å½“å‰é€‰ä¸­çš„å›¾ç‰‡ç´¢å¼•
                    console.log("ç”¨æˆ·é€‰æ‹©äº†æ–°çš„å›¾ç‰‡:", JSON.stringify(data));
                    if (data && data.index !== undefined) {
                        selectedImageIndex = data.index;
                        console.log("å½“å‰é€‰ä¸­å›¾ç‰‡ç´¢å¼•æ›´æ–°ä¸º:", selectedImageIndex);
                    }
                } else if (action === "error") {
                    // é”™è¯¯å¤„ç†
                    console.error("ç¼–è¾‘å™¨é”™è¯¯:", errCode, errMessage);
                    if (errCode) {
                        // æ ¹æ®APIæ–‡æ¡£ä¸­çš„é”™è¯¯ç è¿›è¡Œå¤„ç†
                        switch(errCode) {
                            case 'createGenerateImageTask':
                                console.error("åˆ›å»ºç”Ÿå›¾ä»»åŠ¡å¤±è´¥");
                                break;
                            case 'generateImageError':
                                console.error("ç”Ÿå›¾å¤±è´¥");
                                break;
                            case 'generateImageResult':
                                console.error("ç”Ÿå›¾ç»“æœä¸ºç©º");
                                break;
                            case 'marketing-image-cutout-failed':
                                console.error("æŠ å›¾å¤±è´¥");
                                break;
                            default:
                                console.error("æœªçŸ¥é”™è¯¯:", errCode, errMessage || "");
                        }
                    }
                } else {
                    // å¤„ç†æœªçŸ¥çš„æ¶ˆæ¯ç±»å‹
                    console.log("æ”¶åˆ°æœªçŸ¥ç±»å‹çš„æ¶ˆæ¯:", action, "å®Œæ•´æ¶ˆæ¯:", JSON.stringify(ev.data));
                    // å¯¹äºæœªçŸ¥ç±»å‹çš„æ¶ˆæ¯ï¼Œä¸è‡ªåŠ¨ä¿å­˜ï¼Œé¿å…æ„å¤–çš„å¤šæ¬¡ä¿å­˜
                    console.log("æœªçŸ¥æ¶ˆæ¯ç±»å‹ï¼Œä¸æ‰§è¡Œä»»ä½•è‡ªåŠ¨æ“ä½œ");
                }
            } catch (error) {
                console.error('å¤„ç†æ¶ˆæ¯å‡ºé”™:', error);
            }
        });
        
        // é¡µé¢åŠ è½½ä»…åˆå§‹åŒ–ï¼Œä¸æ‰£è´¹
        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();
        });
    </script>
</body>
</html> 