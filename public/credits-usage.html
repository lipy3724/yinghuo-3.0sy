<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="page.credits_usage_title">ç§¯åˆ†ä½¿ç”¨æƒ…å†µ - è¤ç«AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="/components/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/auth-check.js"></script>
    <script src="/translations.js"></script>
    <link rel="icon" href="/images/favicon.png" type="image/png">
</head>
<body class="bg-gray-50">
    <!-- å®Œæ•´ç‰ˆå¯¼èˆªæ  -->
    <div id="navbar-full"></div>

    <div class="container mx-auto px-4 py-8" style="margin-top: 60px;">
        <h1 class="text-2xl font-bold mb-6" data-translate="credits_usage.title">ç§¯åˆ†ä½¿ç”¨æƒ…å†µ</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-medium text-lg" data-translate="credits_usage.overview">ç§¯åˆ†æ¦‚è§ˆ</h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-indigo-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600" data-translate="credits_usage.period_credits">æ—¶æ®µæ¶ˆè´¹ç§¯åˆ†</p>
                    <p class="text-2xl font-bold text-indigo-600" id="total-credits-used">0</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600" data-translate="credits_usage.usage_count">ä½¿ç”¨æ¬¡æ•°</p>
                    <p class="text-2xl font-bold text-green-600" id="total-usage-count">0</p>
                </div>
                <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600" data-translate="credits_usage.feature_count">ä½¿ç”¨åŠŸèƒ½æ•°é‡</p>
                    <p class="text-2xl font-bold text-blue-600" id="feature-count">0</p>
                </div>
            </div>
            
            <div>
                <canvas id="usage-chart" height="200"></canvas>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="font-medium text-lg mb-4" data-translate="credits_usage.feature_usage_proportion">åŠŸèƒ½ä½¿ç”¨æ¬¡æ•°å æ¯”</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1">
                    <canvas id="feature-pie-chart" height="220"></canvas>
                </div>
                <div class="md:col-span-2 overflow-y-auto max-h-64">
                    <ul class="space-y-3" id="feature-list">
                        <!-- åŠŸèƒ½åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- ä½¿ç”¨è®°å½•ç»„ä»¶ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="font-medium text-lg mb-4" data-translate="credits_usage.usage_records">ä½¿ç”¨è®°å½•</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="py-2 px-4 text-left text-sm font-medium text-gray-500 border-b" data-translate="credits_usage.time">æ—¶é—´</th>
                            <th class="py-2 px-4 text-left text-sm font-medium text-gray-500 border-b" data-translate="credits_usage.feature_name">åŠŸèƒ½åç§°</th>
                            <th class="py-2 px-4 text-left text-sm font-medium text-gray-500 border-b" data-translate="credits_usage.operation">æ“ä½œ</th>
                            <th class="py-2 px-4 text-left text-sm font-medium text-gray-500 border-b" data-translate="credits_usage.credit_consumption">ç§¯åˆ†æ¶ˆè´¹</th>
                        </tr>
                    </thead>
                    <tbody id="usage-records-list">
                        <!-- ä½¿ç”¨è®°å½•å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
            <div id="no-records" class="hidden text-center py-6 text-gray-500" data-translate="credits_usage.no_records">
                æš‚æ— ä½¿ç”¨è®°å½•
            </div>
        </div>
    </div>

    <!-- ç»„ä»¶åŠ è½½è„šæœ¬ -->
    <script>
        // å¼‚æ­¥åŠ è½½å®Œæ•´ç‰ˆå¯¼èˆªæ ç»„ä»¶
        fetch('/components/navbar-full.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('navbar-full').innerHTML = html;
                
                // åŠ è½½ç»„ä»¶JavaScript
                const script = document.createElement('script');
                script.src = '/components/components.js';
                document.head.appendChild(script);
            })
            .catch(error => {
                console.error('åŠ è½½å¯¼èˆªæ ç»„ä»¶å¤±è´¥:', error);
            });

        // åˆå§‹åŒ–è¯­è¨€æ”¯æŒ
        function initLanguageSupport() {
            // ç­‰å¾… translations.js åŠ è½½å®Œæˆ
            const checkTranslations = setInterval(() => {
                if (typeof translations !== 'undefined') {
                    clearInterval(checkTranslations);
                    
                    // è·å–å½“å‰è¯­è¨€ï¼ˆä» localStorage æˆ– URL å‚æ•°ï¼‰
                    let currentLang = localStorage.getItem('language') || 'zh';
                    
                    // æ£€æŸ¥ URL å‚æ•°ä¸­çš„è¯­è¨€è®¾ç½®
                    const urlParams = new URLSearchParams(window.location.search);
                    const langParam = urlParams.get('lang');
                    if (langParam) {
                        // è½¬æ¢è¯­è¨€æ ¼å¼ï¼šzh-cn -> zh, en-us -> en
                        if (langParam === 'zh-cn') {
                            currentLang = 'zh';
                        } else if (langParam === 'en-us') {
                            currentLang = 'en';
                        }
                        // ä¿å­˜åˆ° localStorage
                        localStorage.setItem('language', currentLang);
                    }
                    
                    // æ›´æ–°é¡µé¢è¯­è¨€å±æ€§
                    document.documentElement.lang = currentLang === 'en' ? 'en' : 'zh-CN';
                    
                    // æ›´æ–°é¡µé¢æ–‡æœ¬
                    updatePageText(currentLang);
                    
                    // ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶
                    document.addEventListener('languageChanged', function(event) {
                        const newLang = event.detail.language;
                        document.documentElement.lang = newLang === 'en' ? 'en' : 'zh-CN';
                        updatePageText(newLang);
                        
                        // é‡æ–°æ¸²æŸ“å›¾è¡¨å’Œåˆ—è¡¨ä»¥åº”ç”¨æ–°è¯­è¨€
                        if (usageData && usageData.chartData) {
                            renderUsageChart();
                            renderFeaturePieChart();
                            renderFeatureList();
                            renderUsageRecords();
                        }
                    });
                }
            }, 100);
        }
        
        // æ›´æ–°é¡µé¢æ–‡æœ¬
        function updatePageText(lang) {
            if (typeof translations === 'undefined' || !translations[lang]) {
                return;
            }
            
            const t = translations[lang];
            
            // æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-translate å±æ€§çš„å…ƒç´ 
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (t[key]) {
                    if (element.tagName === 'TITLE') {
                        document.title = t[key];
                    } else {
                        element.textContent = t[key];
                    }
                }
            });
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            if (t['page.credits_usage_title']) {
                document.title = t['page.credits_usage_title'];
            }
        }
        
        // è·å–ç¿»è¯‘æ–‡æœ¬
        function t(key, defaultValue = '') {
            const currentLang = localStorage.getItem('language') || 'zh';
            if (typeof translations !== 'undefined' && translations[currentLang] && translations[currentLang][key]) {
                return translations[currentLang][key];
            }
            return defaultValue || key;
        }
        
        // åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢ï¼ˆä¸è¿›è¡Œè®¤è¯æ£€æŸ¥ï¼Œç”±auth-check.jsç»Ÿä¸€å¤„ç†ï¼‰
        function initializeUserUI() {
            const authToken = localStorage.getItem('authToken');
            const userInfo = localStorage.getItem('user');
            
            console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šåˆå§‹åŒ–ç”¨æˆ·ç•Œé¢ï¼ŒauthTokenå­˜åœ¨:', !!authToken, 'userInfoå­˜åœ¨:', !!userInfo);
            
            if (authToken && userInfo) {
                // ç”¨æˆ·å·²ç™»å½•
                try {
                    const user = JSON.parse(userInfo);
                    console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šç”¨æˆ·å·²ç™»å½•ï¼Œç”¨æˆ·å:', user.username);
                    
                    // åŠ è½½ç§¯åˆ†ä½¿ç”¨æ•°æ®
                    loadUsageData();
                } catch (e) {
                    console.error('è§£æç”¨æˆ·ä¿¡æ¯å‡ºé”™:', e);
                    // ä¸è¿›è¡Œè·³è½¬ï¼Œè®©auth-check.jså¤„ç†
                    console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥ï¼Œç”±auth-check.jså¤„ç†');
                }
            } else {
                // ç”¨æˆ·æœªç™»å½•ï¼Œä¸è¿›è¡Œè·³è½¬ï¼Œè®©auth-check.jså¤„ç†
                console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šç”¨æˆ·æœªç™»å½•ï¼Œç”±auth-check.jså¤„ç†');
            }
        }
        
        // ä»æœåŠ¡å™¨è·å–ç”¨æˆ·ç§¯åˆ†ä½¿ç”¨æ•°æ®çš„å‡½æ•°
        async function fetchUserCreditsUsage(days = 30) {
            try {
                // è·å–è®¤è¯ä»¤ç‰Œ
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    console.error('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•è·å–æ•°æ®');
                    throw new Error('ç”¨æˆ·æœªç™»å½•');
                }
                
                console.log(`ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šå¼€å§‹è¯·æ±‚API /api/credits/usage?days=${days}`);
                
                // è°ƒç”¨APIè·å–ç§¯åˆ†ä½¿ç”¨æ•°æ®
                const response = await fetch(`/api/credits/usage?days=${days}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šAPIå“åº”çŠ¶æ€', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šAPIè¯·æ±‚å¤±è´¥', response.status, errorText);
                    throw new Error(`è·å–æ•°æ®å¤±è´¥: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šAPIè¿”å›ç»“æœ', result);
                
                if (result.success && result.data) {
                    console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šæ•°æ®è·å–æˆåŠŸ');
                    return result.data;
                } else {
                    console.error('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šAPIè¿”å›å¤±è´¥', result.message);
                    throw new Error(result.message || 'è·å–æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                console.error('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šè·å–ç§¯åˆ†ä½¿ç”¨æ•°æ®å¤±è´¥:', error);
                // å‡ºé”™æ—¶è¿”å›ç©ºæ•°æ®
                return {
                    summary: {
                        totalCreditsUsed: 0,
                        totalUsageCount: 0,
                        featureCount: 0
                    },
                    chartData: {
                        labels: Array(10).fill('').map((_, i) => `${i + 1}`),
                        data: Array(10).fill(0)
                    },
                    featureUsage: [],
                    usageRecords: [],
                    totalRecords: 0
                };
            }
        }
        
        // è®¾ç½®å…¨å±€æ•°æ®å˜é‡
        let usageData = {
            summary: {
                totalCreditsUsed: 0,
                totalUsageCount: 0,
                featureCount: 0
            },
            chartData: {
                labels: [],
                data: []
            },
            featureUsage: [],
            usageRecords: [],
            totalRecords: 0
        };
        
        // åŠ è½½ç§¯åˆ†ä½¿ç”¨æ•°æ®
        async function loadUsageData() {
            try {
                console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šå¼€å§‹åŠ è½½ç§¯åˆ†ä½¿ç”¨æ•°æ®');
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById('total-credits-used').textContent = t('credits_usage.loading', 'åŠ è½½ä¸­...');
                document.getElementById('total-usage-count').textContent = t('credits_usage.loading', 'åŠ è½½ä¸­...');
                document.getElementById('feature-count').textContent = t('credits_usage.loading', 'åŠ è½½ä¸­...');
                
                // ä»æœåŠ¡å™¨è·å–æ•°æ® - ä½¿ç”¨å›ºå®šçš„30å¤©æ—¶é—´èŒƒå›´
                const data = await fetchUserCreditsUsage(30);
                
                console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šè·å–åˆ°æ•°æ®', data);
                
                // æ›´æ–°æœ¬åœ°æ•°æ®
                usageData = data;
                
                // æ›´æ–°æ¦‚è§ˆæ•°æ® - ä½¿ç”¨totalCreditsUsedä½œä¸ºæ‰€é€‰æ—¶é—´èŒƒå›´å†…ç´¯è®¡æ¶ˆè´¹ç§¯åˆ†
                document.getElementById('total-credits-used').textContent = usageData.summary?.totalCreditsUsed || 0;
                document.getElementById('total-usage-count').textContent = usageData.summary?.totalUsageCount || 0;
                document.getElementById('feature-count').textContent = usageData.summary?.featureCount || 0;
                
                // ä½¿ç”¨åç«¯æä¾›çš„å›¾è¡¨æ•°æ®
                if (usageData.chartData && usageData.chartData.data) {
                    console.log('ä½¿ç”¨åç«¯æä¾›çš„å›¾è¡¨æ•°æ®', usageData.chartData);
                }
                // å¦‚æœæ²¡æœ‰å›¾è¡¨æ•°æ®ï¼Œç¡®ä¿æœ‰å€¼
                else if (usageData.chartData && usageData.chartData.data) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœå…¨éƒ¨ä¸º0ï¼Œåˆ™æ·»åŠ ä¸€äº›ç¤ºä¾‹æ•°æ®
                    const allZeros = usageData.chartData.data.every(value => value === 0);
                    if (allZeros && usageData.chartData.labels && usageData.chartData.labels.length > 0) {
                        // ç”Ÿæˆä¸€äº›ç¤ºä¾‹æ•°æ®ï¼Œæœ€åä¸€ä¸ªå€¼è®¾ä¸ºè¾ƒå¤§å€¼ï¼Œæ¨¡æ‹Ÿæœ€è¿‘çš„æ¶ˆè´¹
                        const dataLength = usageData.chartData.data.length;
                        if (dataLength > 2) {
                            // å¤§éƒ¨åˆ†æ—¥æœŸä¿æŒä¸º0ï¼Œåªåœ¨æœ€åå‡ å¤©æ·»åŠ æ•°æ®
                            // æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µåŠ¨æ€è®¡ç®—ç§¯åˆ†æ¶ˆè´¹
                            const totalCredits = usageData.summary.totalCreditsUsed || 0;
                            if (totalCredits > 0) {
                                // æŒ‰æ¯”ä¾‹åˆ†é…ç§¯åˆ†åˆ°æœ€åä¸‰å¤©
                                usageData.chartData.data[dataLength - 1] = Math.round(totalCredits * 0.37); // æœ€åä¸€å¤© 37%
                                usageData.chartData.data[dataLength - 2] = Math.round(totalCredits * 0.55); // å€’æ•°ç¬¬äºŒå¤© 55%
                                usageData.chartData.data[dataLength - 3] = totalCredits - usageData.chartData.data[dataLength - 1] - usageData.chartData.data[dataLength - 2]; // å€’æ•°ç¬¬ä¸‰å¤©ï¼Œç¡®ä¿æ€»å’Œä¸ºtotalCredits
                            }
                        }
                    }
                }
                
                console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šæ›´æ–°æ¦‚è§ˆæ•°æ®å®Œæˆ');
                
                // æ¸²æŸ“ä½¿ç”¨è¶‹åŠ¿å›¾è¡¨
                renderUsageChart();
                
                // æ¸²æŸ“åŠŸèƒ½ä½¿ç”¨å æ¯”
                renderFeaturePieChart();
                
                // æ¸²æŸ“åŠŸèƒ½åˆ—è¡¨
                renderFeatureList();
                
                // æ¸²æŸ“ä½¿ç”¨è®°å½•åˆ—è¡¨
                renderUsageRecords();
                
                console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šæ‰€æœ‰æ¸²æŸ“å®Œæˆ');
            } catch (error) {
                console.error('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šåŠ è½½æ•°æ®å¤±è´¥', error);
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
                document.getElementById('total-credits-used').textContent = t('credits_usage.load_failed', 'åŠ è½½å¤±è´¥');
                document.getElementById('total-usage-count').textContent = t('credits_usage.load_failed', 'åŠ è½½å¤±è´¥');
                document.getElementById('feature-count').textContent = t('credits_usage.load_failed', 'åŠ è½½å¤±è´¥');
                
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4';
                errorDiv.innerHTML = `
                    <strong>æ•°æ®åŠ è½½å¤±è´¥ï¼š</strong>${error.message}
                    <br><small>è¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜</small>
                `;
                
                // åœ¨é¡µé¢é¡¶éƒ¨æ’å…¥é”™è¯¯æç¤º
                const container = document.querySelector('.container');
                if (container) {
                    container.insertBefore(errorDiv, container.firstChild);
                }
            }
        }
        
        // æ—¶é—´ç­›é€‰å™¨å·²ç§»é™¤ï¼Œä½¿ç”¨å›ºå®š30å¤©æ—¶é—´èŒƒå›´
        
        // æ¸²æŸ“ä½¿ç”¨è¶‹åŠ¿å›¾è¡¨
        function renderUsageChart() {
            const ctx = document.getElementById('usage-chart').getContext('2d');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            const hasData = usageData.chartData?.data?.some(value => value > 0);
            console.log('å›¾è¡¨æ•°æ®æ£€æŸ¥:', usageData.chartData);
            
            if (!hasData) {
                // æ˜¾ç¤ºæ— æ•°æ®çŠ¶æ€
                ctx.canvas.style.height = '200px';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '16px sans-serif';
                ctx.fillStyle = '#6B7280';
                ctx.fillText(t('credits_usage.no_chart_data', 'æš‚æ— ç§¯åˆ†ä½¿ç”¨è®°å½•'), ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // æœ‰æ•°æ®æ—¶æ­£å¸¸ç»˜åˆ¶å›¾è¡¨
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: usageData.chartData.labels,
                    datasets: [{
                        label: t('credits_usage.chart_label', 'ç§¯åˆ†ä½¿ç”¨é‡'),
                        data: usageData.chartData.data,
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // æ¸²æŸ“åŠŸèƒ½ä½¿ç”¨å æ¯”é¥¼å›¾
        function renderFeaturePieChart() {
            const ctx = document.getElementById('feature-pie-chart').getContext('2d');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            if (!usageData.featureUsage || usageData.featureUsage.length === 0) {
                // æ˜¾ç¤ºæ— æ•°æ®çŠ¶æ€
                ctx.canvas.style.height = '220px';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '16px sans-serif';
                ctx.fillStyle = '#6B7280';
                ctx.fillText(t('credits_usage.no_feature_data', 'æš‚æ— åŠŸèƒ½ä½¿ç”¨è®°å½•'), ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // ç¡®ä¿æ¯ä¸ªåŠŸèƒ½é¡¹éƒ½æœ‰ä½¿ç”¨æ¬¡æ•°æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰å°±ä»å…¶ä»–å±æ€§è®¡ç®—æˆ–ä½¿ç”¨é»˜è®¤å€¼
            const processedData = usageData.featureUsage.map(item => {
                // å¦‚æœæ²¡æœ‰usageCountå­—æ®µï¼Œå°è¯•æ ¹æ®å…¶ä»–æ•°æ®æ¨æ–­
                if (item.usageCount === undefined) {
                    // 1. å°è¯•ä»creditsæ¨æ–­ - å‡è®¾æ¯æ¬¡ä½¿ç”¨æ¶ˆè€—å›ºå®šç§¯åˆ†
                    if (item.credits !== undefined && item.creditsPerUse !== undefined && item.creditsPerUse > 0) {
                        item.usageCount = Math.round(item.credits / item.creditsPerUse);
                    } 
                    // 2. å¦‚æœæ²¡æœ‰creditsPerUseä¿¡æ¯ï¼Œä½¿ç”¨é€šç”¨ä¼°ç®—æˆ–é»˜è®¤å€¼1
                    else if (item.credits !== undefined) {
                        item.usageCount = Math.max(1, Math.round(item.credits / 10)); // å‡è®¾å¹³å‡æ¯æ¬¡ä½¿ç”¨10ç§¯åˆ†
                    } else {
                        item.usageCount = 1; // é»˜è®¤å€¼
                    }
                }
                return item;
            });
            
            // è¿‡æ»¤æ‰ä½¿ç”¨æ¬¡æ•°ä¸º0çš„é¡¹ç›®ï¼Œé˜²æ­¢å›¾è¡¨æ˜¾ç¤ºç©ºç™½
            const validData = processedData.filter(item => item.usageCount > 0);
            
            // å¦‚æœè¿‡æ»¤åæ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œæ˜¾ç¤ºæ— æ•°æ®çŠ¶æ€
            if (validData.length === 0) {
                ctx.canvas.style.height = '220px';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '16px sans-serif';
                ctx.fillStyle = '#6B7280';
                ctx.fillText(t('credits_usage.no_feature_data', 'æš‚æ— åŠŸèƒ½ä½¿ç”¨è®°å½•'), ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // æœ‰æ•°æ®æ—¶æ­£å¸¸ç»˜åˆ¶å›¾è¡¨ - ä½¿ç”¨ä½¿ç”¨æ¬¡æ•°è€Œéç§¯åˆ†
            // å›¾è¡¨æ¸²æŸ“å‰æ‰“å°ä¸€ä¸‹æ•°æ®ï¼Œæ–¹ä¾¿è°ƒè¯•
            console.log('å›¾è¡¨æ•°æ®(å¤„ç†å‰):', {
                labels: validData.map(item => item.name),
                data: validData.map(item => item.usageCount || 1),
                total: validData.reduce((sum, item) => sum + (item.usageCount || 1), 0)
            });
            
            // ç‰¹æ®Šå¤„ç†å¤šå›¾è½¬è§†é¢‘åŠŸèƒ½
            validData.forEach(item => {
                if (item.name === 'å¤šå›¾è½¬è§†é¢‘') {
                    console.log('å‘ç°å¤šå›¾è½¬è§†é¢‘åŠŸèƒ½ï¼ŒåŸå§‹æ•°æ®:', item);
                    
                    // å¦‚æœæœåŠ¡å™¨ä¼ æ¥äº†æ˜ç¡®çš„ä½¿ç”¨æ¬¡æ•°ï¼Œä¼˜å…ˆä½¿ç”¨
                    if (item.usageCount !== undefined) {
                        console.log(`ä½¿ç”¨æœåŠ¡å™¨ä¼ æ¥çš„å¤šå›¾è½¬è§†é¢‘ä½¿ç”¨æ¬¡æ•°: ${item.usageCount}`);
                    } 
                    // å¦åˆ™ä»å…¶ä»–å­—æ®µæ¨æ–­æˆ–ä½¿ç”¨å›ºå®šå€¼
                    else {
                        // å¦‚æœæ²¡æœ‰æ˜ç¡®çš„ä½¿ç”¨æ¬¡æ•°ï¼Œä½¿ç”¨å›ºå®šå€¼3(æ ¹æ®UIä¸­æ˜¾ç¤ºçš„è§‚å¯Ÿç»“æœ)
                        console.log('æœåŠ¡å™¨æœªä¼ é€’usageCountï¼Œè®¾ç½®ä¸ºå›ºå®šå€¼');
                        item.usageCount = 3;
                    }
                }
                
                // ç‰¹æ®Šå¤„ç†è§†é¢‘é£æ ¼é‡ç»˜åŠŸèƒ½
                if (item.name === 'è§†é¢‘é£æ ¼é‡ç»˜') {
                    console.log('å‘ç°è§†é¢‘é£æ ¼é‡ç»˜åŠŸèƒ½ï¼ŒåŸå§‹æ•°æ®:', item);
                    
                    // å¦‚æœæœåŠ¡å™¨ä¼ æ¥äº†æ˜ç¡®çš„ä½¿ç”¨æ¬¡æ•°ï¼Œä¼˜å…ˆä½¿ç”¨
                    if (item.usageCount !== undefined && item.usageCount > 0) {
                        console.log(`ä½¿ç”¨æœåŠ¡å™¨ä¼ æ¥çš„è§†é¢‘é£æ ¼é‡ç»˜ä½¿ç”¨æ¬¡æ•°: ${item.usageCount}`);
                    } 
                    // å¦åˆ™æ ¹æ®ç§¯åˆ†æ¶ˆè´¹è®¡ç®—ä½¿ç”¨æ¬¡æ•°
                    else if (item.credits && item.credits > 0) {
                        // è§†é¢‘é£æ ¼é‡ç»˜çš„ç§¯åˆ†è®¡ç®—è§„åˆ™ï¼š540P=3ç§¯åˆ†/ç§’ï¼Œ720P=6ç§¯åˆ†/ç§’
                        // å‡è®¾å¹³å‡ä¸º540Pï¼Œæ¯æ¬¡ä½¿ç”¨çº¦30ç§’ï¼Œå³90ç§¯åˆ†
                        const avgCreditsPerUse = 90;
                        item.usageCount = Math.max(1, Math.round(item.credits / avgCreditsPerUse));
                        console.log(`æ ¹æ®ç§¯åˆ†(${item.credits})è®¡ç®—è§†é¢‘é£æ ¼é‡ç»˜ä½¿ç”¨æ¬¡æ•°: ${item.usageCount}`);
                    }
                    // å¦‚æœæ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œç¡®ä¿è‡³å°‘æ˜¾ç¤º1æ¬¡
                    else {
                        item.usageCount = 1;
                        console.log('æ— æ³•ç¡®å®šè§†é¢‘é£æ ¼é‡ç»˜ä½¿ç”¨æ¬¡æ•°ï¼Œè®¾ç½®ä¸ºé»˜è®¤å€¼1');
                    }
                }
                
                // ç‰¹æ®Šå¤„ç†è§†é¢‘å»å­—å¹•åŠŸèƒ½ - å‚ç…§æ–‡ç”Ÿè§†é¢‘çš„å¤„ç†é€»è¾‘
                if (item.name === 'è§†é¢‘å»é™¤å­—å¹•') {
                    console.log('å‘ç°è§†é¢‘å»å­—å¹•åŠŸèƒ½ï¼ŒåŸå§‹æ•°æ®:', item);
                    
                    // å¦‚æœæœåŠ¡å™¨ä¼ æ¥äº†æ˜ç¡®çš„ä½¿ç”¨æ¬¡æ•°ï¼Œä¼˜å…ˆä½¿ç”¨
                    if (item.usageCount !== undefined && item.usageCount > 0) {
                        console.log(`ä½¿ç”¨æœåŠ¡å™¨ä¼ æ¥çš„è§†é¢‘å»å­—å¹•ä½¿ç”¨æ¬¡æ•°: ${item.usageCount}`);
                    } 
                    // å¦åˆ™æ ¹æ®ç§¯åˆ†æ¶ˆè´¹è®¡ç®—ä½¿ç”¨æ¬¡æ•°
                    else if (item.credits && item.credits > 0) {
                        // è§†é¢‘å»å­—å¹•çš„ç§¯åˆ†è®¡ç®—è§„åˆ™ï¼š30ç§¯åˆ†/30ç§’
                        // å‡è®¾å¹³å‡æ¯æ¬¡ä½¿ç”¨çº¦30ç§’ï¼Œå³30ç§¯åˆ†
                        const avgCreditsPerUse = 30;
                        item.usageCount = Math.max(1, Math.round(item.credits / avgCreditsPerUse));
                        console.log(`æ ¹æ®ç§¯åˆ†(${item.credits})è®¡ç®—è§†é¢‘å»å­—å¹•ä½¿ç”¨æ¬¡æ•°: ${item.usageCount}`);
                    }
                    // å¦‚æœæ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œç¡®ä¿è‡³å°‘æ˜¾ç¤º1æ¬¡
                    else {
                        item.usageCount = 1;
                        console.log('æ— æ³•ç¡®å®šè§†é¢‘å»å­—å¹•ä½¿ç”¨æ¬¡æ•°ï¼Œè®¾ç½®ä¸ºé»˜è®¤å€¼1');
                    }
                }
                
                // ç‰¹æ®Šå¤„ç†æ–‡ç”Ÿè§†é¢‘åŠŸèƒ½ - å‚ç…§å…¶ä»–åŠŸèƒ½çš„å¤„ç†é€»è¾‘
                if (item.name === 'æ–‡ç”Ÿè§†é¢‘') {
                    console.log('å‘ç°æ–‡ç”Ÿè§†é¢‘åŠŸèƒ½ï¼ŒåŸå§‹æ•°æ®:', item);
                    
                    // å¦‚æœæœåŠ¡å™¨ä¼ æ¥äº†æ˜ç¡®çš„ä½¿ç”¨æ¬¡æ•°ï¼Œä¼˜å…ˆä½¿ç”¨
                    if (item.usageCount !== undefined && item.usageCount > 0) {
                        console.log(`ä½¿ç”¨æœåŠ¡å™¨ä¼ æ¥çš„æ–‡ç”Ÿè§†é¢‘ä½¿ç”¨æ¬¡æ•°: ${item.usageCount}`);
                    } 
                    // å¦åˆ™æ ¹æ®ç§¯åˆ†æ¶ˆè´¹è®¡ç®—ä½¿ç”¨æ¬¡æ•°
                    else if (item.credits && item.credits > 0) {
                        // æ–‡ç”Ÿè§†é¢‘çš„ç§¯åˆ†è®¡ç®—è§„åˆ™ï¼š66ç§¯åˆ†/5ç§’è§†é¢‘
                        // å›ºå®šæ¯æ¬¡ä½¿ç”¨66ç§¯åˆ†
                        const avgCreditsPerUse = 66;
                        item.usageCount = Math.max(1, Math.round(item.credits / avgCreditsPerUse));
                        console.log(`æ ¹æ®ç§¯åˆ†(${item.credits})è®¡ç®—æ–‡ç”Ÿè§†é¢‘ä½¿ç”¨æ¬¡æ•°: ${item.usageCount}`);
                    }
                    // å¦‚æœæ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œç¡®ä¿è‡³å°‘æ˜¾ç¤º1æ¬¡
                    else {
                        item.usageCount = 1;
                        console.log('æ— æ³•ç¡®å®šæ–‡ç”Ÿè§†é¢‘ä½¿ç”¨æ¬¡æ•°ï¼Œè®¾ç½®ä¸ºé»˜è®¤å€¼1');
                    }
                }
                
                // å¤„ç†äºšé©¬é€ŠåŠ©æ‰‹ç›¸å…³åŠŸèƒ½
                if (item.featureName && item.featureName.startsWith('amazon_')) {
                    console.log(`å‘ç°äºšé©¬é€ŠåŠ©æ‰‹åŠŸèƒ½: ${item.name}ï¼ŒåŸå§‹æ•°æ®:`, item);
                    
                    // è§£ædetailså­—æ®µï¼Œè·å–ä»»åŠ¡åˆ—è¡¨
                    if (item.details) {
                        try {
                            const details = JSON.parse(item.details);
                            if (details && details.tasks && Array.isArray(details.tasks)) {
                                // ä½¿ç”¨ä»»åŠ¡åˆ—è¡¨é•¿åº¦ä½œä¸ºä½¿ç”¨æ¬¡æ•°
                                item.usageCount = details.tasks.length;
                                console.log(`ä»ä»»åŠ¡åˆ—è¡¨è§£æå‡ºäºšé©¬é€ŠåŠ©æ‰‹åŠŸèƒ½ä½¿ç”¨æ¬¡æ•°: ${item.usageCount}`);
                            }
                        } catch (e) {
                            console.error('è§£æäºšé©¬é€ŠåŠ©æ‰‹åŠŸèƒ½è¯¦æƒ…å¤±è´¥:', e);
                        }
                    }
                    
                    // å¦‚æœæ— æ³•ä»detailsè§£ææˆ–usageCountä¸åˆç†ï¼Œä½¿ç”¨ç§¯åˆ†è®¡ç®—
                    if (!item.usageCount || item.usageCount <= 0) {
                        // äºšé©¬é€ŠåŠ©æ‰‹åŠŸèƒ½æ¯æ¬¡ä½¿ç”¨å›ºå®šæ¶ˆè€—1ç§¯åˆ†
                        if (item.credits && item.credits > 0) {
                            item.usageCount = item.credits;
                            console.log(`æ ¹æ®ç§¯åˆ†(${item.credits})è®¡ç®—äºšé©¬é€ŠåŠ©æ‰‹åŠŸèƒ½ä½¿ç”¨æ¬¡æ•°: ${item.usageCount}`);
                        } else {
                            // å¦‚æœæ²¡æœ‰ç§¯åˆ†è®°å½•ï¼Œç¡®ä¿è‡³å°‘æ˜¾ç¤º1æ¬¡
                            item.usageCount = 1;
                            console.log(`æ— æ³•ç¡®å®šäºšé©¬é€ŠåŠ©æ‰‹åŠŸèƒ½(${item.name})ä½¿ç”¨æ¬¡æ•°ï¼Œè®¾ç½®ä¸ºé»˜è®¤å€¼1`);
                        }
                    }
                }
                
                // ç¡®ä¿æ¯ä¸ªé¡¹ç›®éƒ½æœ‰usageCountï¼Œé˜²æ­¢æ¸²æŸ“é”™è¯¯
                if (item.usageCount === undefined || item.usageCount <= 0) {
                    // å¦‚æœæ²¡æœ‰usageCountæˆ–å€¼ä¸åˆç†ï¼Œä½¿ç”¨å›ºå®šå€¼1
                    item.usageCount = 1;
                }
            });
            
            console.log('å›¾è¡¨æ•°æ®(å¤„ç†å):', {
                labels: validData.map(item => item.name),
                data: validData.map(item => item.usageCount),
                total: validData.reduce((sum, item) => sum + item.usageCount, 0)
            });
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: validData.map(item => getFeatureName(item.name)),
                    datasets: [{
                        data: validData.map(item => item.usageCount),
                        backgroundColor: validData.map(item => item.color || getRandomColor(item.name)),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // ä¸æ˜¾ç¤ºå†…ç½®å›¾ä¾‹
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    const timesText = t('credits_usage.times', 'æ¬¡');
                                    return `${label}: ${value} ${timesText} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
            
            // æ›´æ–°å…¨å±€æ•°æ®ï¼Œç¡®ä¿åç»­åŠŸèƒ½åˆ—è¡¨æ¸²æŸ“æ­£ç¡®
            usageData.featureUsage = processedData;
        }
        
        // ç”Ÿæˆéšæœºé¢œè‰²å‡½æ•°ï¼ˆç¡®ä¿å›¾è¡¨é¢œè‰²ä¸ç¼ºå¤±ï¼‰
        function getRandomColor(seed) {
            // ä½¿ç”¨å›ºå®šçš„é¢œè‰²åˆ—è¡¨
            const colors = [
                '#4F46E5', '#0EA5E9', '#10B981', '#F59E0B', '#EF4444',
                '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16', '#F97316'
            ];
            
            // ä½¿ç”¨å­—ç¬¦ä¸²çš„å“ˆå¸Œå€¼æ¥é€‰æ‹©é¢œè‰²ï¼Œç¡®ä¿åŒååŠŸèƒ½é¢œè‰²ä¸€è‡´
            let hash = 0;
            for (let i = 0; i < seed.length; i++) {
                hash = seed.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            return colors[Math.abs(hash) % colors.length];
        }
        
        // æ¸²æŸ“åŠŸèƒ½åˆ—è¡¨
        function renderFeatureList() {
            const featureListEl = document.getElementById('feature-list');
            featureListEl.innerHTML = '';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            if (!usageData.featureUsage || usageData.featureUsage.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'text-center text-gray-500 py-4';
                emptyItem.textContent = t('credits_usage.no_feature_data', 'æš‚æ— åŠŸèƒ½ä½¿ç”¨è®°å½•');
                featureListEl.appendChild(emptyItem);
                return;
            }
            
            // è¿‡æ»¤æ‰ä½¿ç”¨æ¬¡æ•°ä¸º0çš„é¡¹ç›®
            const validData = usageData.featureUsage.filter(item => item.usageCount > 0);
            
            // å¦‚æœè¿‡æ»¤åæ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œæ˜¾ç¤ºæ— æ•°æ®æ¶ˆæ¯
            if (validData.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'text-center text-gray-500 py-4';
                emptyItem.textContent = t('credits_usage.no_feature_data', 'æš‚æ— åŠŸèƒ½ä½¿ç”¨è®°å½•');
                featureListEl.appendChild(emptyItem);
                return;
            }
            
            // è®¡ç®—ä½¿ç”¨æ¬¡æ•°çš„ç™¾åˆ†æ¯”
            const totalUsageCount = validData.reduce((sum, feature) => sum + feature.usageCount, 0);
            
            // æŒ‰ä½¿ç”¨æ¬¡æ•°æ’åºï¼Œä»å¤šåˆ°å°‘
            validData
                .sort((a, b) => b.usageCount - a.usageCount)
                .forEach(feature => {
                    // è®¡ç®—ä½¿ç”¨æ¬¡æ•°ç™¾åˆ†æ¯”
                    const usagePercentage = totalUsageCount > 0 ? 
                        ((feature.usageCount / totalUsageCount) * 100).toFixed(2) : '0.00';
                    
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center justify-between';
                    const timesText = t('credits_usage.times', 'æ¬¡');
                    listItem.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${feature.color || getRandomColor(feature.name)}"></div>
                            <span class="text-sm">${getFeatureName(feature.name)}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium">${feature.usageCount} ${timesText}</div>
                            <div class="text-xs text-gray-500">${usagePercentage}%</div>
                        </div>
                    `;
                    featureListEl.appendChild(listItem);
                });
        }
        
        // åŠŸèƒ½åç§°æ˜ å°„ï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
        function getFeatureName(featureName) {
            // è·å–å½“å‰è¯­è¨€
            const currentLang = localStorage.getItem('language') || 'zh';
            
            // ä¸­æ–‡åç§°åˆ°ç¿»è¯‘é”®çš„æ˜ å°„ï¼ˆåç«¯è¿”å›çš„æ˜¯ä¸­æ–‡åç§°ï¼‰
            const chineseNameToTranslationKey = {
                // å›¾åƒå¤„ç†
                'å›¾åƒè£å‰ª': 'feature.image_crop',
                'å›¾ç‰‡æ”¹å°ºå¯¸': 'feature.image_resizer',
                'å›¾åƒé«˜æ¸…æ”¾å¤§': 'feature.image_upscaling',
                'AIè¥é”€å›¾ç”Ÿæˆ': 'feature.marketing_image',
                'å•†å“æ¢èƒŒæ™¯': 'feature.smart_cutout',
                'å›¾ç‰‡ç¿»è¯‘': 'feature.image_translation',
                'åœºæ™¯å›¾ç”Ÿæˆ': 'feature.scene_generator',
                'å›¾åƒæ™ºèƒ½æ¶ˆé™¤': 'feature.smart_removal',
                'æ¨¡ç‰¹æ¢è‚¤': 'feature.model_skin_change',
                'æ¨¡æ‹Ÿè¯•è¡£': 'feature.virtual_try_on',
                'æ–‡ç”Ÿè§†é¢‘': 'feature.text_to_video',
                'å›¾ç”Ÿè§†é¢‘': 'feature.image_to_video',
                'æŒ‡ä»¤ç¼–è¾‘': 'feature.instruction_editing',
                'å±€éƒ¨é‡ç»˜': 'feature.local_redraw',
                'å›¾åƒä¸Šè‰²': 'feature.image_colorization',
                'æ™ºèƒ½æ‰©å›¾': 'feature.smart_expansion',
                'é‹é´è™šæ‹Ÿè¯•ç©¿': 'feature.virtual_shoes_try_on',
                'æ–‡ç”Ÿå›¾ç‰‡': 'feature.text_to_image',
                'æ¨¡ç³Šå›¾ç‰‡å˜æ¸…æ™°': 'feature.blur_to_clear',
                'æ™ºèƒ½æœé¥°åˆ†å‰²': 'feature.smart_clothing_segmentation',
                'å…¨å±€é£æ ¼åŒ–': 'feature.global_stylization',
                'æ™ºèƒ½è™šæ‹Ÿæ¨¡ç‰¹è¯•ç©¿': 'feature.virtual_model_try_on',
                'è§†é¢‘å»é™¤å­—å¹•': 'feature.video_subtitle_remover',
                'å¤šå›¾è½¬è§†é¢‘': 'feature.multi_image_to_video',
                'è§†é¢‘æ•°å­—äºº': 'feature.digital_human_video',
                'è§†é¢‘é£æ ¼é‡ç»˜': 'feature.video_style_repaint',
                'å›¾åƒç¼–è¾‘': 'QWEN_IMAGE_EDIT',
                'è§†é¢‘æ¢äºº': 'VIDEO_FACE_SWAP',
                'è§†é¢‘å»æ°´å°/logo': 'VIDEO_LOGO_REMOVAL',
                // äºšé©¬é€Šç›¸å…³åŠŸèƒ½
                'äºšé©¬é€Šå¹¿å‘Šè§†é¢‘è„šæœ¬ç”Ÿæˆ': 'amazon_video_script',
                'é€‰å“çš„æ”¹æ¬¾åˆ†æå’Œå»ºè®®': 'product_improvement_analysis',
                'å“ç‰Œä¿¡æ¯æ”¶é›†å’Œæ€»ç»“': 'amazon_brand_info',
                'äºšé©¬é€Šå“ç‰Œèµ·å': 'amazon_brand_naming',
                'äºšé©¬é€ŠListingå†™ä½œä¸ä¼˜åŒ–': 'amazon_listing',
                'äºšé©¬é€Šåå°æœç´¢è¯': 'amazon_search_term',
                'äºšé©¬é€Šå®¢æˆ·è¯„è®ºåˆ†æ': 'amazon_review_analysis',
                'äºšé©¬é€Šæ¶ˆè´¹è€…æ´å¯Ÿä¸“å®¶': 'amazon_consumer_insights',
                'äºšé©¬é€Šå®¢æˆ·é‚®ä»¶å›å¤': 'amazon_customer_email',
                'FBAç´¢èµ”é‚®ä»¶': 'fba_claim_email',
                'äºšé©¬é€Šè¯„è®ºç”Ÿæˆ': 'amazon_review_generator',
                'äºšé©¬é€Šè¯„è®ºå›å¤': 'amazon_review_response',
                'äº§å“å¯¹æ¯”': 'product_comparison',
                'åˆ›å»ºäºšé©¬é€ŠPost': 'amazon_post_creator',
                'äºšé©¬é€Šå…³é”®è¯æ¨è': 'amazon_keyword_recommender',
                'äºšé©¬é€Šå®¢æœcaseå†…å®¹': 'amazon_case_creator',
                // å…¶ä»–å¯èƒ½çš„åç§°å˜ä½“
                'å«å›¾': 'feature.padding_image',
                'è™šæ‹Ÿè¯•è¡£': 'feature.virtual_try_on',
                'AIæ¢è„¸': 'feature.ai_face_swap',
                'AIæ¢æ¨¡ç‰¹': 'feature.ai_model_change'
            };
            
            // è‹±æ–‡é”®ååˆ°ç¿»è¯‘é”®çš„æ˜ å°„ï¼ˆå…¼å®¹æ€§ï¼‰
            const englishKeyToTranslationKey = {
                'IMAGE_CROP': 'feature.image_crop',
                'IMAGE_RESIZE': 'feature.image_resizer',
                'image-upscaler': 'feature.image_upscaling',
                'marketing-images': 'feature.marketing_image',
                'cutout': 'feature.smart_cutout',
                'translate': 'feature.image_translation',
                'scene-generator': 'feature.scene_generator',
                'image-removal': 'feature.smart_removal',
                'model-skin-changer': 'feature.model_skin_change',
                'clothing-simulation': 'feature.virtual_try_on',
                'text-to-video': 'feature.text_to_video',
                'image-to-video': 'feature.image_to_video',
                'IMAGE_EDIT': 'feature.instruction_editing',
                'LOCAL_REDRAW': 'feature.local_redraw',
                'IMAGE_COLORIZATION': 'feature.image_colorization',
                'image-expansion': 'feature.smart_expansion',
                'VIRTUAL_SHOE_MODEL': 'feature.virtual_shoes_try_on',
                'TEXT_TO_IMAGE': 'feature.text_to_image',
                'IMAGE_SHARPENING': 'feature.blur_to_clear',
                'CLOTH_SEGMENTATION': 'feature.smart_clothing_segmentation',
                'GLOBAL_STYLE': 'feature.global_stylization',
                'VIRTUAL_MODEL_VTON': 'feature.virtual_model_try_on',
                'VIDEO_SUBTITLE_REMOVER': 'feature.video_subtitle_remover',
                'MULTI_IMAGE_TO_VIDEO': 'feature.multi_image_to_video',
                'DIGITAL_HUMAN_VIDEO': 'feature.digital_human_video',
                'VIDEO_STYLE_REPAINT': 'feature.video_style_repaint',
                'QWEN_IMAGE_EDIT': 'QWEN_IMAGE_EDIT',
                'VIDEO_FACE_SWAP': 'VIDEO_FACE_SWAP',
                'VIDEO_LOGO_REMOVAL': 'VIDEO_LOGO_REMOVAL',
                // äºšé©¬é€Šç›¸å…³åŠŸèƒ½
                'amazon_video_script': 'amazon_video_script',
                'product_improvement_analysis': 'product_improvement_analysis',
                'amazon_brand_info': 'amazon_brand_info',
                'amazon_brand_naming': 'amazon_brand_naming',
                'amazon_listing': 'amazon_listing',
                'amazon_search_term': 'amazon_search_term',
                'amazon_review_analysis': 'amazon_review_analysis',
                'amazon_consumer_insights': 'amazon_consumer_insights',
                'amazon_customer_email': 'amazon_customer_email',
                'fba_claim_email': 'fba_claim_email',
                'amazon_review_generator': 'amazon_review_generator',
                'amazon_review_response': 'amazon_review_response',
                'product_comparison': 'product_comparison',
                'amazon_post_creator': 'amazon_post_creator',
                'amazon_keyword_recommender': 'amazon_keyword_recommender',
                'amazon_case_creator': 'amazon_case_creator'
            };
            
            // å…ˆå°è¯•ä¸­æ–‡åç§°æ˜ å°„ï¼ˆåç«¯é€šå¸¸è¿”å›ä¸­æ–‡ï¼‰
            let translationKey = chineseNameToTranslationKey[featureName];
            
            // å¦‚æœä¸­æ–‡æ˜ å°„ä¸å­˜åœ¨ï¼Œå°è¯•è‹±æ–‡é”®æ˜ å°„
            if (!translationKey) {
                translationKey = englishKeyToTranslationKey[featureName];
            }
            
            // å¦‚æœå­˜åœ¨ç¿»è¯‘é”®ï¼Œå°è¯•ä»ç¿»è¯‘å¯¹è±¡è·å–
            if (translationKey && typeof translations !== 'undefined' && translations[currentLang] && translations[currentLang][translationKey]) {
                return translations[currentLang][translationKey];
            }
            
            // å¦‚æœæ˜¯ä¸­æ–‡è¯­è¨€ï¼Œç›´æ¥è¿”å›åŸåç§°
            if (currentLang === 'zh') {
                return featureName;
            }
            
            // å¦‚æœæ˜¯è‹±æ–‡è¯­è¨€ä½†æ²¡æœ‰ç¿»è¯‘ï¼Œè¿”å›åŸåç§°ï¼ˆå¯èƒ½æ˜¯è‹±æ–‡é”®åï¼‰
            return featureName;
        }
        
        // ä¿ç•™æ—§å‡½æ•°åä»¥å…¼å®¹
        function getChineseFeatureName(featureName) {
            return getFeatureName(featureName);
        }

        // æ“ä½œæè¿°æ˜ å°„ï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
        function getDescription(description) {
            if (!description) return description;
            
            const currentLang = localStorage.getItem('language') || 'zh';
            
            // å¦‚æœæ˜¯ä¸­æ–‡è¯­è¨€ï¼Œåªéœ€è¦ç¿»è¯‘åŠŸèƒ½åç§°
            if (currentLang === 'zh') {
                // åŒ¹é…"ä½¿ç”¨XXXåŠŸèƒ½"çš„æ¨¡å¼ï¼ˆä¸­æ–‡ï¼‰
                const matchCN = description.match(/ä½¿ç”¨(.+?)åŠŸèƒ½/);
                if (matchCN) {
                    const featureName = matchCN[1];
                    const translatedFeatureName = getFeatureName(featureName);
                    return description.replace(featureName, translatedFeatureName);
                }
                return description;
            }
            
            // å¦‚æœæ˜¯è‹±æ–‡è¯­è¨€ï¼Œéœ€è¦å®Œæ•´ç¿»è¯‘
            if (currentLang === 'en') {
                // åŒ¹é…"ä½¿ç”¨XXXåŠŸèƒ½"çš„æ¨¡å¼ï¼ˆä¸­æ–‡ï¼‰
                const matchCN = description.match(/ä½¿ç”¨(.+?)åŠŸèƒ½/);
                if (matchCN) {
                    const featureName = matchCN[1];
                    const translatedFeatureName = getFeatureName(featureName);
                    return `Used ${translatedFeatureName} feature`;
                }
                
                // åŒ¹é…"å¤„ç†Xç§’è§†é¢‘"çš„æ¨¡å¼
                const videoMatch = description.match(/å¤„ç†(\d+)ç§’è§†é¢‘/);
                if (videoMatch) {
                    const seconds = videoMatch[1];
                    return `Processed ${seconds}-second video`;
                }
                
                // åŒ¹é…"Used XXX feature"çš„æ¨¡å¼ï¼ˆè‹±æ–‡ï¼Œå¯èƒ½å·²ç»æ˜¯è‹±æ–‡ï¼‰
                const matchEN = description.match(/Used (.+?) feature/i);
                if (matchEN) {
                    const featureName = matchEN[1];
                    const translatedFeatureName = getFeatureName(featureName);
                    return description.replace(featureName, translatedFeatureName);
                }
            }
            
            return description;
        }
        
        // ä¿ç•™æ—§å‡½æ•°åä»¥å…¼å®¹
        function getChineseDescription(description) {
            return getDescription(description);
        }

        // æ¸²æŸ“ä½¿ç”¨è®°å½•åˆ—è¡¨
        function renderUsageRecords() {
            const recordsListEl = document.getElementById('usage-records-list');
            const noRecordsEl = document.getElementById('no-records');
            
            recordsListEl.innerHTML = '';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è®°å½•æ•°æ®
            if (!usageData.usageRecords || usageData.usageRecords.length === 0) {
                noRecordsEl.classList.remove('hidden');
                return;
            }
            
            noRecordsEl.classList.add('hidden');
            
            // åªæ˜¾ç¤ºæœ€è¿‘çš„10æ¡è®°å½•
            const recentRecords = usageData.usageRecords.slice(0, 10);
            
            // æ¸²æŸ“æ¯æ¡è®°å½•
            recentRecords.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // ğŸ”§ ä¿®å¤ç§¯åˆ†ä½¿ç”¨è®°å½•æ˜¾ç¤ºé€»è¾‘ï¼šåŒºåˆ†çœŸæ­£çš„å…è´¹ä½¿ç”¨å’Œé˜²é‡å¤æ‰£è´¹
                let creditDisplay;
                
                const freeText = t('credits_usage.free', 'å…è´¹');
                const creditsText = t('credits_usage.credits', 'ç§¯åˆ†');
                
                // ç‰¹æ®Šå¤„ç†å±€éƒ¨é‡ç»˜åŠŸèƒ½
                if (record.feature === 'å±€éƒ¨é‡ç»˜' || record.feature === 'LOCAL_REDRAW') {
                    // æ£€æŸ¥æ˜¯å¦ä¸ºå…è´¹ä½¿ç”¨
                    if (record.isFree === true) {
                        creditDisplay = `<span class="text-green-500 font-medium">${freeText}</span>`;
                    } else {
                        // å¦‚æœä¸æ˜¯å…è´¹ï¼Œæ˜¾ç¤ºæ­£ç¡®çš„ç§¯åˆ†æ¶ˆè´¹
                        const creditCost = typeof record.credits === 'number' ? record.credits : 7; // å±€éƒ¨é‡ç»˜æ ‡å‡†ç§¯åˆ†æ¶ˆè´¹
                        creditDisplay = `<span class="text-red-500 font-medium">-${creditCost} ${creditsText}</span>`;
                    }
                } else if (record.feature === 'å›¾ç‰‡æ”¹å°ºå¯¸' || record.feature === 'IMAGE_RESIZE') {
                    // å›¾ç‰‡æ”¹å°ºå¯¸åŠŸèƒ½å§‹ç»ˆå…è´¹
                    creditDisplay = `<span class="text-green-500 font-medium">${freeText}</span>`;
                } else if (record.isFree === true) {
                    // çœŸæ­£çš„å…è´¹ä½¿ç”¨
                    creditDisplay = `<span class="text-green-500 font-medium">${freeText}</span>`;
                } else if (record.credits === 0) {
                    // é˜²é‡å¤æ‰£è´¹çš„0ç§¯åˆ†ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‡ºç°ï¼Œå› ä¸ºåç«¯å·²ä¿®å¤ï¼‰
                    creditDisplay = `<span class="text-gray-500 font-medium">0 ${creditsText}</span>`;
                } else if (record.credits === "å…è´¹" || record.credits === "Free") {
                    // åç«¯è¿”å›çš„å…è´¹æ ‡è®°
                    creditDisplay = `<span class="text-green-500 font-medium">${freeText}</span>`;
                } else {
                    // æ­£å¸¸çš„ä»˜è´¹ä½¿ç”¨
                    creditDisplay = `<span class="text-red-500 font-medium">-${record.credits} ${creditsText}</span>`;
                }
                
                row.innerHTML = `
                    <td class="py-3 px-4 border-b text-sm">${record.date}</td>
                    <td class="py-3 px-4 border-b text-sm">
                        <span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded-full text-xs">
                            ${getFeatureName(record.feature)}
                        </span>
                    </td>
                    <td class="py-3 px-4 border-b text-sm">${getDescription(record.description)}</td>
                    <td class="py-3 px-4 border-b text-sm">${creditDisplay}</td>
                `;
                recordsListEl.appendChild(row);
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šDOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            
            // åˆå§‹åŒ–è¯­è¨€æ”¯æŒ
            initLanguageSupport();
            
            // ç­‰å¾…è®¤è¯æ£€æŸ¥å®Œæˆåå†åˆå§‹åŒ–
            const waitForAuth = () => {
                // æ£€æŸ¥æ˜¯å¦æ­£åœ¨è¿›è¡Œè®¤è¯æ£€æŸ¥
                if (window.isAuthChecking) {
                    console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šç­‰å¾…è®¤è¯æ£€æŸ¥å®Œæˆ...');
                    setTimeout(waitForAuth, 500);
                    return;
                }
                
                // æ£€æŸ¥è®¤è¯çŠ¶æ€
                const authToken = localStorage.getItem('authToken');
                const userInfo = localStorage.getItem('user');
                
                if (authToken && userInfo) {
                    console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šè®¤è¯å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
                    initializeUserUI();
                } else {
                    console.log('ç§¯åˆ†ä½¿ç”¨é¡µé¢ï¼šç”¨æˆ·æœªç™»å½•ï¼Œç­‰å¾…è®¤è¯æ£€æŸ¥...');
                    setTimeout(waitForAuth, 500);
                }
            };
            
            // å»¶è¿Ÿå¯åŠ¨ï¼Œç¡®ä¿auth-check.jsæœ‰æ—¶é—´å®Œæˆè®¤è¯
            setTimeout(waitForAuth, 2000);
        });
    </script>
</body>
</html> 