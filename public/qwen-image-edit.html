<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="qwen_image_edit.page_title">å›¾åƒç¼–è¾‘ - è¤ç«AI</title>
    <link rel="icon" href="/images/favicon.png" type="image/png">
    <script src="/js/tailwind.min.js"></script>
    <link href="/components/styles.css" rel="stylesheet">
    <link href="/css/error-styles.css" rel="stylesheet">
    <script src="/js/logout-handler.js"></script>
    <script src="/js/auth-check.js"></script>
    <script src="/feature-tracker.js"></script>
    <script src="/js/error-handler.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/auth-helper.js"></script>
    <!-- å¤šè¯­è¨€æ”¯æŒ -->
    <script src="/translations.js"></script>
    <!-- æœ¬åœ°å¤‡ä»½çš„remixicon -->
    <link href="/css/remixicon.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        @keyframes firefly-glow {
            0% { text-shadow: 0 0 3px rgba(99, 102, 241, 0.5); }
            50% { text-shadow: 0 0 10px rgba(99, 102, 241, 0.8), 0 0 15px rgba(99, 102, 241, 0.3); }
            100% { text-shadow: 0 0 3px rgba(99, 102, 241, 0.5); }
        }
        .logo-text {
            animation: firefly-glow 3s infinite;
        }
        .logo-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #6366f1;
            border-radius: 50%;
            margin-left: 2px;
            margin-right: 4px;
            position: relative;
            top: -2px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 5px solid rgba(99, 102, 241, 0.2);
            border-top-color: rgba(99, 102, 241, 1);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .image-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .image-upload-area:hover {
            border-color: #6366f1;
            background-color: #f8fafc;
        }
        
        .image-upload-area.dragover {
            border-color: #6366f1;
            background-color: #ede9fe;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .image-preview-container {
            position: relative;
            display: inline-block;
            margin: 8px;
        }
        
        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        
        .result-image {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin: 8px;
            background-color: #f9fafb;
        }
        
        .task-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-succeeded {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-failed {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* å†å²è®°å½•å¡ç‰‡æ ·å¼ - å‚ç…§æ™ºèƒ½æ‰©å›¾ */
        .history-card {
            transition: all 0.2s ease;
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .history-card img {
            transition: transform 0.2s ease-in-out;
        }
        
        .history-card:hover img {
            filter: brightness(1.05);
        }
        
        /* æ–‡æœ¬æˆªæ–­æ ·å¼ */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* ä¸‹è½½æŒ‰é’®æ ·å¼ */
        .download-history-btn {
            transition: all 0.2s ease-in-out;
            border-radius: 4px;
        }
        
        .download-history-btn:hover {
            background-color: rgba(99, 102, 241, 0.1);
            transform: scale(1.1);
        }
        
        /* æ¨¡æ€æ¡†åŠ¨ç”» */
        .modal-enter {
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* ç¼©ç•¥å›¾æ‚¬åœæ•ˆæœ */
        .history-card .relative img {
            transition: all 0.3s ease;
        }
        
        .history-card:hover .relative img {
            filter: brightness(1.05);
        }
        
        /* çŠ¶æ€æ ‡ç­¾åœ¨ç¼©ç•¥å›¾ä¸Šçš„æ ·å¼ */
        .history-card .absolute .task-status {
            backdrop-filter: blur(4px);
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* åŠŸèƒ½æŒ‰é’®æ ·å¼ */
        .function-btn {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            text-align: left;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #ffffff;
            color: #374151;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .function-btn:hover {
            background-color: #f9fafb;
            border-color: #d1d5db;
            color: #111827;
        }

        .function-btn.active {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: #ffffff;
        }

        .function-btn.active:hover {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        .function-btn i {
            margin-right: 8px;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .function-btn span {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- ç®€åŒ–ç‰ˆå¯¼èˆªæ  -->
    <div id="navbar-simple"></div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8" style="margin-top: 60px;">
        <div class="px-4 py-6 sm:px-0">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2" data-translate="qwen_image_edit.main_title">å›¾åƒç¼–è¾‘</h1>
                <p class="text-lg text-gray-600" data-translate="qwen_image_edit.description">æ”¯æŒå¤šå›¾è¾“å…¥ï¼Œç²¾ç¡®ä¿®æ”¹å›¾å†…æ–‡å­—ã€å¢åˆ ç§»åŠ¨ç‰©ä½“ã€æ”¹å˜ä¸»ä½“åŠ¨ä½œã€è¿ç§»å›¾ç‰‡é£æ ¼</p>
                <div class="mt-4 flex justify-center items-center space-x-4 text-sm text-gray-500">
                    <span class="flex items-center">
                        <i class="ri-image-line mr-1"></i>
                        <span data-translate="qwen_image_edit.support_images">æ”¯æŒ1-3å¼ å›¾ç‰‡</span>
                    </span>
                    <span class="flex items-center">
                        <i class="ri-file-line mr-1"></i>
                        <span data-translate="qwen_image_edit.supported_formats">JPGã€PNGã€WEBPæ ¼å¼</span>
                    </span>
                    <span class="flex items-center">
                        <i class="ri-coin-line mr-1"></i>
                        <span data-translate="qwen_image_edit.pricing_info">é¦–æ¬¡å…è´¹ï¼Œåç»­7ç§¯åˆ†/å¼ å›¾ç‰‡</span>
                    </span>
                </div>
            </div>

            <div class="flex gap-6">
                <!-- å·¦ä¾§åŠŸèƒ½èœå• -->
                <div class="w-64 flex-shrink-0">
                    <div class="bg-white rounded-lg shadow p-4 sticky top-20">
                        <h3 class="text-lg font-medium text-gray-900 mb-4" data-translate="qwen_image_edit.sidebar_title">å›¾åƒç¼–è¾‘</h3>
                        <div class="space-y-2">
                            <button class="function-btn active" data-function="multi-fusion">
                                <i class="ri-collage-line"></i>
                                <span data-translate="qwen_image_edit.function.multi_fusion">å¤šå›¾èåˆ</span>
                            </button>
                            <button class="function-btn" data-function="consistency">
                                <i class="ri-user-line"></i>
                                <span data-translate="qwen_image_edit.function.consistency">ä¸»ä½“ä¸€è‡´æ€§ä¿æŒ</span>
                            </button>
                            <button class="function-btn" data-function="sketch-create">
                                <i class="ri-pencil-line"></i>
                                <span data-translate="qwen_image_edit.function.sketch_create">è‰å›¾åˆ›ä½œ</span>
                            </button>
                            <button class="function-btn" data-function="creative-gen">
                                <i class="ri-palette-line"></i>
                                <span data-translate="qwen_image_edit.function.creative_gen">æ–‡åˆ›ç”Ÿæˆ</span>
                            </button>
                            <button class="function-btn" data-function="depth-gen">
                                <i class="ri-stack-line"></i>
                                <span data-translate="qwen_image_edit.function.depth_gen">æ ¹æ®æ·±åº¦å›¾ç”Ÿæˆå›¾åƒ</span>
                            </button>
                            <button class="function-btn" data-function="keypoint-gen">
                                <i class="ri-focus-3-line"></i>
                                <span data-translate="qwen_image_edit.function.keypoint_gen">æ ¹æ®å…³é”®ç‚¹ç”Ÿæˆå›¾åƒ</span>
                            </button>
                            <button class="function-btn" data-function="text-edit">
                                <i class="ri-font-size"></i>
                                <span data-translate="qwen_image_edit.function.text_edit">æ–‡å­—ç¼–è¾‘</span>
                            </button>
                            <button class="function-btn" data-function="object-edit">
                                <i class="ri-scissors-line"></i>
                                <span data-translate="qwen_image_edit.function.object_edit">å¢åˆ æ”¹åŠæ›¿æ¢</span>
                            </button>
                            <button class="function-btn" data-function="perspective">
                                <i class="ri-camera-3-line"></i>
                                <span data-translate="qwen_image_edit.function.perspective">è§†è§’è½¬æ¢</span>
                            </button>
                            <button class="function-btn" data-function="bg-replace">
                                <i class="ri-landscape-line"></i>
                                <span data-translate="qwen_image_edit.function.bg_replace">èƒŒæ™¯æ›¿æ¢</span>
                            </button>
                            <button class="function-btn" data-function="photo-restore">
                                <i class="ri-image-2-line"></i>
                                <span data-translate="qwen_image_edit.function.photo_restore">è€ç…§ç‰‡å¤„ç†</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ä¸­é—´ï¼šä¸»è¦å†…å®¹åŒºåŸŸ -->
                <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- å·¦ä¾§ï¼šå›¾ç‰‡ä¸Šä¼ å’Œå‚æ•°è®¾ç½® -->
                    <div class="space-y-6">
                    <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4" data-translate="qwen_image_edit.upload_title">ä¸Šä¼ å›¾ç‰‡ï¼ˆ1-3å¼ ï¼‰</h3>
                        
                        <div id="imageUploadArea" class="image-upload-area">
                            <div class="text-center">
                                <i class="ri-upload-cloud-2-line text-4xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600 mb-2" data-translate="qwen_image_edit.upload_click_or_drag">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</p>
                                <p class="text-sm text-gray-500" data-translate="qwen_image_edit.upload_formats">æ”¯æŒ JPGã€PNGã€WEBP æ ¼å¼ï¼Œå•å¼ æœ€å¤§ 10MB</p>
                            </div>
                            <input type="file" id="imageInput" multiple accept="image/jpeg,image/jpg,image/png,image/webp" style="display: none;">
                        </div>
                        
                        <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
                        <div id="imagePreviewArea" class="mt-4 text-center" style="display: none;">
                            <h4 class="text-sm font-medium text-gray-700 mb-2" data-translate="qwen_image_edit.uploaded_images">å·²ä¸Šä¼ çš„å›¾ç‰‡ï¼š</h4>
                            <div id="imagePreviewContainer"></div>
                        </div>
                    </div>

                    <!-- ç¼–è¾‘æŒ‡ä»¤ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4" data-translate="qwen_image_edit.edit_instruction">ç¼–è¾‘æŒ‡ä»¤</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="promptInput" class="block text-sm font-medium text-gray-700 mb-2">
                                    <span data-translate="qwen_image_edit.edit_description_required">ç¼–è¾‘æè¿° *</span>
                                </label>
                                <textarea 
                                    id="promptInput" 
                                    rows="4" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    data-translate-placeholder="qwen_image_edit.edit_description_placeholder"
                                    placeholder="è¯·è¯¦ç»†æè¿°æ‚¨æƒ³è¦çš„ç¼–è¾‘æ•ˆæœï¼Œä¾‹å¦‚ï¼šå°†å›¾ä¸­çš„äººç‰©æ”¹ä¸ºç«™ç«‹å§¿åŠ¿ï¼Œå¼¯è…°æ¡ä½ç‹—çš„å‰çˆª"
                                ></textarea>
                                <p class="mt-1 text-xs text-gray-500" data-translate="qwen_image_edit.edit_description_tip">æä¾›æ¸…æ™°çš„æŒ‡ä»¤ï¼ŒAIæ‰èƒ½ç²¾å‡†å¤„ç†ã€‚æ”¯æŒä¸­è‹±æ–‡åŒè¯­ã€‚</p>
                            </div>
                            
                            <div>
                                <label for="negativePromptInput" class="block text-sm font-medium text-gray-700 mb-2">
                                    <span data-translate="qwen_image_edit.negative_prompt">è´Ÿé¢æç¤ºï¼ˆå¯é€‰ï¼‰</span>
                                </label>
                                <textarea 
                                    id="negativePromptInput" 
                                    rows="2" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    data-translate-placeholder="qwen_image_edit.negative_prompt_placeholder"
                                    placeholder="æè¿°æ‚¨ä¸å¸Œæœ›å‡ºç°çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šæ¨¡ç³Šã€æ‰­æ›²ã€å˜å½¢ã€ä½è´¨é‡"
                                ></textarea>
                            </div>
                            
                            <!-- è¾“å‡ºå›¾ç‰‡æ•°é‡è®¾ç½® -->
                            <div>
                                <label for="outputCountInput" class="block text-sm font-medium text-gray-700 mb-2">
                                    <span data-translate="qwen_image_edit.output_count">è¾“å‡ºå›¾ç‰‡æ•°é‡</span>
                                </label>
                                <select 
                                    id="outputCountInput" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    onchange="updateCreditCost()"
                                >
                                    <option value="1" selected data-translate="qwen_image_edit.output_count_1">1å¼ å›¾ç‰‡</option>
                                    <option value="2" data-translate="qwen_image_edit.output_count_2">2å¼ å›¾ç‰‡</option>
                                    <option value="3" data-translate="qwen_image_edit.output_count_3">3å¼ å›¾ç‰‡</option>
                                    <option value="4" data-translate="qwen_image_edit.output_count_4">4å¼ å›¾ç‰‡</option>
                                    <option value="5" data-translate="qwen_image_edit.output_count_5">5å¼ å›¾ç‰‡</option>
                                    <option value="6" data-translate="qwen_image_edit.output_count_6">6å¼ å›¾ç‰‡</option>
                                </select>
                                <div class="mt-2 flex items-center justify-between">
                                    <p class="text-xs text-gray-500" data-translate="qwen_image_edit.output_count_support">æ”¯æŒç”Ÿæˆ1-6å¼ å›¾ç‰‡</p>
                                    <div id="creditCostDisplay" class="text-sm font-medium text-indigo-600">
                                        <span data-translate="qwen_image_edit.estimated_cost">é¢„è®¡æ¶ˆè€—ï¼š7ç§¯åˆ†</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- éšæœºæ•°ç§å­è®¾ç½® -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4" data-translate="qwen_image_edit.seed_title">éšæœºæ•°ç§å­ï¼ˆé«˜çº§é€‰é¡¹ï¼‰</h3>
                        
                        <div>
                            <label for="seedInput" class="block text-sm font-medium text-gray-700 mb-2">
                                <span data-translate="qwen_image_edit.seed_label">éšæœºæ•°ç§å­</span>
                            </label>
                            <input 
                                type="number" 
                                id="seedInput" 
                                name="seed" 
                                min="0" 
                                max="2147483647" 
                                data-translate-placeholder="qwen_image_edit.seed_placeholder"
                                placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆéšæœºç§å­"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            >
                            <p class="mt-1 text-xs text-gray-500" data-translate="qwen_image_edit.seed_tip">
                                è¾“å…¥0åˆ°2147483647ä¹‹é—´çš„æ•´æ•°ã€‚ä½¿ç”¨ç›¸åŒçš„ç§å­å€¼å¯ä»¥ç”Ÿæˆç›¸åŒçš„ç»“æœï¼Œå®ç°å¯é‡å¤çš„å›¾åƒç¼–è¾‘æ•ˆæœã€‚
                            </p>
                        </div>
                    </div>


                    <!-- å¼€å§‹ç¼–è¾‘æŒ‰é’® -->
                    <div class="text-center">
                        <button 
                            id="startEditBtn" 
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-8 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            <i class="ri-magic-line mr-2"></i>
                            <span data-translate="qwen_image_edit.start_edit">å¼€å§‹ç¼–è¾‘</span>
                        </button>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šç¼–è¾‘ç»“æœå’Œå†å²è®°å½• -->
                <div class="space-y-6">
                    <!-- ç¼–è¾‘ç»“æœ -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4" data-translate="qwen_image_edit.edit_result">ç¼–è¾‘ç»“æœ</h3>
                        
                        <div id="editResultArea">
                            <div class="text-center py-12 text-gray-500">
                                <i class="ri-image-line text-4xl mb-4"></i>
                                <p data-translate="qwen_image_edit.result_placeholder">ä¸Šä¼ å›¾ç‰‡å¹¶è¾“å…¥ç¼–è¾‘æŒ‡ä»¤åï¼Œç¼–è¾‘ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                            </div>
                        </div>
                    </div>

                    <!-- å†å²è®°å½• -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900" data-translate="qwen_image_edit.edit_history">ç¼–è¾‘å†å²</h3>
                            <div class="flex space-x-2">
                                <button 
                                    id="clear-history-btn" 
                                    class="text-gray-500 hover:text-red-600 text-sm font-medium"
                                    data-translate-title="qwen_image_edit.clear_history_title"
                                    title="æ¸…ç©ºå†å²è®°å½•"
                                >
                                    <i class="ri-delete-bin-line mr-1"></i>
                                    <span data-translate="qwen_image_edit.clear_history">æ¸…ç©º</span>
                                </button>
                                <button 
                                    id="refreshHistoryBtn" 
                                    class="text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                                >
                                    <i class="ri-refresh-line mr-1"></i>
                                    <span data-translate="qwen_image_edit.refresh">åˆ·æ–°</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="historyArea">
                            <div class="text-center py-8 text-gray-500">
                                <i class="ri-history-line text-3xl mb-2"></i>
                                <p data-translate="qwen_image_edit.no_history">æš‚æ— ç¼–è¾‘å†å²</p>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æç¤ºæ¨¡æ€æ¡† -->
    <div id="loadingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" style="display: none;">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <h3 class="text-lg font-medium text-gray-900 mb-2" data-translate="qwen_image_edit.loading_title">æ­£åœ¨å¤„ç†å›¾åƒç¼–è¾‘</h3>
                <p class="text-sm text-gray-500 mb-4" data-translate="qwen_image_edit.loading_message">AIæ­£åœ¨åˆ†ææ‚¨çš„å›¾ç‰‡å’ŒæŒ‡ä»¤ï¼Œè¯·è€å¿ƒç­‰å¾…...</p>
                <div class="text-xs text-gray-400">
                    <p data-translate="qwen_image_edit.estimated_time">é¢„è®¡å¤„ç†æ—¶é—´ï¼š30-60ç§’</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let uploadedImages = [];
        let currentTaskId = null;
        let pollingInterval = null;
        let currentFunctionType = 'multi-fusion'; // ğŸ”¥ æ–°å¢ï¼šå½“å‰é€‰æ‹©çš„åŠŸèƒ½ç±»å‹

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // åŠ è½½å¯¼èˆªæ ç»„ä»¶
            try {
                const navbarResponse = await fetch('/components/navbar-simple.html');
                const navbarHtml = await navbarResponse.text();
                document.getElementById('navbar-simple').innerHTML = navbarHtml;
                
                // åŠ è½½ç»„ä»¶JavaScript
                const componentsScript = document.createElement('script');
                componentsScript.src = '/components/components.js';
                document.head.appendChild(componentsScript);
            } catch (error) {
                console.error('åŠ è½½å¯¼èˆªæ ç»„ä»¶å¤±è´¥:', error);
            }
            
            initializeEventListeners();
            loadEditHistory();
            
            // åˆå§‹åŒ–ä¸ºå¤šå›¾èåˆåŠŸèƒ½
            handleFunctionSwitch('multi-fusion');
        });

        // æ›´æ–°ç§¯åˆ†æ¶ˆè€—æ˜¾ç¤º
        function updateCreditCost() {
            const outputCount = parseInt(document.getElementById('outputCountInput').value) || 1;
            const creditCost = outputCount * 7; // æ¯å¼ å›¾ç‰‡7ç§¯åˆ†
            const creditDisplay = document.getElementById('creditCostDisplay');
            if (creditDisplay && typeof translate === 'function') {
                const costText = translate('qwen_image_edit.estimated_cost').replace('{cost}', creditCost);
                creditDisplay.innerHTML = `<span data-translate="qwen_image_edit.estimated_cost">${costText}</span>`;
            } else if (creditDisplay) {
                creditDisplay.textContent = `é¢„è®¡æ¶ˆè€—ï¼š${creditCost}ç§¯åˆ†`;
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            // åŠŸèƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.function-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
                    document.querySelectorAll('.function-btn').forEach(b => b.classList.remove('active'));
                    // æ·»åŠ å½“å‰æŒ‰é’®çš„activeçŠ¶æ€
                    this.classList.add('active');
                    
                    const functionType = this.dataset.function;
                    handleFunctionSwitch(functionType);
                });
            });

            // å›¾ç‰‡ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            document.getElementById('imageUploadArea').addEventListener('click', () => {
                document.getElementById('imageInput').click();
            });

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            document.getElementById('imageInput').addEventListener('change', handleImageUpload);

            // æ‹–æ‹½ä¸Šä¼ äº‹ä»¶
            const uploadArea = document.getElementById('imageUploadArea');
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);


            // å¼€å§‹ç¼–è¾‘æŒ‰é’®äº‹ä»¶
            document.getElementById('startEditBtn').addEventListener('click', startImageEdit);

            // åˆ·æ–°å†å²è®°å½•æŒ‰é’®äº‹ä»¶
            document.getElementById('refreshHistoryBtn').addEventListener('click', loadEditHistory);
            
            // æ¸…ç©ºå†å²è®°å½•æŒ‰é’®äº‹ä»¶
            document.getElementById('clear-history-btn').addEventListener('click', clearEditHistory);

            // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('promptInput').addEventListener('input', updateStartButtonState);
        }

        // ğŸ”¥ æ–°å¢ï¼šæ¸…ç†åŠŸèƒ½çŠ¶æ€
        function clearFunctionState() {
            // 1. æ¸…ç†ä¸Šä¼ çš„å›¾ç‰‡
            uploadedImages = [];
            updateImagePreview();
            
            // 2. æ¸…ç©ºè¾“å…¥æ¡†å†…å®¹
            const promptInput = document.getElementById('promptInput');
            if (promptInput) {
                promptInput.value = '';
            }
            
            const negativePromptInput = document.getElementById('negativePromptInput');
            if (negativePromptInput) {
                negativePromptInput.value = '';
            }
            
            const seedInput = document.getElementById('seedInput');
            if (seedInput) {
                seedInput.value = '';
            }
            
            
            // 4. é‡ç½®è¾“å‡ºå›¾ç‰‡æ•°é‡ä¸º1å¼ 
            const outputCountInput = document.getElementById('outputCountInput');
            if (outputCountInput) {
                outputCountInput.value = '1';
                updateCreditCost();
            }
            
            // 5. æ¸…ç†ç¼–è¾‘ç»“æœåŒºåŸŸ
            const editResultArea = document.getElementById('editResultArea');
            if (editResultArea) {
                editResultArea.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="ri-image-line text-4xl mb-4"></i>
                        <p>${typeof translate === 'function' ? translate('qwen_image_edit.result_placeholder') : 'ä¸Šä¼ å›¾ç‰‡å¹¶è¾“å…¥ç¼–è¾‘æŒ‡ä»¤åï¼Œç¼–è¾‘ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º'}</p>
                    </div>
                `;
            }
            
            // 6. åœæ­¢å½“å‰ä»»åŠ¡è½®è¯¢
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            
            // 7. é‡ç½®å½“å‰ä»»åŠ¡ID
            currentTaskId = null;
            
            // 8. éšè—åŠ è½½æ¨¡æ€æ¡†
            const loadingModal = document.getElementById('loadingModal');
            if (loadingModal) {
                loadingModal.style.display = 'none';
            }
            
            // 9. é‡ç½®æ–‡ä»¶è¾“å…¥
            const imageInput = document.getElementById('imageInput');
            if (imageInput) {
                imageInput.value = '';
            }
            
            // 10. æ¸…ç†å†å²è®°å½•åŒºåŸŸï¼ˆå°†åœ¨åŠŸèƒ½åˆ‡æ¢åé‡æ–°åŠ è½½ï¼‰
            const historyArea = document.getElementById('historyArea');
            if (historyArea) {
                historyArea.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="ri-history-line text-3xl mb-2"></i>
                        <p>æ­£åœ¨åŠ è½½å†å²è®°å½•...</p>
                    </div>
                `;
            }
            
            // 11. æ›´æ–°å¼€å§‹æŒ‰é’®çŠ¶æ€
            updateStartButtonState();
            
            console.log('ğŸ§¹ åŠŸèƒ½çŠ¶æ€å·²æ¸…ç†');
        }

        // å¤„ç†åŠŸèƒ½åˆ‡æ¢
        function handleFunctionSwitch(functionType) {
            // ğŸ”¥ æ–°å¢ï¼šæ¸…ç†ä¹‹å‰åŠŸèƒ½çš„çŠ¶æ€å’Œæ•°æ®
            clearFunctionState();
            
            // ğŸ”¥ æ–°å¢ï¼šæ›´æ–°å½“å‰åŠŸèƒ½ç±»å‹
            currentFunctionType = functionType;
            
            // æ ¹æ®ä¸åŒåŠŸèƒ½ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤ºä¿¡æ¯
            const functionInfo = {
                'multi-fusion': {
                    title: 'å¤šå›¾èåˆ',
                    description: 'å°†å¤šå¼ å›¾ç‰‡èåˆæˆä¸€å¼ ï¼Œåˆ›é€ å…¨æ–°çš„è§†è§‰æ•ˆæœ',
                    placeholder: 'è¯·æè¿°æ‚¨å¸Œæœ›å¦‚ä½•èåˆè¿™äº›å›¾ç‰‡ï¼Œä¾‹å¦‚ï¼š\n- å°†ç¬¬ä¸€å¼ å›¾çš„äººç‰©å’Œç¬¬äºŒå¼ å›¾çš„èƒŒæ™¯èåˆ\n- åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰å›¾ç‰‡å…ƒç´ çš„åˆæˆå›¾\n- å°†å¤šå¼ é£æ™¯å›¾èåˆæˆå…¨æ™¯å›¾'
                },
                'consistency': {
                    title: 'ä¸»ä½“ä¸€è‡´æ€§ä¿æŒ',
                    description: 'åœ¨ä¸åŒåœºæ™¯ä¸­ä¿æŒä¸»ä½“äººç‰©æˆ–ç‰©ä½“çš„ä¸€è‡´æ€§',
                    placeholder: 'è¯·æè¿°æ‚¨å¸Œæœ›ä¿æŒä¸€è‡´çš„ä¸»ä½“å’Œæ–°çš„åœºæ™¯ï¼Œä¾‹å¦‚ï¼š\n- ä¿æŒäººç‰©å¤–è§‚ï¼Œå°†èƒŒæ™¯æ”¹ä¸ºæµ·è¾¹\n- ä¿æŒäº§å“å¤–è§‚ï¼Œæ”¾ç½®åœ¨ä¸åŒçš„ç¯å¢ƒä¸­\n- ä¿æŒè§’è‰²ç‰¹å¾ï¼Œæ”¹å˜åŠ¨ä½œå§¿æ€'
                },
                'sketch-create': {
                    title: 'è‰å›¾åˆ›ä½œ',
                    description: 'å°†ç®€å•çš„è‰å›¾è½¬æ¢ä¸ºç²¾ç¾çš„è‰ºæœ¯ä½œå“',
                    placeholder: 'è¯·æè¿°æ‚¨å¸Œæœ›å°†è‰å›¾è½¬æ¢æˆä»€ä¹ˆæ ·çš„ä½œå“ï¼Œä¾‹å¦‚ï¼š\n- å°†æ‰‹ç»˜è‰å›¾è½¬æ¢ä¸ºå†™å®é£æ ¼çš„ç”»ä½œ\n- å°†ç®€ç¬”ç”»è½¬æ¢ä¸ºå¡é€šé£æ ¼çš„æ’ç”»\n- å°†å»ºç­‘è‰å›¾è½¬æ¢ä¸º3Dæ•ˆæœå›¾'
                },
                'creative-gen': {
                    title: 'æ–‡åˆ›ç”Ÿæˆ',
                    description: 'åŸºäºæ–‡å­—æè¿°ç”Ÿæˆåˆ›æ„å›¾åƒä½œå“',
                    placeholder: 'è¯·è¯¦ç»†æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„åˆ›æ„ä½œå“ï¼Œä¾‹å¦‚ï¼š\n- è®¾è®¡ä¸€ä¸ªç°ä»£ç®€çº¦é£æ ¼çš„logo\n- åˆ›ä½œä¸€å¹…æŠ½è±¡è‰ºæœ¯ç”»\n- ç”Ÿæˆä¸€ä¸ªäº§å“åŒ…è£…è®¾è®¡\n- åˆ¶ä½œä¸€å¼ å®£ä¼ æµ·æŠ¥'
                },
                'depth-gen': {
                    title: 'æ ¹æ®æ·±åº¦å›¾ç”Ÿæˆå›¾åƒ',
                    description: 'åŸºäºæ·±åº¦ä¿¡æ¯ç”Ÿæˆå…·æœ‰ç«‹ä½“æ„Ÿçš„å›¾åƒ',
                    placeholder: 'è¯·æè¿°æ‚¨å¸Œæœ›ç”Ÿæˆçš„å›¾åƒå†…å®¹å’Œé£æ ¼ï¼Œä¾‹å¦‚ï¼š\n- æ ¹æ®æ·±åº¦å›¾ç”Ÿæˆå®¤å†…åœºæ™¯\n- åˆ›å»ºå…·æœ‰å±‚æ¬¡æ„Ÿçš„é£æ™¯ç”»\n- ç”Ÿæˆ3Dæ•ˆæœçš„äº§å“å±•ç¤ºå›¾'
                },
                'keypoint-gen': {
                    title: 'æ ¹æ®å…³é”®ç‚¹ç”Ÿæˆå›¾åƒ',
                    description: 'åŸºäºå…³é”®ç‚¹ä¿¡æ¯ç”Ÿæˆç¬¦åˆå§¿æ€çš„å›¾åƒ',
                    placeholder: 'è¯·æè¿°æ‚¨å¸Œæœ›ç”Ÿæˆçš„å›¾åƒå’Œå§¿æ€è¦æ±‚ï¼Œä¾‹å¦‚ï¼š\n- æ ¹æ®äººä½“å…³é”®ç‚¹ç”Ÿæˆç‰¹å®šå§¿åŠ¿çš„äººç‰©\n- åŸºäºæ‰‹éƒ¨å…³é”®ç‚¹ç”Ÿæˆæ‰‹åŠ¿å›¾åƒ\n- æ ¹æ®é¢éƒ¨å…³é”®ç‚¹ç”Ÿæˆè¡¨æƒ…å›¾åƒ'
                },
                'text-edit': {
                    title: 'æ–‡å­—ç¼–è¾‘',
                    description: 'ç²¾ç¡®ç¼–è¾‘å›¾ç‰‡ä¸­çš„æ–‡å­—å†…å®¹',
                    placeholder: 'è¯·æè¿°æ‚¨è¦ç¼–è¾‘çš„æ–‡å­—å†…å®¹ï¼Œä¾‹å¦‚ï¼š\n- å°†å›¾ç‰‡ä¸­çš„"SALE"æ”¹ä¸º"ä¿ƒé”€"\n- ä¿®æ”¹æµ·æŠ¥ä¸Šçš„æ—¥æœŸä¿¡æ¯\n- æ›´æ¢æ ‡è¯†ç‰Œä¸Šçš„æ–‡å­—\n- ç¿»è¯‘å›¾ç‰‡ä¸­çš„å¤–æ–‡æ–‡å­—'
                },
                'object-edit': {
                    title: 'å¢åˆ æ”¹åŠæ›¿æ¢',
                    description: 'å¯¹å›¾ç‰‡ä¸­çš„ç‰©ä½“è¿›è¡Œå¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹æˆ–æ›¿æ¢',
                    placeholder: 'è¯·æè¿°æ‚¨è¦è¿›è¡Œçš„ç‰©ä½“ç¼–è¾‘æ“ä½œï¼Œä¾‹å¦‚ï¼š\n- åˆ é™¤å›¾ç‰‡ä¸­çš„æŸä¸ªäººç‰©\n- åœ¨æ¡Œå­ä¸Šæ·»åŠ ä¸€ä¸ªè‹¹æœ\n- å°†æ±½è½¦æ›¿æ¢ä¸ºè‡ªè¡Œè½¦\n- ä¿®æ”¹å»ºç­‘ç‰©çš„é¢œè‰²'
                },
                'perspective': {
                    title: 'è§†è§’è½¬æ¢',
                    description: 'æ”¹å˜å›¾ç‰‡çš„æ‹æ‘„è§†è§’å’Œè§‚å¯Ÿè§’åº¦',
                    placeholder: 'è¯·æè¿°æ‚¨å¸Œæœ›çš„è§†è§’å˜åŒ–ï¼Œä¾‹å¦‚ï¼š\n- å°†æ­£é¢è§†è§’æ”¹ä¸ºä¾§é¢è§†è§’\n- ä»ä½è§’åº¦æ”¹ä¸ºé¸Ÿç°è§†è§’\n- å°†å®¤å†…è§†è§’æ”¹ä¸ºå®¤å¤–è§†è§’\n- æ”¹å˜äº§å“çš„å±•ç¤ºè§’åº¦'
                },
                'bg-replace': {
                    title: 'èƒŒæ™¯æ›¿æ¢',
                    description: 'æ›¿æ¢å›¾ç‰‡çš„èƒŒæ™¯ç¯å¢ƒ',
                    placeholder: 'è¯·æè¿°æ‚¨å¸Œæœ›çš„æ–°èƒŒæ™¯ï¼Œä¾‹å¦‚ï¼š\n- å°†å®¤å†…èƒŒæ™¯æ”¹ä¸ºæµ·æ»©é£æ™¯\n- å°†ç™½è‰²èƒŒæ™¯æ”¹ä¸ºæ¸å˜è‰²èƒŒæ™¯\n- å°†åŸå¸‚èƒŒæ™¯æ”¹ä¸ºæ£®æ—èƒŒæ™¯\n- æ·»åŠ ç‰¹å®šçš„åœºæ™¯èƒŒæ™¯'
                },
                'photo-restore': {
                    title: 'è€ç…§ç‰‡å¤„ç†',
                    description: 'ä¿®å¤å’Œå¢å¼ºè€æ—§ç…§ç‰‡çš„è´¨é‡',
                    placeholder: 'è¯·æè¿°æ‚¨å¸Œæœ›å¯¹è€ç…§ç‰‡è¿›è¡Œçš„å¤„ç†ï¼Œä¾‹å¦‚ï¼š\n- ä¿®å¤ç…§ç‰‡ä¸Šçš„åˆ’ç—•å’Œæ±¡æ¸\n- æé«˜ç…§ç‰‡çš„æ¸…æ™°åº¦å’Œå¯¹æ¯”åº¦\n- ä¸ºé»‘ç™½ç…§ç‰‡ä¸Šè‰²\n- ä¿®å¤ç ´æŸçš„ç…§ç‰‡è¾¹ç¼˜'
                }
            };

            const info = functionInfo[functionType] || functionInfo['multi-fusion'];
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜å’Œæè¿° - ä½¿ç”¨ç¿»è¯‘å‡½æ•°
            const formattedFunctionType = functionType.replace(/-/g, '_');
            const titleKey = `qwen_image_edit.function_info.${formattedFunctionType}.title`;
            const descKey = `qwen_image_edit.function_info.${formattedFunctionType}.description`;
            const placeholderKey = `qwen_image_edit.function_info.${formattedFunctionType}.placeholder`;
            
            document.querySelector('h1').textContent = typeof translate === 'function' ? translate(titleKey) || info.title : info.title;
            document.querySelector('h1').nextElementSibling.textContent = typeof translate === 'function' ? translate(descKey) || info.description : info.description;
            
            // æ›´æ–°ç¼–è¾‘æŒ‡ä»¤çš„å ä½ç¬¦æ–‡æœ¬
            const textarea = document.getElementById('promptInput');
            if (textarea) {
                textarea.placeholder = typeof translate === 'function' ? translate(placeholderKey) || info.placeholder : info.placeholder;
                textarea.value = ''; // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            }

            // æ ¹æ®åŠŸèƒ½ç±»å‹æ˜¾ç¤º/éšè—ç›¸å…³æ§ä»¶
            updateUIForFunction(functionType);
            
            // ğŸ”¥ æ–°å¢ï¼šé‡æ–°åŠ è½½å½“å‰åŠŸèƒ½çš„å†å²è®°å½•
            setTimeout(() => {
                loadEditHistory();
            }, 100); // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿UIæ›´æ–°å®Œæˆ
        }

        // æ ¹æ®åŠŸèƒ½ç±»å‹æ›´æ–°UI
        function updateUIForFunction(functionType) {
            // è¿™é‡Œå¯ä»¥æ ¹æ®ä¸åŒåŠŸèƒ½æ˜¾ç¤º/éšè—ç‰¹å®šçš„æ§ä»¶
            // ä¾‹å¦‚æŸäº›åŠŸèƒ½å¯èƒ½ä¸éœ€è¦ç‰¹å®šçš„è®¾ç½®ç­‰
            
            // æš‚æ—¶ä¿æŒæ‰€æœ‰æ§ä»¶å¯è§ï¼Œåç»­å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´
            console.log('åˆ‡æ¢åˆ°åŠŸèƒ½:', functionType);
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            processImageFiles(files);
        }

        // å¤„ç†æ‹–æ‹½æ‚¬åœ
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        // å¤„ç†æ‹–æ‹½ç¦»å¼€
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        // å¤„ç†æ‹–æ‹½æ”¾ä¸‹
        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = Array.from(event.dataTransfer.files);
            processImageFiles(files);
        }

        // å¤„ç†å›¾ç‰‡æ–‡ä»¶
        function processImageFiles(files) {
            // è¿‡æ»¤å›¾ç‰‡æ–‡ä»¶
            const imageFiles = files.filter(file => {
                return file.type.startsWith('image/') && 
                       ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'].includes(file.type);
            });

            if (imageFiles.length === 0) {
                alert(typeof translate === 'function' ? translate('qwen_image_edit.upload_first') : 'è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼ˆJPGã€PNGã€WEBPæ ¼å¼ï¼‰');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶æ•°é‡é™åˆ¶
            if (uploadedImages.length + imageFiles.length > 3) {
                alert(typeof translate === 'function' ? translate('qwen_image_edit.support_images') : 'æœ€å¤šåªèƒ½ä¸Šä¼ 3å¼ å›¾ç‰‡');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°
            const oversizedFiles = imageFiles.filter(file => file.size > 10 * 1024 * 1024);
            if (oversizedFiles.length > 0) {
                alert(typeof translate === 'function' ? translate('qwen_image_edit.upload_formats') : 'å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                return;
            }

            // æ·»åŠ å›¾ç‰‡åˆ°åˆ—è¡¨
            imageFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImages.push({
                        file: file,
                        dataUrl: e.target.result,
                        name: file.name
                    });
                    updateImagePreview();
                    updateStartButtonState();
                };
                reader.readAsDataURL(file);
            });
        }

        // æ›´æ–°å›¾ç‰‡é¢„è§ˆ
        function updateImagePreview() {
            const previewArea = document.getElementById('imagePreviewArea');
            const previewContainer = document.getElementById('imagePreviewContainer');

            if (uploadedImages.length === 0) {
                previewArea.style.display = 'none';
                return;
            }

            previewArea.style.display = 'block';
            previewContainer.innerHTML = '';

            uploadedImages.forEach((image, index) => {
                const container = document.createElement('div');
                container.className = 'image-preview-container';

                const img = document.createElement('img');
                img.src = image.dataUrl;
                img.className = 'image-preview';
                img.alt = image.name;

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-image-btn';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.onclick = () => removeImage(index);

                container.appendChild(img);
                container.appendChild(removeBtn);
                previewContainer.appendChild(container);
            });
        }

        // ç§»é™¤å›¾ç‰‡
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImagePreview();
            updateStartButtonState();
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            document.getElementById('imageInput').value = '';
        }

        // æ›´æ–°å¼€å§‹æŒ‰é’®çŠ¶æ€
        function updateStartButtonState() {
            const startBtn = document.getElementById('startEditBtn');
            const prompt = document.getElementById('promptInput').value.trim();
            const hasImages = uploadedImages.length > 0;

            startBtn.disabled = !(hasImages && prompt);
        }

        // å¼€å§‹å›¾åƒç¼–è¾‘
        async function startImageEdit() {
            const prompt = document.getElementById('promptInput').value.trim();
            const negativePrompt = document.getElementById('negativePromptInput').value.trim();

            if (!prompt) {
                alert(typeof translate === 'function' ? translate('qwen_image_edit.enter_prompt') : 'è¯·è¾“å…¥ç¼–è¾‘æŒ‡ä»¤');
                return;
            }

            if (uploadedImages.length === 0) {
                alert(typeof translate === 'function' ? translate('qwen_image_edit.upload_first') : 'è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ å›¾ç‰‡');
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½æ¨¡æ€æ¡†
                document.getElementById('loadingModal').style.display = 'block';

                // å‡†å¤‡FormData
                const formData = new FormData();
                formData.append('prompt', `[${currentFunctionType}] ${prompt}`); // ğŸ”¥ æ–°å¢ï¼šåœ¨promptå‰æ·»åŠ åŠŸèƒ½ç±»å‹æ ‡è¯†
                formData.append('negativePrompt', negativePrompt);
                
                // æ·»åŠ è¾“å‡ºå›¾ç‰‡æ•°é‡å‚æ•°
                const outputCount = document.getElementById('outputCountInput').value;
                console.log('ğŸ” å‰ç«¯è°ƒè¯• - é€‰æ‹©çš„å›¾ç‰‡æ•°é‡:', outputCount);
                formData.append('n', outputCount);
                
                // æ·»åŠ éšæœºæ•°ç§å­å‚æ•°
                const seed = document.getElementById('seedInput').value;
                if (seed && seed.trim() !== '') {
                    formData.append('seed', seed);
                }

                // æ·»åŠ å›¾ç‰‡æ–‡ä»¶
                uploadedImages.forEach((image, index) => {
                    formData.append('images', image.file);
                });

                console.log('å¼€å§‹åˆ›å»ºé€šä¹‰åƒé—®å›¾åƒç¼–è¾‘ä»»åŠ¡...');

                // è°ƒç”¨APIåˆ›å»ºä»»åŠ¡
                const response = await fetch('/api/qwen-image-edit/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    currentTaskId = result.data.taskId;
                    console.log('ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œä»»åŠ¡ID:', currentTaskId);

                    // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    startTaskPolling();
                } else {
                    throw new Error(result.message || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
                }

            } catch (error) {
                console.error('åˆ›å»ºå›¾åƒç¼–è¾‘ä»»åŠ¡å¤±è´¥:', error);
                document.getElementById('loadingModal').style.display = 'none';
                alert((typeof translate === 'function' ? translate('qwen_image_edit.task_failed') : 'åˆ›å»ºä»»åŠ¡å¤±è´¥') + ': ' + error.message);
            }
        }

        // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
        function startTaskPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/qwen-image-edit/status/${currentTaskId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });

                    const result = await response.json();
                    
                    // ğŸ” è°ƒè¯•ï¼šæ˜¾ç¤ºå®Œæ•´çš„APIå“åº”æ•°æ®
                    console.log('ğŸ” è°ƒè¯• - çŠ¶æ€æŸ¥è¯¢APIå“åº”:', result);

                    if (result.success && result.data.status === 'SUCCEEDED') {
                        // ä»»åŠ¡å®Œæˆ
                        clearInterval(pollingInterval);
                        document.getElementById('loadingModal').style.display = 'none';
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰ç¼–è¾‘åçš„å›¾ç‰‡
                        if (result.data.resultImages && result.data.resultImages.length > 0) {
                            // æœ‰ç¼–è¾‘åçš„å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡ç»“æœ
                            displayEditResult(result.data);
                        } else if (result.data.editingInstructions) {
                            // åªæœ‰ç¼–è¾‘æŒ‡å¯¼ï¼Œæ˜¾ç¤ºæŒ‡å¯¼å†…å®¹
                            displayEditInstructions(result.data);
                        } else {
                            displayEditResult(result.data);
                        }
                        loadEditHistory(); // åˆ·æ–°å†å²è®°å½•
                        
                    } else if (!result.success || result.data.status === 'FAILED') {
                        // ä»»åŠ¡å¤±è´¥
                        clearInterval(pollingInterval);
                        document.getElementById('loadingModal').style.display = 'none';
                        alert((typeof translate === 'function' ? translate('qwen_image_edit.task_failed_status') : 'å›¾åƒç¼–è¾‘å¤±è´¥') + ': ' + (result.data?.error || (typeof translate === 'function' ? translate('qwen_image_edit.task_failed_status') : 'æœªçŸ¥é”™è¯¯')));
                    }
                    // ä»»åŠ¡è¿›è¡Œä¸­ï¼Œç»§ç»­è½®è¯¢

                } catch (error) {
                    console.error('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                }
            }, 3000); // æ¯3ç§’æŸ¥è¯¢ä¸€æ¬¡
        }

        // æ˜¾ç¤ºç¼–è¾‘ç»“æœï¼ˆåŒ…å«ç¼–è¾‘åçš„å›¾ç‰‡ï¼‰
        function displayEditResult(taskData) {
            const resultArea = document.getElementById('editResultArea');
            
            // ä¼˜å…ˆä½¿ç”¨OSSå­˜å‚¨çš„å›¾ç‰‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åŸå§‹ç»“æœ
            let displayImages = [];
            
            if (taskData.ossResultImages && taskData.ossResultImages.length > 0) {
                displayImages = taskData.ossResultImages.map(item => item.ossUrl);
                console.log('ğŸ” è°ƒè¯• - ä½¿ç”¨OSSç»“æœå›¾ç‰‡:', taskData.ossResultImages);
            } else if (taskData.resultImages && taskData.resultImages.length > 0) {
                displayImages = taskData.resultImages.map(item => {
                    // ç¡®ä¿è¿”å›æœ‰æ•ˆçš„URLå­—ç¬¦ä¸²
                    if (typeof item === 'string') {
                        return item;
                    } else if (item && typeof item === 'object' && item.url) {
                        return item.url;
                    } else {
                        console.error('âŒ æ— æ•ˆçš„å›¾ç‰‡æ•°æ®:', item);
                        return null;
                    }
                }).filter(url => url !== null); // è¿‡æ»¤æ‰æ— æ•ˆçš„URL
                console.log('ğŸ” è°ƒè¯• - ä½¿ç”¨åŸå§‹ç»“æœå›¾ç‰‡:', taskData.resultImages);
            }
            
            // ğŸ” è°ƒè¯•ï¼šæ£€æŸ¥æ‰€æœ‰å›¾ç‰‡URL
            console.log('ğŸ” è°ƒè¯• - æœ€ç»ˆæ˜¾ç¤ºçš„å›¾ç‰‡URLs:', displayImages);
            
            if (!displayImages || displayImages.length === 0) {
                // å¦‚æœæ²¡æœ‰å›¾ç‰‡ä½†æœ‰æŒ‡å¯¼ï¼Œæ˜¾ç¤ºæŒ‡å¯¼å†…å®¹
                if (taskData.editingInstructions) {
                    displayEditInstructions(taskData);
                    return;
                }
                
                resultArea.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="ri-error-warning-line text-3xl mb-2"></i>
                        <p>æœªç”Ÿæˆç¼–è¾‘ç»“æœ</p>
                    </div>
                `;
                return;
            }

            let resultHtml = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h4 class="font-medium text-gray-900">
                            <i class="ri-image-edit-line mr-2"></i>${typeof translate === 'function' ? translate('qwen_image_edit.task_succeeded') : 'å›¾åƒç¼–è¾‘å®Œæˆ'}
                        </h4>
                        <div class="flex items-center space-x-2">
                            <span class="task-status status-succeeded">${typeof translate === 'function' ? translate('qwen_image_edit.task_succeeded') : 'å·²å®Œæˆ'}</span>
                            ${taskData.ossResultImages && taskData.ossResultImages.length > 0 ? 
                                `<span class="text-xs text-green-600"><i class="ri-cloud-line"></i>${typeof translate === 'function' ? translate('qwen_image_edit.save_to_download_center') : 'å·²ä¿å­˜åˆ°äº‘ç«¯'}</span>` : ''}
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded">
                        <strong>${typeof translate === 'function' ? translate('qwen_image_edit.edit_description') : 'ç¼–è¾‘æŒ‡ä»¤'}ï¼š</strong>${getCleanPrompt(taskData.prompt)}
                        ${taskData.negativePrompt ? `<br><strong>${typeof translate === 'function' ? translate('qwen_image_edit.negative_prompt') : 'è´Ÿé¢æç¤º'}ï¼š</strong>${taskData.negativePrompt}` : ''}
                    </div>
                    <div class="text-center mb-4">
                        <span class="text-sm font-medium text-green-600">
                            <i class="ri-check-line"></i> ${typeof translate === 'function' ? translate('qwen_image_edit.task_succeeded') : 'æˆåŠŸç”Ÿæˆ'} ${displayImages.length} ${typeof translate === 'function' ? translate('qwen_image_edit.support_images') : 'å¼ ç¼–è¾‘åçš„å›¾ç‰‡'}
                        </span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            `;

            displayImages.forEach((imageUrl, index) => {
                // ğŸ” è°ƒè¯•ï¼šæ£€æŸ¥å›¾ç‰‡URLæ˜¯å¦æ­£ç¡®
                console.log(`ğŸ” è°ƒè¯• - å›¾ç‰‡URL ${index + 1}:`, imageUrl);
                if (imageUrl && imageUrl.includes('200bject')) {
                    console.error('âŒ å‘ç°é”™è¯¯çš„URL:', imageUrl);
                    console.trace('URLæ¥æºè¿½è¸ª');
                }
                
                resultHtml += `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                        <div class="text-center">
                            <div class="relative inline-block">
                                <img src="${imageUrl}" alt="ç¼–è¾‘ç»“æœ ${index + 1}" class="result-image mx-auto rounded-lg shadow-md">
                                <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">
                                    ${index + 1}/${displayImages.length}
                                </div>
                            </div>
                            <div class="mt-3 space-y-2">
                                <div class="flex space-x-2 justify-center">
                                    <a href="${imageUrl}" download="qwen-edit-result-${index + 1}.jpg" 
                                       class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-indigo-600 bg-indigo-100 hover:bg-indigo-200 transition-colors">
                                        <i class="ri-download-line mr-1"></i>
                                        ${typeof translate === 'function' ? translate('qwen_image_edit.download_result') : 'ä¸‹è½½'}
                                    </a>
                                    <button onclick="saveToDownloadCenter('${imageUrl}', 'QWEN_IMAGE_EDIT', '${typeof translate === 'function' ? translate('qwen_image_edit.edit_result') : 'å›¾åƒç¼–è¾‘ç»“æœ'} ${index + 1}', '${taskData.prompt}')" 
                                            class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-green-600 bg-green-100 hover:bg-green-200 transition-colors">
                                        <i class="ri-save-line mr-1"></i>
                                        ${typeof translate === 'function' ? translate('qwen_image_edit.save_to_downloads') : 'ä¿å­˜'}
                                    </button>
                                    <button onclick="previewImage('${imageUrl}')" 
                                            class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-purple-600 bg-purple-100 hover:bg-purple-200 transition-colors">
                                        <i class="ri-eye-line mr-1"></i>
                                        ${typeof translate === 'function' ? translate('qwen_image_edit.edit_result') : 'é¢„è§ˆ'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            resultHtml += `
                    </div>
                    ${taskData.editingInstructions ? `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h5 class="font-medium text-blue-900 mb-2">
                                <i class="ri-lightbulb-line mr-1"></i>${typeof translate === 'function' ? translate('qwen_image_edit.edit_instruction') : 'ç¼–è¾‘è¯´æ˜'}
                            </h5>
                            <div class="text-sm text-blue-800 whitespace-pre-wrap">${taskData.editingInstructions}</div>
                        </div>
                    ` : ''}
                    <div class="text-xs text-gray-500 text-center space-x-4">
                        <span>${typeof translate === 'function' ? translate('qwen_image_edit.estimated_cost').replace('{cost}', taskData.isFree ? '0' : taskData.creditCost) : 'æ¶ˆè€—ç§¯åˆ†'}: ${taskData.isFree ? `0ï¼ˆ${typeof translate === 'function' ? translate('qwen_image_edit.pricing_info') : 'å…è´¹'}ï¼‰` : taskData.creditCost}${taskData.resultImages && taskData.resultImages.length > 1 ? ` (${taskData.resultImages.length}å¼ Ã—7ç§¯åˆ†)` : ''}</span>
                        <span>${typeof translate === 'function' ? translate('qwen_image_edit.estimated_time') : 'å®Œæˆæ—¶é—´'}: ${new Date(taskData.completedAt).toLocaleString()}</span>
                    </div>
                </div>
            `;

            resultArea.innerHTML = resultHtml;
        }
        
        // æ˜¾ç¤ºç¼–è¾‘æŒ‡å¯¼ï¼ˆä»…æ–‡æœ¬æ¨¡å¼ï¼‰
        function displayEditInstructions(taskData) {
            const resultArea = document.getElementById('editResultArea');
            
            const instructionsHtml = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h4 class="font-medium text-gray-900">
                            <i class="ri-lightbulb-line mr-2"></i>å›¾åƒç¼–è¾‘æŒ‡å¯¼
                        </h4>
                        <div class="flex items-center space-x-2">
                            <span class="task-status status-succeeded">${typeof translate === 'function' ? translate('qwen_image_edit.task_succeeded') : 'å·²å®Œæˆ'}</span>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded">
                        <strong>${typeof translate === 'function' ? translate('qwen_image_edit.edit_description') : 'ç¼–è¾‘æŒ‡ä»¤'}ï¼š</strong>${getCleanPrompt(taskData.prompt)}
                        ${taskData.negativePrompt ? `<br><strong>${typeof translate === 'function' ? translate('qwen_image_edit.negative_prompt') : 'è´Ÿé¢æç¤º'}ï¼š</strong>${taskData.negativePrompt}` : ''}
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="text-center mb-3">
                            <i class="ri-robot-line text-2xl text-blue-600"></i>
                            <p class="text-sm font-medium text-blue-900 mt-1">${typeof translate === 'function' ? translate('qwen_image_edit.edit_instruction') : 'ä¸“ä¸šç¼–è¾‘æŒ‡å¯¼'}</p>
                        </div>
                        <div class="text-sm text-blue-800 whitespace-pre-wrap leading-relaxed">${taskData.editingInstructions}</div>
                    </div>
                    <div class="text-xs text-gray-500 text-center space-x-4">
                        <span>${typeof translate === 'function' ? translate('qwen_image_edit.estimated_cost').replace('{cost}', taskData.isFree ? '0' : taskData.creditCost) : 'æ¶ˆè€—ç§¯åˆ†'}: ${taskData.isFree ? `0ï¼ˆ${typeof translate === 'function' ? translate('qwen_image_edit.pricing_info') : 'å…è´¹'}ï¼‰` : taskData.creditCost}${taskData.resultImages && taskData.resultImages.length > 1 ? ` (${taskData.resultImages.length}å¼ Ã—7ç§¯åˆ†)` : ''}</span>
                        <span>${typeof translate === 'function' ? translate('qwen_image_edit.estimated_time') : 'å®Œæˆæ—¶é—´'}: ${new Date(taskData.completedAt).toLocaleString()}</span>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-sm text-yellow-800">
                            <i class="ri-information-line mr-1"></i>
                            å½“å‰ä½¿ç”¨çš„æ˜¯ç¼–è¾‘æŒ‡å¯¼æ¨¡å¼ï¼Œæä¾›ä¸“ä¸šçš„å›¾åƒç¼–è¾‘å»ºè®®ã€‚å¦‚éœ€ç›´æ¥ç”Ÿæˆç¼–è¾‘åçš„å›¾ç‰‡ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å‡çº§APIæƒé™ã€‚
                        </p>
                    </div>
                </div>
            `;
            
            resultArea.innerHTML = instructionsHtml;
        }
        
        // é¢„è§ˆå›¾ç‰‡
        function previewImage(imageUrl) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="relative max-w-4xl max-h-full p-4">
                    <img src="${imageUrl}" class="max-w-full max-h-full object-contain rounded-lg">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full w-8 h-8 flex items-center justify-center hover:bg-opacity-75">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
            `;
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // ğŸ”¥ æ–°å¢ï¼šæ¸…ç†promptä¸­çš„åŠŸèƒ½ç±»å‹æ ‡è¯†
        function getCleanPrompt(prompt) {
            if (!prompt) return '';
            
            // ç§»é™¤åŠŸèƒ½ç±»å‹æ ‡è¯† [function-type]
            const cleanPrompt = prompt.replace(/^\[[\w-]+\]\s*/, '');
            return cleanPrompt;
        }

        // åŠ è½½ç¼–è¾‘å†å²
        async function loadEditHistory() {
            try {
                const response = await fetch('/api/qwen-image-edit/history?limit=20', { // ğŸ”¥ å¢åŠ è·å–æ•°é‡ä»¥ä¾¿è¿‡æ»¤
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // ğŸ”¥ æ–°å¢ï¼šæ ¹æ®å½“å‰åŠŸèƒ½ç±»å‹è¿‡æ»¤å†å²è®°å½•
                    const filteredTasks = result.data.tasks.filter(task => {
                        // æ£€æŸ¥promptæ˜¯å¦åŒ…å«å½“å‰åŠŸèƒ½ç±»å‹çš„æ ‡è¯†
                        return task.prompt && task.prompt.startsWith(`[${currentFunctionType}]`);
                    });
                    
                    // åªæ˜¾ç¤ºå‰5æ¡åŒ¹é…çš„è®°å½•
                    const limitedTasks = filteredTasks.slice(0, 5);
                    
                    console.log(`ğŸ” å†å²è®°å½•è¿‡æ»¤ç»“æœ: æ€»æ•°=${result.data.tasks.length}, å½“å‰åŠŸèƒ½(${currentFunctionType})=${limitedTasks.length}`);
                    
                    displayEditHistory(limitedTasks);
                } else {
                    console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', result.message);
                    displayEditHistory([]);
                }

            } catch (error) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                displayEditHistory([]);
            }
        }

        // æ˜¾ç¤ºç¼–è¾‘å†å²
        function displayEditHistory(tasks) {
            const historyArea = document.getElementById('historyArea');

            if (!tasks || tasks.length === 0) {
                historyArea.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="ri-history-line text-3xl mb-2"></i>
                        <p>${typeof translate === 'function' ? translate('qwen_image_edit.no_history') : 'æš‚æ— ç¼–è¾‘å†å²'}</p>
                    </div>
                `;
                return;
            }

            // ä¼˜å…ˆæ˜¾ç¤ºæœ‰ç»“æœå›¾çš„è®°å½•ï¼Œç„¶åæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œåªå–å‰3æ¡
            const sortedTasks = tasks
                .sort((a, b) => {
                    // ä¼˜å…ˆæ˜¾ç¤ºæœ‰ç»“æœå›¾çš„è®°å½•
                    const aHasResult = (a.ossResultImages && a.ossResultImages.length > 0) || 
                                     (a.resultImages && a.resultImages.length > 0);
                    const bHasResult = (b.ossResultImages && b.ossResultImages.length > 0) || 
                                     (b.resultImages && b.resultImages.length > 0);
                    
                    if (aHasResult && !bHasResult) return -1;
                    if (!aHasResult && bHasResult) return 1;
                    
                    // å¦‚æœéƒ½æœ‰ç»“æœå›¾æˆ–éƒ½æ²¡æœ‰ç»“æœå›¾ï¼ŒæŒ‰æ—¶é—´æ’åº
                    return new Date(b.createdAt) - new Date(a.createdAt);
                })
                .slice(0, 3);

            // ä½¿ç”¨ç½‘æ ¼å¸ƒå±€æ˜¾ç¤ºå†å²è®°å½• - å‚ç…§æ™ºèƒ½æ‰©å›¾æ ·å¼
            let historyHtml = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';

            sortedTasks.forEach((task, index) => {
                const statusClass = task.status === 'SUCCEEDED' ? 'status-succeeded' : 
                                  task.status === 'FAILED' ? 'status-failed' : 'status-pending';
                const statusText = task.status === 'SUCCEEDED' ? 'å·²å®Œæˆ' : 
                                 task.status === 'FAILED' ? 'å¤±è´¥' : 'å¤„ç†ä¸­';

                // è·å–ç»“æœå›¾ç‰‡ç”¨äºç¼©ç•¥å›¾æ˜¾ç¤º
                let thumbnailImage = null;
                if (task.ossResultImages && task.ossResultImages.length > 0) {
                    thumbnailImage = task.ossResultImages[0].ossUrl;
                } else if (task.resultImages && task.resultImages.length > 0) {
                    const firstResult = task.resultImages[0];
                    if (typeof firstResult === 'string') {
                        thumbnailImage = firstResult;
                    } else if (firstResult && typeof firstResult === 'object' && firstResult.url) {
                        thumbnailImage = firstResult.url;
                    }
                }

                historyHtml += `
                    <div class="history-card bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-all cursor-pointer h-full flex flex-col">
                        ${thumbnailImage ? `
                            <div class="relative flex-shrink-0">
                                <img src="${thumbnailImage}" alt="ç¼–è¾‘ç»“æœ" class="w-full h-40 object-cover" loading="lazy">
                                <div class="absolute top-2 right-2">
                                    <span class="task-status ${statusClass} text-xs backdrop-blur-sm bg-white bg-opacity-90 border border-white border-opacity-20">${statusText}</span>
                                </div>
                                ${task.ossResultImages && task.ossResultImages.length > 0 ? 
                                    '<div class="absolute top-2 left-2"><span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded backdrop-blur-sm bg-opacity-90"><i class="ri-cloud-line"></i> å·²ä¿å­˜</span></div>' : ''}
                            </div>
                        ` : `
                            <div class="h-40 bg-gray-100 flex items-center justify-center flex-shrink-0">
                                <div class="text-center">
                                    <i class="ri-image-line text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500">æ— ç»“æœå›¾ç‰‡</p>
                                    <span class="task-status ${statusClass} text-xs mt-2 inline-block">${statusText}</span>
                                </div>
                            </div>
                        `}
                        
                        <div class="p-3 flex-1 flex flex-col">
                            <p class="text-sm text-gray-700 line-clamp-2 mb-2 flex-1" title="${getCleanPrompt(task.prompt)}">${getCleanPrompt(task.prompt)}</p>
                            
                            <div class="mt-auto space-y-2">
                                <div class="flex justify-between items-center text-xs text-gray-500">
                                    <span>${new Date(task.createdAt).toLocaleString('zh-CN')}</span>
                                    ${thumbnailImage ? `
                                        <button class="download-history-btn text-indigo-600 hover:text-indigo-800 p-1 rounded hover:bg-indigo-50 transition-all" 
                                                onclick="event.stopPropagation(); downloadHistoryImage('${thumbnailImage}', 'ç¼–è¾‘ç»“æœ_${task.taskId || Date.now()}.png')"
                                                title="ä¸‹è½½å›¾ç‰‡">
                                            <i class="ri-download-line text-sm"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            
                                
                                <div class="pt-2 border-t border-gray-100 text-right">
                                    <span class="text-xs text-gray-500">ç§¯åˆ†: ${task.isFree ? '0ï¼ˆå…è´¹ï¼‰' : task.creditCost}${task.resultImages && task.resultImages.length > 1 ? ` (${task.resultImages.length}å¼ Ã—7ç§¯åˆ†)` : ''}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            historyHtml += '</div>';
            historyArea.innerHTML = historyHtml;

            // ä¸ºå†å²è®°å½•å¡ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæŸ¥çœ‹è¯¦æƒ…ï¼‰
            document.querySelectorAll('.history-card').forEach((card, index) => {
                card.addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯ä¸‹è½½æŒ‰é’®ï¼Œä¸è§¦å‘å¡ç‰‡ç‚¹å‡»äº‹ä»¶
                    if (e.target.closest('.download-history-btn')) {
                        return;
                    }
                    showHistoryDetail(sortedTasks[index]);
                });
            });
        }

        // æ˜¾ç¤ºå†å²è®°å½•è¯¦æƒ…
        function showHistoryDetail(task) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 modal-enter';
            
            // è·å–æ‰€æœ‰ç»“æœå›¾ç‰‡
            let displayImages = [];
            if (task.ossResultImages && task.ossResultImages.length > 0) {
                displayImages = task.ossResultImages.map(item => item.ossUrl);
            } else if (task.resultImages && task.resultImages.length > 0) {
                displayImages = task.resultImages.map(item => {
                    if (typeof item === 'string') {
                        return item;
                    } else if (item && typeof item === 'object' && item.url) {
                        return item.url;
                    }
                    return null;
                }).filter(url => url !== null);
            }

            modal.innerHTML = `
                <div class="relative top-10 mx-auto p-6 border w-11/12 max-w-3xl shadow-xl rounded-lg bg-white">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-gray-900">ç¼–è¾‘è¯¦æƒ…</h3>
                        <button class="close-modal text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 transition-colors">
                            <i class="ri-close-line text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <i class="ri-edit-line text-blue-600 mr-2"></i>
                                <label class="text-sm font-medium text-blue-900">ç¼–è¾‘æŒ‡ä»¤</label>
                            </div>
                            <p class="text-sm text-gray-800 leading-relaxed">${getCleanPrompt(task.prompt)}</p>
                        </div>
                        
                        ${task.negativePrompt ? `
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-center mb-2">
                                    <i class="ri-forbid-line text-red-600 mr-2"></i>
                                    <label class="text-sm font-medium text-red-900">è´Ÿé¢æç¤º</label>
                                </div>
                                <p class="text-sm text-gray-800 leading-relaxed">${task.negativePrompt}</p>
                            </div>
                        ` : ''}
                        
                        
                        ${displayImages.length > 0 ? `
                            <div>
                                <div class="flex items-center mb-4">
                                    <i class="ri-image-line text-green-600 mr-2"></i>
                                    <label class="text-sm font-medium text-green-900">ç¼–è¾‘ç»“æœ (${displayImages.length}å¼ )</label>
                                </div>
                                <div class="space-y-4">
                                    ${displayImages.map((url, index) => `
                                        <div class="relative group bg-gray-50 rounded-lg p-4">
                                            <div class="text-center">
                                                <div class="text-xs text-gray-500 mb-2">ç»“æœå›¾ ${index + 1}</div>
                                                <div class="inline-block relative">
                                                    <img src="${url}" alt="ç¼–è¾‘ç»“æœ ${index + 1}" 
                                                         class="max-w-full max-h-80 object-contain rounded border shadow-sm" 
                                                         style="min-height: 100px;">
                                                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button class="bg-white bg-opacity-90 hover:bg-opacity-100 text-indigo-600 p-2 rounded-full shadow-md hover:shadow-lg transition-all" 
                                                                onclick="event.stopPropagation(); downloadHistoryImage('${url}', 'ç¼–è¾‘ç»“æœ_${index + 1}_${task.taskId || Date.now()}.png')"
                                                                title="ä¸‹è½½å›¾ç‰‡">
                                                            <i class="ri-download-line text-sm"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="bg-gray-50 rounded-lg p-4 border-t">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                <div class="flex items-center">
                                    <i class="ri-time-line text-gray-500 mr-2"></i>
                                    <span class="text-gray-600">${new Date(task.createdAt).toLocaleString('zh-CN')}</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="ri-coin-line text-gray-500 mr-2"></i>
                                    <span class="text-gray-600">ç§¯åˆ†: ${task.isFree ? '0ï¼ˆå…è´¹ï¼‰' : task.creditCost}${task.resultImages && task.resultImages.length > 1 ? ` (${task.resultImages.length}å¼ Ã—7ç§¯åˆ†)` : ''}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // å…³é—­æ¨¡æ€æ¡†äº‹ä»¶
            modal.querySelector('.close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // ä¸‹è½½å†å²è®°å½•å›¾ç‰‡
        function downloadHistoryImage(imageUrl, fileName) {
            try {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = fileName || `ç¼–è¾‘ç»“æœ_${Date.now()}.png`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('å†å²å›¾ç‰‡ä¸‹è½½æˆåŠŸ:', fileName);
            } catch (error) {
                console.error('å†å²å›¾ç‰‡ä¸‹è½½å¤±è´¥:', error);
                alert(typeof translate === 'function' ? translate('qwen_image_edit.download_failed') : 'å›¾ç‰‡ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ¸…ç©ºç¼–è¾‘å†å²è®°å½•
        async function clearEditHistory() {
            const confirmText = typeof translate === 'function' ? translate('qwen_image_edit.confirm_clear_history') : 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å›¾åƒç¼–è¾‘å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚';
            if (!confirm(confirmText)) {
                return;
            }

            const clearBtn = document.getElementById('clear-history-btn');
            const originalText = clearBtn.innerHTML;
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const clearingText = typeof translate === 'function' ? translate('qwen_image_edit.processing') : 'æ¸…ç©ºä¸­...';
                clearBtn.innerHTML = `<i class="ri-loader-4-line animate-spin mr-1"></i>${clearingText}`;
                clearBtn.disabled = true;

                // è°ƒç”¨åç«¯APIæ¸…ç©ºå†å²è®°å½•
                const response = await fetch('/api/qwen-image-edit/clear-history', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    console.log('å›¾åƒç¼–è¾‘å†å²è®°å½•å·²æ¸…ç©º');
                    
                    // æ¸…ç©ºå†å²è®°å½•æ˜¾ç¤ºåŒºåŸŸ
                    const historyArea = document.getElementById('historyArea');
                    historyArea.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="ri-history-line text-3xl mb-2"></i>
                            <p>${typeof translate === 'function' ? translate('qwen_image_edit.no_history') : 'æš‚æ— ç¼–è¾‘å†å²'}</p>
                        </div>
                    `;
                    
                    alert(typeof translate === 'function' ? translate('qwen_image_edit.history_cleared') : 'å›¾åƒç¼–è¾‘å†å²è®°å½•å·²æ¸…ç©ºï¼');
                } else {
                    throw new Error(result.message || 'æ¸…ç©ºå†å²è®°å½•å¤±è´¥');
                }

            } catch (error) {
                console.error('æ¸…ç©ºå†å²è®°å½•å¤±è´¥:', error);
                alert(typeof translate === 'function' ? translate('qwen_image_edit.clear_history_failed') : 'æ¸…ç©ºå†å²è®°å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                clearBtn.innerHTML = originalText;
                clearBtn.disabled = false;
            }
        }

        // ä¿å­˜å›¾ç‰‡åˆ°ä¸‹è½½ä¸­å¿ƒ
        async function saveToDownloadCenter(imageUrl, type, title, description) {
            try {
                // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    throw new Error('è¯·å…ˆç™»å½•å†ä¿å­˜å›¾ç‰‡');
                }
                
                console.log('ä¿å­˜å›¾ç‰‡åˆ°ä¸‹è½½ä¸­å¿ƒ:', {
                    imageUrl: imageUrl ? imageUrl.substring(0, 50) + '...' : 'æ— ',
                    type: type,
                    title: title,
                    description: description
                });
                
                const response = await fetch('/api/downloads/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        imageUrl: imageUrl,
                        type: type,
                        title: title,
                        description: description,
                        saveAction: 'manual'
                    })
                });

                console.log('ä¿å­˜å“åº”çŠ¶æ€:', response.status);
                
                const result = await response.json();
                console.log('ä¿å­˜å“åº”æ•°æ®:', result);
                
                if (!response.ok) {
                    throw new Error(result.message || result.error || `HTTP ${response.status}: ä¿å­˜å¤±è´¥`);
                }
                
                if (result.success) {
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    const toast = document.createElement('div');
                    toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
                    toast.textContent = typeof translate === 'function' ? translate('qwen_image_edit.save_to_download_center') : 'å›¾ç‰‡å·²ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒ';
                    document.body.appendChild(toast);
                    
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 3000);
                } else {
                    throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜åˆ°ä¸‹è½½ä¸­å¿ƒå¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50';
                const saveFailedText = typeof translate === 'function' ? translate('qwen_image_edit.save_failed').replace('{error}', error.message) : 'ä¿å­˜å¤±è´¥: ' + error.message;
                toast.textContent = saveFailedText;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 3000);
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†è½®è¯¢
        window.addEventListener('beforeunload', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });

        // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶ï¼ˆä»homeé¡µé¢åˆ‡æ¢è¯­è¨€æ—¶è§¦å‘ï¼‰
        document.addEventListener('languageChanged', function(event) {
            console.log('å›¾åƒç¼–è¾‘é¡µé¢ï¼šè¯­è¨€å·²åˆ‡æ¢ä¸º', event.detail ? event.detail.language : localStorage.getItem('language'));
            // translations.js ä¼šè‡ªåŠ¨æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-translate å±æ€§çš„å…ƒç´ 
            if (typeof updatePageText === 'function') {
                updatePageText();
            }
            // æ›´æ–°selecté€‰é¡¹çš„æ–‡æœ¬
            updateSelectOptions();
            // æ›´æ–°ç§¯åˆ†æ¶ˆè€—æ˜¾ç¤º
            updateCreditCost();
        });

        // æ›´æ–°selecté€‰é¡¹çš„æ–‡æœ¬
        function updateSelectOptions() {
            const select = document.getElementById('outputCountInput');
            if (select && typeof translate === 'function') {
                const options = select.querySelectorAll('option');
                options.forEach((option, index) => {
                    const value = option.value;
                    const key = `qwen_image_edit.output_count_${value}`;
                    option.textContent = translate(key);
                });
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç¿»è¯‘
        if (typeof translate === 'function' && typeof updatePageText === 'function') {
            // ç­‰å¾…translations.jsåŠ è½½å®Œæˆ
            setTimeout(() => {
                updatePageText();
                updateSelectOptions();
                updateCreditCost();
            }, 100);
        }
    </script>
</body>
</html>
