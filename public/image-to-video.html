<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="image_to_video.page_title">å›¾ç”Ÿè§†é¢‘ - è¤ç«.AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="/components/styles.css">
    <link href="/css/image-to-video.css" rel="stylesheet">
    <style>
    </style>

    <link rel="icon" href="/images/favicon.png" type="image/png">
    <script src="/js/auth-check.js"></script>
    <script src="/js/mobile-guard.js"></script>
    <script src="/translations.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- ç®€åŒ–ç‰ˆå¯¼èˆªæ  -->
    <div id="navbar-simple"></div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="container mx-auto py-8 px-4" style="margin-top: 60px;">
        <h1 class="text-3xl font-bold text-center mb-8" data-translate="image_to_video.main_title">å›¾ç”Ÿè§†é¢‘</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- å·¦ä¾§é¢æ¿: ä¸Šä¼ å›¾ç‰‡å’Œæç¤ºè¯ -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-bold mb-4" data-translate="image_to_video.upload_title">ä¸Šä¼ å›¾ç‰‡</h2>
                
                <div id="upload-area" class="upload-area h-36 flex flex-col items-center justify-center mb-2 bg-gray-50">
                    <i class="ri-upload-cloud-line text-2xl text-gray-400 mb-1"></i>
                    <p class="text-gray-500 text-center text-sm px-2" data-translate="image_to_video.upload_description">ç‚¹å‡»æˆ–è€…æ‹–åŠ¨æ–‡ä»¶åˆ°è¿™åŒºåŸŸæ¥ä¸Šä¼ </p>
                    <input type="file" id="image-upload" class="hidden" accept="image/*">
                </div>
                <p class="text-xs text-gray-500 mb-4" data-translate="image_to_video.upload_size_limit">ä¸Šä¼ å›¾ç‰‡çš„å¤§å°ä¸èƒ½å¤§äº30M</p>
                
                <div id="original-image-container" class="h-48 bg-gray-100 rounded-md flex items-center justify-center overflow-hidden mb-4 hidden">
                    <img id="original-image" class="max-w-full max-h-full object-contain" alt="ä¸Šä¼ çš„å›¾ç‰‡">
                </div>
                
                <div class="mb-6">
                    <label for="prompt" class="block text-sm font-medium text-gray-700 mb-1" data-translate="image_to_video.prompt_label">æç¤ºè¯</label>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700" data-translate="image_to_video.prompt_description">è¾“å…¥æç¤ºè¯</span>
                        <a href="#" class="text-xs text-indigo-600 hover:text-indigo-800" id="prompt-guide-link" data-translate="image_to_video.prompt_guide">æç¤ºè¯è¯¦ç»†æ•™ç¨‹</a>
                    </div>
                    <textarea id="prompt" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" data-translate-placeholder="image_to_video.prompt_placeholder" placeholder="è¯·è¾“å…¥è¯¦ç»†çš„è§†é¢‘åœºæ™¯æè¿°ï¼Œä¾‹å¦‚ï¼šæ¨¡ç‰¹é¢å¸¦å¾®ç¬‘ï¼Œå‘å‰èµ°ä¸¤æ­¥ï¼Œæ‰‹ä¿æŒè‡ªç„¶ï¼Œè¿è¡£è£™ä¹Ÿè·Ÿç€æ­¥ä¼åŠ¨"></textarea>
                    <p class="mt-1 text-xs text-gray-500" data-translate="image_to_video.prompt_tip">è¯¦ç»†ã€å…·ä½“çš„æè¿°å¯ä»¥è·å¾—æ›´å¥½çš„æ•ˆæœ</p>
                </div>
                    
                    <!-- æ™ºèƒ½æ”¹å†™å¼€å…³ -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-sm font-medium text-gray-700" data-translate="image_to_video.smart_rewrite_label">æ™ºèƒ½æ”¹å†™</label>
                        <div class="relative inline-block w-12 align-middle">
                            <input type="checkbox" id="prompt-expansion" class="sr-only peer" checked>
                            <div id="toggle-background" class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-indigo-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mb-3" data-translate="image_to_video.smart_rewrite_description">å¼€å¯åä½¿ç”¨è€…åœ¨ä¸Šæ–¹è¾“å…¥çš„æç¤ºè¯è¿›è¡Œæ™ºèƒ½æ”¹å†™ï¼Œå¯¹äºè¾ƒçŸ­çš„æç¤ºè¯ç”Ÿæˆæ•ˆæœä¼šæå‡æ˜æ˜¾ï¼Œä½†ç”Ÿæˆç»“æœä¼šåç¦»åŸæ„ã€‚</p>
                </div>
                
                <button id="generate-btn" class="w-full bg-indigo-600 text-white py-3 rounded-md hover:bg-indigo-700 flex items-center justify-center">
                    <i class="ri-movie-2-line mr-2"></i>
                    <span data-translate="image_to_video.generate_button">ç”Ÿæˆè§†é¢‘</span>
                </button>
                <p class="mt-2 text-center text-sm text-gray-500" data-translate="image_to_video.generate_info">
                    è§†é¢‘ç”Ÿæˆéœ€è¦3-5åˆ†é’Ÿï¼Œæ¶ˆè€—66ç§¯åˆ†
                </p>
                <p class="mt-2 text-center text-sm text-red-500" data-translate="image_to_video.warning_text">
                    è¯·ä¸Šä¼ åˆæ³•åˆè§„çš„å›¾ç‰‡è§†é¢‘ï¼Œå¦‚æœ‰è¿åä¼šè¿›è¡Œå°å·å¤„ç†ï¼Œä»»åŠ¡ä¸€æ—¦æäº¤å°±ä¼šæ‰£é™¤ç§¯åˆ†ä¸å¯ä¸­æ–­ï¼Œè¯·å‹¿é‡å¤åˆ·æ–°æäº¤ï¼Œå¦åˆ™ä¼šé€ æˆç§¯åˆ†æµªè´¹ã€‚
                </p>
            </div>
            
            <!-- å³ä¾§é¢æ¿: è§†é¢‘é¢„è§ˆå’Œå†å²è®°å½• -->
            <div class="lg:col-span-3 space-y-8">
                <!-- é¢„è§ˆåŒºåŸŸ -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h2 class="text-xl font-bold mb-4" data-translate="image_to_video.preview_title">è§†é¢‘é¢„è§ˆ</h2>
                    <div id="preview-container" class="video-preview flex items-center justify-center border border-gray-200 rounded-md overflow-hidden">
                        <div class="text-center p-6">
                            <i class="ri-movie-2-line text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500" data-translate="image_to_video.preview_placeholder">æ‚¨ç”Ÿæˆçš„è§†é¢‘å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                        </div>
                    </div>
                </div>
                
                <!-- ä»»åŠ¡åˆ—è¡¨ -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-bold" data-translate="image_to_video.tasks_title">ä»»åŠ¡åˆ—è¡¨</h2>
                            <p class="text-sm text-gray-500 mt-1" data-translate="image_to_video.tasks_description">ä»…æ˜¾ç¤º24å°æ—¶å†…çš„æœ€æ–°1æ¡è®°å½•</p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="clear-all-tasks-global-btn" class="text-red-600 hover:text-red-800 text-sm px-3 py-1 border border-red-300 rounded-md">
                                <i class="ri-delete-bin-line mr-1"></i><span data-translate="image_to_video.clear_all">æ¸…ç©ºæ‰€æœ‰</span>
                            </button>
                            <button id="refresh-tasks-btn" class="text-indigo-600 hover:text-indigo-800" data-translate-title="image_to_video.refresh_tasks" title="åˆ·æ–°ä»»åŠ¡åˆ—è¡¨">
                                <i class="ri-refresh-line text-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div id="tasks-container" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            <p data-translate="image_to_video.no_tasks">æš‚æ— è§†é¢‘ç”Ÿæˆè®°å½•</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½ä¸­é®ç½© -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl flex flex-col items-center">
            <div class="loading-spinner mb-4"></div>
            <p id="loading-message" class="text-lg font-medium" data-translate="image_to_video.loading_message">è§†é¢‘ç”Ÿæˆä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...</p>
            <p class="text-sm text-gray-500 mt-2" data-translate="image_to_video.loading_time">è§†é¢‘ç”Ÿæˆéœ€è¦3-5åˆ†é’Ÿ</p>
        </div>
    </div>

    <!-- æç¤ºè¯æ•™ç¨‹æ¨¡æ€æ¡† -->
    <div id="prompt-tutorial-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-tutorial">&times;</span>
            <div class="tutorial-content">
                <h2 class="text-2xl font-bold mb-4">æç¤ºè¯ä½¿ç”¨æŒ‡å—</h2>
                
                <p>æç¤ºè¯ç”¨æ¥æè¿°è§†é¢‘ä¸­æ‰€åŒ…å«çš„å†…å®¹å’Œè¿åŠ¨è¿‡ç¨‹ï¼Œå®ƒæ˜¯æ§åˆ¶è§†é¢‘ç”»é¢å†…å®¹ä¸æ•ˆæœçš„å…³é”®å› ç´ ã€‚æç¤ºè¯æè¿°è¶Šå®Œæ•´ã€ç²¾ç¡®å’Œä¸°å¯Œï¼Œç”Ÿæˆè§†é¢‘çš„å“è´¨è¶Šé«˜ï¼Œä¸”è¶Šè´´è¿‘æœŸæœ›ç”Ÿæˆçš„å†…å®¹ã€‚ä¸ºäº†å¸®åŠ©æ‚¨æ›´å¿«ä¸Šæ‰‹ï¼Œæˆ‘ä»¬é’ˆå¯¹ä¸åŒçš„ä½¿ç”¨éœ€æ±‚æä¾›äº†å››ç§æç¤ºè¯ä½¿ç”¨å…¬å¼ï¼š</p>
                
                <h3 class="text-xl font-medium">åŸºç¡€å…¬å¼</h3>
                <p><strong>é¢å‘ç”¨æˆ·ï¼š</strong>é€‚ç”¨äºåˆæ¬¡å°è¯•AIè§†é¢‘çš„æ–°ç”¨æˆ·ï¼ŒåŠå°†AIè§†é¢‘ä½œä¸ºçµæ„Ÿå¯å‘çš„ç”¨æˆ·ï¼Œç®€å•è‡ªç”±çš„æç¤ºè¯å¯ç”Ÿæˆæ›´å…·æœ‰æƒ³è±¡åŠ›çš„è§†é¢‘ã€‚</p>
                <div class="formula">
                    <p class="font-medium">æç¤ºè¯ = ä¸»ä½“ + åœºæ™¯ + è¿åŠ¨</p>
                </div>
                
                <ul class="list-disc ml-6 mb-4 text-gray-700">
                    <li><strong>ä¸»ä½“ï¼š</strong>ä¸»ä½“æ˜¯è§†é¢‘å†…å®¹çš„ä¸»è¦è¡¨ç°å¯¹è±¡ï¼Œå¯ä»¥æ˜¯äººã€åŠ¨ç‰©ã€æ¤ç‰©ã€ç‰©å“æˆ–éç‰©ç†çœŸå®å­˜åœ¨çš„æƒ³è±¡ç‰©ä½“ã€‚</li>
                    <li><strong>åœºæ™¯ï¼š</strong>åœºæ™¯æ˜¯ä¸»ä½“æ‰€å¤„çš„ç¯å¢ƒï¼ŒåŒ…å«èƒŒæ™¯ã€å‰æ™¯ï¼Œå¯ä»¥æ˜¯ç‰©ç†å­˜åœ¨çš„çœŸå®ç©ºé—´æˆ–æƒ³è±¡å‡ºæ¥çš„è™šæ„åœºæ™¯ã€‚</li>
                    <li><strong>è¿åŠ¨ï¼š</strong>è¿åŠ¨åŒ…å«ä¸»ä½“çš„å…·ä½“è¿åŠ¨å’Œéä¸»ä½“çš„è¿åŠ¨çŠ¶æ€ï¼Œå¯ä»¥æ˜¯é™æ­¢ã€å°å¹…åº¦è¿åŠ¨ã€å¤§å¹…åº¦è¿åŠ¨ã€å±€éƒ¨è¿åŠ¨æˆ–æ•´ä½“åŠ¨åŠ¿ã€‚</li>
                </ul>
                
                <h3 class="text-xl font-medium">è¿›é˜¶å…¬å¼</h3>
                <p><strong>é¢å‘ç”¨æˆ·ï¼š</strong>é€‚ç”¨äºæœ‰ä¸€å®šAIè§†é¢‘ä½¿ç”¨ç»éªŒçš„ç”¨æˆ·ï¼Œåœ¨åŸºç¡€å…¬å¼ä¹‹ä¸Šæ·»åŠ æ›´ä¸°å¯Œç»†è‡´çš„æè¿°å¯æœ‰æ•ˆæå‡è§†é¢‘è´¨æ„Ÿã€ç”ŸåŠ¨æ€§ä¸æ•…äº‹æ€§ã€‚</p>
                <div class="formula">
                    <p class="font-medium">æç¤ºè¯ = ä¸»ä½“ï¼ˆä¸»ä½“æè¿°ï¼‰+ åœºæ™¯ï¼ˆåœºæ™¯æè¿°ï¼‰+ è¿åŠ¨ï¼ˆè¿åŠ¨æè¿°ï¼‰+ é•œå¤´è¯­è¨€ + æ°›å›´è¯ + é£æ ¼åŒ–</p>
                </div>
                
                <div class="example">
                    <p>ä¾‹å¦‚ï¼šä¸€åªæ©˜çŒ«ï¼ˆæ¯›å‘è“¬æ¾ï¼Œå¤§çœ¼ç›ï¼‰åœ¨é˜³å…‰æ˜åªšçš„å®¢å…ï¼ˆæœ¨åœ°æ¿ï¼Œç™½è‰²æ²™å‘ï¼‰ç©è€ï¼ˆè¿½é€ä¸€ä¸ªçº¢è‰²æ¯›çº¿çƒï¼‰ï¼Œç‰¹å†™é•œå¤´ï¼Œæ¸©é¦¨æ°›å›´ï¼Œå†™å®é£æ ¼</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let tasks = [];
        let pollingIntervals = {};
        let currentImage = null;
        let currentPrompt = '';
        let currentTaskId = null;
        let isGenerating = false;
        
        document.addEventListener('DOMContentLoaded', async function() {
            // åŠ è½½å¯¼èˆªæ ç»„ä»¶
            try {
                const navbarResponse = await fetch('/components/navbar-simple.html');
                const navbarHtml = await navbarResponse.text();
                document.getElementById('navbar-simple').innerHTML = navbarHtml;
                
                // åŠ è½½ç»„ä»¶JavaScript
                const componentsScript = document.createElement('script');
                componentsScript.src = '/components/components.js';
                document.head.appendChild(componentsScript);
            } catch (error) {
                console.error('åŠ è½½å¯¼èˆªæ ç»„ä»¶å¤±è´¥:', error);
            }
            
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            if (typeof window.checkAuth === 'function') {
                try {
                    const isAuthenticated = await window.checkAuth(true);
                    if (!isAuthenticated) {
                        return; // checkAuthä¼šè‡ªåŠ¨å¤„ç†é‡å®šå‘
                    }
                } catch (error) {
                    console.error('è®¤è¯æ£€æŸ¥å‡ºé”™:', error);
                }
            }
            
            // DOMå…ƒç´ 
            const uploadArea = document.getElementById('upload-area');
            const imageUpload = document.getElementById('image-upload');
            const originalImage = document.getElementById('original-image');
            const originalImageContainer = document.getElementById('original-image-container');
            const promptInput = document.getElementById('prompt');
            const promptExpansion = document.getElementById('prompt-expansion');
            const generateBtn = document.getElementById('generate-btn');
            const previewContainer = document.getElementById('preview-container');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingMessage = document.getElementById('loading-message');
            const tasksContainer = document.getElementById('tasks-container');
            const refreshTasksBtn = document.getElementById('refresh-tasks-btn');
            const clearAllTasksBtn = document.getElementById('clear-all-tasks-global-btn');
            const promptGuideLink = document.getElementById('prompt-guide-link');
            const promptTutorialModal = document.getElementById('prompt-tutorial-modal');
            const closeTutorial = document.getElementById('close-tutorial');
            
            // åˆå§‹åŒ–é¡µé¢
            loadUserTasks();
            
            // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            uploadArea.addEventListener('click', function() {
                imageUpload.click();
            });
            
            // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            imageUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 30 * 1024 * 1024) {
                        alert(typeof translate === 'function' ? translate('image_to_video.image_too_large') : 'å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡30MB');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        originalImage.src = e.target.result;
                        originalImage.classList.remove('hidden');
                        originalImageContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
                
            // æ‹–æ‹½äº‹ä»¶
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('border-indigo-500', 'bg-indigo-50');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                this.classList.remove('border-indigo-500', 'bg-indigo-50');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('border-indigo-500', 'bg-indigo-50');
                
                const file = e.dataTransfer.files[0];
                if (file) {
                    if (file.type.startsWith('image/')) {
                        if (file.size > 30 * 1024 * 1024) {
                            alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡30MB');
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            originalImage.src = e.target.result;
                            originalImage.classList.remove('hidden');
                            originalImageContainer.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                        
                        // å°†æ–‡ä»¶è®¾ç½®åˆ°æ–‡ä»¶è¾“å…¥æ¡†
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        imageUpload.files = dataTransfer.files;
                    } else {
                        alert(typeof translate === 'function' ? translate('image_to_video.upload_image_file') : 'è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
                    }
                }
            });
            
            // ç”ŸæˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            generateBtn.addEventListener('click', async function() {
                if (!imageUpload.files[0]) {
                    alert(typeof translate === 'function' ? translate('image_to_video.upload_image_first') : 'è¯·å…ˆä¸Šä¼ å›¾ç‰‡');
                    return;
                }
                
                if (!promptInput.value.trim()) {
                    alert(typeof translate === 'function' ? translate('image_to_video.enter_prompt') : 'è¯·è¾“å…¥æç¤ºè¯');
                    return;
                }
                
                await generateVideo();
            });
            
            
            // åˆ·æ–°ä»»åŠ¡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            refreshTasksBtn.addEventListener('click', function() {
                loadUserTasks();
            });
            
            // æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            clearAllTasksBtn.addEventListener('click', function() {
                const confirmText = typeof translate === 'function' ? translate('image_to_video.clear_all_confirm') : 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼';
                if (confirm(confirmText)) {
                    clearAllTasks();
                }
            });
            
            // æç¤ºè¯æ•™ç¨‹é“¾æ¥ç‚¹å‡»äº‹ä»¶
            promptGuideLink.addEventListener('click', function(e) {
                e.preventDefault();
                promptTutorialModal.style.display = 'block';
            });
            
            // å…³é—­æ•™ç¨‹æ¨¡æ€æ¡†
            closeTutorial.addEventListener('click', function() {
                promptTutorialModal.style.display = 'none';
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(e) {
                if (e.target === promptTutorialModal) {
                    promptTutorialModal.style.display = 'none';
                }
            });
            
            // ğŸ”§ é˜²é‡å¤ç‚¹å‡»æ ‡å¿—
            let isGenerating = false;
            
            // ç”Ÿæˆè§†é¢‘
            async function generateVideo() {
                try {
                    // ğŸ”§ é˜²é‡å¤ç‚¹å‡»æ£€æŸ¥
                    if (isGenerating) {
                        console.log('æ­£åœ¨ç”Ÿæˆä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
                        return;
                    }
                    
                    // è®¾ç½®ç”Ÿæˆä¸­æ ‡å¿—
                    isGenerating = true;
                    
                    // ç¦ç”¨ç”ŸæˆæŒ‰é’®
                    const generateBtn = document.getElementById('generate-btn');
                    if (generateBtn) {
                        generateBtn.disabled = true;
                        const generatingText = typeof translate === 'function' ? translate('image_to_video.generating') : 'ç”Ÿæˆä¸­...';
                        const generateBtnText = generateBtn.querySelector('span');
                        if (generateBtnText) {
                            generateBtnText.textContent = generatingText;
                        } else {
                            generateBtn.textContent = generatingText;
                        }
                    }
                    
                    // æ˜¾ç¤ºåŠ è½½é®ç½©
                    loadingOverlay.classList.remove('hidden');
                    loadingMessage.textContent = typeof translate === 'function' ? translate('image_to_video.submitting') : 'æ­£åœ¨æäº¤è§†é¢‘ç”Ÿæˆè¯·æ±‚...';
                    
                    // ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ å›¾ç‰‡è·å–URL
                    console.log('å¼€å§‹ä¸Šä¼ å›¾ç‰‡...');
                    const imageFormData = new FormData();
                    imageFormData.append('image', imageUpload.files[0]);
                    
                    const uploadResponse = await fetch('/api/text-to-video/upload-image', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: imageFormData
                    });
                    
                    const uploadData = await uploadResponse.json();
                    
                    if (!uploadResponse.ok) {
                        throw new Error(uploadData.message || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
                    }
                    
                    console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼ŒURL:', uploadData.imageUrl);
                    
                    // ç¬¬äºŒæ­¥ï¼šä½¿ç”¨å›¾ç‰‡URLè°ƒç”¨å›¾ç”Ÿè§†é¢‘API
                    const videoRequestData = {
                        model: "wanx2.1-i2v-turbo",
                        input: {
                            prompt: promptInput.value,
                            img_url: uploadData.imageUrl
                        },
                        parameters: {
                            usePromptExpansion: promptExpansion.checked,
                            duration: 5
                        }
                    };
                    
                    console.log('å‘é€å›¾ç”Ÿè§†é¢‘è¯·æ±‚:', videoRequestData);
                    
                    const response = await fetch('/api/image-to-video/image-to-video', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(videoRequestData)
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'è§†é¢‘ç”Ÿæˆè¯·æ±‚å¤±è´¥');
                    }
                    
                    // æ›´æ–°åŠ è½½æ¶ˆæ¯
                    loadingMessage.textContent = typeof translate === 'function' ? translate('image_to_video.task_submitted') : 'è§†é¢‘ç”Ÿæˆä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†ä¸­...';
                    
                    // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    const taskId = data.output.task_id;
                    currentTaskId = taskId;
                    
                    // åˆ›å»ºæ–°ä»»åŠ¡å¯¹è±¡
                    const newTask = {
                        id: taskId,
                        prompt: promptInput.value,
                        status: 'PROCESSING',
                        createdAt: new Date().toISOString(),
                        videoUrl: null
                    };
                    
                    // æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨ï¼ˆåªä¿ç•™æœ€æ–°1æ¡ï¼‰
                    tasks = [newTask];
                    renderTasks();
                    
                    // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    pollTaskStatus(taskId);
                    
                    // åœ¨é¢„è§ˆåŒºåŸŸæ˜¾ç¤ºä»»åŠ¡è¿›åº¦
                    showGenerationProgress({
                        id: taskId,
                        prompt: promptInput.value,
                        status: 'PENDING',
                        createdAt: new Date().toISOString()
                    });
                    
                    // ç«‹å³æ»šåŠ¨åˆ°é¢„è§ˆåŒºåŸŸï¼Œè®©ç”¨æˆ·çœ‹åˆ°ç”Ÿæˆè¿›åº¦
                    previewContainer.scrollIntoView({ behavior: 'smooth' });
                    
                    // éšè—åŠ è½½é®ç½©ï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        loadingOverlay.classList.add('hidden');
                        const successText = typeof translate === 'function' ? translate('image_to_video.task_submitted_success') : 'è§†é¢‘ç”Ÿæˆä»»åŠ¡å·²æäº¤ï¼Œæ­£åœ¨åå°å¤„ç†...';
                        showToast(successText, 'success');
                        
                        // ğŸ”§ é‡ç½®é˜²é‡å¤ç‚¹å‡»æ ‡å¿—å’ŒæŒ‰é’®çŠ¶æ€
                        isGenerating = false;
                        const generateBtn = document.getElementById('generate-btn');
                        if (generateBtn) {
                            generateBtn.disabled = false;
                            const generateButtonText = typeof translate === 'function' ? translate('image_to_video.generate_button') : 'ç”Ÿæˆè§†é¢‘';
                            const generateBtnText = generateBtn.querySelector('span');
                            if (generateBtnText) {
                                generateBtnText.textContent = generateButtonText;
                            } else {
                                generateBtn.textContent = generateButtonText;
                            }
                        }
                    }, 1500);
                    
            } catch (error) {
                    console.error('ç”Ÿæˆè§†é¢‘å‡ºé”™:', error);
                    const failedText = typeof translate === 'function' ? translate('image_to_video.generate_failed') : 'ç”Ÿæˆè§†é¢‘å¤±è´¥';
                    alert(failedText + ': ' + error.message);
                    loadingOverlay.classList.add('hidden');
                    
                    // ğŸ”§ é‡ç½®é˜²é‡å¤ç‚¹å‡»æ ‡å¿—å’ŒæŒ‰é’®çŠ¶æ€
                    isGenerating = false;
                    const generateBtn = document.getElementById('generate-btn');
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        const generateButtonText = typeof translate === 'function' ? translate('image_to_video.generate_button') : 'ç”Ÿæˆè§†é¢‘';
                        const generateBtnText = generateBtn.querySelector('span');
                        if (generateBtnText) {
                            generateBtnText.textContent = generateButtonText;
                        } else {
                            generateBtn.textContent = generateButtonText;
                        }
                    }
            }
            }
            
            // è½®è¯¢ä»»åŠ¡çŠ¶æ€
            function pollTaskStatus(taskId) {
                // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢
                if (pollingIntervals[taskId]) {
                    clearInterval(pollingIntervals[taskId]);
                }
                
                pollingIntervals[taskId] = setInterval(async function() {
                    try {
                        const response = await fetch(`/api/tasks/${taskId}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(data.message || 'æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥');
                        }
                        
                        // æ ¹æ®ä»»åŠ¡çŠ¶æ€å¤„ç†
                        const taskStatus = data.output?.task_status || data.status;
                        console.log('ä»»åŠ¡çŠ¶æ€:', taskStatus);
                        
                        // æ›´æ–°é¢„è§ˆåŒºåŸŸæ˜¾ç¤º
                        showGenerationProgress({
                            id: taskId,
                            prompt: promptInput.value,
                            status: taskStatus,
                            createdAt: new Date().toISOString()
                        });
                        
                        switch (taskStatus) {
                            case 'SUCCEEDED':
                                clearInterval(pollingIntervals[taskId]);
                                delete pollingIntervals[taskId];
                                const videoUrl = data.output?.video_url || data.output?.result_url || data.result?.videoUrl;
                                if (videoUrl) {
                                    showVideoPreview(videoUrl, taskId);
                                    // æ›´æ–°ä»»åŠ¡çŠ¶æ€
                                    const taskIndex = tasks.findIndex(t => t.id === taskId);
                                    if (taskIndex !== -1) {
                                        tasks[taskIndex].status = 'SUCCEEDED';
                                        tasks[taskIndex].videoUrl = videoUrl;
                                        renderTasks();
                                    }
                                    const successText = typeof translate === 'function' ? translate('image_to_video.video_generated_success') : 'è§†é¢‘ç”ŸæˆæˆåŠŸï¼';
                                    showToast(successText, 'success');
                                } else {
                                    const missingUrlText = typeof translate === 'function' ? translate('image_to_video.video_url_missing') : 'è§†é¢‘ç”Ÿæˆå®Œæˆä½†æœªè·å–åˆ°è§†é¢‘URL';
                                    alert(missingUrlText);
                                }
                                break;
                                
                            case 'FAILED':
                                clearInterval(pollingIntervals[taskId]);
                                delete pollingIntervals[taskId];
                                const errorMsg = data.output?.message || data.error || (typeof translate === 'function' ? translate('image_to_video.video_generated_failed') : 'æœªçŸ¥é”™è¯¯');
                                // æ›´æ–°ä»»åŠ¡çŠ¶æ€
                                const taskIndex = tasks.findIndex(t => t.id === taskId);
                                if (taskIndex !== -1) {
                                    tasks[taskIndex].status = 'FAILED';
                                    renderTasks();
                                }
                                const failedText = typeof translate === 'function' ? translate('image_to_video.video_generated_failed') : 'è§†é¢‘ç”Ÿæˆå¤±è´¥';
                                alert(failedText + ': ' + errorMsg);
                                break;
                                
                            case 'PENDING':
                            case 'RUNNING':
                                // ç»§ç»­ç­‰å¾…
                                console.log('ä»»åŠ¡è¿›è¡Œä¸­ï¼Œç»§ç»­ç­‰å¾…...');
                                break;
                                
                            default:
                                console.warn('æœªçŸ¥ä»»åŠ¡çŠ¶æ€:', taskStatus);
                        }
                        
                    } catch (error) {
                        console.error('æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å‡ºé”™:', error);
                        // å‡ºé”™æ—¶ä¸åœæ­¢è½®è¯¢ï¼Œç»§ç»­å°è¯•
                    }
                }, 5000);
            }
            
            // åœ¨é¢„è§ˆåŒºåŸŸæ˜¾ç¤ºè§†é¢‘
            function showVideoPreview(videoUrl, taskId = '') {
                previewContainer.innerHTML = `
                    <video controls class="w-full h-full" data-task-id="${taskId}">
                        <source src="${videoUrl}" type="video/mp4">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾
                    </video>
                `;
                
                // ç¡®ä¿è§†é¢‘å…ƒç´ åŠ è½½å¹¶æ­£ç¡®æ˜¾ç¤º
                const videoElement = previewContainer.querySelector('video');
                videoElement.addEventListener('loadedmetadata', () => {
                    // è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆï¼Œç¡®ä¿å®½é«˜é€‚é…å®¹å™¨
                    videoElement.style.maxHeight = '100%';
                    videoElement.style.maxWidth = '100%';
                    videoElement.style.objectFit = 'contain';
                });
                
                videoElement.addEventListener('error', () => {
                    // è§†é¢‘åŠ è½½å‡ºé”™å¤„ç†
                    console.error('è§†é¢‘åŠ è½½å¤±è´¥:', videoUrl);
                    const loadFailedText = typeof translate === 'function' ? translate('image_to_video.video_load_failed') : 'è§†é¢‘åŠ è½½å¤±è´¥';
                    const loadFailedDesc = typeof translate === 'function' ? translate('image_to_video.video_load_failed_desc') : 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è§†é¢‘é“¾æ¥æ˜¯å¦æœ‰æ•ˆ';
                    previewContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full">
                            <p class="text-lg text-red-600 text-center">${loadFailedText}</p>
                            <p class="text-sm text-gray-500 mt-2">${loadFailedDesc}</p>
                        </div>
                    `;
                });
                
                // æ»šåŠ¨åˆ°é¢„è§ˆåŒºåŸŸ
                previewContainer.scrollIntoView({ behavior: 'smooth' });
            }
            
            // æ˜¾ç¤ºç”Ÿæˆè¿›åº¦å’ŒçŠ¶æ€
            function showGenerationProgress(task) {
                if (!previewContainer) return;
                
                // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹
                if (task.status === 'SUCCEEDED' && task.videoUrl) {
                    // æˆåŠŸçŠ¶æ€æ˜¾ç¤ºè§†é¢‘
                    showVideoPreview(task.videoUrl, task.id);
                } else {
                    // å…¶ä»–çŠ¶æ€æ˜¾ç¤ºåŠ è½½åŠ¨ç”»å’ŒçŠ¶æ€ä¿¡æ¯
                    let statusText = typeof translate === 'function' ? translate('image_to_video.status_processing') : 'å‡†å¤‡ä¸­...';
                    let statusClass = 'text-gray-600';
                    
                    if (task.status === 'PENDING') {
                        statusText = typeof translate === 'function' ? translate('image_to_video.status_pending') : 'æ’é˜Ÿä¸­ï¼Œè¯·ç¨å€™...';
                        statusClass = 'text-yellow-600';
                    } else if (task.status === 'RUNNING') {
                        statusText = typeof translate === 'function' ? translate('image_to_video.status_running') : 'è§†é¢‘ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...';
                        statusClass = 'text-blue-600';
                    } else if (task.status === 'FAILED') {
                        statusText = typeof translate === 'function' ? translate('image_to_video.status_failed') : 'è§†é¢‘ç”Ÿæˆå¤±è´¥';
                        statusClass = 'text-red-600';
                    }
                    
                    previewContainer.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full">
                            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-500 mb-4"></div>
                            <p class="text-lg ${statusClass} text-center">${statusText}</p>
                            <p class="text-sm text-gray-500 mt-2">æç¤ºè¯: ${task.prompt}</p>
                        </div>
                    `;
                }
            }
            
            // æ¶ˆæ¯æç¤º
            function showToast(message, type = 'info') {
                // åˆ›å»ºtoastå…ƒç´ 
                const toast = document.createElement('div');
                
                // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
                let bgColor, textColor;
                if (type === 'success') {
                    bgColor = 'bg-green-500';
                    textColor = 'text-white';
                } else if (type === 'error') {
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                } else if (type === 'warning') {
                    bgColor = 'bg-yellow-500';
                    textColor = 'text-white';
                } else {
                    bgColor = 'bg-blue-500';
                    textColor = 'text-white';
                }
                
                toast.className = `fixed top-4 right-4 ${bgColor} ${textColor} px-4 py-2 rounded shadow-md z-50 transition-opacity duration-300 opacity-0`;
                toast.innerText = message;
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(toast);
                
                // æ˜¾ç¤ºtoast
                setTimeout(() => {
                    toast.classList.replace('opacity-0', 'opacity-100');
                }, 10);
                
                // è‡ªåŠ¨éšè—
                setTimeout(() => {
                    toast.classList.replace('opacity-100', 'opacity-0');
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }
            
            // åŠ è½½ç”¨æˆ·ä»»åŠ¡
            async function loadUserTasks() {
                try {
                    const response = await fetch('/api/image-to-video/tasks/image-to-video', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥');
                    }
                    
                    const data = await response.json();
                    tasks = data.tasks || [];
                    
                    // åªä¿ç•™æœ€è¿‘1æ¡è®°å½•
                    if (tasks.length > 1) {
                        tasks = tasks.slice(0, 1);
                    }
                    
                    renderTasks();
                } catch (error) {
                    console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
                    tasks = [];
                    renderTasks();
                }
            }
            
            // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
            function renderTasks() {
                if (tasks.length === 0) {
                    const noTasksText = typeof translate === 'function' ? translate('image_to_video.no_tasks') : 'æš‚æ— è§†é¢‘ç”Ÿæˆè®°å½•';
                    const tasksDescText = typeof translate === 'function' ? translate('image_to_video.tasks_description') : 'ä»…æ˜¾ç¤º24å°æ—¶å†…çš„æœ€æ–°1æ¡è®°å½•';
                    tasksContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p>${noTasksText}</p>
                            <p class="text-sm mt-2 text-gray-400">${tasksDescText}</p>
                        </div>
                    `;
                    return;
                }
                
                tasksContainer.innerHTML = '';
                
                tasks.forEach(task => {
                    const taskCard = createTaskCard(task);
                    tasksContainer.appendChild(taskCard);
                });
            }
            
            // åˆ›å»ºä»»åŠ¡å¡ç‰‡
            function createTaskCard(task) {
                const card = document.createElement('div');
                card.className = 'video-task bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4';
                card.setAttribute('data-task-id', task.id);
                
                const createdAt = new Date(task.createdAt);
                const formattedDate = `${createdAt.getFullYear()}-${String(createdAt.getMonth() + 1).padStart(2, '0')}-${String(createdAt.getDate()).padStart(2, '0')} ${String(createdAt.getHours()).padStart(2, '0')}:${String(createdAt.getMinutes()).padStart(2, '0')}`;
                
                let statusClass = 'bg-yellow-100 text-yellow-800';
                let statusText = typeof translate === 'function' ? translate('image_to_video.status_processing') : 'å¤„ç†ä¸­';
                
                if (task.status === 'SUCCEEDED') {
                    statusClass = 'bg-green-100 text-green-800';
                    statusText = typeof translate === 'function' ? translate('image_to_video.status_completed') : 'å·²å®Œæˆ';
                } else if (task.status === 'FAILED') {
                    statusClass = 'bg-red-100 text-red-800';
                    statusText = typeof translate === 'function' ? translate('image_to_video.status_failed') : 'å¤±è´¥';
                }
                
                // è§†é¢‘é¢„è§ˆï¼ˆä»…å½“æœ‰è§†é¢‘URLæ—¶ï¼‰
                let videoPreview = '';
                if (task.videoUrl) {
                    videoPreview = `
                        <div class="mt-3">
                            <video controls class="w-full rounded" style="max-height: 180px">
                                <source src="${task.videoUrl}" type="video/mp4">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ ‡ç­¾
                            </video>
                            <div class="flex justify-end mt-2">
                                <a href="${task.videoUrl}" class="text-indigo-600 hover:text-indigo-800 text-sm mr-3" download>
                                    <i class="ri-download-2-line mr-1"></i>${typeof translate === 'function' ? translate('image_to_video.download') : 'ä¸‹è½½'}
                                </a>
                                <button class="text-indigo-600 hover:text-indigo-800 text-sm preview-btn" data-url="${task.videoUrl}">
                                    <i class="ri-fullscreen-line mr-1"></i>${typeof translate === 'function' ? translate('image_to_video.preview') : 'é¢„è§ˆ'}
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                card.innerHTML = `
                    <div class="flex justify-between">
                        <div class="flex-1 pr-4">
                            <p class="font-medium">${task.prompt}</p>
                            <div class="flex mt-2 text-sm text-gray-500">
                                <span class="mr-4">å›¾ç”Ÿè§†é¢‘</span>
                                <span>${formattedDate}</span>
                            </div>
                        </div>
                        <div>
                            <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    ${videoPreview}
                `;
                
                // é¢„è§ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const previewBtn = card.querySelector('.preview-btn');
                if (previewBtn) {
                    previewBtn.addEventListener('click', function() {
                        showVideoPreview(task.videoUrl);
                        previewContainer.scrollIntoView({ behavior: 'smooth' });
                    });
                }
                
                return card;
            }
            
            // æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡
            async function clearAllTasks() {
                try {
                    const response = await fetch('/api/image-to-video/tasks/image-to-video', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('æ¸…ç©ºä»»åŠ¡å¤±è´¥');
                    }
                    
                    tasks = [];
                    renderTasks();
                    const clearSuccessText = typeof translate === 'function' ? translate('image_to_video.clear_all_success') : 'æ‰€æœ‰ä»»åŠ¡å·²æ¸…ç©º';
                    showToast(clearSuccessText, 'success');
                } catch (error) {
                    console.error('æ¸…ç©ºä»»åŠ¡å¤±è´¥:', error);
                    const clearFailedText = typeof translate === 'function' ? translate('image_to_video.clear_all_failed') : 'æ¸…ç©ºä»»åŠ¡å¤±è´¥';
                    showToast(clearFailedText + ': ' + error.message, 'error');
                }
            }
            
            // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶
            document.addEventListener('languageChanged', function(event) {
                console.log('å›¾ç”Ÿè§†é¢‘é¡µé¢ï¼šæ”¶åˆ°è¯­è¨€åˆ‡æ¢äº‹ä»¶:', event.detail.language);
                // é‡æ–°æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
                renderTasks();
                // æ›´æ–°é¢„è§ˆåŒºåŸŸå ä½ç¬¦æ–‡æœ¬ï¼ˆå¦‚æœé¢„è§ˆåŒºåŸŸæ˜¯ç©ºçš„ï¼‰
                updatePreviewPlaceholder();
            });
            
            // æ›´æ–°é¢„è§ˆåŒºåŸŸå ä½ç¬¦æ–‡æœ¬
            function updatePreviewPlaceholder() {
                const hasVideo = previewContainer.querySelector('video');
                if (!hasVideo) {
                    const placeholderText = typeof translate === 'function' ? translate('image_to_video.preview_placeholder') : 'æ‚¨ç”Ÿæˆçš„è§†é¢‘å°†åœ¨è¿™é‡Œæ˜¾ç¤º';
                    const placeholderDiv = previewContainer.querySelector('.text-gray-500');
                    if (placeholderDiv) {
                        const textElement = placeholderDiv.querySelector('p');
                        if (textElement) {
                            textElement.textContent = placeholderText;
                        }
                    } else {
                        previewContainer.innerHTML = `
                            <div class="text-center p-6">
                                <i class="ri-movie-2-line text-6xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500">${placeholderText}</p>
                            </div>
                        `;
                    }
                }
            }
            
            // åˆå§‹åŒ–é¢„è§ˆåŒºåŸŸå ä½ç¬¦æ–‡æœ¬
            updatePreviewPlaceholder();
        });
    </script>
</body>
</html> 