# 视频功能扣费逻辑更新指南

## 功能变更概述

我们对以下三个视频功能的扣费逻辑进行了优化，从原来的"先扣费后使用"改为"先使用后扣费"模式：

1. **文生视频 (text-to-video)**
2. **图生视频 (image-to-video)**
3. **多图转视频 (MULTI_IMAGE_TO_VIDEO)**

这种变更使这些功能与其他视频处理功能（如视频去除字幕、视频数字人、视频风格重绘）的扣费逻辑保持一致，提供更好的用户体验。

## 变更详情

### 原有逻辑

- **文生视频**：创建任务时立即扣除66积分
- **图生视频**：创建任务时立即扣除66积分
- **多图转视频**：创建任务时根据预估时长扣除积分（每30秒30积分）

### 新逻辑

- **文生视频**：
  - 创建任务时仅检查用户是否有至少20积分
  - 任务完成后扣除66积分

- **图生视频**：
  - 创建任务时仅检查用户是否有至少20积分
  - 任务完成后扣除66积分

- **多图转视频**：
  - 创建任务时仅检查用户是否有至少30积分
  - 任务完成后根据实际视频时长扣除积分（每30秒30积分）

## 实现方式

我们对以下文件进行了修改：

### 1. middleware/featureAccess.js

- 修改了功能配置，使三个功能在创建阶段返回0积分消耗
- 添加了特殊处理逻辑，在权限检查阶段仅验证用户是否有最低积分要求

```javascript
// 文生视频和图生视频配置示例
'text-to-video': { 
  creditCost: (payload) => {
    // 返回0，创建阶段不预扣积分，任务完成后再扣费
    return 0;
  }, 
  freeUsage: 1 
}, // 文生视频功能，任务完成后扣除66积分
```

### 2. middleware/unifiedFeatureUsage.js

- 修改了`saveTaskDetails`函数，添加了对这三个功能的任务完成后扣费处理
- 在任务状态为`completed`时，根据功能类型扣除相应积分

```javascript
// 处理文生视频、图生视频和多图转视频功能的积分扣除
if (taskInfo.featureName === 'text-to-video' || taskInfo.featureName === 'image-to-video') {
  // 文生视频和图生视频功能固定扣除66积分
  const fixedCost = 66;
  
  // 查找用户
  const user = await User.findByPk(usage.userId);
  if (user) {
    // 扣除积分
    const deduct = Math.min(fixedCost, user.credits);
    user.credits -= deduct;
    await user.save();
    
    // 更新使用记录中的积分消耗
    usage.credits = (usage.credits || 0) + deduct;
    await usage.save();
    
    console.log(`[任务完成] 已扣除用户 ${usage.userId} 积分 ${deduct} (功能: ${taskInfo.featureName})`);
  }
}
```

## 测试方法

我们提供了一个测试脚本`test-video-features.js`，用于验证修改后的扣费逻辑是否正确工作：

```bash
node test-video-features.js
```

此脚本会模拟三个功能的任务完成过程，并验证积分扣除是否符合预期。

## 注意事项

1. **任务完成回调机制**：确保任务完成回调正常工作，否则可能导致用户使用功能但未被扣费
2. **最低积分要求**：虽然创建任务时不扣除积分，但用户仍需满足最低积分要求
3. **免费使用次数**：免费使用次数的逻辑保持不变，仍然是每个功能提供1次免费使用机会

## 后续优化建议

1. **积分预授权**：考虑实现积分预授权机制，在任务创建时锁定一定积分，避免用户在任务处理过程中消费积分导致任务完成时积分不足
2. **任务失败处理**：完善任务失败处理逻辑，明确定义哪些失败情况需要扣费、哪些不需要
3. **超时任务处理**：添加定时任务检查长时间未完成的任务，避免资源浪费

## 联系方式

如有任何问题或需要进一步说明，请联系技术支持团队。 