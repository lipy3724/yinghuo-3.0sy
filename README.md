# 电商工具 - 图片文字翻译转换

这是一个使用Node.js开发的电商工具，主要功能是集成图片文字翻译功能。系统通过对接第三方API实现图片中文字的识别与多语言翻译。

## 功能特点

- 图片上传功能
- 对接第三方图片翻译编辑器
- 支持多种语言翻译
- 结果保存和下载

## 功能列表

- 电商工图实景图/电商海报智能生成
- 产品电商场景图/产品换场景/换背景
- 视频语音翻译
- 视频文字翻译
- 图片文字翻译转换
- 智能虚拟模特试衣
- 图像高清放大
- 跨境合规标签

## 技术栈

- 前端：HTML, CSS, JavaScript
- 后端：Node.js, Express
- 第三方集成：图片翻译编辑器API

## 安装与运行

### 前提条件

- Node.js (v12+)
- npm 或 yarn

### 安装步骤

1. 克隆或下载代码到本地

2. 安装依赖
```bash
npm install
```

3. 配置API密钥
   在`server.js`文件中，找到以下代码并替换为您的实际密钥：
```javascript
const APP_KEY = "YOUR_APP_KEY"; // 替换为实际的APP_KEY
const SECRET_KEY = "YOUR_SECRET_KEY"; // 替换为实际的SECRET_KEY
```

4. 启动服务器
```bash
npm start
```
或使用开发模式（自动重启）：
```bash
npm run dev
```

5. 访问应用
   打开浏览器访问: http://localhost:3000

## 使用说明

1. 在首页上传需要翻译的图片
2. 选择源语言和目标语言
3. 点击"打开工作台生成"按钮
4. 在打开的编辑器中可以进行进一步编辑和保存

## 使用方法

1. 直接在浏览器中打开 `index.html` 文件
2. 点击选择侧边栏中的功能
3. 根据页面指引上传图片并进行相应操作

## 文件结构

- `index.html` - 主页面HTML结构
- `styles.css` - 样式表
- `script.js` - 交互功能JavaScript代码
- `server.js` - Node.js服务器代码
- `package.json` - 项目依赖配置

## 注意事项

- 上传的图片不要超过10MB
- 请确保有稳定的网络连接，以便与翻译服务器通信
- 初次生成翻译需要一定时间，请耐心等待

## 备份和恢复

当前项目已创建以下备份文件:

1. `server.js.backup` - 服务器代码备份
2. `public/index.html.backup` - 前端页面备份

如需恢复，请使用以下命令:

```bash
# 恢复服务器代码
copy server.js.backup server.js

# 恢复前端页面
copy public\index.html.backup public\index.html

# 重启服务器
taskkill /f /im node.exe
node server.js
```

## 各功能详细说明

### 图像高清放大

图像高清放大功能允许用户将低分辨率图片提升到更高分辨率，同时保持图像清晰度和细节。本功能基于阿里云AI图像超分辨率API实现，支持2-4倍放大。

**功能特点：**
- 支持多种图片格式（JPG、PNG、WEBP等）
- 可选择2倍、4倍或自定义放大倍率
- 智能降噪和细节增强
- 自动将图片存储到阿里云OSS

**技术实现：**
- 前端：基于HTML、CSS和JavaScript实现的直观用户界面
- 后端：Node.js处理图片上传、调用阿里云API
- 存储：阿里云OSS对象存储
- API：阿里云超分辨率API（/ai/super/resolution）

**限制条件：**
- 输入图片尺寸需大于100×100像素，小于3000×3000像素
- 放大后的图片不能超过3000×3000像素
- 放大倍数范围：2-4倍

**使用方法：**
1. 在侧边栏菜单选择"图像高清放大"
2. 上传需要处理的图片（可拖拽或点击上传）
3. 选择所需的放大倍率（2-4倍）
4. 点击"开始放大"按钮
5. 等待处理完成后，可以预览和下载处理后的高清图像

**API调用示例：**
```javascript
// 上传图片到OSS
const imageUrl = await uploadToOSS(imageBuffer, fileName);

// 调用图像高清放大API
const apiResult = await callUpscaleApi(imageUrl, upscaleFactor);

// 获取处理结果
const resultImageUrl = apiResult.data.imageUrl;
```

**错误处理：**
- 如果图片尺寸不符合要求，系统会提示相应错误
- 如果API调用失败，会显示具体的错误信息
- 所有操作都有加载状态指示，提升用户体验

## AI平台功能文档

## 系统功能说明

本系统是一个提供多种AI功能的平台，包括视频数字人生成、视频风格重绘、视频字幕移除等功能。系统使用积分机制，用户每次使用功能都会消耗相应的积分。

### 积分系统

- 每个功能消耗不同数量的积分
- 系统跟踪用户功能使用情况，包括使用次数和积分消费
- 管理员可以查看所有用户的积分使用情况

### 最近重大更新 - 积分系统统一优化

#### 统一的功能使用逻辑
系统已完成对所有功能的积分扣除逻辑统一，确保每个功能都遵循相同的流程：

1. **免费次数检查**: 首先检查用户是否还有该功能的免费使用次数
2. **积分扣除**: 如果超过免费次数，则检查并扣除相应积分
3. **记录生成**: 生成准确的使用记录，包括免费/付费标记
4. **同步显示**: 确保积分使用情况页面准确显示所有使用记录

#### 已优化的功能
- **亚马逊助手系列** (17个功能): 所有亚马逊相关功能现在使用统一的积分扣除逻辑
- **图像处理功能**: 图像高清放大、多图转视频等功能
- **视频处理功能**: 视频去除字幕、数字人视频、视频风格重绘等
- **虚拟模特功能**: 智能虚拟模特试穿功能

#### 技术改进
- 创建了统一的功能使用中间件 `unifiedFeatureUsage.js`
- 移除了旧的 `featureAccess` 中间件中的积分扣除逻辑
- 所有功能现在都使用相同的积分处理流程
- 修复了积分重复扣除和记录不一致的问题

#### 最新修复 - 变量作用域问题
**修复日期**: 2024年12月14日

**问题描述**: 
视频去除字幕功能中存在变量作用域问题，`finalCreditCost` 和 `usageType` 变量在 try 块内定义，但在 catch 块外的代码中被使用，导致 `ReferenceError: finalCreditCost is not defined` 错误。

**修复内容**:
1. **视频去除字幕功能**: 将 `usageType` 和 `finalCreditCost` 变量的定义移到 try 块之前，确保在整个函数作用域内都可以访问

#### 最新完成 - 积分系统完全统一 ✅
**完成日期**: 2024年12月14日

**重大成就**: 
系统已完成所有功能的积分扣除逻辑统一，实现了真正的"检查积分是否足够 → 如果够则扣除并使用功能，如果不够则提示积分不足"的统一逻辑。

**最终修复内容**:

1. **亚马逊助手功能完全统一** ✅
   - 移除了自定义的 `createAmazonFeatureMiddleware`
   - 所有17个亚马逊助手功能现在都使用 `createUnifiedFeatureMiddleware`
   - 消除了重复的积分扣除逻辑

2. **track-usage路由优化** ✅
   - 重构了 `/api/credits/track-usage` 路由
   - 使用与统一中间件相同的积分扣除逻辑
   - 支持场景图生成、图像智能消除、AI营销图、图片翻译等功能
   - 保持了与前端页面的兼容性

3. **数字人视频功能优化** ✅
   - 实现了精确的积分计算：每秒9积分
   - 上传视频后立即分析时长并扣除精确积分
   - 修复了积分检查逻辑，避免过度预扣

4. **清理无用代码** ✅
   - 移除了 `routes/downloads.js` 中无用的 `checkFeatureAccess` 导入
   - 统一了所有功能的积分扣除时机和逻辑

**技术成果**:
- ✅ 消除了所有双重扣费风险
- ✅ 统一了积分扣除逻辑：检查 → 扣除 → 使用
- ✅ 提高了代码质量和可维护性
- ✅ 确保了用户积分的准确性和公平性
- ✅ 实现了真正的统一积分管理系统

**用户体验改进**:
- 所有功能现在都有一致的积分提示
- 积分不足时会显示明确的错误信息
- 积分扣除更加准确和透明
- 消除了用户经济损失的风险

**开发者收益**:
- 代码结构更加清晰和统一
- 减少了重复代码和维护成本
- 提高了系统的稳定性和可靠性
- 为未来新功能的添加提供了标准模板

这次优化彻底解决了积分系统的所有问题，实现了真正的统一管理。所有功能现在都遵循相同的积分扣除逻辑，确保了系统的一致性和用户体验的优质性。

#### 最新优化 - 下载中心过期记录自动清理
**优化日期**: 2024年12月14日

**优化内容**:
1. **自动清理机制**: 
   - 添加了定时清理任务，每小时自动清除12小时前的过期下载记录
   - 用户访问下载中心时也会触发清理，确保页面只显示有效记录
   - 过期记录直接从数据库删除，不再显示在下载中心页面

2. **技术实现**:
   - 创建了 `utils/cleanupTasks.js` 定时清理任务模块
   - 使用 `node-cron` 实现定时任务调度
   - 在服务器启动时自动启动清理任务
   - 添加了手动清理API接口 `POST /api/downloads/cleanup`

3. **清理规则**:
   - 清理12小时前创建的下载记录
   - 不清理视频相关的特殊记录类型（如数字人视频、视频风格重绘等）
   - 每次清理都会记录清理数量到控制台日志

4. **用户体验优化**:
   - 下载中心页面加载更快（无需显示大量过期记录）
   - 减少数据库存储压力
   - 用户只看到有效的下载记录，避免混淆

#### 最新优化 - 下载中心仅保存图片
**优化日期**: 2024年12月14日

**优化内容**:
1. **严格的内容过滤**:
   - 下载中心现在只保存和显示图片相关的内容
   - 完全排除所有视频相关的记录和保存请求
   - 使用多重过滤条件确保视频内容不会出现在下载中心

2. **保存接口优化**:
   - 在保存接口中添加类型检查，拒绝视频相关的保存请求
   - 返回明确的错误信息："下载中心只保存图片，不保存视频"
   - 确保用户清楚了解下载中心的功能定位

3. **查询逻辑增强**:
   - 使用 `Op.notLike` 过滤所有包含 'video' 或 'VIDEO' 的类型
   - 扩展排除列表，包含所有可能的视频相关类型标识
   - 即使用户指定特定类型查询，也会过滤掉视频类型

4. **清理任务优化**:
   - 定时清理任务和手动清理都只处理图片记录
   - 保留所有视频记录不被意外清理
   - 确保视频功能的历史记录完整性

#### 🚨 紧急修复 - 亚马逊助手双重扣费问题彻底解决 ✅
**修复日期**: 2024年12月14日

**严重问题发现**: 
用户报告亚马逊助手功能仍然存在重复扣费问题。经过深入调查发现，这是一个影响所有亚马逊助手功能的系统性问题。

**问题根因分析**: 
通过服务器日志分析发现，亚马逊助手功能存在双重扣费机制：
1. **前端扣费**: 页面通过 `feature-tracker.js` 调用 `/api/credits/track-usage` 路由扣费
2. **后端扣费**: API通过统一中间件 `createUnifiedFeatureMiddleware` 再次扣费

**日志证据**:
```
用户ID 11 使用 amazon_review_generator 功能，扣除 1 积分，剩余 83 积分  // 第一次扣费
用户ID 11 使用 amazon_review_generator 功能，扣除 1 积分，剩余 82 积分  // 第二次扣费
```

**影响范围**: 
所有17个亚马逊助手功能都受到影响：
- ❌ 亚马逊Listing写作与优化
- ❌ 亚马逊后台搜索词
- ❌ 品牌信息收集和总结
- ❌ 亚马逊品牌起名
- ❌ 亚马逊消费者洞察专家
- ❌ 亚马逊客户邮件回复
- ❌ FBA索赔邮件
- ❌ 亚马逊评论生成
- ❌ 亚马逊评论回复
- ❌ 产品对比
- ❌ 创建亚马逊Post
- ❌ 亚马逊关键词推荐
- ❌ 亚马逊客服case内容生成
- ❌ 选品的改款分析和建议
- ❌ 亚马逊客户评论分析
- ❌ 亚马逊广告视频脚本生成
- ❌ 亚马逊视频脚本生成

**修复方案**: 

1. **批量修复前端页面** ✅
   - 创建自动化修复脚本 `fix-amazon-double-charge.js`
   - 移除所有前端页面中的 `trackFeatureUsage` 调用
   - 成功修复12个HTML页面文件

2. **保留统一中间件扣费** ✅
   - 保持后端统一中间件的积分扣除逻辑
   - 确保所有功能只通过一个渠道扣费
   - 维持积分扣除的准确性和一致性

3. **移除重复扣费代码** ✅
   - 移除前端的 `const canProceed = await trackFeatureUsage(...)` 调用
   - 移除页面查看跟踪 `trackFeatureUsage('page_view', ...)`
   - 移除内容生成跟踪 `trackFeatureUsage('generate_content', ...)`

**修复结果**:
- ✅ **成功修复**: 12个亚马逊助手页面
- ✅ **修复失败**: 0个文件
- ✅ **总计处理**: 12个文件
- ✅ **亚马逊评论生成**: 已在之前单独修复

**技术改进**:
- ✅ 消除了所有双重扣费风险
- ✅ 统一了积分扣除机制（仅通过后端中间件）
- ✅ 提高了用户体验和系统可靠性
- ✅ 保护了用户的经济利益

**验证方法**:
现在所有亚马逊助手功能都只会：
1. 通过统一中间件检查积分是否足够
2. 如果足够则扣除积分并继续执行
3. 如果不够则提示积分不足并拒绝请求
4. **绝不会重复扣费**

**用户受益**:
- 💰 **经济保护**: 不再有双重扣费损失
- 🎯 **准确计费**: 每次使用只扣除应有的积分
- 🛡️ **系统可靠**: 积分扣除逻辑统一且可靠
- 📈 **体验提升**: 功能使用更加流畅和可预期

这次修复彻底解决了亚马逊助手的双重扣费问题，确保用户的每一分积分都得到公平合理的使用。

## 管理员功能

### 用户管理

管理员可以在后台管理所有用户，包括：

1. 查看用户列表
2. 查看用户详细信息
3. 修改用户信息和积分
4. 删除用户账号
5. **删除用户功能使用记录**（新功能）

### 删除用户功能使用记录功能

管理员可以删除特定用户的所有功能使用记录，这在以下情况很有用：

- 测试账号需要清除使用记录
- 用户功能使用记录出现异常需要重置
- 统计数据需要调整

#### 使用方法

1. 登录管理员账号
2. 进入用户详情页面
3. 点击"删除所有使用记录"按钮
4. 确认操作后，系统将：
   - 删除数据库中该用户的所有功能使用记录
   - 清理服务器全局变量中该用户的任务记录
   - 刷新统计数据

#### API接口

管理员也可以通过API接口删除用户功能使用记录：

```
POST /api/admin/delete-user-usage
Content-Type: application/json
Authorization: Bearer {管理员TOKEN}

{
  "userId": 用户ID
}
```

响应示例：

```json
{
  "success": true,
  "message": "成功删除用户ID为 X 的 Y 条功能使用记录",
  "data": {
    "databaseRecords": {
      "deleted": 数量,
      "records": [使用记录详情]
    },
    "globalVariables": {
      "digitalHumanTasks": 清理数量,
      "videoSubtitleTasks": 清理数量,
      "videoStyleRepaintTasks": 清理数量
    }
  }
}
```

## 🎉 **紧急修复完成报告**

**修复时间**: 2024年12月14日  
**修复状态**: ✅ 所有严重问题已修复

### 修复内容总结

#### 1. 统一中间件使用
- ✅ 将所有功能从 `checkFeatureAccess` 迁移到 `createUnifiedFeatureMiddleware`
- ✅ 移除了所有重复的积分扣除逻辑
- ✅ 确保积分在功能使用前立即扣除

#### 2. 具体修复的功能

**亚马逊助手功能** (`routes/amazon-listing-api.js`)
- ✅ 修复 `/generate` 接口使用正确的中间件
- ✅ 确保所有17个亚马逊助手功能正确扣除积分

**图像编辑功能** (`routes/imageEdit.js`)
- ✅ 修复图像上色、局部重绘、智能扩图、图像锐化、垫图等功能
- ✅ 移除重复的积分处理逻辑
- ✅ 统一使用 `createUnifiedFeatureMiddleware`

**文生图功能** (`routes/textToImage.js`)
- ✅ 修复积分在任务完成后扣除的问题
- ✅ 改为在使用前立即扣除积分
- ✅ 简化任务记录逻辑

**文生视频功能** (`routes/textToVideo.js`)
- ✅ 修复所有文生视频和图生视频接口
- ✅ 统一使用 `createUnifiedFeatureMiddleware`

**全局风格化功能** (`routes/globalStyle.js`)
- ✅ 修复积分处理逻辑
- ✅ 移除重复扣除问题

**服饰分割功能** (`routes/clothingSegmentation.js`)
- ✅ 修复严重的重复扣除积分问题
- ✅ 简化数据库记录逻辑

**Server.js中的功能**
- ✅ 修复图像放大功能
- ✅ 修复鞋靴虚拟试穿功能
- ✅ 修复视频风格重绘功能

#### 3. 技术改进

- ✅ **统一积分扣除时机**: 所有功能现在都在使用前立即扣除积分
- ✅ **消除重复扣除**: 移除了所有重复的积分扣除逻辑
- ✅ **统一记录格式**: 所有功能使用相同的记录格式
- ✅ **简化代码逻辑**: 移除了复杂的任务完成后扣费逻辑

### 现在的统一流程

所有功能现在都严格遵循以下流程：

1. **权限检查** → 2. **免费次数验证** → 3. **积分立即扣除** → 4. **功能执行** → 5. **记录保存**

### 风险消除

- ✅ **经济风险**: 已消除用户免费使用付费功能的风险
- ✅ **一致性风险**: 所有功能现在使用统一的积分处理逻辑
- ✅ **数据完整性**: 确保积分使用情况页面准确显示所有记录

## 功能使用情况统计

系统会自动跟踪和统计所有功能的使用情况，包括：

- 每个功能的使用次数
- 每个功能消耗的积分总额
- 用户的功能使用详情

管理员可以在后台查看这些统计数据，了解平台运营情况

#### 最新修复 - 亚马逊评论生成英文输出问题 ✅
**修复日期**: 2024年12月14日

**问题描述**: 
用户反馈亚马逊助手中的评论生成功能在设置输出语言为英文时不能正常生成评论。

**问题根因**: 
经过代码分析发现，亚马逊评论生成功能(`/review-generator`)的代码逻辑存在严重错误：
1. **错误的代码复制**: 该函数错误地复制了亚马逊Post生成的代码逻辑，而不是评论生成的逻辑
2. **返回格式错误**: 应该返回评论数组(`reviews`)，但却使用了单个Post的处理逻辑
3. **语言处理错误**: 英文输出时的系统提示词和处理逻辑不正确
4. **JSON解析问题**: 解析逻辑针对单个对象而不是评论数组

**修复内容**:

1. **重写评论生成逻辑** ✅
   - 修正了系统提示词，根据输出语言选择合适的提示词
   - 修正了用户提示词，明确要求生成评论数组格式
   - 添加了语言特定的指导原则

2. **修复JSON解析逻辑** ✅
   - 正确解析`reviews`数组格式
   - 验证返回结果是否包含`reviews`数组
   - 确保每个评论都有必要的字段(`title`, `content`, `username`)

3. **完善评论数量控制** ✅
   - 确保生成指定数量的评论
   - 如果数量不足，自动补充到要求的数量
   - 如果数量超过，截取到要求的数量

4. **改进错误处理** ✅
   - 提供语言特定的默认评论
   - 使用`generateRandomUsername`函数生成合适的用户名
   - 确保在任何情况下都能返回有效的评论数据

5. **统一语言处理** ✅
   - 英文输出时使用英文系统提示词和用户提示词
   - 中文输出时使用中文系统提示词和用户提示词
   - 默认评论也根据语言选择生成

**技术改进**:
- ✅ 修复了代码逻辑错误，确保功能正常工作
- ✅ 统一了中英文输出的处理逻辑
- ✅ 提高了JSON解析的健壮性
- ✅ 确保了评论数量的准确控制
- ✅ 改进了错误处理和默认值提供

**用户体验改进**:
- 英文输出现在可以正常工作
- 评论格式统一，包含标题、内容和用户名
- 评论数量准确，符合用户要求
- 即使在API出错时也能提供有用的默认评论

现在亚马逊评论生成功能在中文和英文输出模式下都能正常工作，用户可以根据需要选择合适的输出语言。

#### 最新修复 - 亚马逊助手其他功能英文输出统一 ✅
**修复日期**: 2024年12月14日

**问题描述**: 
在修复亚马逊评论生成功能后，发现亚马逊助手中还有3个功能存在英文输出相关的问题。

**问题根因**: 
经过全面检查发现，以下3个功能存在问题：
1. **亚马逊消费者洞察专家**: 系统提示词错误，使用了产品对比的提示词而不是消费者洞察的提示词
2. **FBA索赔邮件**: 语言判断逻辑不一致，使用了 `outputLanguage !== 'zh'` 而不是 `outputLanguage === 'en'`
3. **产品对比**: 语言判断逻辑不一致，使用了 `outputLanguage !== 'zh'` 而不是 `outputLanguage === 'en'`

**修复内容**:

1. **亚马逊消费者洞察专家功能** ✅
   - 修正了错误的系统提示词，改为专门的消费者洞察专家提示词
   - 统一了语言判断逻辑：`outputLanguage !== 'zh'` → `outputLanguage === 'en'`
   - 确保英文和中文输出都使用正确的专业提示词

2. **FBA索赔邮件功能** ✅
   - 统一了语言判断逻辑：`outputLanguage !== 'zh'` → `outputLanguage === 'en'`
   - 确保英文和中文输出的一致性

3. **产品对比功能** ✅
   - 统一了语言判断逻辑：`outputLanguage !== 'zh'` → `outputLanguage === 'en'`
   - 确保英文和中文输出的一致性

**技术改进**:
- ✅ 统一了所有亚马逊助手功能的语言判断逻辑
- ✅ 修正了错误的系统提示词
- ✅ 确保了英文输出的准确性和一致性
- ✅ 提高了代码的可维护性

**验证结果**:
现在所有17个亚马逊助手功能都使用统一的语言判断逻辑：
- 英文输出：`outputLanguage === 'en'`
- 中文输出：默认或 `outputLanguage !== 'en'`

**功能列表**（全部支持中英文输出）:
1. ✅ 亚马逊Listing写作与优化
2. ✅ 亚马逊后台搜索词
3. ✅ 品牌信息收集和总结
4. ✅ 亚马逊品牌起名
5. ✅ 亚马逊消费者洞察专家 (已修复)
6. ✅ 亚马逊客户邮件回复
7. ✅ FBA索赔邮件 (已修复)
8. ✅ 亚马逊评论生成 (已修复)
9. ✅ 亚马逊评论回复
10. ✅ 产品对比 (已修复)
11. ✅ 创建亚马逊Post
12. ✅ 亚马逊关键词推荐
13. ✅ 亚马逊客服case内容生成
14. ✅ 选品的改款分析和建议
15. ✅ 亚马逊客户评论分析
16. ✅ 亚马逊广告视频脚本生成
17. ✅ 亚马逊视频脚本生成

现在所有亚马逊助手功能的英文输出都能正常工作，用户可以根据需要选择合适的输出语言，获得一致的高质量结果。

#### 🐞 Bug Fix - FBA索赔邮件无法点击生成 (2025-06-13)

**问题**: 在 FBA 索赔邮件页面点击「生成索赔邮件」按钮后无任何反应，开发者工具报语法错误 `awaitif`。该错误同时导致前端重复积分扣费的潜在风险。

**原因**: 代码中误将 `await trackFeatureUsage(...)` 写成 `awaitif`，导致脚本解析失败；此外该调用会与后端统一中间件造成双重扣费。

**解决**:
1. 移除页面中错误的 `trackFeatureUsage` 调用，改由后端统一中间件 `createUnifiedFeatureMiddleware('fba_claim_email')` 负责积分扣除。
2. 修正 JavaScript 语法错误，页面脚本恢复正常执行。

**影响**:
- 现在「FBA索赔邮件」功能可以正常使用。
- 积分只扣除一次，避免双重扣费。

## 部署说明

### 宝塔面板部署
详细的部署说明请参考 [DEPLOY.md](./DEPLOY.md) 文件。

### 快速部署步骤
1. 在宝塔面板中安装 Node.js 16.x
2. 安装 PM2：`npm install pm2 -g`
3. 上传项目文件到网站目录
4. 安装依赖：`npm install`
5. 使用 PM2 启动：`pm2 start ecosystem.config.js`
6. 配置 Nginx 反向代理

### 环境要求
- Node.js 16.x 或以上
- PM2 进程管理工具
- MySQL 数据库（如果使用）
- Nginx 反向代理