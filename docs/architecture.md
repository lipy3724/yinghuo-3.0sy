# 萤火AI平台系统架构

## 整体架构

萤火AI平台采用现代化的微服务架构设计，由多个独立的服务组件组成，通过API网关进行统一的请求处理和路由。系统架构如下图所示：

```
                                  ┌─────────────┐
                                  │   客户端    │
                                  │ Web/移动应用 │
                                  └──────┬──────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                         API网关层                               │
└───────────────────────────────┬─────────────────────────────────┘
                                │
     ┌───────────────────┬──────┴───────┬────────────────┐
     │                   │              │                │
     ▼                   ▼              ▼                ▼
┌─────────┐        ┌──────────┐    ┌─────────┐     ┌──────────┐
│ 用户服务 │        │ AI对话服务 │    │ 绘画服务 │     │ 支付服务 │
└────┬────┘        └─────┬────┘    └────┬────┘     └────┬─────┘
     │                   │              │               │
     └───────────────────┴──────────────┴───────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         数据持久层                              │
│                                                                │
│    ┌─────────┐      ┌─────────┐      ┌─────────────────┐       │
│    │ MySQL   │      │  Redis  │      │ 阿里云OSS存储    │       │
│    └─────────┘      └─────────┘      └─────────────────┘       │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         外部服务集成                            │
│                                                                │
│    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │
│    │ DashScope   │    │ 支付宝/微信  │    │ 短信服务    │       │
│    │ AI服务      │    │ 支付服务     │    │            │       │
│    └─────────────┘    └─────────────┘    └─────────────┘       │
└─────────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. API网关层

API网关是系统的统一入口，负责请求的路由、认证、限流等功能：

- **请求路由**：将请求分发到相应的微服务
- **认证授权**：验证用户身份和权限
- **请求限流**：防止恶意请求和系统过载
- **日志记录**：记录API调用日志
- **响应缓存**：缓存常用数据提高响应速度

### 2. 核心服务

系统包含多个独立的核心服务，每个服务负责特定的业务功能：

#### 用户服务

- 用户注册、登录、认证
- 用户信息管理
- 权限管理
- 会话管理

#### AI对话服务

- 对话历史管理
- 模型参数配置
- DashScope API调用
- 对话内容处理

#### AI绘画服务

- 绘画任务管理
- 绘画参数配置
- 图像生成和处理
- 图像存储和检索

#### 支付服务

- 订单管理
- 支付处理
- 退款处理
- 支付记录

### 3. 数据持久层

#### MySQL数据库

主要存储结构化数据，包括：
- 用户信息
- 订单数据
- 对话历史
- 系统配置

#### Redis缓存

用于提高系统性能和响应速度：
- 会话缓存
- 热点数据缓存
- 限流计数器
- 分布式锁

#### 阿里云OSS存储

用于存储大量非结构化数据：
- 用户上传的图片
- AI生成的图像
- 系统文件

### 4. 外部服务集成

#### DashScope AI服务

- 通过API调用阿里云的AI模型
- 处理文本生成、对话、图像生成等AI任务

#### 支付服务集成

- 支付宝API集成
- 微信支付API集成
- 支付回调处理

#### 短信服务

- 验证码发送
- 通知消息发送

## 技术栈

### 后端技术

- **运行环境**：Node.js
- **Web框架**：Express.js
- **数据库**：MySQL
- **缓存**：Redis
- **对象存储**：阿里云OSS
- **认证**：JWT (JSON Web Tokens)
- **API文档**：Swagger
- **日志**：Winston
- **任务队列**：Bull

### 部署技术

- **容器化**：Docker
- **进程管理**：PM2
- **CI/CD**：GitHub Actions
- **监控**：Prometheus + Grafana

## 系统安全

系统采用多层次的安全防护措施：

1. **传输安全**：全站HTTPS加密
2. **认证安全**：JWT + 密码加盐哈希
3. **授权控制**：基于角色的访问控制(RBAC)
4. **API安全**：请求签名验证
5. **数据安全**：敏感数据加密存储
6. **防护措施**：XSS防护、CSRF防护、SQL注入防护

## 扩展性设计

系统设计考虑了未来的扩展需求：

1. **水平扩展**：服务可独立部署和扩展
2. **功能扩展**：模块化设计便于添加新功能
3. **模型扩展**：支持集成多种AI模型
4. **多租户支持**：系统设计支持多租户隔离

## 高可用设计

为保证系统的高可用性，采用以下策略：

1. **服务冗余**：关键服务多实例部署
2. **负载均衡**：请求分发到多个服务实例
3. **故障转移**：服务故障自动切换
4. **熔断机制**：防止级联故障
5. **限流保护**：防止服务过载
