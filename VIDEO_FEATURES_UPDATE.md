# 视频功能扣费逻辑更新

## 已修改的功能

以下功能已更新为"先使用后扣费"的逻辑：

1. **文生视频 (text-to-video)**
   - 原逻辑：使用前扣除66积分
   - 新逻辑：创建任务时仅检查用户是否有至少20积分，任务完成后扣除66积分

2. **图生视频 (image-to-video)**
   - 原逻辑：使用前扣除66积分
   - 新逻辑：创建任务时仅检查用户是否有至少20积分，任务完成后扣除66积分

3. **多图转视频 (MULTI_IMAGE_TO_VIDEO)**
   - 原逻辑：使用前根据预估时长扣除积分
   - 新逻辑：创建任务时仅检查用户是否有至少30积分，任务完成后根据实际时长扣除积分（每30秒30积分）

## 实现方式

1. 修改了 `middleware/featureAccess.js` 中的功能配置，将积分计算改为在创建阶段返回0
2. 在功能检查逻辑中添加了这三个功能的特殊处理，仅检查最低积分要求
3. 修改了 `middleware/unifiedFeatureUsage.js` 中的任务完成处理逻辑，在任务完成后扣除相应积分

## 注意事项

- 请确保任务完成回调机制正常工作，否则可能导致用户使用功能但未被扣费
- 建议监控这些功能的使用情况，确保积分扣除正常
- 如果发现任何问题，可以回滚到之前的扣费逻辑

## 后续优化建议

1. 添加积分预授权机制，在任务创建时锁定一定积分
2. 完善任务失败处理逻辑，明确定义哪些失败情况需要扣费、哪些不需要
3. 添加定时任务检查长时间未完成的任务，避免资源浪费
