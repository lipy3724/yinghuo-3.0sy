# 萤火AI平台退款机制说明

## 退款系统概述

萤火AI平台实现了一套完善的退款机制，用于处理各种功能任务失败时的积分退还。该机制确保用户在使用AI功能过程中，如果出现任务失败、API调用错误等情况，能够自动或手动退还已消费的积分，保障用户权益。

## 退款系统架构

退款系统主要由以下部分组成：

1. **退款管理模块** (`utils/refundManager.js`)：集中处理所有功能的退款逻辑
2. **功能特定退款函数**：针对每种功能的专用退款处理函数
3. **全局任务记录**：使用全局变量存储任务信息，包括积分消费和退款状态
4. **API接口**：提供前端请求退款的接口

## 退款流程

### 自动退款流程

1. **任务失败触发退款**：
   - 系统检测到任务失败（API调用失败、处理错误等）
   - 调用对应功能的退款函数，传入用户ID、任务ID和失败原因
   - 自动执行退款操作，无需用户干预

2. **退款处理步骤**：
   - 检查全局任务记录，确认任务存在且未退款
   - 标记任务为已退款，防止重复退款
   - 查询功能使用记录，确定是否为免费使用
   - 免费使用：回退使用次数，保留免费机会
   - 付费使用：退还积分，更新使用记录
   - 记录退款信息到任务详情中

### 手动退款流程

1. **用户请求退款**：
   - 用户通过前端界面请求退款
   - 系统验证任务状态和用户权限
   - 执行与自动退款相同的退款处理步骤

2. **管理员处理退款**：
   - 管理员可以通过管理后台处理特殊退款请求
   - 可以指定退款积分数量或强制退款

## 退款代码实现

### 核心退款函数

```javascript
/**
 * 通用退款函数 - 处理任何功能的退款
 * @param {number} userId - 用户ID
 * @param {string} taskId - 任务ID
 * @param {string} featureName - 功能名称
 * @param {string} reason - 退款原因
 * @param {Object} [options] - 额外选项
 * @returns {Promise<boolean>} - 退款是否成功
 */
async function refundFeatureCredits(userId, taskId, featureName, reason = '任务失败', options = {}) {
  try {
    console.log(`开始处理${featureName}功能退款: 用户ID=${userId}, 任务ID=${taskId}, 原因=${reason}`);
    
    // 获取对应功能的全局任务变量
    const globalTasksVar = getGlobalTasksVariable(featureName);
    let creditCost = 0;
    let wasRefunded = false;
    
    // 检查全局任务记录中是否有该任务的积分信息
    if (!options.skipGlobalCheck && globalTasksVar && globalTasksVar[taskId]) {
      const taskInfo = globalTasksVar[taskId];
      creditCost = taskInfo.creditCost || 0;
      wasRefunded = taskInfo.refunded || false;
      
      // 如果已经退款过了，不重复退款
      if (wasRefunded) {
        console.log(`任务 ${taskId} 已经退款过，跳过退款处理`);
        return false;
      }
      
      // 标记为已退款，防止重复退款
      globalTasksVar[taskId].refunded = true;
    }
    
    // 如果没有积分消耗信息，从功能配置中获取
    if (creditCost === 0) {
      const featureConfig = FEATURES[featureName];
      creditCost = featureConfig ? (
        typeof featureConfig.creditCost === 'function' 
          ? featureConfig.creditCost({}) 
          : featureConfig.creditCost
      ) : 0;
    }
    
    // 查找最近的该功能使用记录
    const recentUsage = await FeatureUsage.findOne({
      where: {
        userId: userId,
        featureName: featureName
      },
      order: [['createdAt', 'DESC']]
    });
    
    // 检查该使用记录是否为免费使用
    const featureConfig = FEATURES[featureName];
    
    if (featureConfig && recentUsage.usageCount <= featureConfig.freeUsage) {
      // 免费使用，仅回退使用次数
      if (recentUsage.usageCount > 0) {
        recentUsage.usageCount -= 1;
        await recentUsage.save();
      }
      
      // 记录退款信息
      await recordRefundInfo(recentUsage, taskId, 0, true, reason);
      return true;
    }
    
    // 付费使用，退还积分
    if (creditCost > 0) {
      const user = await User.findByPk(userId);
      
      // 退还积分
      user.credits += creditCost;
      await user.save();
      
      // 更新使用记录
      if (recentUsage.usageCount > 0) {
        recentUsage.usageCount -= 1;
        recentUsage.credits = Math.max(0, (recentUsage.credits || 0) - creditCost);
      }
      
      // 记录退款信息
      await recordRefundInfo(recentUsage, taskId, creditCost, false, reason);
      return true;
    }
    
    return false;
  } catch (error) {
    console.error(`${featureName}功能退款处理错误:`, error);
    return false;
  }
}
```

### 功能特定退款函数

系统为每种功能提供了专用的退款函数，这些函数都调用通用退款函数：

```javascript
/**
 * 图像智能消除任务退款函数
 */
async function refundImageRemovalCredits(userId, taskId, reason = '任务失败') {
  return refundFeatureCredits(userId, taskId, 'image-removal', reason);
}

/**
 * 图片高清放大任务退款函数
 */
async function refundImageUpscalerCredits(userId, taskId, reason = '任务失败') {
  return refundFeatureCredits(userId, taskId, 'image-upscaler', reason);
}

// 其他功能的退款函数...
```

### 退款记录函数

```javascript
/**
 * 记录退款信息到任务详情中
 */
async function recordRefundInfo(usageRecord, taskId, creditCost, isFree, reason) {
  try {
    const details = JSON.parse(usageRecord.details || '{}');
    const refunds = details.refunds || [];
    
    // 记录退款信息
    refunds.push({
      taskId: taskId,
      creditCost: creditCost,
      isFree: isFree,
      reason: reason,
      refundTime: new Date().toISOString()
    });
    
    // 更新任务详情
    usageRecord.details = JSON.stringify({
      ...details,
      refunds: refunds
    });
    
    await usageRecord.save();
  } catch (error) {
    console.error('记录退款信息失败:', error);
  }
}
```

## 防重复退款机制

系统采用多重防护措施避免重复退款：

1. **全局任务标记**：
   - 任务退款后在全局变量中标记为已退款
   - 每次退款前检查该标记

2. **退款记录查询**：
   - 在功能使用记录的details字段中存储退款记录
   - 每次退款前检查是否已有该任务的退款记录

3. **事务处理**：
   - 确保积分退还和记录更新的原子性
   - 避免因系统错误导致重复退款

## 退款记录与审计

每次退款操作都会详细记录以下信息：

1. **任务ID**：关联到具体的任务
2. **退款积分**：退还的积分数量
3. **退款时间**：执行退款的时间戳
4. **退款原因**：详细说明退款的原因
5. **是否免费**：标记是否为免费使用的回退

这些记录存储在FeatureUsage表的details字段中，以JSON格式保存，方便后续审计和分析。

## 前端退款接口

系统提供了多个API端点用于前端请求退款：

```javascript
/**
 * @route   POST /api/refund/image-removal
 * @desc    处理图像智能消除功能的退款请求
 * @access  Private
 */
router.post('/refund/image-removal', protect, async (req, res) => {
  try {
    const { taskId, reason } = req.body;
    const userId = req.user.id;
    
    if (!taskId) {
      return res.status(400).json({ 
        success: false, 
        message: '缺少任务ID参数' 
      });
    }
    
    // 调用退款函数
    const success = await refundImageRemovalCredits(userId, taskId, reason || '前端请求退款');
    
    if (success) {
      return res.status(200).json({ 
        success: true, 
        message: '退款处理成功' 
      });
    } else {
      return res.status(400).json({ 
        success: false, 
        message: '退款处理失败，可能是任务不存在或已经退款' 
      });
    }
  } catch (error) {
    console.error('处理退款请求时出错:', error);
    return res.status(500).json({ 
      success: false, 
      message: '服务器处理退款请求时出错: ' + error.message 
    });
  }
});
```

## 免费使用与付费使用的区别

1. **免费使用退款**：
   - 不涉及积分退还
   - 仅回退使用次数计数
   - 保留用户的免费使用机会

2. **付费使用退款**：
   - 退还消耗的积分
   - 更新积分消费记录
   - 回退使用次数计数
   - 如果回退后使用次数回到免费范围，清除付费记录

## 退款触发场景

1. **API调用失败**：
   - 第三方API返回错误
   - 网络连接问题
   - 服务超时

2. **任务处理失败**：
   - 图像处理错误
   - 视频生成失败
   - 结果不符合预期

3. **用户主动请求**：
   - 用户通过前端界面请求退款
   - 用户联系客服申请退款

4. **系统错误**：
   - 服务器内部错误
   - 数据库操作失败
   - 文件存储问题

## 退款系统监控与日志

系统对所有退款操作进行详细日志记录：

1. **控制台日志**：
   - 记录退款开始、过程和结果
   - 包含用户ID、任务ID、功能名称、积分数量等信息

2. **数据库记录**：
   - 在FeatureUsage表中记录详细退款信息
   - 便于后续查询和统计

3. **错误处理**：
   - 捕获并记录退款过程中的所有错误
   - 确保即使退款失败也不影响系统正常运行

## 退款系统优化建议

1. **事务管理**：
   - 使用数据库事务确保积分退还和记录更新的原子性
   - 避免因系统错误导致数据不一致

2. **退款审批流程**：
   - 对大额退款或特殊情况引入审批流程
   - 管理员确认后才执行退款

3. **退款限制**：
   - 设置退款时间窗口，如任务完成后24小时内
   - 限制单用户退款频率，防止滥用

4. **退款通知**：
   - 退款成功后向用户发送通知
   - 包含退款原因、积分数量和当前积分余额

## 结语

萤火AI平台的退款机制设计全面、实现严谨，能够有效保障用户权益，提升用户体验。系统通过自动化处理大部分退款场景，同时保留人工干预的可能，既提高了效率，又确保了灵活性和安全性。 