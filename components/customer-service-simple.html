<!-- å®¢æœç³»ç»Ÿç»„ä»¶ - ç®€åŒ–ç‰ˆæœ¬ -->
<style>
    /* å®¢æœæŒ‰é’®æ ·å¼ */
    .cs-float-button {
        position: fixed !important;
        bottom: 30px !important;
        right: 30px !important;
        width: 60px !important;
        height: 60px !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border-radius: 50% !important;
        border: none !important;
        cursor: pointer !important;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4) !important;
        z-index: 9999 !important;
        color: white !important;
        font-size: 24px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        transition: transform 0.2s ease !important;
    }
    
    .cs-float-button:hover {
        transform: scale(1.1) !important;
    }
    
    /* èŠå¤©çª—å£æ ·å¼ */
    .cs-chat-window {
        position: fixed !important;
        bottom: 100px !important;
        right: 30px !important;
        width: 350px !important;
        height: 450px !important;
        background: white !important;
        border-radius: 12px !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
        z-index: 10000 !important;
        display: none !important;
        flex-direction: column !important;
        overflow: hidden !important;
        border: 1px solid #e0e0e0 !important;
    }
    
    .cs-chat-window.show {
        display: flex !important;
    }
    
    /* èŠå¤©çª—å£å¤´éƒ¨ */
    .cs-chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        padding: 16px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
    }
    
    .cs-chat-header-info {
        display: flex !important;
        align-items: center !important;
    }
    
    .cs-chat-avatar {
        width: 40px !important;
        height: 40px !important;
        background: rgba(255, 255, 255, 0.2) !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin-right: 12px !important;
        font-size: 20px !important;
    }
    
    .cs-chat-title {
        margin: 0 !important;
        font-size: 16px !important;
        font-weight: 600 !important;
    }
    
    .cs-chat-subtitle {
        margin: 0 !important;
        font-size: 12px !important;
        opacity: 0.8 !important;
    }
    
    .cs-close-btn {
        background: none !important;
        border: none !important;
        color: white !important;
        font-size: 20px !important;
        cursor: pointer !important;
        padding: 4px !important;
        border-radius: 4px !important;
    }
    
    .cs-close-btn:hover {
        background: rgba(255, 255, 255, 0.1) !important;
    }
    
    /* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */
    .cs-chat-messages {
        flex: 1 !important;
        padding: 16px !important;
        overflow-y: auto !important;
        background: #f8f9fa !important;
    }
    
    /* èŠå¤©è¾“å…¥åŒºåŸŸ */
    .cs-chat-input-area {
        padding: 16px !important;
        border-top: 1px solid #e0e0e0 !important;
        background: white !important;
    }
    
    .cs-chat-input-container {
        display: flex !important;
        gap: 8px !important;
    }
    
    .cs-chat-input {
        flex: 1 !important;
        border: 1px solid #ddd !important;
        border-radius: 20px !important;
        padding: 8px 16px !important;
        font-size: 14px !important;
        outline: none !important;
    }
    
    .cs-chat-input:focus {
        border-color: #667eea !important;
    }
    
    .cs-send-btn {
        background: #667eea !important;
        color: white !important;
        border: none !important;
        border-radius: 50% !important;
        width: 36px !important;
        height: 36px !important;
        cursor: pointer !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    .cs-send-btn:hover {
        background: #5a67d8 !important;
    }
    
    /* æ¶ˆæ¯æ ·å¼ */
    .cs-message {
        margin-bottom: 12px !important;
        max-width: 80% !important;
    }
    
    .cs-message.user {
        margin-left: auto !important;
        text-align: right !important;
    }
    
    .cs-message-content {
        padding: 8px 12px !important;
        border-radius: 12px !important;
        font-size: 14px !important;
        line-height: 1.4 !important;
    }
    
    .cs-message.user .cs-message-content {
        background: #667eea !important;
        color: white !important;
        border-bottom-right-radius: 4px !important;
    }
    
    .cs-message.admin .cs-message-content {
        background: white !important;
        color: #333 !important;
        border: 1px solid #e0e0e0 !important;
        border-bottom-left-radius: 4px !important;
    }
    
    .cs-message-time {
        font-size: 11px !important;
        color: #999 !important;
        margin-top: 4px !important;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 480px) {
        .cs-chat-window {
            width: calc(100vw - 20px) !important;
            height: calc(100vh - 120px) !important;
            right: 10px !important;
            bottom: 80px !important;
        }
    }
</style>

<!-- å®¢æœæµ®åŠ¨æŒ‰é’® -->
<button class="cs-float-button" id="cs-float-button" onclick="toggleChatWindow()">
    <i class="ri-customer-service-2-line"></i>
</button>

<!-- èŠå¤©çª—å£ -->
<div class="cs-chat-window" id="cs-chat-window">
    <!-- å¤´éƒ¨ -->
    <div class="cs-chat-header">
        <div class="cs-chat-header-info">
            <div class="cs-chat-avatar">
                <i class="ri-customer-service-2-fill"></i>
            </div>
            <div>
                <h4 class="cs-chat-title">è¤ç«AIå®¢æœ</h4>
                <p class="cs-chat-subtitle">æˆ‘ä»¬ä¼šå°½å¿«å›å¤æ‚¨</p>
            </div>
        </div>
        <button class="cs-close-btn" onclick="closeChatWindow()">
            <i class="ri-close-line"></i>
        </button>
    </div>
    
    <!-- æ¶ˆæ¯åŒºåŸŸ -->
    <div class="cs-chat-messages" id="cs-chat-messages">
        <div class="cs-message admin">
            <div class="cs-message-content">
                æ‚¨å¥½ï¼æ¬¢è¿ä½¿ç”¨è¤ç«AIæ™ºèƒ½åŠ©æ‰‹ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ
            </div>
            <div class="cs-message-time">åˆšåˆš</div>
        </div>
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="cs-chat-input-area">
        <div class="cs-chat-input-container">
            <input type="text" class="cs-chat-input" id="cs-chat-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." maxlength="500">
            <button class="cs-send-btn" id="cs-send-btn" onclick="sendMessage()">
                <i class="ri-send-plane-fill"></i>
            </button>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡ - ç›´æ¥å®šä¹‰åœ¨windowå¯¹è±¡ä¸Š
window.csIsChatOpen = false;
window.csCurrentUserId = null;
window.csUnreadCount = 0;

// è°ƒè¯•æ—¥å¿—å‡½æ•°
function csLog(message) {
    console.log('[å®¢æœç³»ç»Ÿ] ' + message);
}

// ç®€åŒ–çš„ç”¨æˆ·IDè·å–å‡½æ•°
function getUserId() {
    csLog('ğŸ” å¼€å§‹è·å–ç”¨æˆ·ID');
    
    // æ£€æŸ¥ç¼“å­˜
    if (window.csCurrentUserId && typeof window.csCurrentUserId === 'number') {
        csLog('âœ… ä½¿ç”¨ç¼“å­˜çš„ç”¨æˆ·ID: ' + window.csCurrentUserId);
        return window.csCurrentUserId;
    }
    
    // å°è¯•ä»localStorageè·å–ç”¨æˆ·ä¿¡æ¯
    try {
        var userInfo = localStorage.getItem('user');
        if (userInfo && userInfo !== 'null') {
            var user = JSON.parse(userInfo);
            if (user && user.id && !isNaN(user.id)) {
                var realUserId = parseInt(user.id);
                window.csCurrentUserId = realUserId;
                csLog('âœ… ä»localStorageè·å–åˆ°ç”¨æˆ·ID: ' + realUserId);
                return realUserId;
            }
        }
    } catch (error) {
        csLog('âŒ è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message);
    }
    
    // ç”Ÿæˆè®¿å®¢ID
    var guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    csLog('âš ï¸ ç”Ÿæˆè®¿å®¢ID: ' + guestId);
    return guestId;
}

// åˆ‡æ¢èŠå¤©çª—å£ - å…¨å±€å‡½æ•°
function toggleChatWindow() {
    csLog('ğŸ–±ï¸ åˆ‡æ¢èŠå¤©çª—å£');
    var chatWindow = document.getElementById('cs-chat-window');
    
    if (!chatWindow) {
        csLog('âŒ æ‰¾ä¸åˆ°èŠå¤©çª—å£å…ƒç´ ');
        return;
    }
    
    if (window.csIsChatOpen) {
        closeChatWindow();
    } else {
        openChatWindow();
    }
}

// æ‰“å¼€èŠå¤©çª—å£
function openChatWindow() {
    csLog('ğŸ“– æ‰“å¼€èŠå¤©çª—å£');
    var chatWindow = document.getElementById('cs-chat-window');
    
    if (chatWindow) {
        chatWindow.classList.add('show');
        window.csIsChatOpen = true;
        loadMessages();
        focusInput();
    }
}

// å…³é—­èŠå¤©çª—å£
function closeChatWindow() {
    csLog('ğŸ“• å…³é—­èŠå¤©çª—å£');
    var chatWindow = document.getElementById('cs-chat-window');
    
    if (chatWindow) {
        chatWindow.classList.remove('show');
        window.csIsChatOpen = false;
    }
}

// å‘é€æ¶ˆæ¯
function sendMessage() {
    var input = document.getElementById('cs-chat-input');
    var message = input.value.trim();
    
    if (!message) {
        csLog('âŒ æ¶ˆæ¯ä¸ºç©º');
        return;
    }
    
    csLog('ğŸ“¤ å‘é€æ¶ˆæ¯: ' + message);
    
    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    addMessage(message, 'user');
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    input.value = '';
    
    // å‘é€åˆ°æœåŠ¡å™¨
    sendToServer(message);
}

// æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
function addMessage(content, type) {
    var messagesContainer = document.getElementById('cs-chat-messages');
    var messageDiv = document.createElement('div');
    messageDiv.className = 'cs-message ' + type;
    
    var now = new Date();
    var timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                  now.getMinutes().toString().padStart(2, '0');
    
    messageDiv.innerHTML = 
        '<div class="cs-message-content">' + escapeHtml(content) + '</div>' +
        '<div class="cs-message-time">' + timeStr + '</div>';
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// HTMLè½¬ä¹‰
function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
function sendToServer(message) {
    var userId = getUserId();
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºè®¿å®¢ID
    if (userId.toString().startsWith('guest_')) {
        csLog('âš ï¸ è®¿å®¢ç”¨æˆ·ï¼Œæ˜¾ç¤ºç™»å½•æç¤º');
        addMessage('æŠ±æ­‰ï¼Œæ‚¨éœ€è¦å…ˆç™»å½•æ‰èƒ½ä½¿ç”¨å®¢æœåŠŸèƒ½ã€‚è¯·ç‚¹å‡»å³ä¸Šè§’ç™»å½•æŒ‰é’®è¿›è¡Œç™»å½•ã€‚', 'admin');
        return;
    }
    
    // ç¡®ä¿userIdæ˜¯æ•°å­—ç±»å‹
    if (isNaN(userId)) {
        csLog('âŒ ç”¨æˆ·IDæ ¼å¼é”™è¯¯: ' + userId);
        addMessage('æŠ±æ­‰ï¼Œæ‚¨çš„ç™»å½•ä¿¡æ¯æœ‰è¯¯ï¼Œè¯·é‡æ–°ç™»å½•åå†è¯•ã€‚', 'admin');
        return;
    }
    
    csLog('ğŸ“¡ å‘é€åˆ°æœåŠ¡å™¨ï¼Œç”¨æˆ·ID: ' + userId);
    
    fetch('/api/kefu/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            userId: parseInt(userId),
            message: message,
            type: 'user'
        })
    })
    .then(function(response) {
        csLog('ğŸ“¡ æœåŠ¡å™¨å“åº”: ' + response.status);
        if (!response.ok) {
            throw new Error('HTTP ' + response.status);
        }
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            csLog('âœ… æ¶ˆæ¯å‘é€æˆåŠŸ');
        } else {
            csLog('âŒ æ¶ˆæ¯å‘é€å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            addMessage('æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'admin');
        }
    })
    .catch(function(error) {
        csLog('âŒ å‘é€å¤±è´¥: ' + error.message);
        if (error.message.includes('404')) {
            addMessage('å®¢æœæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'admin');
        } else {
            addMessage('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚', 'admin');
        }
    });
}

// åŠ è½½å†å²æ¶ˆæ¯
function loadMessages() {
    var userId = getUserId();
    
    // å¦‚æœæ˜¯è®¿å®¢ç”¨æˆ·ï¼Œä¸åŠ è½½å†å²æ¶ˆæ¯
    if (userId.toString().startsWith('guest_')) {
        csLog('âš ï¸ è®¿å®¢ç”¨æˆ·ï¼Œä¸åŠ è½½å†å²æ¶ˆæ¯');
        return;
    }
    
    if (isNaN(userId)) {
        csLog('âŒ ç”¨æˆ·IDæ ¼å¼é”™è¯¯ï¼Œæ— æ³•åŠ è½½å†å²æ¶ˆæ¯');
        return;
    }
    
    csLog('ğŸ“¥ åŠ è½½å†å²æ¶ˆæ¯ï¼Œç”¨æˆ·ID: ' + userId);
    
    fetch('/api/kefu/messages?userId=' + parseInt(userId))
    .then(function(response) {
        if (!response.ok) {
            throw new Error('HTTP ' + response.status);
        }
        return response.json();
    })
    .then(function(data) {
        if (data.success && data.messages) {
            csLog('âœ… åŠ è½½äº† ' + data.messages.length + ' æ¡å†å²æ¶ˆæ¯');
            displayMessages(data.messages);
        }
    })
    .catch(function(error) {
        csLog('âŒ åŠ è½½æ¶ˆæ¯å¤±è´¥: ' + error.message);
    });
}

// æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨
function displayMessages(messages) {
    var messagesContainer = document.getElementById('cs-chat-messages');
    // æ¸…ç©ºç°æœ‰æ¶ˆæ¯ï¼ˆé™¤äº†æ¬¢è¿æ¶ˆæ¯ï¼‰
    var welcomeMsg = messagesContainer.querySelector('.cs-message.admin');
    messagesContainer.innerHTML = '';
    if (welcomeMsg) {
        messagesContainer.appendChild(welcomeMsg);
    }
    
    // æ·»åŠ å†å²æ¶ˆæ¯
    for (var i = 0; i < messages.length; i++) {
        var msg = messages[i];
        addMessage(msg.message, msg.type);
    }
}

// èšç„¦è¾“å…¥æ¡†
function focusInput() {
    setTimeout(function() {
        var input = document.getElementById('cs-chat-input');
        if (input) {
            input.focus();
        }
    }, 100);
}

// è®¾ç½®å›è½¦å‘é€
function setupInputEvents() {
    var input = document.getElementById('cs-chat-input');
    if (input) {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    }
}

// åˆå§‹åŒ–
function initCustomerService() {
    csLog('ğŸš€ å®¢æœç³»ç»Ÿåˆå§‹åŒ–');
    setupInputEvents();
    csLog('âœ… å®¢æœç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCustomerService);
} else {
    initCustomerService();
}

// ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å¯ç”¨
window.toggleChatWindow = toggleChatWindow;
window.openChatWindow = openChatWindow;
window.closeChatWindow = closeChatWindow;
window.sendMessage = sendMessage;

csLog('ğŸ“ å®¢æœç»„ä»¶è„šæœ¬åŠ è½½å®Œæˆ');
</script> 