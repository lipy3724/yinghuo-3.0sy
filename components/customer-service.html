<!-- å®¢æœç³»ç»Ÿç»„ä»¶ -->
<style>
    /* å®¢æœç»„ä»¶æ ·å¼ v2.1 - ä¿®å¤æ°”æ³¡å®½åº¦è‡ªé€‚åº” */
    
    /* é‡ç½®æ‰€æœ‰æ ·å¼ï¼Œç¡®ä¿ä¼˜å…ˆçº§ */
    .cs-message-content {
        padding: 8px 12px !important;
        border-radius: 12px !important;
        font-size: 14px !important;
        line-height: 1.4 !important;
        display: inline-block !important;
        max-width: fit-content !important;
        width: auto !important;
        min-width: auto !important;
        word-wrap: break-word !important;
        word-break: break-word !important;
        box-sizing: border-box !important;
    }
    
    /* æ¶ˆæ¯å®¹å™¨æ ·å¼ */
    .cs-message {
        margin-bottom: 0 !important;
        max-width: 80% !important;
        display: flex !important;
        flex-direction: column !important;
        width: auto !important;
        min-width: auto !important;
    }
    
    .cs-message.user {
        align-self: flex-end !important;
        align-items: flex-end !important;
    }
    
    .cs-message.admin {
        align-self: flex-start !important;
        align-items: flex-start !important;
    }
    
    /* å®¢æœæŒ‰é’®æ ·å¼ */
    .cs-float-button {
        position: fixed !important;
        bottom: 30px !important;
        right: 30px !important;
        width: 60px !important;
        height: 60px !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border-radius: 50% !important;
        border: none !important;
        cursor: pointer !important;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4) !important;
        z-index: 9999 !important;
        color: white !important;
        font-size: 24px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        transition: transform 0.2s ease !important;
    }
    
    .cs-float-button:hover {
        transform: scale(1.1) !important;
    }
    
    /* æœªè¯»æ¶ˆæ¯å¾½ç«  */
    .cs-unread-badge {
        position: absolute !important;
        top: -5px !important;
        right: -5px !important;
        background: #ff4757 !important;
        color: white !important;
        border-radius: 50% !important;
        width: 20px !important;
        height: 20px !important;
        font-size: 12px !important;
        display: none !important;
        align-items: center !important;
        justify-content: center !important;
        font-weight: bold !important;
    }
    
    /* èŠå¤©çª—å£æ ·å¼ */
    .cs-chat-window {
        position: fixed !important;
        bottom: 100px !important;
        right: 30px !important;
        width: 350px !important;
        height: 450px !important;
        background: white !important;
        border-radius: 12px !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
        z-index: 10000 !important;
        display: none !important;
        flex-direction: column !important;
        overflow: hidden !important;
        border: 1px solid #e0e0e0 !important;
    }
    
    .cs-chat-window.show {
        display: flex !important;
    }
    
    /* èŠå¤©çª—å£å¤´éƒ¨ */
    .cs-chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        padding: 16px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
    }
    
    .cs-chat-header-info {
        display: flex !important;
        align-items: center !important;
    }
    
    .cs-chat-avatar {
        width: 44px !important;
        height: 44px !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin-right: 12px !important;
        font-size: 20px !important;
        color: white !important;
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3) !important;
        border: 3px solid rgba(255, 255, 255, 0.9) !important;
        position: relative !important;
        transition: all 0.3s ease !important;
    }
    
    .cs-chat-avatar::before {
        content: '' !important;
        position: absolute !important;
        top: -3px !important;
        left: -3px !important;
        right: -3px !important;
        bottom: -3px !important;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%) !important;
        border-radius: 50% !important;
        z-index: -1 !important;
        opacity: 0.8 !important;
    }
    
    .cs-chat-avatar i {
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2)) !important;
        animation: headerPulse 3s infinite !important;
    }
    
    @keyframes headerPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.08); }
        100% { transform: scale(1); }
    }
    
    .cs-chat-title {
        margin: 0 !important;
        font-size: 16px !important;
        font-weight: 600 !important;
    }
    
    .cs-chat-subtitle {
        margin: 0 !important;
        font-size: 12px !important;
        opacity: 0.8 !important;
    }
    
    .cs-close-btn {
        background: none !important;
        border: none !important;
        color: white !important;
        font-size: 20px !important;
        cursor: pointer !important;
        padding: 4px !important;
        border-radius: 4px !important;
    }
    
    .cs-close-btn:hover {
        background: rgba(255, 255, 255, 0.1) !important;
    }
    
    /* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */
    .cs-chat-messages {
        flex: 1 !important;
        padding: 16px !important;
        overflow-y: auto !important;
        background: #f8f9fa !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 8px !important;
    }
    
    /* èŠå¤©è¾“å…¥åŒºåŸŸ */
    .cs-chat-input-area {
        padding: 16px !important;
        border-top: 1px solid #e0e0e0 !important;
        background: white !important;
    }
    
    .cs-chat-input-container {
        display: flex !important;
        gap: 8px !important;
    }
    
    .cs-chat-input {
        flex: 1 !important;
        border: 1px solid #ddd !important;
        border-radius: 20px !important;
        padding: 8px 16px !important;
        font-size: 14px !important;
        outline: none !important;
    }
    
    .cs-chat-input:focus {
        border-color: #667eea !important;
    }
    
    .cs-send-btn {
        background: #667eea !important;
        color: white !important;
        border: none !important;
        border-radius: 50% !important;
        width: 36px !important;
        height: 36px !important;
        cursor: pointer !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    .cs-send-btn:hover {
        background: #5a67d8 !important;
    }
    
    .cs-send-btn:disabled {
        background: #ccc !important;
        cursor: not-allowed !important;
    }
    
    /* ç®¡ç†å‘˜æ¶ˆæ¯åº•éƒ¨å¸ƒå±€ï¼ˆå¤´åƒ+æ—¶é—´ï¼‰ */
    .cs-message-footer {
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
        margin-top: 4px !important;
        flex-direction: row !important;
    }
    
    /* å®¢æœå¤´åƒæ ·å¼ - ä½¿ç”¨æ›´å¼ºçš„é€‰æ‹©å™¨ç¡®ä¿ç”Ÿæ•ˆ */
    .cs-message-footer .cs-message-avatar,
    .cs-message-footer img.cs-message-avatar,
    img.cs-message-avatar {
        width: 12px !important;
        height: 12px !important;
        max-width: 12px !important;
        max-height: 12px !important;
        flex-shrink: 0 !important;
        display: inline-block !important;
        margin-left: -10px !important;
    }
    
    .cs-message-time {
        font-size: 11px !important;
        color: #999 !important;
        margin-top: 0px !important;
        white-space: nowrap !important;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 480px) {
        .cs-chat-window {
            width: calc(100vw - 20px) !important;
            height: calc(100vh - 120px) !important;
            right: 10px !important;
            bottom: 80px !important;
        }
    }
    
    /* ç”¨æˆ·æ¶ˆæ¯æ ·å¼ */
    .cs-message.user .cs-message-content {
        background: #667eea !important;
        color: white !important;
        border-bottom-right-radius: 4px !important;
    }
    
    /* ç®¡ç†å‘˜æ¶ˆæ¯æ ·å¼ */
    .cs-message.admin .cs-message-content {
        background: white !important;
        color: #333 !important;
        border: 1px solid #e0e0e0 !important;
        border-bottom-left-radius: 4px !important;
    }
</style>

<!-- å®¢æœæµ®åŠ¨æŒ‰é’® -->
<button class="cs-float-button" id="cs-float-button" onclick="window.toggleChatWindow()">
    <i class="ri-customer-service-2-line"></i>
    <div class="cs-unread-badge" id="cs-unread-badge">0</div>
</button>

<!-- èŠå¤©çª—å£ -->
<div class="cs-chat-window" id="cs-chat-window">
    <!-- å¤´éƒ¨ -->
    <div class="cs-chat-header">
        <div class="cs-chat-header-info">
            <div class="cs-chat-avatar">
                <i class="ri-customer-service-2-fill"></i>
            </div>
            <div>
                <h4 class="cs-chat-title">è¤ç«AIå®¢æœ</h4>
                <p class="cs-chat-subtitle">æˆ‘ä»¬ä¼šå°½å¿«å›å¤æ‚¨</p>
            </div>
        </div>
        <button class="cs-close-btn" onclick="window.closeChatWindow()">
            <i class="ri-close-line"></i>
        </button>
    </div>
    
    <!-- æ¶ˆæ¯åŒºåŸŸ -->
    <div class="cs-chat-messages" id="cs-chat-messages">
        <div class="cs-message admin">
            <div class="cs-message-content">
                æ‚¨å¥½ï¼æ¬¢è¿ä½¿ç”¨è¤ç«AIæ™ºèƒ½åŠ©æ‰‹ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ
            </div>
            <div class="cs-message-footer" style="display: flex !important; align-items: center !important; gap: 6px !important; margin-top: 4px !important; flex-direction: row !important;">
                <img src="/public/images/favicon.png" class="cs-message-avatar" alt="å®¢æœå¤´åƒ" style="width: 12px; height: 12px; max-width: 12px; max-height: 12px; margin-left: -10px;">
                <div class="cs-message-time" style="font-size: 11px !important; color: #999 !important; margin-top: 0px !important; white-space: nowrap !important;">åˆšåˆš</div>
            </div>
        </div>
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="cs-chat-input-area">
        <div class="cs-chat-input-container">
            <input type="text" class="cs-chat-input" id="cs-chat-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." maxlength="500">
            <button class="cs-send-btn" id="cs-send-btn" onclick="window.sendMessage()">
                <i class="ri-send-plane-fill"></i>
            </button>
        </div>
    </div>
</div>

<script>
    // ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å®šä¹‰
    (function() {
        // å…¨å±€å˜é‡
        window.csIsChatOpen = false;
        window.csCurrentUserId = null;
        window.csUnreadCount = 0;

        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function csLog(message) {
            console.log('[å®¢æœç³»ç»Ÿ] ' + message);
        }

        // è·å–æˆ–ç”Ÿæˆç”¨æˆ·ID - å½»åº•ä¿®å¤ç‰ˆæœ¬
        function getUserId() {
            csLog('ğŸ” === å¼€å§‹è·å–ç”¨æˆ·ID ===');
            
            // ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ç¼“å­˜çš„ç”¨æˆ·IDï¼ˆå¦‚æœå·²ç»è·å–è¿‡çœŸå®IDï¼‰
            if (window.csCurrentUserId && typeof window.csCurrentUserId === 'number') {
                csLog('âœ… ä½¿ç”¨ç¼“å­˜çš„çœŸå®ç”¨æˆ·ID: ' + window.csCurrentUserId);
                return window.csCurrentUserId;
            }
            
            // ç¬¬äºŒæ­¥ï¼šå°è¯•ä»localStorageè·å–ç”¨æˆ·ä¿¡æ¯
            try {
                var userInfo = localStorage.getItem('user');
                csLog('ğŸ“‹ localStorageä¸­çš„ç”¨æˆ·ä¿¡æ¯: ' + (userInfo ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
                
                if (userInfo && userInfo !== 'null' && userInfo !== 'undefined' && userInfo.trim() !== '') {
                    var user = JSON.parse(userInfo);
                    csLog('ğŸ“ è§£æåçš„ç”¨æˆ·å¯¹è±¡: ' + JSON.stringify(user));
                    
                    if (user && user.id && !isNaN(user.id)) {
                        var realUserId = parseInt(user.id);
                        window.csCurrentUserId = realUserId;
                        csLog('âœ… ä»localStorageè·å–åˆ°çœŸå®ç”¨æˆ·ID: ' + realUserId);
                        return realUserId;
                    } else {
                        csLog('âŒ ç”¨æˆ·å¯¹è±¡ä¸­IDå­—æ®µæ— æ•ˆ: ' + JSON.stringify(user));
                    }
                } else {
                    csLog('âŒ localStorageä¸­æ²¡æœ‰æœ‰æ•ˆçš„ç”¨æˆ·ä¿¡æ¯');
                }
            } catch (error) {
                csLog('âŒ è§£ælocalStorageç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
            
            // ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥æ˜¯å¦æœ‰tokenï¼Œå¦‚æœæœ‰åˆ™å°è¯•åŒæ­¥è·å–ç”¨æˆ·ä¿¡æ¯
            var token = getAuthToken() || getAuthToken();
            if (token) {
                csLog('ğŸ”‘ æ‰¾åˆ°tokenï¼Œå°è¯•åŒæ­¥è·å–ç”¨æˆ·ä¿¡æ¯');
                
                // å°è¯•åŒæ­¥è·å–ç”¨æˆ·ä¿¡æ¯
                try {
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', '/api/auth/verify', false); // åŒæ­¥è¯·æ±‚
                    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                    xhr.send();
                    
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        if (response.user && response.user.id) {
                            var userId = parseInt(response.user.id);
                            // ç«‹å³ä¿å­˜åˆ°localStorageå’Œç¼“å­˜
                            localStorage.setItem('user', JSON.stringify(response.user));
                            window.csCurrentUserId = userId;
                            csLog('âœ… åŒæ­¥è·å–åˆ°çœŸå®ç”¨æˆ·ID: ' + userId);
                            return userId;
                        }
                    }
                    csLog('âŒ åŒæ­¥APIè¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€: ' + xhr.status);
                } catch (error) {
                    csLog('âŒ åŒæ­¥APIè¯·æ±‚å¼‚å¸¸: ' + error.message);
                }
                
                // å¦‚æœåŒæ­¥å¤±è´¥ï¼Œå¯åŠ¨å¼‚æ­¥è·å–
                setTimeout(function() {
                    fetchUserInfoAsync();
                }, 100);
            } else {
                csLog('âŒ æ²¡æœ‰æ‰¾åˆ°è®¤è¯token');
            }
            
            // ç¬¬å››æ­¥ï¼šç”Ÿæˆè®¿å®¢IDä½œä¸ºåå¤‡æ–¹æ¡ˆ
            var guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            csLog('âš ï¸ ç”Ÿæˆè®¿å®¢ID: ' + guestId + ' (éœ€è¦ç™»å½•æ‰èƒ½ä½¿ç”¨å®¢æœåŠŸèƒ½)');
            
            return guestId;
        }

        // åˆ‡æ¢èŠå¤©çª—å£æ˜¾ç¤º/éšè— - å…¨å±€å‡½æ•°
        window.toggleChatWindow = function() {
            csLog('åˆ‡æ¢èŠå¤©çª—å£');
            var chatWindow = document.getElementById('cs-chat-window');
            
            if (!chatWindow) {
                csLog('é”™è¯¯ï¼šæ‰¾ä¸åˆ°èŠå¤©çª—å£å…ƒç´ ');
                return;
            }
            
            if (window.csIsChatOpen) {
                window.closeChatWindow();
            } else {
                window.openChatWindow();
            }
        };

        // æ‰“å¼€èŠå¤©çª—å£ - å…¨å±€å‡½æ•°
        window.openChatWindow = function() {
            csLog('æ‰“å¼€èŠå¤©çª—å£');
            var chatWindow = document.getElementById('cs-chat-window');
            
            if (chatWindow) {
                chatWindow.classList.add('show');
                window.csIsChatOpen = true;
                // ä¿å­˜èŠå¤©çª—å£çŠ¶æ€åˆ°localStorage
                localStorage.setItem('cs_chat_window_open', 'true');
                clearUnreadCount();
                loadMessages();
                focusInput();
            }
        };

        // å…³é—­èŠå¤©çª—å£ - å…¨å±€å‡½æ•°
        window.closeChatWindow = function() {
            csLog('å…³é—­èŠå¤©çª—å£');
            var chatWindow = document.getElementById('cs-chat-window');
            
            if (chatWindow) {
                chatWindow.classList.remove('show');
                window.csIsChatOpen = false;
                // ä¿å­˜èŠå¤©çª—å£çŠ¶æ€åˆ°localStorage
                localStorage.setItem('cs_chat_window_open', 'false');
            }
        };

        // å‘é€æ¶ˆæ¯ - å…¨å±€å‡½æ•°
        window.sendMessage = function() {
            var input = document.getElementById('cs-chat-input');
            var message = input.value.trim();
            
            if (!message) {
                csLog('æ¶ˆæ¯ä¸ºç©ºï¼Œä¸å‘é€');
                return;
            }
            
            csLog('å‘é€æ¶ˆæ¯: ' + message);
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            
            // å‘é€åˆ°æœåŠ¡å™¨
            sendToServer(message);
        };

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(content, type) {
            var messagesContainer = document.getElementById('cs-chat-messages');
            var messageDiv = document.createElement('div');
            messageDiv.className = 'cs-message ' + type;
            
            var now = new Date();
            var timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                          now.getMinutes().toString().padStart(2, '0');
            
            if (type === 'admin') {
                // ç®¡ç†å‘˜æ¶ˆæ¯åŒ…å«å¤´åƒå’Œfooter
                messageDiv.innerHTML = 
                    '<div class="cs-message-content">' + escapeHtml(content) + '</div>' +
                    '<div class="cs-message-footer">' +
                        '<img src="/public/images/favicon.png" class="cs-message-avatar" alt="å®¢æœå¤´åƒ">' +
                        '<div class="cs-message-time">' + timeStr + '</div>' +
                    '</div>';
            } else {
                // ç”¨æˆ·æ¶ˆæ¯åªæœ‰å†…å®¹å’Œæ—¶é—´
                messageDiv.innerHTML = 
                    '<div class="cs-message-content">' + escapeHtml(content) + '</div>' +
                    '<div class="cs-message-time">' + timeStr + '</div>';
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
        function sendToServer(message) {
            var userId = getUserId();
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºè®¿å®¢IDï¼ˆä»¥guest_å¼€å¤´ï¼‰
            if (userId.toString().startsWith('guest_')) {
                csLog('è®¿å®¢ç”¨æˆ·æ— æ³•å‘é€æ¶ˆæ¯ï¼Œè¯·å…ˆç™»å½•');
                addMessage('æŠ±æ­‰ï¼Œæ‚¨éœ€è¦å…ˆç™»å½•æ‰èƒ½ä½¿ç”¨å®¢æœåŠŸèƒ½ã€‚è¯·ç‚¹å‡»å³ä¸Šè§’ç™»å½•æŒ‰é’®è¿›è¡Œç™»å½•ã€‚', 'admin');
                return;
            }
            
            // ç¡®ä¿userIdæ˜¯æ•°å­—ç±»å‹
            if (isNaN(userId)) {
                csLog('ç”¨æˆ·IDæ ¼å¼é”™è¯¯: ' + userId);
                addMessage('æŠ±æ­‰ï¼Œæ‚¨çš„ç™»å½•ä¿¡æ¯æœ‰è¯¯ï¼Œè¯·é‡æ–°ç™»å½•åå†è¯•ã€‚', 'admin');
                return;
            }
            
            csLog('å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨ï¼Œç”¨æˆ·ID: ' + userId + ' (ç±»å‹: ' + typeof userId + ')');
            
            fetch('/api/user-kefu/messages', {
        headers: {
            'Authorization': `Bearer ${getAuthToken()}`
        },
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
        },
                body: JSON.stringify({
                    userId: parseInt(userId),
                    message: message,
                    type: 'user'
                })
            })
            .then(function(response) {
                csLog('æœåŠ¡å™¨å“åº”çŠ¶æ€: ' + response.status);
                if (!response.ok) {
                    return response.json().then(function(errorData) {
                        throw new Error('HTTP ' + response.status + ': ' + (errorData.error || errorData.message || response.statusText));
                    });
                }
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    csLog('æ¶ˆæ¯å‘é€æˆåŠŸ');
                } else {
                    csLog('æ¶ˆæ¯å‘é€å¤±è´¥: ' + (data.error || data.message || 'æœªçŸ¥é”™è¯¯'));
                    if (data.error && data.error.includes('ç”¨æˆ·ä¸å­˜åœ¨')) {
                        addMessage('æŠ±æ­‰ï¼Œæ‚¨çš„è´¦æˆ·ä¿¡æ¯æœ‰è¯¯ï¼Œè¯·é‡æ–°ç™»å½•åå†è¯•ã€‚', 'admin');
                    } else {
                        addMessage('æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'admin');
                    }
                }
            })
            .catch(function(error) {
                csLog('å‘é€æ¶ˆæ¯æ—¶å‡ºé”™: ' + error.message);
                if (error.message.includes('404')) {
                    addMessage('å®¢æœæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'admin');
                } else if (error.message.includes('ç”¨æˆ·ä¸å­˜åœ¨')) {
                    addMessage('æŠ±æ­‰ï¼Œæ‚¨çš„è´¦æˆ·ä¿¡æ¯æœ‰è¯¯ï¼Œè¯·é‡æ–°ç™»å½•åå†è¯•ã€‚', 'admin');
                } else {
                    addMessage('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚', 'admin');
                }
            });
        }

        // åŠ è½½å†å²æ¶ˆæ¯
        function loadMessages() {
            var userId = getUserId();
            
            // å¦‚æœæ˜¯è®¿å®¢ç”¨æˆ·ï¼Œä¸åŠ è½½å†å²æ¶ˆæ¯
            if (userId.toString().startsWith('guest_')) {
                csLog('è®¿å®¢ç”¨æˆ·ï¼Œä¸åŠ è½½å†å²æ¶ˆæ¯');
                return;
            }
            
            // ç¡®ä¿userIdæ˜¯æ•°å­—ç±»å‹
            if (isNaN(userId)) {
                csLog('ç”¨æˆ·IDæ ¼å¼é”™è¯¯ï¼Œæ— æ³•åŠ è½½å†å²æ¶ˆæ¯: ' + userId);
                return;
            }
            
            csLog('åŠ è½½å†å²æ¶ˆæ¯ï¼Œç”¨æˆ·ID: ' + userId);
            
            fetch('/api/user-kefu/messages?userId=' + parseInt(userId), {
        headers: {
            'Authorization': `Bearer ${getAuthToken()}`
        }
    })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.json();
            })
            .then(function(data) {
                if (data.success && data.messages) {
                    csLog('æˆåŠŸåŠ è½½ ' + data.messages.length + ' æ¡å†å²æ¶ˆæ¯');
                    displayMessages(data.messages);
                } else {
                    csLog('åŠ è½½æ¶ˆæ¯å¤±è´¥: ' + (data.error || data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(function(error) {
                csLog('åŠ è½½æ¶ˆæ¯æ—¶å‡ºé”™: ' + error.message);
            });
        }

        // æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨
        function displayMessages(messages) {
            var messagesContainer = document.getElementById('cs-chat-messages');
            // æ¸…ç©ºç°æœ‰æ¶ˆæ¯ï¼ˆé™¤äº†æ¬¢è¿æ¶ˆæ¯ï¼‰
            var welcomeMsg = messagesContainer.querySelector('.cs-message.admin');
            messagesContainer.innerHTML = '';
            if (welcomeMsg) {
                messagesContainer.appendChild(welcomeMsg);
            }
            
            // æ·»åŠ å†å²æ¶ˆæ¯
            for (var i = 0; i < messages.length; i++) {
                var msg = messages[i];
                addMessage(msg.message, msg.type);
            }
        }

        // æ¸…é™¤æœªè¯»è®¡æ•°
        function clearUnreadCount() {
            window.csUnreadCount = 0;
            var badge = document.getElementById('cs-unread-badge');
            if (badge) {
                badge.style.display = 'none';
            }
        }

        // èšç„¦è¾“å…¥æ¡†
        function focusInput() {
            setTimeout(function() {
                var input = document.getElementById('cs-chat-input');
                if (input) {
                    input.focus();
                }
            }, 100);
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        function setupInputEvents() {
            var input = document.getElementById('cs-chat-input');
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        window.sendMessage();
                    }
                });
            }
        }

        // å¼‚æ­¥è·å–ç”¨æˆ·ä¿¡æ¯
        function fetchUserInfoAsync() {
            var token = getAuthToken() || getAuthToken();
            if (!token) {
                csLog('âŒ æ²¡æœ‰æ‰¾åˆ°è®¤è¯tokenï¼Œæ— æ³•å¼‚æ­¥è·å–ç”¨æˆ·ä¿¡æ¯');
                return;
            }
            
            csLog('ğŸ”„ å¼‚æ­¥è·å–ç”¨æˆ·ä¿¡æ¯...');
            
            fetch('/api/auth/verify', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(function(response) {
                csLog('ğŸŒ å¼‚æ­¥APIå“åº”çŠ¶æ€: ' + response.status);
                if (response.ok) {
                    return response.json();
                }
                throw new Error('è®¤è¯å¤±è´¥: HTTP ' + response.status);
            })
            .then(function(data) {
                csLog('ğŸ“¦ å¼‚æ­¥APIè¿”å›æ•°æ®: ' + JSON.stringify(data));
                if (data.user && data.user.id) {
                    var newUserId = parseInt(data.user.id);
                    csLog('ğŸ†” ä»å¼‚æ­¥APIè·å–åˆ°ç”¨æˆ·ID: ' + newUserId);
                    
                    // ç«‹å³æ›´æ–°ç¼“å­˜å’ŒlocalStorage
                    window.csCurrentUserId = newUserId;
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    csLog('âœ… å¼‚æ­¥æ›´æ–°å®Œæˆ - ç”¨æˆ·ID: ' + newUserId + ', ç”¨æˆ·å: ' + data.user.username);
                    
                    // å¦‚æœèŠå¤©çª—å£å·²æ‰“å¼€ï¼Œé‡æ–°åŠ è½½æ¶ˆæ¯
                    if (window.csIsChatOpen) {
                        csLog('ğŸ”„ èŠå¤©çª—å£å·²æ‰“å¼€ï¼Œé‡æ–°åŠ è½½å†å²æ¶ˆæ¯');
                        loadMessages();
                    }
                } else {
                    csLog('âŒ å¼‚æ­¥APIè¿”å›çš„ç”¨æˆ·ä¿¡æ¯æ ¼å¼æ— æ•ˆ');
                }
            })
            .catch(function(error) {
                csLog('âŒ å¼‚æ­¥è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message);
            });
        }

        // åˆå§‹åŒ–
        function initCustomerService() {
            csLog('å®¢æœç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹');
            
            // è·å–ç”¨æˆ·ID
            getUserId();
            
            // å¼‚æ­¥è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœæœ‰tokenä½†æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼‰
            setTimeout(fetchUserInfoAsync, 100);
            
            // è®¾ç½®è¾“å…¥äº‹ä»¶
            setupInputEvents();
            
            // æ¢å¤èŠå¤©çª—å£çŠ¶æ€
            restoreChatWindowState();
            
            csLog('å®¢æœç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }
        
        // æ¢å¤èŠå¤©çª—å£çŠ¶æ€
        function restoreChatWindowState() {
            var savedState = localStorage.getItem('cs_chat_window_open');
            csLog('æ£€æŸ¥ä¿å­˜çš„èŠå¤©çª—å£çŠ¶æ€: ' + savedState);
            
            if (savedState === 'true') {
                csLog('æ¢å¤èŠå¤©çª—å£æ‰“å¼€çŠ¶æ€');
                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿DOMå…ƒç´ å·²åŠ è½½
                setTimeout(function() {
                    window.openChatWindow();
                }, 200);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCustomerService);
        } else {
            initCustomerService();
        }

        csLog('å®¢æœç»„ä»¶è„šæœ¬åŠ è½½å®Œæˆ');
    })();

// è·å–è®¤è¯token
function getAuthToken() {
    // ä¼˜å…ˆè·å–authTokenï¼Œè¿™æ˜¯æ™®é€šç”¨æˆ·ä½¿ç”¨çš„key
    let token = getAuthToken();
    
    // å¦‚æœæ²¡æœ‰ï¼Œå°è¯•è·å–admin_tokenï¼Œè¿™æ˜¯ç®¡ç†å‘˜ä½¿ç”¨çš„key
    if (!token) {
        token = localStorage.getItem('admin_token');
    }
    
    return token;
}
</script> 